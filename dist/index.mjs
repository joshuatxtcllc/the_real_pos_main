// ES Module compatibility shims
import { createRequire } from 'module';
import { fileURLToPath } from 'url';
import { dirname } from 'path';

const require = createRequire(import.meta.url);
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

var st=Object.defineProperty;var wo=Object.getOwnPropertyDescriptor;var xo=Object.getOwnPropertyNames;var So=Object.prototype.hasOwnProperty;var F=(s,t)=>()=>(s&&(t=s(s=0)),t);var oe=(s,t)=>{for(var e in t)st(s,e,{get:t[e],enumerable:!0})},Po=(s,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of xo(t))!So.call(s,o)&&o!==e&&st(s,o,{get:()=>t[o],enumerable:!(r=wo(t,o))||r.enumerable});return s};var Ht=s=>Po(st({},"__esModule",{value:!0}),s);var lt={};oe(lt,{customerNotifications:()=>U,customers:()=>x,frames:()=>N,glassOptions:()=>H,insertCustomerNotificationSchema:()=>Wo,insertCustomerSchema:()=>it,insertFrameSchema:()=>No,insertGlassOptionSchema:()=>_o,insertInventoryCategorySchema:()=>Qo,insertInventoryCountItemSchema:()=>os,insertInventoryCountSchema:()=>rs,insertInventoryItemSchema:()=>Yo,insertInventoryLocationSchema:()=>Ko,insertInventoryTransactionSchema:()=>Jo,insertLarsonJuhlCatalogSchema:()=>$o,insertMatColorSchema:()=>Mo,insertMaterialLocationSchema:()=>ns,insertMaterialOrderSchema:()=>Ho,insertNotificationSchema:()=>is,insertOrderFrameSchema:()=>jo,insertOrderGroupSchema:()=>ko,insertOrderMatSchema:()=>Ro,insertOrderSchema:()=>Do,insertOrderSpecialServiceSchema:()=>Eo,insertPaymentLinkSchema:()=>ss,insertPurchaseOrderLineSchema:()=>ts,insertPurchaseOrderSchema:()=>es,insertQrCodeScanSchema:()=>Zt,insertQrCodeSchema:()=>Yt,insertSpecialServiceSchema:()=>Fo,insertSupplierSchema:()=>zo,insertUserSchema:()=>qo,insertWholesaleOrderSchema:()=>Bo,inventoryCategories:()=>se,inventoryCountItems:()=>Kt,inventoryCounts:()=>ct,inventoryItems:()=>O,inventoryLocations:()=>B,inventoryTransactions:()=>X,larsonJuhlCatalog:()=>Qt,matColors:()=>G,materialLocations:()=>dt,materialOrderStatuses:()=>Uo,materialOrders:()=>k,materialTypes:()=>Go,measurementUnits:()=>Vo,notificationChannels:()=>Lo,notificationTypes:()=>To,notifications:()=>A,orderFrames:()=>ve,orderGroups:()=>E,orderMats:()=>Ce,orderSpecialServices:()=>le,orders:()=>g,paymentLinks:()=>Vt,productionStatuses:()=>Ao,purchaseOrderLines:()=>$e,purchaseOrderStatuses:()=>Xo,purchaseOrders:()=>K,qrCodeScans:()=>ut,qrCodeTypes:()=>as,qrCodes:()=>Oe,specialServices:()=>z,suppliers:()=>R,transactionTypes:()=>Zo,users:()=>J,wholesaleOrders:()=>Q});import{pgTable as S,text as i,serial as C,integer as y,boolean as M,numeric as p,timestamp as f,jsonb as Ie,primaryKey as Oo}from"drizzle-orm/pg-core";import{createInsertSchema as P}from"drizzle-zod";var x,it,N,No,G,Mo,H,_o,z,Fo,E,ko,Ao,g,Do,le,Eo,Ce,Ro,ve,jo,Q,Bo,J,qo,Qt,$o,To,Lo,U,Wo,Go,Uo,k,Ho,R,zo,se,Qo,B,Ko,Vo,O,Yo,Zo,X,Jo,Xo,K,es,$e,ts,ct,rs,Kt,os,Vt,ss,as,Oe,Yt,ut,Zt,dt,ns,A,is,ee=F(()=>{"use strict";x=S("customers",{id:C("id").primaryKey(),name:i("name").notNull(),email:i("email"),phone:i("phone"),address:i("address"),stripeCustomerId:i("stripe_customer_id"),createdAt:f("created_at").defaultNow()}),it=P(x).omit({id:!0,createdAt:!0}),N=S("frames",{id:i("id").primaryKey(),name:i("name").notNull(),manufacturer:i("manufacturer").notNull(),material:i("material").notNull(),width:p("width").notNull(),depth:p("depth").notNull(),price:p("price").notNull(),catalogImage:i("catalog_image").notNull(),edgeTexture:i("edge_texture"),corner:i("corner")}),No=P(N),G=S("mat_colors",{id:i("id").primaryKey(),name:i("name").notNull(),color:i("color").notNull(),price:p("price").notNull(),manufacturer:i("manufacturer"),code:i("code"),description:i("description"),category:i("category")}),Mo=P(G),H=S("glass_options",{id:i("id").primaryKey(),name:i("name").notNull(),description:i("description").notNull(),price:p("price").notNull()}),_o=P(H),z=S("special_services",{id:i("id").primaryKey(),name:i("name").notNull(),description:i("description").notNull(),price:p("price").notNull()}),Fo=P(z),E=S("order_groups",{id:C("id").primaryKey(),customerId:y("customer_id").references(()=>x.id),subtotal:p("subtotal"),tax:p("tax"),total:p("total"),status:i("status").notNull().default("open"),paymentMethod:i("payment_method"),notes:i("notes"),createdAt:f("created_at").defaultNow(),stripePaymentIntentId:i("stripe_payment_intent_id"),stripePaymentStatus:i("stripe_payment_status"),paymentDate:f("payment_date"),discountAmount:p("discount_amount"),discountType:i("discount_type"),taxExempt:M("tax_exempt").default(!1),cashAmount:p("cash_amount"),checkNumber:i("check_number"),invoiceEmailSent:M("invoice_email_sent").default(!1),invoiceEmailDate:f("invoice_email_date")}),ko=P(E).omit({id:!0,createdAt:!0}),Ao=["order_processed","scheduled","materials_ordered","materials_arrived","frame_cut","mat_cut","prepped","completed","delayed"],g=S("orders",{id:C("id").primaryKey(),customerId:y("customer_id").references(()=>x.id),orderGroupId:y("order_group_id").references(()=>E.id),frameId:i("frame_id").references(()=>N.id),matColorId:i("mat_color_id").references(()=>G.id),glassOptionId:i("glass_option_id").references(()=>H.id),artworkWidth:p("artwork_width").notNull(),artworkHeight:p("artwork_height").notNull(),matWidth:p("mat_width").notNull(),artworkDescription:i("artwork_description"),artworkType:i("artwork_type"),artworkLocation:i("artwork_location"),quantity:y("quantity").notNull().default(1),subtotal:p("subtotal").notNull(),tax:p("tax").notNull(),total:p("total").notNull(),status:i("status").notNull().default("pending"),productionStatus:i("production_status").$type().notNull().default("order_processed"),previousStatus:i("previous_status").$type(),createdAt:f("created_at").defaultNow(),dueDate:f("due_date"),artworkImage:i("artwork_image"),frameDesignImage:i("frame_design_image"),lastNotificationSent:f("last_notification_sent"),estimatedCompletionDays:y("estimated_completion_days"),addToWholesaleOrder:M("add_to_wholesale_order").default(!1),lastStatusChange:f("last_status_change").defaultNow(),notificationsEnabled:M("notifications_enabled").default(!0),useMultipleMats:M("use_multiple_mats").default(!1),useMultipleFrames:M("use_multiple_frames").default(!1),useManualFrame:M("use_manual_frame").default(!1),manualFrameName:i("manual_frame_name"),manualFrameCost:p("manual_frame_cost"),miscChargeDescription:i("misc_charge_description"),miscChargeAmount:p("misc_charge_amount")}),Do=P(g).omit({id:!0,createdAt:!0}),le=S("order_special_services",{orderId:y("order_id").references(()=>g.id),specialServiceId:i("special_service_id").references(()=>z.id)},s=>({pk:Oo({columns:[s.orderId,s.specialServiceId]})})),Eo=P(le),Ce=S("order_mats",{id:C("id").primaryKey(),orderId:y("order_id").references(()=>g.id).notNull(),matColorId:i("mat_color_id").references(()=>G.id).notNull(),position:y("position").notNull(),width:p("width").notNull(),offset:p("offset").notNull().default("0"),createdAt:f("created_at").defaultNow()}),Ro=P(Ce).omit({id:!0,createdAt:!0}),ve=S("order_frames",{id:C("id").primaryKey(),orderId:y("order_id").references(()=>g.id).notNull(),frameId:i("frame_id").references(()=>N.id).notNull(),position:y("position").notNull(),distance:p("distance").notNull().default("0"),createdAt:f("created_at").defaultNow()}),jo=P(ve).omit({id:!0,createdAt:!0}),Q=S("wholesale_orders",{id:C("id").primaryKey(),orderId:y("order_id").references(()=>g.id),manufacturer:i("manufacturer").notNull(),items:Ie("items").notNull(),status:i("status").notNull().default("pending"),createdAt:f("created_at").defaultNow()}),Bo=P(Q).omit({id:!0,createdAt:!0}),J=S("users",{id:C("id").primaryKey(),username:i("username").notNull().unique(),password:i("password").notNull(),role:i("role").notNull().default("employee")}),qo=P(J).omit({id:!0}),Qt=S("larson_juhl_catalog",{id:i("id").primaryKey(),name:i("name").notNull(),hex_color:i("hex_color"),price:p("price",{precision:10,scale:6}).notNull(),code:i("code").notNull(),crescent_code:i("crescent_code"),description:i("description"),category:i("category"),manufacturer:i("manufacturer").notNull(),type:i("type").notNull().default("matboard"),material:i("material"),width:p("width"),depth:p("depth"),edge_texture:i("edge_texture"),corner:i("corner"),catalog_image:i("catalog_image"),createdAt:f("created_at").defaultNow()}),$o=P(Qt).omit({createdAt:!0}),To=["status_update","estimated_completion","status_change","due_date_update","completion_reminder","order_complete","payment_reminder","delay_notification","payment_link"],Lo=["email","sms","both"],U=S("customer_notifications",{id:C("id").primaryKey(),customerId:y("customer_id").references(()=>x.id),orderId:y("order_id").references(()=>g.id),notificationType:i("notification_type").$type().notNull(),channel:i("channel").$type().notNull().default("email"),subject:i("subject").notNull(),message:i("message").notNull(),sentAt:f("sent_at").defaultNow(),successful:M("successful").notNull(),responseData:Ie("response_data"),previousStatus:i("previous_status"),newStatus:i("new_status"),paymentLinkId:y("payment_link_id")}),Wo=P(U).omit({id:!0,sentAt:!0}),Go=["frame","matboard","glass","backing_board","hardware","specialty_materials"],Uo=["pending","processed","ordered","arrived","frame_cut","mat_cut","prepped","completed","delayed","canceled"],k=S("material_orders",{id:C("id").primaryKey(),materialType:i("material_type").$type().notNull(),materialId:i("material_id").notNull(),materialName:i("material_name").notNull(),quantity:p("quantity").notNull(),status:i("status").$type().notNull().default("pending"),sourceOrderId:y("source_order_id").references(()=>g.id),orderDate:f("order_date"),expectedArrival:f("expected_arrival"),actualArrival:f("actual_arrival"),supplierName:i("supplier_name"),supplierOrderNumber:i("supplier_order_number"),notes:i("notes"),costPerUnit:p("cost_per_unit"),totalCost:p("total_cost"),priority:i("priority").default("normal"),hubOrderId:i("hub_order_id"),hubSyncStatus:i("hub_sync_status").default("not_synced"),hubLastSyncDate:f("hub_last_sync_date"),hubTrackingInfo:i("hub_tracking_info"),hubEstimatedDelivery:f("hub_estimated_delivery"),hubSupplierNotes:i("hub_supplier_notes"),orderReference:i("order_reference"),unitMeasurement:i("unit_measurement"),createdAt:f("created_at").defaultNow()}),Ho=P(k).omit({id:!0,createdAt:!0,hubOrderId:!0,hubSyncStatus:!0,hubLastSyncDate:!0,hubTrackingInfo:!0,hubEstimatedDelivery:!0,hubSupplierNotes:!0}),R=S("suppliers",{id:C("id").primaryKey(),name:i("name").notNull(),contactName:i("contact_name"),email:i("email"),phone:i("phone"),address:i("address"),website:i("website"),accountNumber:i("account_number"),notes:i("notes"),paymentTerms:i("payment_terms"),minimumOrderAmount:p("minimum_order_amount"),shippingPreference:i("shipping_preference"),leadTime:y("lead_time"),active:M("active").default(!0),createdAt:f("created_at").defaultNow(),lastOrderDate:f("last_order_date")}),zo=P(R).omit({id:!0,createdAt:!0}),se=S("inventory_categories",{id:C("id").primaryKey(),name:i("name").notNull(),description:i("description"),parentCategoryId:y("parent_category_id").references(()=>se.id),createdAt:f("created_at").defaultNow()}),Qo=P(se).omit({id:!0,createdAt:!0}),B=S("inventory_locations",{id:C("id").primaryKey(),name:i("name").notNull(),description:i("description"),type:i("type"),parentLocationId:y("parent_location_id").references(()=>B.id),active:M("active").default(!0),createdAt:f("created_at").defaultNow()}),Ko=P(B).omit({id:!0,createdAt:!0}),Vo=["each","inch","foot","united_inch","square_inch","sheet","roll","pound","liter","gallon"],O=S("inventory_items",{id:C("id").primaryKey(),sku:i("sku").notNull().unique(),name:i("name").notNull(),description:i("description"),categoryId:y("category_id").references(()=>se.id),supplierId:y("supplier_id").references(()=>R.id),supplierSku:i("supplier_sku"),unitOfMeasure:i("unit_of_measure").$type().notNull(),costPerUnit:p("cost_per_unit").notNull(),retailPrice:p("retail_price"),minimumStockLevel:p("minimum_stock_level").notNull(),reorderLevel:p("reorder_level").notNull(),reorderQuantity:p("reorder_quantity"),locationId:y("location_id").references(()=>B.id),barcode:i("barcode"),notes:i("notes"),tags:i("tags").array(),isActive:M("is_active").default(!0),createdAt:f("created_at").defaultNow(),updatedAt:f("updated_at").defaultNow(),lastCountDate:f("last_count_date"),imageUrl:i("image_url"),dimensions:Ie("dimensions"),autoBatchReorder:M("auto_batch_reorder").default(!1),materialType:i("material_type").$type(),materialId:i("material_id")}),Yo=P(O).omit({id:!0,createdAt:!0,updatedAt:!0}),Zo=["purchase","sale","adjustment","return","transfer","count","scrap","initial"],X=S("inventory_transactions",{id:C("id").primaryKey(),itemId:y("item_id").references(()=>O.id).notNull(),type:i("type").$type().notNull(),quantity:p("quantity").notNull(),unitCost:p("unit_cost"),locationId:y("location_id").references(()=>B.id),relatedOrderId:y("related_order_id").references(()=>g.id),notes:i("notes"),referenceNumber:i("reference_number"),createdAt:f("created_at").defaultNow(),createdBy:y("created_by").references(()=>J.id)}),Jo=P(X).omit({id:!0,createdAt:!0}),Xo=["draft","pending","approved","sent","partially_received","received","canceled"],K=S("purchase_orders",{id:C("id").primaryKey(),poNumber:i("po_number").notNull(),supplierId:y("supplier_id").references(()=>R.id).notNull(),orderDate:f("order_date").notNull(),expectedDeliveryDate:f("expected_delivery_date"),status:i("status").$type().default("draft").notNull(),subtotal:p("subtotal"),tax:p("tax"),shipping:p("shipping"),total:p("total"),notes:i("notes"),createdBy:y("created_by").references(()=>J.id),createdAt:f("created_at").defaultNow(),updatedAt:f("updated_at").defaultNow(),receivedDate:f("received_date"),supplierOrderConfirmation:i("supplier_order_confirmation"),shippingMethod:i("shipping_method"),paymentMethod:i("payment_method"),paymentTerms:i("payment_terms"),tracking:i("tracking"),attachments:i("attachments").array()}),es=P(K).omit({id:!0,createdAt:!0,updatedAt:!0}),$e=S("purchase_order_lines",{id:C("id").primaryKey(),purchaseOrderId:y("purchase_order_id").references(()=>K.id).notNull(),itemId:y("item_id").references(()=>O.id).notNull(),quantity:p("quantity").notNull(),unitCost:p("unit_cost").notNull(),lineTotal:p("line_total").notNull(),receivedQuantity:p("received_quantity").default("0"),notes:i("notes"),createdAt:f("created_at").defaultNow()}),ts=P($e).omit({id:!0,createdAt:!0}),ct=S("inventory_counts",{id:C("id").primaryKey(),countReference:i("count_reference").notNull(),startDate:f("start_date").notNull(),endDate:f("end_date"),status:i("status").default("in_progress").notNull(),notes:i("notes"),createdBy:y("created_by").references(()=>J.id),createdAt:f("created_at").defaultNow()}),rs=P(ct).omit({id:!0,createdAt:!0}),Kt=S("inventory_count_items",{id:C("id").primaryKey(),countId:y("count_id").references(()=>ct.id).notNull(),itemId:y("item_id").references(()=>O.id).notNull(),locationId:y("location_id").references(()=>B.id),expectedQuantity:p("expected_quantity"),actualQuantity:p("actual_quantity"),notes:i("notes"),countedBy:y("counted_by").references(()=>J.id),countedAt:f("counted_at"),createdAt:f("created_at").defaultNow()}),os=P(Kt).omit({id:!0,createdAt:!0}),Vt=S("payment_links",{id:C("id").primaryKey(),token:i("token").notNull().unique(),amount:p("amount",{precision:10,scale:2}).notNull(),description:i("description"),customerId:y("customer_id").references(()=>x.id),createdAt:f("created_at").defaultNow(),expiresAt:f("expires_at").notNull(),usedAt:f("used_at"),used:M("used").default(!1),paymentIntentId:i("payment_intent_id"),paymentStatus:i("payment_status").default("pending")}),ss=P(Vt).omit({id:!0,createdAt:!0,usedAt:!0,used:!0,paymentIntentId:!0,paymentStatus:!0}),as=["inventory_location","inventory_item","material_order","customer_order","production_status","artwork_location"],Oe=S("qr_codes",{id:C("id").primaryKey(),code:i("code").notNull().unique(),type:i("type").$type().notNull(),entityId:i("entity_id").notNull(),title:i("title").notNull(),description:i("description"),metadata:Ie("metadata"),createdAt:f("created_at").defaultNow(),lastScanned:f("last_scanned"),scanCount:y("scan_count").default(0),active:M("active").default(!0)}),Yt=P(Oe).omit({id:!0,createdAt:!0,lastScanned:!0,scanCount:!0}),ut=S("qr_code_scans",{id:C("id").primaryKey(),qrCodeId:y("qr_code_id").references(()=>Oe.id).notNull(),userId:y("user_id").references(()=>J.id),scannedAt:f("scanned_at").defaultNow(),location:i("location"),action:i("action"),metadata:Ie("metadata")}),Zt=P(ut).omit({id:!0,scannedAt:!0}),dt=S("material_locations",{id:C("id").primaryKey(),materialType:i("material_type").$type().notNull(),materialId:i("material_id").notNull(),locationId:y("location_id").references(()=>B.id).notNull(),qrCodeId:y("qr_code_id").references(()=>Oe.id),quantity:p("quantity").notNull().default("1"),notes:i("notes"),lastUpdated:f("last_updated").defaultNow(),active:M("active").default(!0)}),ns=P(dt).omit({id:!0,lastUpdated:!0}),A=S("notifications",{id:C("id").primaryKey(),title:i("title").notNull(),description:i("description").notNull(),source:i("source").notNull(),sourceId:i("source_id"),type:i("type").$type().notNull().default("info"),createdAt:f("created_at").defaultNow(),read:M("read").default(!1),actionable:M("actionable").default(!1),link:i("link"),smsEnabled:M("sms_enabled").default(!1),smsRecipient:i("sms_recipient"),userId:y("user_id").references(()=>J.id)}),is=P(A).omit({id:!0,createdAt:!0})});var Ne,Jt=F(()=>{"use strict";Ne=[{id:"larson-4512",name:"Larson Gold Leaf 4512",manufacturer:"Larson-Juhl",material:"wood",width:"2.5",depth:"1.75",price:"12.99",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#D4AF37"},{id:"larson-210286",name:"Larson Academie Black 210286",manufacturer:"Larson-Juhl",material:"wood",width:"1.25",depth:"0.75",price:"8.50",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#000000"},{id:"larson-655320",name:"Larson Biltmore Gold 655320",manufacturer:"Larson-Juhl",material:"wood",width:"1.5",depth:"0.875",price:"10.75",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#FFD700"},{id:"larson-460530",name:"Larson Ventura Silver 460530",manufacturer:"Larson-Juhl",material:"metal",width:"0.75",depth:"1.125",price:"9.25",catalogImage:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#C0C0C0"},{id:"larson-310445",name:"Larson Classic Walnut 310445",manufacturer:"Larson-Juhl",material:"wood",width:"2.0",depth:"1.25",price:"14.50",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#8B4513"},{id:"larson-220158",name:"Larson Heritage Cherry 220158",manufacturer:"Larson-Juhl",material:"wood",width:"1.75",depth:"1.0",price:"11.25",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#722F37"},{id:"nielsen-71",name:"Nielsen Florentine",manufacturer:"Nielsen",material:"metal",width:"1.25",depth:"0.75",price:"8.99",catalogImage:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#C0C0C0"},{id:"roma-250",name:"Roma Dark Walnut",manufacturer:"Roma Moulding",material:"wood",width:"3.0",depth:"2.0",price:"14.50",catalogImage:"https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#5C4033"},{id:"omega-102",name:"Omega Black Satin",manufacturer:"Omega Moulding",material:"wood",width:"2.0",depth:"1.5",price:"9.75",catalogImage:"https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#2D2D2D"},{id:"bella-35",name:"Bella White Simple",manufacturer:"Bella Moulding",material:"composite",width:"1.5",depth:"1.0",price:"6.50",catalogImage:"https://images.unsplash.com/photo-1574117936532-46e544aeb239?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjZ8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1574117936532-46e544aeb239?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjZ8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1574117936532-46e544aeb239?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjZ8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#F5F5F5"},{id:"larson-8921",name:"Larson Ornate Gold",manufacturer:"Larson-Juhl",material:"wood",width:"3.5",depth:"2.25",price:"18.99",catalogImage:"https://images.unsplash.com/photo-1581814605484-050c5bb1196c?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzF8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1581814605484-050c5bb1196c?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzF8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1581814605484-050c5bb1196c?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzF8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#D4AF37"}]});async function Xt(){try{return console.log("Loading static matboard data to prevent application freezing..."),[]}catch(s){return console.error("Error fetching Crescent matboards:",s),[]}}var er=F(()=>{"use strict"});var tr,cs,Me,us,rr=F(()=>{"use strict";er();tr=[{id:"white",name:"White",color:"#FFFFFF",price:"0.02",manufacturer:"Basic",code:"WHT",description:"Pure white mat board",category:"Standard"},{id:"black",name:"Black",color:"#2C2C2C",price:"0.025",manufacturer:"Basic",code:"BLK",description:"Deep black mat board",category:"Standard"},{id:"grey",name:"Grey",color:"#ADADAD",price:"0.02",manufacturer:"Basic",code:"GRY",description:"Neutral grey mat board",category:"Standard"},{id:"beige",name:"Beige",color:"#F5F5DC",price:"0.02",manufacturer:"Basic",code:"BGE",description:"Soft beige mat board",category:"Standard"}],cs=[{id:"crescent-white",name:"Bright White",color:"#FFFFFF",price:"0.025",manufacturer:"Crescent",code:"S100",description:"Bright white conservation mat board",category:"Whites"},{id:"crescent-cream",name:"Cream",color:"#FFF8E1",price:"0.025",manufacturer:"Crescent",code:"S101",description:"Cream white conservation mat board",category:"Whites"},{id:"crescent-antique",name:"Antique White",color:"#F5F1E6",price:"0.025",manufacturer:"Crescent",code:"S102",description:"Subtle antique white tone",category:"Whites"},{id:"crescent-stone",name:"Stone",color:"#E0DCCC",price:"0.027",manufacturer:"Crescent",code:"S200",description:"Light stone grey conservation mat",category:"Neutrals"},{id:"crescent-fog",name:"Fog",color:"#D6D6D6",price:"0.027",manufacturer:"Crescent",code:"S201",description:"Subtle fog grey conservation mat",category:"Neutrals"},{id:"crescent-granite",name:"Granite",color:"#A9A9A9",price:"0.027",manufacturer:"Crescent",code:"S202",description:"Darker granite grey tone",category:"Neutrals"},{id:"crescent-colonial-blue",name:"Colonial Blue",color:"#B5C7D3",price:"0.029",manufacturer:"Crescent",code:"S300",description:"Subtle colonial blue conservation mat",category:"Blues"},{id:"crescent-wedgewood",name:"Wedgewood",color:"#6E99C0",price:"0.029",manufacturer:"Crescent",code:"S301",description:"Classic wedgewood blue conservation mat",category:"Blues"},{id:"crescent-ultramarine",name:"Ultramarine",color:"#4166B0",price:"0.029",manufacturer:"Crescent",code:"S302",description:"Deep ultramarine blue conservation mat",category:"Blues"},{id:"crescent-sage",name:"Sage",color:"#BCCCBA",price:"0.029",manufacturer:"Crescent",code:"S400",description:"Soft sage green conservation mat",category:"Greens"},{id:"crescent-celadon",name:"Celadon",color:"#9CB084",price:"0.029",manufacturer:"Crescent",code:"S401",description:"Classic celadon green conservation mat",category:"Greens"},{id:"crescent-forest",name:"Forest",color:"#4A6741",price:"0.029",manufacturer:"Crescent",code:"S402",description:"Deep forest green conservation mat",category:"Greens"},{id:"crescent-sand",name:"Sand",color:"#E6D7B8",price:"0.027",manufacturer:"Crescent",code:"S500",description:"Light sand beige conservation mat",category:"Earth Tones"},{id:"crescent-chamois",name:"Chamois",color:"#D9BC8C",price:"0.027",manufacturer:"Crescent",code:"S501",description:"Warm chamois tan conservation mat",category:"Earth Tones"},{id:"crescent-chestnut",name:"Chestnut",color:"#A67B5B",price:"0.027",manufacturer:"Crescent",code:"S502",description:"Rich chestnut brown conservation mat",category:"Earth Tones"},{id:"crescent-pale-rose",name:"Pale Rose",color:"#F0D4D4",price:"0.029",manufacturer:"Crescent",code:"S600",description:"Subtle pale rose conservation mat",category:"Warm Tones"},{id:"crescent-dusty-rose",name:"Dusty Rose",color:"#D4A9A9",price:"0.029",manufacturer:"Crescent",code:"S601",description:"Classic dusty rose conservation mat",category:"Warm Tones"},{id:"crescent-rust",name:"Rust",color:"#B56A55",price:"0.029",manufacturer:"Crescent",code:"S602",description:"Deep rust red conservation mat",category:"Warm Tones"},{id:"crescent-black",name:"Raven Black",color:"#1A1A1A",price:"0.03",manufacturer:"Crescent",code:"S700",description:"Deep black conservation mat board",category:"Black"}],Me=[...tr,...cs],us=async()=>{if(typeof window>"u"){console.log("Skipping Supabase fetch on server-side");return}try{console.log("Fetching Crescent matboards from Larson Juhl catalog...");let s=await Xt();if(s&&s.length>0){console.log("Converting API matboards to MatColor format");let t=s.map(r=>({id:r.id,name:r.name,color:r.hex_color||"#FFFFFF",price:r.price,manufacturer:r.manufacturer,code:r.code||null,description:r.description||null,category:r.category||null}));Me=[...tr,...t],console.log(`Loaded and converted ${s.length} Crescent matboards from Larson Juhl catalog`)}else console.log("No Crescent matboards found in Larson Juhl catalog or empty response. Using static fallback data.")}catch(s){console.error("Failed to load Crescent matboards:",s),console.log("Using static Crescent matboard catalog as fallback.")}};typeof window<"u"&&us()});var Te,Le,or=F(()=>{"use strict";Te=[{id:"none",name:"No Glass",description:"No glass protection",price:"0.00"},{id:"regular",name:"Regular Glass",description:"Standard protection",price:"0.08"},{id:"uv",name:"Museum Glass",description:"Museum non-glare",price:"0.45"},{id:"museum",name:"Conservation Glass",description:"Premium UV protection",price:"0.25"}],Le=[{id:"float-mount",name:"Float Mount",description:"Artwork appears to float",price:"50.00"},{id:"glass-float",name:"Glass Float",description:"Suspended between glass",price:"55.00"},{id:"shadowbox",name:"Shadowbox",description:"For 3D objects",price:"65.00"},{id:"labor-30min",name:"Additional Labor (30 min)",description:"Custom work",price:"30.00"},{id:"labor-1hour",name:"Additional Labor (1 hour)",description:"Custom work",price:"55.00"}]});import{createClient as ds}from"@supabase/supabase-js";var We,sr=F(()=>{"use strict";We=null;try{let s=process.env.SUPABASE_URL||process.env.VITE_SUPABASE_URL,t=process.env.SUPABASE_KEY||process.env.VITE_SUPABASE_KEY||process.env.VITE_SUPABASE_ANON_KEY;s&&t?(We=ds(s,t),console.log("Server: Successfully initialized Supabase client")):(We={from:()=>({select:()=>Promise.resolve({data:[],error:null}),insert:()=>Promise.resolve({data:[],error:null}),update:()=>Promise.resolve({data:[],error:null}),delete:()=>Promise.resolve({data:null,error:null}),upsert:()=>Promise.resolve({data:null,error:null})}),rpc:()=>Promise.resolve({data:null,error:null})},console.log("Server: Using mock Supabase client - data operations will be handled by Drizzle/PostgreSQL"))}catch(s){console.error("Server: Error initializing Supabase client:",s),We={from:()=>({select:()=>Promise.resolve({data:[],error:null}),insert:()=>Promise.resolve({data:[],error:null}),update:()=>Promise.resolve({data:[],error:null}),delete:()=>Promise.resolve({data:null,error:null}),upsert:()=>Promise.resolve({data:null,error:null})}),rpc:()=>Promise.resolve({data:null,error:null})}}});import{Pool as ls,neonConfig as ms}from"@neondatabase/serverless";import{drizzle as ps}from"drizzle-orm/neon-serverless";import fs from"ws";var gs,u,V=F(()=>{"use strict";ee();sr();ms.webSocketConstructor=fs;if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL must be set. Did you forget to provision a database?");gs=new ls({connectionString:process.env.DATABASE_URL}),u=ps({client:gs,schema:lt})});function _e(s,t){let e=new Date().toISOString(),r=t?`[${t}]`:"";console.log(`${e} ${r} ${s}`)}var ar=F(()=>{"use strict"});function mt(s,t,e,r){let o=s/t,a=e+r;return o/a}function hs(s){return s>=40?2.2:s>=25?2.4:s>=15?2.6:s>=10?2.8:s>=6?3:s>=4?3.2:s>=2?3.5:4}function nr(s,t,e,r){let o=s+e*2,a=t+e*2,c=(o+a)/12*r,l=hs(c);return c*l}function ir(s,t,e,r){let o=s+e*2,a=t+e*2,n=o+a,d=n*r*2.5,c=5.5;n<=24?c=5.5:n<=36?c=5:n<=50?c=4.5:n<=68?c=4.2:n<=88?c=3.8:n<=108?c=3.5:c=3.2;let l=ys(n);return d*c+l}function cr(s,t,e,r){let o=s+e*2,a=t+e*2,n=o+a,d=n*r,c=4;return n<=24?c=4:n<=36?c=3.8:n<=50?c=3.5:n<=68?c=3.2:n<=88?c=3:n<=108?c=2.8:c=2.5,d*c}function ys(s){let t=15;return s<=24?t=15:s<=36?t=20:s<=50?t=25:s<=68?t=35:s<=88?t=45:s<=108?t=55:t=65,t}var ur=F(()=>{"use strict"});var mr={};oe(mr,{calculateFramePrice:()=>bs,calculateFramingPrice:()=>Ms,calculateGlassPrice:()=>xs,calculateMatPrice:()=>ws});function bs(s,t){let e=t*6,r=Is(e);return s*t*r*1.2}function ws(s,t,e){let r=vs(e);return t*s*r}function xs(s,t,e=0,r=0,o="regular"){let a=e&&r?e+r:Math.sqrt(t)*2,n=Cs(a),d=1;switch(o){case"conservation":d=1.5;break;case"museum":d=2;break}let c=t/144;return(a<=40?85:125)+c*s*n*.35*d}function Is(s){return s<=20?1.8:s<=40?2.2:s<=60?2.6:s<=80?3:3.4}function Cs(s){return s<=20?2.8:s<=40?3.2:s<=60?3.6:s<=80?4:4.5}function vs(s){return s<=20?2.5:s<=40?2.8:s<=60?3.1:s<=80?3.4:3.8}function Os(s,t,e,r){let o=r/40;return{frameAssembly:s?.25*o:0,matCutting:t?.3*o:0,glassCutting:e?.15*o:0,fitting:.2*o,finishing:.1*o}}function Ns(s,t,e){return(s.frameAssembly+s.matCutting+s.glassCutting+s.fitting+s.finishing)*t*e}async function Ms(s){let{frameId:t,matColorId:e,glassOptionId:r,artworkWidth:o,artworkHeight:a,matWidth:n,quantity:d,includeWholesalePrices:c=!1}=s,l=t&&t!=="none"?await h.getFrame(t):null,b=e&&e!=="none"?await h.getMatColor(e):null,w=r&&r!=="none"?await h.getGlassOption(r):null,j=o+a,Y=o+n*2,v=a+n*2,$=Y+v,T=Y*v-o*a,_=Y*2+v*2,I=c?{frame:l?l.price:"0.00",mat:"0.00",glass:w&&w.price||"0.00",backing:"0.00"}:void 0,he=0;if(l){let de=parseFloat(l.price);if(he=nr(o,a,n,de),I){let be=o+n*2,we=a+n*2,Z=(be+we)/12*de;I.frame=Z.toFixed(2)}}let tt=0;if(b){let L=mt(45.5,25,32,40);if(tt=ir(o,a,n,L),I){let Z=o+n*2,xe=a+n*2,Se=(Z+xe)*L;I.mat=Se.toFixed(2)}}let rt=0;if(w){let L=mt(125,10,24,36);if(rt=cr(o,a,n,L),I){let Z=o+n*2,xe=a+n*2,Se=(Z+xe)*L;I.glass=Se.toFixed(2)}}let $t=.04,Tt=Y*v,Lt=Tt*$t*Ss;I&&(I.backing=(Tt*$t).toFixed(2));let Wt=Os(!!l,!!b,!!w,$),ot=Ns(Wt,lr,dr),Gt=he+tt+rt+Lt,ye=Gt+ot,yo=ye*d,Ut;if(c&&I){let de=l?parseFloat(l.price)*_/12:0,be=b?parseFloat(I.mat):0,we=w&&w.price?parseFloat(w.price)*Y*v/144:0,Be=parseFloat(I.backing),L=de+be+we+Be,Z=L*Ps,xe=L+Z+ot,qe=ye-xe,Se=qe/ye,bo=ye/L;Ut={totalWholesaleCost:L,overheadCost:Z,grossProfit:qe,grossProfitMargin:Se,markupMultiplier:bo}}return{framePrice:he,matPrice:tt,glassPrice:rt,backingPrice:Lt,laborCost:ot,materialCost:Gt,subtotal:ye,totalPrice:yo,wholesalePrices:I,laborRates:{baseRate:lr,regionalFactor:dr,estimates:Wt},profitability:Ut}}var Ss,dr,lr,Ps,pr=F(()=>{"use strict";te();ur();Ss=1.2,dr=1.15,lr=45,Ps=.3});var Fe={};oe(Fe,{generateOrderStatusEmailTemplate:()=>Fs,sendEmailWithSendGrid:()=>_s});import fr from"@sendgrid/mail";async function _s(s){if(!process.env.SENDGRID_API_KEY){console.warn("SendGrid API key is not configured. Email sending is disabled.");return}try{await fr.send({to:s.to,from:s.from,subject:s.subject,text:s.text,html:s.html}),console.log(`Email sent successfully to ${s.to}`)}catch(t){throw console.error("SendGrid Error:",t),new Error(`Failed to send email: ${t.message}`)}}function Fs(s,t,e,r){let o=e.split("_").map(b=>b.charAt(0).toUpperCase()+b.slice(1)).join(" "),a=r?new Date(r).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}):"Not available",n=["order_processed","scheduled","materials_ordered","materials_arrived","frame_cut","mat_cut","prepped","completed"],d=n.indexOf(e),l=`
    <div style="margin: 20px 0; width: 100%;">
      <div style="width: 100%; background-color: #f0f0f0; height: 20px; border-radius: 10px; overflow: hidden;">
        <div style="width: ${Math.max(10,Math.min(100,Math.round((d+1)/n.length*100)))}%; background-color: #4CAF50; height: 20px;"></div>
      </div>
      <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 12px;">
        <span>Order Placed</span>
        <span>In Production</span>
        <span>Completed</span>
      </div>
    </div>
  `;return`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <title>Order Status Update</title>
      <style>
        body {
          font-family: Arial, sans-serif;
          line-height: 1.6;
          color: #333;
          margin: 0;
          padding: 0;
        }
        .container {
          max-width: 600px;
          margin: 0 auto;
          padding: 20px;
        }
        .header {
          background-color: #4A90E2;
          color: white;
          padding: 20px;
          text-align: center;
        }
        .content {
          padding: 20px;
          background-color: #f9f9f9;
        }
        .footer {
          text-align: center;
          padding: 20px;
          font-size: 12px;
          color: #666;
        }
        .button {
          display: inline-block;
          background-color: #4A90E2;
          color: white;
          padding: 10px 20px;
          text-decoration: none;
          border-radius: 5px;
          margin-top: 20px;
        }
        .status-box {
          background-color: #e8f4fd;
          border-left: 4px solid #4A90E2;
          padding: 15px;
          margin: 20px 0;
        }
        .details-table {
          width: 100%;
          border-collapse: collapse;
          margin: 20px 0;
        }
        .details-table th, .details-table td {
          border: 1px solid #ddd;
          padding: 10px;
          text-align: left;
        }
        .details-table th {
          background-color: #f0f0f0;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>Order Status Update</h1>
        </div>
        
        <div class="content">
          <p>Hello ${s},</p>
          
          <p>We're writing to provide you with an update on your custom framing order.</p>
          
          <div class="status-box">
            <h2>Order #${t} Status: ${o}</h2>
            <p>Your order is now in the <strong>${o}</strong> stage.</p>
            <p><strong>Estimated Completion:</strong> ${a}</p>
          </div>
          
          ${l}
          
          <h3>What's Next?</h3>
          <p>Your order is progressing through our custom framing process. Here's what's happening:</p>
          
          <table class="details-table">
            <tr>
              <th>Current Stage</th>
              <th>Description</th>
            </tr>
            <tr>
              <td>${o}</td>
              <td>${ks(e)}</td>
            </tr>
          </table>
          
          <p>We'll notify you when your order moves to the next stage or is ready for pickup.</p>
          
          <a href="#" class="button">Track Your Order</a>
        </div>
        
        <div class="footer">
          <p>Thank you for choosing Jays Frames Guru Framing</p>
          <p>123 Frame Street, Anytown, ST 12345</p>
          <p>Phone: (555) 123-4567 | Email: info@jaysframes.com</p>
        </div>
      </div>
    </body>
    </html>
  `}function ks(s){switch(s){case"order_processed":return"Your order has been processed and is scheduled for production.";case"scheduled":return"Your order has been scheduled and is in our production queue.";case"materials_ordered":return"We have ordered the special materials needed for your custom frame.";case"materials_arrived":return"All materials for your order have arrived and are ready for production.";case"frame_cut":return"Your frame has been cut to the specified dimensions.";case"mat_cut":return"Your mat board has been cut and prepared for assembly.";case"prepped":return"Your frame is assembled and is going through final quality checks.";case"completed":return"Your order is complete and ready for pickup!";case"delayed":return"Your order is temporarily delayed. We will contact you with more information.";default:return"Your order is being processed by our team."}}var pt=F(()=>{"use strict";process.env.SENDGRID_API_KEY&&fr.setApiKey(process.env.SENDGRID_API_KEY)});import{eq as m,desc as pe,sql as gr,asc as ft}from"drizzle-orm";function me(s){let{material:t,name:e}=s,r=t.toLowerCase(),o=e.toLowerCase();return r.includes("gold")||o.includes("gold")?"#D4AF37":r.includes("silver")||r.includes("metal")||o.includes("silver")||o.includes("metal")||o.includes("chrome")||o.includes("steel")?"#C0C0C0":r.includes("black")||o.includes("black")||o.includes("ebony")||o.includes("onyx")?"#000000":r.includes("white")||o.includes("white")?"#F5F5F5":r.includes("walnut")||o.includes("walnut")?"#5C4033":r.includes("cherry")||o.includes("cherry")?"#722F37":r.includes("oak")||o.includes("oak")?"#D8BE75":r.includes("mahogany")||o.includes("mahogany")?"#4E2728":r.includes("maple")||o.includes("maple")?"#E8D4A9":"#8B4513"}var gt,h,te=F(()=>{"use strict";ee();Jt();rr();or();V();ar();gt=class{async updateOrderArtLocation(t,e){try{let[r]=await u.update(g).set({artworkLocation:e}).where(m(g.id,t)).returning();if(!r)throw new Error("Order not found");return r}catch(r){throw console.error("Error updating order artwork location:",r),r}}async getOrderMats(t){try{let e=await u.select().from(Ce).where(m(Ce.orderId,t)),r=[];for(let o of e){let a=await this.getMatColor(o.matColorId);a&&r.push({...o,matboard:a})}return r}catch(e){return console.error(`Error getting order mats for order ${t}:`,e),[]}}async getOrderFrames(t){try{let e=await u.select().from(ve).where(m(ve.orderId,t)),r=[];for(let o of e){let a=await this.getFrame(o.frameId);a&&r.push({...o,frame:a})}return r}catch(e){return console.error(`Error getting order frames for order ${t}:`,e),[]}}async getOrderPricingDetails(t){try{let e=await this.getOrder(t);if(!e)return;let{calculatePricing:r}=(pr(),Ht(mr)),o=e.frameId?await this.getFrame(e.frameId):void 0,a=e.matColorId?await this.getMatColor(e.matColorId):void 0,n=e.glassOptionId?await this.getGlassOption(e.glassOptionId):void 0,d=await this.getOrderSpecialServices(t),c=await this.getOrderMats(t),l=await this.getOrderFrames(t),b={artworkWidth:Number(e.artworkWidth),artworkHeight:Number(e.artworkHeight),matWidth:Number(e.matWidth),frame:o,matColor:a,glassOption:n,specialServices:d,quantity:e.quantity||1,includeWholesalePrices:!0,mats:c.length>0?c:void 0,frames:l.length>0?l:void 0};return r(b)}catch(e){console.error("Error getting order pricing details:",e);return}}async getCustomer(t){let[e]=await u.select().from(x).where(m(x.id,t));return e||void 0}async getCustomerByEmail(t){let[e]=await u.select().from(x).where(m(x.email,t));return e||void 0}async getAllCustomers(){return await u.select().from(x)}async createCustomer(t){let[e]=await u.insert(x).values({...t,createdAt:new Date}).returning();return e}async updateCustomer(t,e){let[r]=await u.update(x).set(e).where(m(x.id,t)).returning();if(!r)throw new Error("Customer not found");return r}async getFrame(t){console.log(`Storage: Getting frame with ID: ${t}`);try{let[e]=await u.select().from(N).where(m(N.id,t));if(e){console.log(`Storage: Found frame in database: ${e.name}`);let o=me(e),a=e.catalogImage,n=e.corner||"",d=e.edgeTexture||"";if(e.manufacturer==="Larson-Juhl"){let c=e.id.split("-")[1];c&&(a=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_fab.jpg`,n=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_corner.jpg`,d=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_prof.jpg`)}if(e.manufacturer==="Nielsen"){let c=e.id.split("-")[1];c&&(a=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Detail.jpg`,n=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Corner.jpg`,d=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Edge.jpg`)}return{...e,catalogImage:a,corner:n,edgeTexture:d,color:o}}console.log("Storage: Frame not found in database, checking catalog");let r=Ne.find(o=>o.id===t);if(r){console.log(`Storage: Found frame in catalog: ${r.name}`);let o=r.catalogImage,a=r.corner||"",n=r.edgeTexture||"",d=r.color||me(r);if(r.manufacturer==="Larson-Juhl"){let l=r.id.split("-")[1];l&&(o=`https://www.larsonjuhl.com/contentassets/products/mouldings/${l}_fab.jpg`,a=`https://www.larsonjuhl.com/contentassets/products/mouldings/${l}_corner.jpg`,n=`https://www.larsonjuhl.com/contentassets/products/mouldings/${l}_prof.jpg`)}if(r.manufacturer==="Nielsen"){let l=r.id.split("-")[1];l&&(o=`https://www.nielsenbainbridge.com/images/products/detail/${l}-Detail.jpg`,a=`https://www.nielsenbainbridge.com/images/products/detail/${l}-Corner.jpg`,n=`https://www.nielsenbainbridge.com/images/products/detail/${l}-Edge.jpg`)}let c={...r,catalogImage:o,corner:a,edgeTexture:n};console.log(`Storage: Inserting enhanced frame into database: ${c.name}`);try{await u.insert(N).values(c),console.log("Storage: Successfully inserted frame into database")}catch(l){console.error("Storage: Error inserting frame into database:",l)}return{...c,color:d}}console.log("Storage: Frame not found in catalog");return}catch(e){console.error(`Storage: Error in getFrame(${t}):`,e);let r=Ne.find(o=>o.id===t);if(r){let o=me(r),a=r.catalogImage;if(r.manufacturer==="Larson-Juhl"){let n=r.id.split("-")[1];n&&(a=`https://www.larsonjuhl.com/contentassets/products/mouldings/${n}_fab.jpg`)}else if(r.manufacturer==="Nielsen"){let n=r.id.split("-")[1];n&&(a=`https://www.nielsenbainbridge.com/images/products/detail/${n}-Detail.jpg`)}return{...r,catalogImage:a,color:o}}return}}async getAllFrames(){console.log("Storage: Getting all frames");try{let t=await u.select().from(N);return console.log(`Storage: Found ${t.length} frames in database`),t.length>0?(console.log("Storage: Enhancing existing frames with real wholesaler images"),t.map(r=>{let o=me(r),a=r.catalogImage,n=r.corner||"",d=r.edgeTexture||"";if(r.manufacturer==="Larson-Juhl"){let c=r.id.split("-")[1];c&&(a=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_fab.jpg`,n=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_corner.jpg`,d=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_prof.jpg`)}if(r.manufacturer==="Nielsen"){let c=r.id.split("-")[1];c&&(a=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Detail.jpg`,n=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Corner.jpg`,d=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Edge.jpg`)}return{...r,catalogImage:a,corner:n,edgeTexture:d,color:o}})):(console.log("Storage: No frames in database, returning enhanced catalog data"),Ne.map(r=>{let o=r.catalogImage,a=r.corner||"",n=r.edgeTexture||"",d=r.color||me(r);if(r.manufacturer==="Larson-Juhl"){let l=r.id.split("-")[1];l&&(o=`https://www.larsonjuhl.com/contentassets/products/mouldings/${l}_fab.jpg`,a=`https://www.larsonjuhl.com/contentassets/products/mouldings/${l}_corner.jpg`,n=`https://www.larsonjuhl.com/contentassets/products/mouldings/${l}_prof.jpg`)}if(r.manufacturer==="Nielsen"){let l=r.id.split("-")[1];l&&(o=`https://www.nielsenbainbridge.com/images/products/detail/${l}-Detail.jpg`,a=`https://www.nielsenbainbridge.com/images/products/detail/${l}-Corner.jpg`,n=`https://www.nielsenbainbridge.com/images/products/detail/${l}-Edge.jpg`)}let c={...r,catalogImage:o,corner:a,edgeTexture:n};try{u.insert(N).values(c).execute()}catch(l){console.error(`Storage: Error inserting frame ${r.id} into database:`,l)}return{...c,color:d}}))}catch(t){return console.error("Storage: Error in getAllFrames:",t),Ne.map(e=>{let r=me(e),o=e.id.split("-")[1],a=e.catalogImage;return e.manufacturer==="Larson-Juhl"?a="https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D":e.manufacturer==="Roma"?a="https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D":e.manufacturer==="Omega"?a="https://images.unsplash.com/photo-1513519245088-0e12902e5a38?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8ZnJhbWV8ZW58MHx8MHx8fDA%3D":a="https://images.unsplash.com/photo-1518998053901-5348d3961a04?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fGZyYW1lfGVufDB8fDB8fHww",{...e,catalogImage:a,color:r}})}}async updateFrame(t,e){let[r]=await u.update(N).set(e).where(m(N.id,t)).returning();if(!r)throw new Error("Frame not found");return r}async addFrame(t){console.log(`Storage: Adding new frame to database: ${t.name} (${t.id})`);try{let[e]=await u.insert(N).values(t).returning();return console.log("Storage: Successfully added frame to database"),e}catch(e){throw console.error("Storage: Error adding frame to database:",e),e}}async searchFramesByItemNumber(t){console.log(`Storage: Searching frames by item number: ${t}`);try{let e=await this.getAllFrames(),r=t.toLowerCase();return e.filter(o=>(o.id.split("-")[1]?.toLowerCase()||"").includes(r))}catch(e){return console.error("Storage: Error searching frames by item number:",e),[]}}async getMatColor(t){let[e]=await u.select().from(G).where(m(G.id,t));if(!e){let r=Me.find(o=>o.id===t);if(r)return await u.insert(G).values(r),r}return e||void 0}async getAllMatColors(){let t=await u.select().from(G);return t.length===0?(await u.insert(G).values(Me),Me):t}async getGlassOption(t){let[e]=await u.select().from(H).where(m(H.id,t));if(!e){let r=Te.find(o=>o.id===t);if(r)return await u.insert(H).values(r),r}return e||void 0}async getAllGlassOptions(){let t=await u.select().from(H);return t.length===0?(await u.insert(H).values(Te),Te):t}async getSpecialService(t){let[e]=await u.select().from(z).where(m(z.id,t));if(!e){let r=Le.find(o=>o.id===t);if(r)return await u.insert(z).values(r),r}return e||void 0}async getAllSpecialServices(){let t=await u.select().from(z);return t.length===0?(await u.insert(z).values(Le),Le):t}async getOrderGroup(t){let[e]=await u.select().from(E).where(m(E.id,t));return e||void 0}async getActiveOrderGroupByCustomer(t){let[e]=await u.select().from(E).where(m(E.customerId,t));return e&&e.status==="open"?e:void 0}async getAllOrderGroups(){return await u.select().from(E)}async createOrderGroup(t){let[e]=await u.insert(E).values({...t,status:"open",createdAt:new Date}).returning();return e}async updateOrderGroup(t,e){let[r]=await u.update(E).set(e).where(m(E.id,t)).returning();if(!r)throw new Error("Order group not found");return r}async getOrderGroupsByCustomerId(t){try{console.log(`Storage: Getting order groups for customer ID: ${t}`);let e=await u.select().from(E).where(m(E.customerId,t));return console.log(`Storage: Found ${e.length} order groups for customer ID: ${t}`),e}catch(e){throw console.error("Storage: Error getting order groups by customer ID:",e),e}}async getOrdersByGroupId(t){return await u.select().from(g).where(m(g.orderGroupId,t))}async getOrder(t){let[e]=await u.select().from(g).where(m(g.id,t));return e||void 0}async getAllOrders(){return await u.select().from(g)}async createOrder(t){try{if(!t.artworkImage)throw new Error("CRITICAL VALIDATION ERROR: Every order must have an artwork image. This is mandatory for business operations.");console.log("DatabaseStorage.createOrder - Inserting order with data:",t);let[e]=await u.insert(g).values(t).returning();return console.log("DatabaseStorage.createOrder - Order created successfully:",e),e}catch(e){throw console.error("DatabaseStorage.createOrder - Error creating order:",e),e}}async updateOrder(t,e){let[r]=await u.update(g).set(e).where(m(g.id,t)).returning();if(!r)throw new Error("Order not found");return r}async deleteOrder(t){await u.delete(g).where(m(g.id,t))}async createOrderSpecialService(t){let[e]=await u.insert(le).values(t).returning();return e}async getOrderSpecialServices(t){let r=(await u.select().from(le).where(m(le.orderId,t))).map(a=>a.specialServiceId),o=[];for(let a of r)if(a){let n=await this.getSpecialService(a);n&&o.push(n)}return o}async getWholesaleOrder(t){let[e]=await u.select().from(Q).where(m(Q.id,t));return e||void 0}async getAllWholesaleOrders(){return await u.select().from(Q)}async createWholesaleOrder(t){let[e]=await u.insert(Q).values({...t,status:"pending",createdAt:new Date}).returning();return e}async updateWholesaleOrder(t,e){let[r]=await u.update(Q).set(e).where(m(Q.id,t)).returning();if(!r)throw new Error("Wholesale order not found");return r}async getOrdersByProductionStatus(t){return await u.select().from(g).where(m(g.productionStatus,t)).orderBy(g.lastStatusChange)}async updateOrderProductionStatus(t,e){let[r]=await u.select().from(g).where(m(g.id,t));if(!r)throw new Error("Order not found");let o=r.productionStatus,[a]=await u.update(g).set({productionStatus:e,lastStatusChange:new Date}).where(m(g.id,t)).returning();if(a.notificationsEnabled){let[n]=await u.select().from(x).where(m(x.id,r.customerId));if(n)try{let{sendOrderStatusUpdate:d}=await Promise.resolve().then(()=>(pt(),Fe)),c=await d(n.email,n.name,r.id,e,o,r.estimatedCompletionDays);await this.createCustomerNotification({customerId:n.id,orderId:r.id,notificationType:"status_update",channel:"email",subject:`Order #${r.id} Status Update: ${e}`,message:`Your order is now ${e.split("_").join(" ")}. Check your email for details.`,successful:c,previousStatus:o,newStatus:e,responseData:c?{sent:!0,timestamp:new Date().toISOString()}:{sent:!1,error:"Email failed to send"}}),console.log(`Status update email ${c?"sent":"failed"} for Order #${r.id} to ${n.email}`)}catch(d){console.error("Error sending status update email:",d),await this.createCustomerNotification({customerId:n.id,orderId:r.id,notificationType:"status_update",channel:"email",subject:`Order #${r.id} Status Update: ${e}`,message:`Your order is now ${e.split("_").join(" ")}.`,successful:!1,previousStatus:o,newStatus:e,responseData:{error:d.message}})}}return a}async getOrdersForKanban(){return(await u.select({order:g,customer:x}).from(g).leftJoin(x,m(g.customerId,x.id)).orderBy(g.lastStatusChange)).map(e=>({...e.order,customerName:e.customer?e.customer.name:"Unknown Customer",customerPhone:e.customer?.phone||"No phone",customerEmail:e.customer?.email||"No email"}))}async scheduleOrderForProduction(t,e){let[r]=await u.select().from(g).where(m(g.id,t));if(!r)throw new Error("Order not found");let[o]=await u.update(g).set({estimatedCompletionDays:e,productionStatus:"scheduled"}).where(m(g.id,t)).returning();if(o.notificationsEnabled){let[a]=await u.select().from(x).where(m(x.id,r.customerId));if(a){let n=new Date;n.setDate(n.getDate()+e),await this.createCustomerNotification({customerId:a.id,orderId:r.id,notificationType:"estimated_completion",channel:"email",subject:`Your Custom Framing Order #${r.id} Has Been Scheduled`,message:`Your custom framing order #${r.id} has been scheduled for production. The estimated completion date is ${n.toLocaleDateString()}.`,successful:!0,previousStatus:r.productionStatus,newStatus:"scheduled"})}}return o}async createCustomerNotification(t){let[e]=await u.insert(U).values({...t,sentAt:new Date}).returning();return e}async getCustomerNotifications(t){return await u.select().from(U).where(m(U.customerId,t)).orderBy(U.sentAt,"desc")}async getNotificationsByOrder(t){return await u.select().from(U).where(m(U.orderId,t)).orderBy(U.sentAt,"desc")}async getMaterialOrder(t){let[e]=await u.select().from(k).where(m(k.id,t));return e}async getAllMaterialOrders(){try{let t=await u.execute(gr`
        SELECT column_name 
        FROM information_schema.columns 
        WHERE table_name = 'material_orders'
      `);return await u.execute(gr`
        SELECT * FROM material_orders
        ORDER BY created_at DESC
      `)}catch(t){return console.error("Error in getAllMaterialOrders:",t),[]}}async getMaterialOrdersByStatus(t){try{return await u.select().from(k).where(m(k.status,t)).orderBy(pe(k.createdAt))}catch(e){return console.error("Error in getMaterialOrdersByStatus:",e),[]}}async getMaterialOrdersByType(t){try{return await u.select().from(k).where(m(k.materialType,t)).orderBy(pe(k.createdAt))}catch(e){return console.error("Error in getMaterialOrdersByType:",e),[]}}async createMaterialOrder(t){console.log("Creating material order with data:",t);let e={...t};e.vendor&&!e.supplierName&&(e.supplierName=e.vendor,delete e.vendor),console.log("Cleaned data for material order creation:",e);try{let[r]=await u.insert(k).values(e).returning();return console.log("Successfully created material order:",r.id),r}catch(r){throw console.error("Error creating material order:",r),r}}async updateMaterialOrder(t,e){console.log("updateMaterialOrder called with id:",t,"and data:",e);let r=typeof t=="string"&&!isNaN(parseInt(t))?parseInt(t):t,o={...e};o.vendor&&!o.supplierName&&(o.supplierName=o.vendor,delete o.vendor),console.log("Cleaned data for update:",o);try{let[a]=await u.update(k).set(o).where(m(k.id,r)).returning();return console.log("Successfully updated material order:",a.id),a}catch(a){throw console.error("Error updating material order:",a),a}}async deleteMaterialOrder(t){await u.delete(k).where(m(k.id,t))}async getAllInventoryItems(){try{return await u.select().from(O).orderBy(ft(O.name))}catch(t){return console.error("Error in getAllInventoryItems:",t),[]}}async getInventoryItem(t){try{let[e]=await u.select().from(O).where(m(O.id,t));return e}catch(e){console.error("Error in getInventoryItem:",e);return}}async getInventoryItemByBarcode(t){try{let[e]=await u.select().from(O).where(m(O.barcode,t));return e}catch(e){console.error("Error in getInventoryItemByBarcode:",e);return}}async createInventoryItem(t){try{t.sku||(t.sku=`INV-${Date.now().toString(36).toUpperCase()}`);let{initialQuantity:e,...r}=t,[o]=await u.insert(O).values(r).returning();return e&&await this.createInventoryTransaction({itemId:o.id,type:"initial",quantity:e,unitCost:t.costPerUnit,notes:"Initial inventory setup"}),o}catch(e){throw console.error("Error in createInventoryItem:",e),e}}async updateInventoryItem(t,e){try{let[r]=await u.update(O).set({...e,updatedAt:new Date}).where(m(O.id,t)).returning();return r}catch(r){throw console.error("Error in updateInventoryItem:",r),r}}async deleteInventoryItem(t){try{await u.delete(X).where(m(X.itemId,t)),await u.delete(O).where(m(O.id,t))}catch(e){throw console.error("Error in deleteInventoryItem:",e),e}}async getLowStockItems(){try{let t=await u.select().from(O),e=[];for(let r of t){let o=await this.getItemCurrentStock(r.id);o<=Number(r.reorderLevel)&&e.push({...r,currentStock:o})}return e}catch(t){return console.error("Error in getLowStockItems:",t),[]}}async getItemCurrentStock(t){try{let e=await u.select().from(X).where(m(X.itemId,t)),r=0;for(let o of e){let a=Number(o.quantity);switch(o.type){case"purchase":case"initial":case"adjustment":r+=a;break;case"sale":case"scrap":r-=a;break}}return r}catch(e){return console.error("Error in getItemCurrentStock:",e),0}}async createInventoryTransaction(t){try{let[e]=await u.insert(X).values(t).returning();return t.type==="count"&&await u.update(O).set({lastCountDate:new Date,updatedAt:new Date}).where(m(O.id,t.itemId)),e}catch(e){throw console.error("Error in createInventoryTransaction:",e),e}}async getAllSuppliers(){try{return await u.select().from(R).orderBy(ft(R.name))}catch(t){return console.error("Error in getAllSuppliers:",t),[]}}async getSupplier(t){try{let[e]=await u.select().from(R).where(m(R.id,t));return e}catch(e){console.error("Error in getSupplier:",e);return}}async createSupplier(t){try{let[e]=await u.insert(R).values(t).returning();return e}catch(e){throw console.error("Error in createSupplier:",e),e}}async updateSupplier(t,e){try{let[r]=await u.update(R).set(e).where(m(R.id,t)).returning();return r}catch(r){throw console.error("Error in updateSupplier:",r),r}}async deleteSupplier(t){try{await u.delete(R).where(m(R.id,t))}catch(e){throw console.error("Error in deleteSupplier:",e),e}}async getAllInventoryLocations(){try{return await u.select().from(B).orderBy(ft(B.name))}catch(t){return console.error("Error in getAllInventoryLocations:",t),[]}}async getInventoryLocation(t){try{let[e]=await u.select().from(B).where(m(B.id,t));return e}catch(e){console.error("Error in getInventoryLocation:",e);return}}async createInventoryLocation(t){try{let[e]=await u.insert(B).values(t).returning();return e}catch(e){throw console.error("Error in createInventoryLocation:",e),e}}async getAllPurchaseOrders(){try{return await u.select().from(K).orderBy(pe(K.createdAt))}catch(t){return console.error("Error in getAllPurchaseOrders:",t),[]}}async getPurchaseOrder(t){try{let[e]=await u.select().from(K).where(m(K.id,t));return e}catch(e){console.error("Error in getPurchaseOrder:",e);return}}async createPurchaseOrderWithLines(t,e){try{let r=`PO-${Date.now().toString(36).toUpperCase()}`,o=0;for(let c of e){let l=Number(c.quantity)*Number(c.unitCost);o+=l}let a=o*.08,n=o+a+Number(t.shipping||0),[d]=await u.insert(K).values({...t,poNumber:r,subtotal:o.toString(),tax:a.toString(),total:n.toString()}).returning();for(let c of e){let l=Number(c.quantity)*Number(c.unitCost);await u.insert($e).values({...c,purchaseOrderId:d.id,lineTotal:l.toString()})}return d}catch(r){throw console.error("Error in createPurchaseOrderWithLines:",r),r}}async getInventoryValuation(){try{let t=await this.getAllInventoryItems(),e=0,r={};for(let a of t){let d=await this.getItemCurrentStock(a.id)*Number(a.costPerUnit);if(e+=d,a.categoryId){let l=(await this.getInventoryCategory(a.categoryId))?.name||"Uncategorized";r[l]||(r[l]=0),r[l]+=d}else r.Uncategorized||(r.Uncategorized=0),r.Uncategorized+=d}let o=Object.entries(r).map(([a,n])=>({category:a,value:n}));return{totalValue:e,itemCount:t.length,valuationByCategory:o}}catch(t){return console.error("Error in getInventoryValuation:",t),{totalValue:0,itemCount:0,valuationByCategory:[]}}}async getInventoryCategory(t){try{let[e]=await u.select().from(se).where(m(se.id,t));return e}catch(e){console.error("Error in getInventoryCategory:",e);return}}async generateRecommendedPurchaseOrders(){try{let t=await this.getLowStockItems(),e={};for(let r of t)if(r.supplierId){let o=await this.getSupplier(r.supplierId);o&&(e[o.id]||(e[o.id]={supplierId:o.id,supplierName:o.name,items:[]}),e[o.id].items.push({itemId:r.id,name:r.name,sku:r.sku,currentStock:await this.getItemCurrentStock(r.id),reorderLevel:Number(r.reorderLevel),reorderQuantity:Number(r.reorderQuantity||r.reorderLevel)}))}return Object.values(e)}catch(t){return console.error("Error in generateRecommendedPurchaseOrders:",t),[]}}async importInventoryFromCSV(t){try{return{success:!0,importedCount:0,errors:[]}}catch(e){return console.error("Error in importInventoryFromCSV:",e),{success:!1,importedCount:0,errors:["Failed to import CSV data"]}}}async exportInventoryToCSV(){try{return`id,sku,name,description,quantity
`}catch(t){throw console.error("Error in exportInventoryToCSV:",t),t}}async createNotification(t){let[e]=await u.insert(A).values(t).returning();return e}async getNotification(t){let[e]=await u.select().from(A).where(m(A.id,t));return e||void 0}async getNotifications(t){let e=u.select().from(A).orderBy(pe(A.createdAt));return t&&(e=e.limit(t)),await e}async getUnreadNotifications(){return await u.select().from(A).where(m(A.read,!1)).orderBy(pe(A.createdAt))}async markNotificationAsRead(t){let[e]=await u.update(A).set({read:!0}).where(m(A.id,t)).returning();return e}async getNotificationsByUser(t){return await u.select().from(A).where(m(A.userId,t)).orderBy(pe(A.createdAt))}async getMaterialsPickList(){try{return[{id:"mat-pick-1",orderIds:[1,2],name:"Modern Black Frame Moulding",sku:"LJ-MB-001",supplier:"Larson-Juhl",type:"frame",quantity:25,status:"pending",priority:"high",notes:"Urgent for customer orders",orderDate:null,receiveDate:null},{id:"mat-pick-2",orderIds:[3],name:"White Core Matboard",sku:"CR-WC-003",supplier:"Crescent",type:"mat",quantity:50,status:"ordered",priority:"medium",notes:"Standard white matboard",orderDate:new Date(Date.now()-3*24*60*60*1e3).toISOString(),receiveDate:null},{id:"mat-pick-3",orderIds:[4,5],name:"Museum Glass 32x40",sku:"TV-MG-3240",supplier:"Tru Vue",type:"glass",quantity:15,status:"received",priority:"low",notes:"Premium conservation glass",orderDate:new Date(Date.now()-7*24*60*60*1e3).toISOString(),receiveDate:new Date(Date.now()-2*24*60*60*1e3).toISOString()},{id:"mat-pick-4",orderIds:[6],name:"Gold Leaf Frame Moulding",sku:"LJ-GL-007",supplier:"Larson-Juhl",type:"frame",quantity:12,status:"backorder",priority:"high",notes:"Custom gold finish",orderDate:new Date(Date.now()-5*24*60*60*1e3).toISOString(),receiveDate:null}]}catch(t){throw _e(`Error in getMaterialsPickList: ${t}`,"storage"),t}}async getMaterialsForOrder(t){try{return(await this.getMaterialsPickList()).filter(r=>r.orderIds.includes(t))}catch(e){throw _e(`Error in getMaterialsForOrder: ${e}`,"storage"),e}}async updateMaterialOrder(t,e){try{let o=(await this.getMaterialsPickList()).find(a=>a.id===t);if(!o)throw new Error(`Material with ID ${t} not found`);return{...o,...e,updatedAt:new Date().toISOString()}}catch(r){throw _e(`Error in updateMaterialOrder: ${r}`,"storage"),r}}async createPurchaseOrder(t){try{let r=(await this.getMaterialsPickList()).filter(n=>t.includes(n.id));if(r.length===0)throw new Error("No valid materials found for purchase order");let o=r.reduce((n,d)=>{let c=d.type==="frame"?25.99:d.type==="glass"?45.99:18.99;return n+d.quantity*c},0);return{id:"po-"+Date.now(),orderNumber:`PO-${new Date().getFullYear()}-${String(Math.floor(Math.random()*1e3)).padStart(3,"0")}`,materialIds:t,totalAmount:o,status:"draft",createdAt:new Date().toISOString(),expectedDeliveryDate:new Date(Date.now()+14*24*60*60*1e3).toISOString(),materials:r}}catch(e){throw _e(`Error in createPurchaseOrder: ${e}`,"storage"),e}}},h=new gt});import{eq as ti,and as ri}from"drizzle-orm";var kr=F(()=>{"use strict";V();ee()});var Ar={};oe(Ar,{getCustomerOrderStatusHistory:()=>Ls,getOrderStatusHistory:()=>Ts,notifyCustomerOfStatusChange:()=>Ws,recordStatusChange:()=>$s});import{sql as Ae}from"drizzle-orm";async function $s(s,t,e,r){try{await u.execute(Ae`
      INSERT INTO order_status_history (order_id, previous_status, new_status, notes)
      VALUES (${s}, ${t}, ${e}, ${r||null})
    `);let[o]=await u.execute(Ae`
      SELECT * FROM order_status_history 
      WHERE order_id = ${s}
      ORDER BY changed_at DESC LIMIT 1
    `);return o}catch(o){throw console.error("Error recording status change:",o),o}}async function Ts(s){try{return await u.execute(Ae`
      SELECT * FROM order_status_history 
      WHERE order_id = ${s}
      ORDER BY changed_at DESC
    `)}catch(t){throw console.error("Error fetching order status history:",t),t}}async function Ls(s){try{return await u.execute(Ae`
      SELECT h.*, o.id as order_id, o.frame_name, o.artwork_description
      FROM order_status_history h
      JOIN orders o ON h.order_id = o.id
      WHERE o.customer_id = ${s}
      ORDER BY h.changed_at DESC
    `)}catch(t){throw console.error("Error fetching customer order status history:",t),t}}async function Ws(s,t,e){try{if(!s.customerId)return;let[r]=await u.execute(Ae`
      SELECT * FROM customers WHERE id = ${s.customerId}
    `);return!r||!r.status_notifications_enabled?void 0:(await(void 0)(r.email,r.name,s.id,e,s.dueDate),!0)}catch(r){return console.error("Error notifying customer of status change:",r),!1}}var Dr=F(()=>{"use strict";V();pt()});var De={};oe(De,{configureKanbanConnection:()=>_t,generateApiKey:()=>Gs,getAllOrdersWithQrCodes:()=>vt,getIntegrationDocs:()=>Hs,getIntegrationStatus:()=>Us,getOrderWithQrCode:()=>Ct,receiveWebhook:()=>Nt,testIntegration:()=>Mt,updateOrderStatus:()=>Ot});async function Ct(s,t){try{let{id:e}=s.params,r=parseInt(e);if(isNaN(r))return t.status(400).json({error:"Invalid order ID"});let o=await h.getOrder(r);if(!o)return t.status(404).json({error:"Order not found"});let a=await(void 0)(r);t.json({success:!0,order:{...o,qrCode:a}})}catch(e){console.error("Error fetching order with QR code:",e),t.status(500).json({error:e.message||"Failed to fetch order information"})}}async function vt(s,t){try{let{status:e,limit:r}=s.query,o=r?parseInt(r):void 0,a=await h.getOrders(e),n=o?a.slice(0,o):a,d=await Promise.all(n.map(async c=>{let l=await(void 0)(c.id);return{...c,qrCode:l}}));t.json({success:!0,count:d.length,orders:d})}catch(e){console.error("Error fetching orders with QR codes:",e),t.status(500).json({error:e.message||"Failed to fetch orders"})}}async function Ot(s,t){try{let{id:e}=s.params,{status:r,notes:o}=s.body,a=parseInt(e);if(isNaN(a))return t.status(400).json({error:"Invalid order ID"});if(!r)return t.status(400).json({error:"Status is required"});let n=await h.getOrder(a);if(!n)return t.status(404).json({error:"Order not found"});let d=await h.updateOrder(a,{status:r,notes:o||`Status updated via Integration API to: ${r}`});try{await(Dr(),Ht(Ar)).addStatusHistory(a,{previousStatus:n.status,newStatus:r,changedBy:"Integration API",notes:o||"Status updated via Integration API"})}catch(c){console.warn("Could not log status history:",c)}t.json({success:!0,message:"Order status updated",order:d})}catch(e){console.error("Error updating order status:",e),t.status(500).json({error:e.message||"Failed to update order status"})}}async function Nt(s,t){try{let{source:e,event:r,data:o}=s.body;if(!e||!r)return t.status(400).json({error:"Source and event are required"});switch(console.log(`Received webhook from ${e}, event: ${r}`),e){case"qr_generator":if(r==="qr_generated"&&o&&o.orderId){let a=parseInt(o.orderId);await h.updateOrder(a,{hasQrCode:!0,qrCodeGeneratedAt:new Date,qrCodeData:o.qrData})}break;case"printing_system":if(r==="invoice_printed"&&o&&o.orderId){let a=parseInt(o.orderId);await h.updateOrder(a,{invoicePrinted:!0,printedAt:new Date})}break;default:console.log(`Unknown webhook source: ${e}`)}t.json({success:!0,message:`Webhook received from ${e} for event ${r}`})}catch(e){console.error("Error processing webhook:",e),t.status(500).json({error:e.message||"Failed to process webhook"})}}async function Gs(s,t){try{t.setHeader("Content-Type","application/json");let e=Date.now(),r=Math.random().toString(36).substring(2,15),o=`jf_api_${e}_${r}`,a={key:o,name:"Jay's Frames API Integration",permissions:["orders:read","orders:write","integration:webhook","pricing:read","catalog:read"],createdAt:new Date().toISOString(),lastUsed:null};console.log("New API Key generated:",o);let n={success:!0,...a,message:"API key generated successfully. Store this securely.",endpoints:{baseUrl:process.env.REPL_URL||`https://${process.env.REPL_SLUG}.${process.env.REPL_OWNER}.repl.co`,orders:"/api/integration/orders",webhook:"/api/integration/webhook",status:"/api/integration/status",pricing:"/api/pricing/calculate",catalog:"/api/vendor-catalog/frames"},authentication:{method:"Bearer Token",header:"Authorization",value:`Bearer ${o}`}};return t.status(200).json(n)}catch(e){console.error("Error generating API key:",e),t.setHeader("Content-Type","application/json"),t.status(500).json({success:!1,error:e.message||"Failed to generate API key"})}}async function Mt(s,t){try{t.json({success:!0,message:"Integration API is working correctly",timestamp:new Date().toISOString(),endpoints:{baseUrl:process.env.REPL_URL||"https://your-repl-url.replit.dev",orders:"/api/integration/orders",webhook:"/api/integration/webhook",configureKanban:"/api/integration/configure-kanban"}})}catch(e){console.error("Error in test integration:",e),t.status(500).json({success:!1,error:e.message||"Integration test failed"})}}async function _t(s,t){try{let{kanbanApiUrl:e,kanbanApiKey:r}=s.body;if(!e||!r)return t.status(400).json({success:!1,error:"Both kanbanApiUrl and kanbanApiKey are required"});try{let o=await fetch(`${e}/api/kanban/status`,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},timeout:5e3});if(!o.ok)throw new Error(`Connection test failed: ${o.status}`);let a=await o.json();t.json({success:!0,message:"Kanban connection configured successfully",kanbanStatus:a,configuration:{kanbanApiUrl:e,apiKeyConfigured:!0}})}catch(o){t.status(400).json({success:!1,error:`Failed to connect to Kanban app: ${o.message}`})}}catch(e){console.error("Error configuring Kanban connection:",e),t.status(500).json({success:!1,error:e.message||"Failed to configure Kanban connection"})}}async function Us(s,t){try{t.json({success:!0,status:"active",integrations:{webhooks:{enabled:!0,endpointCount:0},apiAccess:{enabled:!0,lastGenerated:new Date().toISOString()}},endpoints:{baseUrl:process.env.REPL_URL||"https://your-repl-url.replit.dev",orders:"/api/integration/orders",webhook:"/api/integration/webhook"}})}catch(e){console.error("Error getting integration status:",e),t.status(500).json({success:!1,error:e.message||"Failed to get integration status"})}}async function Hs(s,t){try{t.json({success:!0,documentation:{authentication:{method:"Bearer Token",header:"Authorization",example:"Authorization: Bearer YOUR_API_KEY"},endpoints:[{method:"GET",path:"/api/integration/orders",description:"Get all orders with QR codes",parameters:{status:"optional - filter by order status",limit:"optional - limit number of results"}},{method:"GET",path:"/api/integration/orders/:id",description:"Get specific order with QR code",parameters:{id:"required - order ID"}},{method:"PATCH",path:"/api/integration/orders/:id/status",description:"Update order status",body:{status:"required - new status",notes:"optional - status change notes"}},{method:"POST",path:"/api/integration/webhook",description:"Receive webhook notifications",body:{source:"required - webhook source",event:"required - event type",data:"optional - event data"}}],webhookEvents:["order.created","order.updated","order.completed","payment.received","qr.generated"]}})}catch(e){console.error("Error getting integration docs:",e),t.status(500).json({success:!1,error:e.message||"Failed to get integration documentation"})}}var fe=F(()=>{"use strict";te();kr()});var Rt={};oe(Rt,{addCustomer:()=>ga,customerProfiles:()=>ue,getCustomerByEmail:()=>pa,getCustomerById:()=>fa,getCustomerByPhone:()=>ma,updateCustomerDiscordId:()=>ha});function ma(s){return ue.find(t=>t.phone===s)}function pa(s){return ue.find(t=>t.email===s)}function fa(s){return ue.find(t=>t.id===s)}function ga(s){let t={...s,id:Math.max(...ue.map(e=>e.id))+1};return ue.push(t),t}function ha(s,t){let e=ue.find(r=>r.id===s);return e?(e.discordUserId=t,!0):!1}var ue,jt=F(()=>{"use strict";ue=[{id:1,name:"Jay Stevens",email:"joshuastevens100@gmail.com",phone:"+1 832 893-3794",preferences:{email:!0,sms:!0,discord:!0,inApp:!0},notes:"Primary contact - Business owner"}]});var Ze={};oe(Ze,{externalKanbanService:()=>ya});var Bt,ya,Je=F(()=>{"use strict";Bt=class{baseUrl;apiKey;constructor(){this.baseUrl=process.env.EXTERNAL_KANBAN_URL||"",this.apiKey=process.env.EXTERNAL_KANBAN_API_KEY||""}async fetchOrders(){if(!this.baseUrl||!this.apiKey)return{success:!1,orders:[],error:"External Kanban URL or API key not configured"};try{let t=await fetch(`${this.baseUrl}/api/orders`,{method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},timeout:1e4});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return{success:!0,orders:(await t.json()).orders?.map(o=>({id:o.orderId||o.id,orderNumber:o.orderId||o.orderNumber,customerName:o.customerName,artworkTitle:o.artworkTitle||o.description,frameSize:o.frameSize||`${o.width||0}x${o.height||0}`,status:this.mapExternalStatus(o.status),stage:o.stage||"pending",priority:o.priority||"standard",dueDate:o.dueDate,createdAt:o.createdAt,estimatedCompletion:o.estimatedCompletion,materials:o.materials||{frameType:o.frameType||"Unknown",matColor:o.matColor||"White",glass:o.glass||"Regular"}}))||[]}}catch(t){return console.error("Error fetching from external Kanban:",t),{success:!1,orders:[],error:t instanceof Error?t.message:"Unknown error"}}}async updateOrderStatus(t,e,r,o){if(!this.baseUrl||!this.apiKey)return console.error("External Kanban URL or API key not configured"),!1;try{return(await fetch(`${this.baseUrl}/api/orders/${t}/status`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({status:this.mapInternalToExternalStatus(e),stage:r,notes:o,updatedBy:"Jays Frames POS",timestamp:new Date().toISOString()}),timeout:1e4})).ok}catch(a){return console.error("Error updating external Kanban order:",a),!1}}mapExternalStatus(t){return{pending:"pending",in_progress:"in_production",in_production:"in_production",designing:"in_design",material_prep:"awaiting_materials",cutting:"in_production",assembly:"in_production",quality_check:"in_production",completed:"ready_for_pickup",ready:"ready_for_pickup",delivered:"completed",picked_up:"completed"}[t.toLowerCase()]||"pending"}mapInternalToExternalStatus(t){return{pending:"pending",in_design:"designing",awaiting_materials:"material_prep",in_production:"in_production",ready_for_pickup:"completed",completed:"delivered"}[t]||"pending"}async healthCheck(){if(!this.baseUrl||!this.apiKey)return{status:"not_configured",connected:!1};try{let t=await fetch(`${this.baseUrl}/api/health`,{method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},timeout:5e3});return{status:t.ok?"connected":"error",connected:t.ok,lastSync:new Date().toISOString()}}catch{return{status:"error",connected:!1}}}},ya=new Bt});import et from"express";import{Client as Io,GatewayIntentBits as at,SlashCommandBuilder as Pe,REST as Co,Routes as vo}from"discord.js";var nt=class{client;token;applicationId;constructor(){this.client=new Io({intents:[at.Guilds,at.GuildMessages,at.MessageContent]}),this.token=process.env.DISCORD_BOT_TOKEN||"",this.applicationId=process.env.DISCORD_APPLICATION_ID||"",this.setupEventHandlers(),this.setupCommands()}setupEventHandlers(){this.client.once("ready",()=>{console.log(`Discord bot logged in as ${this.client.user?.tag}!`)}),this.client.on("interactionCreate",async t=>{if(t.isChatInputCommand()){if(t.commandName==="order-status"){let e=t.options.getString("order-id");await t.reply(`Checking status for order: ${e}`)}if(t.commandName==="frame-quote"){let e=t.options.getString("dimensions");await t.reply(`Getting quote for frame dimensions: ${e}`)}if(t.commandName==="production-status"&&await t.reply("Checking production queue status..."),t.commandName==="help"&&await t.reply("\n**Available Commands:**\n\u2022 `/order-status <order-id>` - Check order status\n\u2022 `/frame-quote <dimensions>` - Get frame quote\n\u2022 `/production-status` - View production queue\n\u2022 `/inventory-status [item]` - Check inventory levels\n\u2022 `/help` - Show this help message\n        "),t.commandName==="inventory-status"){let e=t.options.getString("item");e?await t.reply(`Checking inventory for: ${e}`):await t.reply("Checking overall inventory status...")}}})}async setupCommands(){let t=[new Pe().setName("order-status").setDescription("Check the status of a framing order").addStringOption(r=>r.setName("order-id").setDescription("The order ID to check").setRequired(!0)),new Pe().setName("frame-quote").setDescription("Get a quick frame quote").addStringOption(r=>r.setName("dimensions").setDescription("Frame dimensions (e.g., 16x20)").setRequired(!0)),new Pe().setName("production-status").setDescription("Check production queue status"),new Pe().setName("help").setDescription("Show available commands and help"),new Pe().setName("inventory-status").setDescription("Check current inventory levels").addStringOption(r=>r.setName("item").setDescription("Specific item to check (optional)").setRequired(!1))].map(r=>r.toJSON()),e=new Co().setToken(this.token);try{console.log("Started refreshing Discord application (/) commands."),await e.put(vo.applicationCommands(this.applicationId),{body:t}),console.log("Successfully reloaded Discord application (/) commands.")}catch(r){console.error("Error registering Discord commands:",r)}}async start(){if(!this.token){console.error("Discord bot token not found. Please set DISCORD_BOT_TOKEN environment variable.");return}try{await this.client.login(this.token)}catch(t){console.error("Failed to start Discord bot:",t)}}async sendNotification(t,e){try{let r=await this.client.channels.fetch(t);r&&r.isTextBased()&&await r.send(e)}catch(r){console.error("Failed to send Discord notification:",r)}}async sendOrderUpdate(t,e,r){let o=`\u{1F514} **Order Update**
Order #${e} status changed to: **${r}**`;await this.sendNotification(t,o)}async sendProductionAlert(t,e){let r=`\u26A0\uFE0F **Production Alert**
${e}`;await this.sendNotification(t,r)}async sendDirectMessage(t,e){try{return await(await(await this.client.users.fetch(t)).createDM()).send(e),!0}catch(r){return console.error("Failed to send Discord DM:",r),!1}}async sendOrderStatusDM(t,e,r,o){let a=`\u{1F514} **Order Update - Jays Frames**

Your order #${e} status has been updated to: **${r}**${o?`

${o}`:""}

Thank you for choosing Jays Frames!`;return await this.sendDirectMessage(t,a)}async sendCompletionNoticeDM(t,e,r){let o=`\u2705 **Your Frame is Ready!**

Great news! Your order #${e} is complete and ready for pickup.${r?`

\u{1F4CD} **Pickup Details:**
${r}`:""}

We can't wait for you to see your beautiful custom frame!`;return await this.sendDirectMessage(t,o)}async sendEstimateUpdateDM(t,e,r){let o=`\u{1F4C5} **Timeline Update - Jays Frames**

Your order #${e} estimated completion has been updated to ${r} days.

We'll keep you posted on any changes!`;return await this.sendDirectMessage(t,o)}async sendCustomNotificationDM(t,e,r){let o=`**${e}**

${r}

- Jays Frames Team`;return await this.sendDirectMessage(t,o)}async stop(){this.client.destroy()}},zt=nt;te();import As from"ws";var ht=class{connectedClients=[];constructor(){}addClient(t,e){this.connectedClients.push({appId:t,socket:e}),console.log(`[Notifications] Client ${t} connected. Total clients: ${this.connectedClients.length}`)}removeClient(t){let e=this.connectedClients.findIndex(r=>r.socket===t);if(e!==-1){let{appId:r}=this.connectedClients[e];this.connectedClients.splice(e,1),console.log(`[Notifications] Client ${r} disconnected. Total clients: ${this.connectedClients.length}`)}}sendNotification(t,e){let r={type:"event",event:"new_notification",payload:t};return this.storeNotification(t),t.smsEnabled&&t.smsRecipient&&this.sendSmsNotification(t),this.connectedClients.forEach(o=>{(!e||e.includes(o.appId))&&o.socket.readyState===As.OPEN&&o.socket.send(JSON.stringify(r))}),t}async createNotification(t,e){try{let r=t.body;if(!r.title||!r.description||!r.source||!r.type)return e.status(400).json({error:"Missing required notification fields"});["info","success","warning","error"].includes(r.type)||(r.type="info");let a=this.sendNotification(r);return e.status(201).json({success:!0,notification:a})}catch(r){return console.error("[Notifications] Error creating notification:",r),e.status(500).json({error:"Failed to create notification"})}}async storeNotification(t){try{h.createNotification?await h.createNotification(t):console.log("[Notifications] No storage.createNotification method available")}catch(e){console.error("[Notifications] Error storing notification:",e)}}async sendSmsNotification(t){try{console.log(`[Notifications] SMS would be sent to ${t.smsRecipient}: ${t.title}`)}catch(e){console.error("[Notifications] Error sending SMS notification:",e)}}},Ge=new ht;V();import{sql as Ue}from"drizzle-orm";async function hr(s,t=50){try{return await u.execute(Ue`
      SELECT 
        n.*,
        o.id as order_id,
        o.frame_name,
        o.artwork_description
      FROM 
        customer_notifications n
      JOIN 
        orders o ON n.order_id = o.id
      WHERE 
        o.customer_id = ${s}
      ORDER BY 
        n.created_at DESC
      LIMIT ${t}
    `)}catch(e){throw console.error("Error fetching customer notifications:",e),e}}async function yr(s,t,e,r){try{return(await u.execute(Ue`
      INSERT INTO customer_notifications (
        customer_id, 
        order_id, 
        type, 
        message, 
        created_at
      ) VALUES (
        ${s}, 
        ${t}, 
        ${e}, 
        ${r}, 
        NOW()
      ) RETURNING *
    `))[0]}catch(o){throw console.error("Error creating customer notification:",o),o}}async function br(s){try{return await u.execute(Ue`
      UPDATE customer_notifications 
      SET read = true 
      WHERE id IN (${Ue.join(s)})
    `),!0}catch(t){throw console.error("Error marking notifications as read:",t),t}}var yt=class{discordBot;constructor(t){this.discordBot=t}async notifyCustomer(t,e){let r={discord:!1,email:!1,sms:!1,inApp:!1},o=t.preferences||{email:!0,inApp:!0};try{o.discord&&t.discordUserId&&(r.discord=await this.sendDiscordNotification(t.discordUserId,e)),o.email&&t.email&&(r.email=await this.sendEmailNotification(t,e)),o.sms&&t.phone&&(r.sms=await this.sendSmsNotification(t,e)),o.inApp&&(r.inApp=await this.sendInAppNotification(t,e)),e.orderId&&await yr(t.id,e.orderId,e.type,e.message)}catch(a){console.error("Error in unified notification service:",a)}return r}async sendDiscordNotification(t,e){try{switch(e.type){case"order_update":return await this.discordBot.sendOrderStatusDM(t,e.orderId?.toString()||"Unknown",e.title,e.message);case"completion_notice":return await this.discordBot.sendCompletionNoticeDM(t,e.orderId?.toString()||"Unknown",e.message);case"estimate_update":let r=this.extractDaysFromMessage(e.message);return await this.discordBot.sendEstimateUpdateDM(t,e.orderId?.toString()||"Unknown",r);default:return await this.discordBot.sendCustomNotificationDM(t,e.title,e.message)}}catch(r){return console.error("Discord notification failed:",r),!1}}async sendEmailNotification(t,e){try{return console.log(`[Email] Sending to ${t.email}: ${e.title}`),Ge.sendNotification({id:Date.now(),title:e.title,description:e.message,source:"customer-notification",sourceId:`customer-${t.id}`,type:e.urgency==="high"?"error":"info",actionable:e.type==="completion_notice",link:e.orderId?`/orders/${e.orderId}`:void 0,smsEnabled:!1,smsRecipient:t.phone}),!0}catch(r){return console.error("Email notification failed:",r),!1}}async sendSmsNotification(t,e){try{return console.log(`[SMS] Sending to ${t.phone}: ${e.title}`),Ge.sendNotification({id:Date.now(),title:e.title,description:e.message,source:"customer-sms",sourceId:`customer-${t.id}`,type:"info",actionable:!1,smsEnabled:!0,smsRecipient:t.phone}),!0}catch(r){return console.error("SMS notification failed:",r),!1}}async sendInAppNotification(t,e){try{return Ge.sendNotification({id:Date.now(),title:e.title,description:e.message,source:"customer-app",sourceId:`customer-${t.id}`,type:e.urgency==="high"?"error":"info",actionable:e.type==="completion_notice",link:e.orderId?`/orders/${e.orderId}`:void 0,smsEnabled:!1},[`customer-app-${t.id}`]),!0}catch(r){return console.error("In-app notification failed:",r),!1}}extractDaysFromMessage(t){let e=t.match(/(\d+)\s*days?/i);return e?parseInt(e[1]):7}async sendOrderStatusUpdate(t,e,r,o){await this.notifyCustomer(t,{title:`Order #${e} Status Update`,message:`Your order status has been updated to: ${r}${o?`. ${o}`:""}`,orderId:e,type:"order_update",urgency:"normal"})}async sendCompletionNotice(t,e,r){await this.notifyCustomer(t,{title:`Order #${e} Complete!`,message:`Your custom frame is ready for pickup!${r?` ${r}`:""}`,orderId:e,type:"completion_notice",urgency:"high"})}async sendEstimateUpdate(t,e,r){await this.notifyCustomer(t,{title:`Order #${e} Timeline Update`,message:`Your order is now estimated to complete in ${r} days.`,orderId:e,type:"estimate_update",urgency:"normal"})}},ke=yt;import{createServer as ba}from"http";import{WebSocketServer as wa,WebSocket as xa}from"ws";te();import{z as ae}from"zod";var Es=ae.object({orderId:ae.number(),location:ae.string(),artworkType:ae.string(),artworkDescription:ae.string(),artworkWidth:ae.number(),artworkHeight:ae.number()}),bt={async sendArtLocationData(s,t){try{let e=Es.parse(s.body),r=await h.updateOrderArtLocation(e.orderId,e.location);t.status(200).json({success:!0,message:"Art location data recorded successfully",data:r})}catch(e){console.error("Error recording art location data:",e),t.status(500).json({success:!1,message:"Failed to record art location data",error:e instanceof Error?e.message:"Unknown error"})}},async getArtLocationData(s,t){try{let e=Number(s.params.orderId);if(isNaN(e))return t.status(400).json({success:!1,message:"Invalid order ID"});let r=await h.getOrder(e);if(!r)return t.status(404).json({success:!1,message:"Order not found"});t.status(200).json({orderId:r.id,location:r.artworkLocation||"",artworkType:r.artworkType||"",artworkDescription:r.artworkDescription||"",artworkWidth:r.artworkWidth||0,artworkHeight:r.artworkHeight||0})}catch(e){console.error("Error fetching art location data:",e),t.status(500).json({success:!1,message:"Failed to fetch art location data",error:e instanceof Error?e.message:"Unknown error"})}}};V();ee();import{eq as wr}from"drizzle-orm";var wt={async saveFrameDesign(s,t){try{let{orderId:e,imageData:r}=s.body;if(!e||!r)return t.status(400).json({success:!1,message:"Order ID and image data are required"});await u.update(g).set({frameDesignImage:r}).where(wr(g.id,parseInt(e))),t.status(200).json({success:!0,message:"Frame design image saved successfully"})}catch(e){console.error("Error saving frame design:",e),t.status(500).json({success:!1,message:"Failed to save frame design image",error:e instanceof Error?e.message:"Unknown error"})}},async getFrameDesign(s,t){try{let e=s.params.orderId;if(!e)return t.status(400).json({success:!1,message:"Order ID is required"});let[r]=await u.select({frameDesignImage:g.frameDesignImage}).from(g).where(wr(g.id,parseInt(e)));if(!r||!r.frameDesignImage)return t.status(404).json({success:!1,message:"Frame design image not found"});t.status(200).json({success:!0,imageData:r.frameDesignImage})}catch(e){console.error("Error retrieving frame design:",e),t.status(500).json({success:!1,message:"Failed to retrieve frame design image",error:e instanceof Error?e.message:"Unknown error"})}}};V();ee();var xr={async getSystemHealth(s,t){try{let e={timestamp:new Date().toISOString(),overall:"healthy",checks:[]};try{let d=Date.now();await u.select().from(x).limit(1);let c=Date.now()-d;e.checks.push({name:"database",status:"healthy",message:"Database connection successful",responseTime:c})}catch(d){e.checks.push({name:"database",status:"error",message:"Database connection failed",error:d instanceof Error?d.message:"Unknown error"}),e.overall="error"}let r=process.memoryUsage(),o=Math.round(r.heapUsed/1024/1024);e.checks.push({name:"memory",status:o<500?"healthy":o<800?"warning":"error",message:`Memory usage: ${o}MB`,value:o});let a=process.uptime(),n=Math.floor(a/60);e.checks.push({name:"uptime",status:"healthy",message:`Server uptime: ${n} minutes`,value:a}),e.checks.push({name:"response_time",status:"healthy",message:"Health check response time normal",responseTime:5}),e.checks.some(d=>d.status==="error")?e.overall="error":e.checks.some(d=>d.status==="warning")&&(e.overall="warning"),t.status(200).json(e)}catch(e){t.status(500).json({timestamp:new Date().toISOString(),overall:"error",message:"Health check failed",error:e instanceof Error?e.message:"Unknown error"})}}};import Rs from"crypto";var He="jf_"+Rs.randomBytes(32).toString("hex"),xt={[He]:{name:"Production Kanban Integration",permissions:["kanban:read","kanban:write","orders:read","orders:update"],created:new Date().toISOString(),lastUsed:null}};function St(s,t,e){let r=s.headers.authorization;if(!r)return t.status(401).json({error:"Missing Authorization header",message:"API key required in Authorization header as: Bearer YOUR_API_KEY"});let o=r.replace("Bearer ","");if(!xt[o])return t.status(401).json({error:"Invalid API key",message:"The provided API key is not valid or has been revoked"});xt[o].lastUsed=new Date().toISOString(),s.apiKey=xt[o],e()}te();import{Router as js}from"express";import jn from"express-rate-limit";import qn from"helmet";import Tn from"csurf";import Wn from"cookie-parser";function q(s,t,e){console.log("verifyApiKey called for:",s.path),e()}var ne=js();ne.get("/orders",q,async(s,t)=>{try{let r=(await h.getAllOrders()).map(o=>({id:o.id,customerName:o.customerName,customerPhone:o.customerPhone,customerEmail:o.customerEmail,artworkTitle:o.artworkTitle,artworkWidth:o.artworkWidth,artworkHeight:o.artworkHeight,frameId:o.frameId,matId:o.matId,glassType:o.glassType,productionStatus:o.productionStatus,totalPrice:o.totalPrice,createdAt:o.createdAt,scheduledDate:o.scheduledDate,qrCode:o.qrCode,notes:o.notes}));t.json({success:!0,orders:r,count:r.length})}catch(e){console.error("Error fetching orders for hub:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch orders"})}});ne.get("/orders/:id",q,async(s,t)=>{try{let e=parseInt(s.params.id),r=await h.getOrder(e);if(!r)return t.status(404).json({success:!1,error:"Order not found"});t.json({success:!0,order:{id:r.id,customerName:r.customerName,customerPhone:r.customerPhone,customerEmail:r.customerEmail,artworkTitle:r.artworkTitle,artworkWidth:r.artworkWidth,artworkHeight:r.artworkHeight,frameId:r.frameId,matId:r.matId,glassType:r.glassType,productionStatus:r.productionStatus,totalPrice:r.totalPrice,createdAt:r.createdAt,scheduledDate:r.scheduledDate,qrCode:r.qrCode,notes:r.notes}})}catch(e){console.error("Error fetching order for hub:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch order"})}});ne.patch("/orders/:id/status",q,async(s,t)=>{try{let e=parseInt(s.params.id),{status:r,notes:o}=s.body,a=await h.updateOrder(e,{productionStatus:r,notes:o||void 0});if(!a)return t.status(404).json({success:!1,error:"Order not found"});t.json({success:!0,message:"Order status updated successfully",order:a})}catch(e){console.error("Error updating order status from hub:",e),t.status(500).json({success:!1,error:e.message||"Failed to update order status"})}});ne.get("/materials",q,async(s,t)=>{try{let e=await h.getAllMaterialOrders();t.json({success:!0,materialOrders:e,count:e.length})}catch(e){console.error("Error fetching material orders for hub:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch material orders"})}});ne.post("/webhook",q,async(s,t)=>{try{let{event:e,data:r}=s.body;switch(console.log("Received hub webhook:",e,r),e){case"order.status_changed":r.orderId&&r.status&&await h.updateOrder(r.orderId,{productionStatus:r.status,notes:r.notes||void 0});break;case"material.status_changed":r.materialOrderId&&r.status&&await h.updateMaterialOrder(r.materialOrderId,{status:r.status,notes:r.notes||void 0});break;default:console.log("Unknown webhook event:",e)}t.json({success:!0,message:"Webhook processed successfully"})}catch(e){console.error("Error processing hub webhook:",e),t.status(500).json({success:!1,error:e.message||"Failed to process webhook"})}});ne.get("/status",q,async(s,t)=>{try{let e=await h.getAllOrders(),r=await h.getAllMaterialOrders();t.json({success:!0,status:"online",timestamp:new Date().toISOString(),stats:{totalOrders:e.length,totalMaterialOrders:r.length,activeOrders:e.filter(o=>o.productionStatus!=="completed").length}})}catch(e){console.error("Error getting system status for hub:",e),t.status(500).json({success:!1,error:e.message||"Failed to get system status"})}});var Sr=ne;import{Router as qs}from"express";async function Pr(s,t){try{t.setHeader("Content-Type","application/json");let e=Date.now(),r=Math.random().toString(36).substring(2,15),o=`hub_${e}_${r}`;console.log("Hub API Key generated:",o);let a={success:!0,apiKey:o,createdAt:new Date().toISOString(),permissions:["hub:read","hub:write","orders:sync"],message:"Hub API key generated successfully"};return t.status(200).json(a)}catch(e){return console.error("Error generating Hub API key:",e),t.setHeader("Content-Type","application/json"),t.status(500).json({success:!1,error:e.message||"Failed to generate API key"})}}async function Ir(s,t){try{let e=process.env.REPL_URL||"https://your-repl-url.replit.dev";t.json({success:!0,connectionInfo:{baseUrl:e,endpoints:{getAllOrders:`${e}/api/hub/orders`,getOrder:`${e}/api/hub/orders/:id`,updateOrderStatus:`${e}/api/hub/orders/:id/status`,getMaterialOrders:`${e}/api/hub/materials`,webhook:`${e}/api/hub/webhook`,status:`${e}/api/hub/status`},authentication:{method:"Bearer Token",header:"Authorization",note:"Use the API key generated from /api/admin/generate-hub-key"},webhookEvents:["order.status_changed","material.status_changed"]}})}catch(e){console.error("Error getting hub connection info:",e),t.status(500).json({success:!1,error:e.message||"Failed to get connection info"})}}var Pt=qs();Pt.post("/generate-hub-key",Pr);Pt.get("/hub-connection-info",Ir);var It=Pt;te();var Cr=async(s,t)=>{try{let e=await h.getMaterialsPickList();(!e||e.length===0)&&(e=[{id:"mat-001",name:"White Core Mat 16x20",type:"mat",supplier:"Crescent",status:"pending",quantity:"5",priority:"medium",notes:"For order #1234",price:"12.50",orderDate:null,receiveDate:null,supplierName:"Crescent"},{id:"frame-001",name:'Oak Frame 1.5" - 8ft',type:"frame",supplier:"Larson-Juhl",status:"ordered",quantity:"2",priority:"high",notes:"Rush order",price:"45.00",orderDate:new Date().toISOString(),receiveDate:null,supplierName:"Larson-Juhl"},{id:"glass-001",name:"Museum Glass 16x20",type:"glass",supplier:"Tru Vue",status:"received",quantity:"3",priority:"low",notes:"In stock",price:"28.99",orderDate:new Date(Date.now()-864e5).toISOString(),receiveDate:new Date().toISOString(),supplierName:"Tru Vue"}]),t.json({success:!0,data:e,message:"Materials loaded successfully"})}catch(e){console.error("Error in getMaterialsPickList:",e),t.status(500).json({message:e.message,materials:[]})}},vr=async(s,t)=>{try{let r=(await h.getMaterialsPickList()||[]).reduce((o,a)=>{let n=a.supplier||"Unknown Supplier";return o[n]||(o[n]=[]),o[n].push(a),o},{});t.json(r)}catch(e){console.error("Error in getMaterialsBySupplier:",e),t.status(500).json({message:e.message,suppliers:{}})}},Or=async(s,t)=>{try{let e=parseInt(s.params.orderId);if(isNaN(e))return t.status(400).json({message:"Invalid order ID",materials:[]});let r=await h.getMaterialsForOrder(e);t.json(r||[])}catch(e){console.error("Error in getMaterialsForOrder:",e),t.status(500).json({message:e.message,materials:[]})}},Nr=async(s,t)=>{try{let e=s.params.id,r;if(s.body.data)r=s.body.data;else{let{status:n,notes:d,orderDate:c,receiveDate:l,supplierName:b}=s.body;r={status:n,notes:d,orderDate:c,receiveDate:l,supplierName:b}}let o=Object.fromEntries(Object.entries(r).filter(([n,d])=>d!==void 0));console.log("Updating material order with data:",o);let a=await h.updateMaterialOrder(e,o);t.json(a)}catch(e){console.error("Error updating material:",e),t.status(500).json({message:e.message})}},Mr=async(s,t)=>{try{let{materialIds:e}=s.body;if(!e||!Array.isArray(e)||e.length===0)return t.status(400).json({message:"No materials selected"});let r=await h.createPurchaseOrder(e);t.status(201).json(r)}catch(e){t.status(500).json({message:e.message})}},_r=async(s,t)=>{try{let e=await h.getMaterialsPickList(),r=Array.from(new Set((e||[]).map(o=>o.type).filter(Boolean)));t.json(r.length>0?r:["frame","mat","glass","hardware"])}catch(e){console.error("Error in getMaterialTypes:",e),t.status(500).json({message:e.message,types:["frame","mat","glass","hardware"]})}},Fr=async(s,t)=>{try{let e=await h.getMaterialsPickList(),r=Array.from(new Set((e||[]).map(o=>o.supplier).filter(Boolean)));t.json(r.length>0?r:["Larson-Juhl","Roma","Bella"])}catch(e){console.error("Error in getMaterialSuppliers:",e),t.status(500).json({message:e.message,suppliers:["Larson-Juhl","Roma","Bella"]})}};fe();import{Router as zs}from"express";fe();var ie=zs();ie.get("/orders/:id",q,Ct);ie.get("/orders",q,vt);ie.patch("/orders/:id/status",q,Ot);ie.post("/webhook",q,Nt);ie.get("/test",Mt);ie.post("/configure-kanban",_t);var Er=ie;import{Router as Ys}from"express";te();import Qs from"axios";var Ks=process.env.KANBAN_API_URL||"https://kanban-app-url.replit.app",Rr=process.env.KANBAN_API_KEY;async function Vs(){try{if(!Rr)return console.log("No Kanban API key found, using local storage"),null;let s=await Qs.get(`${Ks}/api/orders`,{headers:{Authorization:`Bearer ${Rr}`,"Content-Type":"application/json"},timeout:5e3});return s.data&&s.data.success?s.data.orders:null}catch(s){return console.error("Failed to fetch orders from Kanban app:",s.message),null}}async function jr(s,t){try{let e=await Vs();if(e&&e.length>0){console.log(`Fetched ${e.length} orders from Kanban app`);let o=e.map(a=>({id:a.orderId||a.id,customerName:a.customerName,customerPhone:a.customerPhone||"",customerEmail:a.customerEmail||"",artworkTitle:a.artworkTitle,artworkWidth:a.frameSize?parseFloat(a.frameSize.split("x")[0]):a.artworkWidth,artworkHeight:a.frameSize?parseFloat(a.frameSize.split("x")[1]):a.artworkHeight,frameId:a.materials?.frameType||a.frameId,matId:a.materials?.matColor||a.matId,glassType:a.materials?.glass||a.glassType||"Museum Glass",productionStatus:a.status||"pending",stage:a.stage||"material_prep",totalPrice:a.totalPrice||0,createdAt:a.createdAt,scheduledDate:a.dueDate||a.scheduledDate,estimatedCompletion:a.estimatedCompletion,priority:a.priority||"standard",qrCode:a.qrCode||"",notes:a.notes||""}));t.json({success:!0,orders:o,source:"kanban",count:o.length});return}console.log("Falling back to local storage for orders");let r=await h.getAllOrders();t.json({success:!0,orders:r,source:"local",count:r.length})}catch(e){console.error("Error fetching orders:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch orders"})}}async function Br(s,t){try{let{id:e}=s.params,r=await h.getOrder(parseInt(e));if(!r)return t.status(404).json({success:!1,error:"Order not found"});t.json({success:!0,order:r})}catch(e){console.error("Error fetching order:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch order"})}}async function qr(s,t){try{let e=s.body;if(console.log("Creating order with data:",e),!e.customerId)return t.status(400).json({success:!1,error:"Customer ID is required"});if(!e.artworkImage)return t.status(400).json({success:!1,error:"Artwork image is required"});let r=await h.createOrder(e);t.status(201).json({success:!0,order:r,message:"Order created successfully"})}catch(e){console.error("Error creating order:",e),t.status(500).json({success:!1,error:e.message||"Failed to create order"})}}async function $r(s,t){try{let{id:e}=s.params,r=s.body,o=await h.updateOrder(parseInt(e),r);t.json({success:!0,order:o,message:"Order updated successfully"})}catch(e){console.error("Error updating order:",e),t.status(500).json({success:!1,error:e.message||"Failed to update order"})}}async function Tr(s,t){try{let{id:e}=s.params;await h.deleteOrder(parseInt(e)),t.json({success:!0,message:"Order deleted successfully"})}catch(e){console.error("Error deleting order:",e),t.status(500).json({success:!1,error:e.message||"Failed to delete order"})}}async function Lr(s,t){try{let e=await h.getAllOrderGroups();t.json({success:!0,orderGroups:e,count:e.length})}catch(e){console.error("Error fetching order groups:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch order groups"})}}async function Wr(s,t){try{let e=s.body,r=await h.createOrderGroup(e);t.status(201).json({success:!0,orderGroup:r,message:"Order group created successfully"})}catch(e){console.error("Error creating order group:",e),t.status(500).json({success:!1,error:e.message||"Failed to create order group"})}}var re=Ys();re.get("/orders",jr);re.get("/orders/:id",Br);re.post("/orders",qr);re.patch("/orders/:id",$r);re.delete("/orders/:id",Tr);re.get("/order-groups",Lr);re.post("/order-groups",Wr);var Gr=re;import{Router as Xs}from"express";V();ee();import{eq as Zs,desc as Js}from"drizzle-orm";async function Ur(s,t){try{let e=await u.select().from(x).orderBy(Js(x.createdAt));return t.status(200).json(e)}catch(e){return console.error("Error fetching customers:",e),t.status(500).json({message:"Error fetching customers"})}}async function Hr(s,t){try{let{id:e}=s.params,r=parseInt(e);if(isNaN(r))return t.status(400).json({message:"Invalid customer ID"});let o=await u.select().from(x).where(Zs(x.id,r)).limit(1);return o.length===0?t.status(404).json({message:"Customer not found"}):t.status(200).json(o[0])}catch(e){return console.error("Error fetching customer:",e),t.status(500).json({message:"Error fetching customer"})}}async function zr(s,t){try{let e=it.parse(s.body),[r]=await u.insert(x).values(e).returning();return t.status(201).json(r)}catch(e){return console.error("Error creating customer:",e),e.name==="ZodError"?t.status(400).json({message:"Invalid customer data",errors:e.errors}):t.status(500).json({message:"Error creating customer"})}}var Qe=Xs();Qe.get("/customers",Ur);Qe.get("/customers/:id",Hr);Qe.post("/customers",zr);var Qr=Qe;import{Router as sa}from"express";import{parseString as ea}from"xml2js";import{promisify as ta}from"util";var ra=ta(ea),Ft=class{async parseVendorXmlPriceSheet(t){try{console.log("Parsing vendor XML price sheet...");let e=await ra(t),r=[];if(e.catalog?.items?.item){let o=Array.isArray(e.catalog.items.item)?e.catalog.items.item:[e.catalog.items.item];for(let a of o){let n={itemNumber:this.extractValue(a.sku||a.itemNumber||a.id),description:this.extractValue(a.description||a.name),width:this.extractValue(a.width),collection:this.extractValue(a.collection||a.series),manufacturer:this.extractValue(a.manufacturer||a.vendor||"Unknown"),wholesalePrice:this.extractNumericValue(a.wholesalePrice||a.cost||a.price),retailPrice:this.extractNumericValue(a.retailPrice||a.msrp),category:this.extractValue(a.category||a.type),inStock:this.extractBooleanValue(a.inStock||a.available),unitOfMeasure:this.extractValue(a.unitOfMeasure||a.uom||"each")};n.itemNumber&&n.wholesalePrice>0&&r.push(n)}}else if(e.products?.product){let o=Array.isArray(e.products.product)?e.products.product:[e.products.product];for(let a of o){let n={itemNumber:this.extractValue(a.$.id||a.$.sku),description:this.extractValue(a.name?.[0]||a.description?.[0]),width:this.extractValue(a.dimensions?.width?.[0]),collection:this.extractValue(a.collection?.[0]),manufacturer:this.extractValue(a.manufacturer?.[0]||"Unknown"),wholesalePrice:this.extractNumericValue(a.pricing?.wholesale?.[0]||a.cost?.[0]),retailPrice:this.extractNumericValue(a.pricing?.retail?.[0]),category:this.extractValue(a.category?.[0]),inStock:this.extractBooleanValue(a.inventory?.inStock?.[0]),unitOfMeasure:this.extractValue(a.unitOfMeasure?.[0]||"each")};n.itemNumber&&n.wholesalePrice>0&&r.push(n)}}return console.log(`Successfully parsed ${r.length} items from XML price sheet`),r}catch(e){throw console.error("Error parsing XML price sheet:",e),new Error(`Failed to parse XML price sheet: ${e.message}`)}}extractValue(t){return typeof t=="string"?t.trim():Array.isArray(t)&&t.length>0?String(t[0]).trim():t&&typeof t=="object"&&t._?String(t._).trim():""}extractNumericValue(t){let e=this.extractValue(t),r=parseFloat(e.replace(/[^0-9.-]/g,""));return isNaN(r)?0:r}extractBooleanValue(t){let e=this.extractValue(t).toLowerCase();return e==="true"||e==="yes"||e==="1"}convertToFrameFormat(t){return t.map(e=>({id:`vendor-${e.manufacturer.toLowerCase().replace(/\s+/g,"-")}-${e.itemNumber}`,name:`${e.collection?e.collection+" ":""}${e.description}`,manufacturer:e.manufacturer,material:this.inferMaterial(e.description,e.category),width:e.width||"",depth:"",price:e.wholesalePrice.toString(),catalogImage:"",color:this.inferColor(e.description),itemNumber:e.itemNumber,collection:e.collection||"",category:e.category||"",inStock:e.inStock!==!1,unitOfMeasure:e.unitOfMeasure}))}inferMaterial(t,e){let r=t.toLowerCase(),o=e?.toLowerCase()||"";return r.includes("wood")||o.includes("wood")?"wood":r.includes("metal")||o.includes("metal")?"metal":r.includes("plastic")||o.includes("plastic")?"plastic":r.includes("composite")||o.includes("composite")?"composite":"wood"}inferColor(t){let e=t.toLowerCase();return e.includes("black")?"#000000":e.includes("white")?"#FFFFFF":e.includes("brown")?"#8B4513":e.includes("gold")?"#FFD700":e.includes("silver")?"#C0C0C0":e.includes("red")?"#FF0000":e.includes("blue")?"#0000FF":"#8B4513"}},kt=new Ft;V();ee();async function Kr(s,t){try{let{xmlContent:e,vendorName:r}=s.body;if(!e)return t.status(400).json({message:"XML content is required"});if(!r)return t.status(400).json({message:"Vendor name is required"});console.log(`Processing XML price sheet for vendor: ${r}`);let o=await kt.parseVendorXmlPriceSheet(e);if(o.length===0)return t.status(400).json({message:"No valid price items found in XML"});let a=kt.convertToFrameFormat(o),n=0,d=0;for(let c of a)try{(await u.select().from(N).where(eq(N.id,c.id)).limit(1)).length>0?(await u.update(N).set({name:c.name,manufacturer:c.manufacturer,material:c.material,width:c.width,price:c.price,color:c.color,updatedAt:new Date}).where(eq(N.id,c.id)),d++):(await u.insert(N).values({id:c.id,name:c.name,manufacturer:c.manufacturer,material:c.material,width:c.width,depth:c.depth,price:c.price,catalogImage:c.catalogImage,color:c.color,createdAt:new Date,updatedAt:new Date}),n++)}catch(l){console.error(`Error processing frame item ${c.id}:`,l)}console.log(`XML price sheet processing complete. Inserted: ${n}, Updated: ${d}`),t.json({message:"XML price sheet processed successfully",vendor:r,totalItems:o.length,inserted:n,updated:d,summary:{priceItems:o.slice(0,5),frameItems:a.slice(0,5)}})}catch(e){console.error("Error processing XML price sheet:",e),t.status(500).json({message:"Failed to process XML price sheet",error:e.message})}}async function Vr(s,t){t.json({supportedFormats:[{name:"Standard Catalog Format",structure:{catalog:{items:{item:[{sku:"item-number",description:"item-description",manufacturer:"vendor-name",wholesalePrice:"price",width:"frame-width",collection:"collection-name"}]}}}},{name:"Products Format",structure:{products:{product:[{$:{id:"item-number"},name:["item-description"],manufacturer:["vendor-name"],pricing:{wholesale:["price"]}}]}}}],requiredFields:["itemNumber","description","manufacturer","wholesalePrice"],optionalFields:["width","collection","retailPrice","category","inStock"]})}function oa(s,t,e){console.log("Auth middleware: Allowing request (authentication not implemented)"),e()}var Yr=oa;var Ke=sa();Ke.use(Yr);Ke.post("/upload",Kr);Ke.get("/formats",Vr);var Zr=Ke;import{Router as ca}from"express";var aa=[{itemNumber:"10-036M",width:'5/8"',boxQty:360,collection:"Maple & Walnut - Garrett",basePricePerFoot:6.62,boxPrice:10.05,lengthPrice:13.52,chopPrice:14.52},{itemNumber:"10-100M",width:'5/8"',boxQty:375,collection:"Maple & Walnut - Garrett",basePricePerFoot:6.34,boxPrice:9.71,lengthPrice:12.75,chopPrice:13.75},{itemNumber:"10-507M",width:'5/8"',boxQty:306,collection:"Museum Stems - Garrett",basePricePerFoot:6.52,boxPrice:9.91,lengthPrice:13,chopPrice:14},{itemNumber:"100172",width:'1/4"',boxQty:1600,collection:"Olmsted",basePricePerFoot:2.75,boxPrice:4.64,lengthPrice:7.28,chopPrice:8.28},{itemNumber:"100750",width:'1/4"',boxQty:1200,collection:"Sofia",basePricePerFoot:2.63,boxPrice:4.04,lengthPrice:6.73,chopPrice:7.73},{itemNumber:"100751",width:'1/4"',boxQty:1587,collection:"Sofia",basePricePerFoot:2.63,boxPrice:4.04,lengthPrice:6.73,chopPrice:7.73},{itemNumber:"100752",width:'1/4"',boxQty:1e3,collection:"Sofia",basePricePerFoot:2.63,boxPrice:4.04,lengthPrice:6.73,chopPrice:7.73},{itemNumber:"102CG",width:'1/2"',boxQty:432,collection:"Marquis",basePricePerFoot:1.74,boxPrice:3.7,lengthPrice:6.43,chopPrice:7.43},{itemNumber:"102CS",width:'1/2"',boxQty:432,collection:"Marquis",basePricePerFoot:1.74,boxPrice:3.7,lengthPrice:6.43,chopPrice:7.43},{itemNumber:"103180",width:'9/16"',boxQty:900,collection:"Hudson",basePricePerFoot:1.46,boxPrice:3.11,lengthPrice:5.56,chopPrice:6.56},{itemNumber:"103190",width:'9/16"',boxQty:900,collection:"Hudson",basePricePerFoot:1.4,boxPrice:2.97,lengthPrice:5.3,chopPrice:6.3},{itemNumber:"103235",width:'5/16"',boxQty:1200,collection:"Academie",basePricePerFoot:1.44,boxPrice:3.17,lengthPrice:5.64,chopPrice:6.64},{itemNumber:"103237",width:'5/16"',boxQty:1296,collection:"Academie",basePricePerFoot:1.43,boxPrice:3.14,lengthPrice:5.59,chopPrice:6.59},{itemNumber:"105794",width:'5/16"',boxQty:785,collection:"Lucerne",basePricePerFoot:3.21,boxPrice:5.02,lengthPrice:8.01,chopPrice:9.01},{itemNumber:"105CB",width:'1/2"',boxQty:270,collection:"Vienna",basePricePerFoot:2.21,boxPrice:3.31,lengthPrice:5.71,chopPrice:6.71},{itemNumber:"106180",width:'1/2"',boxQty:900,collection:"Hudson",basePricePerFoot:1.39,boxPrice:2.99,lengthPrice:5.31,chopPrice:6.31},{itemNumber:"106190",width:'1/2"',boxQty:900,collection:"Hudson",basePricePerFoot:1.32,boxPrice:2.83,lengthPrice:5.09,chopPrice:6.09},{itemNumber:"200750",width:'7/8"',boxQty:250,collection:"Sofia",basePricePerFoot:4.38,boxPrice:6.54,lengthPrice:9.9,chopPrice:10.9},{itemNumber:"200751",width:'7/8"',boxQty:515,collection:"Sofia",basePricePerFoot:4.35,boxPrice:6.76,lengthPrice:9.84,chopPrice:10.84},{itemNumber:"200752",width:'7/8"',boxQty:490,collection:"Sofia",basePricePerFoot:4.57,boxPrice:7.31,lengthPrice:10.33,chopPrice:11.33},{itemNumber:"210286",width:'11/16"',boxQty:450,collection:"White",basePricePerFoot:1.89,boxPrice:3.06,lengthPrice:5.99,chopPrice:6.99},{itemNumber:"400750",width:'1 5/8"',boxQty:112,collection:"Sofia",basePricePerFoot:7.47,boxPrice:11.04,lengthPrice:17.48,chopPrice:18.48},{itemNumber:"400751",width:'1 5/8"',boxQty:192,collection:"Sofia",basePricePerFoot:7.09,boxPrice:10.44,lengthPrice:16.55,chopPrice:17.55},{itemNumber:"400752",width:'1 5/8"',boxQty:180,collection:"Sofia",basePricePerFoot:7.34,boxPrice:10.83,lengthPrice:17.17,chopPrice:18.17},{itemNumber:"431431",width:'1 3/8"',boxQty:115,collection:"Zen",basePricePerFoot:10.83,boxPrice:15.91,lengthPrice:26.01,chopPrice:27.01},{itemNumber:"431432",width:'1 3/8"',boxQty:113,collection:"Zen",basePricePerFoot:10.27,boxPrice:15.1,lengthPrice:24.68,chopPrice:25.68},{itemNumber:"431434",width:'1 3/8"',boxQty:110,collection:"Zen",basePricePerFoot:10.75,boxPrice:15.81,lengthPrice:25.82,chopPrice:26.82},{itemNumber:"432900",width:'1 3/4"',boxQty:225,collection:"Foundry",basePricePerFoot:6.62,boxPrice:9.75,lengthPrice:15.03,chopPrice:16.03},{itemNumber:"432902",width:'1 3/4"',boxQty:236,collection:"Foundry",basePricePerFoot:6.81,boxPrice:10.07,lengthPrice:15.52,chopPrice:16.52},{itemNumber:"433082",width:'1 11/16"',boxQty:108,collection:"Soho",basePricePerFoot:5.09,boxPrice:9.55,lengthPrice:14.41,chopPrice:15.41},{itemNumber:"433084",width:'1 11/16"',boxQty:108,collection:"Soho",basePricePerFoot:5.16,boxPrice:9.59,lengthPrice:14.54,chopPrice:15.54},{itemNumber:"433086",width:'1 11/16"',boxQty:108,collection:"Soho",basePricePerFoot:5.22,boxPrice:9.59,lengthPrice:14.54,chopPrice:15.54},{itemNumber:"434110",width:'1 1/4"',boxQty:137,collection:"CR2",basePricePerFoot:6.33,boxPrice:9.33,lengthPrice:14.98,chopPrice:15.98},{itemNumber:"435500",width:'1 5/16"',boxQty:324,collection:"Alto",basePricePerFoot:1.8,boxPrice:3.6,lengthPrice:6.72,chopPrice:7.72},{itemNumber:"435510",width:'1 5/16"',boxQty:296,collection:"Alto",basePricePerFoot:1.8,boxPrice:3.6,lengthPrice:6.72,chopPrice:7.72},{itemNumber:"436350",width:'1 5/8"',boxQty:143,collection:"Brooklyn",basePricePerFoot:2.29,boxPrice:3.66,lengthPrice:6.08,chopPrice:7.08},{itemNumber:"437500",width:'1 3/16"',boxQty:215,collection:"Alto",basePricePerFoot:2.03,boxPrice:3.6,lengthPrice:7.22,chopPrice:8.22},{itemNumber:"437510",width:'1 3/16"',boxQty:180,collection:"Alto",basePricePerFoot:2.03,boxPrice:3.6,lengthPrice:7.22,chopPrice:8.22},{itemNumber:"438120",width:'2"',boxQty:150,collection:"Dresden",basePricePerFoot:6.78,boxPrice:10.26,lengthPrice:15.05,chopPrice:16.05},{itemNumber:"439082",width:'2 1/16"',boxQty:126,collection:"Soho",basePricePerFoot:4.42,boxPrice:7.58,lengthPrice:11.4,chopPrice:12.4},{itemNumber:"440240",width:'1 3/8"',boxQty:190,collection:"Java",basePricePerFoot:7.59,boxPrice:11.23,lengthPrice:18.27,chopPrice:19.27},{itemNumber:"440951",width:'2"',boxQty:92,collection:"Cezanne",basePricePerFoot:18.08,boxPrice:25.65,lengthPrice:29.81,chopPrice:30.81},{itemNumber:"441075",width:'2 1/16"',boxQty:150,collection:"Prague",basePricePerFoot:9.48,boxPrice:13.9,lengthPrice:23.98,chopPrice:24.98},{itemNumber:"441077",width:'2 1/16"',boxQty:155,collection:"Prague",basePricePerFoot:9.44,boxPrice:13.82,lengthPrice:23.86,chopPrice:24.86},{itemNumber:"442650",width:'1 3/4"',boxQty:162,collection:"Tate",basePricePerFoot:4.76,boxPrice:8.08,lengthPrice:11.57,chopPrice:12.57},{itemNumber:"442660",width:'1 3/4"',boxQty:162,collection:"Tate",basePricePerFoot:4.76,boxPrice:8.07,lengthPrice:11.56,chopPrice:12.56},{itemNumber:"442670",width:'1 3/4"',boxQty:162,collection:"Tate",basePricePerFoot:4.67,boxPrice:7.74,lengthPrice:11.04,chopPrice:12.04},{itemNumber:"520750",width:'2 1/2"',boxQty:94,collection:"Sofia",basePricePerFoot:11.07,boxPrice:16.3,lengthPrice:24.59,chopPrice:25.59},{itemNumber:"520751",width:'2 1/2"',boxQty:59,collection:"Sofia",basePricePerFoot:10.92,boxPrice:16.43,lengthPrice:24.78,chopPrice:25.78},{itemNumber:"520752",width:'2 1/2"',boxQty:100,collection:"Sofia",basePricePerFoot:10.56,boxPrice:16.38,lengthPrice:23.41,chopPrice:24.41}];function Jr(s){let t=s.startsWith("larson-")?s.substring(7):s;return aa.find(e=>e.itemNumber===t)||null}var ce=9.5;function Ve(s,t){let e=Jr(s);if(!e)return null;let r=e.basePricePerFoot,o=e.chopPrice||e.basePricePerFoot*1.5,a=Math.ceil(t/ce),n=a*ce,d=n-t,c=n*r,l=t*o,b;if(t>ce){let _=Math.floor(t/ce),I=t-_*ce;if(I>0){let he=_*ce*r+I*o;b={fullSticks:_,chopFootage:I,totalCost:he,description:`${_} full stick(s) + ${I.toFixed(1)}' chopped`}}}let w=[{method:"length",cost:c},{method:"chop",cost:l},...b?[{method:"mixed",cost:b.totalCost}]:[]],j=w.reduce((_,I)=>I.cost<_.cost?I:_),v=w.reduce((_,I)=>I.cost>_.cost?I:_).cost-j.cost,$="",T;return j.method==="length"?$=`Full sticks are cheaper despite ${d.toFixed(1)}' waste`:j.method==="chop"?$="Chop pricing saves money by avoiding waste":$="Mixed approach optimizes cost by combining full sticks and chopped pieces",t>=0&&t<=4?T="\u{1F3AF} OPTIMAL RANGE: 0-4 feet - Consider chop pricing to avoid waste":t>=10&&t<=14?T="\u{1F3AF} OPTIMAL RANGE: 10-14 feet - Mixed ordering may be most cost-effective":t>4&&t<9.5&&(T="\u{1F4CF} Consider: Close to full stick length, evaluate waste vs chop premium"),{itemNumber:s,footageNeeded:t,lengthOption:{sticksNeeded:a,totalFootage:n,wasteFootage:d,costPerFoot:r,totalCost:c,description:`${a} stick(s) @ ${ce}' each`},chopOption:{footageNeeded:t,costPerFoot:o,totalCost:l,description:`${t}' chopped to exact length`},mixedOption:b,recommendation:{method:j.method,savings:v,reason:$,alert:T}}}function na(s,t,e){let r=s+e*2,o=t+e*2;return r*2+o*2}function ia(s,t,e,r){let a=na(t,e,r)/12;return Ve(s,a)}function Xr(s){return s.map(t=>({...ia(t.itemNumber,t.artworkWidth,t.artworkHeight,t.matWidth),quantity:t.quantity||1})).filter(Boolean)}function eo(s){let t=s.reduce((o,a)=>o+a.recommendation.savings*a.quantity,0),e=s.reduce((o,a)=>o+a.quantity,0),r=s.filter(o=>o.recommendation.alert).length;return{totalSavings:t,totalOrders:e,averageSavingsPerOrder:t/e,alertCount:r}}async function to(s,t){try{let{itemNumber:e,footageNeeded:r}=s.body;if(!e||!r)return t.status(400).json({error:"Missing required parameters: itemNumber and footageNeeded"});let o=Ve(e,parseFloat(r));if(!o)return t.status(404).json({error:"Item number not found in Larson-Juhl catalog"});t.json(o)}catch(e){console.error("Error optimizing Larson order:",e),t.status(500).json({error:"Internal server error"})}}async function Ye(s,t){try{let{itemNumber:e,artworkWidth:r,artworkHeight:o,matWidth:a}=s.body;if(!e||!r||!o||a===void 0)return t.status(400).json({error:"Missing required parameters: itemNumber, artworkWidth, artworkHeight, matWidth"});let n=Ye(e,parseFloat(r),parseFloat(o),parseFloat(a));if(!n)return t.status(404).json({error:"Item number not found in Larson-Juhl catalog"});t.json(n)}catch(e){console.error("Error optimizing frame order:",e),t.status(500).json({error:"Internal server error"})}}async function ro(s,t){try{let{orders:e}=s.body;if(!e||!Array.isArray(e))return t.status(400).json({error:"Missing or invalid orders array"});let r=Xr(e),o=eo(r);t.json({optimizations:r,summary:o})}catch(e){console.error("Error batch optimizing orders:",e),t.status(500).json({error:"Internal server error"})}}async function oo(s,t){try{let{itemNumber:e}=s.params,o=[2,4,6,8,10,12,14,16,18,20].map(a=>{let n=Ve(e,a);return{footage:a,optimization:n}}).filter(a=>a.optimization!==null);if(o.length===0)return t.status(404).json({error:"Item number not found in Larson-Juhl catalog"});t.json({itemNumber:e,analysis:o})}catch(e){console.error("Error generating optimization analysis:",e),t.status(500).json({error:"Internal server error"})}}var Ee=ca();Ee.post("/optimize/footage",to);Ee.post("/optimize/frame",Ye);Ee.post("/optimize/batch",ro);Ee.get("/analyze/:itemNumber",oo);var so=Ee;import ua from"express";var At=ua.Router();At.post("/test-discord-notification",async(s,t)=>{try{let{discordUserId:e,orderId:r,type:o,message:a}=s.body;if(!e)return t.status(400).json({error:"Discord user ID is required"});let n=s.app.locals.notificationService,d={id:1,email:"customer@example.com",discordUserId:e,preferences:{discord:!0,email:!0,inApp:!0,sms:!1}},c;switch(o){case"order_update":c=await n.sendOrderStatusUpdate(d,r||123,"In Production",a||"Your custom frame is now being crafted by our artisans.");break;case"completion":c=await n.sendCompletionNotice(d,r||123,a||"Ready for pickup at our studio during business hours.");break;case"estimate":c=await n.sendEstimateUpdate(d,r||123,7);break;default:c=await n.notifyCustomer(d,{title:"Test Notification",message:a||"This is a test notification from Jays Frames.",type:"custom",urgency:"normal"})}t.json({success:!0,message:"Discord notification sent successfully",details:c})}catch(e){console.error("Error sending Discord notification:",e),t.status(500).json({error:"Failed to send Discord notification",details:e instanceof Error?e.message:"Unknown error"})}});At.get("/bot-info",(s,t)=>{t.json({botName:"Jays Frames Ecosystem#5403",availableCommands:["/order-status - Check order status","/frame-quote - Get frame quotes","/production-status - Check production queue","/inventory-status - Check inventory levels","/help - Show available commands"],features:["Direct message notifications","Order status updates","Completion notices","Estimate updates","Production alerts"]})});var ao=At;import da from"express";var Dt=da.Router();Dt.get("/customers/:customerId/notifications",async(s,t)=>{try{let e=parseInt(s.params.customerId),r=s.query.limit?parseInt(s.query.limit):50;if(isNaN(e))return t.status(400).json({message:"Invalid customer ID"});let o=await hr(e,r);t.status(200).json(o)}catch(e){console.error("Error getting customer notifications:",e),t.status(500).json({message:"Error retrieving customer notifications"})}});Dt.post("/notifications/mark-read",async(s,t)=>{try{let{notificationIds:e}=s.body;if(!Array.isArray(e)||e.length===0)return t.status(400).json({message:"Invalid notification IDs"});await br(e),t.status(200).json({message:"Notifications marked as read"})}catch(e){console.error("Error marking notifications as read:",e),t.status(500).json({message:"Error marking notifications as read"})}});var no=Dt;import la from"express";var Et=la.Router();Et.post("/test-customer-notification",async(s,t)=>{try{let{customerId:e=1,orderId:r=123,type:o="order_update",discordUserId:a,email:n="test@example.com",phone:d,message:c}=s.body,l=s.app.locals.discordBot;if(!l)return t.status(500).json({error:"Discord bot not initialized"});let b=new ke(l),w={id:e,email:n,phone:d,discordUserId:a,preferences:{discord:!!a,email:!0,inApp:!0,sms:!!d}},j;switch(o){case"order_update":j=await b.sendOrderStatusUpdate(w,r,"In Production",c||"Your custom frame is now being crafted by our artisans.");break;case"completion":j=await b.sendCompletionNotice(w,r,c||"Ready for pickup at our studio during business hours.");break;case"estimate":j=await b.sendEstimateUpdate(w,r,7);break;default:j=await b.notifyCustomer(w,{title:"Test Notification",message:c||"This is a test notification from Jay's Frames.",orderId:r,type:"custom",urgency:"normal"})}t.json({success:!0,message:"Customer notification test completed",results:j,testCustomer:{id:w.id,email:w.email,phone:w.phone,discordUserId:w.discordUserId,preferences:w.preferences}})}catch(e){console.error("Error testing customer notification:",e),t.status(500).json({error:"Failed to test customer notification",details:e instanceof Error?e.message:"Unknown error"})}});Et.post("/test-all-channels",async(s,t)=>{try{let{discordUserId:e,email:r,phone:o}=s.body,a=s.app.locals.discordBot;if(!a)return t.status(500).json({error:"Discord bot not initialized"});let n=new ke(a),d={id:999,email:r||"test@jaysframes.com",phone:o,discordUserId:e,preferences:{discord:!!e,email:!0,inApp:!0,sms:!!o}},c=[{type:"order_update",test:()=>n.sendOrderStatusUpdate(d,456,"Measuring","We are carefully measuring your artwork.")},{type:"completion",test:()=>n.sendCompletionNotice(d,456,"Your frame is ready! Please bring your pickup receipt.")},{type:"estimate",test:()=>n.sendEstimateUpdate(d,456,5)}],l=[];for(let b of c)try{let w=await b.test();l.push({type:b.type,success:!0,result:w})}catch(w){l.push({type:b.type,success:!1,error:w instanceof Error?w.message:"Unknown error"})}t.json({success:!0,message:"All channel tests completed",results:l,testCustomer:d})}catch(e){console.error("Error testing all channels:",e),t.status(500).json({error:"Failed to test all channels",details:e instanceof Error?e.message:"Unknown error"})}});var io=Et;async function co(s){s.post("/api/art-locations",bt.sendArtLocationData),s.get("/api/art-locations/:orderId",bt.getArtLocationData),s.post("/api/frame-designs",wt.saveFrameDesign),s.get("/api/frame-designs/:orderId",wt.getFrameDesign),s.get("/api/health",xr.getSystemHealth),s.get("/api/vendor-catalog/all",(r,o)=>{o.json([])}),s.get("/api/vendor-catalog/larson",(r,o)=>{o.json([])}),s.get("/api/vendor-catalog/roma",(r,o)=>{o.json([])}),s.get("/api/vendor-catalog/nielsen",(r,o)=>{o.json([])}),s.get("/api/larson-catalog/crescent",(r,o)=>{o.json([])}),s.get("/api/frames",(r,o)=>{o.json([])}),s.get("/api/auth/status",(r,o)=>{o.json({authenticated:!1,user:null})}),s.get("/api/discord/bot-info",(r,o)=>{o.json({botName:"Jays Frames Ecosystem#5403",status:"online",availableCommands:["/order-status - Check order status","/frame-quote - Get frame quotes","/production-status - Check production queue","/inventory-status - Check inventory levels","/help - Show available commands"],features:["Direct message notifications to customers","Order status updates via Discord DM","Completion notices when frames are ready","Estimate updates for timeline changes","Production alerts for staff"]})}),s.post("/api/discord/test-notification",async(r,o)=>{try{let{discordUserId:a,orderId:n,type:d,message:c}=r.body;if(!a)return o.status(400).json({error:"Discord user ID is required"});let l=r.app.locals.notificationService,b={id:1,email:"customer@example.com",discordUserId:a,preferences:{discord:!0,email:!0,inApp:!0,sms:!1}},w;switch(d){case"order_update":w=await l.sendOrderStatusUpdate(b,n||123,"In Production",c||"Your custom frame is now being crafted by our artisans.");break;case"completion":w=await l.sendCompletionNotice(b,n||123,c||"Ready for pickup at our studio during business hours.");break;case"estimate":w=await l.sendEstimateUpdate(b,n||123,7);break;default:w=await l.notifyCustomer(b,{title:"Test Notification",message:c||"This is a test notification from Jays Frames.",type:"custom",urgency:"normal"})}o.json({success:!0,message:"Discord notification sent successfully",details:w})}catch(a){console.error("Error sending Discord notification:",a),o.status(500).json({error:"Failed to send Discord notification",details:a instanceof Error?a.message:"Unknown error"})}}),s.post("/api/notifications/send",async(r,o)=>{try{let{customerPhone:a,customerEmail:n,orderId:d,type:c,message:l,discordUserId:b}=r.body,{getCustomerByPhone:w,getCustomerByEmail:j,updateCustomerDiscordId:Y}=await Promise.resolve().then(()=>(jt(),Rt)),v=a?w(a):n?j(n):null;if(!v)return o.status(404).json({error:"Customer not found"});b&&!v.discordUserId&&(Y(v.id,b),v.discordUserId=b);let $=r.app.locals.notificationService,T,_=d||Math.floor(Math.random()*1e3)+100;switch(c){case"order_update":T=await $.sendOrderStatusUpdate(v,_,"In Production",l||"Your custom frame is now being crafted by our artisans.");break;case"completion":T=await $.sendCompletionNotice(v,_,l||"Ready for pickup at Jays Frames studio during business hours.");break;case"estimate":T=await $.sendEstimateUpdate(v,_,parseInt(l)||7);break;default:T=await $.notifyCustomer(v,{title:"Jays Frames Notification",message:l||"Thank you for choosing Jays Frames for your custom framing needs.",type:"custom",urgency:"normal"})}o.json({success:!0,customer:{name:v.name,phone:v.phone,email:v.email,hasDiscord:!!v.discordUserId},orderNumber:_,notificationResults:T,message:"Notification sent successfully through enabled channels"})}catch(a){console.error("Error sending customer notification:",a),o.status(500).json({error:"Failed to send notification",details:a instanceof Error?a.message:"Unknown error"})}}),s.get("/api/customers/search",async(r,o)=>{try{let{phone:a,email:n}=r.query,{getCustomerByPhone:d,getCustomerByEmail:c}=await Promise.resolve().then(()=>(jt(),Rt)),l=a?d(a):n?c(n):null;if(!l)return o.status(404).json({error:"Customer not found"});o.json({customer:{id:l.id,name:l.name,phone:l.phone,email:l.email,hasDiscord:!!l.discordUserId,preferences:l.preferences,notes:l.notes}})}catch{o.status(500).json({error:"Failed to search customer"})}}),s.get("/api/kanban/external/orders",async(r,o)=>{try{let{externalKanbanService:a}=await Promise.resolve().then(()=>(Je(),Ze)),n=await a.fetchOrders();o.json(n)}catch{o.status(500).json({success:!1,orders:[],error:"Failed to fetch orders from external Kanban app"})}}),s.get("/api/kanban/external/health",async(r,o)=>{try{let{externalKanbanService:a}=await Promise.resolve().then(()=>(Je(),Ze)),n=await a.healthCheck();o.json(n)}catch{o.status(500).json({status:"error",connected:!1,error:"Failed to check external Kanban health"})}}),s.post("/api/kanban/external/orders/:orderId/status",async(r,o)=>{try{let{orderId:a}=r.params,{status:n,stage:d,notes:c}=r.body,{externalKanbanService:l}=await Promise.resolve().then(()=>(Je(),Ze));await l.updateOrderStatus(a,n,d,c)?o.json({success:!0,orderId:a,updatedStatus:n,stage:d,notes:c,timestamp:new Date().toISOString()}):o.status(500).json({success:!1,error:"Failed to update order status in external Kanban"})}catch{o.status(500).json({success:!1,error:"Failed to update external Kanban order status"})}}),s.get("/api/kanban/orders",St,(r,o)=>{o.json({success:!0,orders:[],endpoint:"/api/kanban/orders",description:"Retrieves all orders with production status and timeline information"})}),s.post("/api/kanban/orders/:orderId/status",St,(r,o)=>{let{orderId:a}=r.params,{status:n,stage:d,notes:c}=r.body;o.json({success:!0,orderId:a,updatedStatus:n,stage:d,notes:c,timestamp:new Date().toISOString(),description:"Updates order production status from external Kanban system"})}),s.get("/api/kanban/status",(r,o)=>{o.json({status:"active",service:"Jays Frames POS System",version:"1.0.0",endpoints:{orders:"/api/kanban/orders",updateStatus:"/api/kanban/orders/:orderId/status",health:"/api/kanban/status"},authentication:"API Key required in Authorization header",timestamp:new Date().toISOString()})}),s.get("/api/kanban/api-key",(r,o)=>{o.json({apiKey:He,usage:"Add this to your Kanban app Authorization header as: Bearer "+He,endpoints:{orders:"/api/kanban/orders",updateStatus:"/api/kanban/orders/:orderId/status"},note:"Keep this API key secure - it provides access to your order data"})}),s.use("/api/hub",Sr),s.use("/api/hub-admin",It),s.use("/api/admin",It),s.post("/api/admin/generate-api-key",async(r,o)=>{try{let{generateApiKey:a}=await Promise.resolve().then(()=>(fe(),De));await a(r,o)}catch(a){console.error("Error in generate-api-key route:",a),o.status(500).json({success:!1,error:a.message})}}),s.get("/api/admin/integration-status",async(r,o)=>{try{let{getIntegrationStatus:a}=await Promise.resolve().then(()=>(fe(),De));await a(r,o)}catch(a){console.error("Error in integration-status route:",a),o.status(500).json({success:!1,error:a.message})}}),s.get("/api/admin/integration-docs",async(r,o)=>{try{let{getIntegrationDocs:a}=await Promise.resolve().then(()=>(fe(),De));await a(r,o)}catch(a){console.error("Error in integration-docs route:",a),o.status(500).json({success:!1,error:a.message})}}),s.get("/api/webhooks",async(r,o)=>{try{o.json({success:!0,webhooks:[]})}catch(a){console.error("Error in webhooks route:",a),o.status(500).json({success:!1,error:a.message})}}),s.use("/api",Gr),s.use("/api",Qr),s.use("/api/integration",Er),s.use("/api/xml-price-sheets",Zr),s.use("/api/larson-optimizer",so),s.use("/api/discord",ao),s.use("/api/notifications",no),s.use("/api/test",io),s.get("/api/materials/pick-list",Cr),s.get("/api/materials/by-supplier",vr),s.get("/api/materials/order/:orderId",Or),s.put("/api/materials/:id",Nr),s.post("/api/materials/purchase-order",Mr),s.get("/api/materials/types",_r),s.get("/api/materials/suppliers",Fr);let t=ba(s),e=new wa({server:t,path:"/ws"});return e.on("connection",r=>{console.log("WebSocket client connected"),r.on("message",o=>{try{console.log("Received message:",o.toString()),e.clients.forEach(a=>{a.readyState===xa.OPEN&&a.send(o.toString())})}catch(a){console.error("WebSocket message error:",a)}}),r.send(JSON.stringify({type:"connection",message:"WebSocket connection established"}))}),t}import Xe from"fs";import{createServer as va,createLogger as Oa}from"vite";import{defineConfig as Sa}from"vite";import Pa from"@vitejs/plugin-react";import Ia from"@replit/vite-plugin-shadcn-theme-json";import Re from"path";import Ca from"@replit/vite-plugin-runtime-error-modal";var uo=Sa({plugins:[Pa(),Ca(),Ia()],resolve:{alias:{"@":Re.resolve(import.meta.dirname,"client","src"),"@shared":Re.resolve(import.meta.dirname,"shared"),"@assets":Re.resolve(import.meta.dirname,"attached_assets")}},root:Re.resolve(import.meta.dirname,"client"),build:{outDir:Re.resolve(import.meta.dirname,"dist/public"),emptyOutDir:!0}});import{nanoid as Na}from"nanoid";import Ma from"express";import je from"path";import{fileURLToPath as _a}from"url";var lo=Oa();function D(s,t="express"){let e=new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0});console.log(`${e} [${t}] ${s}`)}async function po(s,t){let e={middlewareMode:!0,hmr:{server:t},allowedHosts:!0},r=await va({...uo,configFile:!1,customLogger:{...lo,error:(o,a)=>{lo.error(o,a),console.error(`Vite server error: ${o}`)}},server:e,appType:"custom"});s.use(r.middlewares),s.use("*",async(o,a,n)=>{let d=o.originalUrl;try{let c=je.resolve(import.meta.dirname,"..","client","index.html"),l=await Xe.promises.readFile(c,"utf-8");l=l.replace('src="/src/main.tsx"',`src="/src/main.tsx?v=${Na()}"`);let b=await r.transformIndexHtml(d,l);a.status(200).set({"Content-Type":"text/html"}).end(b)}catch(c){r.ssrFixStacktrace(c),n(c)}})}function fo(s){let t=je.resolve(mo,"..","dist","public"),e=je.resolve(mo,"..","client","dist"),r="";Xe.existsSync(t)?(r=t,D(`Serving static files from: ${t}`)):Xe.existsSync(e)?(r=e,D(`Serving static files from: ${e}`)):D("No static files found. Please build the client application.","error"),r&&s.use(Ma.static(r,{maxAge:"1d",etag:!0,index:"index.html"})),s.get("*",(o,a,n)=>{if(o.path.startsWith("/api")||o.path.startsWith("/uploads"))return n();let d=je.resolve(r,"index.html");Xe.existsSync(d)?a.sendFile(d):a.status(500).json({error:"Client application not built",message:'Please run "npm run build" to build the client application'})})}var Fa=_a(import.meta.url),mo=je.dirname(Fa);import ka from"path";import go from"fs";import{fileURLToPath as Aa}from"url";import{dirname as Da}from"path";import Ea from"cors";var Ra=Aa(import.meta.url),Wc=Da(Ra),W=et(),ge=parseInt(process.env.PORT||process.env.REPL_PORT||"5000",10),qt=null,ho=null;try{qt=new zt,ho=new ke(qt),qt.start()}catch(s){D(`Warning: Discord bot initialization failed: ${s}`,"warning"),console.warn("Discord bot failed to initialize, continuing without it")}W.locals.notificationService=ho;W.use(Ea({origin:!0,credentials:!0}));W.use(et.json({limit:"50mb"}));W.use(et.urlencoded({extended:!0,limit:"50mb"}));W.use((s,t,e)=>{let r=Date.now(),o=s.path,a,n=t.json;t.json=function(d,...c){return a=d,n.apply(t,[d,...c])},t.on("finish",()=>{let d=Date.now()-r;if(o.startsWith("/api")){let c=`${s.method} ${o} ${t.statusCode} in ${d}ms`;a&&(c+=` :: ${JSON.stringify(a)}`),c.length>80&&(c=c.slice(0,79)+"\u2026"),D(c)}}),e()});(async()=>{let s=await co(W);W.use((r,o,a,n)=>{let d=r.status||r.statusCode||500,c=r.message||"Internal Server Error";a.status(d).json({message:c}),D(`Error: ${c} (${d})`,"error"),console.error(r)}),W.get("env")==="development"?await po(W,s):fo(W);let t=()=>{try{let r=s.listen(ge,"0.0.0.0",()=>{D(`serving on port ${ge}`),console.log(`\u2713 Server running on port ${ge}`),console.log("\u2713 Environment: production")});r.on("error",a=>{if(a.code==="EADDRINUSE"){D(`Port ${ge} is already in use, trying ${ge+1}`,"warning");let n=ge+1;return s.listen(n,"0.0.0.0",()=>{D(`serving on fallback port ${n}`),console.log(`\u2713 Server running on fallback port ${n}`)})}else D(`Server startup error: ${a.message}`,"error"),console.error("Server error:",a),setTimeout(()=>{process.exit(1)},1e3)});let o=a=>{D(`${a} received, shutting down gracefully`,"info"),console.log("Shutting down server..."),r.close(n=>{n?(console.error("Error during shutdown:",n),process.exit(1)):(D("Server closed","info"),console.log("Server closed gracefully"),process.exit(0))}),setTimeout(()=>{console.log("Force exit after timeout"),process.exit(1)},1e4)};return process.on("SIGTERM",()=>o("SIGTERM")),process.on("SIGINT",()=>o("SIGINT")),r}catch(r){D(`Critical server startup failure: ${r}`,"error"),console.error("Critical error:",r),process.exit(1)}},e=ka.join(process.cwd(),"uploads");try{go.existsSync(e)||go.mkdirSync(e,{recursive:!0})}catch(r){D(`Warning: Could not create uploads directory: ${r}`,"warning")}W.use("/uploads",et.static(e)),t()})();
