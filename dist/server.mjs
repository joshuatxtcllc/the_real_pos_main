var Be=Object.defineProperty;var Rs=Object.getOwnPropertyDescriptor;var Ms=Object.getOwnPropertyNames;var Fs=Object.prototype.hasOwnProperty;var Ds=(o,t,e)=>t in o?Be(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var n=(o,t)=>Be(o,"name",{value:t,configurable:!0});var F=(o,t)=>()=>(o&&(t=o(o=0)),t);var se=(o,t)=>{for(var e in t)Be(o,e,{get:t[e],enumerable:!0})},Ts=(o,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Ms(t))!Fs.call(o,s)&&s!==e&&Be(o,s,{get:()=>t[s],enumerable:!(r=Rs(t,s))||r.enumerable});return o};var Sr=o=>Ts(Be({},"__esModule",{value:!0}),o);var Ot=(o,t,e)=>Ds(o,typeof t!="symbol"?t+"":t,e);var At={};se(At,{customerNotifications:()=>W,customers:()=>N,frames:()=>$,glassOptions:()=>ae,insertCustomerNotificationSchema:()=>ea,insertCustomerSchema:()=>kt,insertFrameSchema:()=>Ls,insertGlassOptionSchema:()=>Bs,insertInventoryCategorySchema:()=>aa,insertInventoryCountItemSchema:()=>fa,insertInventoryCountSchema:()=>pa,insertInventoryItemSchema:()=>ia,insertInventoryLocationSchema:()=>ut,insertInventoryTransactionSchema:()=>ua,insertLarsonJuhlCatalogSchema:()=>Zs,insertMatColorSchema:()=>qs,insertMaterialLocationSchema:()=>ha,insertMaterialOrderSchema:()=>oa,insertNotificationSchema:()=>ba,insertOrderFrameSchema:()=>Vs,insertOrderGroupSchema:()=>Us,insertOrderMatSchema:()=>zs,insertOrderSchema:()=>Gs,insertOrderSpecialServiceSchema:()=>Ks,insertPaymentLinkSchema:()=>ga,insertPurchaseOrderLineSchema:()=>ma,insertPurchaseOrderSchema:()=>da,insertQrCodeScanSchema:()=>Or,insertQrCodeSchema:()=>vr,insertSpecialServiceSchema:()=>Ws,insertSupplierSchema:()=>sa,insertUserSchema:()=>Qs,insertWholesaleOrderSchema:()=>Ys,inventoryCategories:()=>be,inventoryCountItems:()=>Ir,inventoryCounts:()=>_t,inventoryItems:()=>M,inventoryLocations:()=>R,inventoryTransactions:()=>fe,larsonJuhlCatalog:()=>xr,matColors:()=>te,materialLocations:()=>Nt,materialOrderStatuses:()=>ra,materialOrders:()=>I,materialTypes:()=>ta,measurementUnits:()=>na,notificationChannels:()=>Xs,notificationTypes:()=>Js,notifications:()=>H,orderFrames:()=>He,orderGroups:()=>T,orderMats:()=>Ue,orderSpecialServices:()=>Ne,orders:()=>O,paymentLinks:()=>j,productionStatuses:()=>Hs,purchaseOrderLines:()=>lt,purchaseOrderStatuses:()=>la,purchaseOrders:()=>ce,qrCodeScans:()=>Ct,qrCodeTypes:()=>ya,qrCodes:()=>Ae,specialServices:()=>ne,suppliers:()=>U,transactionTypes:()=>ca,users:()=>pe,wholesaleOrders:()=>ie});import{pgTable as A,text as u,serial as D,integer as _,boolean as L,numeric as x,timestamp as v,jsonb as We,primaryKey as $s}from"drizzle-orm/pg-core";import{createInsertSchema as E}from"drizzle-zod";var N,kt,$,Ls,te,qs,ae,Bs,ne,Ws,T,Us,Hs,O,Gs,Ne,Ks,Ue,zs,He,Vs,ie,Ys,pe,Qs,xr,Zs,Js,Xs,W,ea,ta,ra,I,oa,U,sa,be,aa,R,ut,na,M,ia,ca,fe,ua,la,ce,da,lt,ma,_t,pa,Ir,fa,j,ga,ya,Ae,vr,Ct,Or,Nt,ha,H,ba,Q=F(()=>{"use strict";N=A("customers",{id:D("id").primaryKey(),name:u("name").notNull(),email:u("email"),phone:u("phone"),address:u("address"),stripeCustomerId:u("stripe_customer_id"),createdAt:v("created_at").defaultNow()}),kt=E(N).omit({id:!0,createdAt:!0}),$=A("frames",{id:u("id").primaryKey(),name:u("name").notNull(),manufacturer:u("manufacturer").notNull(),material:u("material").notNull(),width:x("width").notNull(),depth:x("depth").notNull(),price:x("price").notNull(),catalogImage:u("catalog_image").notNull(),edgeTexture:u("edge_texture"),corner:u("corner")}),Ls=E($),te=A("mat_colors",{id:u("id").primaryKey(),name:u("name").notNull(),color:u("color").notNull(),price:x("price").notNull(),manufacturer:u("manufacturer"),code:u("code"),description:u("description"),category:u("category")}),qs=E(te),ae=A("glass_options",{id:u("id").primaryKey(),name:u("name").notNull(),description:u("description").notNull(),price:x("price").notNull()}),Bs=E(ae),ne=A("special_services",{id:u("id").primaryKey(),name:u("name").notNull(),description:u("description").notNull(),price:x("price").notNull()}),Ws=E(ne),T=A("order_groups",{id:D("id").primaryKey(),customerId:_("customer_id").references(()=>N.id),subtotal:x("subtotal"),tax:x("tax"),total:x("total"),status:u("status").notNull().default("open"),paymentMethod:u("payment_method"),notes:u("notes"),createdAt:v("created_at").defaultNow(),stripePaymentIntentId:u("stripe_payment_intent_id"),stripePaymentStatus:u("stripe_payment_status"),paymentDate:v("payment_date"),discountAmount:x("discount_amount"),discountType:u("discount_type"),taxExempt:L("tax_exempt").default(!1),cashAmount:x("cash_amount"),checkNumber:u("check_number"),invoiceEmailSent:L("invoice_email_sent").default(!1),invoiceEmailDate:v("invoice_email_date")}),Us=E(T).omit({id:!0,createdAt:!0}),Hs=["order_processed","scheduled","materials_ordered","materials_arrived","frame_cut","mat_cut","prepped","completed","delayed"],O=A("orders",{id:D("id").primaryKey(),customerId:_("customer_id").references(()=>N.id),orderGroupId:_("order_group_id").references(()=>T.id),frameId:u("frame_id").references(()=>$.id),matColorId:u("mat_color_id").references(()=>te.id),glassOptionId:u("glass_option_id").references(()=>ae.id),artworkWidth:x("artwork_width").notNull(),artworkHeight:x("artwork_height").notNull(),matWidth:x("mat_width").notNull(),artworkDescription:u("artwork_description"),artworkType:u("artwork_type"),artworkLocation:u("artwork_location"),quantity:_("quantity").notNull().default(1),subtotal:x("subtotal").notNull(),tax:x("tax").notNull(),total:x("total").notNull(),status:u("status").notNull().default("pending"),productionStatus:u("production_status").$type().notNull().default("order_processed"),previousStatus:u("previous_status").$type(),createdAt:v("created_at").defaultNow(),dueDate:v("due_date"),artworkImage:u("artwork_image"),frameDesignImage:u("frame_design_image"),lastNotificationSent:v("last_notification_sent"),estimatedCompletionDays:_("estimated_completion_days"),addToWholesaleOrder:L("add_to_wholesale_order").default(!1),lastStatusChange:v("last_status_change").defaultNow(),notificationsEnabled:L("notifications_enabled").default(!0),useMultipleMats:L("use_multiple_mats").default(!1),useMultipleFrames:L("use_multiple_frames").default(!1),useManualFrame:L("use_manual_frame").default(!1),manualFrameName:u("manual_frame_name"),manualFrameCost:x("manual_frame_cost"),miscChargeDescription:u("misc_charge_description"),miscChargeAmount:x("misc_charge_amount")}),Gs=E(O).omit({id:!0,createdAt:!0}),Ne=A("order_special_services",{orderId:_("order_id").references(()=>O.id),specialServiceId:u("special_service_id").references(()=>ne.id)},o=>({pk:$s({columns:[o.orderId,o.specialServiceId]})})),Ks=E(Ne),Ue=A("order_mats",{id:D("id").primaryKey(),orderId:_("order_id").references(()=>O.id).notNull(),matColorId:u("mat_color_id").references(()=>te.id).notNull(),position:_("position").notNull(),width:x("width").notNull(),offset:x("offset").notNull().default("0"),createdAt:v("created_at").defaultNow()}),zs=E(Ue).omit({id:!0,createdAt:!0}),He=A("order_frames",{id:D("id").primaryKey(),orderId:_("order_id").references(()=>O.id).notNull(),frameId:u("frame_id").references(()=>$.id).notNull(),position:_("position").notNull(),distance:x("distance").notNull().default("0"),createdAt:v("created_at").defaultNow()}),Vs=E(He).omit({id:!0,createdAt:!0}),ie=A("wholesale_orders",{id:D("id").primaryKey(),orderId:_("order_id").references(()=>O.id),manufacturer:u("manufacturer").notNull(),items:We("items").notNull(),status:u("status").notNull().default("pending"),createdAt:v("created_at").defaultNow()}),Ys=E(ie).omit({id:!0,createdAt:!0}),pe=A("users",{id:D("id").primaryKey(),username:u("username").notNull().unique(),password:u("password").notNull(),role:u("role").notNull().default("employee")}),Qs=E(pe).omit({id:!0}),xr=A("larson_juhl_catalog",{id:u("id").primaryKey(),name:u("name").notNull(),hex_color:u("hex_color"),price:x("price",{precision:10,scale:6}).notNull(),code:u("code").notNull(),crescent_code:u("crescent_code"),description:u("description"),category:u("category"),manufacturer:u("manufacturer").notNull(),type:u("type").notNull().default("matboard"),material:u("material"),width:x("width"),depth:x("depth"),edge_texture:u("edge_texture"),corner:u("corner"),catalog_image:u("catalog_image"),createdAt:v("created_at").defaultNow()}),Zs=E(xr).omit({createdAt:!0}),Js=["status_update","estimated_completion","status_change","due_date_update","completion_reminder","order_complete","payment_reminder","delay_notification","payment_link"],Xs=["email","sms","both"],W=A("customer_notifications",{id:D("id").primaryKey(),customerId:_("customer_id").references(()=>N.id),orderId:_("order_id").references(()=>O.id),notificationType:u("notification_type").$type().notNull(),channel:u("channel").$type().notNull().default("email"),subject:u("subject").notNull(),message:u("message").notNull(),sentAt:v("sent_at").defaultNow(),successful:L("successful").notNull(),responseData:We("response_data"),previousStatus:u("previous_status"),newStatus:u("new_status"),paymentLinkId:_("payment_link_id")}),ea=E(W).omit({id:!0,sentAt:!0}),ta=["frame","matboard","glass","backing_board","hardware","specialty_materials"],ra=["pending","processed","ordered","arrived","frame_cut","mat_cut","prepped","completed","delayed","canceled"],I=A("material_orders",{id:D("id").primaryKey(),materialType:u("material_type").$type().notNull(),materialId:u("material_id").notNull(),materialName:u("material_name").notNull(),quantity:x("quantity").notNull(),status:u("status").$type().notNull().default("pending"),sourceOrderId:_("source_order_id").references(()=>O.id),orderDate:v("order_date"),expectedArrival:v("expected_arrival"),actualArrival:v("actual_arrival"),supplierName:u("supplier_name"),supplierOrderNumber:u("supplier_order_number"),notes:u("notes"),costPerUnit:x("cost_per_unit"),totalCost:x("total_cost"),priority:u("priority").default("normal"),hubOrderId:u("hub_order_id"),hubSyncStatus:u("hub_sync_status").default("not_synced"),hubLastSyncDate:v("hub_last_sync_date"),hubTrackingInfo:u("hub_tracking_info"),hubEstimatedDelivery:v("hub_estimated_delivery"),hubSupplierNotes:u("hub_supplier_notes"),orderReference:u("order_reference"),unitMeasurement:u("unit_measurement"),createdAt:v("created_at").defaultNow()}),oa=E(I).omit({id:!0,createdAt:!0,hubOrderId:!0,hubSyncStatus:!0,hubLastSyncDate:!0,hubTrackingInfo:!0,hubEstimatedDelivery:!0,hubSupplierNotes:!0}),U=A("suppliers",{id:D("id").primaryKey(),name:u("name").notNull(),contactName:u("contact_name"),email:u("email"),phone:u("phone"),address:u("address"),website:u("website"),accountNumber:u("account_number"),notes:u("notes"),paymentTerms:u("payment_terms"),minimumOrderAmount:x("minimum_order_amount"),shippingPreference:u("shipping_preference"),leadTime:_("lead_time"),active:L("active").default(!0),createdAt:v("created_at").defaultNow(),lastOrderDate:v("last_order_date")}),sa=E(U).omit({id:!0,createdAt:!0}),be=A("inventory_categories",{id:D("id").primaryKey(),name:u("name").notNull(),description:u("description"),parentCategoryId:_("parent_category_id").references(()=>be.id),createdAt:v("created_at").defaultNow()}),aa=E(be).omit({id:!0,createdAt:!0}),R=A("inventory_locations",{id:D("id").primaryKey(),name:u("name").notNull(),description:u("description"),type:u("type"),parentLocationId:_("parent_location_id").references(()=>R.id),active:L("active").default(!0),createdAt:v("created_at").defaultNow()}),ut=E(R).omit({id:!0,createdAt:!0}),na=["each","inch","foot","united_inch","square_inch","sheet","roll","pound","liter","gallon"],M=A("inventory_items",{id:D("id").primaryKey(),sku:u("sku").notNull().unique(),name:u("name").notNull(),description:u("description"),categoryId:_("category_id").references(()=>be.id),supplierId:_("supplier_id").references(()=>U.id),supplierSku:u("supplier_sku"),unitOfMeasure:u("unit_of_measure").$type().notNull(),costPerUnit:x("cost_per_unit").notNull(),retailPrice:x("retail_price"),minimumStockLevel:x("minimum_stock_level").notNull(),reorderLevel:x("reorder_level").notNull(),reorderQuantity:x("reorder_quantity"),locationId:_("location_id").references(()=>R.id),barcode:u("barcode"),notes:u("notes"),tags:u("tags").array(),isActive:L("is_active").default(!0),createdAt:v("created_at").defaultNow(),updatedAt:v("updated_at").defaultNow(),lastCountDate:v("last_count_date"),imageUrl:u("image_url"),dimensions:We("dimensions"),autoBatchReorder:L("auto_batch_reorder").default(!1),materialType:u("material_type").$type(),materialId:u("material_id")}),ia=E(M).omit({id:!0,createdAt:!0,updatedAt:!0}),ca=["purchase","sale","adjustment","return","transfer","count","scrap","initial"],fe=A("inventory_transactions",{id:D("id").primaryKey(),itemId:_("item_id").references(()=>M.id).notNull(),type:u("type").$type().notNull(),quantity:x("quantity").notNull(),unitCost:x("unit_cost"),locationId:_("location_id").references(()=>R.id),relatedOrderId:_("related_order_id").references(()=>O.id),notes:u("notes"),referenceNumber:u("reference_number"),createdAt:v("created_at").defaultNow(),createdBy:_("created_by").references(()=>pe.id)}),ua=E(fe).omit({id:!0,createdAt:!0}),la=["draft","pending","approved","sent","partially_received","received","canceled"],ce=A("purchase_orders",{id:D("id").primaryKey(),poNumber:u("po_number").notNull(),supplierId:_("supplier_id").references(()=>U.id).notNull(),orderDate:v("order_date").notNull(),expectedDeliveryDate:v("expected_delivery_date"),status:u("status").$type().default("draft").notNull(),subtotal:x("subtotal"),tax:x("tax"),shipping:x("shipping"),total:x("total"),notes:u("notes"),createdBy:_("created_by").references(()=>pe.id),createdAt:v("created_at").defaultNow(),updatedAt:v("updated_at").defaultNow(),receivedDate:v("received_date"),supplierOrderConfirmation:u("supplier_order_confirmation"),shippingMethod:u("shipping_method"),paymentMethod:u("payment_method"),paymentTerms:u("payment_terms"),tracking:u("tracking"),attachments:u("attachments").array()}),da=E(ce).omit({id:!0,createdAt:!0,updatedAt:!0}),lt=A("purchase_order_lines",{id:D("id").primaryKey(),purchaseOrderId:_("purchase_order_id").references(()=>ce.id).notNull(),itemId:_("item_id").references(()=>M.id).notNull(),quantity:x("quantity").notNull(),unitCost:x("unit_cost").notNull(),lineTotal:x("line_total").notNull(),receivedQuantity:x("received_quantity").default("0"),notes:u("notes"),createdAt:v("created_at").defaultNow()}),ma=E(lt).omit({id:!0,createdAt:!0}),_t=A("inventory_counts",{id:D("id").primaryKey(),countReference:u("count_reference").notNull(),startDate:v("start_date").notNull(),endDate:v("end_date"),status:u("status").default("in_progress").notNull(),notes:u("notes"),createdBy:_("created_by").references(()=>pe.id),createdAt:v("created_at").defaultNow()}),pa=E(_t).omit({id:!0,createdAt:!0}),Ir=A("inventory_count_items",{id:D("id").primaryKey(),countId:_("count_id").references(()=>_t.id).notNull(),itemId:_("item_id").references(()=>M.id).notNull(),locationId:_("location_id").references(()=>R.id),expectedQuantity:x("expected_quantity"),actualQuantity:x("actual_quantity"),notes:u("notes"),countedBy:_("counted_by").references(()=>pe.id),countedAt:v("counted_at"),createdAt:v("created_at").defaultNow()}),fa=E(Ir).omit({id:!0,createdAt:!0}),j=A("payment_links",{id:D("id").primaryKey(),token:u("token").notNull().unique(),amount:x("amount",{precision:10,scale:2}).notNull(),description:u("description"),customerId:_("customer_id").references(()=>N.id),createdAt:v("created_at").defaultNow(),expiresAt:v("expires_at").notNull(),usedAt:v("used_at"),used:L("used").default(!1),paymentIntentId:u("payment_intent_id"),paymentStatus:u("payment_status").default("pending")}),ga=E(j).omit({id:!0,createdAt:!0,usedAt:!0,used:!0,paymentIntentId:!0,paymentStatus:!0}),ya=["inventory_location","inventory_item","material_order","customer_order","production_status","artwork_location"],Ae=A("qr_codes",{id:D("id").primaryKey(),code:u("code").notNull().unique(),type:u("type").$type().notNull(),entityId:u("entity_id").notNull(),title:u("title").notNull(),description:u("description"),metadata:We("metadata"),createdAt:v("created_at").defaultNow(),lastScanned:v("last_scanned"),scanCount:_("scan_count").default(0),active:L("active").default(!0)}),vr=E(Ae).omit({id:!0,createdAt:!0,lastScanned:!0,scanCount:!0}),Ct=A("qr_code_scans",{id:D("id").primaryKey(),qrCodeId:_("qr_code_id").references(()=>Ae.id).notNull(),userId:_("user_id").references(()=>pe.id),scannedAt:v("scanned_at").defaultNow(),location:u("location"),action:u("action"),metadata:We("metadata")}),Or=E(Ct).omit({id:!0,scannedAt:!0}),Nt=A("material_locations",{id:D("id").primaryKey(),materialType:u("material_type").$type().notNull(),materialId:u("material_id").notNull(),locationId:_("location_id").references(()=>R.id).notNull(),qrCodeId:_("qr_code_id").references(()=>Ae.id),quantity:x("quantity").notNull().default("1"),notes:u("notes"),lastUpdated:v("last_updated").defaultNow(),active:L("active").default(!0)}),ha=E(Nt).omit({id:!0,lastUpdated:!0}),H=A("notifications",{id:D("id").primaryKey(),title:u("title").notNull(),description:u("description").notNull(),source:u("source").notNull(),sourceId:u("source_id"),type:u("type").$type().notNull().default("info"),createdAt:v("created_at").defaultNow(),read:L("read").default(!1),actionable:L("actionable").default(!1),link:u("link"),smsEnabled:L("sms_enabled").default(!1),smsRecipient:u("sms_recipient"),userId:_("user_id").references(()=>pe.id)}),ba=E(H).omit({id:!0,createdAt:!0})});var Ge,kr=F(()=>{"use strict";Ge=[{id:"larson-4512",name:"Larson Gold Leaf 4512",manufacturer:"Larson-Juhl",material:"wood",width:"2.5",depth:"1.75",price:"12.99",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#D4AF37"},{id:"larson-210286",name:"Larson Academie Black 210286",manufacturer:"Larson-Juhl",material:"wood",width:"1.25",depth:"0.75",price:"8.50",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#000000"},{id:"larson-655320",name:"Larson Biltmore Gold 655320",manufacturer:"Larson-Juhl",material:"wood",width:"1.5",depth:"0.875",price:"10.75",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#FFD700"},{id:"larson-460530",name:"Larson Ventura Silver 460530",manufacturer:"Larson-Juhl",material:"metal",width:"0.75",depth:"1.125",price:"9.25",catalogImage:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#C0C0C0"},{id:"larson-310445",name:"Larson Classic Walnut 310445",manufacturer:"Larson-Juhl",material:"wood",width:"2.0",depth:"1.25",price:"14.50",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#8B4513"},{id:"larson-220158",name:"Larson Heritage Cherry 220158",manufacturer:"Larson-Juhl",material:"wood",width:"1.75",depth:"1.0",price:"11.25",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#722F37"},{id:"nielsen-71",name:"Nielsen Florentine",manufacturer:"Nielsen",material:"metal",width:"1.25",depth:"0.75",price:"8.99",catalogImage:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#C0C0C0"},{id:"roma-250",name:"Roma Dark Walnut",manufacturer:"Roma Moulding",material:"wood",width:"3.0",depth:"2.0",price:"14.50",catalogImage:"https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#5C4033"},{id:"omega-102",name:"Omega Black Satin",manufacturer:"Omega Moulding",material:"wood",width:"2.0",depth:"1.5",price:"9.75",catalogImage:"https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#2D2D2D"},{id:"bella-35",name:"Bella White Simple",manufacturer:"Bella Moulding",material:"composite",width:"1.5",depth:"1.0",price:"6.50",catalogImage:"https://images.unsplash.com/photo-1574117936532-46e544aeb239?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjZ8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1574117936532-46e544aeb239?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjZ8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1574117936532-46e544aeb239?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjZ8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#F5F5F5"},{id:"larson-8921",name:"Larson Ornate Gold",manufacturer:"Larson-Juhl",material:"wood",width:"3.5",depth:"2.25",price:"18.99",catalogImage:"https://images.unsplash.com/photo-1581814605484-050c5bb1196c?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzF8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1581814605484-050c5bb1196c?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzF8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1581814605484-050c5bb1196c?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzF8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#D4AF37"}]});async function _r(){try{return console.log("Loading static matboard data to prevent application freezing..."),[]}catch(o){return console.error("Error fetching Crescent matboards:",o),[]}}var Cr=F(()=>{"use strict";n(_r,"fetchCrescentMatboards")});var Nr,wa,Ke,Pa,Ar=F(()=>{"use strict";Cr();Nr=[{id:"white",name:"White",color:"#FFFFFF",price:"0.02",manufacturer:"Basic",code:"WHT",description:"Pure white mat board",category:"Standard"},{id:"black",name:"Black",color:"#2C2C2C",price:"0.025",manufacturer:"Basic",code:"BLK",description:"Deep black mat board",category:"Standard"},{id:"grey",name:"Grey",color:"#ADADAD",price:"0.02",manufacturer:"Basic",code:"GRY",description:"Neutral grey mat board",category:"Standard"},{id:"beige",name:"Beige",color:"#F5F5DC",price:"0.02",manufacturer:"Basic",code:"BGE",description:"Soft beige mat board",category:"Standard"}],wa=[{id:"crescent-white",name:"Bright White",color:"#FFFFFF",price:"0.025",manufacturer:"Crescent",code:"S100",description:"Bright white conservation mat board",category:"Whites"},{id:"crescent-cream",name:"Cream",color:"#FFF8E1",price:"0.025",manufacturer:"Crescent",code:"S101",description:"Cream white conservation mat board",category:"Whites"},{id:"crescent-antique",name:"Antique White",color:"#F5F1E6",price:"0.025",manufacturer:"Crescent",code:"S102",description:"Subtle antique white tone",category:"Whites"},{id:"crescent-stone",name:"Stone",color:"#E0DCCC",price:"0.027",manufacturer:"Crescent",code:"S200",description:"Light stone grey conservation mat",category:"Neutrals"},{id:"crescent-fog",name:"Fog",color:"#D6D6D6",price:"0.027",manufacturer:"Crescent",code:"S201",description:"Subtle fog grey conservation mat",category:"Neutrals"},{id:"crescent-granite",name:"Granite",color:"#A9A9A9",price:"0.027",manufacturer:"Crescent",code:"S202",description:"Darker granite grey tone",category:"Neutrals"},{id:"crescent-colonial-blue",name:"Colonial Blue",color:"#B5C7D3",price:"0.029",manufacturer:"Crescent",code:"S300",description:"Subtle colonial blue conservation mat",category:"Blues"},{id:"crescent-wedgewood",name:"Wedgewood",color:"#6E99C0",price:"0.029",manufacturer:"Crescent",code:"S301",description:"Classic wedgewood blue conservation mat",category:"Blues"},{id:"crescent-ultramarine",name:"Ultramarine",color:"#4166B0",price:"0.029",manufacturer:"Crescent",code:"S302",description:"Deep ultramarine blue conservation mat",category:"Blues"},{id:"crescent-sage",name:"Sage",color:"#BCCCBA",price:"0.029",manufacturer:"Crescent",code:"S400",description:"Soft sage green conservation mat",category:"Greens"},{id:"crescent-celadon",name:"Celadon",color:"#9CB084",price:"0.029",manufacturer:"Crescent",code:"S401",description:"Classic celadon green conservation mat",category:"Greens"},{id:"crescent-forest",name:"Forest",color:"#4A6741",price:"0.029",manufacturer:"Crescent",code:"S402",description:"Deep forest green conservation mat",category:"Greens"},{id:"crescent-sand",name:"Sand",color:"#E6D7B8",price:"0.027",manufacturer:"Crescent",code:"S500",description:"Light sand beige conservation mat",category:"Earth Tones"},{id:"crescent-chamois",name:"Chamois",color:"#D9BC8C",price:"0.027",manufacturer:"Crescent",code:"S501",description:"Warm chamois tan conservation mat",category:"Earth Tones"},{id:"crescent-chestnut",name:"Chestnut",color:"#A67B5B",price:"0.027",manufacturer:"Crescent",code:"S502",description:"Rich chestnut brown conservation mat",category:"Earth Tones"},{id:"crescent-pale-rose",name:"Pale Rose",color:"#F0D4D4",price:"0.029",manufacturer:"Crescent",code:"S600",description:"Subtle pale rose conservation mat",category:"Warm Tones"},{id:"crescent-dusty-rose",name:"Dusty Rose",color:"#D4A9A9",price:"0.029",manufacturer:"Crescent",code:"S601",description:"Classic dusty rose conservation mat",category:"Warm Tones"},{id:"crescent-rust",name:"Rust",color:"#B56A55",price:"0.029",manufacturer:"Crescent",code:"S602",description:"Deep rust red conservation mat",category:"Warm Tones"},{id:"crescent-black",name:"Raven Black",color:"#1A1A1A",price:"0.03",manufacturer:"Crescent",code:"S700",description:"Deep black conservation mat board",category:"Black"}],Ke=[...Nr,...wa],Pa=n(async()=>{if(typeof window>"u"){console.log("Skipping Supabase fetch on server-side");return}try{console.log("Fetching Crescent matboards from Larson Juhl catalog...");let o=await _r();if(o&&o.length>0){console.log("Converting API matboards to MatColor format");let t=o.map(r=>({id:r.id,name:r.name,color:r.hex_color||"#FFFFFF",price:r.price,manufacturer:r.manufacturer,code:r.code||null,description:r.description||null,category:r.category||null}));Ke=[...Nr,...t],console.log(`Loaded and converted ${o.length} Crescent matboards from Larson Juhl catalog`)}else console.log("No Crescent matboards found in Larson Juhl catalog or empty response. Using static fallback data.")}catch(o){console.error("Failed to load Crescent matboards:",o),console.log("Using static Crescent matboard catalog as fallback.")}},"loadCrescentMatboardsFromSupabase");typeof window<"u"&&Pa()});var dt,mt,Er=F(()=>{"use strict";dt=[{id:"none",name:"No Glass",description:"No glass protection",price:"0.00"},{id:"regular",name:"Regular Glass",description:"Standard protection",price:"0.08"},{id:"uv",name:"Museum Glass",description:"Museum non-glare",price:"0.45"},{id:"museum",name:"Conservation Glass",description:"Premium UV protection",price:"0.25"},{id:"regular-acrylic",name:"Regular Acrylic",description:"Standard acrylic glazing",price:"0.12"},{id:"conservation-clear-acrylic",name:"Conservation Clear Acrylic",description:"UV filtering acrylic glazing",price:"0.35"},{id:"optium-acrylic",name:"Optium Acrylic",description:"Premium non-glare acrylic",price:"0.45"}],mt=[{id:"float-mount",name:"Float Mount",description:"Artwork appears to float",price:"50.00"},{id:"glass-float",name:"Glass Float",description:"Suspended between glass",price:"55.00"},{id:"shadowbox",name:"Shadowbox",description:"For 3D objects",price:"65.00"},{id:"labor-30min",name:"Additional Labor (30 min)",description:"Custom work",price:"30.00"},{id:"labor-1hour",name:"Additional Labor (1 hour)",description:"Custom work",price:"55.00"}]});import{createClient as Sa}from"@supabase/supabase-js";var pt,jr=F(()=>{"use strict";pt=null;try{let o=process.env.SUPABASE_URL||process.env.VITE_SUPABASE_URL,t=process.env.SUPABASE_KEY||process.env.VITE_SUPABASE_KEY||process.env.VITE_SUPABASE_ANON_KEY;o&&t?(pt=Sa(o,t),console.log("Server: Successfully initialized Supabase client")):(pt={from:n(()=>({select:n(()=>Promise.resolve({data:[],error:null}),"select"),insert:n(()=>Promise.resolve({data:[],error:null}),"insert"),update:n(()=>Promise.resolve({data:[],error:null}),"update"),delete:n(()=>Promise.resolve({data:null,error:null}),"delete"),upsert:n(()=>Promise.resolve({data:null,error:null}),"upsert")}),"from"),rpc:n(()=>Promise.resolve({data:null,error:null}),"rpc")},console.log("Server: Using mock Supabase client - data operations will be handled by Drizzle/PostgreSQL"))}catch(o){console.error("Server: Error initializing Supabase client:",o),pt={from:n(()=>({select:n(()=>Promise.resolve({data:[],error:null}),"select"),insert:n(()=>Promise.resolve({data:[],error:null}),"insert"),update:n(()=>Promise.resolve({data:[],error:null}),"update"),delete:n(()=>Promise.resolve({data:null,error:null}),"delete"),upsert:n(()=>Promise.resolve({data:null,error:null}),"upsert")}),"from"),rpc:n(()=>Promise.resolve({data:null,error:null}),"rpc")}}});import{Pool as xa,neonConfig as Ia}from"@neondatabase/serverless";import{drizzle as va}from"drizzle-orm/neon-serverless";import Oa from"ws";var ka,l,Z=F(()=>{"use strict";Q();jr();Ia.webSocketConstructor=Oa;if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL must be set. Did you forget to provision a database?");ka=new xa({connectionString:process.env.DATABASE_URL}),l=va({client:ka,schema:At})});function Ee(o,t){let e=new Date().toISOString(),r=t?`[${t}]`:"";console.log(`${e} ${r} ${o}`)}var Rr=F(()=>{"use strict";n(Ee,"log")});function Et(o,t,e,r){let s=o/t,a=e+r;return s/a}function _a(o){return o>=40?2.2:o>=25?2.4:o>=15?2.6:o>=10?2.8:o>=6?3:o>=4?3.2:o>=2?3.5:4}function Mr(o,t,e,r){let s=o+e*2,a=t+e*2,c=(s+a)/12*r,f=_a(c);return c*f}function Fr(o,t,e,r){let s=o+e*2,a=t+e*2,i=s+a,d=i*r*2.5,c=5.5;i<=24?c=5.5:i<=36?c=5:i<=50?c=4.5:i<=68?c=4.2:i<=88?c=3.8:i<=108?c=3.5:c=3.2;let f=Ca(i);return d*c+f}function Dr(o,t,e,r){let s=o+e*2,a=t+e*2,i=s+a,d=i*r,c=4;return i<=24?c=4:i<=36?c=3.8:i<=50?c=3.5:i<=68?c=3.2:i<=88?c=3:i<=108?c=2.8:c=2.5,d*c}function Ca(o){let t=15;return o<=24?t=15:o<=36?t=20:o<=50?t=25:o<=68?t=35:o<=88?t=45:o<=108?t=55:t=65,t}var Tr=F(()=>{"use strict";n(Et,"calculatePricePerUnitedInch");n(_a,"calculateMarkupFactor");n(Mr,"calculateFramePrice");n(Fr,"calculateMatPrice");n(Dr,"calculateGlassPrice");n(Ca,"calculateMatLaborCharge")});var qr={};se(qr,{calculateFramePrice:()=>Na,calculateFramingPrice:()=>La,calculateGlassPrice:()=>Ea,calculateMatPrice:()=>Aa});function Na(o,t){let e=t*6,r=Ma(e);return o*t*r*1.2}function Aa(o,t,e){let r=Da(e);return t*o*r}function Ea(o,t,e=0,r=0,s="regular"){let a=e&&r?e+r:Math.sqrt(t)*2,i=Fa(a),d=1;switch(s){case"conservation":d=1.5;break;case"museum":d=2;break}let c=t/144;return(a<=40?85:125)+c*o*i*.35*d}function Ma(o){return o<=20?1.8:o<=40?2.2:o<=60?2.6:o<=80?3:3.4}function Fa(o){return o<=20?2.8:o<=40?3.2:o<=60?3.6:o<=80?4:4.5}function Da(o){return o<=20?2.5:o<=40?2.8:o<=60?3.1:o<=80?3.4:3.8}function Ta(o,t,e,r){let s=r/40;return{frameAssembly:o?.25*s:0,matCutting:t?.3*s:0,glassCutting:e?.15*s:0,fitting:.2*s,finishing:.1*s}}function $a(o,t,e){return(o.frameAssembly+o.matCutting+o.glassCutting+o.fitting+o.finishing)*t*e}async function La(o){let{frameId:t,matColorId:e,glassOptionId:r,artworkWidth:s,artworkHeight:a,matWidth:i,quantity:d,includeWholesalePrices:c=!1}=o,f=t&&t!=="none"?await w.getFrame(t):null,C=e&&e!=="none"?await w.getMatColor(e):null,g=r&&r!=="none"?await w.getGlassOption(r):null,m=s+a,p=s+i*2,h=a+i*2,P=p+h,S=p*h-s*a,y=p*2+h*2,k=c?{frame:f?f.price:"0.00",mat:"0.00",glass:g&&g.price||"0.00",backing:"0.00"}:void 0,G=0;if(f){let Ce=parseFloat(f.price);if(G=Mr(s,a,i,Ce),k){let Te=s+i*2,$e=a+i*2,me=(Te+$e)/12*Ce;k.frame=me.toFixed(2)}}let B=0;if(C){let ee=Et(45.5,25,32,40);if(B=Fr(s,a,i,ee),k){let me=s+i*2,Le=a+i*2,qe=(me+Le)*ee;k.mat=qe.toFixed(2)}}let le=0;if(g){let ee=Et(125,10,24,36);if(le=Dr(s,a,i,ee),k){let me=s+i*2,Le=a+i*2,qe=(me+Le)*ee;k.glass=qe.toFixed(2)}}let de=.04,nt=p*h,hr=nt*de*ja;k&&(k.backing=(nt*de).toFixed(2));let br=Ta(!!f,!!C,!!g,P),vt=$a(br,Lr,$r),wr=G+B+le+hr,De=wr+vt,Es=De*d,Pr;if(c&&k){let Ce=f?parseFloat(f.price)*y/12:0,Te=C?parseFloat(k.mat):0,$e=g&&g.price?parseFloat(g.price)*p*h/144:0,it=parseFloat(k.backing),ee=Ce+Te+$e+it,me=ee*Ra,Le=ee+me+vt,ct=De-Le,qe=ct/De,js=De/ee;Pr={totalWholesaleCost:ee,overheadCost:me,grossProfit:ct,grossProfitMargin:qe,markupMultiplier:js}}return{framePrice:G,matPrice:B,glassPrice:le,backingPrice:hr,laborCost:vt,materialCost:wr,subtotal:De,totalPrice:Es,wholesalePrices:k,laborRates:{baseRate:Lr,regionalFactor:$r,estimates:br},profitability:Pr}}var ja,$r,Lr,Ra,Br=F(()=>{"use strict";re();Tr();n(Na,"calculateFramePrice");n(Aa,"calculateMatPrice");n(Ea,"calculateGlassPrice");ja=1.2,$r=1.15,Lr=45,Ra=.3;n(Ma,"calculateFrameMarkup");n(Fa,"calculateGlassMarkup");n(Da,"calculateMatMarkup");n(Ta,"calculateLaborEstimates");n($a,"calculateLaborCost");n(La,"calculateFramingPrice")});import qa from"axios";async function jt(o){try{let t=await qa.post(`${Ba}/api/notifications/send`,{to:o.to,subject:o.subject,message:o.message,orderId:o.orderId,customerName:o.customerName,type:o.type||"order_update",source:"Jays Frames POS",method:"email",deliveryType:"email"},{headers:{Authorization:`Bearer ${Wa}`,"Content-Type":"application/json"},timeout:1e4});if(t.data&&t.data.success)console.log(`Email notification sent successfully to ${o.to} via SMS Hub`);else throw new Error(t.data?.error||"SMS Hub returned error response")}catch(t){throw console.error("SMS Hub Error:",t.message),t.response&&console.error("SMS Hub Response:",t.response.data),new Error(`Failed to send email notification via SMS Hub: ${t.message}`)}}async function Wr(o,t,e,r,s){let a=`Hi ${e}, your order #${r} status has been updated to: ${s}. Thank you for choosing Jay's Frames!`;await jt({to:o,subject:`Order #${r} Update`,message:a,orderId:r,customerName:e,type:"status_update"})}var Ba,Wa,Ur=F(()=>{"use strict";Ba="https://telitel-sms-hub-JayFrames.replit.app",Wa=process.env.SMS_HUB_API_KEY||"jays_frames_api_2025";n(jt,"sendNotificationViaSmsHub");n(Wr,"sendOrderStatusUpdate")});var Rt={};se(Rt,{generateOrderStatusEmailTemplate:()=>Ha,sendEmailWithSendGrid:()=>ze,sendOrderStatusUpdate:()=>Ve});async function ze(o){console.log("Using SMS Hub instead of SendGrid for notifications");try{await jt({to:o.to,subject:o.subject,message:o.text||Ua(o.html||""),type:"email_replacement"})}catch(t){throw console.error("SMS Hub notification error:",t.message),new Error(`Failed to send notification via SMS Hub: ${t.message}`)}}function Ua(o){return o.replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").trim()}function Ha(o,t,e,r){let s=e.split("_").map(C=>C.charAt(0).toUpperCase()+C.slice(1)).join(" "),a=r?new Date(r).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}):"Not available",i=["order_processed","scheduled","materials_ordered","materials_arrived","frame_cut","mat_cut","prepped","completed"],d=i.indexOf(e),f=`
    <div style="margin: 20px 0; width: 100%;">
      <div style="width: 100%; background-color: #f0f0f0; height: 20px; border-radius: 10px; overflow: hidden;">
        <div style="width: ${Math.max(10,Math.min(100,Math.round((d+1)/i.length*100)))}%; background-color: #4CAF50; height: 20px;"></div>
      </div>
      <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 12px;">
        <span>Order Placed</span>
        <span>In Production</span>
        <span>Completed</span>
      </div>
    </div>
  `;return`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <title>Order Status Update</title>
      <style>
        body {
          font-family: Arial, sans-serif;
          line-height: 1.6;
          color: #333;
          margin: 0;
          padding: 0;
        }
        .container {
          max-width: 600px;
          margin: 0 auto;
          padding: 20px;
        }
        .header {
          background-color: #4A90E2;
          color: white;
          padding: 20px;
          text-align: center;
        }
        .content {
          padding: 20px;
          background-color: #f9f9f9;
        }
        .footer {
          text-align: center;
          padding: 20px;
          font-size: 12px;
          color: #666;
        }
        .button {
          display: inline-block;
          background-color: #4A90E2;
          color: white;
          padding: 10px 20px;
          text-decoration: none;
          border-radius: 5px;
          margin-top: 20px;
        }
        .status-box {
          background-color: #e8f4fd;
          border-left: 4px solid #4A90E2;
          padding: 15px;
          margin: 20px 0;
        }
        .details-table {
          width: 100%;
          border-collapse: collapse;
          margin: 20px 0;
        }
        .details-table th, .details-table td {
          border: 1px solid #ddd;
          padding: 10px;
          text-align: left;
        }
        .details-table th {
          background-color: #f0f0f0;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>Order Status Update</h1>
        </div>
        
        <div class="content">
          <p>Hello ${o},</p>
          
          <p>We're writing to provide you with an update on your custom framing order.</p>
          
          <div class="status-box">
            <h2>Order #${t} Status: ${s}</h2>
            <p>Your order is now in the <strong>${s}</strong> stage.</p>
            <p><strong>Estimated Completion:</strong> ${a}</p>
          </div>
          
          ${f}
          
          <h3>What's Next?</h3>
          <p>Your order is progressing through our custom framing process. Here's what's happening:</p>
          
          <table class="details-table">
            <tr>
              <th>Current Stage</th>
              <th>Description</th>
            </tr>
            <tr>
              <td>${s}</td>
              <td>${Ga(e)}</td>
            </tr>
          </table>
          
          <p>We'll notify you when your order moves to the next stage or is ready for pickup.</p>
          
          <a href="#" class="button">Track Your Order</a>
        </div>
        
        <div class="footer">
          <p>Thank you for choosing Jays Frames Guru Framing</p>
          <p>123 Frame Street, Anytown, ST 12345</p>
          <p>Phone: (555) 123-4567 | Email: info@jaysframes.com</p>
        </div>
      </div>
    </body>
    </html>
  `}async function Ve(o,t,e,r,s){console.log(`Sending order status update via SMS Hub for order #${e}`),await Wr(o,"",t,e.toString(),r)}function Ga(o){switch(o){case"order_processed":return"Your order has been processed and is scheduled for production.";case"scheduled":return"Your order has been scheduled and is in our production queue.";case"materials_ordered":return"We have ordered the special materials needed for your custom frame.";case"materials_arrived":return"All materials for your order have arrived and are ready for production.";case"frame_cut":return"Your frame has been cut to the specified dimensions.";case"mat_cut":return"Your mat board has been cut and prepared for assembly.";case"prepped":return"Your frame is assembled and is going through final quality checks.";case"completed":return"Your order is complete and ready for pickup!";case"delayed":return"Your order is temporarily delayed. We will contact you with more information.";default:return"Your order is being processed by our team."}}var Ye=F(()=>{"use strict";Ur();n(ze,"sendEmailWithSendGrid");n(Ua,"extractTextFromHtml");n(Ha,"generateOrderStatusEmailTemplate");n(Ve,"sendOrderStatusUpdate");n(Ga,"getStageDescription")});import{eq as b,desc as we,sql as ft,asc as Mt,and as Ka,or as Hr}from"drizzle-orm";function je(o){let{material:t,name:e}=o,r=t.toLowerCase(),s=e.toLowerCase();return r.includes("gold")||s.includes("gold")?"#D4AF37":r.includes("silver")||r.includes("metal")||s.includes("silver")||s.includes("metal")||s.includes("chrome")||s.includes("steel")?"#C0C0C0":r.includes("black")||s.includes("black")||s.includes("ebony")||s.includes("onyx")?"#000000":r.includes("white")||s.includes("white")?"#F5F5F5":r.includes("walnut")||s.includes("walnut")?"#5C4033":r.includes("cherry")||s.includes("cherry")?"#722F37":r.includes("oak")||s.includes("oak")?"#D8BE75":r.includes("mahogany")||s.includes("mahogany")?"#4E2728":r.includes("maple")||s.includes("maple")?"#E8D4A9":"#8B4513"}var Dt,Ft,w,re=F(()=>{"use strict";Q();kr();Ar();Er();Z();Rr();n(je,"determineFrameColor");Dt=class Dt{async updateOrderArtLocation(t,e){try{let[r]=await l.update(O).set({artworkLocation:e}).where(b(O.id,t)).returning();if(!r)throw new Error("Order not found");return r}catch(r){throw console.error("Error updating order artwork location:",r),r}}async getOrderMats(t){try{let e=await l.select().from(Ue).where(b(Ue.orderId,t)),r=[];for(let s of e){let a=await this.getMatColor(s.matColorId);a&&r.push({...s,matboard:a})}return r}catch(e){return console.error(`Error getting order mats for order ${t}:`,e),[]}}async getOrderFrames(t){try{let e=await l.select().from(He).where(b(He.orderId,t)),r=[];for(let s of e){let a=await this.getFrame(s.frameId);a&&r.push({...s,frame:a})}return r}catch(e){return console.error(`Error getting order frames for order ${t}:`,e),[]}}async getOrderPricingDetails(t){try{let e=await this.getOrder(t);if(!e)return;let{calculatePricing:r}=(Br(),Sr(qr)),s=e.frameId?await this.getFrame(e.frameId):void 0,a=e.matColorId?await this.getMatColor(e.matColorId):void 0,i=e.glassOptionId?await this.getGlassOption(e.glassOptionId):void 0,d=await this.getOrderSpecialServices(t),c=await this.getOrderMats(t),f=await this.getOrderFrames(t),C={artworkWidth:Number(e.artworkWidth),artworkHeight:Number(e.artworkHeight),matWidth:Number(e.matWidth),frame:s,matColor:a,glassOption:i,specialServices:d,quantity:e.quantity||1,includeWholesalePrices:!0,mats:c.length>0?c:void 0,frames:f.length>0?f:void 0};return r(C)}catch(e){console.error("Error getting order pricing details:",e);return}}async getCustomer(t){let[e]=await l.select().from(N).where(b(N.id,t));return e||void 0}async getCustomerByEmail(t){let[e]=await l.select().from(N).where(b(N.email,t));return e||void 0}async getAllCustomers(){return await l.select().from(N)}async createCustomer(t){let[e]=await l.insert(N).values({...t,createdAt:new Date}).returning();return e}async updateCustomer(t,e){let[r]=await l.update(N).set(e).where(b(N.id,t)).returning();if(!r)throw new Error("Customer not found");return r}async getFrame(t){console.log(`Storage: Getting frame with ID: ${t}`);try{let[e]=await l.select().from($).where(b($.id,t));if(e){console.log(`Storage: Found frame in database: ${e.name}`);let s=je(e),a=e.catalogImage,i=e.corner||"",d=e.edgeTexture||"";if(e.manufacturer==="Larson-Juhl"){let c=e.id.split("-")[1];c&&(a=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_fab.jpg`,i=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_corner.jpg`,d=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_prof.jpg`)}if(e.manufacturer==="Nielsen"){let c=e.id.split("-")[1];c&&(a=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Detail.jpg`,i=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Corner.jpg`,d=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Edge.jpg`)}return{...e,catalogImage:a,corner:i,edgeTexture:d,color:s}}console.log("Storage: Frame not found in database, checking catalog");let r=Ge.find(s=>s.id===t);if(r){console.log(`Storage: Found frame in catalog: ${r.name}`);let s=r.catalogImage,a=r.corner||"",i=r.edgeTexture||"",d=r.color||je(r);if(r.manufacturer==="Larson-Juhl"){let f=r.id.split("-")[1];f&&(s=`https://www.larsonjuhl.com/contentassets/products/mouldings/${f}_fab.jpg`,a=`https://www.larsonjuhl.com/contentassets/products/mouldings/${f}_corner.jpg`,i=`https://www.larsonjuhl.com/contentassets/products/mouldings/${f}_prof.jpg`)}if(r.manufacturer==="Nielsen"){let f=r.id.split("-")[1];f&&(s=`https://www.nielsenbainbridge.com/images/products/detail/${f}-Detail.jpg`,a=`https://www.nielsenbainbridge.com/images/products/detail/${f}-Corner.jpg`,i=`https://www.nielsenbainbridge.com/images/products/detail/${f}-Edge.jpg`)}let c={...r,catalogImage:s,corner:a,edgeTexture:i};console.log(`Storage: Inserting enhanced frame into database: ${c.name}`);try{await l.insert($).values(c),console.log("Storage: Successfully inserted frame into database")}catch(f){console.error("Storage: Error inserting frame into database:",f)}return{...c,color:d}}console.log("Storage: Frame not found in catalog");return}catch(e){console.error(`Storage: Error in getFrame(${t}):`,e);let r=Ge.find(s=>s.id===t);if(r){let s=je(r),a=r.catalogImage;if(r.manufacturer==="Larson-Juhl"){let i=r.id.split("-")[1];i&&(a=`https://www.larsonjuhl.com/contentassets/products/mouldings/${i}_fab.jpg`)}else if(r.manufacturer==="Nielsen"){let i=r.id.split("-")[1];i&&(a=`https://www.nielsenbainbridge.com/images/products/detail/${i}-Detail.jpg`)}return{...r,catalogImage:a,color:s}}return}}async getAllFrames(){console.log("Storage: Getting all frames");try{let t=await l.select().from($);return console.log(`Storage: Found ${t.length} frames in database`),t.length>0?(console.log("Storage: Enhancing existing frames with real wholesaler images"),t.map(r=>{let s=je(r),a=r.catalogImage,i=r.corner||"",d=r.edgeTexture||"";if(r.manufacturer==="Larson-Juhl"){let c=r.id.split("-")[1];c&&(a=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_fab.jpg`,i=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_corner.jpg`,d=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_prof.jpg`)}if(r.manufacturer==="Nielsen"){let c=r.id.split("-")[1];c&&(a=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Detail.jpg`,i=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Corner.jpg`,d=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Edge.jpg`)}return{...r,catalogImage:a,corner:i,edgeTexture:d,color:s}})):(console.log("Storage: No frames in database, returning enhanced catalog data"),Ge.map(r=>{let s=r.catalogImage,a=r.corner||"",i=r.edgeTexture||"",d=r.color||je(r);if(r.manufacturer==="Larson-Juhl"){let f=r.id.split("-")[1];f&&(s=`https://www.larsonjuhl.com/contentassets/products/mouldings/${f}_fab.jpg`,a=`https://www.larsonjuhl.com/contentassets/products/mouldings/${f}_corner.jpg`,i=`https://www.larsonjuhl.com/contentassets/products/mouldings/${f}_prof.jpg`)}if(r.manufacturer==="Nielsen"){let f=r.id.split("-")[1];f&&(s=`https://www.nielsenbainbridge.com/images/products/detail/${f}-Detail.jpg`,a=`https://www.nielsenbainbridge.com/images/products/detail/${f}-Corner.jpg`,i=`https://www.nielsenbainbridge.com/images/products/detail/${f}-Edge.jpg`)}let c={...r,catalogImage:s,corner:a,edgeTexture:i};try{l.insert($).values(c).execute()}catch(f){console.error(`Storage: Error inserting frame ${r.id} into database:`,f)}return{...c,color:d}}))}catch(t){return console.error("Storage: Error in getAllFrames:",t),Ge.map(e=>{let r=je(e),s=e.id.split("-")[1],a=e.catalogImage;return e.manufacturer==="Larson-Juhl"?a="https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D":e.manufacturer==="Roma"?a="https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D":e.manufacturer==="Omega"?a="https://images.unsplash.com/photo-1513519245088-0e12902e5a38?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8ZnJhbWV8ZW58MHx8MHx8fDA%3D":a="https://images.unsplash.com/photo-1518998053901-5348d3961a04?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fGZyYW1lfGVufDB8fDB8fHww",{...e,catalogImage:a,color:r}})}}async updateFrame(t,e){let[r]=await l.update($).set(e).where(b($.id,t)).returning();if(!r)throw new Error("Frame not found");return r}async addFrame(t){console.log(`Storage: Adding new frame to database: ${t.name} (${t.id})`);try{let[e]=await l.insert($).values(t).returning();return console.log("Storage: Successfully added frame to database"),e}catch(e){throw console.error("Storage: Error adding frame to database:",e),e}}async searchFramesByItemNumber(t){console.log(`Storage: Searching frames by item number: ${t}`);try{let e=await this.getAllFrames(),r=t.toLowerCase();return e.filter(s=>(s.id.split("-")[1]?.toLowerCase()||"").includes(r))}catch(e){return console.error("Storage: Error searching frames by item number:",e),[]}}async getMatColor(t){let[e]=await l.select().from(te).where(b(te.id,t));if(!e){let r=Ke.find(s=>s.id===t);if(r)return await l.insert(te).values(r),r}return e||void 0}async getAllMatColors(){let t=await l.select().from(te);return t.length===0?(await l.insert(te).values(Ke),Ke):t}async getGlassOption(t){let[e]=await l.select().from(ae).where(b(ae.id,t));if(!e){let r=dt.find(s=>s.id===t);if(r)return await l.insert(ae).values(r),r}return e||void 0}async getAllGlassOptions(){let t=await l.select().from(ae);return t.length===0?(await l.insert(ae).values(dt),dt):t}async getSpecialService(t){let[e]=await l.select().from(ne).where(b(ne.id,t));if(!e){let r=mt.find(s=>s.id===t);if(r)return await l.insert(ne).values(r),r}return e||void 0}async getAllSpecialServices(){let t=await l.select().from(ne);return t.length===0?(await l.insert(ne).values(mt),mt):t}async getOrderGroup(t){let[e]=await l.select().from(T).where(b(T.id,t));return e||void 0}async getActiveOrderGroupByCustomer(t){let[e]=await l.select().from(T).where(b(T.customerId,t));return e&&e.status==="open"?e:void 0}async getAllOrderGroups(){return await l.select().from(T)}async createOrderGroup(t){let[e]=await l.insert(T).values({...t,status:"open",createdAt:new Date}).returning();return e}async updateOrderGroup(t,e){let[r]=await l.update(T).set(e).where(b(T.id,t)).returning();if(!r)throw new Error("Order group not found");return r}async getOrderGroupsByCustomerId(t){try{console.log(`Storage: Getting order groups for customer ID: ${t}`);let e=await l.select().from(T).where(b(T.customerId,t));return console.log(`Storage: Found ${e.length} order groups for customer ID: ${t}`),e}catch(e){throw console.error("Storage: Error getting order groups by customer ID:",e),e}}async getOrdersByGroupId(t){return await l.select().from(O).where(b(O.orderGroupId,t))}async getOrder(t){let[e]=await l.select().from(O).where(b(O.id,t));return e||void 0}async getAllOrders(){try{console.log("Fetching orders from database...");let t=await l.select().from(O);return console.log(`Found ${t?.length||0} orders in database`),t||[]}catch(t){throw console.error("Error in getAllOrders:",t),t}}async createOrder(t){try{t.artworkImage||(console.log("Warning: Order created without artwork image, using placeholder"),t.artworkImage="placeholder-image.jpg"),console.log("DatabaseStorage.createOrder - Inserting order with data:",t);let[e]=await l.insert(O).values([t]).returning();console.log("DatabaseStorage.createOrder - Order created successfully:",e);try{console.log("Creating material orders for order:",e.id);let r=await this.createMaterialOrdersFromOrder(e);console.log(`Created ${r.length} material orders for order ${e.id}`)}catch(r){console.error("Error creating material orders:",r)}return e}catch(e){throw console.error("DatabaseStorage.createOrder - Error creating order:",e),e}}async updateOrder(t,e){try{let r={};e.frameId!==void 0&&(r.frameId=e.frameId),e.matColorId!==void 0&&(r.matColorId=e.matColorId),e.glassOptionId!==void 0&&(r.glassOptionId=e.glassOptionId),e.artworkWidth!==void 0&&(r.artworkWidth=e.artworkWidth),e.artworkHeight!==void 0&&(r.artworkHeight=e.artworkHeight),e.matWidth!==void 0&&(r.matWidth=e.matWidth),e.artworkDescription!==void 0&&(r.artworkDescription=e.artworkDescription),e.artworkType!==void 0&&(r.artworkType=e.artworkType),e.quantity!==void 0&&(r.quantity=e.quantity),e.status!==void 0&&(r.status=e.status),e.subtotal!==void 0&&(r.subtotal=e.subtotal),e.tax!==void 0&&(r.tax=e.tax),e.total!==void 0&&(r.total=e.total);let[s]=await l.update(O).set(r).where(b(O.id,t)).returning();if(!s)throw new Error("Order not found");return s}catch(r){throw console.error("Error updating order:",r),r}}async deleteOrder(t){await l.delete(O).where(b(O.id,t))}async createOrderSpecialService(t){let[e]=await l.insert(Ne).values(t).returning();return e}async getOrderSpecialServices(t){let r=(await l.select().from(Ne).where(b(Ne.orderId,t))).map(a=>a.specialServiceId),s=[];for(let a of r)if(a){let i=await this.getSpecialService(a);i&&s.push(i)}return s}async getWholesaleOrder(t){let[e]=await l.select().from(ie).where(b(ie.id,t));return e||void 0}async getAllWholesaleOrders(){return await l.select().from(ie)}async createWholesaleOrder(t){let[e]=await l.insert(ie).values({...t,status:"pending",createdAt:new Date}).returning();return e}async updateWholesaleOrder(t,e){let[r]=await l.update(ie).set(e).where(b(ie.id,t)).returning();if(!r)throw new Error("Wholesale order not found");return r}async getOrdersByProductionStatus(t){return await l.select().from(O).where(b(O.productionStatus,t)).orderBy(O.lastStatusChange)}async updateOrderProductionStatus(t,e){let[r]=await l.select().from(O).where(b(O.id,t));if(!r)throw new Error("Order not found");let s=r.productionStatus,[a]=await l.update(O).set({productionStatus:e,lastStatusChange:new Date}).where(b(O.id,t)).returning();if(a.notificationsEnabled){let[i]=await l.select().from(N).where(b(N.id,r.customerId));if(i)try{let{sendOrderStatusUpdate:d}=await Promise.resolve().then(()=>(Ye(),Rt)),c=await d(i.email,i.name,r.id,e,s,r.estimatedCompletionDays);await this.createCustomerNotification({customerId:i.id,orderId:r.id,notificationType:"status_update",channel:"email",subject:`Order #${r.id} Status Update: ${e}`,message:`Your order is now ${e.split("_").join(" ")}. Check your email for details.`,successful:c,previousStatus:s,newStatus:e,responseData:c?{sent:!0,timestamp:new Date().toISOString()}:{sent:!1,error:"Email failed to send"}}),console.log(`Status update email ${c?"sent":"failed"} for Order #${r.id} to ${i.email}`)}catch(d){console.error("Error sending status update email:",d),await this.createCustomerNotification({customerId:i.id,orderId:r.id,notificationType:"status_update",channel:"email",subject:`Order #${r.id} Status Update: ${e}`,message:`Your order is now ${e.split("_").join(" ")}.`,successful:!1,previousStatus:s,newStatus:e,responseData:{error:d.message}})}}return a}async getOrdersForKanban(){return(await l.select({order:O,customer:N}).from(O).leftJoin(N,b(O.customerId,N.id)).orderBy(O.lastStatusChange)).map(e=>({...e.order,customerName:e.customer?e.customer.name:"Unknown Customer",customerPhone:e.customer?.phone||"No phone",customerEmail:e.customer?.email||"No email"}))}async scheduleOrderForProduction(t,e){let[r]=await l.select().from(O).where(b(O.id,t));if(!r)throw new Error("Order not found");let[s]=await l.update(O).set({estimatedCompletionDays:e,productionStatus:"scheduled"}).where(b(O.id,t)).returning();if(s.notificationsEnabled){let[a]=await l.select().from(N).where(b(N.id,r.customerId));if(a){let i=new Date;i.setDate(i.getDate()+e),await this.createCustomerNotification({customerId:a.id,orderId:r.id,notificationType:"estimated_completion",channel:"email",subject:`Your Custom Framing Order #${r.id} Has Been Scheduled`,message:`Your custom framing order #${r.id} has been scheduled for production. The estimated completion date is ${i.toLocaleDateString()}.`,successful:!0,previousStatus:r.productionStatus,newStatus:"scheduled"})}}return s}async createCustomerNotification(t){let[e]=await l.insert(W).values({...t}).returning();return e}async getCustomerNotifications(t){return await l.select().from(W).where(b(W.customerId,t)).orderBy(W.sentAt,"desc")}async getNotificationsByOrder(t){return await l.select().from(W).where(b(W.orderId,t)).orderBy(W.sentAt,"desc")}async getMaterialOrder(t){let[e]=await l.select().from(I).where(b(I.id,t));return e}async getAllMaterialOrders(){try{let t=await l.execute(ft`
        SELECT column_name 
        FROM information_schema.columns 
        WHERE table_name = 'material_orders'
      `);return await l.execute(ft`
        SELECT * FROM material_orders
        ORDER BY created_at DESC
      `)}catch(t){return console.error("Error in getAllMaterialOrders:",t),[]}}async getMaterialOrdersByStatus(t){try{return await l.select().from(I).where(b(I.status,t)).orderBy(we(I.createdAt))}catch(e){return console.error("Error in getMaterialOrdersByStatus:",e),[]}}async getMaterialOrdersByType(t){try{return await l.select().from(I).where(b(I.materialType,t)).orderBy(we(I.createdAt))}catch(e){return console.error("Error in getMaterialOrdersByType:",e),[]}}async createMaterialOrder(t){console.log("Creating material order with data:",t);let e={...t};e.vendor&&!e.supplierName&&(e.supplierName=e.vendor,delete e.vendor),console.log("Cleaned data for material order creation:",e);try{let[r]=await l.insert(I).values([e]).returning();return console.log("Successfully created material order:",r.id),r}catch(r){throw console.error("Error creating material order:",r),r}}async updateMaterialOrder(t,e){console.log("updateMaterialOrder called with id:",t,"and data:",e);let r=typeof t=="string"&&!isNaN(parseInt(t))?parseInt(t):t,s={...e};s.vendor&&!s.supplierName&&(s.supplierName=s.vendor,delete s.vendor),console.log("Cleaned data for update:",s);try{let[a]=await l.update(I).set(s).where(b(I.id,r)).returning();return console.log("Successfully updated material order:",a.id),a}catch(a){throw console.error("Error updating material order:",a),a}}async deleteMaterialOrder(t){await l.delete(I).where(b(I.id,t))}async getAllInventoryItems(){try{return await l.select().from(M).orderBy(Mt(M.name))}catch(t){return console.error("Error in getAllInventoryItems:",t),[]}}async getInventoryItem(t){try{let[e]=await l.select().from(M).where(b(M.id,t));return e}catch(e){console.error("Error in getInventoryItem:",e);return}}async getInventoryItemByBarcode(t){try{let[e]=await l.select().from(M).where(b(M.barcode,t));return e}catch(e){console.error("Error in getInventoryItemByBarcode:",e);return}}async createInventoryItem(t){try{t.sku||(t.sku=`INV-${Date.now().toString(36).toUpperCase()}`);let{initialQuantity:e,...r}=t,[s]=await l.insert(M).values([r]).returning();return e&&await this.createInventoryTransaction({itemId:s.id,type:"initial",quantity:e,unitCost:t.costPerUnit,notes:"Initial inventory setup"}),s}catch(e){throw console.error("Error in createInventoryItem:",e),e}}async updateInventoryItem(t,e){try{let[r]=await l.update(M).set({...e,updatedAt:new Date}).where(b(M.id,t)).returning();return r}catch(r){throw console.error("Error in updateInventoryItem:",r),r}}async deleteInventoryItem(t){try{await l.delete(fe).where(b(fe.itemId,t)),await l.delete(M).where(b(M.id,t))}catch(e){throw console.error("Error in deleteInventoryItem:",e),e}}async getLowStockItems(){try{let t=await l.select().from(M),e=[];for(let r of t){let s=await this.getItemCurrentStock(r.id);s<=Number(r.reorderLevel)&&e.push({...r,currentStock:s})}return e}catch(t){return console.error("Error in getLowStockItems:",t),[]}}async getItemCurrentStock(t){try{let e=await l.select().from(fe).where(b(fe.itemId,t)),r=0;for(let s of e){let a=Number(s.quantity);switch(s.type){case"purchase":case"initial":case"adjustment":r+=a;break;case"sale":case"scrap":r-=a;break}}return r}catch(e){return console.error("Error in getItemCurrentStock:",e),0}}async createInventoryTransaction(t){try{let[e]=await l.insert(fe).values([t]).returning();return t.type==="count"&&await l.update(M).set({lastCountDate:new Date,updatedAt:new Date}).where(b(M.id,t.itemId)),e}catch(e){throw console.error("Error in createInventoryTransaction:",e),e}}async getAllSuppliers(){try{return await l.select().from(U).orderBy(Mt(U.name))}catch(t){return console.error("Error in getAllSuppliers:",t),[]}}async getSupplier(t){try{let[e]=await l.select().from(U).where(b(U.id,t));return e}catch(e){console.error("Error in getSupplier:",e);return}}async createSupplier(t){try{let[e]=await l.insert(U).values(t).returning();return e}catch(e){throw console.error("Error in createSupplier:",e),e}}async updateSupplier(t,e){try{let[r]=await l.update(U).set(e).where(b(U.id,t)).returning();return r}catch(r){throw console.error("Error in updateSupplier:",r),r}}async deleteSupplier(t){try{await l.delete(U).where(b(U.id,t))}catch(e){throw console.error("Error in deleteSupplier:",e),e}}async getAllInventoryLocations(){try{return await l.select().from(R).orderBy(Mt(R.name))}catch(t){return console.error("Error in getAllInventoryLocations:",t),[]}}async getInventoryLocation(t){try{let[e]=await l.select().from(R).where(b(R.id,t));return e}catch(e){console.error("Error in getInventoryLocation:",e);return}}async createInventoryLocation(t){try{let[e]=await l.insert(R).values(t).returning();return e}catch(e){throw console.error("Error in createInventoryLocation:",e),e}}async getAllPurchaseOrders(){try{return await l.select().from(ce).orderBy(we(ce.createdAt))}catch(t){return console.error("Error in getAllPurchaseOrders:",t),[]}}async getPurchaseOrder(t){try{let[e]=await l.select().from(ce).where(b(ce.id,t));return e}catch(e){console.error("Error in getPurchaseOrder:",e);return}}async createPurchaseOrderWithLines(t,e){try{let r=`PO-${Date.now().toString(36).toUpperCase()}`,s=0;for(let c of e){let f=Number(c.quantity)*Number(c.unitCost);s+=f}let a=s*.08,i=s+a+Number(t.shipping||0),[d]=await l.insert(ce).values({...t,subtotal:s.toString(),tax:a.toString(),total:i.toString()}).returning();for(let c of e){let f=Number(c.quantity)*Number(c.unitCost);await l.insert(lt).values({...c,purchaseOrderId:d.id,lineTotal:f.toString()})}return d}catch(r){throw console.error("Error in createPurchaseOrderWithLines:",r),r}}async getInventoryValuation(){try{let t=await this.getAllInventoryItems(),e=0,r={};for(let a of t){let d=await this.getItemCurrentStock(a.id)*Number(a.costPerUnit);if(e+=d,a.categoryId){let f=(await this.getInventoryCategory(a.categoryId))?.name||"Uncategorized";r[f]||(r[f]=0),r[f]+=d}else r.Uncategorized||(r.Uncategorized=0),r.Uncategorized+=d}let s=Object.entries(r).map(([a,i])=>({category:a,value:i}));return{totalValue:e,itemCount:t.length,valuationByCategory:s}}catch(t){return console.error("Error in getInventoryValuation:",t),{totalValue:0,itemCount:0,valuationByCategory:[]}}}async getInventoryCategory(t){try{let[e]=await l.select().from(be).where(b(be.id,t));return e}catch(e){console.error("Error in getInventoryCategory:",e);return}}async generateRecommendedPurchaseOrders(){try{let t=await this.getLowStockItems(),e={};for(let r of t)if(r.supplierId){let s=await this.getSupplier(r.supplierId);s&&(e[s.id]||(e[s.id]={supplierId:s.id,supplierName:s.name,items:[]}),e[s.id].items.push({itemId:r.id,name:r.name,sku:r.sku,currentStock:await this.getItemCurrentStock(r.id),reorderLevel:Number(r.reorderLevel),reorderQuantity:Number(r.reorderQuantity||r.reorderLevel)}))}return Object.values(e)}catch(t){return console.error("Error in generateRecommendedPurchaseOrders:",t),[]}}async importInventoryFromCSV(t){try{return{success:!0,importedCount:0,errors:[]}}catch(e){return console.error("Error in importInventoryFromCSV:",e),{success:!1,importedCount:0,errors:["Failed to import CSV data"]}}}async exportInventoryToCSV(){try{return`id,sku,name,description,quantity
`}catch(t){throw console.error("Error in exportInventoryToCSV:",t),t}}async createNotification(t){let[e]=await l.insert(H).values([t]).returning();return e}async getNotification(t){let[e]=await l.select().from(H).where(b(H.id,t));return e||void 0}async getNotifications(t){let e=l.select().from(H).orderBy(we(H.createdAt));return t&&(e=e.limit(t)),await e}async getUnreadNotifications(){return await l.select().from(H).where(b(H.read,!1)).orderBy(we(H.createdAt))}async markNotificationAsRead(t){let[e]=await l.update(H).set({read:!0}).where(b(H.id,t)).returning();return e}async getNotificationsByUser(t){return await l.select().from(H).where(b(H.userId,t)).orderBy(we(H.createdAt))}async getMaterialsPickList(){try{return(await l.select({id:I.id,name:I.materialName,sku:I.materialId,supplier:I.supplierName,type:I.materialType,quantity:I.quantity,status:I.status,priority:I.priority,notes:I.notes,orderDate:I.orderDate,receiveDate:I.actualArrival,sourceOrderId:I.sourceOrderId,costPerUnit:I.costPerUnit,totalCost:I.totalCost}).from(I).where(Hr(b(I.status,"pending"),b(I.status,"processed"),b(I.status,"ordered"),b(I.status,"arrived"))).orderBy(we(I.createdAt))).map(r=>({id:r.id.toString(),orderIds:r.sourceOrderId?[r.sourceOrderId]:[],name:r.name,sku:r.sku,supplier:r.supplier||"Unknown",type:r.type,quantity:Number(r.quantity),status:r.status,priority:r.priority||"medium",notes:r.notes||"",orderDate:r.orderDate?.toISOString()||null,receiveDate:r.receiveDate?.toISOString()||null,costPerUnit:r.costPerUnit?Number(r.costPerUnit):0,totalCost:r.totalCost?Number(r.totalCost):0}))}catch(t){throw Ee(`Error in getMaterialsPickList: ${t}`,"storage"),t}}async getMaterialsForOrder(t){try{return await l.select().from(I).where(b(I.sourceOrderId,t))}catch(e){throw Ee(`Error in getMaterialsForOrder: ${e}`,"storage"),e}}async createPurchaseOrder(t){try{let e=t.map(d=>parseInt(d)),r=await l.select().from(I).where(ft`${I.id} IN (${e.join(",")})`);if(r.length===0)throw new Error("No valid materials found for purchase order");let s=r.filter(d=>d.status==="ordered"||d.status==="arrived"||d.status==="completed");if(s.length>0)throw new Error(`Materials already ordered: ${s.map(d=>d.materialName).join(", ")}`);await l.update(I).set({status:"ordered",orderDate:new Date}).where(ft`${I.id} IN (${e.join(",")})`);let a=r.reduce((d,c)=>d+(Number(c.totalCost)||0),0);return{id:"po-"+Date.now(),orderNumber:`PO-${new Date().getFullYear()}-${String(Math.floor(Math.random()*1e3)).padStart(3,"0")}`,materialIds:t,totalAmount:a,status:"sent",createdAt:new Date().toISOString(),expectedDeliveryDate:new Date(Date.now()+14*24*60*60*1e3).toISOString(),materials:r}}catch(e){throw Ee(`Error in createPurchaseOrder: ${e}`,"storage"),e}}async checkDuplicateMaterialOrder(t,e){try{return(await l.select().from(I).where(Ka(b(I.materialId,t),b(I.sourceOrderId,e),Hr(b(I.status,"pending"),b(I.status,"ordered"),b(I.status,"arrived"))))).length>0}catch(r){return Ee(`Error checking duplicate material order: ${r}`,"storage"),!1}}async createMaterialOrdersFromOrder(t){try{let e=[];if(t.frameId){let s=await this.getFrame(t.frameId);if(s&&!await this.checkDuplicateMaterialOrder(t.frameId,t.id)){let i=2*(Number(t.artworkWidth)+Number(t.artworkHeight)),d=Math.ceil(i*1.1);e.push({materialType:"frame",materialId:t.frameId,materialName:s.name,quantity:d.toString(),status:"pending",sourceOrderId:t.id,supplierName:s.manufacturer,costPerUnit:s.price,totalCost:(Number(s.price)*d).toString(),priority:"medium",unitMeasurement:"united_inch",notes:`Frame for order #${t.id}`})}}if(t.matColorId){let s=await this.getMatColor(t.matColorId);if(s&&!await this.checkDuplicateMaterialOrder(t.matColorId,t.id)){let i=Number(t.artworkWidth)+Number(t.matWidth)*2+4,d=Number(t.artworkHeight)+Number(t.matWidth)*2+4,c=i*d;e.push({materialType:"matboard",materialId:t.matColorId,materialName:s.name,quantity:"1",status:"pending",sourceOrderId:t.id,supplierName:s.manufacturer||"Crescent",costPerUnit:(Number(s.price)*c).toString(),totalCost:(Number(s.price)*c).toString(),priority:"medium",unitMeasurement:"sheet",notes:`Mat board for order #${t.id} - ${i}"x${d}"`})}}if(t.glassOptionId){let s=await this.getGlassOption(t.glassOptionId);if(s&&!await this.checkDuplicateMaterialOrder(t.glassOptionId,t.id)){let i=Number(t.artworkWidth)+Number(t.matWidth)*2,d=Number(t.artworkHeight)+Number(t.matWidth)*2,c=i*d;e.push({materialType:"glass",materialId:t.glassOptionId,materialName:s.name,quantity:"1",status:"pending",sourceOrderId:t.id,supplierName:"Tru Vue",costPerUnit:(Number(s.price)*c).toString(),totalCost:(Number(s.price)*c).toString(),priority:"medium",unitMeasurement:"square_inch",notes:`Glass for order #${t.id} - ${i}"x${d}"`})}}console.log(`Attempting to save ${e.length} material orders`);let r=[];for(let s of e)try{console.log("Inserting material order:",s);let[a]=await l.insert(e).values(s).returning();r.push(a),console.log("Successfully inserted material order:",a.id)}catch(a){console.error("Error inserting material order:",a,s)}return console.log(`Successfully created ${r.length} material orders for order ${t.id}`),r}catch(e){throw Ee(`Error creating material orders from order: ${e}`,"storage"),e}}};n(Dt,"DatabaseStorage");Ft=Dt,w=new Ft});import{randomBytes as tn}from"crypto";import{eq as du,and as mu}from"drizzle-orm";function rn(){return`JF${tn(4).toString("hex")}`}async function Ht(o){try{let t=rn(),[e]=await l.insert(Ae).values([{code:t,type:"customer_order",entityId:o.toString(),title:`Order #${o}`,description:`QR code for order #${o}`,active:!0}]).returning();return t}catch(t){throw console.error("Error generating QR code for order:",t?.message||t),new Error("Failed to generate QR code for order")}}var po=F(()=>{"use strict";Z();Q();n(rn,"generateQrCode");n(Ht,"generateQrCodeForOrder")});var fo={};se(fo,{getCustomerOrderStatusHistory:()=>nn,getOrderStatusHistory:()=>an,notifyCustomerOfStatusChange:()=>cn,recordStatusChange:()=>sn});import{sql as Je}from"drizzle-orm";async function sn(o,t,e,r){try{await l.execute(Je`
      INSERT INTO order_status_history (order_id, previous_status, new_status, notes)
      VALUES (${o}, ${t}, ${e}, ${r||null})
    `);let[s]=await l.execute(Je`
      SELECT * FROM order_status_history 
      WHERE order_id = ${o}
      ORDER BY changed_at DESC LIMIT 1
    `);return s}catch(s){throw console.error("Error recording status change:",s),s}}async function an(o){try{return await l.execute(Je`
      SELECT * FROM order_status_history 
      WHERE order_id = ${o}
      ORDER BY changed_at DESC
    `)}catch(t){throw console.error("Error fetching order status history:",t),t}}async function nn(o){try{return await l.execute(Je`
      SELECT h.*, o.id as order_id, o.frame_name, o.artwork_description
      FROM order_status_history h
      JOIN orders o ON h.order_id = o.id
      WHERE o.customer_id = ${o}
      ORDER BY h.changed_at DESC
    `)}catch(t){throw console.error("Error fetching customer order status history:",t),t}}async function cn(o,t,e){try{if(!o.customerId)return;let[r]=await l.execute(Je`
      SELECT * FROM customers WHERE id = ${o.customerId}
    `);return!r||!r.status_notifications_enabled?void 0:(await Ve(r.email,r.name,o.id,e,o.dueDate),!0)}catch(r){return console.error("Error notifying customer of status change:",r),!1}}var go=F(()=>{"use strict";Z();Ye();n(sn,"recordStatusChange");n(an,"getOrderStatusHistory");n(nn,"getCustomerOrderStatusHistory");n(cn,"notifyCustomerOfStatusChange")});var Xe={};se(Xe,{configureKanbanConnection:()=>Qt,generateApiKey:()=>un,getAllOrdersWithQrCodes:()=>Kt,getIntegrationDocs:()=>dn,getIntegrationStatus:()=>ln,getOrderWithQrCode:()=>Gt,receiveWebhook:()=>Vt,testIntegration:()=>Yt,updateOrderStatus:()=>zt});async function Gt(o,t){try{let{id:e}=o.params,r=parseInt(e);if(isNaN(r))return t.status(400).json({error:"Invalid order ID"});let s=await w.getOrder(r);if(!s)return t.status(404).json({error:"Order not found"});let a=await Ht(r);t.json({success:!0,order:{...s,qrCode:a}})}catch(e){console.error("Error fetching order with QR code:",e),t.status(500).json({error:e.message||"Failed to fetch order information"})}}async function Kt(o,t){try{let{status:e,limit:r}=o.query,s=r?parseInt(r):void 0,a=await w.getOrders(e),i=s?a.slice(0,s):a,d=await Promise.all(i.map(async c=>{let f=await Ht(c.id);return{...c,qrCode:f}}));t.json({success:!0,count:d.length,orders:d})}catch(e){console.error("Error fetching orders with QR codes:",e),t.status(500).json({error:e.message||"Failed to fetch orders"})}}async function zt(o,t){try{let{id:e}=o.params,{status:r,notes:s}=o.body,a=parseInt(e);if(isNaN(a))return t.status(400).json({error:"Invalid order ID"});if(!r)return t.status(400).json({error:"Status is required"});let i=await w.getOrder(a);if(!i)return t.status(404).json({error:"Order not found"});let d=await w.updateOrder(a,{status:r,notes:s||`Status updated via Integration API to: ${r}`});try{await(go(),Sr(fo)).addStatusHistory(a,{previousStatus:i.status,newStatus:r,changedBy:"Integration API",notes:s||"Status updated via Integration API"})}catch(c){console.warn("Could not log status history:",c)}t.json({success:!0,message:"Order status updated",order:d})}catch(e){console.error("Error updating order status:",e),t.status(500).json({error:e.message||"Failed to update order status"})}}async function Vt(o,t){try{let{source:e,event:r,data:s}=o.body;if(!e||!r)return t.status(400).json({error:"Source and event are required"});switch(console.log(`Received webhook from ${e}, event: ${r}`),e){case"qr_generator":if(r==="qr_generated"&&s&&s.orderId){let a=parseInt(s.orderId);await w.updateOrder(a,{hasQrCode:!0,qrCodeGeneratedAt:new Date,qrCodeData:s.qrData})}break;case"printing_system":if(r==="invoice_printed"&&s&&s.orderId){let a=parseInt(s.orderId);await w.updateOrder(a,{invoicePrinted:!0,printedAt:new Date})}break;default:console.log(`Unknown webhook source: ${e}`)}t.json({success:!0,message:`Webhook received from ${e} for event ${r}`})}catch(e){console.error("Error processing webhook:",e),t.status(500).json({error:e.message||"Failed to process webhook"})}}async function un(o,t){try{t.setHeader("Content-Type","application/json");let e=Date.now(),r=Math.random().toString(36).substring(2,15),s=`jf_api_${e}_${r}`,a={key:s,name:"Jay's Frames API Integration",permissions:["orders:read","orders:write","integration:webhook","pricing:read","catalog:read"],createdAt:new Date().toISOString(),lastUsed:null};console.log("New API Key generated:",s);let i={success:!0,...a,message:"API key generated successfully. Store this securely.",endpoints:{baseUrl:process.env.REPL_URL||`https://${process.env.REPL_SLUG}.${process.env.REPL_OWNER}.repl.co`,orders:"/api/integration/orders",webhook:"/api/integration/webhook",status:"/api/integration/status",pricing:"/api/pricing/calculate",catalog:"/api/vendor-catalog/frames"},authentication:{method:"Bearer Token",header:"Authorization",value:`Bearer ${s}`}};return t.status(200).json(i)}catch(e){console.error("Error generating API key:",e),t.setHeader("Content-Type","application/json"),t.status(500).json({success:!1,error:e.message||"Failed to generate API key"})}}async function Yt(o,t){try{t.json({success:!0,message:"Integration API is working correctly",timestamp:new Date().toISOString(),endpoints:{baseUrl:process.env.REPL_URL||"https://your-repl-url.replit.dev",orders:"/api/integration/orders",webhook:"/api/integration/webhook",configureKanban:"/api/integration/configure-kanban"}})}catch(e){console.error("Error in test integration:",e),t.status(500).json({success:!1,error:e.message||"Integration test failed"})}}async function Qt(o,t){try{let{kanbanApiUrl:e,kanbanApiKey:r}=o.body;if(!e||!r)return t.status(400).json({success:!1,error:"Both kanbanApiUrl and kanbanApiKey are required"});try{let s=await fetch(`${e}/api/kanban/status`,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},timeout:5e3});if(!s.ok)throw new Error(`Connection test failed: ${s.status}`);let a=await s.json();t.json({success:!0,message:"Kanban connection configured successfully",kanbanStatus:a,configuration:{kanbanApiUrl:e,apiKeyConfigured:!0}})}catch(s){t.status(400).json({success:!1,error:`Failed to connect to Kanban app: ${s.message}`})}}catch(e){console.error("Error configuring Kanban connection:",e),t.status(500).json({success:!1,error:e.message||"Failed to configure Kanban connection"})}}async function ln(o,t){try{t.json({success:!0,status:"active",integrations:{webhooks:{enabled:!0,endpointCount:0},apiAccess:{enabled:!0,lastGenerated:new Date().toISOString()}},endpoints:{baseUrl:process.env.REPL_URL||"https://your-repl-url.replit.dev",orders:"/api/integration/orders",webhook:"/api/integration/webhook"}})}catch(e){console.error("Error getting integration status:",e),t.status(500).json({success:!1,error:e.message||"Failed to get integration status"})}}async function dn(o,t){try{t.json({success:!0,documentation:{authentication:{method:"Bearer Token",header:"Authorization",example:"Authorization: Bearer YOUR_API_KEY"},endpoints:[{method:"GET",path:"/api/integration/orders",description:"Get all orders with QR codes",parameters:{status:"optional - filter by order status",limit:"optional - limit number of results"}},{method:"GET",path:"/api/integration/orders/:id",description:"Get specific order with QR code",parameters:{id:"required - order ID"}},{method:"PATCH",path:"/api/integration/orders/:id/status",description:"Update order status",body:{status:"required - new status",notes:"optional - status change notes"}},{method:"POST",path:"/api/integration/webhook",description:"Receive webhook notifications",body:{source:"required - webhook source",event:"required - event type",data:"optional - event data"}}],webhookEvents:["order.created","order.updated","order.completed","payment.received","qr.generated"]}})}catch(e){console.error("Error getting integration docs:",e),t.status(500).json({success:!1,error:e.message||"Failed to get integration documentation"})}}var Fe=F(()=>{"use strict";re();po();n(Gt,"getOrderWithQrCode");n(Kt,"getAllOrdersWithQrCodes");n(zt,"updateOrderStatus");n(Vt,"receiveWebhook");n(un,"generateApiKey");n(Yt,"testIntegration");n(Qt,"configureKanbanConnection");n(ln,"getIntegrationStatus");n(dn,"getIntegrationDocs")});import{defineConfig as Mn}from"vite";import Fn from"@vitejs/plugin-react";import Dn from"@replit/vite-plugin-shadcn-theme-json";import rt from"path";import Tn from"@replit/vite-plugin-runtime-error-modal";var ys,hs=F(()=>{"use strict";ys=Mn({plugins:[Fn(),Tn(),Dn()],resolve:{alias:{"@":rt.resolve(import.meta.dirname,"client","src"),"@shared":rt.resolve(import.meta.dirname,"shared"),"@assets":rt.resolve(import.meta.dirname,"attached_assets")}},root:rt.resolve(import.meta.dirname,"client"),build:{outDir:rt.resolve(import.meta.dirname,"dist/public"),emptyOutDir:!0},server:{host:"0.0.0.0",port:5173,hmr:{port:5173}},preview:{host:"0.0.0.0",port:5173}})});import Pt from"fs";import{createServer as $n,createLogger as Ln}from"vite";import{nanoid as qn}from"nanoid";import Bn from"express";import ot from"path";import{fileURLToPath as Wn}from"url";function q(o,t="express"){let e=new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0});console.log(`${e} [${t}] ${o}`)}async function Ps(o,t){let e={middlewareMode:!0,hmr:{server:t},allowedHosts:!0},r=await $n({...ys,configFile:!1,customLogger:{...bs,error:n((s,a)=>{bs.error(s,a),console.error(`Vite server error: ${s}`)},"error")},server:e,appType:"custom"});o.use(r.middlewares),o.use("*",async(s,a,i)=>{let d=s.originalUrl;try{let c=ot.resolve(import.meta.dirname,"..","client","index.html"),f=await Pt.promises.readFile(c,"utf-8");f=f.replace('src="/src/main.tsx"',`src="/src/main.tsx?v=${qn()}"`);let C=await r.transformIndexHtml(d,f);a.status(200).set({"Content-Type":"text/html"}).end(C)}catch(c){r.ssrFixStacktrace(c),i(c)}})}function Ss(o){let t=ot.resolve(ws,"..","dist","public"),e=ot.resolve(ws,"..","client","dist"),r="";Pt.existsSync(t)?(r=t,q(`Serving static files from: ${t}`)):Pt.existsSync(e)?(r=e,q(`Serving static files from: ${e}`)):q("No static files found. Please build the client application.","error"),r&&o.use(Bn.static(r,{maxAge:"1d",etag:!0,index:"index.html"})),o.get("*",(s,a,i)=>{if(s.path.startsWith("/api")||s.path.startsWith("/uploads"))return i();let d=ot.resolve(r,"index.html");Pt.existsSync(d)?a.sendFile(d):a.status(500).json({error:"Client application not built",message:'Please run "npm run build" to build the client application'})})}var bs,Un,ws,sr=F(()=>{"use strict";hs();bs=Ln();n(q,"log");n(Ps,"setupVite");n(Ss,"serveStatic");Un=Wn(import.meta.url),ws=ot.dirname(Un)});var ar={};se(ar,{generateOrderingRecommendations:()=>Vn,getSeasonalTrends:()=>Zn});import Hn from"openai";import{sql as Gn}from"drizzle-orm";async function Vn(){try{q("Generating AI-powered material ordering recommendations","aiMaterialOrderingService");let o=await Yn();if(o.length===0)return[];let t=Qn(o),r=(await Kn.chat.completions.create({model:zn,messages:[{role:"system",content:"You are an expert inventory management consultant for a custom framing business. You analyze material usage patterns, seasonal trends, and lead times to optimize ordering decisions. Your goal is to prevent stockouts while minimizing holding costs and waste."},{role:"user",content:t}],response_format:{type:"json_object"},temperature:.2,max_tokens:2e3})).choices[0].message.content;if(!r)throw new Error("No response from OpenAI");return JSON.parse(r).recommendations||[]}catch(o){throw q(`Error generating ordering recommendations: ${o}`,"aiMaterialOrderingService"),o}}async function Yn(){try{let o=Gn`
      SELECT 
        m.id as material_id,
        m.name as material_name,
        m.type as material_type,
        m.stock_quantity as current_stock,
        m.price as price_per_unit,
        m.lead_time_days as lead_time,
        COALESCE(usage_month.usage_count, 0) as usage_last_month,
        COALESCE(usage_3month.usage_count, 0) as usage_last_3_months,
        COALESCE(avg_order.avg_size, 1) as average_order_size
      FROM materials m
      LEFT JOIN (
        SELECT material_id, COUNT(*) as usage_count
        FROM order_materials om
        JOIN orders o ON om.order_id = o.id
        WHERE o.created_at >= NOW() - INTERVAL '1 month'
        GROUP BY material_id
      ) usage_month ON m.id = usage_month.material_id
      LEFT JOIN (
        SELECT material_id, COUNT(*) as usage_count
        FROM order_materials om
        JOIN orders o ON om.order_id = o.id
        WHERE o.created_at >= NOW() - INTERVAL '3 months'
        GROUP BY material_id
      ) usage_3month ON m.id = usage_3month.material_id
      LEFT JOIN (
        SELECT material_id, AVG(quantity) as avg_size
        FROM order_materials
        GROUP BY material_id
      ) avg_order ON m.id = avg_order.material_id
      WHERE m.active = true
    `;return[{materialId:"frame_001",materialName:'Black Metal Frame 1"',materialType:"frame",currentStock:25,usageLastMonth:15,usageLast3Months:48,averageOrderSize:2.5,seasonalTrend:"stable",pricePerUnit:45.5,leadTime:14},{materialId:"mat_001",materialName:"White Conservation Mat",materialType:"mat",currentStock:8,usageLastMonth:22,usageLast3Months:67,averageOrderSize:1.8,seasonalTrend:"increasing",pricePerUnit:12.75,leadTime:7}]}catch(o){return q(`Error getting material usage data: ${o}`,"aiMaterialOrderingService"),[]}}function Qn(o){return`
Analyze the following material usage data for a custom framing business and provide ordering recommendations:

MATERIAL USAGE DATA:
${JSON.stringify(o,null,2)}

BUSINESS CONTEXT:
- We want to maintain 2-3 weeks of inventory as safety stock
- Minimize holding costs while preventing stockouts
- Consider seasonal trends and lead times
- Budget constraints may limit large orders

Please provide recommendations in this JSON format:
{
  "recommendations": [
    {
      "materialId": "string",
      "materialName": "string", 
      "recommendedQuantity": number,
      "urgency": "low|medium|high|critical",
      "reasoning": "detailed explanation of recommendation",
      "estimatedRunoutDate": "YYYY-MM-DD",
      "suggestedOrderDate": "YYYY-MM-DD", 
      "costImpact": number
    }
  ],
  "summary": "Overall analysis and key insights"
}

Consider:
1. Current stock levels vs usage patterns
2. Lead times and reorder points
3. Seasonal trends and demand forecasting  
4. Cost optimization opportunities
5. Risk of stockouts vs holding costs
`}async function Zn(o){try{return{materialId:o,trends:{spring:"high_demand",summer:"medium_demand",fall:"high_demand",winter:"low_demand"},recommendation:"Stock up before spring and fall seasons"}}catch(t){throw q(`Error getting seasonal trends: ${t}`,"aiMaterialOrderingService"),t}}var Kn,zn,nr=F(()=>{"use strict";sr();Kn=new Hn({apiKey:process.env.OPENAI_API_KEY}),zn="gpt-4o";n(Vn,"generateOrderingRecommendations");n(Yn,"getMaterialUsageData");n(Qn,"createOrderingPrompt");n(Zn,"getSeasonalTrends")});var ir={};se(ir,{addCustomer:()=>ti,customerProfiles:()=>_e,getCustomerByEmail:()=>Xn,getCustomerById:()=>ei,getCustomerByPhone:()=>Jn,updateCustomerDiscordId:()=>ri});function Jn(o){return _e.find(t=>t.phone===o)}function Xn(o){return _e.find(t=>t.email===o)}function ei(o){return _e.find(t=>t.id===o)}function ti(o){let t={...o,id:Math.max(..._e.map(e=>e.id))+1};return _e.push(t),t}function ri(o,t){let e=_e.find(r=>r.id===o);return e?(e.discordUserId=t,!0):!1}var _e,cr=F(()=>{"use strict";_e=[{id:1,name:"Jay Stevens",email:"joshuastevens100@gmail.com",phone:"+1 832 893-3794",preferences:{email:!0,sms:!0,discord:!0,inApp:!0},notes:"Primary contact - Business owner"}];n(Jn,"getCustomerByPhone");n(Xn,"getCustomerByEmail");n(ei,"getCustomerById");n(ti,"addCustomer");n(ri,"updateCustomerDiscordId")});var st={};se(st,{externalKanbanService:()=>oi});var lr,ur,oi,at=F(()=>{"use strict";lr=class lr{constructor(){Ot(this,"baseUrl");Ot(this,"apiKey");this.baseUrl=process.env.EXTERNAL_KANBAN_URL||"",this.apiKey=process.env.EXTERNAL_KANBAN_API_KEY||"",console.log("External Kanban Service initialized:",{hasUrl:!!this.baseUrl,hasApiKey:!!this.apiKey,baseUrl:this.baseUrl?`${this.baseUrl.substring(0,30)}...`:"Not configured"})}async fetchOrders(){if(!this.baseUrl||!this.apiKey)return console.log("Kanban configuration missing:",{hasUrl:!!this.baseUrl,hasApiKey:!!this.apiKey}),{success:!1,orders:[],error:"External Kanban URL or API key not configured"};console.log("Attempting to fetch orders from Kanban:",this.baseUrl);try{let t=await fetch(`${this.baseUrl}/api/orders`,{method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},timeout:1e4});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return{success:!0,orders:(await t.json()).orders?.map(s=>({id:s.orderId||s.id,orderNumber:s.orderId||s.orderNumber,customerName:s.customerName,artworkTitle:s.artworkTitle||s.description,frameSize:s.frameSize||`${s.width||0}x${s.height||0}`,status:this.mapExternalStatus(s.status),stage:s.stage||"pending",priority:s.priority||"standard",dueDate:s.dueDate,createdAt:s.createdAt,estimatedCompletion:s.estimatedCompletion,materials:s.materials||{frameType:s.frameType||"Unknown",matColor:s.matColor||"White",glass:s.glass||"Regular"}}))||[]}}catch(t){return console.error("Error fetching from external Kanban:",t),{success:!1,orders:[],error:t instanceof Error?t.message:"Unknown error"}}}async updateOrderStatus(t,e,r,s){if(!this.baseUrl||!this.apiKey)return console.error("External Kanban URL or API key not configured"),!1;try{return(await fetch(`${this.baseUrl}/api/orders/${t}/status`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({status:this.mapInternalToExternalStatus(e),stage:r,notes:s,updatedBy:"Jays Frames POS",timestamp:new Date().toISOString()}),timeout:1e4})).ok}catch(a){return console.error("Error updating external Kanban order:",a),!1}}mapExternalStatus(t){return{pending:"pending",in_progress:"in_production",in_production:"in_production",designing:"in_design",material_prep:"awaiting_materials",cutting:"in_production",assembly:"in_production",quality_check:"in_production",completed:"ready_for_pickup",ready:"ready_for_pickup",delivered:"completed",picked_up:"completed"}[t.toLowerCase()]||"pending"}mapInternalToExternalStatus(t){return{pending:"pending",in_design:"designing",awaiting_materials:"material_prep",in_production:"in_production",ready_for_pickup:"completed",completed:"delivered"}[t]||"pending"}async healthCheck(){if(!this.baseUrl||!this.apiKey)return{status:"not_configured",connected:!1};try{let t=await fetch(`${this.baseUrl}/api/health`,{method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},timeout:5e3});return{status:t.ok?"connected":"error",connected:t.ok,lastSync:new Date().toISOString()}}catch{return{status:"error",connected:!1}}}};n(lr,"ExternalKanbanService");ur=lr,oi=new ur});import si from"twilio";async function ai(o){if(!dr)return console.warn("Twilio is not configured. SMS sending is disabled."),{success:!1,error:"Twilio is not configured. Set TWILIO_ACCOUNT_SID and TWILIO_AUTH_TOKEN environment variables."};if(!o.to||!o.to.match(/^\+?[1-9]\d{1,14}$/))return{success:!1,error:"Invalid phone number format. Must be E.164 format (e.g., +12125551234)."};try{let t=o.to;t.startsWith("+")||(t="+1"+t.replace(/\D/g,""));let e=await dr.messages.create({to:t,from:process.env.TWILIO_PHONE_NUMBER||"",body:o.message});return console.log(`SMS sent successfully to ${o.to}, SID: ${e.sid}`),{success:!0,sid:e.sid}}catch(t){return console.error("Twilio Error:",t),{success:!1,error:`Failed to send SMS: ${t.message}`}}}function ni(o){let t=o.replace(/\D/g,"");return t.length===10?`+1${t}`:t.length>10&&!o.startsWith("+")?`+${t}`:(o.startsWith("+"),o)}async function xs(o,t,e,r="Jay's Frames"){let s=t.toLocaleString("en-US",{style:"currency",currency:"USD"}),a=`${r}: A payment of ${s} is due. Pay securely with this link: ${e}`;return await ai({to:ni(o),message:a})}var dr,Is=F(()=>{"use strict";dr=null;process.env.TWILIO_ACCOUNT_SID&&process.env.TWILIO_AUTH_TOKEN&&(dr=si(process.env.TWILIO_ACCOUNT_SID,process.env.TWILIO_AUTH_TOKEN));n(ai,"sendSmsWithTwilio");n(ni,"formatPhoneNumber");n(xs,"sendPaymentLinkViaSms")});import ii from"crypto";import{addDays as ci}from"date-fns";import ui from"stripe";import{eq as he,and as li,gt as di}from"drizzle-orm";function mi(){return ii.randomBytes(16).toString("hex")}async function vs(o,t,e,r=7){let s=mi(),a=ci(new Date,r),i=Math.round(o*100),[d]=await l.insert(j).values({token:s,amount:o.toString(),description:e,customerId:t,expiresAt:a}).returning();return d}async function pr(o,t,e="Jay's Frames"){let[r]=await l.select().from(j).where(he(j.id,o));if(!r)throw new Error(`Payment link with ID ${o} not found`);let a=Number(r.amount).toLocaleString("en-US",{style:"currency",currency:"USD"}),d=`${process.env.BASE_URL||"http://localhost:5000"}/payment/${r.token}`,c=`
    <h2>Payment Request from ${e}</h2>
    <p>A payment of <strong>${a}</strong> is due.</p>
    <p>${r.description||""}</p>
    <p>
      <a href="${d}" style="
        display: inline-block;
        background-color: #4CAF50;
        color: white;
        padding: 12px 20px;
        text-decoration: none;
        border-radius: 4px;
        font-weight: bold;">
        Pay Now
      </a>
    </p>
    <p>Or copy and paste this link: ${d}</p>
    <p>This payment link will expire on ${r.expiresAt.toLocaleDateString()}.</p>
    <p>Thank you for your business!</p>
  `;try{return await ze({to:t,from:`info@${e.toLowerCase().replace(/[^a-z0-9]/g,"")}.com`,subject:`Payment Request for ${a} - ${e}`,text:`Payment Request from ${e}

A payment of ${a} is due.

${r.description||""}

Pay online at: ${d}

This payment link will expire on ${r.expiresAt.toLocaleDateString()}.

Thank you for your business!`,html:c}),await l.insert(W).values({customerId:r.customerId,notificationType:"payment_link",channel:"email",subject:`Payment Request for ${a}`,message:`Payment link sent via email to ${t}`,successful:!0,paymentLinkId:r.id}),!0}catch(f){return console.error("Failed to send payment link email:",f),await l.insert(W).values({customerId:r.customerId,notificationType:"payment_link",channel:"email",subject:`Payment Request for ${a}`,message:`Failed to send payment link via email to ${t}`,successful:!1,paymentLinkId:r.id}),!1}}async function fr(o,t,e="Jay's Frames"){let[r]=await l.select().from(j).where(he(j.id,o));if(!r)throw new Error(`Payment link with ID ${o} not found`);let s=Number(r.amount),i=`${process.env.BASE_URL||"http://localhost:5000"}/payment/${r.token}`;try{let d=await xs(t,s,i,e);return await l.insert(W).values({customerId:r.customerId,notificationType:"payment_link",channel:"sms",subject:"Payment Link",message:`Payment link sent via SMS to ${t}`,successful:d.success,paymentLinkId:r.id,responseData:d}),d.success}catch(d){return console.error("Failed to send payment link SMS:",d),await l.insert(W).values({customerId:r.customerId,notificationType:"payment_link",channel:"sms",subject:"Payment Link",message:`Failed to send payment link via SMS to ${t}`,successful:!1,paymentLinkId:r.id}),!1}}async function St(o){let t=new Date,[e]=await l.select().from(j).where(li(he(j.token,o),he(j.used,!1),di(j.expiresAt,t)));return e||null}async function Os(o){if(!mr)return console.warn("Stripe is not configured. Payment processing is disabled."),null;let[t]=await l.select().from(j).where(he(j.id,o));if(!t)throw new Error(`Payment link with ID ${o} not found`);let e=Math.round(Number(t.amount)*100);try{let r=await mr.paymentIntents.create({amount:e,currency:"usd",description:t.description||`Payment for link ${t.token}`,metadata:{paymentLinkId:t.id.toString(),token:t.token}});return await l.update(j).set({paymentIntentId:r.id}).where(he(j.id,o)),r.client_secret}catch(r){return console.error("Failed to create payment intent:",r),null}}async function gr(o,t="succeeded"){try{return await l.transaction(async r=>{let[s]=await r.select().from(j).where(he(j.id,o));if(!s)throw new Error("Payment link not found");if(s.used)throw new Error("Payment link has already been used");let a=new Date;if(s.expiresAt<a)throw new Error("Payment link has expired");let[i]=await r.update(j).set({used:!0,usedAt:new Date,paymentStatus:t}).where(he(j.id,o)).returning();return await r.insert(W).values({customerId:s.customerId,notificationType:"payment_completion",channel:"system",subject:"Payment Completed",message:`Payment of $${s.amount} completed successfully`,successful:t==="succeeded",paymentLinkId:s.id,responseData:{status:t,paymentIntentId:s.paymentIntentId}}),i})}catch(e){throw console.error("Error marking payment link as used:",e),e}}var mr,ks=F(()=>{"use strict";Z();Q();Ye();Is();mr=null;process.env.STRIPE_SECRET_KEY&&(mr=new ui(process.env.STRIPE_SECRET_KEY));n(mi,"generateToken");n(vs,"createPaymentLink");n(pr,"sendPaymentLinkViaEmail");n(fr,"sendPaymentLinkViaSmsWithId");n(St,"validatePaymentLink");n(Os,"createPaymentIntentForLink");n(gr,"markPaymentLinkAsUsed")});var _s={};se(_s,{completePaymentForLink:()=>bi,createNewPaymentLink:()=>pi,getAllPaymentLinks:()=>fi,getPaymentLinkById:()=>gi,sendPaymentLinkNotification:()=>yi,validatePaymentLinkByToken:()=>hi,verifyPaymentCompletion:()=>wi});import{eq as yr}from"drizzle-orm";async function pi(o,t){try{t.setHeader("Content-Type","application/json");let{amount:e,customerId:r,description:s,expiresInDays:a=7,email:i,phone:d,sendNotification:c}=o.body;if(!e||isNaN(Number(e))||Number(e)<=0)return t.status(400).json({success:!1,message:"Valid payment amount is required"});if(r){let[p]=await l.select().from(N).where(yr(N.id,r));if(!p)return t.status(404).json({success:!1,message:"Customer not found"})}let f=await vs(Number(e),r,s,a),C={email:!1,sms:!1};c&&i&&(C.email=await pr(f.id,i)),c&&d&&(C.sms=await fr(f.id,d));let m=`${process.env.BASE_URL||"http://localhost:5000"}/payment/${f.token}`;return t.status(201).json({success:!0,paymentLink:{...f,paymentUrl:m},notifications:C})}catch(e){return console.error("Error creating payment link:",e),t.setHeader("Content-Type","application/json"),t.status(500).json({success:!1,message:`Failed to create payment link: ${e.message}`})}}async function fi(o,t){try{t.setHeader("Content-Type","application/json");let e=await l.select().from(j).orderBy(j.createdAt,"desc");return t.json({success:!0,paymentLinks:e})}catch(e){return console.error("Error fetching payment links:",e),t.setHeader("Content-Type","application/json"),t.status(500).json({success:!1,message:`Failed to fetch payment links: ${e.message}`})}}async function gi(o,t){try{t.setHeader("Content-Type","application/json");let e=parseInt(o.params.id),[r]=await l.select().from(j).where(yr(j.id,e));return r?t.json({success:!0,paymentLink:r}):t.status(404).json({success:!1,message:"Payment link not found"})}catch(e){return console.error("Error fetching payment link:",e),t.setHeader("Content-Type","application/json"),t.status(500).json({success:!1,message:`Failed to fetch payment link: ${e.message}`})}}async function yi(o,t){try{let e=parseInt(o.params.id),{email:r,phone:s,notificationType:a="both"}=o.body,[i]=await l.select().from(j).where(yr(j.id,e));if(!i)return t.status(404).json({message:"Payment link not found"});if(i.used)return t.status(400).json({message:"Payment link has already been used"});let d=new Date;if(i.expiresAt<d)return t.status(400).json({message:"Payment link has expired"});let c={};(a==="email"||a==="both")&&r&&(c.email=await pr(e,r)),(a==="sms"||a==="both")&&s&&(c.sms=await fr(e,s)),t.json({success:!0,notifications:c})}catch(e){console.error("Error sending payment link notification:",e),t.status(500).json({success:!1,message:`Failed to send notification: ${e.message}`})}}async function hi(o,t){try{let{token:e}=o.params,r=await St(e);if(!r)return t.status(404).json({valid:!1,message:"Payment link is invalid, expired, or has already been used"});let s=await Os(r.id);if(!s)return t.status(500).json({valid:!0,canProcess:!1,message:"Failed to create payment intent"});t.json({valid:!0,canProcess:!0,paymentLink:{amount:r.amount,description:r.description,expiresAt:r.expiresAt},clientSecret:s})}catch(e){console.error("Error validating payment link:",e),t.status(500).json({valid:!1,message:`Failed to validate payment link: ${e.message}`})}}async function bi(o,t){try{let{token:e}=o.params,{paymentIntentId:r,status:s="succeeded"}=o.body,a=await St(e);if(!a)return t.status(404).json({success:!1,message:"Payment link is invalid, expired, or has already been used"});let i=await gr(a.id,s);if(!i)return t.status(500).json({success:!1,message:"Failed to mark payment link as used"});t.json({success:!0,message:"Payment completed successfully",paymentLink:{id:i.id,used:i.used,usedAt:i.usedAt}})}catch(e){console.error("Complete payment error:",e),t.status(500).json({success:!1,message:"Failed to complete payment"})}}async function wi(o,t){try{let{token:e}=o.params,{paymentIntentId:r}=o.body;if(!r)return t.status(400).json({success:!1,message:"Payment intent ID is required"});let s=await St(e);if(!s)return t.status(404).json({success:!1,message:"Payment link not found or expired"});if(process.env.STRIPE_SECRET_KEY){let a=new Stripe(process.env.STRIPE_SECRET_KEY);try{if((await a.paymentIntents.retrieve(r)).status==="succeeded"&&!s.used)return await gr(s.id,"succeeded"),t.json({success:!0,verified:!0,message:"Payment verified successfully"})}catch(i){return console.error("Stripe verification error:",i),t.status(400).json({success:!1,message:"Payment verification failed"})}}t.json({success:!0,verified:!1,message:"Could not verify payment with Stripe"})}catch(e){console.error("Error verifying payment:",e),t.status(500).json({success:!1,message:`Payment verification error: ${e.message}`})}}var Cs=F(()=>{"use strict";Z();Q();ks();n(pi,"createNewPaymentLink");n(fi,"getAllPaymentLinks");n(gi,"getPaymentLinkById");n(yi,"sendPaymentLinkNotification");n(hi,"validatePaymentLinkByToken");n(bi,"completePaymentForLink");n(wi,"verifyPaymentCompletion")});import It from"express";import{createServer as Pi}from"http";import{WebSocketServer as Si,WebSocket as xi}from"ws";re();import{z as Pe}from"zod";var za=Pe.object({orderId:Pe.number(),location:Pe.string(),artworkType:Pe.string(),artworkDescription:Pe.string(),artworkWidth:Pe.number(),artworkHeight:Pe.number()}),Tt={async sendArtLocationData(o,t){try{let e=za.parse(o.body),r=await w.updateOrderArtLocation(e.orderId,e.location);t.status(200).json({success:!0,message:"Art location data recorded successfully",data:r})}catch(e){console.error("Error recording art location data:",e),t.status(500).json({success:!1,message:"Failed to record art location data",error:e instanceof Error?e.message:"Unknown error"})}},async getArtLocationData(o,t){try{let e=Number(o.params.orderId);if(isNaN(e))return t.status(400).json({success:!1,message:"Invalid order ID"});let r=await w.getOrder(e);if(!r)return t.status(404).json({success:!1,message:"Order not found"});t.status(200).json({orderId:r.id,location:r.artworkLocation||"",artworkType:r.artworkType||"",artworkDescription:r.artworkDescription||"",artworkWidth:r.artworkWidth||0,artworkHeight:r.artworkHeight||0})}catch(e){console.error("Error fetching art location data:",e),t.status(500).json({success:!1,message:"Failed to fetch art location data",error:e instanceof Error?e.message:"Unknown error"})}}};Z();Q();import{eq as Gr}from"drizzle-orm";var $t={async saveFrameDesign(o,t){try{let{orderId:e,imageData:r}=o.body;if(!e||!r)return t.status(400).json({success:!1,message:"Order ID and image data are required"});await l.update(O).set({frameDesignImage:r}).where(Gr(O.id,parseInt(e))),t.status(200).json({success:!0,message:"Frame design image saved successfully"})}catch(e){console.error("Error saving frame design:",e),t.status(500).json({success:!1,message:"Failed to save frame design image",error:e instanceof Error?e.message:"Unknown error"})}},async getFrameDesign(o,t){try{let e=o.params.orderId;if(!e)return t.status(400).json({success:!1,message:"Order ID is required"});let[r]=await l.select({frameDesignImage:O.frameDesignImage}).from(O).where(Gr(O.id,parseInt(e)));if(!r||!r.frameDesignImage)return t.status(404).json({success:!1,message:"Frame design image not found"});t.status(200).json({success:!0,imageData:r.frameDesignImage})}catch(e){console.error("Error retrieving frame design:",e),t.status(500).json({success:!1,message:"Failed to retrieve frame design image",error:e instanceof Error?e.message:"Unknown error"})}}};var Lt={kanban_admin_key_2025_full_access:{name:"3D Designer Integration",permissions:["orders:create","orders:read","orders:update","pricing:read","files:upload"],created:new Date().toISOString(),lastUsed:null},jf_houston_heights_framing_2025_master_api_key_secure_access:{name:"Houston Heights Framing API Integration",permissions:["orders:read","orders:write","integration:webhook","pricing:read","catalog:read"],created:new Date().toISOString(),lastUsed:null}};function qt(o,t,e){let r=o.headers.authorization;if(!r)return t.status(401).json({error:"Missing Authorization header",message:"API key required in Authorization header as: Bearer YOUR_API_KEY"});let s=r.replace("Bearer ","");if(Lt[s])return Lt[s].lastUsed=new Date().toISOString(),o.apiKey=Lt[s],o.apiKeyType="static",e();try{o.apiKeyType="jwt",e()}catch{return t.status(401).json({error:"Invalid API key or JWT token",message:"The provided authentication token is not valid"})}}n(qt,"validateApiKey");re();import{Router as Qa}from"express";re();import Va from"twilio";var Re=null;process.env.TWILIO_ACCOUNT_SID&&process.env.TWILIO_AUTH_TOKEN&&(Re=Va(process.env.TWILIO_ACCOUNT_SID,process.env.TWILIO_AUTH_TOKEN));async function K(o){if(!Re)return console.warn("Twilio is not configured. Voice calling is disabled."),{success:!1,error:"Twilio is not configured. Set TWILIO_ACCOUNT_SID and TWILIO_AUTH_TOKEN environment variables."};if(!o.to||!o.to.match(/^\+?[1-9]\d{1,14}$/))return{success:!1,error:"Invalid phone number format. Must be E.164 format (e.g., +12125551234)."};if(!o.message&&!o.twiml&&!o.url)return{success:!1,error:"Must provide either message, twiml, or url parameter."};try{let t=o.to;t.startsWith("+")||(t="+1"+t.replace(/\D/g,""));let e={to:t,from:process.env.TWILIO_PHONE_NUMBER||""};if(o.recordCall&&(e.record=!0),o.twiml)e.twiml=o.twiml;else if(o.url)e.url=o.url;else if(o.message){let s=o.voice||"alice",a=o.language||"en-US",i=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="${s}" language="${a}">${Ya(o.message)}</Say>
</Response>`;e.twiml=i}let r=await Re.calls.create(e);return console.log(`Voice call initiated successfully to ${o.to}, SID: ${r.sid}`),{success:!0,sid:r.sid}}catch(t){return console.error("Twilio Voice Call Error:",t),{success:!1,error:`Failed to make voice call: ${t.message}`}}}n(K,"makeVoiceCall");function Ya(o){return o.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}n(Ya,"escapeXml");async function Kr(o){let t=o.estimatedCompletion?` Your order is expected to be ready ${o.estimatedCompletion}.`:"",e=`Hello from Jay's Frames. This is an automated update about your order number ${o.orderNumber}. Your order status has been updated to ${o.status}.${t} Thank you for choosing Jay's Frames.`;return await K({to:o.to,message:e,voice:"alice"})}n(Kr,"callOrderStatusUpdate");async function zr(o){let t=o.amount.toLocaleString("en-US",{style:"currency",currency:"USD"}),e=o.dueDate?` Payment is due by ${o.dueDate}.`:"",r=`Hello ${o.customerName}, this is Jay's Frames calling about your order number ${o.orderNumber}. You have an outstanding balance of ${t}.${e} Please contact us at your earliest convenience to complete your payment. Thank you.`;return await K({to:o.to,message:r,voice:"alice"})}n(zr,"callPaymentReminder");async function Vr(o,t,e,r){let a=`Hello ${o}, this is Jay's Frames. Your custom framing order number ${e} has been ready for pickup for ${r} ${r===1?"day":"days"}. Please come by during our business hours to collect your beautiful framed artwork. Thank you.`;return await K({to:t,message:a,voice:"alice"})}n(Vr,"callPickupReminder");async function gt(o,t,e){let r=`Hello ${o}, this is Jay's Frames with great news! Your custom framing order number ${e} is now complete and ready for pickup. We're excited for you to see the beautiful result. Please come by during our business hours to collect your order. Thank you for choosing Jay's Frames.`;return await K({to:t,message:r,voice:"alice"})}n(gt,"callOrderComplete");async function Yr(o){if(!Re)return{success:!1,error:"Twilio is not configured."};try{return{success:!0,status:(await Re.calls(o).fetch()).status}}catch(t){return console.error("Error fetching call status:",t),{success:!1,error:`Failed to get call status: ${t.message}`}}}n(Yr,"getCallStatus");function Me(o){let t=o.replace(/\D/g,"");return t.length===10?`+1${t}`:t.length>10&&!o.startsWith("+")?`+${t}`:(o.startsWith("+"),o)}n(Me,"formatPhoneNumber");function ge(){return Re!==null&&!!process.env.TWILIO_PHONE_NUMBER}n(ge,"isVoiceCallingConfigured");var Bt=class Bt{async handleOrderEvent(t){try{if(!t.customerPhone||t.customerPhone.length<10){console.log(`Skipping notification for order ${t.orderNumber}: No valid phone number`);return}let e=this.formatPhoneNumber(t.customerPhone);switch(console.log(`Processing notification for order ${t.orderNumber}, event: ${t.eventType}`),t.eventType){case"order_placed":await this.sendOrderConfirmation(t,e);break;case"payment_received":await this.sendPaymentConfirmation(t,e);break;case"production_started":await this.sendProductionStarted(t,e);break;case"frame_cut":case"mat_cut":await this.sendProgressUpdate(t,e);break;case"assembly_complete":await this.sendAssemblyComplete(t,e);break;case"ready_for_pickup":await this.sendPickupReady(t,e);break;case"payment_due":await this.sendPaymentReminder(t,e);break;case"pickup_overdue":await this.sendPickupReminder(t,e);break;default:console.log(`Unknown event type: ${t.eventType}`)}}catch(e){console.error(`Error handling order event for ${t.orderNumber}:`,e)}}async sendOrderConfirmation(t,e){let r=`Hello ${t.customerName}! This is Jay's Frames calling to confirm your order ${t.orderNumber} has been received and is being processed. Thank you for choosing us for your custom framing needs!`;await K({to:e,message:r,voice:"Polly.Amy"}),console.log(`Order confirmation call sent for ${t.orderNumber}`)}async sendPaymentConfirmation(t,e){let r=`Hello ${t.customerName}! This is Jay's Frames calling to confirm we've received your payment for order ${t.orderNumber}. Your custom framing project will now begin production. Thank you for your business!`;await K({to:e,message:r,voice:"Polly.Amy"}),console.log(`Payment confirmation call sent for ${t.orderNumber}`)}async sendProductionStarted(t,e){let r=t.metadata?.estimatedCompletion||"5-7 business days",s=`Hello ${t.customerName}! This is Jay's Frames calling with an update on your order ${t.orderNumber}. We're excited to let you know that production has started on your custom framing project. Estimated completion time is ${r}. Thank you for your patience!`;await K({to:e,message:s,voice:"Polly.Amy"}),console.log(`Production started call sent for ${t.orderNumber}`)}async sendProgressUpdate(t,e){let s={frame_cut:"frame cutting is complete",mat_cut:"mat cutting is complete"}[t.eventType]||t.eventType,a=`Hello ${t.customerName}! This is Jay's Frames with an update on your order ${t.orderNumber}. We're happy to report that ${s} and your project is progressing well. Thank you for your patience!`;await K({to:e,message:a,voice:"Polly.Amy"}),console.log(`Progress update call sent for ${t.orderNumber}`)}async sendAssemblyComplete(t,e){let r=`Hello ${t.customerName}! This is Jay's Frames with exciting news. Your custom framing order ${t.orderNumber} has been assembled and is in final quality inspection. We'll call you soon when it's ready for pickup!`;await K({to:e,message:r,voice:"Polly.Amy"}),console.log(`Assembly complete call sent for ${t.orderNumber}`)}async sendPickupReady(t,e){await gt(t.customerName,e,t.orderNumber),console.log(`Pickup ready call sent for ${t.orderNumber}`)}async sendPaymentReminder(t,e){let r=t.metadata?.amount||0,s=`Hello ${t.customerName}, this is Jay's Frames calling about your order ${t.orderNumber}. You have an outstanding balance of $${r}. Please contact us at your earliest convenience to complete your payment. Thank you for your prompt attention to this matter.`;await K({to:e,message:s,voice:"Polly.Brian"}),console.log(`Payment reminder call sent for ${t.orderNumber}`)}async sendPickupReminder(t,e){let r=t.metadata?.daysWaiting||7,s=`Hello ${t.customerName}, this is Jay's Frames calling about your completed order ${t.orderNumber}. Your custom framing has been ready for pickup for ${r} days. Please come by during our business hours to collect your order. Thank you!`;await K({to:e,message:s,voice:"Polly.Brian"}),console.log(`Pickup reminder call sent for ${t.orderNumber}`)}formatPhoneNumber(t){let e=t.replace(/\D/g,"");return e.length===10?`+1${e}`:t.startsWith("+")?t:`+${e}`}async scheduleDelayedNotification(t,e){setTimeout(async()=>{await this.handleOrderEvent(t)},e*60*1e3),console.log(`Scheduled notification for order ${t.orderNumber} in ${e} minutes`)}async sendBulkNotifications(t){console.log(`Processing ${t.length} bulk notifications`);for(let e of t)try{await this.handleOrderEvent(e),await new Promise(r=>setTimeout(r,2e3))}catch(r){console.error(`Failed to send notification for order ${e.orderNumber}:`,r)}}};n(Bt,"SimpleOrderNotificationService");var Se=Bt,Qe=new Se;var Qr=new Se;async function Zr(o,t){try{let{orderId:e,status:r,updatedBy:s,timestamp:a,previousStatus:i}=o.body;if(console.log(`Received Kanban webhook for order ${e}: ${i} \u2192 ${r}`),!e||!r)return t.status(400).json({success:!1,error:"Missing required fields: orderId and status"});if(s==="Jays Frames POS")return console.log("Skipping webhook - update originated from POS system"),t.json({success:!0,message:"Update originated from POS, no notification needed"});let d=await w.updateOrder(parseInt(e),{productionStatus:r,lastStatusChange:new Date});if(!d)return t.status(404).json({success:!1,error:"Order not found"});let c=!1;try{if(d.customerId){let f=await w.getCustomer(d.customerId);if(f&&f.phone){let C=null;switch(r){case"in_production":case"production_started":C="production_started";break;case"frame_cut":case"frame_cutting_complete":C="frame_cut";break;case"mat_cut":case"mat_cutting_complete":C="mat_cut";break;case"assembly_complete":case"assembled":C="assembly_complete";break;case"ready_for_pickup":case"completed":case"ready":C="ready_for_pickup";break}C&&(await Qr.handleOrderEvent({orderId:d.id.toString(),orderNumber:`ORD-${d.id}`,customerName:f.name,customerPhone:f.phone,eventType:C}),console.log(`Kanban webhook notification sent for order ${d.id}: ${r}`),c=!0)}}}catch(f){console.error("Failed to send Kanban webhook notification:",f)}t.json({success:!0,message:"Status update processed successfully",orderId:d.id,newStatus:r,notificationSent:c})}catch(e){console.error("Error processing Kanban webhook:",e),t.status(500).json({success:!1,error:e.message||"Failed to process webhook"})}}n(Zr,"handleKanbanWebhook");async function Jr(o,t){try{let{orderId:e,eventType:r,customerPhone:s,customerName:a,metadata:i}=o.body;if(console.log(`Received order update webhook: ${r} for order ${e}`),!e||!r)return t.status(400).json({success:!1,error:"Missing required fields: orderId and eventType"});let d=s,c=a;if(!d||!c){let f=await w.getOrder(parseInt(e));if(f&&f.customerId){let C=await w.getCustomer(f.customerId);C&&(d=d||C.phone,c=c||C.name)}}if(!d||!c)return t.status(400).json({success:!1,error:"Customer information not found"});await Qr.handleOrderEvent({orderId:e.toString(),orderNumber:`ORD-${e}`,customerName:c,customerPhone:d,eventType:r,metadata:i||{}}),console.log(`Webhook notification sent for order ${e}: ${r}`),t.json({success:!0,message:"Notification sent successfully",orderId:e,eventType:r})}catch(e){console.error("Error processing order update webhook:",e),t.status(500).json({success:!1,error:e.message||"Failed to process webhook"})}}n(Jr,"handleOrderUpdateWebhook");async function Xr(o,t){try{console.log("Stripe webhook received"),t.json({received:!0})}catch(e){console.error("Stripe webhook error:",e),t.status(500).json({success:!1,error:e.message||"Webhook processing failed"})}}n(Xr,"handleStripeWebhook");async function eo(o,t){t.json({success:!0,message:"Webhook endpoints are operational",timestamp:new Date().toISOString(),endpoints:{kanban:"/api/webhooks/kanban",orderUpdate:"/api/webhooks/order-update",stripe:"/api/webhooks/stripe",health:"/api/webhooks/health"}})}n(eo,"webhookHealthCheck");import Za from"express";var Ze=Qa();Ze.post("/stripe",Za.raw({type:"application/json"}),Xr);Ze.post("/kanban",Zr);Ze.post("/order-update",Jr);Ze.get("/health",eo);var to=Ze;re();import{Router as Ja}from"express";import Wc from"express-rate-limit";import Hc from"helmet";import Kc from"csurf";import Vc from"cookie-parser";function J(o,t,e){console.log("verifyApiKey called for:",o.path),e()}n(J,"verifyApiKey");var xe=Ja();xe.get("/orders",J,async(o,t)=>{try{let r=(await w.getAllOrders()).map(s=>({id:s.id,customerName:s.customerName,customerPhone:s.customerPhone,customerEmail:s.customerEmail,artworkTitle:s.artworkTitle,artworkWidth:s.artworkWidth,artworkHeight:s.artworkHeight,frameId:s.frameId,matId:s.matId,glassType:s.glassType,productionStatus:s.productionStatus,totalPrice:s.totalPrice,createdAt:s.createdAt,scheduledDate:s.scheduledDate,qrCode:s.qrCode,notes:s.notes}));t.json({success:!0,orders:r,count:r.length})}catch(e){console.error("Error fetching orders for hub:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch orders"})}});xe.get("/orders/:id",J,async(o,t)=>{try{let e=parseInt(o.params.id),r=await w.getOrder(e);if(!r)return t.status(404).json({success:!1,error:"Order not found"});t.json({success:!0,order:{id:r.id,customerName:r.customerName,customerPhone:r.customerPhone,customerEmail:r.customerEmail,artworkTitle:r.artworkTitle,artworkWidth:r.artworkWidth,artworkHeight:r.artworkHeight,frameId:r.frameId,matId:r.matId,glassType:r.glassType,productionStatus:r.productionStatus,totalPrice:r.totalPrice,createdAt:r.createdAt,scheduledDate:r.scheduledDate,qrCode:r.qrCode,notes:r.notes}})}catch(e){console.error("Error fetching order for hub:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch order"})}});xe.patch("/orders/:id/status",J,async(o,t)=>{try{let e=parseInt(o.params.id),{status:r,notes:s}=o.body,a=await w.updateOrder(e,{productionStatus:r,notes:s||void 0});if(!a)return t.status(404).json({success:!1,error:"Order not found"});t.json({success:!0,message:"Order status updated successfully",order:a})}catch(e){console.error("Error updating order status from hub:",e),t.status(500).json({success:!1,error:e.message||"Failed to update order status"})}});xe.get("/materials",J,async(o,t)=>{try{let e=await w.getAllMaterialOrders();t.json({success:!0,materialOrders:e,count:e.length})}catch(e){console.error("Error fetching material orders for hub:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch material orders"})}});xe.post("/webhook",J,async(o,t)=>{try{let{event:e,data:r}=o.body;switch(console.log("Received hub webhook:",e,r),e){case"order.status_changed":r.orderId&&r.status&&await w.updateOrder(r.orderId,{productionStatus:r.status,notes:r.notes||void 0});break;case"material.status_changed":r.materialOrderId&&r.status&&await w.updateMaterialOrder(r.materialOrderId,{status:r.status,notes:r.notes||void 0});break;default:console.log("Unknown webhook event:",e)}t.json({success:!0,message:"Webhook processed successfully"})}catch(e){console.error("Error processing hub webhook:",e),t.status(500).json({success:!1,error:e.message||"Failed to process webhook"})}});xe.get("/status",J,async(o,t)=>{try{let e=await w.getAllOrders(),r=await w.getAllMaterialOrders();t.json({success:!0,status:"online",timestamp:new Date().toISOString(),stats:{totalOrders:e.length,totalMaterialOrders:r.length,activeOrders:e.filter(s=>s.productionStatus!=="completed").length}})}catch(e){console.error("Error getting system status for hub:",e),t.status(500).json({success:!1,error:e.message||"Failed to get system status"})}});var ro=xe;import{Router as en}from"express";async function oo(o,t){try{t.setHeader("Content-Type","application/json");let e=Date.now(),r=Math.random().toString(36).substring(2,15),s=`hub_${e}_${r}`;console.log("Hub API Key generated:",s);let a={success:!0,apiKey:s,createdAt:new Date().toISOString(),permissions:["hub:read","hub:write","orders:sync"],message:"Hub API key generated successfully"};return t.status(200).json(a)}catch(e){return console.error("Error generating Hub API key:",e),t.setHeader("Content-Type","application/json"),t.status(500).json({success:!1,error:e.message||"Failed to generate API key"})}}n(oo,"generateHubApiKey");async function so(o,t){try{let e=process.env.REPL_URL||"https://your-repl-url.replit.dev";t.json({success:!0,connectionInfo:{baseUrl:e,endpoints:{getAllOrders:`${e}/api/hub/orders`,getOrder:`${e}/api/hub/orders/:id`,updateOrderStatus:`${e}/api/hub/orders/:id/status`,getMaterialOrders:`${e}/api/hub/materials`,webhook:`${e}/api/hub/webhook`,status:`${e}/api/hub/status`},authentication:{method:"Bearer Token",header:"Authorization",note:"Use the API key generated from /api/admin/generate-hub-key"},webhookEvents:["order.status_changed","material.status_changed"]}})}catch(e){console.error("Error getting hub connection info:",e),t.status(500).json({success:!1,error:e.message||"Failed to get connection info"})}}n(so,"getHubConnectionInfo");var Wt=en();Wt.post("/generate-hub-key",oo);Wt.get("/hub-connection-info",so);var Ut=Wt;re();var ao=n(async(o,t)=>{try{let e=await w.getMaterialsPickList();(!e||e.length===0)&&(e=[{id:"mat-001",name:"White Core Mat 16x20",type:"mat",supplier:"Crescent",status:"pending",quantity:"5",priority:"medium",notes:"For order #1234",price:"12.50",orderDate:null,receiveDate:null,supplierName:"Crescent"},{id:"frame-001",name:'Oak Frame 1.5" - 8ft',type:"frame",supplier:"Larson-Juhl",status:"ordered",quantity:"2",priority:"high",notes:"Rush order",price:"45.00",orderDate:new Date().toISOString(),receiveDate:null,supplierName:"Larson-Juhl"},{id:"glass-001",name:"Museum Glass 16x20",type:"glass",supplier:"Tru Vue",status:"received",quantity:"3",priority:"low",notes:"In stock",price:"28.99",orderDate:new Date(Date.now()-864e5).toISOString(),receiveDate:new Date().toISOString(),supplierName:"Tru Vue"}]),t.json({success:!0,data:e,message:"Materials loaded successfully"})}catch(e){console.error("Error in getMaterialsPickList:",e),t.status(500).json({message:e.message,materials:[]})}},"getMaterialsPickList"),no=n(async(o,t)=>{try{let r=(await w.getMaterialsPickList()||[]).reduce((s,a)=>{let i=a.supplier||"Unknown Supplier";return s[i]||(s[i]=[]),s[i].push(a),s},{});t.json(r)}catch(e){console.error("Error in getMaterialsBySupplier:",e),t.status(500).json({message:e.message,suppliers:{}})}},"getMaterialsBySupplier"),io=n(async(o,t)=>{try{let e=parseInt(o.params.orderId);if(isNaN(e))return t.status(400).json({message:"Invalid order ID",materials:[]});let r=await w.getMaterialsForOrder(e);t.json(r||[])}catch(e){console.error("Error in getMaterialsForOrder:",e),t.status(500).json({message:e.message,materials:[]})}},"getMaterialsForOrder"),co=n(async(o,t)=>{try{let e=o.params.id,r;if(o.body.data)r=o.body.data;else{let{status:i,notes:d,orderDate:c,receiveDate:f,supplierName:C}=o.body;r={status:i,notes:d,orderDate:c,receiveDate:f,supplierName:C}}let s=Object.fromEntries(Object.entries(r).filter(([i,d])=>d!==void 0));console.log("Updating material order with data:",s);let a=await w.updateMaterialOrder(e,s);t.json(a)}catch(e){console.error("Error updating material:",e),t.status(500).json({message:e.message})}},"updateMaterial"),uo=n(async(o,t)=>{try{let{materialIds:e}=o.body;if(!e||!Array.isArray(e)||e.length===0)return t.status(400).json({message:"No materials selected"});let r=await w.createPurchaseOrder(e);t.status(201).json(r)}catch(e){t.status(500).json({message:e.message})}},"createPurchaseOrder"),lo=n(async(o,t)=>{try{let e=await w.getMaterialsPickList(),r=Array.from(new Set((e||[]).map(s=>s.type).filter(Boolean)));t.json(r.length>0?r:["frame","mat","glass","hardware"])}catch(e){console.error("Error in getMaterialTypes:",e),t.status(500).json({message:e.message,types:["frame","mat","glass","hardware"]})}},"getMaterialTypes"),mo=n(async(o,t)=>{try{let e=await w.getMaterialsPickList(),r=Array.from(new Set((e||[]).map(s=>s.supplier).filter(Boolean)));t.json(r.length>0?r:["Larson-Juhl","Roma","Bella"])}catch(e){console.error("Error in getMaterialSuppliers:",e),t.status(500).json({message:e.message,suppliers:["Larson-Juhl","Roma","Bella"]})}},"getMaterialSuppliers");Fe();import{Router as mn}from"express";Fe();var Ie=mn();Ie.get("/orders/:id",J,Gt);Ie.get("/orders",J,Kt);Ie.patch("/orders/:id/status",J,zt);Ie.post("/webhook",J,Vt);Ie.get("/test",Yt);Ie.post("/configure-kanban",Qt);var yo=Ie;import{Router as fn}from"express";re();import Zt from"axios";Z();Q();import{eq as Au}from"drizzle-orm";var ho=new Se,z=process.env.KANBAN_API_URL||"https://kanban-app-url.replit.app",oe=process.env.KANBAN_API_KEY;async function bo(o){try{if(!oe||!z){console.log("Kanban integration not configured, skipping sync");return}let t={orderId:o.id,customerName:o.customerName||"Unknown Customer",artworkTitle:o.artworkDescription,frameSize:`${o.artworkWidth}x${o.artworkHeight}`,status:o.productionStatus||"order_processed",stage:"pending",priority:"standard",dueDate:o.dueDate,createdAt:o.createdAt,estimatedCompletion:o.estimatedCompletionDays?new Date(Date.now()+o.estimatedCompletionDays*24*60*60*1e3).toISOString():null,materials:{frameType:o.frameId||"Unknown",matColor:o.matColorId||"White",glass:o.glassOptionId||"Regular"}},e=await Zt.post(`${z}/api/orders`,t,{headers:{Authorization:`Bearer ${oe}`,"Content-Type":"application/json"},timeout:5e3});e.data&&e.data.success&&console.log(`Order ${o.id} synced to Kanban successfully`)}catch(t){console.error(`Failed to sync order ${o.id} to Kanban:`,t.message)}}n(bo,"syncOrderToKanban");async function wo(o,t,e){try{if(!oe||!z){console.log("Kanban integration not configured, skipping status update");return}let r=await Zt.post(`${z}/api/orders/${o}/status`,{status:t,stage:t,notes:e||`Status updated to ${t}`,updatedBy:"Jays Frames POS",timestamp:new Date().toISOString()},{headers:{Authorization:`Bearer ${oe}`,"Content-Type":"application/json"},timeout:5e3});r.data&&r.data.success&&console.log(`Order ${o} status updated in Kanban to ${t}`)}catch(r){console.error(`Failed to update order ${o} status in Kanban:`,r.message)}}n(wo,"updateKanbanOrderStatus");async function pn(){try{if(!oe)return console.log("No Kanban API key found, using local storage"),null;let o=await Zt.get(`${z}/api/orders`,{headers:{Authorization:`Bearer ${oe}`,"Content-Type":"application/json"},timeout:5e3});return o.data&&o.data.success?o.data.orders:null}catch(o){return console.error("Failed to fetch orders from Kanban app:",o.message),null}}n(pn,"fetchOrdersFromKanban");async function Po(o,t){try{let e=await pn();if(e&&e.length>0){console.log(`Fetched ${e.length} orders from Kanban app`);let s=e.map(a=>({id:a.orderId||a.id,customerName:a.customerName,customerPhone:a.customerPhone||"",customerEmail:a.customerEmail||"",artworkTitle:a.artworkTitle,artworkWidth:a.frameSize?parseFloat(a.frameSize.split("x")[0]):a.artworkWidth,artworkHeight:a.frameSize?parseFloat(a.frameSize.split("x")[1]):a.artworkHeight,frameId:a.materials?.frameType||a.frameId,matId:a.materials?.matColor||a.matId,glassType:a.materials?.glass||a.glassType||"Museum Glass",productionStatus:a.status||"pending",stage:a.stage||"material_prep",totalPrice:a.totalPrice||0,createdAt:a.createdAt,scheduledDate:a.dueDate||a.scheduledDate,estimatedCompletion:a.estimatedCompletion,priority:a.priority||"standard",qrCode:a.qrCode||"",notes:a.notes||""}));t.json({success:!0,orders:s,source:"kanban",count:s.length});return}console.log("Falling back to local storage for orders");let r=await w.getAllOrders();console.log("Local orders found:",r.length),t.json({success:!0,orders:r,source:"local",count:r.length})}catch(e){console.error("Error fetching orders:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch orders"})}}n(Po,"getAllOrders");async function So(o,t){try{let{id:e}=o.params,r=await w.getOrder(parseInt(e));if(!r)return t.status(404).json({success:!1,error:"Order not found"});t.json({success:!0,order:r})}catch(e){console.error("Error fetching order:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch order"})}}n(So,"getOrderById");async function xo(o,t){try{let e=o.body;if(console.log("Creating order with data:",e),!e.customerId)return t.status(400).json({success:!1,error:"Customer ID is required"});if(e.artworkImage||(console.log("Warning: Order created without artwork image"),e.artworkImage="placeholder-image.jpg"),!e.artworkWidth||!e.artworkHeight)return t.status(400).json({success:!1,error:"Artwork dimensions are required"});e.matWidth||(e.matWidth="2"),console.log("Processing order creation...");let r=await w.createOrder(e);console.log("Order created successfully:",r),await bo(r);try{if(r.customerId){let s=await w.getCustomer(r.customerId);s&&s.phone&&(await ho.handleOrderEvent({orderId:r.id.toString(),orderNumber:`ORD-${r.id}`,customerName:s.name,customerPhone:s.phone,eventType:"order_placed",metadata:{estimatedCompletion:r.estimatedCompletionDays?`${r.estimatedCompletionDays} days`:"7-10 days"}}),console.log(`Order placed notification sent for order ${r.id}`))}}catch(s){console.error("Failed to send order placed notification:",s)}t.status(201).json({success:!0,order:r,message:"Order created successfully",orderId:r.id})}catch(e){console.error("Error creating order:",e),t.status(500).json({success:!1,error:e.message||"Failed to create order",details:e.stack})}}n(xo,"createOrder");async function Io(o,t){try{let{id:e}=o.params,r=o.body,s=await w.updateOrder(parseInt(e),r);r.productionStatus&&await wo(parseInt(e),r.productionStatus),t.json({success:!0,order:s,message:"Order updated successfully"})}catch(e){console.error("Error updating order:",e),t.status(500).json({success:!1,error:e.message||"Failed to update order"})}}n(Io,"updateOrder");async function vo(o,t){try{let{id:e}=o.params,{status:r,notes:s}=o.body;if(!r)return t.status(400).json({success:!1,error:"Status is required"});let a=await w.updateOrder(parseInt(e),{productionStatus:r,lastStatusChange:new Date});try{if(a&&a.customerId){let i=await w.getCustomer(a.customerId);if(i&&i.phone){let d=null;switch(r){case"in_production":d="production_started";break;case"frame_cut":d="frame_cut";break;case"mat_cut":d="mat_cut";break;case"assembly_complete":d="assembly_complete";break;case"ready_for_pickup":d="ready_for_pickup";break}d&&(await ho.handleOrderEvent({orderId:a.id.toString(),orderNumber:`ORD-${a.id}`,customerName:i.name,customerPhone:i.phone,eventType:d}),console.log(`Status change notification sent for order ${a.id}: ${r}`))}}}catch(i){console.error("Failed to send status change notification:",i)}await wo(parseInt(e),r,s),t.json({success:!0,order:a,message:`Order status updated to ${r}`})}catch(e){console.error("Error updating order status:",e),t.status(500).json({success:!1,error:e.message||"Failed to update order status"})}}n(vo,"updateOrderStatus");async function Oo(o,t){try{let{id:e}=o.params;await w.deleteOrder(parseInt(e)),t.json({success:!0,message:"Order deleted successfully"})}catch(e){console.error("Error deleting order:",e),t.status(500).json({success:!1,error:e.message||"Failed to delete order"})}}n(Oo,"deleteOrder");async function ko(o,t){try{let{orderId:e}=o.params;if(!oe||!z)return t.json({success:!1,error:"Kanban integration not configured",config:{hasApiKey:!!oe,hasApiUrl:!!z,apiUrl:z}});let r=await w.getOrder(parseInt(e));if(!r)return t.status(404).json({success:!1,error:"Order not found"});await bo(r),t.json({success:!0,message:`Order ${e} synced to Kanban successfully`,order:{id:r.id,status:r.productionStatus,kanbanUrl:z}})}catch(e){console.error("Error testing Kanban sync:",e),t.status(500).json({success:!1,error:e.message||"Failed to test Kanban sync"})}}n(ko,"testKanbanSync");async function _o(o,t){try{t.json({success:!0,status:{configured:!!(oe&&z),apiUrl:z,hasApiKey:!!oe,endpoints:{orders:`${z}/api/orders`,statusUpdate:`${z}/api/orders/:id/status`}}})}catch(e){t.status(500).json({success:!1,error:e.message||"Failed to get Kanban status"})}}n(_o,"getKanbanStatus");async function Co(o,t){try{let e=await w.getAllOrderGroups();t.json({success:!0,orderGroups:e,count:e.length})}catch(e){console.error("Error fetching order groups:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch order groups"})}}n(Co,"getAllOrderGroups");async function No(o,t){try{let e=o.body,r=await w.createOrderGroup(e);t.status(201).json({success:!0,orderGroup:r,message:"Order group created successfully"})}catch(e){console.error("Error creating order group:",e),t.status(500).json({success:!1,error:e.message||"Failed to create order group"})}}n(No,"createOrderGroup");re();var X=fn();X.get("/orders",Po);X.get("/orders/:id",So);X.post("/orders",xo);X.patch("/orders/:id",Io);X.patch("/orders/:id/status",vo);X.delete("/orders/:id",Oo);X.post("/orders/:id/send-update",async(o,t)=>{try{let e=parseInt(o.params.id),r=await w.getOrder(e);if(!r)return t.status(404).json({success:!1,error:"Order not found"});if(!r.customerId)return t.status(400).json({success:!1,error:"Order has no customer"});let s=await w.getCustomer(r.customerId);if(!s)return t.status(404).json({success:!1,error:"Customer not found"});await w.createCustomerNotification({customerId:s.id,orderId:r.id,notificationType:"status_update",channel:"email",subject:`Order #${r.id} Update`,message:`Your order is currently ${r.productionStatus.replace("_"," ")}. We'll keep you updated on the progress.`,successful:!0}),t.json({success:!0,message:"Customer notification sent successfully"})}catch(e){console.error("Error sending customer update:",e),t.status(500).json({success:!1,error:e.message||"Failed to send customer update"})}});X.post("/orders/:orderId/test-kanban-sync",ko);X.get("/kanban/status",_o);X.get("/order-groups",Co);X.post("/order-groups",No);var Ao=X;import{Router as hn}from"express";Z();Q();import{eq as gn,desc as yn}from"drizzle-orm";async function Eo(o,t){try{let e=await l.select().from(N).orderBy(yn(N.createdAt));return t.status(200).json(e)}catch(e){return console.error("Error fetching customers:",e),t.status(500).json({message:"Error fetching customers"})}}n(Eo,"getAllCustomers");async function jo(o,t){try{let{id:e}=o.params,r=parseInt(e);if(isNaN(r))return t.status(400).json({message:"Invalid customer ID"});let s=await l.select().from(N).where(gn(N.id,r)).limit(1);return s.length===0?t.status(404).json({message:"Customer not found"}):t.status(200).json(s[0])}catch(e){return console.error("Error fetching customer:",e),t.status(500).json({message:"Error fetching customer"})}}n(jo,"getCustomerById");async function Ro(o,t){try{let e=kt.parse(o.body),[r]=await l.insert(N).values(e).returning();return t.status(201).json(r)}catch(e){return console.error("Error creating customer:",e),e.name==="ZodError"?t.status(400).json({message:"Invalid customer data",errors:e.errors}):t.status(500).json({message:"Error creating customer"})}}n(Ro,"createCustomer");var yt=hn();yt.get("/customers",Eo);yt.get("/customers/:id",jo);yt.post("/customers",Ro);var Mo=yt;import{Router as bn}from"express";Z();Q();import{eq as et}from"drizzle-orm";async function Fo(o,t){try{let e=await l.select().from(R);return t.status(200).json(e)}catch(e){return console.error("Error fetching inventory locations:",e),t.status(500).json({message:"Error fetching inventory locations",details:e.message})}}n(Fo,"getAllInventoryLocations");async function Do(o,t){try{let{id:e}=o.params,r=await l.select().from(R).where(et(R.id,parseInt(e))).limit(1);return r.length===0?t.status(404).json({message:"Inventory location not found"}):t.status(200).json(r[0])}catch(e){return console.error("Error fetching inventory location:",e),t.status(500).json({message:"Error fetching inventory location",details:e.message})}}n(Do,"getInventoryLocationById");async function To(o,t){try{let e=ut.parse(o.body),[r]=await l.insert(R).values(e).returning();return t.status(201).json(r)}catch(e){return console.error("Error creating inventory location:",e),e.name==="ZodError"?t.status(400).json({message:"Invalid location data",errors:e.errors}):t.status(500).json({message:"Error creating inventory location",details:e.message})}}n(To,"createInventoryLocation");async function $o(o,t){try{let{id:e}=o.params,r=ut.parse(o.body),[s]=await l.update(R).set(r).where(et(R.id,parseInt(e))).returning();return s?t.status(200).json(s):t.status(404).json({message:"Inventory location not found"})}catch(e){return console.error("Error updating inventory location:",e),e.name==="ZodError"?t.status(400).json({message:"Invalid location data",errors:e.errors}):t.status(500).json({message:"Error updating inventory location",details:e.message})}}n($o,"updateInventoryLocation");async function Lo(o,t){try{let{id:e}=o.params,r=await l.select({count:l.fn.count()}).from(M).where(et(M.locationId,parseInt(e)));return parseInt(r[0].count)>0?t.status(400).json({message:"Cannot delete location with assigned items. Move items to another location first."}):(await l.delete(R).where(et(R.id,parseInt(e))).returning({id:R.id})).length===0?t.status(404).json({message:"Inventory location not found"}):t.status(200).json({message:"Inventory location deleted successfully"})}catch(e){return console.error("Error deleting inventory location:",e),t.status(500).json({message:"Error deleting inventory location",details:e.message})}}n(Lo,"deleteInventoryLocation");async function qo(o,t){try{let e=await l.select({...M,locationName:R.name}).from(M).leftJoin(R,et(M.locationId,R.id));return t.status(200).json(e||[])}catch(e){return console.error("Error fetching inventory items:",e),t.status(500).json({message:"Error fetching inventory items",details:e.message})}}n(qo,"getAllInventoryItems");async function Bo(o,t){try{return t.status(200).json([])}catch(e){return console.error("Error fetching low stock items:",e),t.status(500).json({message:"Error fetching low stock items",details:e.message})}}n(Bo,"getLowStockItems");async function Wo(o,t){try{let e=await l.select().from(U);return t.status(200).json(e||[])}catch(e){return console.error("Error fetching suppliers:",e),t.status(500).json({message:"Error fetching suppliers",details:e.message})}}n(Wo,"getAllSuppliers");var ue=bn();ue.get("/inventory/locations",Fo);ue.get("/inventory/locations/:id",Do);ue.post("/inventory/locations",To);ue.put("/inventory/locations/:id",$o);ue.delete("/inventory/locations/:id",Lo);ue.get("/inventory/items",qo);ue.get("/inventory/items/low-stock",Bo);ue.get("/inventory/suppliers",Wo);var Uo=ue;import{Router as In}from"express";import{parseString as wn}from"xml2js";import{promisify as Pn}from"util";var Sn=Pn(wn),er=class er{async parseVendorXmlPriceSheet(t){try{console.log("Parsing vendor XML price sheet...");let e=await Sn(t),r=[];if(e.catalog?.items?.item){let s=Array.isArray(e.catalog.items.item)?e.catalog.items.item:[e.catalog.items.item];for(let a of s){let i={itemNumber:this.extractValue(a.sku||a.itemNumber||a.id),description:this.extractValue(a.description||a.name),width:this.extractValue(a.width),collection:this.extractValue(a.collection||a.series),manufacturer:this.extractValue(a.manufacturer||a.vendor||"Unknown"),wholesalePrice:this.extractNumericValue(a.wholesalePrice||a.cost||a.price),retailPrice:this.extractNumericValue(a.retailPrice||a.msrp),category:this.extractValue(a.category||a.type),inStock:this.extractBooleanValue(a.inStock||a.available),unitOfMeasure:this.extractValue(a.unitOfMeasure||a.uom||"each")};i.itemNumber&&i.wholesalePrice>0&&r.push(i)}}else if(e.products?.product){let s=Array.isArray(e.products.product)?e.products.product:[e.products.product];for(let a of s){let i={itemNumber:this.extractValue(a.$.id||a.$.sku),description:this.extractValue(a.name?.[0]||a.description?.[0]),width:this.extractValue(a.dimensions?.width?.[0]),collection:this.extractValue(a.collection?.[0]),manufacturer:this.extractValue(a.manufacturer?.[0]||"Unknown"),wholesalePrice:this.extractNumericValue(a.pricing?.wholesale?.[0]||a.cost?.[0]),retailPrice:this.extractNumericValue(a.pricing?.retail?.[0]),category:this.extractValue(a.category?.[0]),inStock:this.extractBooleanValue(a.inventory?.inStock?.[0]),unitOfMeasure:this.extractValue(a.unitOfMeasure?.[0]||"each")};i.itemNumber&&i.wholesalePrice>0&&r.push(i)}}return console.log(`Successfully parsed ${r.length} items from XML price sheet`),r}catch(e){throw console.error("Error parsing XML price sheet:",e),new Error(`Failed to parse XML price sheet: ${e.message}`)}}extractValue(t){return typeof t=="string"?t.trim():Array.isArray(t)&&t.length>0?String(t[0]).trim():t&&typeof t=="object"&&t._?String(t._).trim():""}extractNumericValue(t){let e=this.extractValue(t),r=parseFloat(e.replace(/[^0-9.-]/g,""));return isNaN(r)?0:r}extractBooleanValue(t){let e=this.extractValue(t).toLowerCase();return e==="true"||e==="yes"||e==="1"}convertToFrameFormat(t){return t.map(e=>({id:`vendor-${e.manufacturer.toLowerCase().replace(/\s+/g,"-")}-${e.itemNumber}`,name:`${e.collection?e.collection+" ":""}${e.description}`,manufacturer:e.manufacturer,material:this.inferMaterial(e.description,e.category),width:e.width||"",depth:"",price:e.wholesalePrice.toString(),catalogImage:"",color:this.inferColor(e.description),itemNumber:e.itemNumber,collection:e.collection||"",category:e.category||"",inStock:e.inStock!==!1,unitOfMeasure:e.unitOfMeasure}))}inferMaterial(t,e){let r=t.toLowerCase(),s=e?.toLowerCase()||"";return r.includes("wood")||s.includes("wood")?"wood":r.includes("metal")||s.includes("metal")?"metal":r.includes("plastic")||s.includes("plastic")?"plastic":r.includes("composite")||s.includes("composite")?"composite":"wood"}inferColor(t){let e=t.toLowerCase();return e.includes("black")?"#000000":e.includes("white")?"#FFFFFF":e.includes("brown")?"#8B4513":e.includes("gold")?"#FFD700":e.includes("silver")?"#C0C0C0":e.includes("red")?"#FF0000":e.includes("blue")?"#0000FF":"#8B4513"}};n(er,"XmlPriceSheetService");var Jt=er,Xt=new Jt;Z();Q();async function Ho(o,t){try{let{xmlContent:e,vendorName:r}=o.body;if(!e)return t.status(400).json({message:"XML content is required"});if(!r)return t.status(400).json({message:"Vendor name is required"});console.log(`Processing XML price sheet for vendor: ${r}`);let s=await Xt.parseVendorXmlPriceSheet(e);if(s.length===0)return t.status(400).json({message:"No valid price items found in XML"});let a=Xt.convertToFrameFormat(s),i=0,d=0;for(let c of a)try{(await l.select().from($).where(eq($.id,c.id)).limit(1)).length>0?(await l.update($).set({name:c.name,manufacturer:c.manufacturer,material:c.material,width:c.width,price:c.price,color:c.color,updatedAt:new Date}).where(eq($.id,c.id)),d++):(await l.insert($).values({id:c.id,name:c.name,manufacturer:c.manufacturer,material:c.material,width:c.width,depth:c.depth,price:c.price,catalogImage:c.catalogImage,color:c.color,createdAt:new Date,updatedAt:new Date}),i++)}catch(f){console.error(`Error processing frame item ${c.id}:`,f)}console.log(`XML price sheet processing complete. Inserted: ${i}, Updated: ${d}`),t.json({message:"XML price sheet processed successfully",vendor:r,totalItems:s.length,inserted:i,updated:d,summary:{priceItems:s.slice(0,5),frameItems:a.slice(0,5)}})}catch(e){console.error("Error processing XML price sheet:",e),t.status(500).json({message:"Failed to process XML price sheet",error:e.message})}}n(Ho,"uploadXmlPriceSheet");async function Go(o,t){t.json({supportedFormats:[{name:"Standard Catalog Format",structure:{catalog:{items:{item:[{sku:"item-number",description:"item-description",manufacturer:"vendor-name",wholesalePrice:"price",width:"frame-width",collection:"collection-name"}]}}}},{name:"Products Format",structure:{products:{product:[{$:{id:"item-number"},name:["item-description"],manufacturer:["vendor-name"],pricing:{wholesale:["price"]}}]}}}],requiredFields:["itemNumber","description","manufacturer","wholesalePrice"],optionalFields:["width","collection","retailPrice","category","inStock"]})}n(Go,"getXmlFormats");function xn(o,t,e){console.log("Auth middleware: Allowing request (authentication not implemented)"),e()}n(xn,"isAuthenticated");var Ko=xn;var ht=In();ht.use(Ko);ht.post("/upload",Ho);ht.get("/formats",Go);var zo=ht;import{Router as _n}from"express";var vn=[{itemNumber:"10-036M",width:'5/8"',boxQty:360,collection:"Maple & Walnut - Garrett",basePricePerFoot:6.62,boxPrice:10.05,lengthPrice:13.52,chopPrice:14.52},{itemNumber:"10-100M",width:'5/8"',boxQty:375,collection:"Maple & Walnut - Garrett",basePricePerFoot:6.34,boxPrice:9.71,lengthPrice:12.75,chopPrice:13.75},{itemNumber:"10-507M",width:'5/8"',boxQty:306,collection:"Museum Stems - Garrett",basePricePerFoot:6.52,boxPrice:9.91,lengthPrice:13,chopPrice:14},{itemNumber:"100172",width:'1/4"',boxQty:1600,collection:"Olmsted",basePricePerFoot:2.75,boxPrice:4.64,lengthPrice:7.28,chopPrice:8.28},{itemNumber:"100750",width:'1/4"',boxQty:1200,collection:"Sofia",basePricePerFoot:2.63,boxPrice:4.04,lengthPrice:6.73,chopPrice:7.73},{itemNumber:"100751",width:'1/4"',boxQty:1587,collection:"Sofia",basePricePerFoot:2.63,boxPrice:4.04,lengthPrice:6.73,chopPrice:7.73},{itemNumber:"100752",width:'1/4"',boxQty:1e3,collection:"Sofia",basePricePerFoot:2.63,boxPrice:4.04,lengthPrice:6.73,chopPrice:7.73},{itemNumber:"102CG",width:'1/2"',boxQty:432,collection:"Marquis",basePricePerFoot:1.74,boxPrice:3.7,lengthPrice:6.43,chopPrice:7.43},{itemNumber:"102CS",width:'1/2"',boxQty:432,collection:"Marquis",basePricePerFoot:1.74,boxPrice:3.7,lengthPrice:6.43,chopPrice:7.43},{itemNumber:"103180",width:'9/16"',boxQty:900,collection:"Hudson",basePricePerFoot:1.46,boxPrice:3.11,lengthPrice:5.56,chopPrice:6.56},{itemNumber:"103190",width:'9/16"',boxQty:900,collection:"Hudson",basePricePerFoot:1.4,boxPrice:2.97,lengthPrice:5.3,chopPrice:6.3},{itemNumber:"103235",width:'5/16"',boxQty:1200,collection:"Academie",basePricePerFoot:1.44,boxPrice:3.17,lengthPrice:5.64,chopPrice:6.64},{itemNumber:"103237",width:'5/16"',boxQty:1296,collection:"Academie",basePricePerFoot:1.43,boxPrice:3.14,lengthPrice:5.59,chopPrice:6.59},{itemNumber:"105794",width:'5/16"',boxQty:785,collection:"Lucerne",basePricePerFoot:3.21,boxPrice:5.02,lengthPrice:8.01,chopPrice:9.01},{itemNumber:"105CB",width:'1/2"',boxQty:270,collection:"Vienna",basePricePerFoot:2.21,boxPrice:3.31,lengthPrice:5.71,chopPrice:6.71},{itemNumber:"106180",width:'1/2"',boxQty:900,collection:"Hudson",basePricePerFoot:1.39,boxPrice:2.99,lengthPrice:5.31,chopPrice:6.31},{itemNumber:"106190",width:'1/2"',boxQty:900,collection:"Hudson",basePricePerFoot:1.32,boxPrice:2.83,lengthPrice:5.09,chopPrice:6.09},{itemNumber:"200750",width:'7/8"',boxQty:250,collection:"Sofia",basePricePerFoot:4.38,boxPrice:6.54,lengthPrice:9.9,chopPrice:10.9},{itemNumber:"200751",width:'7/8"',boxQty:515,collection:"Sofia",basePricePerFoot:4.35,boxPrice:6.76,lengthPrice:9.84,chopPrice:10.84},{itemNumber:"200752",width:'7/8"',boxQty:490,collection:"Sofia",basePricePerFoot:4.57,boxPrice:7.31,lengthPrice:10.33,chopPrice:11.33},{itemNumber:"210286",width:'11/16"',boxQty:450,collection:"White",basePricePerFoot:1.89,boxPrice:3.06,lengthPrice:5.99,chopPrice:6.99},{itemNumber:"400750",width:'1 5/8"',boxQty:112,collection:"Sofia",basePricePerFoot:7.47,boxPrice:11.04,lengthPrice:17.48,chopPrice:18.48},{itemNumber:"400751",width:'1 5/8"',boxQty:192,collection:"Sofia",basePricePerFoot:7.09,boxPrice:10.44,lengthPrice:16.55,chopPrice:17.55},{itemNumber:"400752",width:'1 5/8"',boxQty:180,collection:"Sofia",basePricePerFoot:7.34,boxPrice:10.83,lengthPrice:17.17,chopPrice:18.17},{itemNumber:"431431",width:'1 3/8"',boxQty:115,collection:"Zen",basePricePerFoot:10.83,boxPrice:15.91,lengthPrice:26.01,chopPrice:27.01},{itemNumber:"431432",width:'1 3/8"',boxQty:113,collection:"Zen",basePricePerFoot:10.27,boxPrice:15.1,lengthPrice:24.68,chopPrice:25.68},{itemNumber:"431434",width:'1 3/8"',boxQty:110,collection:"Zen",basePricePerFoot:10.75,boxPrice:15.81,lengthPrice:25.82,chopPrice:26.82},{itemNumber:"432900",width:'1 3/4"',boxQty:225,collection:"Foundry",basePricePerFoot:6.62,boxPrice:9.75,lengthPrice:15.03,chopPrice:16.03},{itemNumber:"432902",width:'1 3/4"',boxQty:236,collection:"Foundry",basePricePerFoot:6.81,boxPrice:10.07,lengthPrice:15.52,chopPrice:16.52},{itemNumber:"433082",width:'1 11/16"',boxQty:108,collection:"Soho",basePricePerFoot:5.09,boxPrice:9.55,lengthPrice:14.41,chopPrice:15.41},{itemNumber:"433084",width:'1 11/16"',boxQty:108,collection:"Soho",basePricePerFoot:5.16,boxPrice:9.59,lengthPrice:14.54,chopPrice:15.54},{itemNumber:"433086",width:'1 11/16"',boxQty:108,collection:"Soho",basePricePerFoot:5.22,boxPrice:9.59,lengthPrice:14.54,chopPrice:15.54},{itemNumber:"434110",width:'1 1/4"',boxQty:137,collection:"CR2",basePricePerFoot:6.33,boxPrice:9.33,lengthPrice:14.98,chopPrice:15.98},{itemNumber:"435500",width:'1 5/16"',boxQty:324,collection:"Alto",basePricePerFoot:1.8,boxPrice:3.6,lengthPrice:6.72,chopPrice:7.72},{itemNumber:"435510",width:'1 5/16"',boxQty:296,collection:"Alto",basePricePerFoot:1.8,boxPrice:3.6,lengthPrice:6.72,chopPrice:7.72},{itemNumber:"436350",width:'1 5/8"',boxQty:143,collection:"Brooklyn",basePricePerFoot:2.29,boxPrice:3.66,lengthPrice:6.08,chopPrice:7.08},{itemNumber:"437500",width:'1 3/16"',boxQty:215,collection:"Alto",basePricePerFoot:2.03,boxPrice:3.6,lengthPrice:7.22,chopPrice:8.22},{itemNumber:"437510",width:'1 3/16"',boxQty:180,collection:"Alto",basePricePerFoot:2.03,boxPrice:3.6,lengthPrice:7.22,chopPrice:8.22},{itemNumber:"438120",width:'2"',boxQty:150,collection:"Dresden",basePricePerFoot:6.78,boxPrice:10.26,lengthPrice:15.05,chopPrice:16.05},{itemNumber:"439082",width:'2 1/16"',boxQty:126,collection:"Soho",basePricePerFoot:4.42,boxPrice:7.58,lengthPrice:11.4,chopPrice:12.4},{itemNumber:"440240",width:'1 3/8"',boxQty:190,collection:"Java",basePricePerFoot:7.59,boxPrice:11.23,lengthPrice:18.27,chopPrice:19.27},{itemNumber:"440951",width:'2"',boxQty:92,collection:"Cezanne",basePricePerFoot:18.08,boxPrice:25.65,lengthPrice:29.81,chopPrice:30.81},{itemNumber:"441075",width:'2 1/16"',boxQty:150,collection:"Prague",basePricePerFoot:9.48,boxPrice:13.9,lengthPrice:23.98,chopPrice:24.98},{itemNumber:"441077",width:'2 1/16"',boxQty:155,collection:"Prague",basePricePerFoot:9.44,boxPrice:13.82,lengthPrice:23.86,chopPrice:24.86},{itemNumber:"442650",width:'1 3/4"',boxQty:162,collection:"Tate",basePricePerFoot:4.76,boxPrice:8.08,lengthPrice:11.57,chopPrice:12.57},{itemNumber:"442660",width:'1 3/4"',boxQty:162,collection:"Tate",basePricePerFoot:4.76,boxPrice:8.07,lengthPrice:11.56,chopPrice:12.56},{itemNumber:"442670",width:'1 3/4"',boxQty:162,collection:"Tate",basePricePerFoot:4.67,boxPrice:7.74,lengthPrice:11.04,chopPrice:12.04},{itemNumber:"520750",width:'2 1/2"',boxQty:94,collection:"Sofia",basePricePerFoot:11.07,boxPrice:16.3,lengthPrice:24.59,chopPrice:25.59},{itemNumber:"520751",width:'2 1/2"',boxQty:59,collection:"Sofia",basePricePerFoot:10.92,boxPrice:16.43,lengthPrice:24.78,chopPrice:25.78},{itemNumber:"520752",width:'2 1/2"',boxQty:100,collection:"Sofia",basePricePerFoot:10.56,boxPrice:16.38,lengthPrice:23.41,chopPrice:24.41}];function Vo(o){let t=o.startsWith("larson-")?o.substring(7):o;return vn.find(e=>e.itemNumber===t)||null}n(Vo,"getLarsonJuhlWholesalePrice");var ve=9.5;function bt(o,t){let e=Vo(o);if(!e)return null;let r=e.basePricePerFoot,s=e.chopPrice||e.basePricePerFoot*1.5,a=Math.ceil(t/ve),i=a*ve,d=i-t,c=i*r,f=t*s,C;if(t>ve){let y=Math.floor(t/ve),k=t-y*ve;if(k>0){let G=y*ve*r+k*s;C={fullSticks:y,chopFootage:k,totalCost:G,description:`${y} full stick(s) + ${k.toFixed(1)}' chopped`}}}let g=[{method:"length",cost:c},{method:"chop",cost:f},...C?[{method:"mixed",cost:C.totalCost}]:[]],m=g.reduce((y,k)=>k.cost<y.cost?k:y),h=g.reduce((y,k)=>k.cost>y.cost?k:y).cost-m.cost,P="",S;return m.method==="length"?P=`Full sticks are cheaper despite ${d.toFixed(1)}' waste`:m.method==="chop"?P="Chop pricing saves money by avoiding waste":P="Mixed approach optimizes cost by combining full sticks and chopped pieces",t>=0&&t<=4?S="\u{1F3AF} OPTIMAL RANGE: 0-4 feet - Consider chop pricing to avoid waste":t>=10&&t<=14?S="\u{1F3AF} OPTIMAL RANGE: 10-14 feet - Mixed ordering may be most cost-effective":t>4&&t<9.5&&(S="\u{1F4CF} Consider: Close to full stick length, evaluate waste vs chop premium"),{itemNumber:o,footageNeeded:t,lengthOption:{sticksNeeded:a,totalFootage:i,wasteFootage:d,costPerFoot:r,totalCost:c,description:`${a} stick(s) @ ${ve}' each`},chopOption:{footageNeeded:t,costPerFoot:s,totalCost:f,description:`${t}' chopped to exact length`},mixedOption:C,recommendation:{method:m.method,savings:h,reason:P,alert:S}}}n(bt,"optimizeLarsonOrder");function On(o,t,e){let r=o+e*2,s=t+e*2;return r*2+s*2}n(On,"calculateFramePerimeter");function kn(o,t,e,r){let a=On(t,e,r)/12;return bt(o,a)}n(kn,"optimizeFrameOrder");function Yo(o){return o.map(t=>({...kn(t.itemNumber,t.artworkWidth,t.artworkHeight,t.matWidth),quantity:t.quantity||1})).filter(Boolean)}n(Yo,"batchOptimizeOrders");function Qo(o){let t=o.reduce((s,a)=>s+a.recommendation.savings*a.quantity,0),e=o.reduce((s,a)=>s+a.quantity,0),r=o.filter(s=>s.recommendation.alert).length;return{totalSavings:t,totalOrders:e,averageSavingsPerOrder:t/e,alertCount:r}}n(Qo,"calculateBatchSavings");async function Zo(o,t){try{let{itemNumber:e,footageNeeded:r}=o.body;if(!e||!r)return t.status(400).json({error:"Missing required parameters: itemNumber and footageNeeded"});let s=bt(e,parseFloat(r));if(!s)return t.status(404).json({error:"Item number not found in Larson-Juhl catalog"});t.json(s)}catch(e){console.error("Error optimizing Larson order:",e),t.status(500).json({error:"Internal server error"})}}n(Zo,"optimizeByFootage");async function wt(o,t){try{let{itemNumber:e,artworkWidth:r,artworkHeight:s,matWidth:a}=o.body;if(!e||!r||!s||a===void 0)return t.status(400).json({error:"Missing required parameters: itemNumber, artworkWidth, artworkHeight, matWidth"});let i=wt(e,parseFloat(r),parseFloat(s),parseFloat(a));if(!i)return t.status(404).json({error:"Item number not found in Larson-Juhl catalog"});t.json(i)}catch(e){console.error("Error optimizing frame order:",e),t.status(500).json({error:"Internal server error"})}}n(wt,"optimizeFrameOrder");async function Jo(o,t){try{let{orders:e}=o.body;if(!e||!Array.isArray(e))return t.status(400).json({error:"Missing or invalid orders array"});let r=Yo(e),s=Qo(r);t.json({optimizations:r,summary:s})}catch(e){console.error("Error batch optimizing orders:",e),t.status(500).json({error:"Internal server error"})}}n(Jo,"batchOptimize");async function Xo(o,t){try{let{itemNumber:e}=o.params,s=[2,4,6,8,10,12,14,16,18,20].map(a=>{let i=bt(e,a);return{footage:a,optimization:i}}).filter(a=>a.optimization!==null);if(s.length===0)return t.status(404).json({error:"Item number not found in Larson-Juhl catalog"});t.json({itemNumber:e,analysis:s})}catch(e){console.error("Error generating optimization analysis:",e),t.status(500).json({error:"Internal server error"})}}n(Xo,"getOptimizationAnalysis");var tt=_n();tt.post("/optimize/footage",Zo);tt.post("/optimize/frame",wt);tt.post("/optimize/batch",Jo);tt.get("/analyze/:itemNumber",Xo);var es=tt;Ye();import Cn from"express";var tr=Cn.Router();tr.post("/test-basic",async(o,t)=>{let{to:e,subject:r,message:s}=o.body;if(!e||!r||!s)return t.status(400).json({error:"Missing required fields: to, subject, message"});console.log("SendGrid API Key exists:",!!process.env.SENDGRID_API_KEY),console.log("SendGrid API Key starts with SG.:",process.env.SENDGRID_API_KEY?.startsWith("SG.")),console.log("From email:",process.env.FROM_EMAIL||"noreply@jaysartandframes.com");try{await ze({to:e,from:"noreply@jaysartandframes.com",subject:r,text:s,html:`<p>${s}</p>`}),t.json({success:!0,message:"Test email sent successfully!"})}catch(a){console.error("Test email error:",a);let i={message:a.message,hasApiKey:!!process.env.SENDGRID_API_KEY,apiKeyFormat:process.env.SENDGRID_API_KEY?.startsWith("SG.")?"Valid format":"Invalid format",fromEmail:process.env.FROM_EMAIL||"noreply@jaysartandframes.com"};t.status(500).json({error:"Failed to send test email",details:a.message,debug:i})}});tr.post("/test-order-status",async(o,t)=>{let{customerEmail:e,customerName:r="Test Customer",orderId:s=12345,orderStatus:a="order_processed"}=o.body;if(!e)return t.status(400).json({error:"Missing required field: customerEmail"});try{await Ve(e,r,s,a,new Date(Date.now()+7*24*60*60*1e3)),t.json({success:!0,message:"Order status email sent successfully!"})}catch(i){console.error("Order status email error:",i),t.status(500).json({error:"Failed to send order status email",details:i.message})}});var ts=tr;import{Router as Nn}from"express";var rs=n(async(o,t)=>{try{let{to:e,message:r,voice:s,language:a,twiml:i,url:d,recordCall:c}=o.body;if(!e)return t.status(400).json({error:"Phone number is required"});if(!r&&!i&&!d)return t.status(400).json({error:"Must provide either message, twiml, or url parameter"});if(!ge())return t.status(503).json({error:"Voice calling is not configured. Please check Twilio credentials."});let f=await K({to:Me(e),message:r,voice:s,language:a,twiml:i,url:d,recordCall:c});f.success?t.json({success:!0,callSid:f.sid,message:"Voice call initiated successfully"}):t.status(400).json({error:f.error})}catch(e){console.error("Error making voice call:",e),t.status(500).json({error:"Failed to make voice call"})}},"makeCustomVoiceCall"),os=n(async(o,t)=>{try{let{to:e,orderNumber:r,status:s,estimatedCompletion:a}=o.body;if(!e||!r||!s)return t.status(400).json({error:"Phone number, order number, and status are required"});if(!ge())return t.status(503).json({error:"Voice calling is not configured. Please check Twilio credentials."});let i=await Kr({to:Me(e),orderNumber:r,status:s,estimatedCompletion:a});i.success?t.json({success:!0,callSid:i.sid,message:"Order status call initiated successfully"}):t.status(400).json({error:i.error})}catch(e){console.error("Error making order status call:",e),t.status(500).json({error:"Failed to make order status call"})}},"callOrderStatus"),ss=n(async(o,t)=>{try{let{to:e,customerName:r,amount:s,orderNumber:a,dueDate:i}=o.body;if(!e||!r||!s||!a)return t.status(400).json({error:"Phone number, customer name, amount, and order number are required"});if(!ge())return t.status(503).json({error:"Voice calling is not configured. Please check Twilio credentials."});let d=await zr({to:Me(e),customerName:r,amount:parseFloat(s),orderNumber:a,dueDate:i});d.success?t.json({success:!0,callSid:d.sid,message:"Payment reminder call initiated successfully"}):t.status(400).json({error:d.error})}catch(e){console.error("Error making payment reminder call:",e),t.status(500).json({error:"Failed to make payment reminder call"})}},"callPaymentReminderController"),as=n(async(o,t)=>{try{let{to:e,customerName:r,orderNumber:s,daysWaiting:a}=o.body;if(!e||!r||!s||a===void 0)return t.status(400).json({error:"Phone number, customer name, order number, and days waiting are required"});if(!ge())return t.status(503).json({error:"Voice calling is not configured. Please check Twilio credentials."});let i=await Vr(r,Me(e),s,parseInt(a));i.success?t.json({success:!0,callSid:i.sid,message:"Pickup reminder call initiated successfully"}):t.status(400).json({error:i.error})}catch(e){console.error("Error making pickup reminder call:",e),t.status(500).json({error:"Failed to make pickup reminder call"})}},"callPickupReminderController"),ns=n(async(o,t)=>{try{let{to:e,customerName:r,orderNumber:s}=o.body;if(!e||!r||!s)return t.status(400).json({error:"Phone number, customer name, and order number are required"});if(!ge())return t.status(503).json({error:"Voice calling is not configured. Please check Twilio credentials."});let a=await gt(r,Me(e),s);a.success?t.json({success:!0,callSid:a.sid,message:"Order completion call initiated successfully"}):t.status(400).json({error:a.error})}catch(e){console.error("Error making order completion call:",e),t.status(500).json({error:"Failed to make order completion call"})}},"callOrderCompleteController"),is=n(async(o,t)=>{try{let{callSid:e}=o.params;if(!e)return t.status(400).json({error:"Call SID is required"});if(!ge())return t.status(503).json({error:"Voice calling is not configured. Please check Twilio credentials."});let r=await Yr(e);r.success?t.json({success:!0,status:r.status}):t.status(400).json({error:r.error})}catch(e){console.error("Error getting call status:",e),t.status(500).json({error:"Failed to get call status"})}},"getVoiceCallStatus"),cs=n(async(o,t)=>{try{let e=ge();t.json({configured:e,message:e?"Voice calling is properly configured":"Voice calling requires TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN, and TWILIO_PHONE_NUMBER"})}catch(e){console.error("Error checking voice call configuration:",e),t.status(500).json({error:"Failed to check voice call configuration"})}},"checkVoiceCallConfiguration");var ye=Nn();ye.get("/configuration",cs);ye.post("/make-call",rs);ye.post("/order-status",os);ye.post("/order-complete",ns);ye.post("/pickup-reminder",as);ye.post("/payment-reminder",ss);ye.get("/status/:callSid",is);var us=ye;import{Router as An}from"express";var Oe=An();Oe.post("/order-complete/:orderNumber",(o,t)=>{let{orderNumber:e}=o.params,{customerName:r}=o.query;t.set("Content-Type","text/xml");let s=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="Polly.Amy">Hello ${r||"valued customer"}! This is Jay's Frames calling with great news.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Amy">Your custom framing order number ${e} is now complete and ready for pickup.</Say>
    <Pause length="1"/>
    <Play>https://demo.twilio.com/docs/classic.mp3</Play>
    <Say voice="Polly.Amy">We're excited for you to see the beautiful result. Please come by during our business hours to collect your order.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Amy">Thank you for choosing Jay's Frames. Have a wonderful day!</Say>
</Response>`;t.send(s)});Oe.post("/payment-reminder/:orderNumber",(o,t)=>{let{orderNumber:e}=o.params,{customerName:r,amount:s,dueDate:a}=o.query;t.set("Content-Type","text/xml");let i=a?` Payment is due by ${a}.`:"",d=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="Polly.Brian">Hello ${r||"valued customer"}, this is Jay's Frames calling about your order number ${e}.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Brian">You have an outstanding balance of ${s||"your order total"}.${i}</Say>
    <Pause length="1"/>
    <Say voice="Polly.Brian">Please contact us at your earliest convenience to complete your payment.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Brian">Thank you for your prompt attention to this matter.</Say>
</Response>`;t.send(d)});Oe.post("/pickup-reminder/:orderNumber",(o,t)=>{let{orderNumber:e}=o.params,{customerName:r,daysWaiting:s}=o.query;t.set("Content-Type","text/xml");let a=parseInt(s||"1"),d=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="Polly.Emma">Hello ${r||"valued customer"}, this is Jay's Frames.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Emma">Your custom framing order number ${e} has been ready for pickup for ${a} ${a===1?"day":"days"}.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Emma">Please come by during our business hours to collect your beautiful framed artwork.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Emma">We look forward to seeing you soon. Thank you!</Say>
</Response>`;t.send(d)});Oe.post("/promotional/:campaignId",(o,t)=>{let{campaignId:e}=o.params,{customerName:r}=o.query;t.set("Content-Type","text/xml");let s=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="Polly.Amy">Hello ${r||"valued customer"}! Thank you for being a loyal customer of Jay's Frames.</Say>
    <Pause length="1"/>
    <Play>https://demo.twilio.com/docs/classic.mp3</Play>
    <Say voice="Polly.Amy">We have an exciting special offer just for you! Visit our shop this week for twenty percent off all custom matting services.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Amy">This exclusive offer expires soon, so don't miss out on transforming your favorite artwork.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Amy">Thank you for choosing Jay's Frames. We can't wait to help you create something beautiful!</Say>
</Response>`;t.send(s)});Oe.post("/interactive-survey/:orderNumber",(o,t)=>{let{orderNumber:e}=o.params,{customerName:r}=o.query;t.set("Content-Type","text/xml");let s=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="Polly.Amy">Hello ${r||"valued customer"}! This is Jay's Frames calling about your recent order number ${e}.</Say>
    <Pause length="1"/>
    <Gather numDigits="1" action="/api/twiml/survey-response" method="POST" timeout="10">
        <Say voice="Polly.Amy">We'd love to hear about your experience. Please press 1 if you're extremely satisfied, 2 for satisfied, or 3 if you have concerns.</Say>
    </Gather>
    <Say voice="Polly.Amy">Thank you for your time. Have a wonderful day!</Say>
</Response>`;t.send(s)});Oe.post("/survey-response",(o,t)=>{let{Digits:e}=o.body;t.set("Content-Type","text/xml");let r="";switch(e){case"1":r="Thank you for rating us as extremely satisfied! We appreciate your business and look forward to serving you again.";break;case"2":r="Thank you for your positive feedback! We appreciate your business.";break;case"3":r="Thank you for your feedback. We will have a manager contact you shortly to address your concerns.";break;default:r="Thank you for your time. Have a wonderful day!"}let s=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="Polly.Amy">${r}</Say>
</Response>`;t.send(s)});var ls=Oe;import{Router as En}from"express";var or=class or{async triggerNotification(t,e){try{let{orderId:r,orderNumber:s,customerName:a,customerPhone:i,eventType:d,metadata:c}=t.body;if(!r||!s||!a||!i||!d){e.status(400).json({success:!1,error:"Missing required fields: orderId, orderNumber, customerName, customerPhone, eventType"});return}let f=["order_placed","payment_received","production_started","frame_cut","mat_cut","assembly_complete","ready_for_pickup","payment_due","pickup_overdue"];if(!f.includes(d)){e.status(400).json({success:!1,error:`Invalid event type. Must be one of: ${f.join(", ")}`});return}let C={orderId:r,orderNumber:s,customerName:a,customerPhone:i,eventType:d,metadata:c};await Qe.handleOrderEvent(C),e.json({success:!0,message:`Notification triggered for order ${s}`,eventType:d})}catch(r){console.error("Error triggering notification:",r),e.status(500).json({success:!1,error:"Failed to trigger notification"})}}async scheduleNotification(t,e){try{let{orderId:r,orderNumber:s,customerName:a,customerPhone:i,eventType:d,delayMinutes:c,metadata:f}=t.body;if(!c||c<1){e.status(400).json({success:!1,error:"delayMinutes must be a positive number"});return}let C={orderId:r,orderNumber:s,customerName:a,customerPhone:i,eventType:d,metadata:f};await Qe.scheduleDelayedNotification(C,c),e.json({success:!0,message:`Notification scheduled for order ${s} in ${c} minutes`,scheduledFor:new Date(Date.now()+c*60*1e3).toISOString()})}catch(r){console.error("Error scheduling notification:",r),e.status(500).json({success:!1,error:"Failed to schedule notification"})}}async sendBulkNotifications(t,e){try{let{events:r}=t.body;if(!Array.isArray(r)||r.length===0){e.status(400).json({success:!1,error:"events must be a non-empty array"});return}for(let s of r)if(!s.orderId||!s.orderNumber||!s.customerName||!s.customerPhone||!s.eventType){e.status(400).json({success:!1,error:"Each event must have orderId, orderNumber, customerName, customerPhone, and eventType"});return}await Qe.sendBulkNotifications(r),e.json({success:!0,message:`Bulk notifications sent for ${r.length} orders`,count:r.length})}catch(r){console.error("Error sending bulk notifications:",r),e.status(500).json({success:!1,error:"Failed to send bulk notifications"})}}async checkOverdueOrders(t,e){try{console.log("Checking for overdue pickup orders..."),e.json({success:!0,message:"Overdue orders check completed"})}catch(r){console.error("Error checking overdue orders:",r),e.status(500).json({success:!1,error:"Failed to check overdue orders"})}}async getNotificationStatus(t,e){try{let r=!!(process.env.TWILIO_ACCOUNT_SID&&process.env.TWILIO_AUTH_TOKEN&&process.env.TWILIO_PHONE_NUMBER),s=[{type:"order_placed",description:"Order confirmation call"},{type:"payment_received",description:"Payment confirmation call"},{type:"production_started",description:"Production started notification"},{type:"frame_cut",description:"Frame cutting complete update"},{type:"mat_cut",description:"Mat cutting complete update"},{type:"assembly_complete",description:"Assembly complete notification"},{type:"ready_for_pickup",description:"Order ready for pickup call"},{type:"payment_due",description:"Payment reminder call"},{type:"pickup_overdue",description:"Pickup reminder call"}];e.json({success:!0,configured:r,message:r?"Order notifications are configured and ready":"Twilio credentials required",supportedEventTypes:s,endpoints:{trigger:"/api/order-notifications/trigger",schedule:"/api/order-notifications/schedule",bulk:"/api/order-notifications/bulk",checkOverdue:"/api/order-notifications/check-overdue"}})}catch(r){console.error("Error getting notification status:",r),e.status(500).json({success:!1,error:"Failed to get notification status"})}}async testNotification(t,e){try{let{phone:r,eventType:s="ready_for_pickup"}=t.body;if(!r){e.status(400).json({success:!1,error:"Phone number is required for test notification"});return}let a={orderId:"TEST-001",orderNumber:"TEST-001",customerName:"Test Customer",customerPhone:r,eventType:s,metadata:{amount:125.5,daysWaiting:3,dueDate:"Friday",estimatedCompletion:"2-3 business days"}};await Qe.handleOrderEvent(a),e.json({success:!0,message:`Test notification sent to ${r}`,eventType:s,testData:a})}catch(r){console.error("Error sending test notification:",r),e.status(500).json({success:!1,error:"Failed to send test notification"})}}};n(or,"OrderNotificationController");var rr=or,V=new rr;var ke=En();ke.post("/trigger",V.triggerNotification.bind(V));ke.post("/schedule",V.scheduleNotification.bind(V));ke.post("/bulk",V.sendBulkNotifications.bind(V));ke.post("/check-overdue",V.checkOverdueOrders.bind(V));ke.get("/status",V.getNotificationStatus.bind(V));ke.post("/test",V.testNotification.bind(V));var ds=ke;Z();Q();import{Router as jn}from"express";import Rn from"stripe";import{eq as ms}from"drizzle-orm";var fs=jn(),ps=process.env.STRIPE_SECRET_KEY?new Rn(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"}):null;fs.post("/payment-status",async(o,t)=>{try{let{payment_intent_id:e,client_secret:r}=o.body;if(!ps)return t.status(500).json({success:!1,message:"Payment processing is not configured"});if(!e)return t.status(400).json({success:!1,message:"Payment intent ID is required"});let s=await ps.paymentIntents.retrieve(e),a=await l.select().from(T).where(ms(T.stripePaymentIntentId,e)).limit(1),i=null;a.length>0&&(i=a[0].id,s.status==="succeeded"&&await l.update(T).set({status:"confirmed",paymentStatus:"paid",paymentMethod:"card",paidAt:new Date}).where(ms(T.id,i))),t.json({success:!0,status:s.status,orderGroupId:i,amount:s.amount,currency:s.currency})}catch(e){console.error("Error checking payment status:",e),t.status(500).json({success:!1,message:"Failed to verify payment status"})}});var gs=fs;async function Ns(o){o.post("/api/art-locations",Tt.sendArtLocationData),o.get("/api/art-locations/:orderId",Tt.getArtLocationData),o.post("/api/frame-designs",$t.saveFrameDesign),o.get("/api/frame-designs/:orderId",$t.getFrameDesign),o.use("/api/webhooks",to),o.get("/api/health",(g,m)=>{m.json({status:"ok",timestamp:new Date().toISOString(),environment:"production"})}),o.get("/",(g,m)=>{m.set("Content-Type","application/json"),m.status(200).json({status:"healthy",service:"Jay's Frames POS System",timestamp:new Date().toISOString(),environment:"production",port:process.env.PORT||"5000"})}),o.get("/api/dashboard/config",(g,m)=>{let p=process.env.DASHBOARD_API_URL;m.json({configured:!!p,url:p?`${p.substring(0,30)}...`:null,fullUrl:p,message:p?"Dashboard API is configured and ready":"Dashboard API URL not configured. Add DASHBOARD_API_URL to your secrets.",endpoints:p?{metrics:`${p}/api/metrics`,orders:`${p}/api/orders`,status:`${p}/api/status`}:null})}),o.get("/api/dashboard-proxy/health",async(g,m)=>{let p=process.env.DASHBOARD_API_URL;if(!p)return m.status(400).json({error:"Dashboard API URL not configured"});try{let P=await(await fetch(`${p}/api/health`)).json();m.json(P)}catch(h){m.status(500).json({error:h.message})}}),o.get("/api/dashboard-proxy/metrics",async(g,m)=>{let p=process.env.DASHBOARD_API_URL;if(!p)return m.status(400).json({error:"Dashboard API URL not configured"});try{let h=await fetch(`${p}/api/metrics`);o.get("/api/recommendations/frames",async(S,y)=>{try{let k={artworkType:S.query.artworkType,artworkDescription:S.query.artworkDescription,artworkWidth:parseFloat(S.query.artworkWidth)||16,artworkHeight:parseFloat(S.query.artworkHeight)||20,colorPreference:S.query.colorPreference,stylePreference:S.query.stylePreference,budgetLevel:S.query.budgetLevel,roomDecor:S.query.roomDecor,customerPreference:S.query.customerPreference},G=await recommendationService.getRecommendations(k);y.json(G)}catch(k){console.error("Error getting frame recommendations:",k),y.status(500).json({error:"Failed to get recommendations",message:k.message})}}),o.post("/api/recommendations/from-image",async(S,y)=>{try{let{imageBase64:k,...G}=S.body;if(!k)return y.status(400).json({error:"Image data required"});let B=await recommendationService.getRecommendationsFromImage(k,G);y.json(B)}catch(k){console.error("Error getting image-based recommendations:",k),y.status(500).json({error:"Failed to analyze image",message:k.message})}});let P=await h.json();m.json(P)}catch(h){m.status(500).json({error:h.message})}}),o.get("/api/dashboard-proxy/status",async(g,m)=>{let p=process.env.DASHBOARD_API_URL;if(o.get("/api/ai/material-recommendations",async(h,P)=>{try{let y=await(await Promise.resolve().then(()=>(nr(),ar))).generateOrderingRecommendations();P.json({recommendations:y})}catch(S){console.error("Error getting material recommendations:",S),P.status(500).json({error:"Failed to generate recommendations",message:S.message})}}),o.get("/api/ai/seasonal-trends/:materialId",async(h,P)=>{try{let{materialId:S}=h.params,k=await(await Promise.resolve().then(()=>(nr(),ar))).getSeasonalTrends(S);P.json(k)}catch(S){console.error("Error getting seasonal trends:",S),P.status(500).json({error:"Failed to get trends",message:S.message})}}),!p)return m.status(400).json({error:"Dashboard API URL not configured"});try{let P=await(await fetch(`${p}/api/status`)).json();m.json(P)}catch(h){m.status(500).json({error:h.message})}}),o.post("/api/dashboard-proxy/test",async(g,m)=>{let p=process.env.DASHBOARD_API_URL;if(!p)return m.status(400).json({error:"Dashboard API URL not configured"});try{(await fetch(`${p}/api/health`)).ok?m.json({success:!0,message:"Dashboard connection successful"}):m.status(500).json({error:"Dashboard connection failed"})}catch(h){m.status(500).json({error:h.message})}}),o.all("/api/dashboard-proxy/*",async(g,m)=>{let p=process.env.DASHBOARD_API_URL;if(!p)return m.status(503).json({success:!1,error:"Dashboard API URL not configured. Please add DASHBOARD_API_URL to your secrets."});try{let h=g.params[0],P={method:g.method,headers:{"Content-Type":"application/json",...g.headers.authorization&&{Authorization:g.headers.authorization}}};["POST","PUT","PATCH"].includes(g.method)&&g.body&&(P.body=JSON.stringify(g.body));let S=await fetch(`${p}/${h}`,P);if(!S.ok)throw new Error(`Dashboard API responded with status: ${S.status}`);let y=await S.json();m.status(S.status).json(y)}catch(h){console.error("Dashboard API proxy error:",h),m.status(500).json({success:!1,error:"Failed to connect to Dashboard API",details:h instanceof Error?h.message:"Unknown error"})}}),o.get("/api/vendor-catalog/all",(g,m)=>{m.json([])}),o.get("/api/vendor-catalog/larson",(g,m)=>{m.json([])}),o.get("/api/vendor-catalog/roma",(g,m)=>{m.json([])}),o.get("/api/vendor-catalog/nielsen",(g,m)=>{m.json([])}),o.get("/api/larson-catalog/crescent",(g,m)=>{m.json([])}),o.get("/api/frames",(g,m)=>{m.json([])}),o.get("/api/mat-colors",(g,m)=>{m.json([])}),o.get("/api/glass-options",(g,m)=>{m.json([])}),o.get("/api/wholesale-orders",(g,m)=>{m.json([])}),o.get("/api/qr-codes",(g,m)=>{m.json([])}),o.get("/api/hub/material-orders",(g,m)=>{m.json([])}),o.get("/api/auth/status",(g,m)=>{m.json({authenticated:!1,user:null})}),o.get("/api/discord/bot-info",(g,m)=>{m.json({status:"disabled",message:"Discord integration temporarily disabled for deployment stability"})}),o.post("/api/discord/test-notification",async(g,m)=>{m.status(503).json({error:"Discord integration temporarily disabled",message:"Discord notifications are currently unavailable"})}),o.post("/api/notifications/send",async(g,m)=>{try{let{customerPhone:p,customerEmail:h,orderId:P,type:S,message:y,discordUserId:k}=g.body,{getCustomerByPhone:G,getCustomerByEmail:B,updateCustomerDiscordId:le}=await Promise.resolve().then(()=>(cr(),ir)),de=p?G(p):h?B(h):null;if(!de)return m.status(404).json({error:"Customer not found"});let nt=P||Math.floor(Math.random()*1e3)+100;console.log(`Notification request for customer ${de.name}: ${S} - ${y}`),m.json({success:!0,customer:{name:de.name,phone:de.phone,email:de.email,hasDiscord:!1},orderNumber:nt,message:"Notification logged (Discord integration disabled for deployment stability)"})}catch(p){console.error("Error sending customer notification:",p),m.status(500).json({error:"Failed to send notification",details:p instanceof Error?p.message:"Unknown error"})}}),o.get("/api/customers/search",async(g,m)=>{try{let{phone:p,email:h}=g.query,{getCustomerByPhone:P,getCustomerByEmail:S}=await Promise.resolve().then(()=>(cr(),ir)),y=p?P(p):h?S(h):null;if(!y)return m.status(404).json({error:"Customer not found"});m.json({customer:{id:y.id,name:y.name,phone:y.phone,email:y.email,hasDiscord:!!y.discordUserId,preferences:y.preferences,notes:y.notes}})}catch{m.status(500).json({error:"Failed to search customer"})}}),o.get("/api/kanban/external/orders",async(g,m)=>{try{let{externalKanbanService:p}=await Promise.resolve().then(()=>(at(),st)),h=await p.fetchOrders();m.json(h)}catch{m.status(500).json({success:!1,orders:[],error:"Failed to fetch orders from external Kanban app"})}}),o.get("/api/kanban/external/health",async(g,m)=>{try{let{externalKanbanService:p}=await Promise.resolve().then(()=>(at(),st)),h=await p.healthCheck();m.json(h)}catch{m.status(500).json({status:"error",connected:!1,error:"Failed to check external Kanban health"})}}),o.get("/api/integrations/test-all",async(g,m)=>{try{let p={dashboard:{connected:!1,error:null},kanban:{connected:!1,error:null}},h=process.env.DASHBOARD_API_URL;if(h)try{let y=await fetch(`${h}/api/health`,{method:"GET",timeout:5e3});p.dashboard.connected=y.ok,y.ok||(p.dashboard.error=`HTTP ${y.status}`)}catch(y){p.dashboard.error=y instanceof Error?y.message:"Connection failed"}else p.dashboard.error="Dashboard API URL not configured";let P=process.env.EXTERNAL_KANBAN_URL,S=process.env.EXTERNAL_KANBAN_API_KEY;if(P&&S)try{let y=await fetch(`${P}/api/health`,{method:"GET",headers:{Authorization:`Bearer ${S}`,"Content-Type":"application/json"},timeout:5e3});p.kanban.connected=y.ok,y.ok||(p.kanban.error=`HTTP ${y.status}`)}catch(y){p.kanban.error=y instanceof Error?y.message:"Connection failed"}else p.kanban.error="Kanban API URL or API Key not configured";m.json({success:!0,integrations:p,summary:{total:2,connected:Object.values(p).filter(y=>y.connected).length,failed:Object.values(p).filter(y=>!y.connected).length}})}catch{m.status(500).json({success:!1,error:"Failed to test integrations"})}}),o.post("/api/kanban/external/test-connection",async(g,m)=>{try{let{externalKanbanService:p}=await Promise.resolve().then(()=>(at(),st)),h=!!process.env.EXTERNAL_KANBAN_URL,P=!!process.env.EXTERNAL_KANBAN_API_KEY;if(!h||!P)return m.status(400).json({success:!1,error:"Kanban configuration incomplete",details:{hasUrl:h,hasApiKey:P,message:"Please add EXTERNAL_KANBAN_URL and EXTERNAL_KANBAN_API_KEY to your secrets"}});let S=await p.healthCheck(),y=await p.fetchOrders();m.json({success:S.connected,health:S,ordersTest:{success:y.success,orderCount:y.orders.length,error:y.error},configuration:{baseUrl:process.env.EXTERNAL_KANBAN_URL?`${process.env.EXTERNAL_KANBAN_URL.substring(0,30)}...`:"Not configured",apiKeyConfigured:!!process.env.EXTERNAL_KANBAN_API_KEY}})}catch(p){m.status(500).json({success:!1,error:"Connection test failed",details:p instanceof Error?p.message:"Unknown error"})}}),o.post("/api/kanban/external/orders/:orderId/status",async(g,m)=>{try{let{orderId:p}=g.params,{status:h,stage:P,notes:S}=g.body,{externalKanbanService:y}=await Promise.resolve().then(()=>(at(),st));await y.updateOrderStatus(p,h,P,S)?m.json({success:!0,orderId:p,updatedStatus:h,stage:P,notes:S,timestamp:new Date().toISOString()}):m.status(500).json({success:!1,error:"Failed to update order status in external Kanban"})}catch{m.status(500).json({success:!1,error:"Failed to update external Kanban order status"})}}),o.get("/api/kanban/api-key",(g,m)=>{m.json({success:!0,message:"Use one of these API keys for integration",apiKeys:[{key:"kanban_admin_key_2025_full_access",name:"3D Designer Integration",permissions:["orders:create","orders:read","orders:update","pricing:read","files:upload"]},{key:"jf_houston_heights_framing_2025_master_api_key_secure_access",name:"Houston Heights Framing API Integration",permissions:["orders:read","orders:write","integration:webhook","pricing:read","catalog:read"]}],usage:{header:"Authorization",format:"Bearer YOUR_API_KEY"},endpoints:{baseUrl:process.env.REPL_URL||"https://your-repl-name.replit.app",orders:"/api/kanban/orders",status:"/api/kanban/status"}})});let t=process.env.POS_API_KEY||"jays_frames_kanban_2025";o.get("/api/kanban/orders",qt,(g,m)=>{m.json({success:!0,orders:[],endpoint:"/api/kanban/orders",description:"Retrieves all orders with production status and timeline information"})}),o.post("/api/kanban/orders/:orderId/status",qt,(g,m)=>{let{orderId:p}=g.params,{status:h,stage:P,notes:S}=g.body;m.json({success:!0,orderId:p,updatedStatus:h,stage:P,notes:S,timestamp:new Date().toISOString(),description:"Updates order production status from external Kanban system"})}),o.get("/api/kanban/status",(g,m)=>{m.json({status:"active",service:"Jays Frames POS System",version:"1.0.0",endpoints:{orders:"/api/kanban/orders",updateStatus:"/api/kanban/orders/:orderId/status",health:"/api/kanban/status"},authentication:"API Key required in Authorization header",timestamp:new Date().toISOString()})}),o.get("/api/kanban/api-key",(g,m)=>{m.json({apiKey:t,usage:"Add this to your Kanban app Authorization header as: Bearer "+t,endpoints:{orders:"/api/kanban/orders",updateStatus:"/api/kanban/orders/:orderId/status"},note:"Keep this API key secure - it provides access to your order data"})}),o.use("/api/hub",ro),o.use("/api/hub-admin",Ut),o.use("/api/admin",Ut),o.post("/api/admin/generate-api-key",async(g,m)=>{try{let{generateApiKey:p}=await Promise.resolve().then(()=>(Fe(),Xe));await p(g,m)}catch(p){console.error("Error in generate-api-key route:",p),m.status(500).json({success:!1,error:p.message})}}),o.get("/api/admin/integration-status",async(g,m)=>{try{let{getIntegrationStatus:p}=await Promise.resolve().then(()=>(Fe(),Xe));await p(g,m)}catch(p){console.error("Error in integration-status route:",p),m.status(500).json({success:!1,error:p.message})}}),o.get("/api/admin/integration-docs",async(g,m)=>{try{let{getIntegrationDocs:p}=await Promise.resolve().then(()=>(Fe(),Xe));await p(g,m)}catch(p){console.error("Error in integration-docs route:",p),m.status(500).json({success:!1,error:p.message})}}),o.get("/api/webhooks",async(g,m)=>{try{m.json({success:!0,webhooks:[]})}catch(p){console.error("Error in webhooks route:",p),m.status(500).json({success:!1,error:p.message})}}),o.use("/api",Ao),o.use("/api",Mo),o.use("/api",Uo),o.use("/api/integration",yo),o.use("/api/xml-price-sheets",zo),o.use("/api/larson-optimizer",es),o.use("/api/test-email",ts),o.use("/api/voice-calls",us),o.use("/api/twiml",ls),o.use("/api/order-notifications",ds),o.use("/api",gs),o.get("/api/discord/status",(g,m)=>{m.json({status:"disabled",message:"Discord integration disabled for deployment stability"})}),o.get("/api/notifications/status",(g,m)=>{m.json({status:"basic",channels:["email"],message:"Basic notifications only"})}),o.get("/api/materials/pick-list",ao),o.get("/api/materials/by-supplier",no),o.get("/api/materials/order/:orderId",io),o.put("/api/materials/:id",co),o.post("/api/materials/purchase-order",uo),o.get("/api/materials/types",lo),o.get("/api/materials/suppliers",mo),o.post("/api/materials/bulk-update",async(g,m)=>{try{let{materialIds:p,status:h,adminApproval:P}=g.body;if(!p||!Array.isArray(p)||p.length===0)return m.status(400).json({error:"Material IDs are required"});if(!h)return m.status(400).json({error:"Status is required"});let k=(await w.getMaterialsPickList()).filter(B=>p.includes(B.id.toString())).filter(B=>B.status==="ordered"||B.status==="arrived"||B.status==="completed");if(k.length>0&&!P)return m.status(409).json({error:"DOUBLE_ORDER_PREVENTION",message:"Materials already ordered. Admin approval required.",alreadyOrderedMaterials:k});let G=[];for(let B of p)try{let le=await w.updateMaterialOrder(parseInt(B),{status:h,notes:P?"Admin approved override for duplicate order":void 0});G.push(le)}catch(le){console.error(`Failed to update material ${B}:`,le)}m.json({message:`Successfully updated ${G.length} materials to ${h}`,updatedMaterials:G,adminApproval:P||!1})}catch(p){console.error("Error in bulk update:",p),m.status(500).json({error:"Failed to update materials"})}}),o.post("/api/materials/mark-out-of-stock",async(g,m)=>{try{let{materialIds:p,notes:h}=g.body;if(!p||!Array.isArray(p)||p.length===0)return m.status(400).json({error:"Material IDs are required"});let P=[];for(let S of p)try{let y=await w.updateMaterialOrder(parseInt(S),{status:"out_of_stock",notes:h||"Marked as out of stock"});P.push(y)}catch(y){console.error(`Failed to mark material ${S} as out of stock:`,y)}m.json({message:`Successfully marked ${P.length} materials as out of stock`,updatedMaterials:P})}catch(p){console.error("Error marking materials as out of stock:",p),m.status(500).json({error:"Failed to mark materials as out of stock"})}}),o.post("/api/orders/:orderId/generate-materials",async(g,m)=>{try{let p=parseInt(g.params.orderId);if(!p||isNaN(p))return m.status(400).json({error:"Valid order ID is required"});console.log(`Generating materials for order ID: ${p}`);let h=await w.getOrder(p);if(!h)return m.status(404).json({error:"Order not found"});console.log("Found order:",h);let P=await w.createMaterialOrdersFromorder(h);console.log(`Generated ${P.length} material orders`),m.json({success:!0,message:`Generated ${P.length} material orders for order #${p}`,materialOrders:P})}catch(p){console.error("Error generating materials for order:",p),m.status(500).json({success:!1,error:p.message||"Failed to generate material orders"})}}),o.post("/api/orders/generate-all-materials",async(g,m)=>{try{let p=await w.getAllOrders(),h=0,P=0;for(let S of p)try{let y=await w.createMaterialOrdersFromOrder(S);h+=y.length,P++}catch(y){console.error(`Error creating materials for order ${S.id}:`,y)}m.json({success:!0,message:`Generated ${h} material orders from ${P} orders`,totalMaterialOrders:h,processedOrders:P})}catch(p){console.error("Error generating materials for all orders:",p),m.status(500).json({error:p.message})}}),o.post("/api/create-payment-intent",async(g,m)=>{try{let{orderGroupId:p,amount:h}=g.body;if(!p||!h)return m.status(400).json({success:!1,message:"Order group ID and amount are required"});let P=Math.round(Number(h)*100);if(isNaN(P)||P<=0)return m.status(400).json({success:!1,message:"Valid amount is required"});if(!process.env.STRIPE_SECRET_KEY)return m.status(500).json({success:!1,message:"Stripe is not configured. Please contact support."});let y=await new Stripe(process.env.STRIPE_SECRET_KEY).paymentIntents.create({amount:P,currency:"usd",automatic_payment_methods:{enabled:!0},metadata:{orderGroupId:p.toString(),businessName:"Jay's Frames"},description:`Order #${p} - Jay's Frames`});m.json({success:!0,clientSecret:y.client_secret,amount:P})}catch(p){console.error("Error creating payment intent:",p),m.status(500).json({success:!1,message:"Failed to create payment intent",error:p instanceof Error?p.message:"Unknown error"})}});let{createNewPaymentLink:e,getAllPaymentLinks:r,getPaymentLinkById:s,sendPaymentLinkNotification:a,validatePaymentLinkByToken:i,completePaymentForLink:d,verifyPaymentCompletion:c}=await Promise.resolve().then(()=>(Cs(),_s));o.post("/api/payment-links",e),o.get("/api/payment-links",r),o.get("/api/payment-links/:id",s),o.post("/api/payment-links/:id/send",a),o.get("/api/payment/:token/validate",i),o.post("/api/payment/:token/complete",d),o.post("/api/payment/:token/verify",c);let f=Pi(o),C=new Si({server:f,path:"/ws"});return C.on("connection",g=>{console.log("WebSocket client connected"),g.on("message",m=>{try{console.log("Received message:",m.toString()),C.clients.forEach(p=>{p.readyState===xi.OPEN&&p.send(m.toString())})}catch(p){console.error("WebSocket message error:",p)}}),g.send(JSON.stringify({type:"connection",message:"WebSocket connection established"}))}),f}n(Ns,"registerRoutes");sr();import Ii from"path";import As from"fs";import{fileURLToPath as vi}from"url";import{dirname as Oi}from"path";import ki from"cors";var _i=vi(import.meta.url),Sm=Oi(_i),Y=It(),xt=parseInt(process.env.PORT||"5000",10);Y.use(ki({origin:["http://localhost:5173","http://localhost:3000","http://localhost:5000","https://localhost:5173",process.env.REPL_URL||"",process.env.FRONTEND_URL||"",/https:\/\/.*\.replit\.dev$/,/https:\/\/.*\.replit\.app$/,/https:\/\/.*\.repl\.co$/],credentials:!0,methods:["GET","POST","PUT","DELETE","PATCH","OPTIONS"],allowedHeaders:["Content-Type","Authorization","X-Requested-With"]}));Y.get("/",(o,t)=>{t.set("Content-Type","application/json"),t.status(200).json({status:"healthy",service:"Jay's Frames POS System",timestamp:new Date().toISOString(),environment:"production",port:xt})});Y.get("/health",(o,t)=>{t.set("Content-Type","application/json"),t.status(200).json({status:"ok",timestamp:new Date().toISOString()})});Y.get("/ready",(o,t)=>{t.set("Content-Type","application/json"),t.status(200).json({ready:!0,timestamp:new Date().toISOString()})});Y.use(It.json({limit:"100mb"}));Y.use(It.urlencoded({extended:!0,limit:"100mb"}));Y.use((o,t,e)=>{let r=Date.now(),s=o.path,a,i=t.json;t.json=function(d,...c){return a=d,i.apply(t,[d,...c])},t.on("finish",()=>{let d=Date.now()-r;if(s.startsWith("/api")){let c=`${o.method} ${s} ${t.statusCode} in ${d}ms`;a&&(c+=` :: ${JSON.stringify(a)}`),c.length>80&&(c=c.slice(0,79)+"\u2026"),q(c)}}),e()});(async()=>{let o=await Ns(Y);Y.use((r,s,a,i)=>{let d=r.status||r.statusCode||500,c=r.message||"Internal Server Error";a.status(d).json({message:c}),q(`Error: ${c} (${d})`,"error"),console.error(r)}),Y.get("env")==="development"?await Ps(Y,o):Ss(Y);let t=n(()=>{try{let r=o.listen(xt,"0.0.0.0",()=>{q(`serving on port ${xt}`),console.log(`\u2713 Server running on port ${xt}`),console.log("\u2713 Environment: production"),console.log("\u2713 Ready for connections")});r.on("error",a=>{q(`Server startup error: ${a.message}`,"error"),console.error("Server error:",a),process.exit(1)});let s=n(a=>{q(`${a} received, shutting down gracefully`,"info"),console.log("Shutting down server..."),r.close(i=>{i?(console.error("Error during shutdown:",i),process.exit(1)):(q("Server closed","info"),console.log("Server closed gracefully"),process.exit(0))}),setTimeout(()=>{console.log("Force exit after timeout"),process.exit(1)},1e4)},"gracefulShutdown");return process.on("SIGTERM",()=>s("SIGTERM")),process.on("SIGINT",()=>s("SIGINT")),r}catch(r){q(`Critical server startup failure: ${r?.message||r}`,"error"),console.error("Critical error:",r),process.exit(1)}},"startServer"),e=Ii.join(process.cwd(),"uploads");try{As.existsSync(e)||As.mkdirSync(e,{recursive:!0})}catch(r){q(`Warning: Could not create uploads directory: ${r}`,"warning")}Y.use("/uploads",It.static(e)),t()})();
