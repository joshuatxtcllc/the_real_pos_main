var it=Object.defineProperty;var _s=Object.getOwnPropertyDescriptor;var Cs=Object.getOwnPropertyNames;var Ns=Object.prototype.hasOwnProperty;var As=(o,t,e)=>t in o?it(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var M=(o,t)=>()=>(o&&(t=o(o=0)),t);var oe=(o,t)=>{for(var e in t)it(o,e,{get:t[e],enumerable:!0})},Es=(o,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Cs(t))!Ns.call(o,s)&&s!==e&&it(o,s,{get:()=>t[s],enumerable:!(r=_s(t,s))||r.enumerable});return o};var gr=o=>Es(it({},"__esModule",{value:!0}),o);var It=(o,t,e)=>As(o,typeof t!="symbol"?t+"":t,e);var Ct={};oe(Ct,{customerNotifications:()=>B,customers:()=>C,frames:()=>T,glassOptions:()=>se,insertCustomerNotificationSchema:()=>Vs,insertCustomerSchema:()=>vt,insertFrameSchema:()=>js,insertGlassOptionSchema:()=>Fs,insertInventoryCategorySchema:()=>Xs,insertInventoryCountItemSchema:()=>ca,insertInventoryCountSchema:()=>ia,insertInventoryItemSchema:()=>ta,insertInventoryLocationSchema:()=>ct,insertInventoryTransactionSchema:()=>oa,insertLarsonJuhlCatalogSchema:()=>Gs,insertMatColorSchema:()=>Ms,insertMaterialLocationSchema:()=>da,insertMaterialOrderSchema:()=>Zs,insertNotificationSchema:()=>ma,insertOrderFrameSchema:()=>Ws,insertOrderGroupSchema:()=>Ts,insertOrderMatSchema:()=>Bs,insertOrderSchema:()=>Ls,insertOrderSpecialServiceSchema:()=>qs,insertPaymentLinkSchema:()=>ua,insertPurchaseOrderLineSchema:()=>na,insertPurchaseOrderSchema:()=>aa,insertQrCodeScanSchema:()=>wr,insertQrCodeSchema:()=>br,insertSpecialServiceSchema:()=>Ds,insertSupplierSchema:()=>Js,insertUserSchema:()=>Hs,insertWholesaleOrderSchema:()=>Us,inventoryCategories:()=>he,inventoryCountItems:()=>hr,inventoryCounts:()=>Ot,inventoryItems:()=>j,inventoryLocations:()=>R,inventoryTransactions:()=>pe,larsonJuhlCatalog:()=>yr,matColors:()=>X,materialLocations:()=>_t,materialOrderStatuses:()=>Qs,materialOrders:()=>x,materialTypes:()=>Ys,measurementUnits:()=>ea,notificationChannels:()=>zs,notificationTypes:()=>Ks,notifications:()=>U,orderFrames:()=>We,orderGroups:()=>D,orderMats:()=>Be,orderSpecialServices:()=>Ce,orders:()=>v,paymentLinks:()=>E,productionStatuses:()=>$s,purchaseOrderLines:()=>ut,purchaseOrderStatuses:()=>sa,purchaseOrders:()=>ie,qrCodeScans:()=>kt,qrCodeTypes:()=>la,qrCodes:()=>Ne,specialServices:()=>ae,suppliers:()=>W,transactionTypes:()=>ra,users:()=>me,wholesaleOrders:()=>ne});import{pgTable as N,text as c,serial as F,integer as k,boolean as $,numeric as S,timestamp as I,jsonb as qe,primaryKey as Rs}from"drizzle-orm/pg-core";import{createInsertSchema as A}from"drizzle-zod";var C,vt,T,js,X,Ms,se,Fs,ae,Ds,D,Ts,$s,v,Ls,Ce,qs,Be,Bs,We,Ws,ne,Us,me,Hs,yr,Gs,Ks,zs,B,Vs,Ys,Qs,x,Zs,W,Js,he,Xs,R,ct,ea,j,ta,ra,pe,oa,sa,ie,aa,ut,na,Ot,ia,hr,ca,E,ua,la,Ne,br,kt,wr,_t,da,U,ma,V=M(()=>{"use strict";C=N("customers",{id:F("id").primaryKey(),name:c("name").notNull(),email:c("email"),phone:c("phone"),address:c("address"),stripeCustomerId:c("stripe_customer_id"),createdAt:I("created_at").defaultNow()}),vt=A(C).omit({id:!0,createdAt:!0}),T=N("frames",{id:c("id").primaryKey(),name:c("name").notNull(),manufacturer:c("manufacturer").notNull(),material:c("material").notNull(),width:S("width").notNull(),depth:S("depth").notNull(),price:S("price").notNull(),catalogImage:c("catalog_image").notNull(),edgeTexture:c("edge_texture"),corner:c("corner")}),js=A(T),X=N("mat_colors",{id:c("id").primaryKey(),name:c("name").notNull(),color:c("color").notNull(),price:S("price").notNull(),manufacturer:c("manufacturer"),code:c("code"),description:c("description"),category:c("category")}),Ms=A(X),se=N("glass_options",{id:c("id").primaryKey(),name:c("name").notNull(),description:c("description").notNull(),price:S("price").notNull()}),Fs=A(se),ae=N("special_services",{id:c("id").primaryKey(),name:c("name").notNull(),description:c("description").notNull(),price:S("price").notNull()}),Ds=A(ae),D=N("order_groups",{id:F("id").primaryKey(),customerId:k("customer_id").references(()=>C.id),subtotal:S("subtotal"),tax:S("tax"),total:S("total"),status:c("status").notNull().default("open"),paymentMethod:c("payment_method"),notes:c("notes"),createdAt:I("created_at").defaultNow(),stripePaymentIntentId:c("stripe_payment_intent_id"),stripePaymentStatus:c("stripe_payment_status"),paymentDate:I("payment_date"),discountAmount:S("discount_amount"),discountType:c("discount_type"),taxExempt:$("tax_exempt").default(!1),cashAmount:S("cash_amount"),checkNumber:c("check_number"),invoiceEmailSent:$("invoice_email_sent").default(!1),invoiceEmailDate:I("invoice_email_date")}),Ts=A(D).omit({id:!0,createdAt:!0}),$s=["order_processed","scheduled","materials_ordered","materials_arrived","frame_cut","mat_cut","prepped","completed","delayed"],v=N("orders",{id:F("id").primaryKey(),customerId:k("customer_id").references(()=>C.id),orderGroupId:k("order_group_id").references(()=>D.id),frameId:c("frame_id").references(()=>T.id),matColorId:c("mat_color_id").references(()=>X.id),glassOptionId:c("glass_option_id").references(()=>se.id),artworkWidth:S("artwork_width").notNull(),artworkHeight:S("artwork_height").notNull(),matWidth:S("mat_width").notNull(),artworkDescription:c("artwork_description"),artworkType:c("artwork_type"),artworkLocation:c("artwork_location"),quantity:k("quantity").notNull().default(1),subtotal:S("subtotal").notNull(),tax:S("tax").notNull(),total:S("total").notNull(),status:c("status").notNull().default("pending"),productionStatus:c("production_status").$type().notNull().default("order_processed"),previousStatus:c("previous_status").$type(),createdAt:I("created_at").defaultNow(),dueDate:I("due_date"),artworkImage:c("artwork_image"),frameDesignImage:c("frame_design_image"),lastNotificationSent:I("last_notification_sent"),estimatedCompletionDays:k("estimated_completion_days"),addToWholesaleOrder:$("add_to_wholesale_order").default(!1),lastStatusChange:I("last_status_change").defaultNow(),notificationsEnabled:$("notifications_enabled").default(!0),useMultipleMats:$("use_multiple_mats").default(!1),useMultipleFrames:$("use_multiple_frames").default(!1),useManualFrame:$("use_manual_frame").default(!1),manualFrameName:c("manual_frame_name"),manualFrameCost:S("manual_frame_cost"),miscChargeDescription:c("misc_charge_description"),miscChargeAmount:S("misc_charge_amount")}),Ls=A(v).omit({id:!0,createdAt:!0}),Ce=N("order_special_services",{orderId:k("order_id").references(()=>v.id),specialServiceId:c("special_service_id").references(()=>ae.id)},o=>({pk:Rs({columns:[o.orderId,o.specialServiceId]})})),qs=A(Ce),Be=N("order_mats",{id:F("id").primaryKey(),orderId:k("order_id").references(()=>v.id).notNull(),matColorId:c("mat_color_id").references(()=>X.id).notNull(),position:k("position").notNull(),width:S("width").notNull(),offset:S("offset").notNull().default("0"),createdAt:I("created_at").defaultNow()}),Bs=A(Be).omit({id:!0,createdAt:!0}),We=N("order_frames",{id:F("id").primaryKey(),orderId:k("order_id").references(()=>v.id).notNull(),frameId:c("frame_id").references(()=>T.id).notNull(),position:k("position").notNull(),distance:S("distance").notNull().default("0"),createdAt:I("created_at").defaultNow()}),Ws=A(We).omit({id:!0,createdAt:!0}),ne=N("wholesale_orders",{id:F("id").primaryKey(),orderId:k("order_id").references(()=>v.id),manufacturer:c("manufacturer").notNull(),items:qe("items").notNull(),status:c("status").notNull().default("pending"),createdAt:I("created_at").defaultNow()}),Us=A(ne).omit({id:!0,createdAt:!0}),me=N("users",{id:F("id").primaryKey(),username:c("username").notNull().unique(),password:c("password").notNull(),role:c("role").notNull().default("employee")}),Hs=A(me).omit({id:!0}),yr=N("larson_juhl_catalog",{id:c("id").primaryKey(),name:c("name").notNull(),hex_color:c("hex_color"),price:S("price",{precision:10,scale:6}).notNull(),code:c("code").notNull(),crescent_code:c("crescent_code"),description:c("description"),category:c("category"),manufacturer:c("manufacturer").notNull(),type:c("type").notNull().default("matboard"),material:c("material"),width:S("width"),depth:S("depth"),edge_texture:c("edge_texture"),corner:c("corner"),catalog_image:c("catalog_image"),createdAt:I("created_at").defaultNow()}),Gs=A(yr).omit({createdAt:!0}),Ks=["status_update","estimated_completion","status_change","due_date_update","completion_reminder","order_complete","payment_reminder","delay_notification","payment_link"],zs=["email","sms","both"],B=N("customer_notifications",{id:F("id").primaryKey(),customerId:k("customer_id").references(()=>C.id),orderId:k("order_id").references(()=>v.id),notificationType:c("notification_type").$type().notNull(),channel:c("channel").$type().notNull().default("email"),subject:c("subject").notNull(),message:c("message").notNull(),sentAt:I("sent_at").defaultNow(),successful:$("successful").notNull(),responseData:qe("response_data"),previousStatus:c("previous_status"),newStatus:c("new_status"),paymentLinkId:k("payment_link_id")}),Vs=A(B).omit({id:!0,sentAt:!0}),Ys=["frame","matboard","glass","backing_board","hardware","specialty_materials"],Qs=["pending","processed","ordered","arrived","frame_cut","mat_cut","prepped","completed","delayed","canceled"],x=N("material_orders",{id:F("id").primaryKey(),materialType:c("material_type").$type().notNull(),materialId:c("material_id").notNull(),materialName:c("material_name").notNull(),quantity:S("quantity").notNull(),status:c("status").$type().notNull().default("pending"),sourceOrderId:k("source_order_id").references(()=>v.id),orderDate:I("order_date"),expectedArrival:I("expected_arrival"),actualArrival:I("actual_arrival"),supplierName:c("supplier_name"),supplierOrderNumber:c("supplier_order_number"),notes:c("notes"),costPerUnit:S("cost_per_unit"),totalCost:S("total_cost"),priority:c("priority").default("normal"),hubOrderId:c("hub_order_id"),hubSyncStatus:c("hub_sync_status").default("not_synced"),hubLastSyncDate:I("hub_last_sync_date"),hubTrackingInfo:c("hub_tracking_info"),hubEstimatedDelivery:I("hub_estimated_delivery"),hubSupplierNotes:c("hub_supplier_notes"),orderReference:c("order_reference"),unitMeasurement:c("unit_measurement"),createdAt:I("created_at").defaultNow()}),Zs=A(x).omit({id:!0,createdAt:!0,hubOrderId:!0,hubSyncStatus:!0,hubLastSyncDate:!0,hubTrackingInfo:!0,hubEstimatedDelivery:!0,hubSupplierNotes:!0}),W=N("suppliers",{id:F("id").primaryKey(),name:c("name").notNull(),contactName:c("contact_name"),email:c("email"),phone:c("phone"),address:c("address"),website:c("website"),accountNumber:c("account_number"),notes:c("notes"),paymentTerms:c("payment_terms"),minimumOrderAmount:S("minimum_order_amount"),shippingPreference:c("shipping_preference"),leadTime:k("lead_time"),active:$("active").default(!0),createdAt:I("created_at").defaultNow(),lastOrderDate:I("last_order_date")}),Js=A(W).omit({id:!0,createdAt:!0}),he=N("inventory_categories",{id:F("id").primaryKey(),name:c("name").notNull(),description:c("description"),parentCategoryId:k("parent_category_id").references(()=>he.id),createdAt:I("created_at").defaultNow()}),Xs=A(he).omit({id:!0,createdAt:!0}),R=N("inventory_locations",{id:F("id").primaryKey(),name:c("name").notNull(),description:c("description"),type:c("type"),parentLocationId:k("parent_location_id").references(()=>R.id),active:$("active").default(!0),createdAt:I("created_at").defaultNow()}),ct=A(R).omit({id:!0,createdAt:!0}),ea=["each","inch","foot","united_inch","square_inch","sheet","roll","pound","liter","gallon"],j=N("inventory_items",{id:F("id").primaryKey(),sku:c("sku").notNull().unique(),name:c("name").notNull(),description:c("description"),categoryId:k("category_id").references(()=>he.id),supplierId:k("supplier_id").references(()=>W.id),supplierSku:c("supplier_sku"),unitOfMeasure:c("unit_of_measure").$type().notNull(),costPerUnit:S("cost_per_unit").notNull(),retailPrice:S("retail_price"),minimumStockLevel:S("minimum_stock_level").notNull(),reorderLevel:S("reorder_level").notNull(),reorderQuantity:S("reorder_quantity"),locationId:k("location_id").references(()=>R.id),barcode:c("barcode"),notes:c("notes"),tags:c("tags").array(),isActive:$("is_active").default(!0),createdAt:I("created_at").defaultNow(),updatedAt:I("updated_at").defaultNow(),lastCountDate:I("last_count_date"),imageUrl:c("image_url"),dimensions:qe("dimensions"),autoBatchReorder:$("auto_batch_reorder").default(!1),materialType:c("material_type").$type(),materialId:c("material_id")}),ta=A(j).omit({id:!0,createdAt:!0,updatedAt:!0}),ra=["purchase","sale","adjustment","return","transfer","count","scrap","initial"],pe=N("inventory_transactions",{id:F("id").primaryKey(),itemId:k("item_id").references(()=>j.id).notNull(),type:c("type").$type().notNull(),quantity:S("quantity").notNull(),unitCost:S("unit_cost"),locationId:k("location_id").references(()=>R.id),relatedOrderId:k("related_order_id").references(()=>v.id),notes:c("notes"),referenceNumber:c("reference_number"),createdAt:I("created_at").defaultNow(),createdBy:k("created_by").references(()=>me.id)}),oa=A(pe).omit({id:!0,createdAt:!0}),sa=["draft","pending","approved","sent","partially_received","received","canceled"],ie=N("purchase_orders",{id:F("id").primaryKey(),poNumber:c("po_number").notNull(),supplierId:k("supplier_id").references(()=>W.id).notNull(),orderDate:I("order_date").notNull(),expectedDeliveryDate:I("expected_delivery_date"),status:c("status").$type().default("draft").notNull(),subtotal:S("subtotal"),tax:S("tax"),shipping:S("shipping"),total:S("total"),notes:c("notes"),createdBy:k("created_by").references(()=>me.id),createdAt:I("created_at").defaultNow(),updatedAt:I("updated_at").defaultNow(),receivedDate:I("received_date"),supplierOrderConfirmation:c("supplier_order_confirmation"),shippingMethod:c("shipping_method"),paymentMethod:c("payment_method"),paymentTerms:c("payment_terms"),tracking:c("tracking"),attachments:c("attachments").array()}),aa=A(ie).omit({id:!0,createdAt:!0,updatedAt:!0}),ut=N("purchase_order_lines",{id:F("id").primaryKey(),purchaseOrderId:k("purchase_order_id").references(()=>ie.id).notNull(),itemId:k("item_id").references(()=>j.id).notNull(),quantity:S("quantity").notNull(),unitCost:S("unit_cost").notNull(),lineTotal:S("line_total").notNull(),receivedQuantity:S("received_quantity").default("0"),notes:c("notes"),createdAt:I("created_at").defaultNow()}),na=A(ut).omit({id:!0,createdAt:!0}),Ot=N("inventory_counts",{id:F("id").primaryKey(),countReference:c("count_reference").notNull(),startDate:I("start_date").notNull(),endDate:I("end_date"),status:c("status").default("in_progress").notNull(),notes:c("notes"),createdBy:k("created_by").references(()=>me.id),createdAt:I("created_at").defaultNow()}),ia=A(Ot).omit({id:!0,createdAt:!0}),hr=N("inventory_count_items",{id:F("id").primaryKey(),countId:k("count_id").references(()=>Ot.id).notNull(),itemId:k("item_id").references(()=>j.id).notNull(),locationId:k("location_id").references(()=>R.id),expectedQuantity:S("expected_quantity"),actualQuantity:S("actual_quantity"),notes:c("notes"),countedBy:k("counted_by").references(()=>me.id),countedAt:I("counted_at"),createdAt:I("created_at").defaultNow()}),ca=A(hr).omit({id:!0,createdAt:!0}),E=N("payment_links",{id:F("id").primaryKey(),token:c("token").notNull().unique(),amount:S("amount",{precision:10,scale:2}).notNull(),description:c("description"),customerId:k("customer_id").references(()=>C.id),createdAt:I("created_at").defaultNow(),expiresAt:I("expires_at").notNull(),usedAt:I("used_at"),used:$("used").default(!1),paymentIntentId:c("payment_intent_id"),paymentStatus:c("payment_status").default("pending")}),ua=A(E).omit({id:!0,createdAt:!0,usedAt:!0,used:!0,paymentIntentId:!0,paymentStatus:!0}),la=["inventory_location","inventory_item","material_order","customer_order","production_status","artwork_location"],Ne=N("qr_codes",{id:F("id").primaryKey(),code:c("code").notNull().unique(),type:c("type").$type().notNull(),entityId:c("entity_id").notNull(),title:c("title").notNull(),description:c("description"),metadata:qe("metadata"),createdAt:I("created_at").defaultNow(),lastScanned:I("last_scanned"),scanCount:k("scan_count").default(0),active:$("active").default(!0)}),br=A(Ne).omit({id:!0,createdAt:!0,lastScanned:!0,scanCount:!0}),kt=N("qr_code_scans",{id:F("id").primaryKey(),qrCodeId:k("qr_code_id").references(()=>Ne.id).notNull(),userId:k("user_id").references(()=>me.id),scannedAt:I("scanned_at").defaultNow(),location:c("location"),action:c("action"),metadata:qe("metadata")}),wr=A(kt).omit({id:!0,scannedAt:!0}),_t=N("material_locations",{id:F("id").primaryKey(),materialType:c("material_type").$type().notNull(),materialId:c("material_id").notNull(),locationId:k("location_id").references(()=>R.id).notNull(),qrCodeId:k("qr_code_id").references(()=>Ne.id),quantity:S("quantity").notNull().default("1"),notes:c("notes"),lastUpdated:I("last_updated").defaultNow(),active:$("active").default(!0)}),da=A(_t).omit({id:!0,lastUpdated:!0}),U=N("notifications",{id:F("id").primaryKey(),title:c("title").notNull(),description:c("description").notNull(),source:c("source").notNull(),sourceId:c("source_id"),type:c("type").$type().notNull().default("info"),createdAt:I("created_at").defaultNow(),read:$("read").default(!1),actionable:$("actionable").default(!1),link:c("link"),smsEnabled:$("sms_enabled").default(!1),smsRecipient:c("sms_recipient"),userId:k("user_id").references(()=>me.id)}),ma=A(U).omit({id:!0,createdAt:!0})});var Ue,Pr=M(()=>{"use strict";Ue=[{id:"larson-4512",name:"Larson Gold Leaf 4512",manufacturer:"Larson-Juhl",material:"wood",width:"2.5",depth:"1.75",price:"12.99",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#D4AF37"},{id:"larson-210286",name:"Larson Academie Black 210286",manufacturer:"Larson-Juhl",material:"wood",width:"1.25",depth:"0.75",price:"8.50",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#000000"},{id:"larson-655320",name:"Larson Biltmore Gold 655320",manufacturer:"Larson-Juhl",material:"wood",width:"1.5",depth:"0.875",price:"10.75",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#FFD700"},{id:"larson-460530",name:"Larson Ventura Silver 460530",manufacturer:"Larson-Juhl",material:"metal",width:"0.75",depth:"1.125",price:"9.25",catalogImage:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#C0C0C0"},{id:"larson-310445",name:"Larson Classic Walnut 310445",manufacturer:"Larson-Juhl",material:"wood",width:"2.0",depth:"1.25",price:"14.50",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#8B4513"},{id:"larson-220158",name:"Larson Heritage Cherry 220158",manufacturer:"Larson-Juhl",material:"wood",width:"1.75",depth:"1.0",price:"11.25",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#722F37"},{id:"nielsen-71",name:"Nielsen Florentine",manufacturer:"Nielsen",material:"metal",width:"1.25",depth:"0.75",price:"8.99",catalogImage:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#C0C0C0"},{id:"roma-250",name:"Roma Dark Walnut",manufacturer:"Roma Moulding",material:"wood",width:"3.0",depth:"2.0",price:"14.50",catalogImage:"https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#5C4033"},{id:"omega-102",name:"Omega Black Satin",manufacturer:"Omega Moulding",material:"wood",width:"2.0",depth:"1.5",price:"9.75",catalogImage:"https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#2D2D2D"},{id:"bella-35",name:"Bella White Simple",manufacturer:"Bella Moulding",material:"composite",width:"1.5",depth:"1.0",price:"6.50",catalogImage:"https://images.unsplash.com/photo-1574117936532-46e544aeb239?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjZ8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1574117936532-46e544aeb239?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjZ8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1574117936532-46e544aeb239?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjZ8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#F5F5F5"},{id:"larson-8921",name:"Larson Ornate Gold",manufacturer:"Larson-Juhl",material:"wood",width:"3.5",depth:"2.25",price:"18.99",catalogImage:"https://images.unsplash.com/photo-1581814605484-050c5bb1196c?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzF8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1581814605484-050c5bb1196c?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzF8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1581814605484-050c5bb1196c?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzF8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#D4AF37"}]});async function Sr(){try{return console.log("Loading static matboard data to prevent application freezing..."),[]}catch(o){return console.error("Error fetching Crescent matboards:",o),[]}}var xr=M(()=>{"use strict"});var Ir,pa,He,fa,vr=M(()=>{"use strict";xr();Ir=[{id:"white",name:"White",color:"#FFFFFF",price:"0.02",manufacturer:"Basic",code:"WHT",description:"Pure white mat board",category:"Standard"},{id:"black",name:"Black",color:"#2C2C2C",price:"0.025",manufacturer:"Basic",code:"BLK",description:"Deep black mat board",category:"Standard"},{id:"grey",name:"Grey",color:"#ADADAD",price:"0.02",manufacturer:"Basic",code:"GRY",description:"Neutral grey mat board",category:"Standard"},{id:"beige",name:"Beige",color:"#F5F5DC",price:"0.02",manufacturer:"Basic",code:"BGE",description:"Soft beige mat board",category:"Standard"}],pa=[{id:"crescent-white",name:"Bright White",color:"#FFFFFF",price:"0.025",manufacturer:"Crescent",code:"S100",description:"Bright white conservation mat board",category:"Whites"},{id:"crescent-cream",name:"Cream",color:"#FFF8E1",price:"0.025",manufacturer:"Crescent",code:"S101",description:"Cream white conservation mat board",category:"Whites"},{id:"crescent-antique",name:"Antique White",color:"#F5F1E6",price:"0.025",manufacturer:"Crescent",code:"S102",description:"Subtle antique white tone",category:"Whites"},{id:"crescent-stone",name:"Stone",color:"#E0DCCC",price:"0.027",manufacturer:"Crescent",code:"S200",description:"Light stone grey conservation mat",category:"Neutrals"},{id:"crescent-fog",name:"Fog",color:"#D6D6D6",price:"0.027",manufacturer:"Crescent",code:"S201",description:"Subtle fog grey conservation mat",category:"Neutrals"},{id:"crescent-granite",name:"Granite",color:"#A9A9A9",price:"0.027",manufacturer:"Crescent",code:"S202",description:"Darker granite grey tone",category:"Neutrals"},{id:"crescent-colonial-blue",name:"Colonial Blue",color:"#B5C7D3",price:"0.029",manufacturer:"Crescent",code:"S300",description:"Subtle colonial blue conservation mat",category:"Blues"},{id:"crescent-wedgewood",name:"Wedgewood",color:"#6E99C0",price:"0.029",manufacturer:"Crescent",code:"S301",description:"Classic wedgewood blue conservation mat",category:"Blues"},{id:"crescent-ultramarine",name:"Ultramarine",color:"#4166B0",price:"0.029",manufacturer:"Crescent",code:"S302",description:"Deep ultramarine blue conservation mat",category:"Blues"},{id:"crescent-sage",name:"Sage",color:"#BCCCBA",price:"0.029",manufacturer:"Crescent",code:"S400",description:"Soft sage green conservation mat",category:"Greens"},{id:"crescent-celadon",name:"Celadon",color:"#9CB084",price:"0.029",manufacturer:"Crescent",code:"S401",description:"Classic celadon green conservation mat",category:"Greens"},{id:"crescent-forest",name:"Forest",color:"#4A6741",price:"0.029",manufacturer:"Crescent",code:"S402",description:"Deep forest green conservation mat",category:"Greens"},{id:"crescent-sand",name:"Sand",color:"#E6D7B8",price:"0.027",manufacturer:"Crescent",code:"S500",description:"Light sand beige conservation mat",category:"Earth Tones"},{id:"crescent-chamois",name:"Chamois",color:"#D9BC8C",price:"0.027",manufacturer:"Crescent",code:"S501",description:"Warm chamois tan conservation mat",category:"Earth Tones"},{id:"crescent-chestnut",name:"Chestnut",color:"#A67B5B",price:"0.027",manufacturer:"Crescent",code:"S502",description:"Rich chestnut brown conservation mat",category:"Earth Tones"},{id:"crescent-pale-rose",name:"Pale Rose",color:"#F0D4D4",price:"0.029",manufacturer:"Crescent",code:"S600",description:"Subtle pale rose conservation mat",category:"Warm Tones"},{id:"crescent-dusty-rose",name:"Dusty Rose",color:"#D4A9A9",price:"0.029",manufacturer:"Crescent",code:"S601",description:"Classic dusty rose conservation mat",category:"Warm Tones"},{id:"crescent-rust",name:"Rust",color:"#B56A55",price:"0.029",manufacturer:"Crescent",code:"S602",description:"Deep rust red conservation mat",category:"Warm Tones"},{id:"crescent-black",name:"Raven Black",color:"#1A1A1A",price:"0.03",manufacturer:"Crescent",code:"S700",description:"Deep black conservation mat board",category:"Black"}],He=[...Ir,...pa],fa=async()=>{if(typeof window>"u"){console.log("Skipping Supabase fetch on server-side");return}try{console.log("Fetching Crescent matboards from Larson Juhl catalog...");let o=await Sr();if(o&&o.length>0){console.log("Converting API matboards to MatColor format");let t=o.map(r=>({id:r.id,name:r.name,color:r.hex_color||"#FFFFFF",price:r.price,manufacturer:r.manufacturer,code:r.code||null,description:r.description||null,category:r.category||null}));He=[...Ir,...t],console.log(`Loaded and converted ${o.length} Crescent matboards from Larson Juhl catalog`)}else console.log("No Crescent matboards found in Larson Juhl catalog or empty response. Using static fallback data.")}catch(o){console.error("Failed to load Crescent matboards:",o),console.log("Using static Crescent matboard catalog as fallback.")}};typeof window<"u"&&fa()});var lt,dt,Or=M(()=>{"use strict";lt=[{id:"none",name:"No Glass",description:"No glass protection",price:"0.00"},{id:"regular",name:"Regular Glass",description:"Standard protection",price:"0.08"},{id:"uv",name:"Museum Glass",description:"Museum non-glare",price:"0.45"},{id:"museum",name:"Conservation Glass",description:"Premium UV protection",price:"0.25"},{id:"regular-acrylic",name:"Regular Acrylic",description:"Standard acrylic glazing",price:"0.12"},{id:"conservation-clear-acrylic",name:"Conservation Clear Acrylic",description:"UV filtering acrylic glazing",price:"0.35"},{id:"optium-acrylic",name:"Optium Acrylic",description:"Premium non-glare acrylic",price:"0.45"}],dt=[{id:"float-mount",name:"Float Mount",description:"Artwork appears to float",price:"50.00"},{id:"glass-float",name:"Glass Float",description:"Suspended between glass",price:"55.00"},{id:"shadowbox",name:"Shadowbox",description:"For 3D objects",price:"65.00"},{id:"labor-30min",name:"Additional Labor (30 min)",description:"Custom work",price:"30.00"},{id:"labor-1hour",name:"Additional Labor (1 hour)",description:"Custom work",price:"55.00"}]});import{createClient as ga}from"@supabase/supabase-js";var mt,kr=M(()=>{"use strict";mt=null;try{let o=process.env.SUPABASE_URL||process.env.VITE_SUPABASE_URL,t=process.env.SUPABASE_KEY||process.env.VITE_SUPABASE_KEY||process.env.VITE_SUPABASE_ANON_KEY;o&&t?(mt=ga(o,t),console.log("Server: Successfully initialized Supabase client")):(mt={from:()=>({select:()=>Promise.resolve({data:[],error:null}),insert:()=>Promise.resolve({data:[],error:null}),update:()=>Promise.resolve({data:[],error:null}),delete:()=>Promise.resolve({data:null,error:null}),upsert:()=>Promise.resolve({data:null,error:null})}),rpc:()=>Promise.resolve({data:null,error:null})},console.log("Server: Using mock Supabase client - data operations will be handled by Drizzle/PostgreSQL"))}catch(o){console.error("Server: Error initializing Supabase client:",o),mt={from:()=>({select:()=>Promise.resolve({data:[],error:null}),insert:()=>Promise.resolve({data:[],error:null}),update:()=>Promise.resolve({data:[],error:null}),delete:()=>Promise.resolve({data:null,error:null}),upsert:()=>Promise.resolve({data:null,error:null})}),rpc:()=>Promise.resolve({data:null,error:null})}}});import{Pool as ya,neonConfig as ha}from"@neondatabase/serverless";import{drizzle as ba}from"drizzle-orm/neon-serverless";import wa from"ws";var Pa,u,Y=M(()=>{"use strict";V();kr();ha.webSocketConstructor=wa;if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL must be set. Did you forget to provision a database?");Pa=new ya({connectionString:process.env.DATABASE_URL}),u=ba({client:Pa,schema:Ct})});function Ae(o,t){let e=new Date().toISOString(),r=t?`[${t}]`:"";console.log(`${e} ${r} ${o}`)}var _r=M(()=>{"use strict"});function Nt(o,t,e,r){let s=o/t,a=e+r;return s/a}function Sa(o){return o>=40?2.2:o>=25?2.4:o>=15?2.6:o>=10?2.8:o>=6?3:o>=4?3.2:o>=2?3.5:4}function Cr(o,t,e,r){let s=o+e*2,a=t+e*2,i=(s+a)/12*r,p=Sa(i);return i*p}function Nr(o,t,e,r){let s=o+e*2,a=t+e*2,n=s+a,l=n*r*2.5,i=5.5;n<=24?i=5.5:n<=36?i=5:n<=50?i=4.5:n<=68?i=4.2:n<=88?i=3.8:n<=108?i=3.5:i=3.2;let p=xa(n);return l*i+p}function Ar(o,t,e,r){let s=o+e*2,a=t+e*2,n=s+a,l=n*r,i=4;return n<=24?i=4:n<=36?i=3.8:n<=50?i=3.5:n<=68?i=3.2:n<=88?i=3:n<=108?i=2.8:i=2.5,l*i}function xa(o){let t=15;return o<=24?t=15:o<=36?t=20:o<=50?t=25:o<=68?t=35:o<=88?t=45:o<=108?t=55:t=65,t}var Er=M(()=>{"use strict"});var Mr={};oe(Mr,{calculateFramePrice:()=>Ia,calculateFramingPrice:()=>ja,calculateGlassPrice:()=>Oa,calculateMatPrice:()=>va});function Ia(o,t){let e=t*6,r=Ca(e);return o*t*r*1.2}function va(o,t,e){let r=Aa(e);return t*o*r}function Oa(o,t,e=0,r=0,s="regular"){let a=e&&r?e+r:Math.sqrt(t)*2,n=Na(a),l=1;switch(s){case"conservation":l=1.5;break;case"museum":l=2;break}let i=t/144;return(a<=40?85:125)+i*o*n*.35*l}function Ca(o){return o<=20?1.8:o<=40?2.2:o<=60?2.6:o<=80?3:3.4}function Na(o){return o<=20?2.8:o<=40?3.2:o<=60?3.6:o<=80?4:4.5}function Aa(o){return o<=20?2.5:o<=40?2.8:o<=60?3.1:o<=80?3.4:3.8}function Ea(o,t,e,r){let s=r/40;return{frameAssembly:o?.25*s:0,matCutting:t?.3*s:0,glassCutting:e?.15*s:0,fitting:.2*s,finishing:.1*s}}function Ra(o,t,e){return(o.frameAssembly+o.matCutting+o.glassCutting+o.fitting+o.finishing)*t*e}async function ja(o){let{frameId:t,matColorId:e,glassOptionId:r,artworkWidth:s,artworkHeight:a,matWidth:n,quantity:l,includeWholesalePrices:i=!1}=o,p=t&&t!=="none"?await b.getFrame(t):null,_=e&&e!=="none"?await b.getMatColor(e):null,f=r&&r!=="none"?await b.getGlassOption(r):null,d=s+a,m=s+n*2,y=a+n*2,w=m+y,P=m*y-s*a,g=m*2+y*2,O=i?{frame:p?p.price:"0.00",mat:"0.00",glass:f&&f.price||"0.00",backing:"0.00"}:void 0,H=0;if(p){let _e=parseFloat(p.price);if(H=Cr(s,a,n,_e),O){let De=s+n*2,Te=a+n*2,de=(De+Te)/12*_e;O.frame=de.toFixed(2)}}let q=0;if(_){let J=Nt(45.5,25,32,40);if(q=Nr(s,a,n,J),O){let de=s+n*2,$e=a+n*2,Le=(de+$e)*J;O.mat=Le.toFixed(2)}}let ue=0;if(f){let J=Nt(125,10,24,36);if(ue=Ar(s,a,n,J),O){let de=s+n*2,$e=a+n*2,Le=(de+$e)*J;O.glass=Le.toFixed(2)}}let le=.04,st=m*y,dr=st*le*ka;O&&(O.backing=(st*le).toFixed(2));let mr=Ea(!!p,!!_,!!f,w),xt=Ra(mr,jr,Rr),pr=H+q+ue+dr,Fe=pr+xt,Os=Fe*l,fr;if(i&&O){let _e=p?parseFloat(p.price)*g/12:0,De=_?parseFloat(O.mat):0,Te=f&&f.price?parseFloat(f.price)*m*y/144:0,at=parseFloat(O.backing),J=_e+De+Te+at,de=J*_a,$e=J+de+xt,nt=Fe-$e,Le=nt/Fe,ks=Fe/J;fr={totalWholesaleCost:J,overheadCost:de,grossProfit:nt,grossProfitMargin:Le,markupMultiplier:ks}}return{framePrice:H,matPrice:q,glassPrice:ue,backingPrice:dr,laborCost:xt,materialCost:pr,subtotal:Fe,totalPrice:Os,wholesalePrices:O,laborRates:{baseRate:jr,regionalFactor:Rr,estimates:mr},profitability:fr}}var ka,Rr,jr,_a,Fr=M(()=>{"use strict";ee();Er();ka=1.2,Rr=1.15,jr=45,_a=.3});import Ma from"axios";async function At(o){try{let t=await Ma.post(`${Fa}/api/notifications/send`,{to:o.to,subject:o.subject,message:o.message,orderId:o.orderId,customerName:o.customerName,type:o.type||"order_update",source:"Jays Frames POS",method:"email",deliveryType:"email"},{headers:{Authorization:`Bearer ${Da}`,"Content-Type":"application/json"},timeout:1e4});if(t.data&&t.data.success)console.log(`Email notification sent successfully to ${o.to} via SMS Hub`);else throw new Error(t.data?.error||"SMS Hub returned error response")}catch(t){throw console.error("SMS Hub Error:",t.message),t.response&&console.error("SMS Hub Response:",t.response.data),new Error(`Failed to send email notification via SMS Hub: ${t.message}`)}}async function Dr(o,t,e,r,s){let a=`Hi ${e}, your order #${r} status has been updated to: ${s}. Thank you for choosing Jay's Frames!`;await At({to:o,subject:`Order #${r} Update`,message:a,orderId:r,customerName:e,type:"status_update"})}var Fa,Da,Tr=M(()=>{"use strict";Fa="https://telitel-sms-hub-JayFrames.replit.app",Da=process.env.SMS_HUB_API_KEY||"jays_frames_api_2025"});var Et={};oe(Et,{generateOrderStatusEmailTemplate:()=>$a,sendEmailWithSendGrid:()=>Ge,sendOrderStatusUpdate:()=>Ke});async function Ge(o){console.log("Using SMS Hub instead of SendGrid for notifications");try{await At({to:o.to,subject:o.subject,message:o.text||Ta(o.html||""),type:"email_replacement"})}catch(t){throw console.error("SMS Hub notification error:",t.message),new Error(`Failed to send notification via SMS Hub: ${t.message}`)}}function Ta(o){return o.replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").trim()}function $a(o,t,e,r){let s=e.split("_").map(_=>_.charAt(0).toUpperCase()+_.slice(1)).join(" "),a=r?new Date(r).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}):"Not available",n=["order_processed","scheduled","materials_ordered","materials_arrived","frame_cut","mat_cut","prepped","completed"],l=n.indexOf(e),p=`
    <div style="margin: 20px 0; width: 100%;">
      <div style="width: 100%; background-color: #f0f0f0; height: 20px; border-radius: 10px; overflow: hidden;">
        <div style="width: ${Math.max(10,Math.min(100,Math.round((l+1)/n.length*100)))}%; background-color: #4CAF50; height: 20px;"></div>
      </div>
      <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 12px;">
        <span>Order Placed</span>
        <span>In Production</span>
        <span>Completed</span>
      </div>
    </div>
  `;return`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <title>Order Status Update</title>
      <style>
        body {
          font-family: Arial, sans-serif;
          line-height: 1.6;
          color: #333;
          margin: 0;
          padding: 0;
        }
        .container {
          max-width: 600px;
          margin: 0 auto;
          padding: 20px;
        }
        .header {
          background-color: #4A90E2;
          color: white;
          padding: 20px;
          text-align: center;
        }
        .content {
          padding: 20px;
          background-color: #f9f9f9;
        }
        .footer {
          text-align: center;
          padding: 20px;
          font-size: 12px;
          color: #666;
        }
        .button {
          display: inline-block;
          background-color: #4A90E2;
          color: white;
          padding: 10px 20px;
          text-decoration: none;
          border-radius: 5px;
          margin-top: 20px;
        }
        .status-box {
          background-color: #e8f4fd;
          border-left: 4px solid #4A90E2;
          padding: 15px;
          margin: 20px 0;
        }
        .details-table {
          width: 100%;
          border-collapse: collapse;
          margin: 20px 0;
        }
        .details-table th, .details-table td {
          border: 1px solid #ddd;
          padding: 10px;
          text-align: left;
        }
        .details-table th {
          background-color: #f0f0f0;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>Order Status Update</h1>
        </div>
        
        <div class="content">
          <p>Hello ${o},</p>
          
          <p>We're writing to provide you with an update on your custom framing order.</p>
          
          <div class="status-box">
            <h2>Order #${t} Status: ${s}</h2>
            <p>Your order is now in the <strong>${s}</strong> stage.</p>
            <p><strong>Estimated Completion:</strong> ${a}</p>
          </div>
          
          ${p}
          
          <h3>What's Next?</h3>
          <p>Your order is progressing through our custom framing process. Here's what's happening:</p>
          
          <table class="details-table">
            <tr>
              <th>Current Stage</th>
              <th>Description</th>
            </tr>
            <tr>
              <td>${s}</td>
              <td>${La(e)}</td>
            </tr>
          </table>
          
          <p>We'll notify you when your order moves to the next stage or is ready for pickup.</p>
          
          <a href="#" class="button">Track Your Order</a>
        </div>
        
        <div class="footer">
          <p>Thank you for choosing Jays Frames Guru Framing</p>
          <p>123 Frame Street, Anytown, ST 12345</p>
          <p>Phone: (555) 123-4567 | Email: info@jaysframes.com</p>
        </div>
      </div>
    </body>
    </html>
  `}async function Ke(o,t,e,r,s){console.log(`Sending order status update via SMS Hub for order #${e}`),await Dr(o,"",t,e.toString(),r)}function La(o){switch(o){case"order_processed":return"Your order has been processed and is scheduled for production.";case"scheduled":return"Your order has been scheduled and is in our production queue.";case"materials_ordered":return"We have ordered the special materials needed for your custom frame.";case"materials_arrived":return"All materials for your order have arrived and are ready for production.";case"frame_cut":return"Your frame has been cut to the specified dimensions.";case"mat_cut":return"Your mat board has been cut and prepared for assembly.";case"prepped":return"Your frame is assembled and is going through final quality checks.";case"completed":return"Your order is complete and ready for pickup!";case"delayed":return"Your order is temporarily delayed. We will contact you with more information.";default:return"Your order is being processed by our team."}}var ze=M(()=>{"use strict";Tr()});import{eq as h,desc as be,sql as pt,asc as Rt,and as qa,or as $r}from"drizzle-orm";function Ee(o){let{material:t,name:e}=o,r=t.toLowerCase(),s=e.toLowerCase();return r.includes("gold")||s.includes("gold")?"#D4AF37":r.includes("silver")||r.includes("metal")||s.includes("silver")||s.includes("metal")||s.includes("chrome")||s.includes("steel")?"#C0C0C0":r.includes("black")||s.includes("black")||s.includes("ebony")||s.includes("onyx")?"#000000":r.includes("white")||s.includes("white")?"#F5F5F5":r.includes("walnut")||s.includes("walnut")?"#5C4033":r.includes("cherry")||s.includes("cherry")?"#722F37":r.includes("oak")||s.includes("oak")?"#D8BE75":r.includes("mahogany")||s.includes("mahogany")?"#4E2728":r.includes("maple")||s.includes("maple")?"#E8D4A9":"#8B4513"}var jt,b,ee=M(()=>{"use strict";V();Pr();vr();Or();Y();_r();jt=class{async updateOrderArtLocation(t,e){try{let[r]=await u.update(v).set({artworkLocation:e}).where(h(v.id,t)).returning();if(!r)throw new Error("Order not found");return r}catch(r){throw console.error("Error updating order artwork location:",r),r}}async getOrderMats(t){try{let e=await u.select().from(Be).where(h(Be.orderId,t)),r=[];for(let s of e){let a=await this.getMatColor(s.matColorId);a&&r.push({...s,matboard:a})}return r}catch(e){return console.error(`Error getting order mats for order ${t}:`,e),[]}}async getOrderFrames(t){try{let e=await u.select().from(We).where(h(We.orderId,t)),r=[];for(let s of e){let a=await this.getFrame(s.frameId);a&&r.push({...s,frame:a})}return r}catch(e){return console.error(`Error getting order frames for order ${t}:`,e),[]}}async getOrderPricingDetails(t){try{let e=await this.getOrder(t);if(!e)return;let{calculatePricing:r}=(Fr(),gr(Mr)),s=e.frameId?await this.getFrame(e.frameId):void 0,a=e.matColorId?await this.getMatColor(e.matColorId):void 0,n=e.glassOptionId?await this.getGlassOption(e.glassOptionId):void 0,l=await this.getOrderSpecialServices(t),i=await this.getOrderMats(t),p=await this.getOrderFrames(t),_={artworkWidth:Number(e.artworkWidth),artworkHeight:Number(e.artworkHeight),matWidth:Number(e.matWidth),frame:s,matColor:a,glassOption:n,specialServices:l,quantity:e.quantity||1,includeWholesalePrices:!0,mats:i.length>0?i:void 0,frames:p.length>0?p:void 0};return r(_)}catch(e){console.error("Error getting order pricing details:",e);return}}async getCustomer(t){let[e]=await u.select().from(C).where(h(C.id,t));return e||void 0}async getCustomerByEmail(t){let[e]=await u.select().from(C).where(h(C.email,t));return e||void 0}async getAllCustomers(){return await u.select().from(C)}async createCustomer(t){let[e]=await u.insert(C).values({...t,createdAt:new Date}).returning();return e}async updateCustomer(t,e){let[r]=await u.update(C).set(e).where(h(C.id,t)).returning();if(!r)throw new Error("Customer not found");return r}async getFrame(t){console.log(`Storage: Getting frame with ID: ${t}`);try{let[e]=await u.select().from(T).where(h(T.id,t));if(e){console.log(`Storage: Found frame in database: ${e.name}`);let s=Ee(e),a=e.catalogImage,n=e.corner||"",l=e.edgeTexture||"";if(e.manufacturer==="Larson-Juhl"){let i=e.id.split("-")[1];i&&(a=`https://www.larsonjuhl.com/contentassets/products/mouldings/${i}_fab.jpg`,n=`https://www.larsonjuhl.com/contentassets/products/mouldings/${i}_corner.jpg`,l=`https://www.larsonjuhl.com/contentassets/products/mouldings/${i}_prof.jpg`)}if(e.manufacturer==="Nielsen"){let i=e.id.split("-")[1];i&&(a=`https://www.nielsenbainbridge.com/images/products/detail/${i}-Detail.jpg`,n=`https://www.nielsenbainbridge.com/images/products/detail/${i}-Corner.jpg`,l=`https://www.nielsenbainbridge.com/images/products/detail/${i}-Edge.jpg`)}return{...e,catalogImage:a,corner:n,edgeTexture:l,color:s}}console.log("Storage: Frame not found in database, checking catalog");let r=Ue.find(s=>s.id===t);if(r){console.log(`Storage: Found frame in catalog: ${r.name}`);let s=r.catalogImage,a=r.corner||"",n=r.edgeTexture||"",l=r.color||Ee(r);if(r.manufacturer==="Larson-Juhl"){let p=r.id.split("-")[1];p&&(s=`https://www.larsonjuhl.com/contentassets/products/mouldings/${p}_fab.jpg`,a=`https://www.larsonjuhl.com/contentassets/products/mouldings/${p}_corner.jpg`,n=`https://www.larsonjuhl.com/contentassets/products/mouldings/${p}_prof.jpg`)}if(r.manufacturer==="Nielsen"){let p=r.id.split("-")[1];p&&(s=`https://www.nielsenbainbridge.com/images/products/detail/${p}-Detail.jpg`,a=`https://www.nielsenbainbridge.com/images/products/detail/${p}-Corner.jpg`,n=`https://www.nielsenbainbridge.com/images/products/detail/${p}-Edge.jpg`)}let i={...r,catalogImage:s,corner:a,edgeTexture:n};console.log(`Storage: Inserting enhanced frame into database: ${i.name}`);try{await u.insert(T).values(i),console.log("Storage: Successfully inserted frame into database")}catch(p){console.error("Storage: Error inserting frame into database:",p)}return{...i,color:l}}console.log("Storage: Frame not found in catalog");return}catch(e){console.error(`Storage: Error in getFrame(${t}):`,e);let r=Ue.find(s=>s.id===t);if(r){let s=Ee(r),a=r.catalogImage;if(r.manufacturer==="Larson-Juhl"){let n=r.id.split("-")[1];n&&(a=`https://www.larsonjuhl.com/contentassets/products/mouldings/${n}_fab.jpg`)}else if(r.manufacturer==="Nielsen"){let n=r.id.split("-")[1];n&&(a=`https://www.nielsenbainbridge.com/images/products/detail/${n}-Detail.jpg`)}return{...r,catalogImage:a,color:s}}return}}async getAllFrames(){console.log("Storage: Getting all frames");try{let t=await u.select().from(T);return console.log(`Storage: Found ${t.length} frames in database`),t.length>0?(console.log("Storage: Enhancing existing frames with real wholesaler images"),t.map(r=>{let s=Ee(r),a=r.catalogImage,n=r.corner||"",l=r.edgeTexture||"";if(r.manufacturer==="Larson-Juhl"){let i=r.id.split("-")[1];i&&(a=`https://www.larsonjuhl.com/contentassets/products/mouldings/${i}_fab.jpg`,n=`https://www.larsonjuhl.com/contentassets/products/mouldings/${i}_corner.jpg`,l=`https://www.larsonjuhl.com/contentassets/products/mouldings/${i}_prof.jpg`)}if(r.manufacturer==="Nielsen"){let i=r.id.split("-")[1];i&&(a=`https://www.nielsenbainbridge.com/images/products/detail/${i}-Detail.jpg`,n=`https://www.nielsenbainbridge.com/images/products/detail/${i}-Corner.jpg`,l=`https://www.nielsenbainbridge.com/images/products/detail/${i}-Edge.jpg`)}return{...r,catalogImage:a,corner:n,edgeTexture:l,color:s}})):(console.log("Storage: No frames in database, returning enhanced catalog data"),Ue.map(r=>{let s=r.catalogImage,a=r.corner||"",n=r.edgeTexture||"",l=r.color||Ee(r);if(r.manufacturer==="Larson-Juhl"){let p=r.id.split("-")[1];p&&(s=`https://www.larsonjuhl.com/contentassets/products/mouldings/${p}_fab.jpg`,a=`https://www.larsonjuhl.com/contentassets/products/mouldings/${p}_corner.jpg`,n=`https://www.larsonjuhl.com/contentassets/products/mouldings/${p}_prof.jpg`)}if(r.manufacturer==="Nielsen"){let p=r.id.split("-")[1];p&&(s=`https://www.nielsenbainbridge.com/images/products/detail/${p}-Detail.jpg`,a=`https://www.nielsenbainbridge.com/images/products/detail/${p}-Corner.jpg`,n=`https://www.nielsenbainbridge.com/images/products/detail/${p}-Edge.jpg`)}let i={...r,catalogImage:s,corner:a,edgeTexture:n};try{u.insert(T).values(i).execute()}catch(p){console.error(`Storage: Error inserting frame ${r.id} into database:`,p)}return{...i,color:l}}))}catch(t){return console.error("Storage: Error in getAllFrames:",t),Ue.map(e=>{let r=Ee(e),s=e.id.split("-")[1],a=e.catalogImage;return e.manufacturer==="Larson-Juhl"?a="https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D":e.manufacturer==="Roma"?a="https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D":e.manufacturer==="Omega"?a="https://images.unsplash.com/photo-1513519245088-0e12902e5a38?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8ZnJhbWV8ZW58MHx8MHx8fDA%3D":a="https://images.unsplash.com/photo-1518998053901-5348d3961a04?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fGZyYW1lfGVufDB8fDB8fHww",{...e,catalogImage:a,color:r}})}}async updateFrame(t,e){let[r]=await u.update(T).set(e).where(h(T.id,t)).returning();if(!r)throw new Error("Frame not found");return r}async addFrame(t){console.log(`Storage: Adding new frame to database: ${t.name} (${t.id})`);try{let[e]=await u.insert(T).values(t).returning();return console.log("Storage: Successfully added frame to database"),e}catch(e){throw console.error("Storage: Error adding frame to database:",e),e}}async searchFramesByItemNumber(t){console.log(`Storage: Searching frames by item number: ${t}`);try{let e=await this.getAllFrames(),r=t.toLowerCase();return e.filter(s=>(s.id.split("-")[1]?.toLowerCase()||"").includes(r))}catch(e){return console.error("Storage: Error searching frames by item number:",e),[]}}async getMatColor(t){let[e]=await u.select().from(X).where(h(X.id,t));if(!e){let r=He.find(s=>s.id===t);if(r)return await u.insert(X).values(r),r}return e||void 0}async getAllMatColors(){let t=await u.select().from(X);return t.length===0?(await u.insert(X).values(He),He):t}async getGlassOption(t){let[e]=await u.select().from(se).where(h(se.id,t));if(!e){let r=lt.find(s=>s.id===t);if(r)return await u.insert(se).values(r),r}return e||void 0}async getAllGlassOptions(){let t=await u.select().from(se);return t.length===0?(await u.insert(se).values(lt),lt):t}async getSpecialService(t){let[e]=await u.select().from(ae).where(h(ae.id,t));if(!e){let r=dt.find(s=>s.id===t);if(r)return await u.insert(ae).values(r),r}return e||void 0}async getAllSpecialServices(){let t=await u.select().from(ae);return t.length===0?(await u.insert(ae).values(dt),dt):t}async getOrderGroup(t){let[e]=await u.select().from(D).where(h(D.id,t));return e||void 0}async getActiveOrderGroupByCustomer(t){let[e]=await u.select().from(D).where(h(D.customerId,t));return e&&e.status==="open"?e:void 0}async getAllOrderGroups(){return await u.select().from(D)}async createOrderGroup(t){let[e]=await u.insert(D).values({...t,status:"open",createdAt:new Date}).returning();return e}async updateOrderGroup(t,e){let[r]=await u.update(D).set(e).where(h(D.id,t)).returning();if(!r)throw new Error("Order group not found");return r}async getOrderGroupsByCustomerId(t){try{console.log(`Storage: Getting order groups for customer ID: ${t}`);let e=await u.select().from(D).where(h(D.customerId,t));return console.log(`Storage: Found ${e.length} order groups for customer ID: ${t}`),e}catch(e){throw console.error("Storage: Error getting order groups by customer ID:",e),e}}async getOrdersByGroupId(t){return await u.select().from(v).where(h(v.orderGroupId,t))}async getOrder(t){let[e]=await u.select().from(v).where(h(v.id,t));return e||void 0}async getAllOrders(){try{console.log("Fetching orders from database...");let t=await u.select().from(v);return console.log(`Found ${t?.length||0} orders in database`),t||[]}catch(t){throw console.error("Error in getAllOrders:",t),t}}async createOrder(t){try{t.artworkImage||(console.log("Warning: Order created without artwork image, using placeholder"),t.artworkImage="placeholder-image.jpg"),console.log("DatabaseStorage.createOrder - Inserting order with data:",t);let[e]=await u.insert(v).values([t]).returning();console.log("DatabaseStorage.createOrder - Order created successfully:",e);try{console.log("Creating material orders for order:",e.id);let r=await this.createMaterialOrdersFromOrder(e);console.log(`Created ${r.length} material orders for order ${e.id}`)}catch(r){console.error("Error creating material orders:",r)}return e}catch(e){throw console.error("DatabaseStorage.createOrder - Error creating order:",e),e}}async updateOrder(t,e){try{let r={};e.frameId!==void 0&&(r.frameId=e.frameId),e.matColorId!==void 0&&(r.matColorId=e.matColorId),e.glassOptionId!==void 0&&(r.glassOptionId=e.glassOptionId),e.artworkWidth!==void 0&&(r.artworkWidth=e.artworkWidth),e.artworkHeight!==void 0&&(r.artworkHeight=e.artworkHeight),e.matWidth!==void 0&&(r.matWidth=e.matWidth),e.artworkDescription!==void 0&&(r.artworkDescription=e.artworkDescription),e.artworkType!==void 0&&(r.artworkType=e.artworkType),e.quantity!==void 0&&(r.quantity=e.quantity),e.status!==void 0&&(r.status=e.status),e.subtotal!==void 0&&(r.subtotal=e.subtotal),e.tax!==void 0&&(r.tax=e.tax),e.total!==void 0&&(r.total=e.total);let[s]=await u.update(v).set(r).where(h(v.id,t)).returning();if(!s)throw new Error("Order not found");return s}catch(r){throw console.error("Error updating order:",r),r}}async deleteOrder(t){await u.delete(v).where(h(v.id,t))}async createOrderSpecialService(t){let[e]=await u.insert(Ce).values(t).returning();return e}async getOrderSpecialServices(t){let r=(await u.select().from(Ce).where(h(Ce.orderId,t))).map(a=>a.specialServiceId),s=[];for(let a of r)if(a){let n=await this.getSpecialService(a);n&&s.push(n)}return s}async getWholesaleOrder(t){let[e]=await u.select().from(ne).where(h(ne.id,t));return e||void 0}async getAllWholesaleOrders(){return await u.select().from(ne)}async createWholesaleOrder(t){let[e]=await u.insert(ne).values({...t,status:"pending",createdAt:new Date}).returning();return e}async updateWholesaleOrder(t,e){let[r]=await u.update(ne).set(e).where(h(ne.id,t)).returning();if(!r)throw new Error("Wholesale order not found");return r}async getOrdersByProductionStatus(t){return await u.select().from(v).where(h(v.productionStatus,t)).orderBy(v.lastStatusChange)}async updateOrderProductionStatus(t,e){let[r]=await u.select().from(v).where(h(v.id,t));if(!r)throw new Error("Order not found");let s=r.productionStatus,[a]=await u.update(v).set({productionStatus:e,lastStatusChange:new Date}).where(h(v.id,t)).returning();if(a.notificationsEnabled){let[n]=await u.select().from(C).where(h(C.id,r.customerId));if(n)try{let{sendOrderStatusUpdate:l}=await Promise.resolve().then(()=>(ze(),Et)),i=await l(n.email,n.name,r.id,e,s,r.estimatedCompletionDays);await this.createCustomerNotification({customerId:n.id,orderId:r.id,notificationType:"status_update",channel:"email",subject:`Order #${r.id} Status Update: ${e}`,message:`Your order is now ${e.split("_").join(" ")}. Check your email for details.`,successful:i,previousStatus:s,newStatus:e,responseData:i?{sent:!0,timestamp:new Date().toISOString()}:{sent:!1,error:"Email failed to send"}}),console.log(`Status update email ${i?"sent":"failed"} for Order #${r.id} to ${n.email}`)}catch(l){console.error("Error sending status update email:",l),await this.createCustomerNotification({customerId:n.id,orderId:r.id,notificationType:"status_update",channel:"email",subject:`Order #${r.id} Status Update: ${e}`,message:`Your order is now ${e.split("_").join(" ")}.`,successful:!1,previousStatus:s,newStatus:e,responseData:{error:l.message}})}}return a}async getOrdersForKanban(){return(await u.select({order:v,customer:C}).from(v).leftJoin(C,h(v.customerId,C.id)).orderBy(v.lastStatusChange)).map(e=>({...e.order,customerName:e.customer?e.customer.name:"Unknown Customer",customerPhone:e.customer?.phone||"No phone",customerEmail:e.customer?.email||"No email"}))}async scheduleOrderForProduction(t,e){let[r]=await u.select().from(v).where(h(v.id,t));if(!r)throw new Error("Order not found");let[s]=await u.update(v).set({estimatedCompletionDays:e,productionStatus:"scheduled"}).where(h(v.id,t)).returning();if(s.notificationsEnabled){let[a]=await u.select().from(C).where(h(C.id,r.customerId));if(a){let n=new Date;n.setDate(n.getDate()+e),await this.createCustomerNotification({customerId:a.id,orderId:r.id,notificationType:"estimated_completion",channel:"email",subject:`Your Custom Framing Order #${r.id} Has Been Scheduled`,message:`Your custom framing order #${r.id} has been scheduled for production. The estimated completion date is ${n.toLocaleDateString()}.`,successful:!0,previousStatus:r.productionStatus,newStatus:"scheduled"})}}return s}async createCustomerNotification(t){let[e]=await u.insert(B).values({...t}).returning();return e}async getCustomerNotifications(t){return await u.select().from(B).where(h(B.customerId,t)).orderBy(B.sentAt,"desc")}async getNotificationsByOrder(t){return await u.select().from(B).where(h(B.orderId,t)).orderBy(B.sentAt,"desc")}async getMaterialOrder(t){let[e]=await u.select().from(x).where(h(x.id,t));return e}async getAllMaterialOrders(){try{let t=await u.execute(pt`
        SELECT column_name 
        FROM information_schema.columns 
        WHERE table_name = 'material_orders'
      `);return await u.execute(pt`
        SELECT * FROM material_orders
        ORDER BY created_at DESC
      `)}catch(t){return console.error("Error in getAllMaterialOrders:",t),[]}}async getMaterialOrdersByStatus(t){try{return await u.select().from(x).where(h(x.status,t)).orderBy(be(x.createdAt))}catch(e){return console.error("Error in getMaterialOrdersByStatus:",e),[]}}async getMaterialOrdersByType(t){try{return await u.select().from(x).where(h(x.materialType,t)).orderBy(be(x.createdAt))}catch(e){return console.error("Error in getMaterialOrdersByType:",e),[]}}async createMaterialOrder(t){console.log("Creating material order with data:",t);let e={...t};e.vendor&&!e.supplierName&&(e.supplierName=e.vendor,delete e.vendor),console.log("Cleaned data for material order creation:",e);try{let[r]=await u.insert(x).values([e]).returning();return console.log("Successfully created material order:",r.id),r}catch(r){throw console.error("Error creating material order:",r),r}}async updateMaterialOrder(t,e){console.log("updateMaterialOrder called with id:",t,"and data:",e);let r=typeof t=="string"&&!isNaN(parseInt(t))?parseInt(t):t,s={...e};s.vendor&&!s.supplierName&&(s.supplierName=s.vendor,delete s.vendor),console.log("Cleaned data for update:",s);try{let[a]=await u.update(x).set(s).where(h(x.id,r)).returning();return console.log("Successfully updated material order:",a.id),a}catch(a){throw console.error("Error updating material order:",a),a}}async deleteMaterialOrder(t){await u.delete(x).where(h(x.id,t))}async getAllInventoryItems(){try{return await u.select().from(j).orderBy(Rt(j.name))}catch(t){return console.error("Error in getAllInventoryItems:",t),[]}}async getInventoryItem(t){try{let[e]=await u.select().from(j).where(h(j.id,t));return e}catch(e){console.error("Error in getInventoryItem:",e);return}}async getInventoryItemByBarcode(t){try{let[e]=await u.select().from(j).where(h(j.barcode,t));return e}catch(e){console.error("Error in getInventoryItemByBarcode:",e);return}}async createInventoryItem(t){try{t.sku||(t.sku=`INV-${Date.now().toString(36).toUpperCase()}`);let{initialQuantity:e,...r}=t,[s]=await u.insert(j).values([r]).returning();return e&&await this.createInventoryTransaction({itemId:s.id,type:"initial",quantity:e,unitCost:t.costPerUnit,notes:"Initial inventory setup"}),s}catch(e){throw console.error("Error in createInventoryItem:",e),e}}async updateInventoryItem(t,e){try{let[r]=await u.update(j).set({...e,updatedAt:new Date}).where(h(j.id,t)).returning();return r}catch(r){throw console.error("Error in updateInventoryItem:",r),r}}async deleteInventoryItem(t){try{await u.delete(pe).where(h(pe.itemId,t)),await u.delete(j).where(h(j.id,t))}catch(e){throw console.error("Error in deleteInventoryItem:",e),e}}async getLowStockItems(){try{let t=await u.select().from(j),e=[];for(let r of t){let s=await this.getItemCurrentStock(r.id);s<=Number(r.reorderLevel)&&e.push({...r,currentStock:s})}return e}catch(t){return console.error("Error in getLowStockItems:",t),[]}}async getItemCurrentStock(t){try{let e=await u.select().from(pe).where(h(pe.itemId,t)),r=0;for(let s of e){let a=Number(s.quantity);switch(s.type){case"purchase":case"initial":case"adjustment":r+=a;break;case"sale":case"scrap":r-=a;break}}return r}catch(e){return console.error("Error in getItemCurrentStock:",e),0}}async createInventoryTransaction(t){try{let[e]=await u.insert(pe).values([t]).returning();return t.type==="count"&&await u.update(j).set({lastCountDate:new Date,updatedAt:new Date}).where(h(j.id,t.itemId)),e}catch(e){throw console.error("Error in createInventoryTransaction:",e),e}}async getAllSuppliers(){try{return await u.select().from(W).orderBy(Rt(W.name))}catch(t){return console.error("Error in getAllSuppliers:",t),[]}}async getSupplier(t){try{let[e]=await u.select().from(W).where(h(W.id,t));return e}catch(e){console.error("Error in getSupplier:",e);return}}async createSupplier(t){try{let[e]=await u.insert(W).values(t).returning();return e}catch(e){throw console.error("Error in createSupplier:",e),e}}async updateSupplier(t,e){try{let[r]=await u.update(W).set(e).where(h(W.id,t)).returning();return r}catch(r){throw console.error("Error in updateSupplier:",r),r}}async deleteSupplier(t){try{await u.delete(W).where(h(W.id,t))}catch(e){throw console.error("Error in deleteSupplier:",e),e}}async getAllInventoryLocations(){try{return await u.select().from(R).orderBy(Rt(R.name))}catch(t){return console.error("Error in getAllInventoryLocations:",t),[]}}async getInventoryLocation(t){try{let[e]=await u.select().from(R).where(h(R.id,t));return e}catch(e){console.error("Error in getInventoryLocation:",e);return}}async createInventoryLocation(t){try{let[e]=await u.insert(R).values(t).returning();return e}catch(e){throw console.error("Error in createInventoryLocation:",e),e}}async getAllPurchaseOrders(){try{return await u.select().from(ie).orderBy(be(ie.createdAt))}catch(t){return console.error("Error in getAllPurchaseOrders:",t),[]}}async getPurchaseOrder(t){try{let[e]=await u.select().from(ie).where(h(ie.id,t));return e}catch(e){console.error("Error in getPurchaseOrder:",e);return}}async createPurchaseOrderWithLines(t,e){try{let r=`PO-${Date.now().toString(36).toUpperCase()}`,s=0;for(let i of e){let p=Number(i.quantity)*Number(i.unitCost);s+=p}let a=s*.08,n=s+a+Number(t.shipping||0),[l]=await u.insert(ie).values({...t,subtotal:s.toString(),tax:a.toString(),total:n.toString()}).returning();for(let i of e){let p=Number(i.quantity)*Number(i.unitCost);await u.insert(ut).values({...i,purchaseOrderId:l.id,lineTotal:p.toString()})}return l}catch(r){throw console.error("Error in createPurchaseOrderWithLines:",r),r}}async getInventoryValuation(){try{let t=await this.getAllInventoryItems(),e=0,r={};for(let a of t){let l=await this.getItemCurrentStock(a.id)*Number(a.costPerUnit);if(e+=l,a.categoryId){let p=(await this.getInventoryCategory(a.categoryId))?.name||"Uncategorized";r[p]||(r[p]=0),r[p]+=l}else r.Uncategorized||(r.Uncategorized=0),r.Uncategorized+=l}let s=Object.entries(r).map(([a,n])=>({category:a,value:n}));return{totalValue:e,itemCount:t.length,valuationByCategory:s}}catch(t){return console.error("Error in getInventoryValuation:",t),{totalValue:0,itemCount:0,valuationByCategory:[]}}}async getInventoryCategory(t){try{let[e]=await u.select().from(he).where(h(he.id,t));return e}catch(e){console.error("Error in getInventoryCategory:",e);return}}async generateRecommendedPurchaseOrders(){try{let t=await this.getLowStockItems(),e={};for(let r of t)if(r.supplierId){let s=await this.getSupplier(r.supplierId);s&&(e[s.id]||(e[s.id]={supplierId:s.id,supplierName:s.name,items:[]}),e[s.id].items.push({itemId:r.id,name:r.name,sku:r.sku,currentStock:await this.getItemCurrentStock(r.id),reorderLevel:Number(r.reorderLevel),reorderQuantity:Number(r.reorderQuantity||r.reorderLevel)}))}return Object.values(e)}catch(t){return console.error("Error in generateRecommendedPurchaseOrders:",t),[]}}async importInventoryFromCSV(t){try{return{success:!0,importedCount:0,errors:[]}}catch(e){return console.error("Error in importInventoryFromCSV:",e),{success:!1,importedCount:0,errors:["Failed to import CSV data"]}}}async exportInventoryToCSV(){try{return`id,sku,name,description,quantity
`}catch(t){throw console.error("Error in exportInventoryToCSV:",t),t}}async createNotification(t){let[e]=await u.insert(U).values([t]).returning();return e}async getNotification(t){let[e]=await u.select().from(U).where(h(U.id,t));return e||void 0}async getNotifications(t){let e=u.select().from(U).orderBy(be(U.createdAt));return t&&(e=e.limit(t)),await e}async getUnreadNotifications(){return await u.select().from(U).where(h(U.read,!1)).orderBy(be(U.createdAt))}async markNotificationAsRead(t){let[e]=await u.update(U).set({read:!0}).where(h(U.id,t)).returning();return e}async getNotificationsByUser(t){return await u.select().from(U).where(h(U.userId,t)).orderBy(be(U.createdAt))}async getMaterialsPickList(){try{return(await u.select({id:x.id,name:x.materialName,sku:x.materialId,supplier:x.supplierName,type:x.materialType,quantity:x.quantity,status:x.status,priority:x.priority,notes:x.notes,orderDate:x.orderDate,receiveDate:x.actualArrival,sourceOrderId:x.sourceOrderId,costPerUnit:x.costPerUnit,totalCost:x.totalCost}).from(x).where($r(h(x.status,"pending"),h(x.status,"processed"),h(x.status,"ordered"),h(x.status,"arrived"))).orderBy(be(x.createdAt))).map(r=>({id:r.id.toString(),orderIds:r.sourceOrderId?[r.sourceOrderId]:[],name:r.name,sku:r.sku,supplier:r.supplier||"Unknown",type:r.type,quantity:Number(r.quantity),status:r.status,priority:r.priority||"medium",notes:r.notes||"",orderDate:r.orderDate?.toISOString()||null,receiveDate:r.receiveDate?.toISOString()||null,costPerUnit:r.costPerUnit?Number(r.costPerUnit):0,totalCost:r.totalCost?Number(r.totalCost):0}))}catch(t){throw Ae(`Error in getMaterialsPickList: ${t}`,"storage"),t}}async getMaterialsForOrder(t){try{return await u.select().from(x).where(h(x.sourceOrderId,t))}catch(e){throw Ae(`Error in getMaterialsForOrder: ${e}`,"storage"),e}}async createPurchaseOrder(t){try{let e=t.map(l=>parseInt(l)),r=await u.select().from(x).where(pt`${x.id} IN (${e.join(",")})`);if(r.length===0)throw new Error("No valid materials found for purchase order");let s=r.filter(l=>l.status==="ordered"||l.status==="arrived"||l.status==="completed");if(s.length>0)throw new Error(`Materials already ordered: ${s.map(l=>l.materialName).join(", ")}`);await u.update(x).set({status:"ordered",orderDate:new Date}).where(pt`${x.id} IN (${e.join(",")})`);let a=r.reduce((l,i)=>l+(Number(i.totalCost)||0),0);return{id:"po-"+Date.now(),orderNumber:`PO-${new Date().getFullYear()}-${String(Math.floor(Math.random()*1e3)).padStart(3,"0")}`,materialIds:t,totalAmount:a,status:"sent",createdAt:new Date().toISOString(),expectedDeliveryDate:new Date(Date.now()+14*24*60*60*1e3).toISOString(),materials:r}}catch(e){throw Ae(`Error in createPurchaseOrder: ${e}`,"storage"),e}}async checkDuplicateMaterialOrder(t,e){try{return(await u.select().from(x).where(qa(h(x.materialId,t),h(x.sourceOrderId,e),$r(h(x.status,"pending"),h(x.status,"ordered"),h(x.status,"arrived"))))).length>0}catch(r){return Ae(`Error checking duplicate material order: ${r}`,"storage"),!1}}async createMaterialOrdersFromOrder(t){try{let e=[];if(t.frameId){let s=await this.getFrame(t.frameId);if(s&&!await this.checkDuplicateMaterialOrder(t.frameId,t.id)){let n=2*(Number(t.artworkWidth)+Number(t.artworkHeight)),l=Math.ceil(n*1.1);e.push({materialType:"frame",materialId:t.frameId,materialName:s.name,quantity:l.toString(),status:"pending",sourceOrderId:t.id,supplierName:s.manufacturer,costPerUnit:s.price,totalCost:(Number(s.price)*l).toString(),priority:"medium",unitMeasurement:"united_inch",notes:`Frame for order #${t.id}`})}}if(t.matColorId){let s=await this.getMatColor(t.matColorId);if(s&&!await this.checkDuplicateMaterialOrder(t.matColorId,t.id)){let n=Number(t.artworkWidth)+Number(t.matWidth)*2+4,l=Number(t.artworkHeight)+Number(t.matWidth)*2+4,i=n*l;e.push({materialType:"matboard",materialId:t.matColorId,materialName:s.name,quantity:"1",status:"pending",sourceOrderId:t.id,supplierName:s.manufacturer||"Crescent",costPerUnit:(Number(s.price)*i).toString(),totalCost:(Number(s.price)*i).toString(),priority:"medium",unitMeasurement:"sheet",notes:`Mat board for order #${t.id} - ${n}"x${l}"`})}}if(t.glassOptionId){let s=await this.getGlassOption(t.glassOptionId);if(s&&!await this.checkDuplicateMaterialOrder(t.glassOptionId,t.id)){let n=Number(t.artworkWidth)+Number(t.matWidth)*2,l=Number(t.artworkHeight)+Number(t.matWidth)*2,i=n*l;e.push({materialType:"glass",materialId:t.glassOptionId,materialName:s.name,quantity:"1",status:"pending",sourceOrderId:t.id,supplierName:"Tru Vue",costPerUnit:(Number(s.price)*i).toString(),totalCost:(Number(s.price)*i).toString(),priority:"medium",unitMeasurement:"square_inch",notes:`Glass for order #${t.id} - ${n}"x${l}"`})}}console.log(`Attempting to save ${e.length} material orders`);let r=[];for(let s of e)try{console.log("Inserting material order:",s);let[a]=await u.insert(e).values(s).returning();r.push(a),console.log("Successfully inserted material order:",a.id)}catch(a){console.error("Error inserting material order:",a,s)}return console.log(`Successfully created ${r.length} material orders for order ${t.id}`),r}catch(e){throw Ae(`Error creating material orders from order: ${e}`,"storage"),e}}},b=new jt});import{randomBytes as Ya}from"crypto";import{eq as Bc,and as Wc}from"drizzle-orm";function Qa(){return`JF${Ya(4).toString("hex")}`}async function qt(o){try{let t=Qa(),[e]=await u.insert(Ne).values([{code:t,type:"customer_order",entityId:o.toString(),title:`Order #${o}`,description:`QR code for order #${o}`,active:!0}]).returning();return t}catch(t){throw console.error("Error generating QR code for order:",t?.message||t),new Error("Failed to generate QR code for order")}}var no=M(()=>{"use strict";Y();V()});var io={};oe(io,{getCustomerOrderStatusHistory:()=>en,getOrderStatusHistory:()=>Xa,notifyCustomerOfStatusChange:()=>tn,recordStatusChange:()=>Ja});import{sql as Qe}from"drizzle-orm";async function Ja(o,t,e,r){try{await u.execute(Qe`
      INSERT INTO order_status_history (order_id, previous_status, new_status, notes)
      VALUES (${o}, ${t}, ${e}, ${r||null})
    `);let[s]=await u.execute(Qe`
      SELECT * FROM order_status_history 
      WHERE order_id = ${o}
      ORDER BY changed_at DESC LIMIT 1
    `);return s}catch(s){throw console.error("Error recording status change:",s),s}}async function Xa(o){try{return await u.execute(Qe`
      SELECT * FROM order_status_history 
      WHERE order_id = ${o}
      ORDER BY changed_at DESC
    `)}catch(t){throw console.error("Error fetching order status history:",t),t}}async function en(o){try{return await u.execute(Qe`
      SELECT h.*, o.id as order_id, o.frame_name, o.artwork_description
      FROM order_status_history h
      JOIN orders o ON h.order_id = o.id
      WHERE o.customer_id = ${o}
      ORDER BY h.changed_at DESC
    `)}catch(t){throw console.error("Error fetching customer order status history:",t),t}}async function tn(o,t,e){try{if(!o.customerId)return;let[r]=await u.execute(Qe`
      SELECT * FROM customers WHERE id = ${o.customerId}
    `);return!r||!r.status_notifications_enabled?void 0:(await Ke(r.email,r.name,o.id,e,o.dueDate),!0)}catch(r){return console.error("Error notifying customer of status change:",r),!1}}var co=M(()=>{"use strict";Y();ze()});var Ze={};oe(Ze,{configureKanbanConnection:()=>Kt,generateApiKey:()=>rn,getAllOrdersWithQrCodes:()=>Wt,getIntegrationDocs:()=>sn,getIntegrationStatus:()=>on,getOrderWithQrCode:()=>Bt,receiveWebhook:()=>Ht,testIntegration:()=>Gt,updateOrderStatus:()=>Ut});async function Bt(o,t){try{let{id:e}=o.params,r=parseInt(e);if(isNaN(r))return t.status(400).json({error:"Invalid order ID"});let s=await b.getOrder(r);if(!s)return t.status(404).json({error:"Order not found"});let a=await qt(r);t.json({success:!0,order:{...s,qrCode:a}})}catch(e){console.error("Error fetching order with QR code:",e),t.status(500).json({error:e.message||"Failed to fetch order information"})}}async function Wt(o,t){try{let{status:e,limit:r}=o.query,s=r?parseInt(r):void 0,a=await b.getOrders(e),n=s?a.slice(0,s):a,l=await Promise.all(n.map(async i=>{let p=await qt(i.id);return{...i,qrCode:p}}));t.json({success:!0,count:l.length,orders:l})}catch(e){console.error("Error fetching orders with QR codes:",e),t.status(500).json({error:e.message||"Failed to fetch orders"})}}async function Ut(o,t){try{let{id:e}=o.params,{status:r,notes:s}=o.body,a=parseInt(e);if(isNaN(a))return t.status(400).json({error:"Invalid order ID"});if(!r)return t.status(400).json({error:"Status is required"});let n=await b.getOrder(a);if(!n)return t.status(404).json({error:"Order not found"});let l=await b.updateOrder(a,{status:r,notes:s||`Status updated via Integration API to: ${r}`});try{await(co(),gr(io)).addStatusHistory(a,{previousStatus:n.status,newStatus:r,changedBy:"Integration API",notes:s||"Status updated via Integration API"})}catch(i){console.warn("Could not log status history:",i)}t.json({success:!0,message:"Order status updated",order:l})}catch(e){console.error("Error updating order status:",e),t.status(500).json({error:e.message||"Failed to update order status"})}}async function Ht(o,t){try{let{source:e,event:r,data:s}=o.body;if(!e||!r)return t.status(400).json({error:"Source and event are required"});switch(console.log(`Received webhook from ${e}, event: ${r}`),e){case"qr_generator":if(r==="qr_generated"&&s&&s.orderId){let a=parseInt(s.orderId);await b.updateOrder(a,{hasQrCode:!0,qrCodeGeneratedAt:new Date,qrCodeData:s.qrData})}break;case"printing_system":if(r==="invoice_printed"&&s&&s.orderId){let a=parseInt(s.orderId);await b.updateOrder(a,{invoicePrinted:!0,printedAt:new Date})}break;default:console.log(`Unknown webhook source: ${e}`)}t.json({success:!0,message:`Webhook received from ${e} for event ${r}`})}catch(e){console.error("Error processing webhook:",e),t.status(500).json({error:e.message||"Failed to process webhook"})}}async function rn(o,t){try{t.setHeader("Content-Type","application/json");let e=Date.now(),r=Math.random().toString(36).substring(2,15),s=`jf_api_${e}_${r}`,a={key:s,name:"Jay's Frames API Integration",permissions:["orders:read","orders:write","integration:webhook","pricing:read","catalog:read"],createdAt:new Date().toISOString(),lastUsed:null};console.log("New API Key generated:",s);let n={success:!0,...a,message:"API key generated successfully. Store this securely.",endpoints:{baseUrl:process.env.REPL_URL||`https://${process.env.REPL_SLUG}.${process.env.REPL_OWNER}.repl.co`,orders:"/api/integration/orders",webhook:"/api/integration/webhook",status:"/api/integration/status",pricing:"/api/pricing/calculate",catalog:"/api/vendor-catalog/frames"},authentication:{method:"Bearer Token",header:"Authorization",value:`Bearer ${s}`}};return t.status(200).json(n)}catch(e){console.error("Error generating API key:",e),t.setHeader("Content-Type","application/json"),t.status(500).json({success:!1,error:e.message||"Failed to generate API key"})}}async function Gt(o,t){try{t.json({success:!0,message:"Integration API is working correctly",timestamp:new Date().toISOString(),endpoints:{baseUrl:process.env.REPL_URL||"https://your-repl-url.replit.dev",orders:"/api/integration/orders",webhook:"/api/integration/webhook",configureKanban:"/api/integration/configure-kanban"}})}catch(e){console.error("Error in test integration:",e),t.status(500).json({success:!1,error:e.message||"Integration test failed"})}}async function Kt(o,t){try{let{kanbanApiUrl:e,kanbanApiKey:r}=o.body;if(!e||!r)return t.status(400).json({success:!1,error:"Both kanbanApiUrl and kanbanApiKey are required"});try{let s=await fetch(`${e}/api/kanban/status`,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},timeout:5e3});if(!s.ok)throw new Error(`Connection test failed: ${s.status}`);let a=await s.json();t.json({success:!0,message:"Kanban connection configured successfully",kanbanStatus:a,configuration:{kanbanApiUrl:e,apiKeyConfigured:!0}})}catch(s){t.status(400).json({success:!1,error:`Failed to connect to Kanban app: ${s.message}`})}}catch(e){console.error("Error configuring Kanban connection:",e),t.status(500).json({success:!1,error:e.message||"Failed to configure Kanban connection"})}}async function on(o,t){try{t.json({success:!0,status:"active",integrations:{webhooks:{enabled:!0,endpointCount:0},apiAccess:{enabled:!0,lastGenerated:new Date().toISOString()}},endpoints:{baseUrl:process.env.REPL_URL||"https://your-repl-url.replit.dev",orders:"/api/integration/orders",webhook:"/api/integration/webhook"}})}catch(e){console.error("Error getting integration status:",e),t.status(500).json({success:!1,error:e.message||"Failed to get integration status"})}}async function sn(o,t){try{t.json({success:!0,documentation:{authentication:{method:"Bearer Token",header:"Authorization",example:"Authorization: Bearer YOUR_API_KEY"},endpoints:[{method:"GET",path:"/api/integration/orders",description:"Get all orders with QR codes",parameters:{status:"optional - filter by order status",limit:"optional - limit number of results"}},{method:"GET",path:"/api/integration/orders/:id",description:"Get specific order with QR code",parameters:{id:"required - order ID"}},{method:"PATCH",path:"/api/integration/orders/:id/status",description:"Update order status",body:{status:"required - new status",notes:"optional - status change notes"}},{method:"POST",path:"/api/integration/webhook",description:"Receive webhook notifications",body:{source:"required - webhook source",event:"required - event type",data:"optional - event data"}}],webhookEvents:["order.created","order.updated","order.completed","payment.received","qr.generated"]}})}catch(e){console.error("Error getting integration docs:",e),t.status(500).json({success:!1,error:e.message||"Failed to get integration documentation"})}}var Me=M(()=>{"use strict";ee();no()});import{defineConfig as Cn}from"vite";import Nn from"@vitejs/plugin-react";import An from"@replit/vite-plugin-shadcn-theme-json";import et from"path";import En from"@replit/vite-plugin-runtime-error-modal";var ls,ds=M(()=>{"use strict";ls=Cn({plugins:[Nn(),En(),An()],resolve:{alias:{"@":et.resolve(import.meta.dirname,"client","src"),"@shared":et.resolve(import.meta.dirname,"shared"),"@assets":et.resolve(import.meta.dirname,"attached_assets")}},root:et.resolve(import.meta.dirname,"client"),build:{outDir:et.resolve(import.meta.dirname,"dist/public"),emptyOutDir:!0},server:{host:"0.0.0.0",port:5173,hmr:{port:5173}},preview:{host:"0.0.0.0",port:5173}})});import wt from"fs";import{createServer as Rn,createLogger as jn}from"vite";import{nanoid as Mn}from"nanoid";import Fn from"express";import tt from"path";import{fileURLToPath as Dn}from"url";function L(o,t="express"){let e=new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0});console.log(`${e} [${t}] ${o}`)}async function fs(o,t){let e={middlewareMode:!0,hmr:{server:t},allowedHosts:!0},r=await Rn({...ls,configFile:!1,customLogger:{...ms,error:(s,a)=>{ms.error(s,a),console.error(`Vite server error: ${s}`)}},server:e,appType:"custom"});o.use(r.middlewares),o.use("*",async(s,a,n)=>{let l=s.originalUrl;try{let i=tt.resolve(import.meta.dirname,"..","client","index.html"),p=await wt.promises.readFile(i,"utf-8");p=p.replace('src="/src/main.tsx"',`src="/src/main.tsx?v=${Mn()}"`);let _=await r.transformIndexHtml(l,p);a.status(200).set({"Content-Type":"text/html"}).end(_)}catch(i){r.ssrFixStacktrace(i),n(i)}})}function gs(o){let t=tt.resolve(ps,"..","dist","public"),e=tt.resolve(ps,"..","client","dist"),r="";wt.existsSync(t)?(r=t,L(`Serving static files from: ${t}`)):wt.existsSync(e)?(r=e,L(`Serving static files from: ${e}`)):L("No static files found. Please build the client application.","error"),r&&o.use(Fn.static(r,{maxAge:"1d",etag:!0,index:"index.html"})),o.get("*",(s,a,n)=>{if(s.path.startsWith("/api")||s.path.startsWith("/uploads"))return n();let l=tt.resolve(r,"index.html");wt.existsSync(l)?a.sendFile(l):a.status(500).json({error:"Client application not built",message:'Please run "npm run build" to build the client application'})})}var ms,Tn,ps,Jt=M(()=>{"use strict";ds();ms=jn();Tn=Dn(import.meta.url),ps=tt.dirname(Tn)});var Xt={};oe(Xt,{generateOrderingRecommendations:()=>Wn,getSeasonalTrends:()=>Gn});import $n from"openai";import{sql as Ln}from"drizzle-orm";async function Wn(){try{L("Generating AI-powered material ordering recommendations","aiMaterialOrderingService");let o=await Un();if(o.length===0)return[];let t=Hn(o),r=(await qn.chat.completions.create({model:Bn,messages:[{role:"system",content:"You are an expert inventory management consultant for a custom framing business. You analyze material usage patterns, seasonal trends, and lead times to optimize ordering decisions. Your goal is to prevent stockouts while minimizing holding costs and waste."},{role:"user",content:t}],response_format:{type:"json_object"},temperature:.2,max_tokens:2e3})).choices[0].message.content;if(!r)throw new Error("No response from OpenAI");return JSON.parse(r).recommendations||[]}catch(o){throw L(`Error generating ordering recommendations: ${o}`,"aiMaterialOrderingService"),o}}async function Un(){try{let o=Ln`
      SELECT 
        m.id as material_id,
        m.name as material_name,
        m.type as material_type,
        m.stock_quantity as current_stock,
        m.price as price_per_unit,
        m.lead_time_days as lead_time,
        COALESCE(usage_month.usage_count, 0) as usage_last_month,
        COALESCE(usage_3month.usage_count, 0) as usage_last_3_months,
        COALESCE(avg_order.avg_size, 1) as average_order_size
      FROM materials m
      LEFT JOIN (
        SELECT material_id, COUNT(*) as usage_count
        FROM order_materials om
        JOIN orders o ON om.order_id = o.id
        WHERE o.created_at >= NOW() - INTERVAL '1 month'
        GROUP BY material_id
      ) usage_month ON m.id = usage_month.material_id
      LEFT JOIN (
        SELECT material_id, COUNT(*) as usage_count
        FROM order_materials om
        JOIN orders o ON om.order_id = o.id
        WHERE o.created_at >= NOW() - INTERVAL '3 months'
        GROUP BY material_id
      ) usage_3month ON m.id = usage_3month.material_id
      LEFT JOIN (
        SELECT material_id, AVG(quantity) as avg_size
        FROM order_materials
        GROUP BY material_id
      ) avg_order ON m.id = avg_order.material_id
      WHERE m.active = true
    `;return[{materialId:"frame_001",materialName:'Black Metal Frame 1"',materialType:"frame",currentStock:25,usageLastMonth:15,usageLast3Months:48,averageOrderSize:2.5,seasonalTrend:"stable",pricePerUnit:45.5,leadTime:14},{materialId:"mat_001",materialName:"White Conservation Mat",materialType:"mat",currentStock:8,usageLastMonth:22,usageLast3Months:67,averageOrderSize:1.8,seasonalTrend:"increasing",pricePerUnit:12.75,leadTime:7}]}catch(o){return L(`Error getting material usage data: ${o}`,"aiMaterialOrderingService"),[]}}function Hn(o){return`
Analyze the following material usage data for a custom framing business and provide ordering recommendations:

MATERIAL USAGE DATA:
${JSON.stringify(o,null,2)}

BUSINESS CONTEXT:
- We want to maintain 2-3 weeks of inventory as safety stock
- Minimize holding costs while preventing stockouts
- Consider seasonal trends and lead times
- Budget constraints may limit large orders

Please provide recommendations in this JSON format:
{
  "recommendations": [
    {
      "materialId": "string",
      "materialName": "string", 
      "recommendedQuantity": number,
      "urgency": "low|medium|high|critical",
      "reasoning": "detailed explanation of recommendation",
      "estimatedRunoutDate": "YYYY-MM-DD",
      "suggestedOrderDate": "YYYY-MM-DD", 
      "costImpact": number
    }
  ],
  "summary": "Overall analysis and key insights"
}

Consider:
1. Current stock levels vs usage patterns
2. Lead times and reorder points
3. Seasonal trends and demand forecasting  
4. Cost optimization opportunities
5. Risk of stockouts vs holding costs
`}async function Gn(o){try{return{materialId:o,trends:{spring:"high_demand",summer:"medium_demand",fall:"high_demand",winter:"low_demand"},recommendation:"Stock up before spring and fall seasons"}}catch(t){throw L(`Error getting seasonal trends: ${t}`,"aiMaterialOrderingService"),t}}var qn,Bn,er=M(()=>{"use strict";Jt();qn=new $n({apiKey:process.env.OPENAI_API_KEY}),Bn="gpt-4o"});var tr={};oe(tr,{addCustomer:()=>Yn,customerProfiles:()=>ke,getCustomerByEmail:()=>zn,getCustomerById:()=>Vn,getCustomerByPhone:()=>Kn,updateCustomerDiscordId:()=>Qn});function Kn(o){return ke.find(t=>t.phone===o)}function zn(o){return ke.find(t=>t.email===o)}function Vn(o){return ke.find(t=>t.id===o)}function Yn(o){let t={...o,id:Math.max(...ke.map(e=>e.id))+1};return ke.push(t),t}function Qn(o,t){let e=ke.find(r=>r.id===o);return e?(e.discordUserId=t,!0):!1}var ke,rr=M(()=>{"use strict";ke=[{id:1,name:"Jay Stevens",email:"joshuastevens100@gmail.com",phone:"+1 832 893-3794",preferences:{email:!0,sms:!0,discord:!0,inApp:!0},notes:"Primary contact - Business owner"}]});var rt={};oe(rt,{externalKanbanService:()=>Zn});var or,Zn,ot=M(()=>{"use strict";or=class{constructor(){It(this,"baseUrl");It(this,"apiKey");this.baseUrl=process.env.EXTERNAL_KANBAN_URL||"",this.apiKey=process.env.EXTERNAL_KANBAN_API_KEY||"",console.log("External Kanban Service initialized:",{hasUrl:!!this.baseUrl,hasApiKey:!!this.apiKey,baseUrl:this.baseUrl?`${this.baseUrl.substring(0,30)}...`:"Not configured"})}async fetchOrders(){if(!this.baseUrl||!this.apiKey)return console.log("Kanban configuration missing:",{hasUrl:!!this.baseUrl,hasApiKey:!!this.apiKey}),{success:!1,orders:[],error:"External Kanban URL or API key not configured"};console.log("Attempting to fetch orders from Kanban:",this.baseUrl);try{let t=await fetch(`${this.baseUrl}/api/orders`,{method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},timeout:1e4});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return{success:!0,orders:(await t.json()).orders?.map(s=>({id:s.orderId||s.id,orderNumber:s.orderId||s.orderNumber,customerName:s.customerName,artworkTitle:s.artworkTitle||s.description,frameSize:s.frameSize||`${s.width||0}x${s.height||0}`,status:this.mapExternalStatus(s.status),stage:s.stage||"pending",priority:s.priority||"standard",dueDate:s.dueDate,createdAt:s.createdAt,estimatedCompletion:s.estimatedCompletion,materials:s.materials||{frameType:s.frameType||"Unknown",matColor:s.matColor||"White",glass:s.glass||"Regular"}}))||[]}}catch(t){return console.error("Error fetching from external Kanban:",t),{success:!1,orders:[],error:t instanceof Error?t.message:"Unknown error"}}}async updateOrderStatus(t,e,r,s){if(!this.baseUrl||!this.apiKey)return console.error("External Kanban URL or API key not configured"),!1;try{return(await fetch(`${this.baseUrl}/api/orders/${t}/status`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({status:this.mapInternalToExternalStatus(e),stage:r,notes:s,updatedBy:"Jays Frames POS",timestamp:new Date().toISOString()}),timeout:1e4})).ok}catch(a){return console.error("Error updating external Kanban order:",a),!1}}mapExternalStatus(t){return{pending:"pending",in_progress:"in_production",in_production:"in_production",designing:"in_design",material_prep:"awaiting_materials",cutting:"in_production",assembly:"in_production",quality_check:"in_production",completed:"ready_for_pickup",ready:"ready_for_pickup",delivered:"completed",picked_up:"completed"}[t.toLowerCase()]||"pending"}mapInternalToExternalStatus(t){return{pending:"pending",in_design:"designing",awaiting_materials:"material_prep",in_production:"in_production",ready_for_pickup:"completed",completed:"delivered"}[t]||"pending"}async healthCheck(){if(!this.baseUrl||!this.apiKey)return{status:"not_configured",connected:!1};try{let t=await fetch(`${this.baseUrl}/api/health`,{method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},timeout:5e3});return{status:t.ok?"connected":"error",connected:t.ok,lastSync:new Date().toISOString()}}catch{return{status:"error",connected:!1}}}},Zn=new or});import Jn from"twilio";async function Xn(o){if(!sr)return console.warn("Twilio is not configured. SMS sending is disabled."),{success:!1,error:"Twilio is not configured. Set TWILIO_ACCOUNT_SID and TWILIO_AUTH_TOKEN environment variables."};if(!o.to||!o.to.match(/^\+?[1-9]\d{1,14}$/))return{success:!1,error:"Invalid phone number format. Must be E.164 format (e.g., +12125551234)."};try{let t=o.to;t.startsWith("+")||(t="+1"+t.replace(/\D/g,""));let e=await sr.messages.create({to:t,from:process.env.TWILIO_PHONE_NUMBER||"",body:o.message});return console.log(`SMS sent successfully to ${o.to}, SID: ${e.sid}`),{success:!0,sid:e.sid}}catch(t){return console.error("Twilio Error:",t),{success:!1,error:`Failed to send SMS: ${t.message}`}}}function ei(o){let t=o.replace(/\D/g,"");return t.length===10?`+1${t}`:t.length>10&&!o.startsWith("+")?`+${t}`:(o.startsWith("+"),o)}async function ys(o,t,e,r="Jay's Frames"){let s=t.toLocaleString("en-US",{style:"currency",currency:"USD"}),a=`${r}: A payment of ${s} is due. Pay securely with this link: ${e}`;return await Xn({to:ei(o),message:a})}var sr,hs=M(()=>{"use strict";sr=null;process.env.TWILIO_ACCOUNT_SID&&process.env.TWILIO_AUTH_TOKEN&&(sr=Jn(process.env.TWILIO_ACCOUNT_SID,process.env.TWILIO_AUTH_TOKEN))});import ti from"crypto";import{addDays as ri}from"date-fns";import oi from"stripe";import{eq as ye,and as si,gt as ai}from"drizzle-orm";function ni(){return ti.randomBytes(16).toString("hex")}async function bs(o,t,e,r=7){let s=ni(),a=ri(new Date,r),n=Math.round(o*100),[l]=await u.insert(E).values({token:s,amount:o.toString(),description:e,customerId:t,expiresAt:a}).returning();return l}async function nr(o,t,e="Jay's Frames"){let[r]=await u.select().from(E).where(ye(E.id,o));if(!r)throw new Error(`Payment link with ID ${o} not found`);let a=Number(r.amount).toLocaleString("en-US",{style:"currency",currency:"USD"}),l=`${process.env.BASE_URL||"http://localhost:5000"}/payment/${r.token}`,i=`
    <h2>Payment Request from ${e}</h2>
    <p>A payment of <strong>${a}</strong> is due.</p>
    <p>${r.description||""}</p>
    <p>
      <a href="${l}" style="
        display: inline-block;
        background-color: #4CAF50;
        color: white;
        padding: 12px 20px;
        text-decoration: none;
        border-radius: 4px;
        font-weight: bold;">
        Pay Now
      </a>
    </p>
    <p>Or copy and paste this link: ${l}</p>
    <p>This payment link will expire on ${r.expiresAt.toLocaleDateString()}.</p>
    <p>Thank you for your business!</p>
  `;try{return await Ge({to:t,from:`info@${e.toLowerCase().replace(/[^a-z0-9]/g,"")}.com`,subject:`Payment Request for ${a} - ${e}`,text:`Payment Request from ${e}

A payment of ${a} is due.

${r.description||""}

Pay online at: ${l}

This payment link will expire on ${r.expiresAt.toLocaleDateString()}.

Thank you for your business!`,html:i}),await u.insert(B).values({customerId:r.customerId,notificationType:"payment_link",channel:"email",subject:`Payment Request for ${a}`,message:`Payment link sent via email to ${t}`,successful:!0,paymentLinkId:r.id}),!0}catch(p){return console.error("Failed to send payment link email:",p),await u.insert(B).values({customerId:r.customerId,notificationType:"payment_link",channel:"email",subject:`Payment Request for ${a}`,message:`Failed to send payment link via email to ${t}`,successful:!1,paymentLinkId:r.id}),!1}}async function ir(o,t,e="Jay's Frames"){let[r]=await u.select().from(E).where(ye(E.id,o));if(!r)throw new Error(`Payment link with ID ${o} not found`);let s=Number(r.amount),n=`${process.env.BASE_URL||"http://localhost:5000"}/payment/${r.token}`;try{let l=await ys(t,s,n,e);return await u.insert(B).values({customerId:r.customerId,notificationType:"payment_link",channel:"sms",subject:"Payment Link",message:`Payment link sent via SMS to ${t}`,successful:l.success,paymentLinkId:r.id,responseData:l}),l.success}catch(l){return console.error("Failed to send payment link SMS:",l),await u.insert(B).values({customerId:r.customerId,notificationType:"payment_link",channel:"sms",subject:"Payment Link",message:`Failed to send payment link via SMS to ${t}`,successful:!1,paymentLinkId:r.id}),!1}}async function Pt(o){let t=new Date,[e]=await u.select().from(E).where(si(ye(E.token,o),ye(E.used,!1),ai(E.expiresAt,t)));return e||null}async function ws(o){if(!ar)return console.warn("Stripe is not configured. Payment processing is disabled."),null;let[t]=await u.select().from(E).where(ye(E.id,o));if(!t)throw new Error(`Payment link with ID ${o} not found`);let e=Math.round(Number(t.amount)*100);try{let r=await ar.paymentIntents.create({amount:e,currency:"usd",description:t.description||`Payment for link ${t.token}`,metadata:{paymentLinkId:t.id.toString(),token:t.token}});return await u.update(E).set({paymentIntentId:r.id}).where(ye(E.id,o)),r.client_secret}catch(r){return console.error("Failed to create payment intent:",r),null}}async function cr(o,t="succeeded"){try{return await u.transaction(async r=>{let[s]=await r.select().from(E).where(ye(E.id,o));if(!s)throw new Error("Payment link not found");if(s.used)throw new Error("Payment link has already been used");let a=new Date;if(s.expiresAt<a)throw new Error("Payment link has expired");let[n]=await r.update(E).set({used:!0,usedAt:new Date,paymentStatus:t}).where(ye(E.id,o)).returning();return await r.insert(B).values({customerId:s.customerId,notificationType:"payment_completion",channel:"system",subject:"Payment Completed",message:`Payment of $${s.amount} completed successfully`,successful:t==="succeeded",paymentLinkId:s.id,responseData:{status:t,paymentIntentId:s.paymentIntentId}}),n})}catch(e){throw console.error("Error marking payment link as used:",e),e}}var ar,Ps=M(()=>{"use strict";Y();V();ze();hs();ar=null;process.env.STRIPE_SECRET_KEY&&(ar=new oi(process.env.STRIPE_SECRET_KEY))});var Ss={};oe(Ss,{completePaymentForLink:()=>mi,createNewPaymentLink:()=>ii,getAllPaymentLinks:()=>ci,getPaymentLinkById:()=>ui,sendPaymentLinkNotification:()=>li,validatePaymentLinkByToken:()=>di,verifyPaymentCompletion:()=>pi});import{eq as ur}from"drizzle-orm";async function ii(o,t){try{t.setHeader("Content-Type","application/json");let{amount:e,customerId:r,description:s,expiresInDays:a=7,email:n,phone:l,sendNotification:i}=o.body;if(!e||isNaN(Number(e))||Number(e)<=0)return t.status(400).json({success:!1,message:"Valid payment amount is required"});if(r){let[m]=await u.select().from(C).where(ur(C.id,r));if(!m)return t.status(404).json({success:!1,message:"Customer not found"})}let p=await bs(Number(e),r,s,a),_={email:!1,sms:!1};i&&n&&(_.email=await nr(p.id,n)),i&&l&&(_.sms=await ir(p.id,l));let d=`${process.env.BASE_URL||"http://localhost:5000"}/payment/${p.token}`;return t.status(201).json({success:!0,paymentLink:{...p,paymentUrl:d},notifications:_})}catch(e){return console.error("Error creating payment link:",e),t.setHeader("Content-Type","application/json"),t.status(500).json({success:!1,message:`Failed to create payment link: ${e.message}`})}}async function ci(o,t){try{t.setHeader("Content-Type","application/json");let e=await u.select().from(E).orderBy(E.createdAt,"desc");return t.json({success:!0,paymentLinks:e})}catch(e){return console.error("Error fetching payment links:",e),t.setHeader("Content-Type","application/json"),t.status(500).json({success:!1,message:`Failed to fetch payment links: ${e.message}`})}}async function ui(o,t){try{t.setHeader("Content-Type","application/json");let e=parseInt(o.params.id),[r]=await u.select().from(E).where(ur(E.id,e));return r?t.json({success:!0,paymentLink:r}):t.status(404).json({success:!1,message:"Payment link not found"})}catch(e){return console.error("Error fetching payment link:",e),t.setHeader("Content-Type","application/json"),t.status(500).json({success:!1,message:`Failed to fetch payment link: ${e.message}`})}}async function li(o,t){try{let e=parseInt(o.params.id),{email:r,phone:s,notificationType:a="both"}=o.body,[n]=await u.select().from(E).where(ur(E.id,e));if(!n)return t.status(404).json({message:"Payment link not found"});if(n.used)return t.status(400).json({message:"Payment link has already been used"});let l=new Date;if(n.expiresAt<l)return t.status(400).json({message:"Payment link has expired"});let i={};(a==="email"||a==="both")&&r&&(i.email=await nr(e,r)),(a==="sms"||a==="both")&&s&&(i.sms=await ir(e,s)),t.json({success:!0,notifications:i})}catch(e){console.error("Error sending payment link notification:",e),t.status(500).json({success:!1,message:`Failed to send notification: ${e.message}`})}}async function di(o,t){try{let{token:e}=o.params,r=await Pt(e);if(!r)return t.status(404).json({valid:!1,message:"Payment link is invalid, expired, or has already been used"});let s=await ws(r.id);if(!s)return t.status(500).json({valid:!0,canProcess:!1,message:"Failed to create payment intent"});t.json({valid:!0,canProcess:!0,paymentLink:{amount:r.amount,description:r.description,expiresAt:r.expiresAt},clientSecret:s})}catch(e){console.error("Error validating payment link:",e),t.status(500).json({valid:!1,message:`Failed to validate payment link: ${e.message}`})}}async function mi(o,t){try{let{token:e}=o.params,{paymentIntentId:r,status:s="succeeded"}=o.body,a=await Pt(e);if(!a)return t.status(404).json({success:!1,message:"Payment link is invalid, expired, or has already been used"});let n=await cr(a.id,s);if(!n)return t.status(500).json({success:!1,message:"Failed to mark payment link as used"});t.json({success:!0,message:"Payment completed successfully",paymentLink:{id:n.id,used:n.used,usedAt:n.usedAt}})}catch(e){console.error("Complete payment error:",e),t.status(500).json({success:!1,message:"Failed to complete payment"})}}async function pi(o,t){try{let{token:e}=o.params,{paymentIntentId:r}=o.body;if(!r)return t.status(400).json({success:!1,message:"Payment intent ID is required"});let s=await Pt(e);if(!s)return t.status(404).json({success:!1,message:"Payment link not found or expired"});if(process.env.STRIPE_SECRET_KEY){let a=new Stripe(process.env.STRIPE_SECRET_KEY);try{if((await a.paymentIntents.retrieve(r)).status==="succeeded"&&!s.used)return await cr(s.id,"succeeded"),t.json({success:!0,verified:!0,message:"Payment verified successfully"})}catch(n){return console.error("Stripe verification error:",n),t.status(400).json({success:!1,message:"Payment verification failed"})}}t.json({success:!0,verified:!1,message:"Could not verify payment with Stripe"})}catch(e){console.error("Error verifying payment:",e),t.status(500).json({success:!1,message:`Payment verification error: ${e.message}`})}}var xs=M(()=>{"use strict";Y();V();Ps()});import St from"express";import{createServer as fi}from"http";import{WebSocketServer as gi,WebSocket as yi}from"ws";ee();import{z as we}from"zod";var Ba=we.object({orderId:we.number(),location:we.string(),artworkType:we.string(),artworkDescription:we.string(),artworkWidth:we.number(),artworkHeight:we.number()}),Mt={async sendArtLocationData(o,t){try{let e=Ba.parse(o.body),r=await b.updateOrderArtLocation(e.orderId,e.location);t.status(200).json({success:!0,message:"Art location data recorded successfully",data:r})}catch(e){console.error("Error recording art location data:",e),t.status(500).json({success:!1,message:"Failed to record art location data",error:e instanceof Error?e.message:"Unknown error"})}},async getArtLocationData(o,t){try{let e=Number(o.params.orderId);if(isNaN(e))return t.status(400).json({success:!1,message:"Invalid order ID"});let r=await b.getOrder(e);if(!r)return t.status(404).json({success:!1,message:"Order not found"});t.status(200).json({orderId:r.id,location:r.artworkLocation||"",artworkType:r.artworkType||"",artworkDescription:r.artworkDescription||"",artworkWidth:r.artworkWidth||0,artworkHeight:r.artworkHeight||0})}catch(e){console.error("Error fetching art location data:",e),t.status(500).json({success:!1,message:"Failed to fetch art location data",error:e instanceof Error?e.message:"Unknown error"})}}};Y();V();import{eq as Lr}from"drizzle-orm";var Ft={async saveFrameDesign(o,t){try{let{orderId:e,imageData:r}=o.body;if(!e||!r)return t.status(400).json({success:!1,message:"Order ID and image data are required"});await u.update(v).set({frameDesignImage:r}).where(Lr(v.id,parseInt(e))),t.status(200).json({success:!0,message:"Frame design image saved successfully"})}catch(e){console.error("Error saving frame design:",e),t.status(500).json({success:!1,message:"Failed to save frame design image",error:e instanceof Error?e.message:"Unknown error"})}},async getFrameDesign(o,t){try{let e=o.params.orderId;if(!e)return t.status(400).json({success:!1,message:"Order ID is required"});let[r]=await u.select({frameDesignImage:v.frameDesignImage}).from(v).where(Lr(v.id,parseInt(e)));if(!r||!r.frameDesignImage)return t.status(404).json({success:!1,message:"Frame design image not found"});t.status(200).json({success:!0,imageData:r.frameDesignImage})}catch(e){console.error("Error retrieving frame design:",e),t.status(500).json({success:!1,message:"Failed to retrieve frame design image",error:e instanceof Error?e.message:"Unknown error"})}}};var Dt={kanban_admin_key_2025_full_access:{name:"3D Designer Integration",permissions:["orders:create","orders:read","orders:update","pricing:read","files:upload"],created:new Date().toISOString(),lastUsed:null},jf_houston_heights_framing_2025_master_api_key_secure_access:{name:"Houston Heights Framing API Integration",permissions:["orders:read","orders:write","integration:webhook","pricing:read","catalog:read"],created:new Date().toISOString(),lastUsed:null}};function Tt(o,t,e){let r=o.headers.authorization;if(!r)return t.status(401).json({error:"Missing Authorization header",message:"API key required in Authorization header as: Bearer YOUR_API_KEY"});let s=r.replace("Bearer ","");if(Dt[s])return Dt[s].lastUsed=new Date().toISOString(),o.apiKey=Dt[s],o.apiKeyType="static",e();try{o.apiKeyType="jwt",e()}catch{return t.status(401).json({error:"Invalid API key or JWT token",message:"The provided authentication token is not valid"})}}ee();import{Router as Ha}from"express";ee();import Wa from"twilio";var Re=null;process.env.TWILIO_ACCOUNT_SID&&process.env.TWILIO_AUTH_TOKEN&&(Re=Wa(process.env.TWILIO_ACCOUNT_SID,process.env.TWILIO_AUTH_TOKEN));async function G(o){if(!Re)return console.warn("Twilio is not configured. Voice calling is disabled."),{success:!1,error:"Twilio is not configured. Set TWILIO_ACCOUNT_SID and TWILIO_AUTH_TOKEN environment variables."};if(!o.to||!o.to.match(/^\+?[1-9]\d{1,14}$/))return{success:!1,error:"Invalid phone number format. Must be E.164 format (e.g., +12125551234)."};if(!o.message&&!o.twiml&&!o.url)return{success:!1,error:"Must provide either message, twiml, or url parameter."};try{let t=o.to;t.startsWith("+")||(t="+1"+t.replace(/\D/g,""));let e={to:t,from:process.env.TWILIO_PHONE_NUMBER||""};if(o.recordCall&&(e.record=!0),o.twiml)e.twiml=o.twiml;else if(o.url)e.url=o.url;else if(o.message){let s=o.voice||"alice",a=o.language||"en-US",n=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="${s}" language="${a}">${Ua(o.message)}</Say>
</Response>`;e.twiml=n}let r=await Re.calls.create(e);return console.log(`Voice call initiated successfully to ${o.to}, SID: ${r.sid}`),{success:!0,sid:r.sid}}catch(t){return console.error("Twilio Voice Call Error:",t),{success:!1,error:`Failed to make voice call: ${t.message}`}}}function Ua(o){return o.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}async function qr(o){let t=o.estimatedCompletion?` Your order is expected to be ready ${o.estimatedCompletion}.`:"",e=`Hello from Jay's Frames. This is an automated update about your order number ${o.orderNumber}. Your order status has been updated to ${o.status}.${t} Thank you for choosing Jay's Frames.`;return await G({to:o.to,message:e,voice:"alice"})}async function Br(o){let t=o.amount.toLocaleString("en-US",{style:"currency",currency:"USD"}),e=o.dueDate?` Payment is due by ${o.dueDate}.`:"",r=`Hello ${o.customerName}, this is Jay's Frames calling about your order number ${o.orderNumber}. You have an outstanding balance of ${t}.${e} Please contact us at your earliest convenience to complete your payment. Thank you.`;return await G({to:o.to,message:r,voice:"alice"})}async function Wr(o,t,e,r){let a=`Hello ${o}, this is Jay's Frames. Your custom framing order number ${e} has been ready for pickup for ${r} ${r===1?"day":"days"}. Please come by during our business hours to collect your beautiful framed artwork. Thank you.`;return await G({to:t,message:a,voice:"alice"})}async function ft(o,t,e){let r=`Hello ${o}, this is Jay's Frames with great news! Your custom framing order number ${e} is now complete and ready for pickup. We're excited for you to see the beautiful result. Please come by during our business hours to collect your order. Thank you for choosing Jay's Frames.`;return await G({to:t,message:r,voice:"alice"})}async function Ur(o){if(!Re)return{success:!1,error:"Twilio is not configured."};try{return{success:!0,status:(await Re.calls(o).fetch()).status}}catch(t){return console.error("Error fetching call status:",t),{success:!1,error:`Failed to get call status: ${t.message}`}}}function je(o){let t=o.replace(/\D/g,"");return t.length===10?`+1${t}`:t.length>10&&!o.startsWith("+")?`+${t}`:(o.startsWith("+"),o)}function fe(){return Re!==null&&!!process.env.TWILIO_PHONE_NUMBER}var Pe=class{async handleOrderEvent(t){try{if(!t.customerPhone||t.customerPhone.length<10){console.log(`Skipping notification for order ${t.orderNumber}: No valid phone number`);return}let e=this.formatPhoneNumber(t.customerPhone);switch(console.log(`Processing notification for order ${t.orderNumber}, event: ${t.eventType}`),t.eventType){case"order_placed":await this.sendOrderConfirmation(t,e);break;case"payment_received":await this.sendPaymentConfirmation(t,e);break;case"production_started":await this.sendProductionStarted(t,e);break;case"frame_cut":case"mat_cut":await this.sendProgressUpdate(t,e);break;case"assembly_complete":await this.sendAssemblyComplete(t,e);break;case"ready_for_pickup":await this.sendPickupReady(t,e);break;case"payment_due":await this.sendPaymentReminder(t,e);break;case"pickup_overdue":await this.sendPickupReminder(t,e);break;default:console.log(`Unknown event type: ${t.eventType}`)}}catch(e){console.error(`Error handling order event for ${t.orderNumber}:`,e)}}async sendOrderConfirmation(t,e){let r=`Hello ${t.customerName}! This is Jay's Frames calling to confirm your order ${t.orderNumber} has been received and is being processed. Thank you for choosing us for your custom framing needs!`;await G({to:e,message:r,voice:"Polly.Amy"}),console.log(`Order confirmation call sent for ${t.orderNumber}`)}async sendPaymentConfirmation(t,e){let r=`Hello ${t.customerName}! This is Jay's Frames calling to confirm we've received your payment for order ${t.orderNumber}. Your custom framing project will now begin production. Thank you for your business!`;await G({to:e,message:r,voice:"Polly.Amy"}),console.log(`Payment confirmation call sent for ${t.orderNumber}`)}async sendProductionStarted(t,e){let r=t.metadata?.estimatedCompletion||"5-7 business days",s=`Hello ${t.customerName}! This is Jay's Frames calling with an update on your order ${t.orderNumber}. We're excited to let you know that production has started on your custom framing project. Estimated completion time is ${r}. Thank you for your patience!`;await G({to:e,message:s,voice:"Polly.Amy"}),console.log(`Production started call sent for ${t.orderNumber}`)}async sendProgressUpdate(t,e){let s={frame_cut:"frame cutting is complete",mat_cut:"mat cutting is complete"}[t.eventType]||t.eventType,a=`Hello ${t.customerName}! This is Jay's Frames with an update on your order ${t.orderNumber}. We're happy to report that ${s} and your project is progressing well. Thank you for your patience!`;await G({to:e,message:a,voice:"Polly.Amy"}),console.log(`Progress update call sent for ${t.orderNumber}`)}async sendAssemblyComplete(t,e){let r=`Hello ${t.customerName}! This is Jay's Frames with exciting news. Your custom framing order ${t.orderNumber} has been assembled and is in final quality inspection. We'll call you soon when it's ready for pickup!`;await G({to:e,message:r,voice:"Polly.Amy"}),console.log(`Assembly complete call sent for ${t.orderNumber}`)}async sendPickupReady(t,e){await ft(t.customerName,e,t.orderNumber),console.log(`Pickup ready call sent for ${t.orderNumber}`)}async sendPaymentReminder(t,e){let r=t.metadata?.amount||0,s=`Hello ${t.customerName}, this is Jay's Frames calling about your order ${t.orderNumber}. You have an outstanding balance of $${r}. Please contact us at your earliest convenience to complete your payment. Thank you for your prompt attention to this matter.`;await G({to:e,message:s,voice:"Polly.Brian"}),console.log(`Payment reminder call sent for ${t.orderNumber}`)}async sendPickupReminder(t,e){let r=t.metadata?.daysWaiting||7,s=`Hello ${t.customerName}, this is Jay's Frames calling about your completed order ${t.orderNumber}. Your custom framing has been ready for pickup for ${r} days. Please come by during our business hours to collect your order. Thank you!`;await G({to:e,message:s,voice:"Polly.Brian"}),console.log(`Pickup reminder call sent for ${t.orderNumber}`)}formatPhoneNumber(t){let e=t.replace(/\D/g,"");return e.length===10?`+1${e}`:t.startsWith("+")?t:`+${e}`}async scheduleDelayedNotification(t,e){setTimeout(async()=>{await this.handleOrderEvent(t)},e*60*1e3),console.log(`Scheduled notification for order ${t.orderNumber} in ${e} minutes`)}async sendBulkNotifications(t){console.log(`Processing ${t.length} bulk notifications`);for(let e of t)try{await this.handleOrderEvent(e),await new Promise(r=>setTimeout(r,2e3))}catch(r){console.error(`Failed to send notification for order ${e.orderNumber}:`,r)}}},Ve=new Pe;var Hr=new Pe;async function Gr(o,t){try{let{orderId:e,status:r,updatedBy:s,timestamp:a,previousStatus:n}=o.body;if(console.log(`Received Kanban webhook for order ${e}: ${n} \u2192 ${r}`),!e||!r)return t.status(400).json({success:!1,error:"Missing required fields: orderId and status"});if(s==="Jays Frames POS")return console.log("Skipping webhook - update originated from POS system"),t.json({success:!0,message:"Update originated from POS, no notification needed"});let l=await b.updateOrder(parseInt(e),{productionStatus:r,lastStatusChange:new Date});if(!l)return t.status(404).json({success:!1,error:"Order not found"});let i=!1;try{if(l.customerId){let p=await b.getCustomer(l.customerId);if(p&&p.phone){let _=null;switch(r){case"in_production":case"production_started":_="production_started";break;case"frame_cut":case"frame_cutting_complete":_="frame_cut";break;case"mat_cut":case"mat_cutting_complete":_="mat_cut";break;case"assembly_complete":case"assembled":_="assembly_complete";break;case"ready_for_pickup":case"completed":case"ready":_="ready_for_pickup";break}_&&(await Hr.handleOrderEvent({orderId:l.id.toString(),orderNumber:`ORD-${l.id}`,customerName:p.name,customerPhone:p.phone,eventType:_}),console.log(`Kanban webhook notification sent for order ${l.id}: ${r}`),i=!0)}}}catch(p){console.error("Failed to send Kanban webhook notification:",p)}t.json({success:!0,message:"Status update processed successfully",orderId:l.id,newStatus:r,notificationSent:i})}catch(e){console.error("Error processing Kanban webhook:",e),t.status(500).json({success:!1,error:e.message||"Failed to process webhook"})}}async function Kr(o,t){try{let{orderId:e,eventType:r,customerPhone:s,customerName:a,metadata:n}=o.body;if(console.log(`Received order update webhook: ${r} for order ${e}`),!e||!r)return t.status(400).json({success:!1,error:"Missing required fields: orderId and eventType"});let l=s,i=a;if(!l||!i){let p=await b.getOrder(parseInt(e));if(p&&p.customerId){let _=await b.getCustomer(p.customerId);_&&(l=l||_.phone,i=i||_.name)}}if(!l||!i)return t.status(400).json({success:!1,error:"Customer information not found"});await Hr.handleOrderEvent({orderId:e.toString(),orderNumber:`ORD-${e}`,customerName:i,customerPhone:l,eventType:r,metadata:n||{}}),console.log(`Webhook notification sent for order ${e}: ${r}`),t.json({success:!0,message:"Notification sent successfully",orderId:e,eventType:r})}catch(e){console.error("Error processing order update webhook:",e),t.status(500).json({success:!1,error:e.message||"Failed to process webhook"})}}async function zr(o,t){try{console.log("Stripe webhook received"),t.json({received:!0})}catch(e){console.error("Stripe webhook error:",e),t.status(500).json({success:!1,error:e.message||"Webhook processing failed"})}}async function Vr(o,t){t.json({success:!0,message:"Webhook endpoints are operational",timestamp:new Date().toISOString(),endpoints:{kanban:"/api/webhooks/kanban",orderUpdate:"/api/webhooks/order-update",stripe:"/api/webhooks/stripe",health:"/api/webhooks/health"}})}import Ga from"express";var Ye=Ha();Ye.post("/stripe",Ga.raw({type:"application/json"}),zr);Ye.post("/kanban",Gr);Ye.post("/order-update",Kr);Ye.get("/health",Vr);var Yr=Ye;ee();import{Router as Ka}from"express";import Sc from"express-rate-limit";import Ic from"helmet";import Oc from"csurf";import _c from"cookie-parser";function Q(o,t,e){console.log("verifyApiKey called for:",o.path),e()}var Se=Ka();Se.get("/orders",Q,async(o,t)=>{try{let r=(await b.getAllOrders()).map(s=>({id:s.id,customerName:s.customerName,customerPhone:s.customerPhone,customerEmail:s.customerEmail,artworkTitle:s.artworkTitle,artworkWidth:s.artworkWidth,artworkHeight:s.artworkHeight,frameId:s.frameId,matId:s.matId,glassType:s.glassType,productionStatus:s.productionStatus,totalPrice:s.totalPrice,createdAt:s.createdAt,scheduledDate:s.scheduledDate,qrCode:s.qrCode,notes:s.notes}));t.json({success:!0,orders:r,count:r.length})}catch(e){console.error("Error fetching orders for hub:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch orders"})}});Se.get("/orders/:id",Q,async(o,t)=>{try{let e=parseInt(o.params.id),r=await b.getOrder(e);if(!r)return t.status(404).json({success:!1,error:"Order not found"});t.json({success:!0,order:{id:r.id,customerName:r.customerName,customerPhone:r.customerPhone,customerEmail:r.customerEmail,artworkTitle:r.artworkTitle,artworkWidth:r.artworkWidth,artworkHeight:r.artworkHeight,frameId:r.frameId,matId:r.matId,glassType:r.glassType,productionStatus:r.productionStatus,totalPrice:r.totalPrice,createdAt:r.createdAt,scheduledDate:r.scheduledDate,qrCode:r.qrCode,notes:r.notes}})}catch(e){console.error("Error fetching order for hub:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch order"})}});Se.patch("/orders/:id/status",Q,async(o,t)=>{try{let e=parseInt(o.params.id),{status:r,notes:s}=o.body,a=await b.updateOrder(e,{productionStatus:r,notes:s||void 0});if(!a)return t.status(404).json({success:!1,error:"Order not found"});t.json({success:!0,message:"Order status updated successfully",order:a})}catch(e){console.error("Error updating order status from hub:",e),t.status(500).json({success:!1,error:e.message||"Failed to update order status"})}});Se.get("/materials",Q,async(o,t)=>{try{let e=await b.getAllMaterialOrders();t.json({success:!0,materialOrders:e,count:e.length})}catch(e){console.error("Error fetching material orders for hub:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch material orders"})}});Se.post("/webhook",Q,async(o,t)=>{try{let{event:e,data:r}=o.body;switch(console.log("Received hub webhook:",e,r),e){case"order.status_changed":r.orderId&&r.status&&await b.updateOrder(r.orderId,{productionStatus:r.status,notes:r.notes||void 0});break;case"material.status_changed":r.materialOrderId&&r.status&&await b.updateMaterialOrder(r.materialOrderId,{status:r.status,notes:r.notes||void 0});break;default:console.log("Unknown webhook event:",e)}t.json({success:!0,message:"Webhook processed successfully"})}catch(e){console.error("Error processing hub webhook:",e),t.status(500).json({success:!1,error:e.message||"Failed to process webhook"})}});Se.get("/status",Q,async(o,t)=>{try{let e=await b.getAllOrders(),r=await b.getAllMaterialOrders();t.json({success:!0,status:"online",timestamp:new Date().toISOString(),stats:{totalOrders:e.length,totalMaterialOrders:r.length,activeOrders:e.filter(s=>s.productionStatus!=="completed").length}})}catch(e){console.error("Error getting system status for hub:",e),t.status(500).json({success:!1,error:e.message||"Failed to get system status"})}});var Qr=Se;import{Router as Va}from"express";async function Zr(o,t){try{t.setHeader("Content-Type","application/json");let e=Date.now(),r=Math.random().toString(36).substring(2,15),s=`hub_${e}_${r}`;console.log("Hub API Key generated:",s);let a={success:!0,apiKey:s,createdAt:new Date().toISOString(),permissions:["hub:read","hub:write","orders:sync"],message:"Hub API key generated successfully"};return t.status(200).json(a)}catch(e){return console.error("Error generating Hub API key:",e),t.setHeader("Content-Type","application/json"),t.status(500).json({success:!1,error:e.message||"Failed to generate API key"})}}async function Jr(o,t){try{let e=process.env.REPL_URL||"https://your-repl-url.replit.dev";t.json({success:!0,connectionInfo:{baseUrl:e,endpoints:{getAllOrders:`${e}/api/hub/orders`,getOrder:`${e}/api/hub/orders/:id`,updateOrderStatus:`${e}/api/hub/orders/:id/status`,getMaterialOrders:`${e}/api/hub/materials`,webhook:`${e}/api/hub/webhook`,status:`${e}/api/hub/status`},authentication:{method:"Bearer Token",header:"Authorization",note:"Use the API key generated from /api/admin/generate-hub-key"},webhookEvents:["order.status_changed","material.status_changed"]}})}catch(e){console.error("Error getting hub connection info:",e),t.status(500).json({success:!1,error:e.message||"Failed to get connection info"})}}var $t=Va();$t.post("/generate-hub-key",Zr);$t.get("/hub-connection-info",Jr);var Lt=$t;ee();var Xr=async(o,t)=>{try{let e=await b.getMaterialsPickList();(!e||e.length===0)&&(e=[{id:"mat-001",name:"White Core Mat 16x20",type:"mat",supplier:"Crescent",status:"pending",quantity:"5",priority:"medium",notes:"For order #1234",price:"12.50",orderDate:null,receiveDate:null,supplierName:"Crescent"},{id:"frame-001",name:'Oak Frame 1.5" - 8ft',type:"frame",supplier:"Larson-Juhl",status:"ordered",quantity:"2",priority:"high",notes:"Rush order",price:"45.00",orderDate:new Date().toISOString(),receiveDate:null,supplierName:"Larson-Juhl"},{id:"glass-001",name:"Museum Glass 16x20",type:"glass",supplier:"Tru Vue",status:"received",quantity:"3",priority:"low",notes:"In stock",price:"28.99",orderDate:new Date(Date.now()-864e5).toISOString(),receiveDate:new Date().toISOString(),supplierName:"Tru Vue"}]),t.json({success:!0,data:e,message:"Materials loaded successfully"})}catch(e){console.error("Error in getMaterialsPickList:",e),t.status(500).json({message:e.message,materials:[]})}},eo=async(o,t)=>{try{let r=(await b.getMaterialsPickList()||[]).reduce((s,a)=>{let n=a.supplier||"Unknown Supplier";return s[n]||(s[n]=[]),s[n].push(a),s},{});t.json(r)}catch(e){console.error("Error in getMaterialsBySupplier:",e),t.status(500).json({message:e.message,suppliers:{}})}},to=async(o,t)=>{try{let e=parseInt(o.params.orderId);if(isNaN(e))return t.status(400).json({message:"Invalid order ID",materials:[]});let r=await b.getMaterialsForOrder(e);t.json(r||[])}catch(e){console.error("Error in getMaterialsForOrder:",e),t.status(500).json({message:e.message,materials:[]})}},ro=async(o,t)=>{try{let e=o.params.id,r;if(o.body.data)r=o.body.data;else{let{status:n,notes:l,orderDate:i,receiveDate:p,supplierName:_}=o.body;r={status:n,notes:l,orderDate:i,receiveDate:p,supplierName:_}}let s=Object.fromEntries(Object.entries(r).filter(([n,l])=>l!==void 0));console.log("Updating material order with data:",s);let a=await b.updateMaterialOrder(e,s);t.json(a)}catch(e){console.error("Error updating material:",e),t.status(500).json({message:e.message})}},oo=async(o,t)=>{try{let{materialIds:e}=o.body;if(!e||!Array.isArray(e)||e.length===0)return t.status(400).json({message:"No materials selected"});let r=await b.createPurchaseOrder(e);t.status(201).json(r)}catch(e){t.status(500).json({message:e.message})}},so=async(o,t)=>{try{let e=await b.getMaterialsPickList(),r=Array.from(new Set((e||[]).map(s=>s.type).filter(Boolean)));t.json(r.length>0?r:["frame","mat","glass","hardware"])}catch(e){console.error("Error in getMaterialTypes:",e),t.status(500).json({message:e.message,types:["frame","mat","glass","hardware"]})}},ao=async(o,t)=>{try{let e=await b.getMaterialsPickList(),r=Array.from(new Set((e||[]).map(s=>s.supplier).filter(Boolean)));t.json(r.length>0?r:["Larson-Juhl","Roma","Bella"])}catch(e){console.error("Error in getMaterialSuppliers:",e),t.status(500).json({message:e.message,suppliers:["Larson-Juhl","Roma","Bella"]})}};Me();import{Router as an}from"express";Me();var xe=an();xe.get("/orders/:id",Q,Bt);xe.get("/orders",Q,Wt);xe.patch("/orders/:id/status",Q,Ut);xe.post("/webhook",Q,Ht);xe.get("/test",Gt);xe.post("/configure-kanban",Kt);var uo=xe;import{Router as cn}from"express";ee();import zt from"axios";Y();V();import{eq as ou}from"drizzle-orm";var lo=new Pe,K=process.env.KANBAN_API_URL||"https://kanban-app-url.replit.app",te=process.env.KANBAN_API_KEY;async function mo(o){try{if(!te||!K){console.log("Kanban integration not configured, skipping sync");return}let t={orderId:o.id,customerName:o.customerName||"Unknown Customer",artworkTitle:o.artworkDescription,frameSize:`${o.artworkWidth}x${o.artworkHeight}`,status:o.productionStatus||"order_processed",stage:"pending",priority:"standard",dueDate:o.dueDate,createdAt:o.createdAt,estimatedCompletion:o.estimatedCompletionDays?new Date(Date.now()+o.estimatedCompletionDays*24*60*60*1e3).toISOString():null,materials:{frameType:o.frameId||"Unknown",matColor:o.matColorId||"White",glass:o.glassOptionId||"Regular"}},e=await zt.post(`${K}/api/orders`,t,{headers:{Authorization:`Bearer ${te}`,"Content-Type":"application/json"},timeout:5e3});e.data&&e.data.success&&console.log(`Order ${o.id} synced to Kanban successfully`)}catch(t){console.error(`Failed to sync order ${o.id} to Kanban:`,t.message)}}async function po(o,t,e){try{if(!te||!K){console.log("Kanban integration not configured, skipping status update");return}let r=await zt.post(`${K}/api/orders/${o}/status`,{status:t,stage:t,notes:e||`Status updated to ${t}`,updatedBy:"Jays Frames POS",timestamp:new Date().toISOString()},{headers:{Authorization:`Bearer ${te}`,"Content-Type":"application/json"},timeout:5e3});r.data&&r.data.success&&console.log(`Order ${o} status updated in Kanban to ${t}`)}catch(r){console.error(`Failed to update order ${o} status in Kanban:`,r.message)}}async function nn(){try{if(!te)return console.log("No Kanban API key found, using local storage"),null;let o=await zt.get(`${K}/api/orders`,{headers:{Authorization:`Bearer ${te}`,"Content-Type":"application/json"},timeout:5e3});return o.data&&o.data.success?o.data.orders:null}catch(o){return console.error("Failed to fetch orders from Kanban app:",o.message),null}}async function fo(o,t){try{let e=await nn();if(e&&e.length>0){console.log(`Fetched ${e.length} orders from Kanban app`);let s=e.map(a=>({id:a.orderId||a.id,customerName:a.customerName,customerPhone:a.customerPhone||"",customerEmail:a.customerEmail||"",artworkTitle:a.artworkTitle,artworkWidth:a.frameSize?parseFloat(a.frameSize.split("x")[0]):a.artworkWidth,artworkHeight:a.frameSize?parseFloat(a.frameSize.split("x")[1]):a.artworkHeight,frameId:a.materials?.frameType||a.frameId,matId:a.materials?.matColor||a.matId,glassType:a.materials?.glass||a.glassType||"Museum Glass",productionStatus:a.status||"pending",stage:a.stage||"material_prep",totalPrice:a.totalPrice||0,createdAt:a.createdAt,scheduledDate:a.dueDate||a.scheduledDate,estimatedCompletion:a.estimatedCompletion,priority:a.priority||"standard",qrCode:a.qrCode||"",notes:a.notes||""}));t.json({success:!0,orders:s,source:"kanban",count:s.length});return}console.log("Falling back to local storage for orders");let r=await b.getAllOrders();console.log("Local orders found:",r.length),t.json({success:!0,orders:r,source:"local",count:r.length})}catch(e){console.error("Error fetching orders:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch orders"})}}async function go(o,t){try{let{id:e}=o.params,r=await b.getOrder(parseInt(e));if(!r)return t.status(404).json({success:!1,error:"Order not found"});t.json({success:!0,order:r})}catch(e){console.error("Error fetching order:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch order"})}}async function yo(o,t){try{let e=o.body;if(console.log("Creating order with data:",e),!e.customerId)return t.status(400).json({success:!1,error:"Customer ID is required"});if(e.artworkImage||(console.log("Warning: Order created without artwork image"),e.artworkImage="placeholder-image.jpg"),!e.artworkWidth||!e.artworkHeight)return t.status(400).json({success:!1,error:"Artwork dimensions are required"});e.matWidth||(e.matWidth="2"),console.log("Processing order creation...");let r=await b.createOrder(e);console.log("Order created successfully:",r),await mo(r);try{if(r.customerId){let s=await b.getCustomer(r.customerId);s&&s.phone&&(await lo.handleOrderEvent({orderId:r.id.toString(),orderNumber:`ORD-${r.id}`,customerName:s.name,customerPhone:s.phone,eventType:"order_placed",metadata:{estimatedCompletion:r.estimatedCompletionDays?`${r.estimatedCompletionDays} days`:"7-10 days"}}),console.log(`Order placed notification sent for order ${r.id}`))}}catch(s){console.error("Failed to send order placed notification:",s)}t.status(201).json({success:!0,order:r,message:"Order created successfully",orderId:r.id})}catch(e){console.error("Error creating order:",e),t.status(500).json({success:!1,error:e.message||"Failed to create order",details:e.stack})}}async function ho(o,t){try{let{id:e}=o.params,r=o.body,s=await b.updateOrder(parseInt(e),r);r.productionStatus&&await po(parseInt(e),r.productionStatus),t.json({success:!0,order:s,message:"Order updated successfully"})}catch(e){console.error("Error updating order:",e),t.status(500).json({success:!1,error:e.message||"Failed to update order"})}}async function bo(o,t){try{let{id:e}=o.params,{status:r,notes:s}=o.body;if(!r)return t.status(400).json({success:!1,error:"Status is required"});let a=await b.updateOrder(parseInt(e),{productionStatus:r,lastStatusChange:new Date});try{if(a&&a.customerId){let n=await b.getCustomer(a.customerId);if(n&&n.phone){let l=null;switch(r){case"in_production":l="production_started";break;case"frame_cut":l="frame_cut";break;case"mat_cut":l="mat_cut";break;case"assembly_complete":l="assembly_complete";break;case"ready_for_pickup":l="ready_for_pickup";break}l&&(await lo.handleOrderEvent({orderId:a.id.toString(),orderNumber:`ORD-${a.id}`,customerName:n.name,customerPhone:n.phone,eventType:l}),console.log(`Status change notification sent for order ${a.id}: ${r}`))}}}catch(n){console.error("Failed to send status change notification:",n)}await po(parseInt(e),r,s),t.json({success:!0,order:a,message:`Order status updated to ${r}`})}catch(e){console.error("Error updating order status:",e),t.status(500).json({success:!1,error:e.message||"Failed to update order status"})}}async function wo(o,t){try{let{id:e}=o.params;await b.deleteOrder(parseInt(e)),t.json({success:!0,message:"Order deleted successfully"})}catch(e){console.error("Error deleting order:",e),t.status(500).json({success:!1,error:e.message||"Failed to delete order"})}}async function Po(o,t){try{let{orderId:e}=o.params;if(!te||!K)return t.json({success:!1,error:"Kanban integration not configured",config:{hasApiKey:!!te,hasApiUrl:!!K,apiUrl:K}});let r=await b.getOrder(parseInt(e));if(!r)return t.status(404).json({success:!1,error:"Order not found"});await mo(r),t.json({success:!0,message:`Order ${e} synced to Kanban successfully`,order:{id:r.id,status:r.productionStatus,kanbanUrl:K}})}catch(e){console.error("Error testing Kanban sync:",e),t.status(500).json({success:!1,error:e.message||"Failed to test Kanban sync"})}}async function So(o,t){try{t.json({success:!0,status:{configured:!!(te&&K),apiUrl:K,hasApiKey:!!te,endpoints:{orders:`${K}/api/orders`,statusUpdate:`${K}/api/orders/:id/status`}}})}catch(e){t.status(500).json({success:!1,error:e.message||"Failed to get Kanban status"})}}async function xo(o,t){try{let e=await b.getAllOrderGroups();t.json({success:!0,orderGroups:e,count:e.length})}catch(e){console.error("Error fetching order groups:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch order groups"})}}async function Io(o,t){try{let e=o.body,r=await b.createOrderGroup(e);t.status(201).json({success:!0,orderGroup:r,message:"Order group created successfully"})}catch(e){console.error("Error creating order group:",e),t.status(500).json({success:!1,error:e.message||"Failed to create order group"})}}ee();var Z=cn();Z.get("/orders",fo);Z.get("/orders/:id",go);Z.post("/orders",yo);Z.patch("/orders/:id",ho);Z.patch("/orders/:id/status",bo);Z.delete("/orders/:id",wo);Z.post("/orders/:id/send-update",async(o,t)=>{try{let e=parseInt(o.params.id),r=await b.getOrder(e);if(!r)return t.status(404).json({success:!1,error:"Order not found"});if(!r.customerId)return t.status(400).json({success:!1,error:"Order has no customer"});let s=await b.getCustomer(r.customerId);if(!s)return t.status(404).json({success:!1,error:"Customer not found"});await b.createCustomerNotification({customerId:s.id,orderId:r.id,notificationType:"status_update",channel:"email",subject:`Order #${r.id} Update`,message:`Your order is currently ${r.productionStatus.replace("_"," ")}. We'll keep you updated on the progress.`,successful:!0}),t.json({success:!0,message:"Customer notification sent successfully"})}catch(e){console.error("Error sending customer update:",e),t.status(500).json({success:!1,error:e.message||"Failed to send customer update"})}});Z.post("/orders/:orderId/test-kanban-sync",Po);Z.get("/kanban/status",So);Z.get("/order-groups",xo);Z.post("/order-groups",Io);var vo=Z;import{Router as dn}from"express";Y();V();import{eq as un,desc as ln}from"drizzle-orm";async function Oo(o,t){try{let e=await u.select().from(C).orderBy(ln(C.createdAt));return t.status(200).json(e)}catch(e){return console.error("Error fetching customers:",e),t.status(500).json({message:"Error fetching customers"})}}async function ko(o,t){try{let{id:e}=o.params,r=parseInt(e);if(isNaN(r))return t.status(400).json({message:"Invalid customer ID"});let s=await u.select().from(C).where(un(C.id,r)).limit(1);return s.length===0?t.status(404).json({message:"Customer not found"}):t.status(200).json(s[0])}catch(e){return console.error("Error fetching customer:",e),t.status(500).json({message:"Error fetching customer"})}}async function _o(o,t){try{let e=vt.parse(o.body),[r]=await u.insert(C).values(e).returning();return t.status(201).json(r)}catch(e){return console.error("Error creating customer:",e),e.name==="ZodError"?t.status(400).json({message:"Invalid customer data",errors:e.errors}):t.status(500).json({message:"Error creating customer"})}}var gt=dn();gt.get("/customers",Oo);gt.get("/customers/:id",ko);gt.post("/customers",_o);var Co=gt;import{Router as mn}from"express";Y();V();import{eq as Je}from"drizzle-orm";async function No(o,t){try{let e=await u.select().from(R);return t.status(200).json(e)}catch(e){return console.error("Error fetching inventory locations:",e),t.status(500).json({message:"Error fetching inventory locations",details:e.message})}}async function Ao(o,t){try{let{id:e}=o.params,r=await u.select().from(R).where(Je(R.id,parseInt(e))).limit(1);return r.length===0?t.status(404).json({message:"Inventory location not found"}):t.status(200).json(r[0])}catch(e){return console.error("Error fetching inventory location:",e),t.status(500).json({message:"Error fetching inventory location",details:e.message})}}async function Eo(o,t){try{let e=ct.parse(o.body),[r]=await u.insert(R).values(e).returning();return t.status(201).json(r)}catch(e){return console.error("Error creating inventory location:",e),e.name==="ZodError"?t.status(400).json({message:"Invalid location data",errors:e.errors}):t.status(500).json({message:"Error creating inventory location",details:e.message})}}async function Ro(o,t){try{let{id:e}=o.params,r=ct.parse(o.body),[s]=await u.update(R).set(r).where(Je(R.id,parseInt(e))).returning();return s?t.status(200).json(s):t.status(404).json({message:"Inventory location not found"})}catch(e){return console.error("Error updating inventory location:",e),e.name==="ZodError"?t.status(400).json({message:"Invalid location data",errors:e.errors}):t.status(500).json({message:"Error updating inventory location",details:e.message})}}async function jo(o,t){try{let{id:e}=o.params,r=await u.select({count:u.fn.count()}).from(j).where(Je(j.locationId,parseInt(e)));return parseInt(r[0].count)>0?t.status(400).json({message:"Cannot delete location with assigned items. Move items to another location first."}):(await u.delete(R).where(Je(R.id,parseInt(e))).returning({id:R.id})).length===0?t.status(404).json({message:"Inventory location not found"}):t.status(200).json({message:"Inventory location deleted successfully"})}catch(e){return console.error("Error deleting inventory location:",e),t.status(500).json({message:"Error deleting inventory location",details:e.message})}}async function Mo(o,t){try{let e=await u.select({...j,locationName:R.name}).from(j).leftJoin(R,Je(j.locationId,R.id));return t.status(200).json(e||[])}catch(e){return console.error("Error fetching inventory items:",e),t.status(500).json({message:"Error fetching inventory items",details:e.message})}}async function Fo(o,t){try{return t.status(200).json([])}catch(e){return console.error("Error fetching low stock items:",e),t.status(500).json({message:"Error fetching low stock items",details:e.message})}}async function Do(o,t){try{let e=await u.select().from(W);return t.status(200).json(e||[])}catch(e){return console.error("Error fetching suppliers:",e),t.status(500).json({message:"Error fetching suppliers",details:e.message})}}var ce=mn();ce.get("/inventory/locations",No);ce.get("/inventory/locations/:id",Ao);ce.post("/inventory/locations",Eo);ce.put("/inventory/locations/:id",Ro);ce.delete("/inventory/locations/:id",jo);ce.get("/inventory/items",Mo);ce.get("/inventory/items/low-stock",Fo);ce.get("/inventory/suppliers",Do);var To=ce;import{Router as hn}from"express";import{parseString as pn}from"xml2js";import{promisify as fn}from"util";var gn=fn(pn),Vt=class{async parseVendorXmlPriceSheet(t){try{console.log("Parsing vendor XML price sheet...");let e=await gn(t),r=[];if(e.catalog?.items?.item){let s=Array.isArray(e.catalog.items.item)?e.catalog.items.item:[e.catalog.items.item];for(let a of s){let n={itemNumber:this.extractValue(a.sku||a.itemNumber||a.id),description:this.extractValue(a.description||a.name),width:this.extractValue(a.width),collection:this.extractValue(a.collection||a.series),manufacturer:this.extractValue(a.manufacturer||a.vendor||"Unknown"),wholesalePrice:this.extractNumericValue(a.wholesalePrice||a.cost||a.price),retailPrice:this.extractNumericValue(a.retailPrice||a.msrp),category:this.extractValue(a.category||a.type),inStock:this.extractBooleanValue(a.inStock||a.available),unitOfMeasure:this.extractValue(a.unitOfMeasure||a.uom||"each")};n.itemNumber&&n.wholesalePrice>0&&r.push(n)}}else if(e.products?.product){let s=Array.isArray(e.products.product)?e.products.product:[e.products.product];for(let a of s){let n={itemNumber:this.extractValue(a.$.id||a.$.sku),description:this.extractValue(a.name?.[0]||a.description?.[0]),width:this.extractValue(a.dimensions?.width?.[0]),collection:this.extractValue(a.collection?.[0]),manufacturer:this.extractValue(a.manufacturer?.[0]||"Unknown"),wholesalePrice:this.extractNumericValue(a.pricing?.wholesale?.[0]||a.cost?.[0]),retailPrice:this.extractNumericValue(a.pricing?.retail?.[0]),category:this.extractValue(a.category?.[0]),inStock:this.extractBooleanValue(a.inventory?.inStock?.[0]),unitOfMeasure:this.extractValue(a.unitOfMeasure?.[0]||"each")};n.itemNumber&&n.wholesalePrice>0&&r.push(n)}}return console.log(`Successfully parsed ${r.length} items from XML price sheet`),r}catch(e){throw console.error("Error parsing XML price sheet:",e),new Error(`Failed to parse XML price sheet: ${e.message}`)}}extractValue(t){return typeof t=="string"?t.trim():Array.isArray(t)&&t.length>0?String(t[0]).trim():t&&typeof t=="object"&&t._?String(t._).trim():""}extractNumericValue(t){let e=this.extractValue(t),r=parseFloat(e.replace(/[^0-9.-]/g,""));return isNaN(r)?0:r}extractBooleanValue(t){let e=this.extractValue(t).toLowerCase();return e==="true"||e==="yes"||e==="1"}convertToFrameFormat(t){return t.map(e=>({id:`vendor-${e.manufacturer.toLowerCase().replace(/\s+/g,"-")}-${e.itemNumber}`,name:`${e.collection?e.collection+" ":""}${e.description}`,manufacturer:e.manufacturer,material:this.inferMaterial(e.description,e.category),width:e.width||"",depth:"",price:e.wholesalePrice.toString(),catalogImage:"",color:this.inferColor(e.description),itemNumber:e.itemNumber,collection:e.collection||"",category:e.category||"",inStock:e.inStock!==!1,unitOfMeasure:e.unitOfMeasure}))}inferMaterial(t,e){let r=t.toLowerCase(),s=e?.toLowerCase()||"";return r.includes("wood")||s.includes("wood")?"wood":r.includes("metal")||s.includes("metal")?"metal":r.includes("plastic")||s.includes("plastic")?"plastic":r.includes("composite")||s.includes("composite")?"composite":"wood"}inferColor(t){let e=t.toLowerCase();return e.includes("black")?"#000000":e.includes("white")?"#FFFFFF":e.includes("brown")?"#8B4513":e.includes("gold")?"#FFD700":e.includes("silver")?"#C0C0C0":e.includes("red")?"#FF0000":e.includes("blue")?"#0000FF":"#8B4513"}},Yt=new Vt;Y();V();async function $o(o,t){try{let{xmlContent:e,vendorName:r}=o.body;if(!e)return t.status(400).json({message:"XML content is required"});if(!r)return t.status(400).json({message:"Vendor name is required"});console.log(`Processing XML price sheet for vendor: ${r}`);let s=await Yt.parseVendorXmlPriceSheet(e);if(s.length===0)return t.status(400).json({message:"No valid price items found in XML"});let a=Yt.convertToFrameFormat(s),n=0,l=0;for(let i of a)try{(await u.select().from(T).where(eq(T.id,i.id)).limit(1)).length>0?(await u.update(T).set({name:i.name,manufacturer:i.manufacturer,material:i.material,width:i.width,price:i.price,color:i.color,updatedAt:new Date}).where(eq(T.id,i.id)),l++):(await u.insert(T).values({id:i.id,name:i.name,manufacturer:i.manufacturer,material:i.material,width:i.width,depth:i.depth,price:i.price,catalogImage:i.catalogImage,color:i.color,createdAt:new Date,updatedAt:new Date}),n++)}catch(p){console.error(`Error processing frame item ${i.id}:`,p)}console.log(`XML price sheet processing complete. Inserted: ${n}, Updated: ${l}`),t.json({message:"XML price sheet processed successfully",vendor:r,totalItems:s.length,inserted:n,updated:l,summary:{priceItems:s.slice(0,5),frameItems:a.slice(0,5)}})}catch(e){console.error("Error processing XML price sheet:",e),t.status(500).json({message:"Failed to process XML price sheet",error:e.message})}}async function Lo(o,t){t.json({supportedFormats:[{name:"Standard Catalog Format",structure:{catalog:{items:{item:[{sku:"item-number",description:"item-description",manufacturer:"vendor-name",wholesalePrice:"price",width:"frame-width",collection:"collection-name"}]}}}},{name:"Products Format",structure:{products:{product:[{$:{id:"item-number"},name:["item-description"],manufacturer:["vendor-name"],pricing:{wholesale:["price"]}}]}}}],requiredFields:["itemNumber","description","manufacturer","wholesalePrice"],optionalFields:["width","collection","retailPrice","category","inStock"]})}function yn(o,t,e){console.log("Auth middleware: Allowing request (authentication not implemented)"),e()}var qo=yn;var yt=hn();yt.use(qo);yt.post("/upload",$o);yt.get("/formats",Lo);var Bo=yt;import{Router as Sn}from"express";var bn=[{itemNumber:"10-036M",width:'5/8"',boxQty:360,collection:"Maple & Walnut - Garrett",basePricePerFoot:6.62,boxPrice:10.05,lengthPrice:13.52,chopPrice:14.52},{itemNumber:"10-100M",width:'5/8"',boxQty:375,collection:"Maple & Walnut - Garrett",basePricePerFoot:6.34,boxPrice:9.71,lengthPrice:12.75,chopPrice:13.75},{itemNumber:"10-507M",width:'5/8"',boxQty:306,collection:"Museum Stems - Garrett",basePricePerFoot:6.52,boxPrice:9.91,lengthPrice:13,chopPrice:14},{itemNumber:"100172",width:'1/4"',boxQty:1600,collection:"Olmsted",basePricePerFoot:2.75,boxPrice:4.64,lengthPrice:7.28,chopPrice:8.28},{itemNumber:"100750",width:'1/4"',boxQty:1200,collection:"Sofia",basePricePerFoot:2.63,boxPrice:4.04,lengthPrice:6.73,chopPrice:7.73},{itemNumber:"100751",width:'1/4"',boxQty:1587,collection:"Sofia",basePricePerFoot:2.63,boxPrice:4.04,lengthPrice:6.73,chopPrice:7.73},{itemNumber:"100752",width:'1/4"',boxQty:1e3,collection:"Sofia",basePricePerFoot:2.63,boxPrice:4.04,lengthPrice:6.73,chopPrice:7.73},{itemNumber:"102CG",width:'1/2"',boxQty:432,collection:"Marquis",basePricePerFoot:1.74,boxPrice:3.7,lengthPrice:6.43,chopPrice:7.43},{itemNumber:"102CS",width:'1/2"',boxQty:432,collection:"Marquis",basePricePerFoot:1.74,boxPrice:3.7,lengthPrice:6.43,chopPrice:7.43},{itemNumber:"103180",width:'9/16"',boxQty:900,collection:"Hudson",basePricePerFoot:1.46,boxPrice:3.11,lengthPrice:5.56,chopPrice:6.56},{itemNumber:"103190",width:'9/16"',boxQty:900,collection:"Hudson",basePricePerFoot:1.4,boxPrice:2.97,lengthPrice:5.3,chopPrice:6.3},{itemNumber:"103235",width:'5/16"',boxQty:1200,collection:"Academie",basePricePerFoot:1.44,boxPrice:3.17,lengthPrice:5.64,chopPrice:6.64},{itemNumber:"103237",width:'5/16"',boxQty:1296,collection:"Academie",basePricePerFoot:1.43,boxPrice:3.14,lengthPrice:5.59,chopPrice:6.59},{itemNumber:"105794",width:'5/16"',boxQty:785,collection:"Lucerne",basePricePerFoot:3.21,boxPrice:5.02,lengthPrice:8.01,chopPrice:9.01},{itemNumber:"105CB",width:'1/2"',boxQty:270,collection:"Vienna",basePricePerFoot:2.21,boxPrice:3.31,lengthPrice:5.71,chopPrice:6.71},{itemNumber:"106180",width:'1/2"',boxQty:900,collection:"Hudson",basePricePerFoot:1.39,boxPrice:2.99,lengthPrice:5.31,chopPrice:6.31},{itemNumber:"106190",width:'1/2"',boxQty:900,collection:"Hudson",basePricePerFoot:1.32,boxPrice:2.83,lengthPrice:5.09,chopPrice:6.09},{itemNumber:"200750",width:'7/8"',boxQty:250,collection:"Sofia",basePricePerFoot:4.38,boxPrice:6.54,lengthPrice:9.9,chopPrice:10.9},{itemNumber:"200751",width:'7/8"',boxQty:515,collection:"Sofia",basePricePerFoot:4.35,boxPrice:6.76,lengthPrice:9.84,chopPrice:10.84},{itemNumber:"200752",width:'7/8"',boxQty:490,collection:"Sofia",basePricePerFoot:4.57,boxPrice:7.31,lengthPrice:10.33,chopPrice:11.33},{itemNumber:"210286",width:'11/16"',boxQty:450,collection:"White",basePricePerFoot:1.89,boxPrice:3.06,lengthPrice:5.99,chopPrice:6.99},{itemNumber:"400750",width:'1 5/8"',boxQty:112,collection:"Sofia",basePricePerFoot:7.47,boxPrice:11.04,lengthPrice:17.48,chopPrice:18.48},{itemNumber:"400751",width:'1 5/8"',boxQty:192,collection:"Sofia",basePricePerFoot:7.09,boxPrice:10.44,lengthPrice:16.55,chopPrice:17.55},{itemNumber:"400752",width:'1 5/8"',boxQty:180,collection:"Sofia",basePricePerFoot:7.34,boxPrice:10.83,lengthPrice:17.17,chopPrice:18.17},{itemNumber:"431431",width:'1 3/8"',boxQty:115,collection:"Zen",basePricePerFoot:10.83,boxPrice:15.91,lengthPrice:26.01,chopPrice:27.01},{itemNumber:"431432",width:'1 3/8"',boxQty:113,collection:"Zen",basePricePerFoot:10.27,boxPrice:15.1,lengthPrice:24.68,chopPrice:25.68},{itemNumber:"431434",width:'1 3/8"',boxQty:110,collection:"Zen",basePricePerFoot:10.75,boxPrice:15.81,lengthPrice:25.82,chopPrice:26.82},{itemNumber:"432900",width:'1 3/4"',boxQty:225,collection:"Foundry",basePricePerFoot:6.62,boxPrice:9.75,lengthPrice:15.03,chopPrice:16.03},{itemNumber:"432902",width:'1 3/4"',boxQty:236,collection:"Foundry",basePricePerFoot:6.81,boxPrice:10.07,lengthPrice:15.52,chopPrice:16.52},{itemNumber:"433082",width:'1 11/16"',boxQty:108,collection:"Soho",basePricePerFoot:5.09,boxPrice:9.55,lengthPrice:14.41,chopPrice:15.41},{itemNumber:"433084",width:'1 11/16"',boxQty:108,collection:"Soho",basePricePerFoot:5.16,boxPrice:9.59,lengthPrice:14.54,chopPrice:15.54},{itemNumber:"433086",width:'1 11/16"',boxQty:108,collection:"Soho",basePricePerFoot:5.22,boxPrice:9.59,lengthPrice:14.54,chopPrice:15.54},{itemNumber:"434110",width:'1 1/4"',boxQty:137,collection:"CR2",basePricePerFoot:6.33,boxPrice:9.33,lengthPrice:14.98,chopPrice:15.98},{itemNumber:"435500",width:'1 5/16"',boxQty:324,collection:"Alto",basePricePerFoot:1.8,boxPrice:3.6,lengthPrice:6.72,chopPrice:7.72},{itemNumber:"435510",width:'1 5/16"',boxQty:296,collection:"Alto",basePricePerFoot:1.8,boxPrice:3.6,lengthPrice:6.72,chopPrice:7.72},{itemNumber:"436350",width:'1 5/8"',boxQty:143,collection:"Brooklyn",basePricePerFoot:2.29,boxPrice:3.66,lengthPrice:6.08,chopPrice:7.08},{itemNumber:"437500",width:'1 3/16"',boxQty:215,collection:"Alto",basePricePerFoot:2.03,boxPrice:3.6,lengthPrice:7.22,chopPrice:8.22},{itemNumber:"437510",width:'1 3/16"',boxQty:180,collection:"Alto",basePricePerFoot:2.03,boxPrice:3.6,lengthPrice:7.22,chopPrice:8.22},{itemNumber:"438120",width:'2"',boxQty:150,collection:"Dresden",basePricePerFoot:6.78,boxPrice:10.26,lengthPrice:15.05,chopPrice:16.05},{itemNumber:"439082",width:'2 1/16"',boxQty:126,collection:"Soho",basePricePerFoot:4.42,boxPrice:7.58,lengthPrice:11.4,chopPrice:12.4},{itemNumber:"440240",width:'1 3/8"',boxQty:190,collection:"Java",basePricePerFoot:7.59,boxPrice:11.23,lengthPrice:18.27,chopPrice:19.27},{itemNumber:"440951",width:'2"',boxQty:92,collection:"Cezanne",basePricePerFoot:18.08,boxPrice:25.65,lengthPrice:29.81,chopPrice:30.81},{itemNumber:"441075",width:'2 1/16"',boxQty:150,collection:"Prague",basePricePerFoot:9.48,boxPrice:13.9,lengthPrice:23.98,chopPrice:24.98},{itemNumber:"441077",width:'2 1/16"',boxQty:155,collection:"Prague",basePricePerFoot:9.44,boxPrice:13.82,lengthPrice:23.86,chopPrice:24.86},{itemNumber:"442650",width:'1 3/4"',boxQty:162,collection:"Tate",basePricePerFoot:4.76,boxPrice:8.08,lengthPrice:11.57,chopPrice:12.57},{itemNumber:"442660",width:'1 3/4"',boxQty:162,collection:"Tate",basePricePerFoot:4.76,boxPrice:8.07,lengthPrice:11.56,chopPrice:12.56},{itemNumber:"442670",width:'1 3/4"',boxQty:162,collection:"Tate",basePricePerFoot:4.67,boxPrice:7.74,lengthPrice:11.04,chopPrice:12.04},{itemNumber:"520750",width:'2 1/2"',boxQty:94,collection:"Sofia",basePricePerFoot:11.07,boxPrice:16.3,lengthPrice:24.59,chopPrice:25.59},{itemNumber:"520751",width:'2 1/2"',boxQty:59,collection:"Sofia",basePricePerFoot:10.92,boxPrice:16.43,lengthPrice:24.78,chopPrice:25.78},{itemNumber:"520752",width:'2 1/2"',boxQty:100,collection:"Sofia",basePricePerFoot:10.56,boxPrice:16.38,lengthPrice:23.41,chopPrice:24.41}];function Wo(o){let t=o.startsWith("larson-")?o.substring(7):o;return bn.find(e=>e.itemNumber===t)||null}var Ie=9.5;function ht(o,t){let e=Wo(o);if(!e)return null;let r=e.basePricePerFoot,s=e.chopPrice||e.basePricePerFoot*1.5,a=Math.ceil(t/Ie),n=a*Ie,l=n-t,i=n*r,p=t*s,_;if(t>Ie){let g=Math.floor(t/Ie),O=t-g*Ie;if(O>0){let H=g*Ie*r+O*s;_={fullSticks:g,chopFootage:O,totalCost:H,description:`${g} full stick(s) + ${O.toFixed(1)}' chopped`}}}let f=[{method:"length",cost:i},{method:"chop",cost:p},..._?[{method:"mixed",cost:_.totalCost}]:[]],d=f.reduce((g,O)=>O.cost<g.cost?O:g),y=f.reduce((g,O)=>O.cost>g.cost?O:g).cost-d.cost,w="",P;return d.method==="length"?w=`Full sticks are cheaper despite ${l.toFixed(1)}' waste`:d.method==="chop"?w="Chop pricing saves money by avoiding waste":w="Mixed approach optimizes cost by combining full sticks and chopped pieces",t>=0&&t<=4?P="\u{1F3AF} OPTIMAL RANGE: 0-4 feet - Consider chop pricing to avoid waste":t>=10&&t<=14?P="\u{1F3AF} OPTIMAL RANGE: 10-14 feet - Mixed ordering may be most cost-effective":t>4&&t<9.5&&(P="\u{1F4CF} Consider: Close to full stick length, evaluate waste vs chop premium"),{itemNumber:o,footageNeeded:t,lengthOption:{sticksNeeded:a,totalFootage:n,wasteFootage:l,costPerFoot:r,totalCost:i,description:`${a} stick(s) @ ${Ie}' each`},chopOption:{footageNeeded:t,costPerFoot:s,totalCost:p,description:`${t}' chopped to exact length`},mixedOption:_,recommendation:{method:d.method,savings:y,reason:w,alert:P}}}function wn(o,t,e){let r=o+e*2,s=t+e*2;return r*2+s*2}function Pn(o,t,e,r){let a=wn(t,e,r)/12;return ht(o,a)}function Uo(o){return o.map(t=>({...Pn(t.itemNumber,t.artworkWidth,t.artworkHeight,t.matWidth),quantity:t.quantity||1})).filter(Boolean)}function Ho(o){let t=o.reduce((s,a)=>s+a.recommendation.savings*a.quantity,0),e=o.reduce((s,a)=>s+a.quantity,0),r=o.filter(s=>s.recommendation.alert).length;return{totalSavings:t,totalOrders:e,averageSavingsPerOrder:t/e,alertCount:r}}async function Go(o,t){try{let{itemNumber:e,footageNeeded:r}=o.body;if(!e||!r)return t.status(400).json({error:"Missing required parameters: itemNumber and footageNeeded"});let s=ht(e,parseFloat(r));if(!s)return t.status(404).json({error:"Item number not found in Larson-Juhl catalog"});t.json(s)}catch(e){console.error("Error optimizing Larson order:",e),t.status(500).json({error:"Internal server error"})}}async function bt(o,t){try{let{itemNumber:e,artworkWidth:r,artworkHeight:s,matWidth:a}=o.body;if(!e||!r||!s||a===void 0)return t.status(400).json({error:"Missing required parameters: itemNumber, artworkWidth, artworkHeight, matWidth"});let n=bt(e,parseFloat(r),parseFloat(s),parseFloat(a));if(!n)return t.status(404).json({error:"Item number not found in Larson-Juhl catalog"});t.json(n)}catch(e){console.error("Error optimizing frame order:",e),t.status(500).json({error:"Internal server error"})}}async function Ko(o,t){try{let{orders:e}=o.body;if(!e||!Array.isArray(e))return t.status(400).json({error:"Missing or invalid orders array"});let r=Uo(e),s=Ho(r);t.json({optimizations:r,summary:s})}catch(e){console.error("Error batch optimizing orders:",e),t.status(500).json({error:"Internal server error"})}}async function zo(o,t){try{let{itemNumber:e}=o.params,s=[2,4,6,8,10,12,14,16,18,20].map(a=>{let n=ht(e,a);return{footage:a,optimization:n}}).filter(a=>a.optimization!==null);if(s.length===0)return t.status(404).json({error:"Item number not found in Larson-Juhl catalog"});t.json({itemNumber:e,analysis:s})}catch(e){console.error("Error generating optimization analysis:",e),t.status(500).json({error:"Internal server error"})}}var Xe=Sn();Xe.post("/optimize/footage",Go);Xe.post("/optimize/frame",bt);Xe.post("/optimize/batch",Ko);Xe.get("/analyze/:itemNumber",zo);var Vo=Xe;ze();import xn from"express";var Qt=xn.Router();Qt.post("/test-basic",async(o,t)=>{let{to:e,subject:r,message:s}=o.body;if(!e||!r||!s)return t.status(400).json({error:"Missing required fields: to, subject, message"});console.log("SendGrid API Key exists:",!!process.env.SENDGRID_API_KEY),console.log("SendGrid API Key starts with SG.:",process.env.SENDGRID_API_KEY?.startsWith("SG.")),console.log("From email:",process.env.FROM_EMAIL||"noreply@jaysartandframes.com");try{await Ge({to:e,from:"noreply@jaysartandframes.com",subject:r,text:s,html:`<p>${s}</p>`}),t.json({success:!0,message:"Test email sent successfully!"})}catch(a){console.error("Test email error:",a);let n={message:a.message,hasApiKey:!!process.env.SENDGRID_API_KEY,apiKeyFormat:process.env.SENDGRID_API_KEY?.startsWith("SG.")?"Valid format":"Invalid format",fromEmail:process.env.FROM_EMAIL||"noreply@jaysartandframes.com"};t.status(500).json({error:"Failed to send test email",details:a.message,debug:n})}});Qt.post("/test-order-status",async(o,t)=>{let{customerEmail:e,customerName:r="Test Customer",orderId:s=12345,orderStatus:a="order_processed"}=o.body;if(!e)return t.status(400).json({error:"Missing required field: customerEmail"});try{await Ke(e,r,s,a,new Date(Date.now()+7*24*60*60*1e3)),t.json({success:!0,message:"Order status email sent successfully!"})}catch(n){console.error("Order status email error:",n),t.status(500).json({error:"Failed to send order status email",details:n.message})}});var Yo=Qt;import{Router as In}from"express";var Qo=async(o,t)=>{try{let{to:e,message:r,voice:s,language:a,twiml:n,url:l,recordCall:i}=o.body;if(!e)return t.status(400).json({error:"Phone number is required"});if(!r&&!n&&!l)return t.status(400).json({error:"Must provide either message, twiml, or url parameter"});if(!fe())return t.status(503).json({error:"Voice calling is not configured. Please check Twilio credentials."});let p=await G({to:je(e),message:r,voice:s,language:a,twiml:n,url:l,recordCall:i});p.success?t.json({success:!0,callSid:p.sid,message:"Voice call initiated successfully"}):t.status(400).json({error:p.error})}catch(e){console.error("Error making voice call:",e),t.status(500).json({error:"Failed to make voice call"})}},Zo=async(o,t)=>{try{let{to:e,orderNumber:r,status:s,estimatedCompletion:a}=o.body;if(!e||!r||!s)return t.status(400).json({error:"Phone number, order number, and status are required"});if(!fe())return t.status(503).json({error:"Voice calling is not configured. Please check Twilio credentials."});let n=await qr({to:je(e),orderNumber:r,status:s,estimatedCompletion:a});n.success?t.json({success:!0,callSid:n.sid,message:"Order status call initiated successfully"}):t.status(400).json({error:n.error})}catch(e){console.error("Error making order status call:",e),t.status(500).json({error:"Failed to make order status call"})}},Jo=async(o,t)=>{try{let{to:e,customerName:r,amount:s,orderNumber:a,dueDate:n}=o.body;if(!e||!r||!s||!a)return t.status(400).json({error:"Phone number, customer name, amount, and order number are required"});if(!fe())return t.status(503).json({error:"Voice calling is not configured. Please check Twilio credentials."});let l=await Br({to:je(e),customerName:r,amount:parseFloat(s),orderNumber:a,dueDate:n});l.success?t.json({success:!0,callSid:l.sid,message:"Payment reminder call initiated successfully"}):t.status(400).json({error:l.error})}catch(e){console.error("Error making payment reminder call:",e),t.status(500).json({error:"Failed to make payment reminder call"})}},Xo=async(o,t)=>{try{let{to:e,customerName:r,orderNumber:s,daysWaiting:a}=o.body;if(!e||!r||!s||a===void 0)return t.status(400).json({error:"Phone number, customer name, order number, and days waiting are required"});if(!fe())return t.status(503).json({error:"Voice calling is not configured. Please check Twilio credentials."});let n=await Wr(r,je(e),s,parseInt(a));n.success?t.json({success:!0,callSid:n.sid,message:"Pickup reminder call initiated successfully"}):t.status(400).json({error:n.error})}catch(e){console.error("Error making pickup reminder call:",e),t.status(500).json({error:"Failed to make pickup reminder call"})}},es=async(o,t)=>{try{let{to:e,customerName:r,orderNumber:s}=o.body;if(!e||!r||!s)return t.status(400).json({error:"Phone number, customer name, and order number are required"});if(!fe())return t.status(503).json({error:"Voice calling is not configured. Please check Twilio credentials."});let a=await ft(r,je(e),s);a.success?t.json({success:!0,callSid:a.sid,message:"Order completion call initiated successfully"}):t.status(400).json({error:a.error})}catch(e){console.error("Error making order completion call:",e),t.status(500).json({error:"Failed to make order completion call"})}},ts=async(o,t)=>{try{let{callSid:e}=o.params;if(!e)return t.status(400).json({error:"Call SID is required"});if(!fe())return t.status(503).json({error:"Voice calling is not configured. Please check Twilio credentials."});let r=await Ur(e);r.success?t.json({success:!0,status:r.status}):t.status(400).json({error:r.error})}catch(e){console.error("Error getting call status:",e),t.status(500).json({error:"Failed to get call status"})}},rs=async(o,t)=>{try{let e=fe();t.json({configured:e,message:e?"Voice calling is properly configured":"Voice calling requires TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN, and TWILIO_PHONE_NUMBER"})}catch(e){console.error("Error checking voice call configuration:",e),t.status(500).json({error:"Failed to check voice call configuration"})}};var ge=In();ge.get("/configuration",rs);ge.post("/make-call",Qo);ge.post("/order-status",Zo);ge.post("/order-complete",es);ge.post("/pickup-reminder",Xo);ge.post("/payment-reminder",Jo);ge.get("/status/:callSid",ts);var os=ge;import{Router as vn}from"express";var ve=vn();ve.post("/order-complete/:orderNumber",(o,t)=>{let{orderNumber:e}=o.params,{customerName:r}=o.query;t.set("Content-Type","text/xml");let s=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="Polly.Amy">Hello ${r||"valued customer"}! This is Jay's Frames calling with great news.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Amy">Your custom framing order number ${e} is now complete and ready for pickup.</Say>
    <Pause length="1"/>
    <Play>https://demo.twilio.com/docs/classic.mp3</Play>
    <Say voice="Polly.Amy">We're excited for you to see the beautiful result. Please come by during our business hours to collect your order.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Amy">Thank you for choosing Jay's Frames. Have a wonderful day!</Say>
</Response>`;t.send(s)});ve.post("/payment-reminder/:orderNumber",(o,t)=>{let{orderNumber:e}=o.params,{customerName:r,amount:s,dueDate:a}=o.query;t.set("Content-Type","text/xml");let n=a?` Payment is due by ${a}.`:"",l=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="Polly.Brian">Hello ${r||"valued customer"}, this is Jay's Frames calling about your order number ${e}.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Brian">You have an outstanding balance of ${s||"your order total"}.${n}</Say>
    <Pause length="1"/>
    <Say voice="Polly.Brian">Please contact us at your earliest convenience to complete your payment.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Brian">Thank you for your prompt attention to this matter.</Say>
</Response>`;t.send(l)});ve.post("/pickup-reminder/:orderNumber",(o,t)=>{let{orderNumber:e}=o.params,{customerName:r,daysWaiting:s}=o.query;t.set("Content-Type","text/xml");let a=parseInt(s||"1"),l=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="Polly.Emma">Hello ${r||"valued customer"}, this is Jay's Frames.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Emma">Your custom framing order number ${e} has been ready for pickup for ${a} ${a===1?"day":"days"}.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Emma">Please come by during our business hours to collect your beautiful framed artwork.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Emma">We look forward to seeing you soon. Thank you!</Say>
</Response>`;t.send(l)});ve.post("/promotional/:campaignId",(o,t)=>{let{campaignId:e}=o.params,{customerName:r}=o.query;t.set("Content-Type","text/xml");let s=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="Polly.Amy">Hello ${r||"valued customer"}! Thank you for being a loyal customer of Jay's Frames.</Say>
    <Pause length="1"/>
    <Play>https://demo.twilio.com/docs/classic.mp3</Play>
    <Say voice="Polly.Amy">We have an exciting special offer just for you! Visit our shop this week for twenty percent off all custom matting services.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Amy">This exclusive offer expires soon, so don't miss out on transforming your favorite artwork.</Say>
    <Pause length="1"/>
    <Say voice="Polly.Amy">Thank you for choosing Jay's Frames. We can't wait to help you create something beautiful!</Say>
</Response>`;t.send(s)});ve.post("/interactive-survey/:orderNumber",(o,t)=>{let{orderNumber:e}=o.params,{customerName:r}=o.query;t.set("Content-Type","text/xml");let s=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="Polly.Amy">Hello ${r||"valued customer"}! This is Jay's Frames calling about your recent order number ${e}.</Say>
    <Pause length="1"/>
    <Gather numDigits="1" action="/api/twiml/survey-response" method="POST" timeout="10">
        <Say voice="Polly.Amy">We'd love to hear about your experience. Please press 1 if you're extremely satisfied, 2 for satisfied, or 3 if you have concerns.</Say>
    </Gather>
    <Say voice="Polly.Amy">Thank you for your time. Have a wonderful day!</Say>
</Response>`;t.send(s)});ve.post("/survey-response",(o,t)=>{let{Digits:e}=o.body;t.set("Content-Type","text/xml");let r="";switch(e){case"1":r="Thank you for rating us as extremely satisfied! We appreciate your business and look forward to serving you again.";break;case"2":r="Thank you for your positive feedback! We appreciate your business.";break;case"3":r="Thank you for your feedback. We will have a manager contact you shortly to address your concerns.";break;default:r="Thank you for your time. Have a wonderful day!"}let s=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Say voice="Polly.Amy">${r}</Say>
</Response>`;t.send(s)});var ss=ve;import{Router as On}from"express";var Zt=class{async triggerNotification(t,e){try{let{orderId:r,orderNumber:s,customerName:a,customerPhone:n,eventType:l,metadata:i}=t.body;if(!r||!s||!a||!n||!l){e.status(400).json({success:!1,error:"Missing required fields: orderId, orderNumber, customerName, customerPhone, eventType"});return}let p=["order_placed","payment_received","production_started","frame_cut","mat_cut","assembly_complete","ready_for_pickup","payment_due","pickup_overdue"];if(!p.includes(l)){e.status(400).json({success:!1,error:`Invalid event type. Must be one of: ${p.join(", ")}`});return}let _={orderId:r,orderNumber:s,customerName:a,customerPhone:n,eventType:l,metadata:i};await Ve.handleOrderEvent(_),e.json({success:!0,message:`Notification triggered for order ${s}`,eventType:l})}catch(r){console.error("Error triggering notification:",r),e.status(500).json({success:!1,error:"Failed to trigger notification"})}}async scheduleNotification(t,e){try{let{orderId:r,orderNumber:s,customerName:a,customerPhone:n,eventType:l,delayMinutes:i,metadata:p}=t.body;if(!i||i<1){e.status(400).json({success:!1,error:"delayMinutes must be a positive number"});return}let _={orderId:r,orderNumber:s,customerName:a,customerPhone:n,eventType:l,metadata:p};await Ve.scheduleDelayedNotification(_,i),e.json({success:!0,message:`Notification scheduled for order ${s} in ${i} minutes`,scheduledFor:new Date(Date.now()+i*60*1e3).toISOString()})}catch(r){console.error("Error scheduling notification:",r),e.status(500).json({success:!1,error:"Failed to schedule notification"})}}async sendBulkNotifications(t,e){try{let{events:r}=t.body;if(!Array.isArray(r)||r.length===0){e.status(400).json({success:!1,error:"events must be a non-empty array"});return}for(let s of r)if(!s.orderId||!s.orderNumber||!s.customerName||!s.customerPhone||!s.eventType){e.status(400).json({success:!1,error:"Each event must have orderId, orderNumber, customerName, customerPhone, and eventType"});return}await Ve.sendBulkNotifications(r),e.json({success:!0,message:`Bulk notifications sent for ${r.length} orders`,count:r.length})}catch(r){console.error("Error sending bulk notifications:",r),e.status(500).json({success:!1,error:"Failed to send bulk notifications"})}}async checkOverdueOrders(t,e){try{console.log("Checking for overdue pickup orders..."),e.json({success:!0,message:"Overdue orders check completed"})}catch(r){console.error("Error checking overdue orders:",r),e.status(500).json({success:!1,error:"Failed to check overdue orders"})}}async getNotificationStatus(t,e){try{let r=!!(process.env.TWILIO_ACCOUNT_SID&&process.env.TWILIO_AUTH_TOKEN&&process.env.TWILIO_PHONE_NUMBER),s=[{type:"order_placed",description:"Order confirmation call"},{type:"payment_received",description:"Payment confirmation call"},{type:"production_started",description:"Production started notification"},{type:"frame_cut",description:"Frame cutting complete update"},{type:"mat_cut",description:"Mat cutting complete update"},{type:"assembly_complete",description:"Assembly complete notification"},{type:"ready_for_pickup",description:"Order ready for pickup call"},{type:"payment_due",description:"Payment reminder call"},{type:"pickup_overdue",description:"Pickup reminder call"}];e.json({success:!0,configured:r,message:r?"Order notifications are configured and ready":"Twilio credentials required",supportedEventTypes:s,endpoints:{trigger:"/api/order-notifications/trigger",schedule:"/api/order-notifications/schedule",bulk:"/api/order-notifications/bulk",checkOverdue:"/api/order-notifications/check-overdue"}})}catch(r){console.error("Error getting notification status:",r),e.status(500).json({success:!1,error:"Failed to get notification status"})}}async testNotification(t,e){try{let{phone:r,eventType:s="ready_for_pickup"}=t.body;if(!r){e.status(400).json({success:!1,error:"Phone number is required for test notification"});return}let a={orderId:"TEST-001",orderNumber:"TEST-001",customerName:"Test Customer",customerPhone:r,eventType:s,metadata:{amount:125.5,daysWaiting:3,dueDate:"Friday",estimatedCompletion:"2-3 business days"}};await Ve.handleOrderEvent(a),e.json({success:!0,message:`Test notification sent to ${r}`,eventType:s,testData:a})}catch(r){console.error("Error sending test notification:",r),e.status(500).json({success:!1,error:"Failed to send test notification"})}}},z=new Zt;var Oe=On();Oe.post("/trigger",z.triggerNotification.bind(z));Oe.post("/schedule",z.scheduleNotification.bind(z));Oe.post("/bulk",z.sendBulkNotifications.bind(z));Oe.post("/check-overdue",z.checkOverdueOrders.bind(z));Oe.get("/status",z.getNotificationStatus.bind(z));Oe.post("/test",z.testNotification.bind(z));var as=Oe;Y();V();import{Router as kn}from"express";import _n from"stripe";import{eq as ns}from"drizzle-orm";var cs=kn(),is=process.env.STRIPE_SECRET_KEY?new _n(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"}):null;cs.post("/payment-status",async(o,t)=>{try{let{payment_intent_id:e,client_secret:r}=o.body;if(!is)return t.status(500).json({success:!1,message:"Payment processing is not configured"});if(!e)return t.status(400).json({success:!1,message:"Payment intent ID is required"});let s=await is.paymentIntents.retrieve(e),a=await u.select().from(D).where(ns(D.stripePaymentIntentId,e)).limit(1),n=null;a.length>0&&(n=a[0].id,s.status==="succeeded"&&await u.update(D).set({status:"confirmed",paymentStatus:"paid",paymentMethod:"card",paidAt:new Date}).where(ns(D.id,n))),t.json({success:!0,status:s.status,orderGroupId:n,amount:s.amount,currency:s.currency})}catch(e){console.error("Error checking payment status:",e),t.status(500).json({success:!1,message:"Failed to verify payment status"})}});var us=cs;async function Is(o){o.post("/api/art-locations",Mt.sendArtLocationData),o.get("/api/art-locations/:orderId",Mt.getArtLocationData),o.post("/api/frame-designs",Ft.saveFrameDesign),o.get("/api/frame-designs/:orderId",Ft.getFrameDesign),o.use("/api/webhooks",Yr),o.get("/api/health",(f,d)=>{d.json({status:"ok",timestamp:new Date().toISOString(),environment:"production"})}),o.get("/api/dashboard/config",(f,d)=>{let m=process.env.DASHBOARD_API_URL;d.json({configured:!!m,url:m?`${m.substring(0,30)}...`:null,fullUrl:m,message:m?"Dashboard API is configured and ready":"Dashboard API URL not configured. Add DASHBOARD_API_URL to your secrets.",endpoints:m?{metrics:`${m}/api/metrics`,orders:`${m}/api/orders`,status:`${m}/api/status`}:null})}),o.get("/api/dashboard-proxy/health",async(f,d)=>{let m=process.env.DASHBOARD_API_URL;if(!m)return d.status(400).json({error:"Dashboard API URL not configured"});try{let w=await(await fetch(`${m}/api/health`)).json();d.json(w)}catch(y){d.status(500).json({error:y.message})}}),o.get("/api/dashboard-proxy/metrics",async(f,d)=>{let m=process.env.DASHBOARD_API_URL;if(!m)return d.status(400).json({error:"Dashboard API URL not configured"});try{let y=await fetch(`${m}/api/metrics`);o.get("/api/recommendations/frames",async(P,g)=>{try{let O={artworkType:P.query.artworkType,artworkDescription:P.query.artworkDescription,artworkWidth:parseFloat(P.query.artworkWidth)||16,artworkHeight:parseFloat(P.query.artworkHeight)||20,colorPreference:P.query.colorPreference,stylePreference:P.query.stylePreference,budgetLevel:P.query.budgetLevel,roomDecor:P.query.roomDecor,customerPreference:P.query.customerPreference},H=await recommendationService.getRecommendations(O);g.json(H)}catch(O){console.error("Error getting frame recommendations:",O),g.status(500).json({error:"Failed to get recommendations",message:O.message})}}),o.post("/api/recommendations/from-image",async(P,g)=>{try{let{imageBase64:O,...H}=P.body;if(!O)return g.status(400).json({error:"Image data required"});let q=await recommendationService.getRecommendationsFromImage(O,H);g.json(q)}catch(O){console.error("Error getting image-based recommendations:",O),g.status(500).json({error:"Failed to analyze image",message:O.message})}});let w=await y.json();d.json(w)}catch(y){d.status(500).json({error:y.message})}}),o.get("/api/dashboard-proxy/status",async(f,d)=>{let m=process.env.DASHBOARD_API_URL;if(o.get("/api/ai/material-recommendations",async(y,w)=>{try{let g=await(await Promise.resolve().then(()=>(er(),Xt))).generateOrderingRecommendations();w.json({recommendations:g})}catch(P){console.error("Error getting material recommendations:",P),w.status(500).json({error:"Failed to generate recommendations",message:P.message})}}),o.get("/api/ai/seasonal-trends/:materialId",async(y,w)=>{try{let{materialId:P}=y.params,O=await(await Promise.resolve().then(()=>(er(),Xt))).getSeasonalTrends(P);w.json(O)}catch(P){console.error("Error getting seasonal trends:",P),w.status(500).json({error:"Failed to get trends",message:P.message})}}),!m)return d.status(400).json({error:"Dashboard API URL not configured"});try{let w=await(await fetch(`${m}/api/status`)).json();d.json(w)}catch(y){d.status(500).json({error:y.message})}}),o.post("/api/dashboard-proxy/test",async(f,d)=>{let m=process.env.DASHBOARD_API_URL;if(!m)return d.status(400).json({error:"Dashboard API URL not configured"});try{(await fetch(`${m}/api/health`)).ok?d.json({success:!0,message:"Dashboard connection successful"}):d.status(500).json({error:"Dashboard connection failed"})}catch(y){d.status(500).json({error:y.message})}}),o.all("/api/dashboard-proxy/*",async(f,d)=>{let m=process.env.DASHBOARD_API_URL;if(!m)return d.status(503).json({success:!1,error:"Dashboard API URL not configured. Please add DASHBOARD_API_URL to your secrets."});try{let y=f.params[0],w={method:f.method,headers:{"Content-Type":"application/json",...f.headers.authorization&&{Authorization:f.headers.authorization}}};["POST","PUT","PATCH"].includes(f.method)&&f.body&&(w.body=JSON.stringify(f.body));let P=await fetch(`${m}/${y}`,w);if(!P.ok)throw new Error(`Dashboard API responded with status: ${P.status}`);let g=await P.json();d.status(P.status).json(g)}catch(y){console.error("Dashboard API proxy error:",y),d.status(500).json({success:!1,error:"Failed to connect to Dashboard API",details:y instanceof Error?y.message:"Unknown error"})}}),o.get("/api/vendor-catalog/all",(f,d)=>{d.json([])}),o.get("/api/vendor-catalog/larson",(f,d)=>{d.json([])}),o.get("/api/vendor-catalog/roma",(f,d)=>{d.json([])}),o.get("/api/vendor-catalog/nielsen",(f,d)=>{d.json([])}),o.get("/api/larson-catalog/crescent",(f,d)=>{d.json([])}),o.get("/api/frames",(f,d)=>{d.json([])}),o.get("/api/mat-colors",(f,d)=>{d.json([])}),o.get("/api/glass-options",(f,d)=>{d.json([])}),o.get("/api/wholesale-orders",(f,d)=>{d.json([])}),o.get("/api/qr-codes",(f,d)=>{d.json([])}),o.get("/api/hub/material-orders",(f,d)=>{d.json([])}),o.get("/api/auth/status",(f,d)=>{d.json({authenticated:!1,user:null})}),o.get("/api/discord/bot-info",(f,d)=>{d.json({status:"disabled",message:"Discord integration temporarily disabled for deployment stability"})}),o.post("/api/discord/test-notification",async(f,d)=>{d.status(503).json({error:"Discord integration temporarily disabled",message:"Discord notifications are currently unavailable"})}),o.post("/api/notifications/send",async(f,d)=>{try{let{customerPhone:m,customerEmail:y,orderId:w,type:P,message:g,discordUserId:O}=f.body,{getCustomerByPhone:H,getCustomerByEmail:q,updateCustomerDiscordId:ue}=await Promise.resolve().then(()=>(rr(),tr)),le=m?H(m):y?q(y):null;if(!le)return d.status(404).json({error:"Customer not found"});let st=w||Math.floor(Math.random()*1e3)+100;console.log(`Notification request for customer ${le.name}: ${P} - ${g}`),d.json({success:!0,customer:{name:le.name,phone:le.phone,email:le.email,hasDiscord:!1},orderNumber:st,message:"Notification logged (Discord integration disabled for deployment stability)"})}catch(m){console.error("Error sending customer notification:",m),d.status(500).json({error:"Failed to send notification",details:m instanceof Error?m.message:"Unknown error"})}}),o.get("/api/customers/search",async(f,d)=>{try{let{phone:m,email:y}=f.query,{getCustomerByPhone:w,getCustomerByEmail:P}=await Promise.resolve().then(()=>(rr(),tr)),g=m?w(m):y?P(y):null;if(!g)return d.status(404).json({error:"Customer not found"});d.json({customer:{id:g.id,name:g.name,phone:g.phone,email:g.email,hasDiscord:!!g.discordUserId,preferences:g.preferences,notes:g.notes}})}catch{d.status(500).json({error:"Failed to search customer"})}}),o.get("/api/kanban/external/orders",async(f,d)=>{try{let{externalKanbanService:m}=await Promise.resolve().then(()=>(ot(),rt)),y=await m.fetchOrders();d.json(y)}catch{d.status(500).json({success:!1,orders:[],error:"Failed to fetch orders from external Kanban app"})}}),o.get("/api/kanban/external/health",async(f,d)=>{try{let{externalKanbanService:m}=await Promise.resolve().then(()=>(ot(),rt)),y=await m.healthCheck();d.json(y)}catch{d.status(500).json({status:"error",connected:!1,error:"Failed to check external Kanban health"})}}),o.get("/api/integrations/test-all",async(f,d)=>{try{let m={dashboard:{connected:!1,error:null},kanban:{connected:!1,error:null}},y=process.env.DASHBOARD_API_URL;if(y)try{let g=await fetch(`${y}/api/health`,{method:"GET",timeout:5e3});m.dashboard.connected=g.ok,g.ok||(m.dashboard.error=`HTTP ${g.status}`)}catch(g){m.dashboard.error=g instanceof Error?g.message:"Connection failed"}else m.dashboard.error="Dashboard API URL not configured";let w=process.env.EXTERNAL_KANBAN_URL,P=process.env.EXTERNAL_KANBAN_API_KEY;if(w&&P)try{let g=await fetch(`${w}/api/health`,{method:"GET",headers:{Authorization:`Bearer ${P}`,"Content-Type":"application/json"},timeout:5e3});m.kanban.connected=g.ok,g.ok||(m.kanban.error=`HTTP ${g.status}`)}catch(g){m.kanban.error=g instanceof Error?g.message:"Connection failed"}else m.kanban.error="Kanban API URL or API Key not configured";d.json({success:!0,integrations:m,summary:{total:2,connected:Object.values(m).filter(g=>g.connected).length,failed:Object.values(m).filter(g=>!g.connected).length}})}catch{d.status(500).json({success:!1,error:"Failed to test integrations"})}}),o.post("/api/kanban/external/test-connection",async(f,d)=>{try{let{externalKanbanService:m}=await Promise.resolve().then(()=>(ot(),rt)),y=!!process.env.EXTERNAL_KANBAN_URL,w=!!process.env.EXTERNAL_KANBAN_API_KEY;if(!y||!w)return d.status(400).json({success:!1,error:"Kanban configuration incomplete",details:{hasUrl:y,hasApiKey:w,message:"Please add EXTERNAL_KANBAN_URL and EXTERNAL_KANBAN_API_KEY to your secrets"}});let P=await m.healthCheck(),g=await m.fetchOrders();d.json({success:P.connected,health:P,ordersTest:{success:g.success,orderCount:g.orders.length,error:g.error},configuration:{baseUrl:process.env.EXTERNAL_KANBAN_URL?`${process.env.EXTERNAL_KANBAN_URL.substring(0,30)}...`:"Not configured",apiKeyConfigured:!!process.env.EXTERNAL_KANBAN_API_KEY}})}catch(m){d.status(500).json({success:!1,error:"Connection test failed",details:m instanceof Error?m.message:"Unknown error"})}}),o.post("/api/kanban/external/orders/:orderId/status",async(f,d)=>{try{let{orderId:m}=f.params,{status:y,stage:w,notes:P}=f.body,{externalKanbanService:g}=await Promise.resolve().then(()=>(ot(),rt));await g.updateOrderStatus(m,y,w,P)?d.json({success:!0,orderId:m,updatedStatus:y,stage:w,notes:P,timestamp:new Date().toISOString()}):d.status(500).json({success:!1,error:"Failed to update order status in external Kanban"})}catch{d.status(500).json({success:!1,error:"Failed to update external Kanban order status"})}}),o.get("/api/kanban/api-key",(f,d)=>{d.json({success:!0,message:"Use one of these API keys for integration",apiKeys:[{key:"kanban_admin_key_2025_full_access",name:"3D Designer Integration",permissions:["orders:create","orders:read","orders:update","pricing:read","files:upload"]},{key:"jf_houston_heights_framing_2025_master_api_key_secure_access",name:"Houston Heights Framing API Integration",permissions:["orders:read","orders:write","integration:webhook","pricing:read","catalog:read"]}],usage:{header:"Authorization",format:"Bearer YOUR_API_KEY"},endpoints:{baseUrl:process.env.REPL_URL||"https://your-repl-name.replit.app",orders:"/api/kanban/orders",status:"/api/kanban/status"}})});let t=process.env.POS_API_KEY||"jays_frames_kanban_2025";o.get("/api/kanban/orders",Tt,(f,d)=>{d.json({success:!0,orders:[],endpoint:"/api/kanban/orders",description:"Retrieves all orders with production status and timeline information"})}),o.post("/api/kanban/orders/:orderId/status",Tt,(f,d)=>{let{orderId:m}=f.params,{status:y,stage:w,notes:P}=f.body;d.json({success:!0,orderId:m,updatedStatus:y,stage:w,notes:P,timestamp:new Date().toISOString(),description:"Updates order production status from external Kanban system"})}),o.get("/api/kanban/status",(f,d)=>{d.json({status:"active",service:"Jays Frames POS System",version:"1.0.0",endpoints:{orders:"/api/kanban/orders",updateStatus:"/api/kanban/orders/:orderId/status",health:"/api/kanban/status"},authentication:"API Key required in Authorization header",timestamp:new Date().toISOString()})}),o.get("/api/kanban/api-key",(f,d)=>{d.json({apiKey:t,usage:"Add this to your Kanban app Authorization header as: Bearer "+t,endpoints:{orders:"/api/kanban/orders",updateStatus:"/api/kanban/orders/:orderId/status"},note:"Keep this API key secure - it provides access to your order data"})}),o.use("/api/hub",Qr),o.use("/api/hub-admin",Lt),o.use("/api/admin",Lt),o.post("/api/admin/generate-api-key",async(f,d)=>{try{let{generateApiKey:m}=await Promise.resolve().then(()=>(Me(),Ze));await m(f,d)}catch(m){console.error("Error in generate-api-key route:",m),d.status(500).json({success:!1,error:m.message})}}),o.get("/api/admin/integration-status",async(f,d)=>{try{let{getIntegrationStatus:m}=await Promise.resolve().then(()=>(Me(),Ze));await m(f,d)}catch(m){console.error("Error in integration-status route:",m),d.status(500).json({success:!1,error:m.message})}}),o.get("/api/admin/integration-docs",async(f,d)=>{try{let{getIntegrationDocs:m}=await Promise.resolve().then(()=>(Me(),Ze));await m(f,d)}catch(m){console.error("Error in integration-docs route:",m),d.status(500).json({success:!1,error:m.message})}}),o.get("/api/webhooks",async(f,d)=>{try{d.json({success:!0,webhooks:[]})}catch(m){console.error("Error in webhooks route:",m),d.status(500).json({success:!1,error:m.message})}}),o.use("/api",vo),o.use("/api",Co),o.use("/api",To),o.use("/api/integration",uo),o.use("/api/xml-price-sheets",Bo),o.use("/api/larson-optimizer",Vo),o.use("/api/test-email",Yo),o.use("/api/voice-calls",os),o.use("/api/twiml",ss),o.use("/api/order-notifications",as),o.use("/api",us),o.get("/api/discord/status",(f,d)=>{d.json({status:"disabled",message:"Discord integration disabled for deployment stability"})}),o.get("/api/notifications/status",(f,d)=>{d.json({status:"basic",channels:["email"],message:"Basic notifications only"})}),o.get("/api/materials/pick-list",Xr),o.get("/api/materials/by-supplier",eo),o.get("/api/materials/order/:orderId",to),o.put("/api/materials/:id",ro),o.post("/api/materials/purchase-order",oo),o.get("/api/materials/types",so),o.get("/api/materials/suppliers",ao),o.post("/api/materials/bulk-update",async(f,d)=>{try{let{materialIds:m,status:y,adminApproval:w}=f.body;if(!m||!Array.isArray(m)||m.length===0)return d.status(400).json({error:"Material IDs are required"});if(!y)return d.status(400).json({error:"Status is required"});let O=(await b.getMaterialsPickList()).filter(q=>m.includes(q.id.toString())).filter(q=>q.status==="ordered"||q.status==="arrived"||q.status==="completed");if(O.length>0&&!w)return d.status(409).json({error:"DOUBLE_ORDER_PREVENTION",message:"Materials already ordered. Admin approval required.",alreadyOrderedMaterials:O});let H=[];for(let q of m)try{let ue=await b.updateMaterialOrder(parseInt(q),{status:y,notes:w?"Admin approved override for duplicate order":void 0});H.push(ue)}catch(ue){console.error(`Failed to update material ${q}:`,ue)}d.json({message:`Successfully updated ${H.length} materials to ${y}`,updatedMaterials:H,adminApproval:w||!1})}catch(m){console.error("Error in bulk update:",m),d.status(500).json({error:"Failed to update materials"})}}),o.post("/api/materials/mark-out-of-stock",async(f,d)=>{try{let{materialIds:m,notes:y}=f.body;if(!m||!Array.isArray(m)||m.length===0)return d.status(400).json({error:"Material IDs are required"});let w=[];for(let P of m)try{let g=await b.updateMaterialOrder(parseInt(P),{status:"out_of_stock",notes:y||"Marked as out of stock"});w.push(g)}catch(g){console.error(`Failed to mark material ${P} as out of stock:`,g)}d.json({message:`Successfully marked ${w.length} materials as out of stock`,updatedMaterials:w})}catch(m){console.error("Error marking materials as out of stock:",m),d.status(500).json({error:"Failed to mark materials as out of stock"})}}),o.post("/api/orders/:orderId/generate-materials",async(f,d)=>{try{let m=parseInt(f.params.orderId);if(!m||isNaN(m))return d.status(400).json({error:"Valid order ID is required"});console.log(`Generating materials for order ID: ${m}`);let y=await b.getOrder(m);if(!y)return d.status(404).json({error:"Order not found"});console.log("Found order:",y);let w=await b.createMaterialOrdersFromorder(y);console.log(`Generated ${w.length} material orders`),d.json({success:!0,message:`Generated ${w.length} material orders for order #${m}`,materialOrders:w})}catch(m){console.error("Error generating materials for order:",m),d.status(500).json({success:!1,error:m.message||"Failed to generate material orders"})}}),o.post("/api/orders/generate-all-materials",async(f,d)=>{try{let m=await b.getAllOrders(),y=0,w=0;for(let P of m)try{let g=await b.createMaterialOrdersFromOrder(P);y+=g.length,w++}catch(g){console.error(`Error creating materials for order ${P.id}:`,g)}d.json({success:!0,message:`Generated ${y} material orders from ${w} orders`,totalMaterialOrders:y,processedOrders:w})}catch(m){console.error("Error generating materials for all orders:",m),d.status(500).json({error:m.message})}}),o.post("/api/create-payment-intent",async(f,d)=>{try{let{orderGroupId:m,amount:y}=f.body;if(!m||!y)return d.status(400).json({success:!1,message:"Order group ID and amount are required"});let w=Math.round(Number(y)*100);if(isNaN(w)||w<=0)return d.status(400).json({success:!1,message:"Valid amount is required"});if(!process.env.STRIPE_SECRET_KEY)return d.status(500).json({success:!1,message:"Stripe is not configured. Please contact support."});let g=await new Stripe(process.env.STRIPE_SECRET_KEY).paymentIntents.create({amount:w,currency:"usd",automatic_payment_methods:{enabled:!0},metadata:{orderGroupId:m.toString(),businessName:"Jay's Frames"},description:`Order #${m} - Jay's Frames`});d.json({success:!0,clientSecret:g.client_secret,amount:w})}catch(m){console.error("Error creating payment intent:",m),d.status(500).json({success:!1,message:"Failed to create payment intent",error:m instanceof Error?m.message:"Unknown error"})}});let{createNewPaymentLink:e,getAllPaymentLinks:r,getPaymentLinkById:s,sendPaymentLinkNotification:a,validatePaymentLinkByToken:n,completePaymentForLink:l,verifyPaymentCompletion:i}=await Promise.resolve().then(()=>(xs(),Ss));o.post("/api/payment-links",e),o.get("/api/payment-links",r),o.get("/api/payment-links/:id",s),o.post("/api/payment-links/:id/send",a),o.get("/api/payment/:token/validate",n),o.post("/api/payment/:token/complete",l),o.post("/api/payment/:token/verify",i);let p=fi(o),_=new gi({server:p,path:"/ws"});return _.on("connection",f=>{console.log("WebSocket client connected"),f.on("message",d=>{try{console.log("Received message:",d.toString()),_.clients.forEach(m=>{m.readyState===yi.OPEN&&m.send(d.toString())})}catch(m){console.error("WebSocket message error:",m)}}),f.send(JSON.stringify({type:"connection",message:"WebSocket connection established"}))}),p}Jt();import hi from"path";import vs from"fs";import{fileURLToPath as bi}from"url";import{dirname as wi}from"path";import Pi from"cors";var Si=bi(import.meta.url),Ad=wi(Si),re=St(),lr=parseInt(process.env.PORT||"5000",10);re.use(Pi({origin:["http://localhost:5173","http://localhost:3000","http://localhost:5000","https://localhost:5173",process.env.REPL_URL||"",process.env.FRONTEND_URL||"",/https:\/\/.*\.replit\.dev$/,/https:\/\/.*\.replit\.app$/,/https:\/\/.*\.repl\.co$/],credentials:!0,methods:["GET","POST","PUT","DELETE","PATCH","OPTIONS"],allowedHeaders:["Content-Type","Authorization","X-Requested-With"]}));re.use(St.json({limit:"100mb"}));re.use(St.urlencoded({extended:!0,limit:"100mb"}));re.use((o,t,e)=>{let r=Date.now(),s=o.path,a,n=t.json;t.json=function(l,...i){return a=l,n.apply(t,[l,...i])},t.on("finish",()=>{let l=Date.now()-r;if(s.startsWith("/api")){let i=`${o.method} ${s} ${t.statusCode} in ${l}ms`;a&&(i+=` :: ${JSON.stringify(a)}`),i.length>80&&(i=i.slice(0,79)+"\u2026"),L(i)}}),e()});(async()=>{let o=await Is(re);re.use((r,s,a,n)=>{let l=r.status||r.statusCode||500,i=r.message||"Internal Server Error";a.status(l).json({message:i}),L(`Error: ${i} (${l})`,"error"),console.error(r)}),re.get("env")==="development"?await fs(re,o):gs(re);let t=()=>{try{let r=o.listen(lr,"0.0.0.0",()=>{L(`serving on port ${lr}`),console.log(`\u2713 Server running on port ${lr}`),console.log("\u2713 Environment: production"),console.log("\u2713 Ready for connections")});r.on("error",a=>{L(`Server startup error: ${a.message}`,"error"),console.error("Server error:",a),process.exit(1)});let s=a=>{L(`${a} received, shutting down gracefully`,"info"),console.log("Shutting down server..."),r.close(n=>{n?(console.error("Error during shutdown:",n),process.exit(1)):(L("Server closed","info"),console.log("Server closed gracefully"),process.exit(0))}),setTimeout(()=>{console.log("Force exit after timeout"),process.exit(1)},1e4)};return process.on("SIGTERM",()=>s("SIGTERM")),process.on("SIGINT",()=>s("SIGINT")),r}catch(r){L(`Critical server startup failure: ${r?.message||r}`,"error"),console.error("Critical error:",r),process.exit(1)}},e=hi.join(process.cwd(),"uploads");try{vs.existsSync(e)||vs.mkdirSync(e,{recursive:!0})}catch(r){L(`Warning: Could not create uploads directory: ${r}`,"warning")}re.use("/uploads",St.static(e)),t()})();
