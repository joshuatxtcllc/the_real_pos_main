var Je=Object.defineProperty;var ro=Object.getOwnPropertyDescriptor;var to=Object.getOwnPropertyNames;var oo=Object.prototype.hasOwnProperty;var M=(a,r)=>()=>(a&&(r=a(a=0)),r);var re=(a,r)=>{for(var e in r)Je(a,e,{get:r[e],enumerable:!0})},ao=(a,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of to(r))!oo.call(a,o)&&o!==e&&Je(a,o,{get:()=>r[o],enumerable:!(t=ro(r,o))||t.enumerable});return a};var jr=a=>ao(Je({},"__esModule",{value:!0}),a);var or={};re(or,{customerNotifications:()=>$,customers:()=>b,frames:()=>O,glassOptions:()=>W,insertCustomerNotificationSchema:()=>So,insertCustomerSchema:()=>Xe,insertFrameSchema:()=>no,insertGlassOptionSchema:()=>co,insertInventoryCategorySchema:()=>Mo,insertInventoryCountItemSchema:()=>Bo,insertInventoryCountSchema:()=>Eo,insertInventoryItemSchema:()=>No,insertInventoryLocationSchema:()=>_o,insertInventoryTransactionSchema:()=>ko,insertLarsonJuhlCatalogSchema:()=>wo,insertMatColorSchema:()=>io,insertMaterialLocationSchema:()=>$o,insertMaterialOrderSchema:()=>Oo,insertNotificationSchema:()=>To,insertOrderFrameSchema:()=>ho,insertOrderGroupSchema:()=>lo,insertOrderMatSchema:()=>go,insertOrderSchema:()=>po,insertOrderSpecialServiceSchema:()=>fo,insertPaymentLinkSchema:()=>qo,insertPurchaseOrderLineSchema:()=>Ro,insertPurchaseOrderSchema:()=>jo,insertQrCodeScanSchema:()=>Lr,insertQrCodeSchema:()=>qr,insertSpecialServiceSchema:()=>uo,insertSupplierSchema:()=>vo,insertUserSchema:()=>bo,insertWholesaleOrderSchema:()=>yo,inventoryCategories:()=>te,inventoryCountItems:()=>Er,inventoryCounts:()=>er,inventoryItems:()=>I,inventoryLocations:()=>j,inventoryTransactions:()=>V,larsonJuhlCatalog:()=>Rr,matColors:()=>L,materialLocations:()=>tr,materialOrderStatuses:()=>Co,materialOrders:()=>_,materialTypes:()=>Io,measurementUnits:()=>Fo,notificationChannels:()=>Po,notificationTypes:()=>xo,notifications:()=>F,orderFrames:()=>Oe,orderGroups:()=>N,orderMats:()=>Ce,orderSpecialServices:()=>le,orders:()=>g,paymentLinks:()=>Br,productionStatuses:()=>mo,purchaseOrderLines:()=>Re,purchaseOrderStatuses:()=>Do,purchaseOrders:()=>U,qrCodeScans:()=>rr,qrCodeTypes:()=>Lo,qrCodes:()=>de,specialServices:()=>G,suppliers:()=>A,transactionTypes:()=>Ao,users:()=>K,wholesaleOrders:()=>H});import{pgTable as w,text as i,serial as S,integer as h,boolean as v,numeric as p,timestamp as f,jsonb as Ie,primaryKey as so}from"drizzle-orm/pg-core";import{createInsertSchema as x}from"drizzle-zod";var b,Xe,O,no,L,io,W,co,G,uo,N,lo,mo,g,po,le,fo,Ce,go,Oe,ho,H,yo,K,bo,Rr,wo,xo,Po,$,So,Io,Co,_,Oo,A,vo,te,Mo,j,_o,Fo,I,No,Ao,V,ko,Do,U,jo,Re,Ro,er,Eo,Er,Bo,Br,qo,Lo,de,qr,rr,Lr,tr,$o,F,To,Y=M(()=>{"use strict";b=w("customers",{id:S("id").primaryKey(),name:i("name").notNull(),email:i("email"),phone:i("phone"),address:i("address"),stripeCustomerId:i("stripe_customer_id"),createdAt:f("created_at").defaultNow()}),Xe=x(b).omit({id:!0,createdAt:!0}),O=w("frames",{id:i("id").primaryKey(),name:i("name").notNull(),manufacturer:i("manufacturer").notNull(),material:i("material").notNull(),width:p("width").notNull(),depth:p("depth").notNull(),price:p("price").notNull(),catalogImage:i("catalog_image").notNull(),edgeTexture:i("edge_texture"),corner:i("corner")}),no=x(O),L=w("mat_colors",{id:i("id").primaryKey(),name:i("name").notNull(),color:i("color").notNull(),price:p("price").notNull(),manufacturer:i("manufacturer"),code:i("code"),description:i("description"),category:i("category")}),io=x(L),W=w("glass_options",{id:i("id").primaryKey(),name:i("name").notNull(),description:i("description").notNull(),price:p("price").notNull()}),co=x(W),G=w("special_services",{id:i("id").primaryKey(),name:i("name").notNull(),description:i("description").notNull(),price:p("price").notNull()}),uo=x(G),N=w("order_groups",{id:S("id").primaryKey(),customerId:h("customer_id").references(()=>b.id),subtotal:p("subtotal"),tax:p("tax"),total:p("total"),status:i("status").notNull().default("open"),paymentMethod:i("payment_method"),notes:i("notes"),createdAt:f("created_at").defaultNow(),stripePaymentIntentId:i("stripe_payment_intent_id"),stripePaymentStatus:i("stripe_payment_status"),paymentDate:f("payment_date"),discountAmount:p("discount_amount"),discountType:i("discount_type"),taxExempt:v("tax_exempt").default(!1),cashAmount:p("cash_amount"),checkNumber:i("check_number"),invoiceEmailSent:v("invoice_email_sent").default(!1),invoiceEmailDate:f("invoice_email_date")}),lo=x(N).omit({id:!0,createdAt:!0}),mo=["order_processed","scheduled","materials_ordered","materials_arrived","frame_cut","mat_cut","prepped","completed","delayed"],g=w("orders",{id:S("id").primaryKey(),customerId:h("customer_id").references(()=>b.id),orderGroupId:h("order_group_id").references(()=>N.id),frameId:i("frame_id").references(()=>O.id),matColorId:i("mat_color_id").references(()=>L.id),glassOptionId:i("glass_option_id").references(()=>W.id),artworkWidth:p("artwork_width").notNull(),artworkHeight:p("artwork_height").notNull(),matWidth:p("mat_width").notNull(),artworkDescription:i("artwork_description"),artworkType:i("artwork_type"),artworkLocation:i("artwork_location"),quantity:h("quantity").notNull().default(1),subtotal:p("subtotal").notNull(),tax:p("tax").notNull(),total:p("total").notNull(),status:i("status").notNull().default("pending"),productionStatus:i("production_status").$type().notNull().default("order_processed"),previousStatus:i("previous_status").$type(),createdAt:f("created_at").defaultNow(),dueDate:f("due_date"),artworkImage:i("artwork_image"),frameDesignImage:i("frame_design_image"),lastNotificationSent:f("last_notification_sent"),estimatedCompletionDays:h("estimated_completion_days"),addToWholesaleOrder:v("add_to_wholesale_order").default(!1),lastStatusChange:f("last_status_change").defaultNow(),notificationsEnabled:v("notifications_enabled").default(!0),useMultipleMats:v("use_multiple_mats").default(!1),useMultipleFrames:v("use_multiple_frames").default(!1),useManualFrame:v("use_manual_frame").default(!1),manualFrameName:i("manual_frame_name"),manualFrameCost:p("manual_frame_cost"),miscChargeDescription:i("misc_charge_description"),miscChargeAmount:p("misc_charge_amount")}),po=x(g).omit({id:!0,createdAt:!0}),le=w("order_special_services",{orderId:h("order_id").references(()=>g.id),specialServiceId:i("special_service_id").references(()=>G.id)},a=>({pk:so({columns:[a.orderId,a.specialServiceId]})})),fo=x(le),Ce=w("order_mats",{id:S("id").primaryKey(),orderId:h("order_id").references(()=>g.id).notNull(),matColorId:i("mat_color_id").references(()=>L.id).notNull(),position:h("position").notNull(),width:p("width").notNull(),offset:p("offset").notNull().default("0"),createdAt:f("created_at").defaultNow()}),go=x(Ce).omit({id:!0,createdAt:!0}),Oe=w("order_frames",{id:S("id").primaryKey(),orderId:h("order_id").references(()=>g.id).notNull(),frameId:i("frame_id").references(()=>O.id).notNull(),position:h("position").notNull(),distance:p("distance").notNull().default("0"),createdAt:f("created_at").defaultNow()}),ho=x(Oe).omit({id:!0,createdAt:!0}),H=w("wholesale_orders",{id:S("id").primaryKey(),orderId:h("order_id").references(()=>g.id),manufacturer:i("manufacturer").notNull(),items:Ie("items").notNull(),status:i("status").notNull().default("pending"),createdAt:f("created_at").defaultNow()}),yo=x(H).omit({id:!0,createdAt:!0}),K=w("users",{id:S("id").primaryKey(),username:i("username").notNull().unique(),password:i("password").notNull(),role:i("role").notNull().default("employee")}),bo=x(K).omit({id:!0}),Rr=w("larson_juhl_catalog",{id:i("id").primaryKey(),name:i("name").notNull(),hex_color:i("hex_color"),price:p("price",{precision:10,scale:6}).notNull(),code:i("code").notNull(),crescent_code:i("crescent_code"),description:i("description"),category:i("category"),manufacturer:i("manufacturer").notNull(),type:i("type").notNull().default("matboard"),material:i("material"),width:p("width"),depth:p("depth"),edge_texture:i("edge_texture"),corner:i("corner"),catalog_image:i("catalog_image"),createdAt:f("created_at").defaultNow()}),wo=x(Rr).omit({createdAt:!0}),xo=["status_update","estimated_completion","status_change","due_date_update","completion_reminder","order_complete","payment_reminder","delay_notification","payment_link"],Po=["email","sms","both"],$=w("customer_notifications",{id:S("id").primaryKey(),customerId:h("customer_id").references(()=>b.id),orderId:h("order_id").references(()=>g.id),notificationType:i("notification_type").$type().notNull(),channel:i("channel").$type().notNull().default("email"),subject:i("subject").notNull(),message:i("message").notNull(),sentAt:f("sent_at").defaultNow(),successful:v("successful").notNull(),responseData:Ie("response_data"),previousStatus:i("previous_status"),newStatus:i("new_status"),paymentLinkId:h("payment_link_id")}),So=x($).omit({id:!0,sentAt:!0}),Io=["frame","matboard","glass","backing_board","hardware","specialty_materials"],Co=["pending","processed","ordered","arrived","frame_cut","mat_cut","prepped","completed","delayed","canceled"],_=w("material_orders",{id:S("id").primaryKey(),materialType:i("material_type").$type().notNull(),materialId:i("material_id").notNull(),materialName:i("material_name").notNull(),quantity:p("quantity").notNull(),status:i("status").$type().notNull().default("pending"),sourceOrderId:h("source_order_id").references(()=>g.id),orderDate:f("order_date"),expectedArrival:f("expected_arrival"),actualArrival:f("actual_arrival"),supplierName:i("supplier_name"),supplierOrderNumber:i("supplier_order_number"),notes:i("notes"),costPerUnit:p("cost_per_unit"),totalCost:p("total_cost"),priority:i("priority").default("normal"),hubOrderId:i("hub_order_id"),hubSyncStatus:i("hub_sync_status").default("not_synced"),hubLastSyncDate:f("hub_last_sync_date"),hubTrackingInfo:i("hub_tracking_info"),hubEstimatedDelivery:f("hub_estimated_delivery"),hubSupplierNotes:i("hub_supplier_notes"),orderReference:i("order_reference"),unitMeasurement:i("unit_measurement"),createdAt:f("created_at").defaultNow()}),Oo=x(_).omit({id:!0,createdAt:!0,hubOrderId:!0,hubSyncStatus:!0,hubLastSyncDate:!0,hubTrackingInfo:!0,hubEstimatedDelivery:!0,hubSupplierNotes:!0}),A=w("suppliers",{id:S("id").primaryKey(),name:i("name").notNull(),contactName:i("contact_name"),email:i("email"),phone:i("phone"),address:i("address"),website:i("website"),accountNumber:i("account_number"),notes:i("notes"),paymentTerms:i("payment_terms"),minimumOrderAmount:p("minimum_order_amount"),shippingPreference:i("shipping_preference"),leadTime:h("lead_time"),active:v("active").default(!0),createdAt:f("created_at").defaultNow(),lastOrderDate:f("last_order_date")}),vo=x(A).omit({id:!0,createdAt:!0}),te=w("inventory_categories",{id:S("id").primaryKey(),name:i("name").notNull(),description:i("description"),parentCategoryId:h("parent_category_id").references(()=>te.id),createdAt:f("created_at").defaultNow()}),Mo=x(te).omit({id:!0,createdAt:!0}),j=w("inventory_locations",{id:S("id").primaryKey(),name:i("name").notNull(),description:i("description"),type:i("type"),parentLocationId:h("parent_location_id").references(()=>j.id),active:v("active").default(!0),createdAt:f("created_at").defaultNow()}),_o=x(j).omit({id:!0,createdAt:!0}),Fo=["each","inch","foot","united_inch","square_inch","sheet","roll","pound","liter","gallon"],I=w("inventory_items",{id:S("id").primaryKey(),sku:i("sku").notNull().unique(),name:i("name").notNull(),description:i("description"),categoryId:h("category_id").references(()=>te.id),supplierId:h("supplier_id").references(()=>A.id),supplierSku:i("supplier_sku"),unitOfMeasure:i("unit_of_measure").$type().notNull(),costPerUnit:p("cost_per_unit").notNull(),retailPrice:p("retail_price"),minimumStockLevel:p("minimum_stock_level").notNull(),reorderLevel:p("reorder_level").notNull(),reorderQuantity:p("reorder_quantity"),locationId:h("location_id").references(()=>j.id),barcode:i("barcode"),notes:i("notes"),tags:i("tags").array(),isActive:v("is_active").default(!0),createdAt:f("created_at").defaultNow(),updatedAt:f("updated_at").defaultNow(),lastCountDate:f("last_count_date"),imageUrl:i("image_url"),dimensions:Ie("dimensions"),autoBatchReorder:v("auto_batch_reorder").default(!1),materialType:i("material_type").$type(),materialId:i("material_id")}),No=x(I).omit({id:!0,createdAt:!0,updatedAt:!0}),Ao=["purchase","sale","adjustment","return","transfer","count","scrap","initial"],V=w("inventory_transactions",{id:S("id").primaryKey(),itemId:h("item_id").references(()=>I.id).notNull(),type:i("type").$type().notNull(),quantity:p("quantity").notNull(),unitCost:p("unit_cost"),locationId:h("location_id").references(()=>j.id),relatedOrderId:h("related_order_id").references(()=>g.id),notes:i("notes"),referenceNumber:i("reference_number"),createdAt:f("created_at").defaultNow(),createdBy:h("created_by").references(()=>K.id)}),ko=x(V).omit({id:!0,createdAt:!0}),Do=["draft","pending","approved","sent","partially_received","received","canceled"],U=w("purchase_orders",{id:S("id").primaryKey(),poNumber:i("po_number").notNull(),supplierId:h("supplier_id").references(()=>A.id).notNull(),orderDate:f("order_date").notNull(),expectedDeliveryDate:f("expected_delivery_date"),status:i("status").$type().default("draft").notNull(),subtotal:p("subtotal"),tax:p("tax"),shipping:p("shipping"),total:p("total"),notes:i("notes"),createdBy:h("created_by").references(()=>K.id),createdAt:f("created_at").defaultNow(),updatedAt:f("updated_at").defaultNow(),receivedDate:f("received_date"),supplierOrderConfirmation:i("supplier_order_confirmation"),shippingMethod:i("shipping_method"),paymentMethod:i("payment_method"),paymentTerms:i("payment_terms"),tracking:i("tracking"),attachments:i("attachments").array()}),jo=x(U).omit({id:!0,createdAt:!0,updatedAt:!0}),Re=w("purchase_order_lines",{id:S("id").primaryKey(),purchaseOrderId:h("purchase_order_id").references(()=>U.id).notNull(),itemId:h("item_id").references(()=>I.id).notNull(),quantity:p("quantity").notNull(),unitCost:p("unit_cost").notNull(),lineTotal:p("line_total").notNull(),receivedQuantity:p("received_quantity").default("0"),notes:i("notes"),createdAt:f("created_at").defaultNow()}),Ro=x(Re).omit({id:!0,createdAt:!0}),er=w("inventory_counts",{id:S("id").primaryKey(),countReference:i("count_reference").notNull(),startDate:f("start_date").notNull(),endDate:f("end_date"),status:i("status").default("in_progress").notNull(),notes:i("notes"),createdBy:h("created_by").references(()=>K.id),createdAt:f("created_at").defaultNow()}),Eo=x(er).omit({id:!0,createdAt:!0}),Er=w("inventory_count_items",{id:S("id").primaryKey(),countId:h("count_id").references(()=>er.id).notNull(),itemId:h("item_id").references(()=>I.id).notNull(),locationId:h("location_id").references(()=>j.id),expectedQuantity:p("expected_quantity"),actualQuantity:p("actual_quantity"),notes:i("notes"),countedBy:h("counted_by").references(()=>K.id),countedAt:f("counted_at"),createdAt:f("created_at").defaultNow()}),Bo=x(Er).omit({id:!0,createdAt:!0}),Br=w("payment_links",{id:S("id").primaryKey(),token:i("token").notNull().unique(),amount:p("amount",{precision:10,scale:2}).notNull(),description:i("description"),customerId:h("customer_id").references(()=>b.id),createdAt:f("created_at").defaultNow(),expiresAt:f("expires_at").notNull(),usedAt:f("used_at"),used:v("used").default(!1),paymentIntentId:i("payment_intent_id"),paymentStatus:i("payment_status").default("pending")}),qo=x(Br).omit({id:!0,createdAt:!0,usedAt:!0,used:!0,paymentIntentId:!0,paymentStatus:!0}),Lo=["inventory_location","inventory_item","material_order","customer_order","production_status","artwork_location"],de=w("qr_codes",{id:S("id").primaryKey(),code:i("code").notNull().unique(),type:i("type").$type().notNull(),entityId:i("entity_id").notNull(),title:i("title").notNull(),description:i("description"),metadata:Ie("metadata"),createdAt:f("created_at").defaultNow(),lastScanned:f("last_scanned"),scanCount:h("scan_count").default(0),active:v("active").default(!0)}),qr=x(de).omit({id:!0,createdAt:!0,lastScanned:!0,scanCount:!0}),rr=w("qr_code_scans",{id:S("id").primaryKey(),qrCodeId:h("qr_code_id").references(()=>de.id).notNull(),userId:h("user_id").references(()=>K.id),scannedAt:f("scanned_at").defaultNow(),location:i("location"),action:i("action"),metadata:Ie("metadata")}),Lr=x(rr).omit({id:!0,scannedAt:!0}),tr=w("material_locations",{id:S("id").primaryKey(),materialType:i("material_type").$type().notNull(),materialId:i("material_id").notNull(),locationId:h("location_id").references(()=>j.id).notNull(),qrCodeId:h("qr_code_id").references(()=>de.id),quantity:p("quantity").notNull().default("1"),notes:i("notes"),lastUpdated:f("last_updated").defaultNow(),active:v("active").default(!0)}),$o=x(tr).omit({id:!0,lastUpdated:!0}),F=w("notifications",{id:S("id").primaryKey(),title:i("title").notNull(),description:i("description").notNull(),source:i("source").notNull(),sourceId:i("source_id"),type:i("type").$type().notNull().default("info"),createdAt:f("created_at").defaultNow(),read:v("read").default(!1),actionable:v("actionable").default(!1),link:i("link"),smsEnabled:v("sms_enabled").default(!1),smsRecipient:i("sms_recipient"),userId:h("user_id").references(()=>K.id)}),To=x(F).omit({id:!0,createdAt:!0})});var ve,$r=M(()=>{"use strict";ve=[{id:"larson-4512",name:"Larson Gold Leaf 4512",manufacturer:"Larson-Juhl",material:"wood",width:"2.5",depth:"1.75",price:"12.99",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#D4AF37"},{id:"larson-210286",name:"Larson Academie Black 210286",manufacturer:"Larson-Juhl",material:"wood",width:"1.25",depth:"0.75",price:"8.50",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#000000"},{id:"larson-655320",name:"Larson Biltmore Gold 655320",manufacturer:"Larson-Juhl",material:"wood",width:"1.5",depth:"0.875",price:"10.75",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#FFD700"},{id:"larson-460530",name:"Larson Ventura Silver 460530",manufacturer:"Larson-Juhl",material:"metal",width:"0.75",depth:"1.125",price:"9.25",catalogImage:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#C0C0C0"},{id:"larson-310445",name:"Larson Classic Walnut 310445",manufacturer:"Larson-Juhl",material:"wood",width:"2.0",depth:"1.25",price:"14.50",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#8B4513"},{id:"larson-220158",name:"Larson Heritage Cherry 220158",manufacturer:"Larson-Juhl",material:"wood",width:"1.75",depth:"1.0",price:"11.25",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#722F37"},{id:"nielsen-71",name:"Nielsen Florentine",manufacturer:"Nielsen",material:"metal",width:"1.25",depth:"0.75",price:"8.99",catalogImage:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#C0C0C0"},{id:"roma-250",name:"Roma Dark Walnut",manufacturer:"Roma Moulding",material:"wood",width:"3.0",depth:"2.0",price:"14.50",catalogImage:"https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#5C4033"},{id:"omega-102",name:"Omega Black Satin",manufacturer:"Omega Moulding",material:"wood",width:"2.0",depth:"1.5",price:"9.75",catalogImage:"https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#2D2D2D"},{id:"bella-35",name:"Bella White Simple",manufacturer:"Bella Moulding",material:"composite",width:"1.5",depth:"1.0",price:"6.50",catalogImage:"https://images.unsplash.com/photo-1574117936532-46e544aeb239?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjZ8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1574117936532-46e544aeb239?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjZ8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1574117936532-46e544aeb239?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjZ8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#F5F5F5"},{id:"larson-8921",name:"Larson Ornate Gold",manufacturer:"Larson-Juhl",material:"wood",width:"3.5",depth:"2.25",price:"18.99",catalogImage:"https://images.unsplash.com/photo-1581814605484-050c5bb1196c?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzF8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1581814605484-050c5bb1196c?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzF8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1581814605484-050c5bb1196c?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzF8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#D4AF37"}]});async function Tr(){try{return console.log("Loading static matboard data to prevent application freezing..."),[]}catch(a){return console.error("Error fetching Crescent matboards:",a),[]}}var Wr=M(()=>{"use strict"});var Gr,Wo,Me,Go,Hr=M(()=>{"use strict";Wr();Gr=[{id:"white",name:"White",color:"#FFFFFF",price:"0.02",manufacturer:"Basic",code:"WHT",description:"Pure white mat board",category:"Standard"},{id:"black",name:"Black",color:"#2C2C2C",price:"0.025",manufacturer:"Basic",code:"BLK",description:"Deep black mat board",category:"Standard"},{id:"grey",name:"Grey",color:"#ADADAD",price:"0.02",manufacturer:"Basic",code:"GRY",description:"Neutral grey mat board",category:"Standard"},{id:"beige",name:"Beige",color:"#F5F5DC",price:"0.02",manufacturer:"Basic",code:"BGE",description:"Soft beige mat board",category:"Standard"}],Wo=[{id:"crescent-white",name:"Bright White",color:"#FFFFFF",price:"0.025",manufacturer:"Crescent",code:"S100",description:"Bright white conservation mat board",category:"Whites"},{id:"crescent-cream",name:"Cream",color:"#FFF8E1",price:"0.025",manufacturer:"Crescent",code:"S101",description:"Cream white conservation mat board",category:"Whites"},{id:"crescent-antique",name:"Antique White",color:"#F5F1E6",price:"0.025",manufacturer:"Crescent",code:"S102",description:"Subtle antique white tone",category:"Whites"},{id:"crescent-stone",name:"Stone",color:"#E0DCCC",price:"0.027",manufacturer:"Crescent",code:"S200",description:"Light stone grey conservation mat",category:"Neutrals"},{id:"crescent-fog",name:"Fog",color:"#D6D6D6",price:"0.027",manufacturer:"Crescent",code:"S201",description:"Subtle fog grey conservation mat",category:"Neutrals"},{id:"crescent-granite",name:"Granite",color:"#A9A9A9",price:"0.027",manufacturer:"Crescent",code:"S202",description:"Darker granite grey tone",category:"Neutrals"},{id:"crescent-colonial-blue",name:"Colonial Blue",color:"#B5C7D3",price:"0.029",manufacturer:"Crescent",code:"S300",description:"Subtle colonial blue conservation mat",category:"Blues"},{id:"crescent-wedgewood",name:"Wedgewood",color:"#6E99C0",price:"0.029",manufacturer:"Crescent",code:"S301",description:"Classic wedgewood blue conservation mat",category:"Blues"},{id:"crescent-ultramarine",name:"Ultramarine",color:"#4166B0",price:"0.029",manufacturer:"Crescent",code:"S302",description:"Deep ultramarine blue conservation mat",category:"Blues"},{id:"crescent-sage",name:"Sage",color:"#BCCCBA",price:"0.029",manufacturer:"Crescent",code:"S400",description:"Soft sage green conservation mat",category:"Greens"},{id:"crescent-celadon",name:"Celadon",color:"#9CB084",price:"0.029",manufacturer:"Crescent",code:"S401",description:"Classic celadon green conservation mat",category:"Greens"},{id:"crescent-forest",name:"Forest",color:"#4A6741",price:"0.029",manufacturer:"Crescent",code:"S402",description:"Deep forest green conservation mat",category:"Greens"},{id:"crescent-sand",name:"Sand",color:"#E6D7B8",price:"0.027",manufacturer:"Crescent",code:"S500",description:"Light sand beige conservation mat",category:"Earth Tones"},{id:"crescent-chamois",name:"Chamois",color:"#D9BC8C",price:"0.027",manufacturer:"Crescent",code:"S501",description:"Warm chamois tan conservation mat",category:"Earth Tones"},{id:"crescent-chestnut",name:"Chestnut",color:"#A67B5B",price:"0.027",manufacturer:"Crescent",code:"S502",description:"Rich chestnut brown conservation mat",category:"Earth Tones"},{id:"crescent-pale-rose",name:"Pale Rose",color:"#F0D4D4",price:"0.029",manufacturer:"Crescent",code:"S600",description:"Subtle pale rose conservation mat",category:"Warm Tones"},{id:"crescent-dusty-rose",name:"Dusty Rose",color:"#D4A9A9",price:"0.029",manufacturer:"Crescent",code:"S601",description:"Classic dusty rose conservation mat",category:"Warm Tones"},{id:"crescent-rust",name:"Rust",color:"#B56A55",price:"0.029",manufacturer:"Crescent",code:"S602",description:"Deep rust red conservation mat",category:"Warm Tones"},{id:"crescent-black",name:"Raven Black",color:"#1A1A1A",price:"0.03",manufacturer:"Crescent",code:"S700",description:"Deep black conservation mat board",category:"Black"}],Me=[...Gr,...Wo],Go=async()=>{if(typeof window>"u"){console.log("Skipping Supabase fetch on server-side");return}try{console.log("Fetching Crescent matboards from Larson Juhl catalog...");let a=await Tr();if(a&&a.length>0){console.log("Converting API matboards to MatColor format");let r=a.map(t=>({id:t.id,name:t.name,color:t.hex_color||"#FFFFFF",price:t.price,manufacturer:t.manufacturer,code:t.code||null,description:t.description||null,category:t.category||null}));Me=[...Gr,...r],console.log(`Loaded and converted ${a.length} Crescent matboards from Larson Juhl catalog`)}else console.log("No Crescent matboards found in Larson Juhl catalog or empty response. Using static fallback data.")}catch(a){console.error("Failed to load Crescent matboards:",a),console.log("Using static Crescent matboard catalog as fallback.")}};typeof window<"u"&&Go()});var Ee,Be,Ur=M(()=>{"use strict";Ee=[{id:"none",name:"No Glass",description:"No glass protection",price:"0.00"},{id:"regular",name:"Regular Glass",description:"Standard protection",price:"0.08"},{id:"uv",name:"Museum Glass",description:"Museum non-glare",price:"0.45"},{id:"museum",name:"Conservation Glass",description:"Premium UV protection",price:"0.25"}],Be=[{id:"float-mount",name:"Float Mount",description:"Artwork appears to float",price:"50.00"},{id:"glass-float",name:"Glass Float",description:"Suspended between glass",price:"55.00"},{id:"shadowbox",name:"Shadowbox",description:"For 3D objects",price:"65.00"},{id:"labor-30min",name:"Additional Labor (30 min)",description:"Custom work",price:"30.00"},{id:"labor-1hour",name:"Additional Labor (1 hour)",description:"Custom work",price:"55.00"}]});import{createClient as Ho}from"@supabase/supabase-js";var qe,zr=M(()=>{"use strict";qe=null;try{let a=process.env.SUPABASE_URL||process.env.VITE_SUPABASE_URL,r=process.env.SUPABASE_KEY||process.env.VITE_SUPABASE_KEY||process.env.VITE_SUPABASE_ANON_KEY;a&&r?(qe=Ho(a,r),console.log("Server: Successfully initialized Supabase client")):(qe={from:()=>({select:()=>Promise.resolve({data:[],error:null}),insert:()=>Promise.resolve({data:[],error:null}),update:()=>Promise.resolve({data:[],error:null}),delete:()=>Promise.resolve({data:null,error:null}),upsert:()=>Promise.resolve({data:null,error:null})}),rpc:()=>Promise.resolve({data:null,error:null})},console.log("Server: Using mock Supabase client - data operations will be handled by Drizzle/PostgreSQL"))}catch(a){console.error("Server: Error initializing Supabase client:",a),qe={from:()=>({select:()=>Promise.resolve({data:[],error:null}),insert:()=>Promise.resolve({data:[],error:null}),update:()=>Promise.resolve({data:[],error:null}),delete:()=>Promise.resolve({data:null,error:null}),upsert:()=>Promise.resolve({data:null,error:null})}),rpc:()=>Promise.resolve({data:null,error:null})}}});import{Pool as Uo,neonConfig as zo}from"@neondatabase/serverless";import{drizzle as Qo}from"drizzle-orm/neon-serverless";import Ko from"ws";var Vo,u,Z=M(()=>{"use strict";Y();zr();zo.webSocketConstructor=Ko;if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL must be set. Did you forget to provision a database?");Vo=new Uo({connectionString:process.env.DATABASE_URL}),u=Qo({client:Vo,schema:or})});function Le(a,r){let e=new Date().toISOString(),t=r?`[${r}]`:"";console.log(`${e} ${t} ${a}`)}var Qr=M(()=>{"use strict"});function ar(a,r,e,t){let o=a/r,s=e+t;return o/s}function Yo(a){return a>=40?2.2:a>=25?2.4:a>=15?2.6:a>=10?2.8:a>=6?3:a>=4?3.2:a>=2?3.5:4}function Kr(a,r,e,t){let o=a+e*2,s=r+e*2,c=(o+s)/12*t,d=Yo(c);return c*d}function Vr(a,r,e,t){let o=a+e*2,s=r+e*2,n=o+s,l=n*t*2.5,c=5.5;n<=24?c=5.5:n<=36?c=5:n<=50?c=4.5:n<=68?c=4.2:n<=88?c=3.8:n<=108?c=3.5:c=3.2;let d=Zo(n);return l*c+d}function Yr(a,r,e,t){let o=a+e*2,s=r+e*2,n=o+s,l=n*t,c=4;return n<=24?c=4:n<=36?c=3.8:n<=50?c=3.5:n<=68?c=3.2:n<=88?c=3:n<=108?c=2.8:c=2.5,l*c}function Zo(a){let r=15;return a<=24?r=15:a<=36?r=20:a<=50?r=25:a<=68?r=35:a<=88?r=45:a<=108?r=55:r=65,r}var Zr=M(()=>{"use strict"});var et={};re(et,{calculateFramePrice:()=>Jo,calculateFramingPrice:()=>ca,calculateGlassPrice:()=>ea,calculateMatPrice:()=>Xo});function Jo(a,r){let e=r*6,t=oa(e);return a*r*t*1.2}function Xo(a,r,e){let t=sa(e);return r*a*t}function ea(a,r,e=0,t=0,o="regular"){let s=e&&t?e+t:Math.sqrt(r)*2,n=aa(s),l=1;switch(o){case"conservation":l=1.5;break;case"museum":l=2;break}let c=r/144;return(s<=40?85:125)+c*a*n*.35*l}function oa(a){return a<=20?1.8:a<=40?2.2:a<=60?2.6:a<=80?3:3.4}function aa(a){return a<=20?2.8:a<=40?3.2:a<=60?3.6:a<=80?4:4.5}function sa(a){return a<=20?2.5:a<=40?2.8:a<=60?3.1:a<=80?3.4:3.8}function na(a,r,e,t){let o=t/40;return{frameAssembly:a?.25*o:0,matCutting:r?.3*o:0,glassCutting:e?.15*o:0,fitting:.2*o,finishing:.1*o}}function ia(a,r,e){return(a.frameAssembly+a.matCutting+a.glassCutting+a.fitting+a.finishing)*r*e}async function ca(a){let{frameId:r,matColorId:e,glassOptionId:t,artworkWidth:o,artworkHeight:s,matWidth:n,quantity:l,includeWholesalePrices:c=!1}=a,d=r&&r!=="none"?await y.getFrame(r):null,C=e&&e!=="none"?await y.getMatColor(e):null,R=t&&t!=="none"?await y.getGlassOption(t):null,X=o+s,ee=o+n*2,D=s+n*2,z=ee+D,he=ee*D-o*s,E=ee*2+D*2,P=c?{frame:d?d.price:"0.00",mat:"0.00",glass:R&&R.price||"0.00",backing:"0.00"}:void 0,ye=0;if(d){let ue=parseFloat(d.price);if(ye=Kr(o,s,n,ue),P){let we=o+n*2,xe=s+n*2,Q=(we+xe)/12*ue;P.frame=Q.toFixed(2)}}let Ve=0;if(C){let q=ar(45.5,25,32,40);if(Ve=Vr(o,s,n,q),P){let Q=o+n*2,Pe=s+n*2,Se=(Q+Pe)*q;P.mat=Se.toFixed(2)}}let Ye=0;if(R){let q=ar(125,10,24,36);if(Ye=Yr(o,s,n,q),P){let Q=o+n*2,Pe=s+n*2,Se=(Q+Pe)*q;P.glass=Se.toFixed(2)}}let _r=.04,Fr=ee*D,Nr=Fr*_r*ra;P&&(P.backing=(Fr*_r).toFixed(2));let Ar=na(!!d,!!C,!!R,z),Ze=ia(Ar,Xr,Jr),kr=ye+Ve+Ye+Nr,be=kr+Ze,Xt=be*l,Dr;if(c&&P){let ue=d?parseFloat(d.price)*E/12:0,we=C?parseFloat(P.mat):0,xe=R&&R.price?parseFloat(R.price)*ee*D/144:0,De=parseFloat(P.backing),q=ue+we+xe+De,Q=q*ta,Pe=q+Q+Ze,je=be-Pe,Se=je/be,eo=be/q;Dr={totalWholesaleCost:q,overheadCost:Q,grossProfit:je,grossProfitMargin:Se,markupMultiplier:eo}}return{framePrice:ye,matPrice:Ve,glassPrice:Ye,backingPrice:Nr,laborCost:Ze,materialCost:kr,subtotal:be,totalPrice:Xt,wholesalePrices:P,laborRates:{baseRate:Xr,regionalFactor:Jr,estimates:Ar},profitability:Dr}}var ra,Jr,Xr,ta,rt=M(()=>{"use strict";oe();Zr();ra=1.2,Jr=1.15,Xr=45,ta=.3});var nr={};re(nr,{generateOrderStatusEmailTemplate:()=>at,sendEmailWithSendGrid:()=>ot,sendOrderStatusUpdate:()=>sr});import tt from"@sendgrid/mail";async function ot(a){if(!process.env.SENDGRID_API_KEY){console.warn("SendGrid API key is not configured. Email sending is disabled.");return}try{await tt.send({to:a.to,from:a.from||process.env.FROM_EMAIL||"noreply@jaysframes.com",subject:a.subject,text:a.text,html:a.html}),console.log(`Email sent successfully to ${a.to}`)}catch(r){throw console.error("SendGrid Error:",r),new Error(`Failed to send email: ${r.message}`)}}function at(a,r,e,t){let o=e.split("_").map(C=>C.charAt(0).toUpperCase()+C.slice(1)).join(" "),s=t?new Date(t).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}):"Not available",n=["order_processed","scheduled","materials_ordered","materials_arrived","frame_cut","mat_cut","prepped","completed"],l=n.indexOf(e),d=`
    <div style="margin: 20px 0; width: 100%;">
      <div style="width: 100%; background-color: #f0f0f0; height: 20px; border-radius: 10px; overflow: hidden;">
        <div style="width: ${Math.max(10,Math.min(100,Math.round((l+1)/n.length*100)))}%; background-color: #4CAF50; height: 20px;"></div>
      </div>
      <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 12px;">
        <span>Order Placed</span>
        <span>In Production</span>
        <span>Completed</span>
      </div>
    </div>
  `;return`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <title>Order Status Update</title>
      <style>
        body {
          font-family: Arial, sans-serif;
          line-height: 1.6;
          color: #333;
          margin: 0;
          padding: 0;
        }
        .container {
          max-width: 600px;
          margin: 0 auto;
          padding: 20px;
        }
        .header {
          background-color: #4A90E2;
          color: white;
          padding: 20px;
          text-align: center;
        }
        .content {
          padding: 20px;
          background-color: #f9f9f9;
        }
        .footer {
          text-align: center;
          padding: 20px;
          font-size: 12px;
          color: #666;
        }
        .button {
          display: inline-block;
          background-color: #4A90E2;
          color: white;
          padding: 10px 20px;
          text-decoration: none;
          border-radius: 5px;
          margin-top: 20px;
        }
        .status-box {
          background-color: #e8f4fd;
          border-left: 4px solid #4A90E2;
          padding: 15px;
          margin: 20px 0;
        }
        .details-table {
          width: 100%;
          border-collapse: collapse;
          margin: 20px 0;
        }
        .details-table th, .details-table td {
          border: 1px solid #ddd;
          padding: 10px;
          text-align: left;
        }
        .details-table th {
          background-color: #f0f0f0;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>Order Status Update</h1>
        </div>
        
        <div class="content">
          <p>Hello ${a},</p>
          
          <p>We're writing to provide you with an update on your custom framing order.</p>
          
          <div class="status-box">
            <h2>Order #${r} Status: ${o}</h2>
            <p>Your order is now in the <strong>${o}</strong> stage.</p>
            <p><strong>Estimated Completion:</strong> ${s}</p>
          </div>
          
          ${d}
          
          <h3>What's Next?</h3>
          <p>Your order is progressing through our custom framing process. Here's what's happening:</p>
          
          <table class="details-table">
            <tr>
              <th>Current Stage</th>
              <th>Description</th>
            </tr>
            <tr>
              <td>${o}</td>
              <td>${ua(e)}</td>
            </tr>
          </table>
          
          <p>We'll notify you when your order moves to the next stage or is ready for pickup.</p>
          
          <a href="#" class="button">Track Your Order</a>
        </div>
        
        <div class="footer">
          <p>Thank you for choosing Jays Frames Guru Framing</p>
          <p>123 Frame Street, Anytown, ST 12345</p>
          <p>Phone: (555) 123-4567 | Email: info@jaysframes.com</p>
        </div>
      </div>
    </body>
    </html>
  `}async function sr(a,r,e,t,o){let s=process.env.FROM_EMAIL||"orders@jaysframes.com",n=`Order #${e} Status Update - ${t.replace("_"," ").toUpperCase()}`,l=at(r,e,t,o);await ot({to:a,from:s,subject:n,html:l,text:`Hello ${r}, your order #${e} status has been updated to: ${t}`})}function ua(a){switch(a){case"order_processed":return"Your order has been processed and is scheduled for production.";case"scheduled":return"Your order has been scheduled and is in our production queue.";case"materials_ordered":return"We have ordered the special materials needed for your custom frame.";case"materials_arrived":return"All materials for your order have arrived and are ready for production.";case"frame_cut":return"Your frame has been cut to the specified dimensions.";case"mat_cut":return"Your mat board has been cut and prepared for assembly.";case"prepped":return"Your frame is assembled and is going through final quality checks.";case"completed":return"Your order is complete and ready for pickup!";case"delayed":return"Your order is temporarily delayed. We will contact you with more information.";default:return"Your order is being processed by our team."}}var ir=M(()=>{"use strict";process.env.SENDGRID_API_KEY&&tt.setApiKey(process.env.SENDGRID_API_KEY)});import{eq as m,desc as pe,sql as st,asc as cr}from"drizzle-orm";function me(a){let{material:r,name:e}=a,t=r.toLowerCase(),o=e.toLowerCase();return t.includes("gold")||o.includes("gold")?"#D4AF37":t.includes("silver")||t.includes("metal")||o.includes("silver")||o.includes("metal")||o.includes("chrome")||o.includes("steel")?"#C0C0C0":t.includes("black")||o.includes("black")||o.includes("ebony")||o.includes("onyx")?"#000000":t.includes("white")||o.includes("white")?"#F5F5F5":t.includes("walnut")||o.includes("walnut")?"#5C4033":t.includes("cherry")||o.includes("cherry")?"#722F37":t.includes("oak")||o.includes("oak")?"#D8BE75":t.includes("mahogany")||o.includes("mahogany")?"#4E2728":t.includes("maple")||o.includes("maple")?"#E8D4A9":"#8B4513"}var ur,y,oe=M(()=>{"use strict";Y();$r();Hr();Ur();Z();Qr();ur=class{async updateOrderArtLocation(r,e){try{let[t]=await u.update(g).set({artworkLocation:e}).where(m(g.id,r)).returning();if(!t)throw new Error("Order not found");return t}catch(t){throw console.error("Error updating order artwork location:",t),t}}async getOrderMats(r){try{let e=await u.select().from(Ce).where(m(Ce.orderId,r)),t=[];for(let o of e){let s=await this.getMatColor(o.matColorId);s&&t.push({...o,matboard:s})}return t}catch(e){return console.error(`Error getting order mats for order ${r}:`,e),[]}}async getOrderFrames(r){try{let e=await u.select().from(Oe).where(m(Oe.orderId,r)),t=[];for(let o of e){let s=await this.getFrame(o.frameId);s&&t.push({...o,frame:s})}return t}catch(e){return console.error(`Error getting order frames for order ${r}:`,e),[]}}async getOrderPricingDetails(r){try{let e=await this.getOrder(r);if(!e)return;let{calculatePricing:t}=(rt(),jr(et)),o=e.frameId?await this.getFrame(e.frameId):void 0,s=e.matColorId?await this.getMatColor(e.matColorId):void 0,n=e.glassOptionId?await this.getGlassOption(e.glassOptionId):void 0,l=await this.getOrderSpecialServices(r),c=await this.getOrderMats(r),d=await this.getOrderFrames(r),C={artworkWidth:Number(e.artworkWidth),artworkHeight:Number(e.artworkHeight),matWidth:Number(e.matWidth),frame:o,matColor:s,glassOption:n,specialServices:l,quantity:e.quantity||1,includeWholesalePrices:!0,mats:c.length>0?c:void 0,frames:d.length>0?d:void 0};return t(C)}catch(e){console.error("Error getting order pricing details:",e);return}}async getCustomer(r){let[e]=await u.select().from(b).where(m(b.id,r));return e||void 0}async getCustomerByEmail(r){let[e]=await u.select().from(b).where(m(b.email,r));return e||void 0}async getAllCustomers(){return await u.select().from(b)}async createCustomer(r){let[e]=await u.insert(b).values({...r,createdAt:new Date}).returning();return e}async updateCustomer(r,e){let[t]=await u.update(b).set(e).where(m(b.id,r)).returning();if(!t)throw new Error("Customer not found");return t}async getFrame(r){console.log(`Storage: Getting frame with ID: ${r}`);try{let[e]=await u.select().from(O).where(m(O.id,r));if(e){console.log(`Storage: Found frame in database: ${e.name}`);let o=me(e),s=e.catalogImage,n=e.corner||"",l=e.edgeTexture||"";if(e.manufacturer==="Larson-Juhl"){let c=e.id.split("-")[1];c&&(s=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_fab.jpg`,n=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_corner.jpg`,l=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_prof.jpg`)}if(e.manufacturer==="Nielsen"){let c=e.id.split("-")[1];c&&(s=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Detail.jpg`,n=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Corner.jpg`,l=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Edge.jpg`)}return{...e,catalogImage:s,corner:n,edgeTexture:l,color:o}}console.log("Storage: Frame not found in database, checking catalog");let t=ve.find(o=>o.id===r);if(t){console.log(`Storage: Found frame in catalog: ${t.name}`);let o=t.catalogImage,s=t.corner||"",n=t.edgeTexture||"",l=t.color||me(t);if(t.manufacturer==="Larson-Juhl"){let d=t.id.split("-")[1];d&&(o=`https://www.larsonjuhl.com/contentassets/products/mouldings/${d}_fab.jpg`,s=`https://www.larsonjuhl.com/contentassets/products/mouldings/${d}_corner.jpg`,n=`https://www.larsonjuhl.com/contentassets/products/mouldings/${d}_prof.jpg`)}if(t.manufacturer==="Nielsen"){let d=t.id.split("-")[1];d&&(o=`https://www.nielsenbainbridge.com/images/products/detail/${d}-Detail.jpg`,s=`https://www.nielsenbainbridge.com/images/products/detail/${d}-Corner.jpg`,n=`https://www.nielsenbainbridge.com/images/products/detail/${d}-Edge.jpg`)}let c={...t,catalogImage:o,corner:s,edgeTexture:n};console.log(`Storage: Inserting enhanced frame into database: ${c.name}`);try{await u.insert(O).values(c),console.log("Storage: Successfully inserted frame into database")}catch(d){console.error("Storage: Error inserting frame into database:",d)}return{...c,color:l}}console.log("Storage: Frame not found in catalog");return}catch(e){console.error(`Storage: Error in getFrame(${r}):`,e);let t=ve.find(o=>o.id===r);if(t){let o=me(t),s=t.catalogImage;if(t.manufacturer==="Larson-Juhl"){let n=t.id.split("-")[1];n&&(s=`https://www.larsonjuhl.com/contentassets/products/mouldings/${n}_fab.jpg`)}else if(t.manufacturer==="Nielsen"){let n=t.id.split("-")[1];n&&(s=`https://www.nielsenbainbridge.com/images/products/detail/${n}-Detail.jpg`)}return{...t,catalogImage:s,color:o}}return}}async getAllFrames(){console.log("Storage: Getting all frames");try{let r=await u.select().from(O);return console.log(`Storage: Found ${r.length} frames in database`),r.length>0?(console.log("Storage: Enhancing existing frames with real wholesaler images"),r.map(t=>{let o=me(t),s=t.catalogImage,n=t.corner||"",l=t.edgeTexture||"";if(t.manufacturer==="Larson-Juhl"){let c=t.id.split("-")[1];c&&(s=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_fab.jpg`,n=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_corner.jpg`,l=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_prof.jpg`)}if(t.manufacturer==="Nielsen"){let c=t.id.split("-")[1];c&&(s=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Detail.jpg`,n=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Corner.jpg`,l=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Edge.jpg`)}return{...t,catalogImage:s,corner:n,edgeTexture:l,color:o}})):(console.log("Storage: No frames in database, returning enhanced catalog data"),ve.map(t=>{let o=t.catalogImage,s=t.corner||"",n=t.edgeTexture||"",l=t.color||me(t);if(t.manufacturer==="Larson-Juhl"){let d=t.id.split("-")[1];d&&(o=`https://www.larsonjuhl.com/contentassets/products/mouldings/${d}_fab.jpg`,s=`https://www.larsonjuhl.com/contentassets/products/mouldings/${d}_corner.jpg`,n=`https://www.larsonjuhl.com/contentassets/products/mouldings/${d}_prof.jpg`)}if(t.manufacturer==="Nielsen"){let d=t.id.split("-")[1];d&&(o=`https://www.nielsenbainbridge.com/images/products/detail/${d}-Detail.jpg`,s=`https://www.nielsenbainbridge.com/images/products/detail/${d}-Corner.jpg`,n=`https://www.nielsenbainbridge.com/images/products/detail/${d}-Edge.jpg`)}let c={...t,catalogImage:o,corner:s,edgeTexture:n};try{u.insert(O).values(c).execute()}catch(d){console.error(`Storage: Error inserting frame ${t.id} into database:`,d)}return{...c,color:l}}))}catch(r){return console.error("Storage: Error in getAllFrames:",r),ve.map(e=>{let t=me(e),o=e.id.split("-")[1],s=e.catalogImage;return e.manufacturer==="Larson-Juhl"?s="https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D":e.manufacturer==="Roma"?s="https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D":e.manufacturer==="Omega"?s="https://images.unsplash.com/photo-1513519245088-0e12902e5a38?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8ZnJhbWV8ZW58MHx8MHx8fDA%3D":s="https://images.unsplash.com/photo-1518998053901-5348d3961a04?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fGZyYW1lfGVufDB8fDB8fHww",{...e,catalogImage:s,color:t}})}}async updateFrame(r,e){let[t]=await u.update(O).set(e).where(m(O.id,r)).returning();if(!t)throw new Error("Frame not found");return t}async addFrame(r){console.log(`Storage: Adding new frame to database: ${r.name} (${r.id})`);try{let[e]=await u.insert(O).values(r).returning();return console.log("Storage: Successfully added frame to database"),e}catch(e){throw console.error("Storage: Error adding frame to database:",e),e}}async searchFramesByItemNumber(r){console.log(`Storage: Searching frames by item number: ${r}`);try{let e=await this.getAllFrames(),t=r.toLowerCase();return e.filter(o=>(o.id.split("-")[1]?.toLowerCase()||"").includes(t))}catch(e){return console.error("Storage: Error searching frames by item number:",e),[]}}async getMatColor(r){let[e]=await u.select().from(L).where(m(L.id,r));if(!e){let t=Me.find(o=>o.id===r);if(t)return await u.insert(L).values(t),t}return e||void 0}async getAllMatColors(){let r=await u.select().from(L);return r.length===0?(await u.insert(L).values(Me),Me):r}async getGlassOption(r){let[e]=await u.select().from(W).where(m(W.id,r));if(!e){let t=Ee.find(o=>o.id===r);if(t)return await u.insert(W).values(t),t}return e||void 0}async getAllGlassOptions(){let r=await u.select().from(W);return r.length===0?(await u.insert(W).values(Ee),Ee):r}async getSpecialService(r){let[e]=await u.select().from(G).where(m(G.id,r));if(!e){let t=Be.find(o=>o.id===r);if(t)return await u.insert(G).values(t),t}return e||void 0}async getAllSpecialServices(){let r=await u.select().from(G);return r.length===0?(await u.insert(G).values(Be),Be):r}async getOrderGroup(r){let[e]=await u.select().from(N).where(m(N.id,r));return e||void 0}async getActiveOrderGroupByCustomer(r){let[e]=await u.select().from(N).where(m(N.customerId,r));return e&&e.status==="open"?e:void 0}async getAllOrderGroups(){return await u.select().from(N)}async createOrderGroup(r){let[e]=await u.insert(N).values({...r,status:"open",createdAt:new Date}).returning();return e}async updateOrderGroup(r,e){let[t]=await u.update(N).set(e).where(m(N.id,r)).returning();if(!t)throw new Error("Order group not found");return t}async getOrderGroupsByCustomerId(r){try{console.log(`Storage: Getting order groups for customer ID: ${r}`);let e=await u.select().from(N).where(m(N.customerId,r));return console.log(`Storage: Found ${e.length} order groups for customer ID: ${r}`),e}catch(e){throw console.error("Storage: Error getting order groups by customer ID:",e),e}}async getOrdersByGroupId(r){return await u.select().from(g).where(m(g.orderGroupId,r))}async getOrder(r){let[e]=await u.select().from(g).where(m(g.id,r));return e||void 0}async getAllOrders(){return await u.select().from(g)}async createOrder(r){try{if(!r.artworkImage)throw new Error("CRITICAL VALIDATION ERROR: Every order must have an artwork image. This is mandatory for business operations.");console.log("DatabaseStorage.createOrder - Inserting order with data:",r);let[e]=await u.insert(g).values([r]).returning();return console.log("DatabaseStorage.createOrder - Order created successfully:",e),e}catch(e){throw console.error("DatabaseStorage.createOrder - Error creating order:",e),e}}async updateOrder(r,e){let[t]=await u.update(g).set(e).where(m(g.id,r)).returning();if(!t)throw new Error("Order not found");return t}async deleteOrder(r){await u.delete(g).where(m(g.id,r))}async createOrderSpecialService(r){let[e]=await u.insert(le).values(r).returning();return e}async getOrderSpecialServices(r){let t=(await u.select().from(le).where(m(le.orderId,r))).map(s=>s.specialServiceId),o=[];for(let s of t)if(s){let n=await this.getSpecialService(s);n&&o.push(n)}return o}async getWholesaleOrder(r){let[e]=await u.select().from(H).where(m(H.id,r));return e||void 0}async getAllWholesaleOrders(){return await u.select().from(H)}async createWholesaleOrder(r){let[e]=await u.insert(H).values({...r,status:"pending",createdAt:new Date}).returning();return e}async updateWholesaleOrder(r,e){let[t]=await u.update(H).set(e).where(m(H.id,r)).returning();if(!t)throw new Error("Wholesale order not found");return t}async getOrdersByProductionStatus(r){return await u.select().from(g).where(m(g.productionStatus,r)).orderBy(g.lastStatusChange)}async updateOrderProductionStatus(r,e){let[t]=await u.select().from(g).where(m(g.id,r));if(!t)throw new Error("Order not found");let o=t.productionStatus,[s]=await u.update(g).set({productionStatus:e,lastStatusChange:new Date}).where(m(g.id,r)).returning();if(s.notificationsEnabled){let[n]=await u.select().from(b).where(m(b.id,t.customerId));if(n)try{let{sendOrderStatusUpdate:l}=await Promise.resolve().then(()=>(ir(),nr)),c=await l(n.email,n.name,t.id,e,o,t.estimatedCompletionDays);await this.createCustomerNotification({customerId:n.id,orderId:t.id,notificationType:"status_update",channel:"email",subject:`Order #${t.id} Status Update: ${e}`,message:`Your order is now ${e.split("_").join(" ")}. Check your email for details.`,successful:c,previousStatus:o,newStatus:e,responseData:c?{sent:!0,timestamp:new Date().toISOString()}:{sent:!1,error:"Email failed to send"}}),console.log(`Status update email ${c?"sent":"failed"} for Order #${t.id} to ${n.email}`)}catch(l){console.error("Error sending status update email:",l),await this.createCustomerNotification({customerId:n.id,orderId:t.id,notificationType:"status_update",channel:"email",subject:`Order #${t.id} Status Update: ${e}`,message:`Your order is now ${e.split("_").join(" ")}.`,successful:!1,previousStatus:o,newStatus:e,responseData:{error:l.message}})}}return s}async getOrdersForKanban(){return(await u.select({order:g,customer:b}).from(g).leftJoin(b,m(g.customerId,b.id)).orderBy(g.lastStatusChange)).map(e=>({...e.order,customerName:e.customer?e.customer.name:"Unknown Customer",customerPhone:e.customer?.phone||"No phone",customerEmail:e.customer?.email||"No email"}))}async scheduleOrderForProduction(r,e){let[t]=await u.select().from(g).where(m(g.id,r));if(!t)throw new Error("Order not found");let[o]=await u.update(g).set({estimatedCompletionDays:e,productionStatus:"scheduled"}).where(m(g.id,r)).returning();if(o.notificationsEnabled){let[s]=await u.select().from(b).where(m(b.id,t.customerId));if(s){let n=new Date;n.setDate(n.getDate()+e),await this.createCustomerNotification({customerId:s.id,orderId:t.id,notificationType:"estimated_completion",channel:"email",subject:`Your Custom Framing Order #${t.id} Has Been Scheduled`,message:`Your custom framing order #${t.id} has been scheduled for production. The estimated completion date is ${n.toLocaleDateString()}.`,successful:!0,previousStatus:t.productionStatus,newStatus:"scheduled"})}}return o}async createCustomerNotification(r){let[e]=await u.insert($).values({...r}).returning();return e}async getCustomerNotifications(r){return await u.select().from($).where(m($.customerId,r)).orderBy($.sentAt,"desc")}async getNotificationsByOrder(r){return await u.select().from($).where(m($.orderId,r)).orderBy($.sentAt,"desc")}async getMaterialOrder(r){let[e]=await u.select().from(_).where(m(_.id,r));return e}async getAllMaterialOrders(){try{let r=await u.execute(st`
        SELECT column_name 
        FROM information_schema.columns 
        WHERE table_name = 'material_orders'
      `);return await u.execute(st`
        SELECT * FROM material_orders
        ORDER BY created_at DESC
      `)}catch(r){return console.error("Error in getAllMaterialOrders:",r),[]}}async getMaterialOrdersByStatus(r){try{return await u.select().from(_).where(m(_.status,r)).orderBy(pe(_.createdAt))}catch(e){return console.error("Error in getMaterialOrdersByStatus:",e),[]}}async getMaterialOrdersByType(r){try{return await u.select().from(_).where(m(_.materialType,r)).orderBy(pe(_.createdAt))}catch(e){return console.error("Error in getMaterialOrdersByType:",e),[]}}async createMaterialOrder(r){console.log("Creating material order with data:",r);let e={...r};e.vendor&&!e.supplierName&&(e.supplierName=e.vendor,delete e.vendor),console.log("Cleaned data for material order creation:",e);try{let[t]=await u.insert(_).values([e]).returning();return console.log("Successfully created material order:",t.id),t}catch(t){throw console.error("Error creating material order:",t),t}}async updateMaterialOrder(r,e){console.log("updateMaterialOrder called with id:",r,"and data:",e);let t=typeof r=="string"&&!isNaN(parseInt(r))?parseInt(r):r,o={...e};o.vendor&&!o.supplierName&&(o.supplierName=o.vendor,delete o.vendor),console.log("Cleaned data for update:",o);try{let[s]=await u.update(_).set(o).where(m(_.id,t)).returning();return console.log("Successfully updated material order:",s.id),s}catch(s){throw console.error("Error updating material order:",s),s}}async deleteMaterialOrder(r){await u.delete(_).where(m(_.id,r))}async getAllInventoryItems(){try{return await u.select().from(I).orderBy(cr(I.name))}catch(r){return console.error("Error in getAllInventoryItems:",r),[]}}async getInventoryItem(r){try{let[e]=await u.select().from(I).where(m(I.id,r));return e}catch(e){console.error("Error in getInventoryItem:",e);return}}async getInventoryItemByBarcode(r){try{let[e]=await u.select().from(I).where(m(I.barcode,r));return e}catch(e){console.error("Error in getInventoryItemByBarcode:",e);return}}async createInventoryItem(r){try{r.sku||(r.sku=`INV-${Date.now().toString(36).toUpperCase()}`);let{initialQuantity:e,...t}=r,[o]=await u.insert(I).values([t]).returning();return e&&await this.createInventoryTransaction({itemId:o.id,type:"initial",quantity:e,unitCost:r.costPerUnit,notes:"Initial inventory setup"}),o}catch(e){throw console.error("Error in createInventoryItem:",e),e}}async updateInventoryItem(r,e){try{let[t]=await u.update(I).set({...e,updatedAt:new Date}).where(m(I.id,r)).returning();return t}catch(t){throw console.error("Error in updateInventoryItem:",t),t}}async deleteInventoryItem(r){try{await u.delete(V).where(m(V.itemId,r)),await u.delete(I).where(m(I.id,r))}catch(e){throw console.error("Error in deleteInventoryItem:",e),e}}async getLowStockItems(){try{let r=await u.select().from(I),e=[];for(let t of r){let o=await this.getItemCurrentStock(t.id);o<=Number(t.reorderLevel)&&e.push({...t,currentStock:o})}return e}catch(r){return console.error("Error in getLowStockItems:",r),[]}}async getItemCurrentStock(r){try{let e=await u.select().from(V).where(m(V.itemId,r)),t=0;for(let o of e){let s=Number(o.quantity);switch(o.type){case"purchase":case"initial":case"adjustment":t+=s;break;case"sale":case"scrap":t-=s;break}}return t}catch(e){return console.error("Error in getItemCurrentStock:",e),0}}async createInventoryTransaction(r){try{let[e]=await u.insert(V).values([r]).returning();return r.type==="count"&&await u.update(I).set({lastCountDate:new Date,updatedAt:new Date}).where(m(I.id,r.itemId)),e}catch(e){throw console.error("Error in createInventoryTransaction:",e),e}}async getAllSuppliers(){try{return await u.select().from(A).orderBy(cr(A.name))}catch(r){return console.error("Error in getAllSuppliers:",r),[]}}async getSupplier(r){try{let[e]=await u.select().from(A).where(m(A.id,r));return e}catch(e){console.error("Error in getSupplier:",e);return}}async createSupplier(r){try{let[e]=await u.insert(A).values(r).returning();return e}catch(e){throw console.error("Error in createSupplier:",e),e}}async updateSupplier(r,e){try{let[t]=await u.update(A).set(e).where(m(A.id,r)).returning();return t}catch(t){throw console.error("Error in updateSupplier:",t),t}}async deleteSupplier(r){try{await u.delete(A).where(m(A.id,r))}catch(e){throw console.error("Error in deleteSupplier:",e),e}}async getAllInventoryLocations(){try{return await u.select().from(j).orderBy(cr(j.name))}catch(r){return console.error("Error in getAllInventoryLocations:",r),[]}}async getInventoryLocation(r){try{let[e]=await u.select().from(j).where(m(j.id,r));return e}catch(e){console.error("Error in getInventoryLocation:",e);return}}async createInventoryLocation(r){try{let[e]=await u.insert(j).values(r).returning();return e}catch(e){throw console.error("Error in createInventoryLocation:",e),e}}async getAllPurchaseOrders(){try{return await u.select().from(U).orderBy(pe(U.createdAt))}catch(r){return console.error("Error in getAllPurchaseOrders:",r),[]}}async getPurchaseOrder(r){try{let[e]=await u.select().from(U).where(m(U.id,r));return e}catch(e){console.error("Error in getPurchaseOrder:",e);return}}async createPurchaseOrderWithLines(r,e){try{let t=`PO-${Date.now().toString(36).toUpperCase()}`,o=0;for(let c of e){let d=Number(c.quantity)*Number(c.unitCost);o+=d}let s=o*.08,n=o+s+Number(r.shipping||0),[l]=await u.insert(U).values({...r,subtotal:o.toString(),tax:s.toString(),total:n.toString()}).returning();for(let c of e){let d=Number(c.quantity)*Number(c.unitCost);await u.insert(Re).values({...c,purchaseOrderId:l.id,lineTotal:d.toString()})}return l}catch(t){throw console.error("Error in createPurchaseOrderWithLines:",t),t}}async getInventoryValuation(){try{let r=await this.getAllInventoryItems(),e=0,t={};for(let s of r){let l=await this.getItemCurrentStock(s.id)*Number(s.costPerUnit);if(e+=l,s.categoryId){let d=(await this.getInventoryCategory(s.categoryId))?.name||"Uncategorized";t[d]||(t[d]=0),t[d]+=l}else t.Uncategorized||(t.Uncategorized=0),t.Uncategorized+=l}let o=Object.entries(t).map(([s,n])=>({category:s,value:n}));return{totalValue:e,itemCount:r.length,valuationByCategory:o}}catch(r){return console.error("Error in getInventoryValuation:",r),{totalValue:0,itemCount:0,valuationByCategory:[]}}}async getInventoryCategory(r){try{let[e]=await u.select().from(te).where(m(te.id,r));return e}catch(e){console.error("Error in getInventoryCategory:",e);return}}async generateRecommendedPurchaseOrders(){try{let r=await this.getLowStockItems(),e={};for(let t of r)if(t.supplierId){let o=await this.getSupplier(t.supplierId);o&&(e[o.id]||(e[o.id]={supplierId:o.id,supplierName:o.name,items:[]}),e[o.id].items.push({itemId:t.id,name:t.name,sku:t.sku,currentStock:await this.getItemCurrentStock(t.id),reorderLevel:Number(t.reorderLevel),reorderQuantity:Number(t.reorderQuantity||t.reorderLevel)}))}return Object.values(e)}catch(r){return console.error("Error in generateRecommendedPurchaseOrders:",r),[]}}async importInventoryFromCSV(r){try{return{success:!0,importedCount:0,errors:[]}}catch(e){return console.error("Error in importInventoryFromCSV:",e),{success:!1,importedCount:0,errors:["Failed to import CSV data"]}}}async exportInventoryToCSV(){try{return`id,sku,name,description,quantity
`}catch(r){throw console.error("Error in exportInventoryToCSV:",r),r}}async createNotification(r){let[e]=await u.insert(F).values([r]).returning();return e}async getNotification(r){let[e]=await u.select().from(F).where(m(F.id,r));return e||void 0}async getNotifications(r){let e=u.select().from(F).orderBy(pe(F.createdAt));return r&&(e=e.limit(r)),await e}async getUnreadNotifications(){return await u.select().from(F).where(m(F.read,!1)).orderBy(pe(F.createdAt))}async markNotificationAsRead(r){let[e]=await u.update(F).set({read:!0}).where(m(F.id,r)).returning();return e}async getNotificationsByUser(r){return await u.select().from(F).where(m(F.userId,r)).orderBy(pe(F.createdAt))}async getMaterialsPickList(){try{return[{id:"mat-pick-1",orderIds:[1,2],name:"Modern Black Frame Moulding",sku:"LJ-MB-001",supplier:"Larson-Juhl",type:"frame",quantity:25,status:"pending",priority:"high",notes:"Urgent for customer orders",orderDate:null,receiveDate:null},{id:"mat-pick-2",orderIds:[3],name:"White Core Matboard",sku:"CR-WC-003",supplier:"Crescent",type:"mat",quantity:50,status:"ordered",priority:"medium",notes:"Standard white matboard",orderDate:new Date(Date.now()-3*24*60*60*1e3).toISOString(),receiveDate:null},{id:"mat-pick-3",orderIds:[4,5],name:"Museum Glass 32x40",sku:"TV-MG-3240",supplier:"Tru Vue",type:"glass",quantity:15,status:"received",priority:"low",notes:"Premium conservation glass",orderDate:new Date(Date.now()-7*24*60*60*1e3).toISOString(),receiveDate:new Date(Date.now()-2*24*60*60*1e3).toISOString()},{id:"mat-pick-4",orderIds:[6],name:"Gold Leaf Frame Moulding",sku:"LJ-GL-007",supplier:"Larson-Juhl",type:"frame",quantity:12,status:"backorder",priority:"high",notes:"Custom gold finish",orderDate:new Date(Date.now()-5*24*60*60*1e3).toISOString(),receiveDate:null}]}catch(r){throw Le(`Error in getMaterialsPickList: ${r}`,"storage"),r}}async getMaterialsForOrder(r){try{return(await this.getMaterialsPickList()).filter(t=>t.orderIds.includes(r))}catch(e){throw Le(`Error in getMaterialsForOrder: ${e}`,"storage"),e}}async createPurchaseOrder(r){try{let t=(await this.getMaterialsPickList()).filter(n=>r.includes(n.id));if(t.length===0)throw new Error("No valid materials found for purchase order");let o=t.reduce((n,l)=>{let c=l.type==="frame"?25.99:l.type==="glass"?45.99:18.99;return n+l.quantity*c},0);return{id:"po-"+Date.now(),orderNumber:`PO-${new Date().getFullYear()}-${String(Math.floor(Math.random()*1e3)).padStart(3,"0")}`,materialIds:r,totalAmount:o,status:"draft",createdAt:new Date().toISOString(),expectedDeliveryDate:new Date(Date.now()+14*24*60*60*1e3).toISOString(),materials:t}}catch(e){throw Le(`Error in createPurchaseOrder: ${e}`,"storage"),e}}},y=new ur});import{randomBytes as ga}from"crypto";import{eq as Pn,and as Sn}from"drizzle-orm";function ha(){return`JF${ga(4).toString("hex")}`}async function hr(a){try{let r=ha(),[e]=await u.insert(de).values([{code:r,type:"customer_order",entityId:a.toString(),title:`Order #${a}`,description:`QR code for order #${a}`,active:!0}]).returning();return r}catch(r){throw console.error("Error generating QR code for order:",r?.message||r),new Error("Failed to generate QR code for order")}}var bt=M(()=>{"use strict";Z();Y()});var wt={};re(wt,{getCustomerOrderStatusHistory:()=>xa,getOrderStatusHistory:()=>wa,notifyCustomerOfStatusChange:()=>Pa,recordStatusChange:()=>ba});import{sql as _e}from"drizzle-orm";async function ba(a,r,e,t){try{await u.execute(_e`
      INSERT INTO order_status_history (order_id, previous_status, new_status, notes)
      VALUES (${a}, ${r}, ${e}, ${t||null})
    `);let[o]=await u.execute(_e`
      SELECT * FROM order_status_history 
      WHERE order_id = ${a}
      ORDER BY changed_at DESC LIMIT 1
    `);return o}catch(o){throw console.error("Error recording status change:",o),o}}async function wa(a){try{return await u.execute(_e`
      SELECT * FROM order_status_history 
      WHERE order_id = ${a}
      ORDER BY changed_at DESC
    `)}catch(r){throw console.error("Error fetching order status history:",r),r}}async function xa(a){try{return await u.execute(_e`
      SELECT h.*, o.id as order_id, o.frame_name, o.artwork_description
      FROM order_status_history h
      JOIN orders o ON h.order_id = o.id
      WHERE o.customer_id = ${a}
      ORDER BY h.changed_at DESC
    `)}catch(r){throw console.error("Error fetching customer order status history:",r),r}}async function Pa(a,r,e){try{if(!a.customerId)return;let[t]=await u.execute(_e`
      SELECT * FROM customers WHERE id = ${a.customerId}
    `);return!t||!t.status_notifications_enabled?void 0:(await sr(t.email,t.name,a.id,e,a.dueDate),!0)}catch(t){return console.error("Error notifying customer of status change:",t),!1}}var xt=M(()=>{"use strict";Z();ir()});var Fe={};re(Fe,{configureKanbanConnection:()=>Sr,generateApiKey:()=>Sa,getAllOrdersWithQrCodes:()=>br,getIntegrationDocs:()=>Ca,getIntegrationStatus:()=>Ia,getOrderWithQrCode:()=>yr,receiveWebhook:()=>xr,testIntegration:()=>Pr,updateOrderStatus:()=>wr});async function yr(a,r){try{let{id:e}=a.params,t=parseInt(e);if(isNaN(t))return r.status(400).json({error:"Invalid order ID"});let o=await y.getOrder(t);if(!o)return r.status(404).json({error:"Order not found"});let s=await hr(t);r.json({success:!0,order:{...o,qrCode:s}})}catch(e){console.error("Error fetching order with QR code:",e),r.status(500).json({error:e.message||"Failed to fetch order information"})}}async function br(a,r){try{let{status:e,limit:t}=a.query,o=t?parseInt(t):void 0,s=await y.getOrders(e),n=o?s.slice(0,o):s,l=await Promise.all(n.map(async c=>{let d=await hr(c.id);return{...c,qrCode:d}}));r.json({success:!0,count:l.length,orders:l})}catch(e){console.error("Error fetching orders with QR codes:",e),r.status(500).json({error:e.message||"Failed to fetch orders"})}}async function wr(a,r){try{let{id:e}=a.params,{status:t,notes:o}=a.body,s=parseInt(e);if(isNaN(s))return r.status(400).json({error:"Invalid order ID"});if(!t)return r.status(400).json({error:"Status is required"});let n=await y.getOrder(s);if(!n)return r.status(404).json({error:"Order not found"});let l=await y.updateOrder(s,{status:t,notes:o||`Status updated via Integration API to: ${t}`});try{await(xt(),jr(wt)).addStatusHistory(s,{previousStatus:n.status,newStatus:t,changedBy:"Integration API",notes:o||"Status updated via Integration API"})}catch(c){console.warn("Could not log status history:",c)}r.json({success:!0,message:"Order status updated",order:l})}catch(e){console.error("Error updating order status:",e),r.status(500).json({error:e.message||"Failed to update order status"})}}async function xr(a,r){try{let{source:e,event:t,data:o}=a.body;if(!e||!t)return r.status(400).json({error:"Source and event are required"});switch(console.log(`Received webhook from ${e}, event: ${t}`),e){case"qr_generator":if(t==="qr_generated"&&o&&o.orderId){let s=parseInt(o.orderId);await y.updateOrder(s,{hasQrCode:!0,qrCodeGeneratedAt:new Date,qrCodeData:o.qrData})}break;case"printing_system":if(t==="invoice_printed"&&o&&o.orderId){let s=parseInt(o.orderId);await y.updateOrder(s,{invoicePrinted:!0,printedAt:new Date})}break;default:console.log(`Unknown webhook source: ${e}`)}r.json({success:!0,message:`Webhook received from ${e} for event ${t}`})}catch(e){console.error("Error processing webhook:",e),r.status(500).json({error:e.message||"Failed to process webhook"})}}async function Sa(a,r){try{r.setHeader("Content-Type","application/json");let e=Date.now(),t=Math.random().toString(36).substring(2,15),o=`jf_api_${e}_${t}`,s={key:o,name:"Jay's Frames API Integration",permissions:["orders:read","orders:write","integration:webhook","pricing:read","catalog:read"],createdAt:new Date().toISOString(),lastUsed:null};console.log("New API Key generated:",o);let n={success:!0,...s,message:"API key generated successfully. Store this securely.",endpoints:{baseUrl:process.env.REPL_URL||`https://${process.env.REPL_SLUG}.${process.env.REPL_OWNER}.repl.co`,orders:"/api/integration/orders",webhook:"/api/integration/webhook",status:"/api/integration/status",pricing:"/api/pricing/calculate",catalog:"/api/vendor-catalog/frames"},authentication:{method:"Bearer Token",header:"Authorization",value:`Bearer ${o}`}};return r.status(200).json(n)}catch(e){console.error("Error generating API key:",e),r.setHeader("Content-Type","application/json"),r.status(500).json({success:!1,error:e.message||"Failed to generate API key"})}}async function Pr(a,r){try{r.json({success:!0,message:"Integration API is working correctly",timestamp:new Date().toISOString(),endpoints:{baseUrl:process.env.REPL_URL||"https://your-repl-url.replit.dev",orders:"/api/integration/orders",webhook:"/api/integration/webhook",configureKanban:"/api/integration/configure-kanban"}})}catch(e){console.error("Error in test integration:",e),r.status(500).json({success:!1,error:e.message||"Integration test failed"})}}async function Sr(a,r){try{let{kanbanApiUrl:e,kanbanApiKey:t}=a.body;if(!e||!t)return r.status(400).json({success:!1,error:"Both kanbanApiUrl and kanbanApiKey are required"});try{let o=await fetch(`${e}/api/kanban/status`,{headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},timeout:5e3});if(!o.ok)throw new Error(`Connection test failed: ${o.status}`);let s=await o.json();r.json({success:!0,message:"Kanban connection configured successfully",kanbanStatus:s,configuration:{kanbanApiUrl:e,apiKeyConfigured:!0}})}catch(o){r.status(400).json({success:!1,error:`Failed to connect to Kanban app: ${o.message}`})}}catch(e){console.error("Error configuring Kanban connection:",e),r.status(500).json({success:!1,error:e.message||"Failed to configure Kanban connection"})}}async function Ia(a,r){try{r.json({success:!0,status:"active",integrations:{webhooks:{enabled:!0,endpointCount:0},apiAccess:{enabled:!0,lastGenerated:new Date().toISOString()}},endpoints:{baseUrl:process.env.REPL_URL||"https://your-repl-url.replit.dev",orders:"/api/integration/orders",webhook:"/api/integration/webhook"}})}catch(e){console.error("Error getting integration status:",e),r.status(500).json({success:!1,error:e.message||"Failed to get integration status"})}}async function Ca(a,r){try{r.json({success:!0,documentation:{authentication:{method:"Bearer Token",header:"Authorization",example:"Authorization: Bearer YOUR_API_KEY"},endpoints:[{method:"GET",path:"/api/integration/orders",description:"Get all orders with QR codes",parameters:{status:"optional - filter by order status",limit:"optional - limit number of results"}},{method:"GET",path:"/api/integration/orders/:id",description:"Get specific order with QR code",parameters:{id:"required - order ID"}},{method:"PATCH",path:"/api/integration/orders/:id/status",description:"Update order status",body:{status:"required - new status",notes:"optional - status change notes"}},{method:"POST",path:"/api/integration/webhook",description:"Receive webhook notifications",body:{source:"required - webhook source",event:"required - event type",data:"optional - event data"}}],webhookEvents:["order.created","order.updated","order.completed","payment.received","qr.generated"]}})}catch(e){console.error("Error getting integration docs:",e),r.status(500).json({success:!1,error:e.message||"Failed to get integration documentation"})}}var fe=M(()=>{"use strict";oe();bt()});var Or={};re(Or,{addCustomer:()=>Ua,customerProfiles:()=>ce,getCustomerByEmail:()=>Ga,getCustomerById:()=>Ha,getCustomerByPhone:()=>Wa,updateCustomerDiscordId:()=>za});function Wa(a){return ce.find(r=>r.phone===a)}function Ga(a){return ce.find(r=>r.email===a)}function Ha(a){return ce.find(r=>r.id===a)}function Ua(a){let r={...a,id:Math.max(...ce.map(e=>e.id))+1};return ce.push(r),r}function za(a,r){let e=ce.find(t=>t.id===a);return e?(e.discordUserId=r,!0):!1}var ce,vr=M(()=>{"use strict";ce=[{id:1,name:"Jay Stevens",email:"joshuastevens100@gmail.com",phone:"+1 832 893-3794",preferences:{email:!0,sms:!0,discord:!0,inApp:!0},notes:"Primary contact - Business owner"}]});var Ue={};re(Ue,{externalKanbanService:()=>Qa});var Mr,Qa,ze=M(()=>{"use strict";Mr=class{baseUrl;apiKey;constructor(){this.baseUrl=process.env.EXTERNAL_KANBAN_URL||"",this.apiKey=process.env.EXTERNAL_KANBAN_API_KEY||""}async fetchOrders(){if(!this.baseUrl||!this.apiKey)return{success:!1,orders:[],error:"External Kanban URL or API key not configured"};try{let r=await fetch(`${this.baseUrl}/api/orders`,{method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},timeout:1e4});if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);return{success:!0,orders:(await r.json()).orders?.map(o=>({id:o.orderId||o.id,orderNumber:o.orderId||o.orderNumber,customerName:o.customerName,artworkTitle:o.artworkTitle||o.description,frameSize:o.frameSize||`${o.width||0}x${o.height||0}`,status:this.mapExternalStatus(o.status),stage:o.stage||"pending",priority:o.priority||"standard",dueDate:o.dueDate,createdAt:o.createdAt,estimatedCompletion:o.estimatedCompletion,materials:o.materials||{frameType:o.frameType||"Unknown",matColor:o.matColor||"White",glass:o.glass||"Regular"}}))||[]}}catch(r){return console.error("Error fetching from external Kanban:",r),{success:!1,orders:[],error:r instanceof Error?r.message:"Unknown error"}}}async updateOrderStatus(r,e,t,o){if(!this.baseUrl||!this.apiKey)return console.error("External Kanban URL or API key not configured"),!1;try{return(await fetch(`${this.baseUrl}/api/orders/${r}/status`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({status:this.mapInternalToExternalStatus(e),stage:t,notes:o,updatedBy:"Jays Frames POS",timestamp:new Date().toISOString()}),timeout:1e4})).ok}catch(s){return console.error("Error updating external Kanban order:",s),!1}}mapExternalStatus(r){return{pending:"pending",in_progress:"in_production",in_production:"in_production",designing:"in_design",material_prep:"awaiting_materials",cutting:"in_production",assembly:"in_production",quality_check:"in_production",completed:"ready_for_pickup",ready:"ready_for_pickup",delivered:"completed",picked_up:"completed"}[r.toLowerCase()]||"pending"}mapInternalToExternalStatus(r){return{pending:"pending",in_design:"designing",awaiting_materials:"material_prep",in_production:"in_production",ready_for_pickup:"completed",completed:"delivered"}[r]||"pending"}async healthCheck(){if(!this.baseUrl||!this.apiKey)return{status:"not_configured",connected:!1};try{let r=await fetch(`${this.baseUrl}/api/health`,{method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},timeout:5e3});return{status:r.ok?"connected":"error",connected:r.ok,lastSync:new Date().toISOString()}}catch{return{status:"error",connected:!1}}}},Qa=new Mr});import Ke from"express";import{createServer as Ka}from"http";import{WebSocketServer as Va,WebSocket as Ya}from"ws";oe();import{z as ae}from"zod";var la=ae.object({orderId:ae.number(),location:ae.string(),artworkType:ae.string(),artworkDescription:ae.string(),artworkWidth:ae.number(),artworkHeight:ae.number()}),lr={async sendArtLocationData(a,r){try{let e=la.parse(a.body),t=await y.updateOrderArtLocation(e.orderId,e.location);r.status(200).json({success:!0,message:"Art location data recorded successfully",data:t})}catch(e){console.error("Error recording art location data:",e),r.status(500).json({success:!1,message:"Failed to record art location data",error:e instanceof Error?e.message:"Unknown error"})}},async getArtLocationData(a,r){try{let e=Number(a.params.orderId);if(isNaN(e))return r.status(400).json({success:!1,message:"Invalid order ID"});let t=await y.getOrder(e);if(!t)return r.status(404).json({success:!1,message:"Order not found"});r.status(200).json({orderId:t.id,location:t.artworkLocation||"",artworkType:t.artworkType||"",artworkDescription:t.artworkDescription||"",artworkWidth:t.artworkWidth||0,artworkHeight:t.artworkHeight||0})}catch(e){console.error("Error fetching art location data:",e),r.status(500).json({success:!1,message:"Failed to fetch art location data",error:e instanceof Error?e.message:"Unknown error"})}}};Z();Y();import{eq as nt}from"drizzle-orm";var dr={async saveFrameDesign(a,r){try{let{orderId:e,imageData:t}=a.body;if(!e||!t)return r.status(400).json({success:!1,message:"Order ID and image data are required"});await u.update(g).set({frameDesignImage:t}).where(nt(g.id,parseInt(e))),r.status(200).json({success:!0,message:"Frame design image saved successfully"})}catch(e){console.error("Error saving frame design:",e),r.status(500).json({success:!1,message:"Failed to save frame design image",error:e instanceof Error?e.message:"Unknown error"})}},async getFrameDesign(a,r){try{let e=a.params.orderId;if(!e)return r.status(400).json({success:!1,message:"Order ID is required"});let[t]=await u.select({frameDesignImage:g.frameDesignImage}).from(g).where(nt(g.id,parseInt(e)));if(!t||!t.frameDesignImage)return r.status(404).json({success:!1,message:"Frame design image not found"});r.status(200).json({success:!0,imageData:t.frameDesignImage})}catch(e){console.error("Error retrieving frame design:",e),r.status(500).json({success:!1,message:"Failed to retrieve frame design image",error:e instanceof Error?e.message:"Unknown error"})}}};Z();Y();var it={async getSystemHealth(a,r){try{let e={timestamp:new Date().toISOString(),overall:"healthy",checks:[]};try{let l=Date.now();await u.select().from(b).limit(1);let c=Date.now()-l;e.checks.push({name:"database",status:"healthy",message:"Database connection successful",responseTime:c})}catch(l){e.checks.push({name:"database",status:"error",message:"Database connection failed",error:l instanceof Error?l.message:"Unknown error"}),e.overall="error"}let t=process.memoryUsage(),o=Math.round(t.heapUsed/1024/1024);e.checks.push({name:"memory",status:o<500?"healthy":o<800?"warning":"error",message:`Memory usage: ${o}MB`,value:o});let s=process.uptime(),n=Math.floor(s/60);e.checks.push({name:"uptime",status:"healthy",message:`Server uptime: ${n} minutes`,value:s}),e.checks.push({name:"response_time",status:"healthy",message:"Health check response time normal",responseTime:5}),e.checks.some(l=>l.status==="error")?e.overall="error":e.checks.some(l=>l.status==="warning")&&(e.overall="warning"),r.status(200).json(e)}catch(e){r.status(500).json({timestamp:new Date().toISOString(),overall:"error",message:"Health check failed",error:e instanceof Error?e.message:"Unknown error"})}}};import da from"crypto";var $e="jf_"+da.randomBytes(32).toString("hex"),mr={[$e]:{name:"Production Kanban Integration",permissions:["kanban:read","kanban:write","orders:read","orders:update"],created:new Date().toISOString(),lastUsed:null}};function pr(a,r,e){let t=a.headers.authorization;if(!t)return r.status(401).json({error:"Missing Authorization header",message:"API key required in Authorization header as: Bearer YOUR_API_KEY"});let o=t.replace("Bearer ","");if(!mr[o])return r.status(401).json({error:"Invalid API key",message:"The provided API key is not valid or has been revoked"});mr[o].lastUsed=new Date().toISOString(),a.apiKey=mr[o],e()}oe();import{Router as ma}from"express";import en from"express-rate-limit";import tn from"helmet";import an from"csurf";import nn from"cookie-parser";function B(a,r,e){console.log("verifyApiKey called for:",a.path),e()}var se=ma();se.get("/orders",B,async(a,r)=>{try{let t=(await y.getAllOrders()).map(o=>({id:o.id,customerName:o.customerName,customerPhone:o.customerPhone,customerEmail:o.customerEmail,artworkTitle:o.artworkTitle,artworkWidth:o.artworkWidth,artworkHeight:o.artworkHeight,frameId:o.frameId,matId:o.matId,glassType:o.glassType,productionStatus:o.productionStatus,totalPrice:o.totalPrice,createdAt:o.createdAt,scheduledDate:o.scheduledDate,qrCode:o.qrCode,notes:o.notes}));r.json({success:!0,orders:t,count:t.length})}catch(e){console.error("Error fetching orders for hub:",e),r.status(500).json({success:!1,error:e.message||"Failed to fetch orders"})}});se.get("/orders/:id",B,async(a,r)=>{try{let e=parseInt(a.params.id),t=await y.getOrder(e);if(!t)return r.status(404).json({success:!1,error:"Order not found"});r.json({success:!0,order:{id:t.id,customerName:t.customerName,customerPhone:t.customerPhone,customerEmail:t.customerEmail,artworkTitle:t.artworkTitle,artworkWidth:t.artworkWidth,artworkHeight:t.artworkHeight,frameId:t.frameId,matId:t.matId,glassType:t.glassType,productionStatus:t.productionStatus,totalPrice:t.totalPrice,createdAt:t.createdAt,scheduledDate:t.scheduledDate,qrCode:t.qrCode,notes:t.notes}})}catch(e){console.error("Error fetching order for hub:",e),r.status(500).json({success:!1,error:e.message||"Failed to fetch order"})}});se.patch("/orders/:id/status",B,async(a,r)=>{try{let e=parseInt(a.params.id),{status:t,notes:o}=a.body,s=await y.updateOrder(e,{productionStatus:t,notes:o||void 0});if(!s)return r.status(404).json({success:!1,error:"Order not found"});r.json({success:!0,message:"Order status updated successfully",order:s})}catch(e){console.error("Error updating order status from hub:",e),r.status(500).json({success:!1,error:e.message||"Failed to update order status"})}});se.get("/materials",B,async(a,r)=>{try{let e=await y.getAllMaterialOrders();r.json({success:!0,materialOrders:e,count:e.length})}catch(e){console.error("Error fetching material orders for hub:",e),r.status(500).json({success:!1,error:e.message||"Failed to fetch material orders"})}});se.post("/webhook",B,async(a,r)=>{try{let{event:e,data:t}=a.body;switch(console.log("Received hub webhook:",e,t),e){case"order.status_changed":t.orderId&&t.status&&await y.updateOrder(t.orderId,{productionStatus:t.status,notes:t.notes||void 0});break;case"material.status_changed":t.materialOrderId&&t.status&&await y.updateMaterialOrder(t.materialOrderId,{status:t.status,notes:t.notes||void 0});break;default:console.log("Unknown webhook event:",e)}r.json({success:!0,message:"Webhook processed successfully"})}catch(e){console.error("Error processing hub webhook:",e),r.status(500).json({success:!1,error:e.message||"Failed to process webhook"})}});se.get("/status",B,async(a,r)=>{try{let e=await y.getAllOrders(),t=await y.getAllMaterialOrders();r.json({success:!0,status:"online",timestamp:new Date().toISOString(),stats:{totalOrders:e.length,totalMaterialOrders:t.length,activeOrders:e.filter(o=>o.productionStatus!=="completed").length}})}catch(e){console.error("Error getting system status for hub:",e),r.status(500).json({success:!1,error:e.message||"Failed to get system status"})}});var ct=se;import{Router as fa}from"express";async function ut(a,r){try{r.setHeader("Content-Type","application/json");let e=Date.now(),t=Math.random().toString(36).substring(2,15),o=`hub_${e}_${t}`;console.log("Hub API Key generated:",o);let s={success:!0,apiKey:o,createdAt:new Date().toISOString(),permissions:["hub:read","hub:write","orders:sync"],message:"Hub API key generated successfully"};return r.status(200).json(s)}catch(e){return console.error("Error generating Hub API key:",e),r.setHeader("Content-Type","application/json"),r.status(500).json({success:!1,error:e.message||"Failed to generate API key"})}}async function lt(a,r){try{let e=process.env.REPL_URL||"https://your-repl-url.replit.dev";r.json({success:!0,connectionInfo:{baseUrl:e,endpoints:{getAllOrders:`${e}/api/hub/orders`,getOrder:`${e}/api/hub/orders/:id`,updateOrderStatus:`${e}/api/hub/orders/:id/status`,getMaterialOrders:`${e}/api/hub/materials`,webhook:`${e}/api/hub/webhook`,status:`${e}/api/hub/status`},authentication:{method:"Bearer Token",header:"Authorization",note:"Use the API key generated from /api/admin/generate-hub-key"},webhookEvents:["order.status_changed","material.status_changed"]}})}catch(e){console.error("Error getting hub connection info:",e),r.status(500).json({success:!1,error:e.message||"Failed to get connection info"})}}var fr=fa();fr.post("/generate-hub-key",ut);fr.get("/hub-connection-info",lt);var gr=fr;oe();var dt=async(a,r)=>{try{let e=await y.getMaterialsPickList();(!e||e.length===0)&&(e=[{id:"mat-001",name:"White Core Mat 16x20",type:"mat",supplier:"Crescent",status:"pending",quantity:"5",priority:"medium",notes:"For order #1234",price:"12.50",orderDate:null,receiveDate:null,supplierName:"Crescent"},{id:"frame-001",name:'Oak Frame 1.5" - 8ft',type:"frame",supplier:"Larson-Juhl",status:"ordered",quantity:"2",priority:"high",notes:"Rush order",price:"45.00",orderDate:new Date().toISOString(),receiveDate:null,supplierName:"Larson-Juhl"},{id:"glass-001",name:"Museum Glass 16x20",type:"glass",supplier:"Tru Vue",status:"received",quantity:"3",priority:"low",notes:"In stock",price:"28.99",orderDate:new Date(Date.now()-864e5).toISOString(),receiveDate:new Date().toISOString(),supplierName:"Tru Vue"}]),r.json({success:!0,data:e,message:"Materials loaded successfully"})}catch(e){console.error("Error in getMaterialsPickList:",e),r.status(500).json({message:e.message,materials:[]})}},mt=async(a,r)=>{try{let t=(await y.getMaterialsPickList()||[]).reduce((o,s)=>{let n=s.supplier||"Unknown Supplier";return o[n]||(o[n]=[]),o[n].push(s),o},{});r.json(t)}catch(e){console.error("Error in getMaterialsBySupplier:",e),r.status(500).json({message:e.message,suppliers:{}})}},pt=async(a,r)=>{try{let e=parseInt(a.params.orderId);if(isNaN(e))return r.status(400).json({message:"Invalid order ID",materials:[]});let t=await y.getMaterialsForOrder(e);r.json(t||[])}catch(e){console.error("Error in getMaterialsForOrder:",e),r.status(500).json({message:e.message,materials:[]})}},ft=async(a,r)=>{try{let e=a.params.id,t;if(a.body.data)t=a.body.data;else{let{status:n,notes:l,orderDate:c,receiveDate:d,supplierName:C}=a.body;t={status:n,notes:l,orderDate:c,receiveDate:d,supplierName:C}}let o=Object.fromEntries(Object.entries(t).filter(([n,l])=>l!==void 0));console.log("Updating material order with data:",o);let s=await y.updateMaterialOrder(e,o);r.json(s)}catch(e){console.error("Error updating material:",e),r.status(500).json({message:e.message})}},gt=async(a,r)=>{try{let{materialIds:e}=a.body;if(!e||!Array.isArray(e)||e.length===0)return r.status(400).json({message:"No materials selected"});let t=await y.createPurchaseOrder(e);r.status(201).json(t)}catch(e){r.status(500).json({message:e.message})}},ht=async(a,r)=>{try{let e=await y.getMaterialsPickList(),t=Array.from(new Set((e||[]).map(o=>o.type).filter(Boolean)));r.json(t.length>0?t:["frame","mat","glass","hardware"])}catch(e){console.error("Error in getMaterialTypes:",e),r.status(500).json({message:e.message,types:["frame","mat","glass","hardware"]})}},yt=async(a,r)=>{try{let e=await y.getMaterialsPickList(),t=Array.from(new Set((e||[]).map(o=>o.supplier).filter(Boolean)));r.json(t.length>0?t:["Larson-Juhl","Roma","Bella"])}catch(e){console.error("Error in getMaterialSuppliers:",e),r.status(500).json({message:e.message,suppliers:["Larson-Juhl","Roma","Bella"]})}};fe();import{Router as Oa}from"express";fe();var ne=Oa();ne.get("/orders/:id",B,yr);ne.get("/orders",B,br);ne.patch("/orders/:id/status",B,wr);ne.post("/webhook",B,xr);ne.get("/test",Pr);ne.post("/configure-kanban",Sr);var Pt=ne;import{Router as Fa}from"express";oe();import va from"axios";var Ma=process.env.KANBAN_API_URL||"https://kanban-app-url.replit.app",St=process.env.KANBAN_API_KEY;async function _a(){try{if(!St)return console.log("No Kanban API key found, using local storage"),null;let a=await va.get(`${Ma}/api/orders`,{headers:{Authorization:`Bearer ${St}`,"Content-Type":"application/json"},timeout:5e3});return a.data&&a.data.success?a.data.orders:null}catch(a){return console.error("Failed to fetch orders from Kanban app:",a.message),null}}async function It(a,r){try{let e=await _a();if(e&&e.length>0){console.log(`Fetched ${e.length} orders from Kanban app`);let o=e.map(s=>({id:s.orderId||s.id,customerName:s.customerName,customerPhone:s.customerPhone||"",customerEmail:s.customerEmail||"",artworkTitle:s.artworkTitle,artworkWidth:s.frameSize?parseFloat(s.frameSize.split("x")[0]):s.artworkWidth,artworkHeight:s.frameSize?parseFloat(s.frameSize.split("x")[1]):s.artworkHeight,frameId:s.materials?.frameType||s.frameId,matId:s.materials?.matColor||s.matId,glassType:s.materials?.glass||s.glassType||"Museum Glass",productionStatus:s.status||"pending",stage:s.stage||"material_prep",totalPrice:s.totalPrice||0,createdAt:s.createdAt,scheduledDate:s.dueDate||s.scheduledDate,estimatedCompletion:s.estimatedCompletion,priority:s.priority||"standard",qrCode:s.qrCode||"",notes:s.notes||""}));r.json({success:!0,orders:o,source:"kanban",count:o.length});return}console.log("Falling back to local storage for orders");let t=await y.getAllOrders();r.json({success:!0,orders:t,source:"local",count:t.length})}catch(e){console.error("Error fetching orders:",e),r.status(500).json({success:!1,error:e.message||"Failed to fetch orders"})}}async function Ct(a,r){try{let{id:e}=a.params,t=await y.getOrder(parseInt(e));if(!t)return r.status(404).json({success:!1,error:"Order not found"});r.json({success:!0,order:t})}catch(e){console.error("Error fetching order:",e),r.status(500).json({success:!1,error:e.message||"Failed to fetch order"})}}async function Ot(a,r){try{let e=a.body;if(console.log("Creating order with data:",e),!e.customerId)return r.status(400).json({success:!1,error:"Customer ID is required"});if(!e.artworkImage)return r.status(400).json({success:!1,error:"Artwork image is required"});let t=await y.createOrder(e);r.status(201).json({success:!0,order:t,message:"Order created successfully"})}catch(e){console.error("Error creating order:",e),r.status(500).json({success:!1,error:e.message||"Failed to create order"})}}async function vt(a,r){try{let{id:e}=a.params,t=a.body,o=await y.updateOrder(parseInt(e),t);r.json({success:!0,order:o,message:"Order updated successfully"})}catch(e){console.error("Error updating order:",e),r.status(500).json({success:!1,error:e.message||"Failed to update order"})}}async function Mt(a,r){try{let{id:e}=a.params;await y.deleteOrder(parseInt(e)),r.json({success:!0,message:"Order deleted successfully"})}catch(e){console.error("Error deleting order:",e),r.status(500).json({success:!1,error:e.message||"Failed to delete order"})}}async function _t(a,r){try{let e=await y.getAllOrderGroups();r.json({success:!0,orderGroups:e,count:e.length})}catch(e){console.error("Error fetching order groups:",e),r.status(500).json({success:!1,error:e.message||"Failed to fetch order groups"})}}async function Ft(a,r){try{let e=a.body,t=await y.createOrderGroup(e);r.status(201).json({success:!0,orderGroup:t,message:"Order group created successfully"})}catch(e){console.error("Error creating order group:",e),r.status(500).json({success:!1,error:e.message||"Failed to create order group"})}}var J=Fa();J.get("/orders",It);J.get("/orders/:id",Ct);J.post("/orders",Ot);J.patch("/orders/:id",vt);J.delete("/orders/:id",Mt);J.get("/order-groups",_t);J.post("/order-groups",Ft);var Nt=J;import{Router as ka}from"express";Z();Y();import{eq as Na,desc as Aa}from"drizzle-orm";async function At(a,r){try{let e=await u.select().from(b).orderBy(Aa(b.createdAt));return r.status(200).json(e)}catch(e){return console.error("Error fetching customers:",e),r.status(500).json({message:"Error fetching customers"})}}async function kt(a,r){try{let{id:e}=a.params,t=parseInt(e);if(isNaN(t))return r.status(400).json({message:"Invalid customer ID"});let o=await u.select().from(b).where(Na(b.id,t)).limit(1);return o.length===0?r.status(404).json({message:"Customer not found"}):r.status(200).json(o[0])}catch(e){return console.error("Error fetching customer:",e),r.status(500).json({message:"Error fetching customer"})}}async function Dt(a,r){try{let e=Xe.parse(a.body),[t]=await u.insert(b).values(e).returning();return r.status(201).json(t)}catch(e){return console.error("Error creating customer:",e),e.name==="ZodError"?r.status(400).json({message:"Invalid customer data",errors:e.errors}):r.status(500).json({message:"Error creating customer"})}}var Te=ka();Te.get("/customers",At);Te.get("/customers/:id",kt);Te.post("/customers",Dt);var jt=Te;import{Router as Ba}from"express";import{parseString as Da}from"xml2js";import{promisify as ja}from"util";var Ra=ja(Da),Ir=class{async parseVendorXmlPriceSheet(r){try{console.log("Parsing vendor XML price sheet...");let e=await Ra(r),t=[];if(e.catalog?.items?.item){let o=Array.isArray(e.catalog.items.item)?e.catalog.items.item:[e.catalog.items.item];for(let s of o){let n={itemNumber:this.extractValue(s.sku||s.itemNumber||s.id),description:this.extractValue(s.description||s.name),width:this.extractValue(s.width),collection:this.extractValue(s.collection||s.series),manufacturer:this.extractValue(s.manufacturer||s.vendor||"Unknown"),wholesalePrice:this.extractNumericValue(s.wholesalePrice||s.cost||s.price),retailPrice:this.extractNumericValue(s.retailPrice||s.msrp),category:this.extractValue(s.category||s.type),inStock:this.extractBooleanValue(s.inStock||s.available),unitOfMeasure:this.extractValue(s.unitOfMeasure||s.uom||"each")};n.itemNumber&&n.wholesalePrice>0&&t.push(n)}}else if(e.products?.product){let o=Array.isArray(e.products.product)?e.products.product:[e.products.product];for(let s of o){let n={itemNumber:this.extractValue(s.$.id||s.$.sku),description:this.extractValue(s.name?.[0]||s.description?.[0]),width:this.extractValue(s.dimensions?.width?.[0]),collection:this.extractValue(s.collection?.[0]),manufacturer:this.extractValue(s.manufacturer?.[0]||"Unknown"),wholesalePrice:this.extractNumericValue(s.pricing?.wholesale?.[0]||s.cost?.[0]),retailPrice:this.extractNumericValue(s.pricing?.retail?.[0]),category:this.extractValue(s.category?.[0]),inStock:this.extractBooleanValue(s.inventory?.inStock?.[0]),unitOfMeasure:this.extractValue(s.unitOfMeasure?.[0]||"each")};n.itemNumber&&n.wholesalePrice>0&&t.push(n)}}return console.log(`Successfully parsed ${t.length} items from XML price sheet`),t}catch(e){throw console.error("Error parsing XML price sheet:",e),new Error(`Failed to parse XML price sheet: ${e.message}`)}}extractValue(r){return typeof r=="string"?r.trim():Array.isArray(r)&&r.length>0?String(r[0]).trim():r&&typeof r=="object"&&r._?String(r._).trim():""}extractNumericValue(r){let e=this.extractValue(r),t=parseFloat(e.replace(/[^0-9.-]/g,""));return isNaN(t)?0:t}extractBooleanValue(r){let e=this.extractValue(r).toLowerCase();return e==="true"||e==="yes"||e==="1"}convertToFrameFormat(r){return r.map(e=>({id:`vendor-${e.manufacturer.toLowerCase().replace(/\s+/g,"-")}-${e.itemNumber}`,name:`${e.collection?e.collection+" ":""}${e.description}`,manufacturer:e.manufacturer,material:this.inferMaterial(e.description,e.category),width:e.width||"",depth:"",price:e.wholesalePrice.toString(),catalogImage:"",color:this.inferColor(e.description),itemNumber:e.itemNumber,collection:e.collection||"",category:e.category||"",inStock:e.inStock!==!1,unitOfMeasure:e.unitOfMeasure}))}inferMaterial(r,e){let t=r.toLowerCase(),o=e?.toLowerCase()||"";return t.includes("wood")||o.includes("wood")?"wood":t.includes("metal")||o.includes("metal")?"metal":t.includes("plastic")||o.includes("plastic")?"plastic":t.includes("composite")||o.includes("composite")?"composite":"wood"}inferColor(r){let e=r.toLowerCase();return e.includes("black")?"#000000":e.includes("white")?"#FFFFFF":e.includes("brown")?"#8B4513":e.includes("gold")?"#FFD700":e.includes("silver")?"#C0C0C0":e.includes("red")?"#FF0000":e.includes("blue")?"#0000FF":"#8B4513"}},Cr=new Ir;Z();Y();async function Rt(a,r){try{let{xmlContent:e,vendorName:t}=a.body;if(!e)return r.status(400).json({message:"XML content is required"});if(!t)return r.status(400).json({message:"Vendor name is required"});console.log(`Processing XML price sheet for vendor: ${t}`);let o=await Cr.parseVendorXmlPriceSheet(e);if(o.length===0)return r.status(400).json({message:"No valid price items found in XML"});let s=Cr.convertToFrameFormat(o),n=0,l=0;for(let c of s)try{(await u.select().from(O).where(eq(O.id,c.id)).limit(1)).length>0?(await u.update(O).set({name:c.name,manufacturer:c.manufacturer,material:c.material,width:c.width,price:c.price,color:c.color,updatedAt:new Date}).where(eq(O.id,c.id)),l++):(await u.insert(O).values({id:c.id,name:c.name,manufacturer:c.manufacturer,material:c.material,width:c.width,depth:c.depth,price:c.price,catalogImage:c.catalogImage,color:c.color,createdAt:new Date,updatedAt:new Date}),n++)}catch(d){console.error(`Error processing frame item ${c.id}:`,d)}console.log(`XML price sheet processing complete. Inserted: ${n}, Updated: ${l}`),r.json({message:"XML price sheet processed successfully",vendor:t,totalItems:o.length,inserted:n,updated:l,summary:{priceItems:o.slice(0,5),frameItems:s.slice(0,5)}})}catch(e){console.error("Error processing XML price sheet:",e),r.status(500).json({message:"Failed to process XML price sheet",error:e.message})}}async function Et(a,r){r.json({supportedFormats:[{name:"Standard Catalog Format",structure:{catalog:{items:{item:[{sku:"item-number",description:"item-description",manufacturer:"vendor-name",wholesalePrice:"price",width:"frame-width",collection:"collection-name"}]}}}},{name:"Products Format",structure:{products:{product:[{$:{id:"item-number"},name:["item-description"],manufacturer:["vendor-name"],pricing:{wholesale:["price"]}}]}}}],requiredFields:["itemNumber","description","manufacturer","wholesalePrice"],optionalFields:["width","collection","retailPrice","category","inStock"]})}function Ea(a,r,e){console.log("Auth middleware: Allowing request (authentication not implemented)"),e()}var Bt=Ea;var We=Ba();We.use(Bt);We.post("/upload",Rt);We.get("/formats",Et);var qt=We;import{Router as Ta}from"express";var qa=[{itemNumber:"10-036M",width:'5/8"',boxQty:360,collection:"Maple & Walnut - Garrett",basePricePerFoot:6.62,boxPrice:10.05,lengthPrice:13.52,chopPrice:14.52},{itemNumber:"10-100M",width:'5/8"',boxQty:375,collection:"Maple & Walnut - Garrett",basePricePerFoot:6.34,boxPrice:9.71,lengthPrice:12.75,chopPrice:13.75},{itemNumber:"10-507M",width:'5/8"',boxQty:306,collection:"Museum Stems - Garrett",basePricePerFoot:6.52,boxPrice:9.91,lengthPrice:13,chopPrice:14},{itemNumber:"100172",width:'1/4"',boxQty:1600,collection:"Olmsted",basePricePerFoot:2.75,boxPrice:4.64,lengthPrice:7.28,chopPrice:8.28},{itemNumber:"100750",width:'1/4"',boxQty:1200,collection:"Sofia",basePricePerFoot:2.63,boxPrice:4.04,lengthPrice:6.73,chopPrice:7.73},{itemNumber:"100751",width:'1/4"',boxQty:1587,collection:"Sofia",basePricePerFoot:2.63,boxPrice:4.04,lengthPrice:6.73,chopPrice:7.73},{itemNumber:"100752",width:'1/4"',boxQty:1e3,collection:"Sofia",basePricePerFoot:2.63,boxPrice:4.04,lengthPrice:6.73,chopPrice:7.73},{itemNumber:"102CG",width:'1/2"',boxQty:432,collection:"Marquis",basePricePerFoot:1.74,boxPrice:3.7,lengthPrice:6.43,chopPrice:7.43},{itemNumber:"102CS",width:'1/2"',boxQty:432,collection:"Marquis",basePricePerFoot:1.74,boxPrice:3.7,lengthPrice:6.43,chopPrice:7.43},{itemNumber:"103180",width:'9/16"',boxQty:900,collection:"Hudson",basePricePerFoot:1.46,boxPrice:3.11,lengthPrice:5.56,chopPrice:6.56},{itemNumber:"103190",width:'9/16"',boxQty:900,collection:"Hudson",basePricePerFoot:1.4,boxPrice:2.97,lengthPrice:5.3,chopPrice:6.3},{itemNumber:"103235",width:'5/16"',boxQty:1200,collection:"Academie",basePricePerFoot:1.44,boxPrice:3.17,lengthPrice:5.64,chopPrice:6.64},{itemNumber:"103237",width:'5/16"',boxQty:1296,collection:"Academie",basePricePerFoot:1.43,boxPrice:3.14,lengthPrice:5.59,chopPrice:6.59},{itemNumber:"105794",width:'5/16"',boxQty:785,collection:"Lucerne",basePricePerFoot:3.21,boxPrice:5.02,lengthPrice:8.01,chopPrice:9.01},{itemNumber:"105CB",width:'1/2"',boxQty:270,collection:"Vienna",basePricePerFoot:2.21,boxPrice:3.31,lengthPrice:5.71,chopPrice:6.71},{itemNumber:"106180",width:'1/2"',boxQty:900,collection:"Hudson",basePricePerFoot:1.39,boxPrice:2.99,lengthPrice:5.31,chopPrice:6.31},{itemNumber:"106190",width:'1/2"',boxQty:900,collection:"Hudson",basePricePerFoot:1.32,boxPrice:2.83,lengthPrice:5.09,chopPrice:6.09},{itemNumber:"200750",width:'7/8"',boxQty:250,collection:"Sofia",basePricePerFoot:4.38,boxPrice:6.54,lengthPrice:9.9,chopPrice:10.9},{itemNumber:"200751",width:'7/8"',boxQty:515,collection:"Sofia",basePricePerFoot:4.35,boxPrice:6.76,lengthPrice:9.84,chopPrice:10.84},{itemNumber:"200752",width:'7/8"',boxQty:490,collection:"Sofia",basePricePerFoot:4.57,boxPrice:7.31,lengthPrice:10.33,chopPrice:11.33},{itemNumber:"210286",width:'11/16"',boxQty:450,collection:"White",basePricePerFoot:1.89,boxPrice:3.06,lengthPrice:5.99,chopPrice:6.99},{itemNumber:"400750",width:'1 5/8"',boxQty:112,collection:"Sofia",basePricePerFoot:7.47,boxPrice:11.04,lengthPrice:17.48,chopPrice:18.48},{itemNumber:"400751",width:'1 5/8"',boxQty:192,collection:"Sofia",basePricePerFoot:7.09,boxPrice:10.44,lengthPrice:16.55,chopPrice:17.55},{itemNumber:"400752",width:'1 5/8"',boxQty:180,collection:"Sofia",basePricePerFoot:7.34,boxPrice:10.83,lengthPrice:17.17,chopPrice:18.17},{itemNumber:"431431",width:'1 3/8"',boxQty:115,collection:"Zen",basePricePerFoot:10.83,boxPrice:15.91,lengthPrice:26.01,chopPrice:27.01},{itemNumber:"431432",width:'1 3/8"',boxQty:113,collection:"Zen",basePricePerFoot:10.27,boxPrice:15.1,lengthPrice:24.68,chopPrice:25.68},{itemNumber:"431434",width:'1 3/8"',boxQty:110,collection:"Zen",basePricePerFoot:10.75,boxPrice:15.81,lengthPrice:25.82,chopPrice:26.82},{itemNumber:"432900",width:'1 3/4"',boxQty:225,collection:"Foundry",basePricePerFoot:6.62,boxPrice:9.75,lengthPrice:15.03,chopPrice:16.03},{itemNumber:"432902",width:'1 3/4"',boxQty:236,collection:"Foundry",basePricePerFoot:6.81,boxPrice:10.07,lengthPrice:15.52,chopPrice:16.52},{itemNumber:"433082",width:'1 11/16"',boxQty:108,collection:"Soho",basePricePerFoot:5.09,boxPrice:9.55,lengthPrice:14.41,chopPrice:15.41},{itemNumber:"433084",width:'1 11/16"',boxQty:108,collection:"Soho",basePricePerFoot:5.16,boxPrice:9.59,lengthPrice:14.54,chopPrice:15.54},{itemNumber:"433086",width:'1 11/16"',boxQty:108,collection:"Soho",basePricePerFoot:5.22,boxPrice:9.59,lengthPrice:14.54,chopPrice:15.54},{itemNumber:"434110",width:'1 1/4"',boxQty:137,collection:"CR2",basePricePerFoot:6.33,boxPrice:9.33,lengthPrice:14.98,chopPrice:15.98},{itemNumber:"435500",width:'1 5/16"',boxQty:324,collection:"Alto",basePricePerFoot:1.8,boxPrice:3.6,lengthPrice:6.72,chopPrice:7.72},{itemNumber:"435510",width:'1 5/16"',boxQty:296,collection:"Alto",basePricePerFoot:1.8,boxPrice:3.6,lengthPrice:6.72,chopPrice:7.72},{itemNumber:"436350",width:'1 5/8"',boxQty:143,collection:"Brooklyn",basePricePerFoot:2.29,boxPrice:3.66,lengthPrice:6.08,chopPrice:7.08},{itemNumber:"437500",width:'1 3/16"',boxQty:215,collection:"Alto",basePricePerFoot:2.03,boxPrice:3.6,lengthPrice:7.22,chopPrice:8.22},{itemNumber:"437510",width:'1 3/16"',boxQty:180,collection:"Alto",basePricePerFoot:2.03,boxPrice:3.6,lengthPrice:7.22,chopPrice:8.22},{itemNumber:"438120",width:'2"',boxQty:150,collection:"Dresden",basePricePerFoot:6.78,boxPrice:10.26,lengthPrice:15.05,chopPrice:16.05},{itemNumber:"439082",width:'2 1/16"',boxQty:126,collection:"Soho",basePricePerFoot:4.42,boxPrice:7.58,lengthPrice:11.4,chopPrice:12.4},{itemNumber:"440240",width:'1 3/8"',boxQty:190,collection:"Java",basePricePerFoot:7.59,boxPrice:11.23,lengthPrice:18.27,chopPrice:19.27},{itemNumber:"440951",width:'2"',boxQty:92,collection:"Cezanne",basePricePerFoot:18.08,boxPrice:25.65,lengthPrice:29.81,chopPrice:30.81},{itemNumber:"441075",width:'2 1/16"',boxQty:150,collection:"Prague",basePricePerFoot:9.48,boxPrice:13.9,lengthPrice:23.98,chopPrice:24.98},{itemNumber:"441077",width:'2 1/16"',boxQty:155,collection:"Prague",basePricePerFoot:9.44,boxPrice:13.82,lengthPrice:23.86,chopPrice:24.86},{itemNumber:"442650",width:'1 3/4"',boxQty:162,collection:"Tate",basePricePerFoot:4.76,boxPrice:8.08,lengthPrice:11.57,chopPrice:12.57},{itemNumber:"442660",width:'1 3/4"',boxQty:162,collection:"Tate",basePricePerFoot:4.76,boxPrice:8.07,lengthPrice:11.56,chopPrice:12.56},{itemNumber:"442670",width:'1 3/4"',boxQty:162,collection:"Tate",basePricePerFoot:4.67,boxPrice:7.74,lengthPrice:11.04,chopPrice:12.04},{itemNumber:"520750",width:'2 1/2"',boxQty:94,collection:"Sofia",basePricePerFoot:11.07,boxPrice:16.3,lengthPrice:24.59,chopPrice:25.59},{itemNumber:"520751",width:'2 1/2"',boxQty:59,collection:"Sofia",basePricePerFoot:10.92,boxPrice:16.43,lengthPrice:24.78,chopPrice:25.78},{itemNumber:"520752",width:'2 1/2"',boxQty:100,collection:"Sofia",basePricePerFoot:10.56,boxPrice:16.38,lengthPrice:23.41,chopPrice:24.41}];function Lt(a){let r=a.startsWith("larson-")?a.substring(7):a;return qa.find(e=>e.itemNumber===r)||null}var ie=9.5;function Ge(a,r){let e=Lt(a);if(!e)return null;let t=e.basePricePerFoot,o=e.chopPrice||e.basePricePerFoot*1.5,s=Math.ceil(r/ie),n=s*ie,l=n-r,c=n*t,d=r*o,C;if(r>ie){let E=Math.floor(r/ie),P=r-E*ie;if(P>0){let ye=E*ie*t+P*o;C={fullSticks:E,chopFootage:P,totalCost:ye,description:`${E} full stick(s) + ${P.toFixed(1)}' chopped`}}}let R=[{method:"length",cost:c},{method:"chop",cost:d},...C?[{method:"mixed",cost:C.totalCost}]:[]],X=R.reduce((E,P)=>P.cost<E.cost?P:E),D=R.reduce((E,P)=>P.cost>E.cost?P:E).cost-X.cost,z="",he;return X.method==="length"?z=`Full sticks are cheaper despite ${l.toFixed(1)}' waste`:X.method==="chop"?z="Chop pricing saves money by avoiding waste":z="Mixed approach optimizes cost by combining full sticks and chopped pieces",r>=0&&r<=4?he="\u{1F3AF} OPTIMAL RANGE: 0-4 feet - Consider chop pricing to avoid waste":r>=10&&r<=14?he="\u{1F3AF} OPTIMAL RANGE: 10-14 feet - Mixed ordering may be most cost-effective":r>4&&r<9.5&&(he="\u{1F4CF} Consider: Close to full stick length, evaluate waste vs chop premium"),{itemNumber:a,footageNeeded:r,lengthOption:{sticksNeeded:s,totalFootage:n,wasteFootage:l,costPerFoot:t,totalCost:c,description:`${s} stick(s) @ ${ie}' each`},chopOption:{footageNeeded:r,costPerFoot:o,totalCost:d,description:`${r}' chopped to exact length`},mixedOption:C,recommendation:{method:X.method,savings:D,reason:z,alert:he}}}function La(a,r,e){let t=a+e*2,o=r+e*2;return t*2+o*2}function $a(a,r,e,t){let s=La(r,e,t)/12;return Ge(a,s)}function $t(a){return a.map(r=>({...$a(r.itemNumber,r.artworkWidth,r.artworkHeight,r.matWidth),quantity:r.quantity||1})).filter(Boolean)}function Tt(a){let r=a.reduce((o,s)=>o+s.recommendation.savings*s.quantity,0),e=a.reduce((o,s)=>o+s.quantity,0),t=a.filter(o=>o.recommendation.alert).length;return{totalSavings:r,totalOrders:e,averageSavingsPerOrder:r/e,alertCount:t}}async function Wt(a,r){try{let{itemNumber:e,footageNeeded:t}=a.body;if(!e||!t)return r.status(400).json({error:"Missing required parameters: itemNumber and footageNeeded"});let o=Ge(e,parseFloat(t));if(!o)return r.status(404).json({error:"Item number not found in Larson-Juhl catalog"});r.json(o)}catch(e){console.error("Error optimizing Larson order:",e),r.status(500).json({error:"Internal server error"})}}async function He(a,r){try{let{itemNumber:e,artworkWidth:t,artworkHeight:o,matWidth:s}=a.body;if(!e||!t||!o||s===void 0)return r.status(400).json({error:"Missing required parameters: itemNumber, artworkWidth, artworkHeight, matWidth"});let n=He(e,parseFloat(t),parseFloat(o),parseFloat(s));if(!n)return r.status(404).json({error:"Item number not found in Larson-Juhl catalog"});r.json(n)}catch(e){console.error("Error optimizing frame order:",e),r.status(500).json({error:"Internal server error"})}}async function Gt(a,r){try{let{orders:e}=a.body;if(!e||!Array.isArray(e))return r.status(400).json({error:"Missing or invalid orders array"});let t=$t(e),o=Tt(t);r.json({optimizations:t,summary:o})}catch(e){console.error("Error batch optimizing orders:",e),r.status(500).json({error:"Internal server error"})}}async function Ht(a,r){try{let{itemNumber:e}=a.params,o=[2,4,6,8,10,12,14,16,18,20].map(s=>{let n=Ge(e,s);return{footage:s,optimization:n}}).filter(s=>s.optimization!==null);if(o.length===0)return r.status(404).json({error:"Item number not found in Larson-Juhl catalog"});r.json({itemNumber:e,analysis:o})}catch(e){console.error("Error generating optimization analysis:",e),r.status(500).json({error:"Internal server error"})}}var Ne=Ta();Ne.post("/optimize/footage",Wt);Ne.post("/optimize/frame",He);Ne.post("/optimize/batch",Gt);Ne.get("/analyze/:itemNumber",Ht);var Ut=Ne;async function zt(a){a.post("/api/art-locations",lr.sendArtLocationData),a.get("/api/art-locations/:orderId",lr.getArtLocationData),a.post("/api/frame-designs",dr.saveFrameDesign),a.get("/api/frame-designs/:orderId",dr.getFrameDesign),a.get("/api/health",it.getSystemHealth),a.get("/api/vendor-catalog/all",(t,o)=>{o.json([])}),a.get("/api/vendor-catalog/larson",(t,o)=>{o.json([])}),a.get("/api/vendor-catalog/roma",(t,o)=>{o.json([])}),a.get("/api/vendor-catalog/nielsen",(t,o)=>{o.json([])}),a.get("/api/larson-catalog/crescent",(t,o)=>{o.json([])}),a.get("/api/frames",(t,o)=>{o.json([])}),a.get("/api/auth/status",(t,o)=>{o.json({authenticated:!1,user:null})}),a.get("/api/discord/bot-info",(t,o)=>{o.json({status:"disabled",message:"Discord integration temporarily disabled for deployment stability"})}),a.post("/api/discord/test-notification",async(t,o)=>{o.status(503).json({error:"Discord integration temporarily disabled",message:"Discord notifications are currently unavailable"})}),a.post("/api/notifications/send",async(t,o)=>{try{let{customerPhone:s,customerEmail:n,orderId:l,type:c,message:d,discordUserId:C}=t.body,{getCustomerByPhone:R,getCustomerByEmail:X,updateCustomerDiscordId:ee}=await Promise.resolve().then(()=>(vr(),Or)),D=s?R(s):n?X(n):null;if(!D)return o.status(404).json({error:"Customer not found"});let z=l||Math.floor(Math.random()*1e3)+100;console.log(`Notification request for customer ${D.name}: ${c} - ${d}`),o.json({success:!0,customer:{name:D.name,phone:D.phone,email:D.email,hasDiscord:!1},orderNumber:z,message:"Notification logged (Discord integration disabled for deployment stability)"})}catch(s){console.error("Error sending customer notification:",s),o.status(500).json({error:"Failed to send notification",details:s instanceof Error?s.message:"Unknown error"})}}),a.get("/api/customers/search",async(t,o)=>{try{let{phone:s,email:n}=t.query,{getCustomerByPhone:l,getCustomerByEmail:c}=await Promise.resolve().then(()=>(vr(),Or)),d=s?l(s):n?c(n):null;if(!d)return o.status(404).json({error:"Customer not found"});o.json({customer:{id:d.id,name:d.name,phone:d.phone,email:d.email,hasDiscord:!!d.discordUserId,preferences:d.preferences,notes:d.notes}})}catch{o.status(500).json({error:"Failed to search customer"})}}),a.get("/api/kanban/external/orders",async(t,o)=>{try{let{externalKanbanService:s}=await Promise.resolve().then(()=>(ze(),Ue)),n=await s.fetchOrders();o.json(n)}catch{o.status(500).json({success:!1,orders:[],error:"Failed to fetch orders from external Kanban app"})}}),a.get("/api/kanban/external/health",async(t,o)=>{try{let{externalKanbanService:s}=await Promise.resolve().then(()=>(ze(),Ue)),n=await s.healthCheck();o.json(n)}catch{o.status(500).json({status:"error",connected:!1,error:"Failed to check external Kanban health"})}}),a.post("/api/kanban/external/orders/:orderId/status",async(t,o)=>{try{let{orderId:s}=t.params,{status:n,stage:l,notes:c}=t.body,{externalKanbanService:d}=await Promise.resolve().then(()=>(ze(),Ue));await d.updateOrderStatus(s,n,l,c)?o.json({success:!0,orderId:s,updatedStatus:n,stage:l,notes:c,timestamp:new Date().toISOString()}):o.status(500).json({success:!1,error:"Failed to update order status in external Kanban"})}catch{o.status(500).json({success:!1,error:"Failed to update external Kanban order status"})}}),a.get("/api/kanban/orders",pr,(t,o)=>{o.json({success:!0,orders:[],endpoint:"/api/kanban/orders",description:"Retrieves all orders with production status and timeline information"})}),a.post("/api/kanban/orders/:orderId/status",pr,(t,o)=>{let{orderId:s}=t.params,{status:n,stage:l,notes:c}=t.body;o.json({success:!0,orderId:s,updatedStatus:n,stage:l,notes:c,timestamp:new Date().toISOString(),description:"Updates order production status from external Kanban system"})}),a.get("/api/kanban/status",(t,o)=>{o.json({status:"active",service:"Jays Frames POS System",version:"1.0.0",endpoints:{orders:"/api/kanban/orders",updateStatus:"/api/kanban/orders/:orderId/status",health:"/api/kanban/status"},authentication:"API Key required in Authorization header",timestamp:new Date().toISOString()})}),a.get("/api/kanban/api-key",(t,o)=>{o.json({apiKey:$e,usage:"Add this to your Kanban app Authorization header as: Bearer "+$e,endpoints:{orders:"/api/kanban/orders",updateStatus:"/api/kanban/orders/:orderId/status"},note:"Keep this API key secure - it provides access to your order data"})}),a.use("/api/hub",ct),a.use("/api/hub-admin",gr),a.use("/api/admin",gr),a.post("/api/admin/generate-api-key",async(t,o)=>{try{let{generateApiKey:s}=await Promise.resolve().then(()=>(fe(),Fe));await s(t,o)}catch(s){console.error("Error in generate-api-key route:",s),o.status(500).json({success:!1,error:s.message})}}),a.get("/api/admin/integration-status",async(t,o)=>{try{let{getIntegrationStatus:s}=await Promise.resolve().then(()=>(fe(),Fe));await s(t,o)}catch(s){console.error("Error in integration-status route:",s),o.status(500).json({success:!1,error:s.message})}}),a.get("/api/admin/integration-docs",async(t,o)=>{try{let{getIntegrationDocs:s}=await Promise.resolve().then(()=>(fe(),Fe));await s(t,o)}catch(s){console.error("Error in integration-docs route:",s),o.status(500).json({success:!1,error:s.message})}}),a.get("/api/webhooks",async(t,o)=>{try{o.json({success:!0,webhooks:[]})}catch(s){console.error("Error in webhooks route:",s),o.status(500).json({success:!1,error:s.message})}}),a.use("/api",Nt),a.use("/api",jt),a.use("/api/integration",Pt),a.use("/api/xml-price-sheets",qt),a.use("/api/larson-optimizer",Ut),a.get("/api/discord/status",(t,o)=>{o.json({status:"disabled",message:"Discord integration disabled for deployment stability"})}),a.get("/api/notifications/status",(t,o)=>{o.json({status:"basic",channels:["email"],message:"Basic notifications only"})}),a.get("/api/materials/pick-list",dt),a.get("/api/materials/by-supplier",mt),a.get("/api/materials/order/:orderId",pt),a.put("/api/materials/:id",ft),a.post("/api/materials/purchase-order",gt),a.get("/api/materials/types",ht),a.get("/api/materials/suppliers",yt);let r=Ka(a),e=new Va({server:r,path:"/ws"});return e.on("connection",t=>{console.log("WebSocket client connected"),t.on("message",o=>{try{console.log("Received message:",o.toString()),e.clients.forEach(s=>{s.readyState===Ya.OPEN&&s.send(o.toString())})}catch(s){console.error("WebSocket message error:",s)}}),t.send(JSON.stringify({type:"connection",message:"WebSocket connection established"}))}),r}import Qe from"fs";import{createServer as rs,createLogger as ts}from"vite";import{defineConfig as Za}from"vite";import Ja from"@vitejs/plugin-react";import Xa from"@replit/vite-plugin-shadcn-theme-json";import Ae from"path";import es from"@replit/vite-plugin-runtime-error-modal";var Qt=Za({plugins:[Ja(),es(),Xa()],resolve:{alias:{"@":Ae.resolve(import.meta.dirname,"client","src"),"@shared":Ae.resolve(import.meta.dirname,"shared"),"@assets":Ae.resolve(import.meta.dirname,"attached_assets")}},root:Ae.resolve(import.meta.dirname,"client"),build:{outDir:Ae.resolve(import.meta.dirname,"dist/public"),emptyOutDir:!0}});import{nanoid as os}from"nanoid";import as from"express";import ke from"path";import{fileURLToPath as ss}from"url";var Kt=ts();function k(a,r="express"){let e=new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0});console.log(`${e} [${r}] ${a}`)}async function Yt(a,r){let e={middlewareMode:!0,hmr:{server:r},allowedHosts:!0},t=await rs({...Qt,configFile:!1,customLogger:{...Kt,error:(o,s)=>{Kt.error(o,s),console.error(`Vite server error: ${o}`)}},server:e,appType:"custom"});a.use(t.middlewares),a.use("*",async(o,s,n)=>{let l=o.originalUrl;try{let c=ke.resolve(import.meta.dirname,"..","client","index.html"),d=await Qe.promises.readFile(c,"utf-8");d=d.replace('src="/src/main.tsx"',`src="/src/main.tsx?v=${os()}"`);let C=await t.transformIndexHtml(l,d);s.status(200).set({"Content-Type":"text/html"}).end(C)}catch(c){t.ssrFixStacktrace(c),n(c)}})}function Zt(a){let r=ke.resolve(Vt,"..","dist","public"),e=ke.resolve(Vt,"..","client","dist"),t="";Qe.existsSync(r)?(t=r,k(`Serving static files from: ${r}`)):Qe.existsSync(e)?(t=e,k(`Serving static files from: ${e}`)):k("No static files found. Please build the client application.","error"),t&&a.use(as.static(t,{maxAge:"1d",etag:!0,index:"index.html"})),a.get("*",(o,s,n)=>{if(o.path.startsWith("/api")||o.path.startsWith("/uploads"))return n();let l=ke.resolve(t,"index.html");Qe.existsSync(l)?s.sendFile(l):s.status(500).json({error:"Client application not built",message:'Please run "npm run build" to build the client application'})})}var ns=ss(import.meta.url),Vt=ke.dirname(ns);import is from"path";import Jt from"fs";import{fileURLToPath as cs}from"url";import{dirname as us}from"path";import ls from"cors";var ds=cs(import.meta.url),Vi=us(ds),T=Ke(),ge=parseInt(process.env.PORT||process.env.REPL_PORT||"5000",10);T.use(ls({origin:!0,credentials:!0}));T.use(Ke.json({limit:"50mb"}));T.use(Ke.urlencoded({extended:!0,limit:"50mb"}));T.use((a,r,e)=>{let t=Date.now(),o=a.path,s,n=r.json;r.json=function(l,...c){return s=l,n.apply(r,[l,...c])},r.on("finish",()=>{let l=Date.now()-t;if(o.startsWith("/api")){let c=`${a.method} ${o} ${r.statusCode} in ${l}ms`;s&&(c+=` :: ${JSON.stringify(s)}`),c.length>80&&(c=c.slice(0,79)+"\u2026"),k(c)}}),e()});(async()=>{let a=await zt(T);T.use((t,o,s,n)=>{let l=t.status||t.statusCode||500,c=t.message||"Internal Server Error";s.status(l).json({message:c}),k(`Error: ${c} (${l})`,"error"),console.error(t)}),T.get("env")==="development"?await Yt(T,a):Zt(T);let r=()=>{try{let t=a.listen(ge,"0.0.0.0",()=>{k(`serving on port ${ge}`),console.log(`\u2713 Server running on port ${ge}`),console.log("\u2713 Environment: production")});t.on("error",s=>{if(s.code==="EADDRINUSE"){k(`Port ${ge} is already in use, trying ${ge+1}`,"warning");let n=ge+1;return a.listen(n,"0.0.0.0",()=>{k(`serving on fallback port ${n}`),console.log(`\u2713 Server running on fallback port ${n}`)})}else k(`Server startup error: ${s.message}`,"error"),console.error("Server error:",s),setTimeout(()=>{process.exit(1)},1e3)});let o=s=>{k(`${s} received, shutting down gracefully`,"info"),console.log("Shutting down server..."),t.close(n=>{n?(console.error("Error during shutdown:",n),process.exit(1)):(k("Server closed","info"),console.log("Server closed gracefully"),process.exit(0))}),setTimeout(()=>{console.log("Force exit after timeout"),process.exit(1)},1e4)};return process.on("SIGTERM",()=>o("SIGTERM")),process.on("SIGINT",()=>o("SIGINT")),t}catch(t){k(`Critical server startup failure: ${t}`,"error"),console.error("Critical error:",t),process.exit(1)}},e=is.join(process.cwd(),"uploads");try{Jt.existsSync(e)||Jt.mkdirSync(e,{recursive:!0})}catch(t){k(`Warning: Could not create uploads directory: ${t}`,"warning")}T.use("/uploads",Ke.static(e)),r()})();
