var st=Object.defineProperty;var So=Object.getOwnPropertyDescriptor;var Io=Object.getOwnPropertyNames;var vo=Object.prototype.hasOwnProperty;var _=(o,t)=>()=>(o&&(t=o(o=0)),t);var ae=(o,t)=>{for(var e in t)st(o,e,{get:t[e],enumerable:!0})},Oo=(o,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Io(t))!vo.call(o,s)&&s!==e&&st(o,s,{get:()=>t[s],enumerable:!(r=So(t,s))||r.enumerable});return o};var Ht=o=>Oo(st({},"__esModule",{value:!0}),o);var ut={};ae(ut,{customerNotifications:()=>H,customers:()=>P,frames:()=>C,glassOptions:()=>G,insertCustomerNotificationSchema:()=>Ho,insertCustomerSchema:()=>at,insertFrameSchema:()=>_o,insertGlassOptionSchema:()=>Mo,insertInventoryCategorySchema:()=>zo,insertInventoryCountItemSchema:()=>rs,insertInventoryCountSchema:()=>ts,insertInventoryItemSchema:()=>Vo,insertInventoryLocationSchema:()=>He,insertInventoryTransactionSchema:()=>Zo,insertLarsonJuhlCatalogSchema:()=>qo,insertMatColorSchema:()=>Ao,insertMaterialLocationSchema:()=>as,insertMaterialOrderSchema:()=>Go,insertNotificationSchema:()=>ns,insertOrderFrameSchema:()=>Eo,insertOrderGroupSchema:()=>No,insertOrderMatSchema:()=>Do,insertOrderSchema:()=>jo,insertOrderSpecialServiceSchema:()=>Ro,insertPaymentLinkSchema:()=>os,insertPurchaseOrderLineSchema:()=>es,insertPurchaseOrderSchema:()=>Xo,insertQrCodeScanSchema:()=>zt,insertQrCodeSchema:()=>Kt,insertSpecialServiceSchema:()=>Fo,insertSupplierSchema:()=>Ko,insertUserSchema:()=>Lo,insertWholesaleOrderSchema:()=>Bo,inventoryCategories:()=>ne,inventoryCountItems:()=>Ut,inventoryCounts:()=>nt,inventoryItems:()=>I,inventoryLocations:()=>S,inventoryTransactions:()=>ee,larsonJuhlCatalog:()=>Wt,matColors:()=>T,materialLocations:()=>ct,materialOrderStatuses:()=>Uo,materialOrders:()=>M,materialTypes:()=>Wo,measurementUnits:()=>Qo,notificationChannels:()=>To,notificationTypes:()=>$o,notifications:()=>N,orderFrames:()=>Ae,orderGroups:()=>j,orderMats:()=>_e,orderSpecialServices:()=>ge,orders:()=>h,paymentLinks:()=>Gt,productionStatuses:()=>ko,purchaseOrderLines:()=>We,purchaseOrderStatuses:()=>Jo,purchaseOrders:()=>Q,qrCodeScans:()=>it,qrCodeTypes:()=>ss,qrCodes:()=>fe,specialServices:()=>K,suppliers:()=>F,transactionTypes:()=>Yo,users:()=>X,wholesaleOrders:()=>z});import{pgTable as w,text as i,serial as O,integer as y,boolean as A,numeric as g,timestamp as f,jsonb as Ce,primaryKey as Co}from"drizzle-orm/pg-core";import{createInsertSchema as x}from"drizzle-zod";var P,at,C,_o,T,Ao,G,Mo,K,Fo,j,No,ko,h,jo,ge,Ro,_e,Do,Ae,Eo,z,Bo,X,Lo,Wt,qo,$o,To,H,Ho,Wo,Uo,M,Go,F,Ko,ne,zo,S,He,Qo,I,Vo,Yo,ee,Zo,Jo,Q,Xo,We,es,nt,ts,Ut,rs,Gt,os,ss,fe,Kt,it,zt,ct,as,N,ns,te=_(()=>{"use strict";P=w("customers",{id:O("id").primaryKey(),name:i("name").notNull(),email:i("email"),phone:i("phone"),address:i("address"),stripeCustomerId:i("stripe_customer_id"),createdAt:f("created_at").defaultNow()}),at=x(P).omit({id:!0,createdAt:!0}),C=w("frames",{id:i("id").primaryKey(),name:i("name").notNull(),manufacturer:i("manufacturer").notNull(),material:i("material").notNull(),width:g("width").notNull(),depth:g("depth").notNull(),price:g("price").notNull(),catalogImage:i("catalog_image").notNull(),edgeTexture:i("edge_texture"),corner:i("corner")}),_o=x(C),T=w("mat_colors",{id:i("id").primaryKey(),name:i("name").notNull(),color:i("color").notNull(),price:g("price").notNull(),manufacturer:i("manufacturer"),code:i("code"),description:i("description"),category:i("category")}),Ao=x(T),G=w("glass_options",{id:i("id").primaryKey(),name:i("name").notNull(),description:i("description").notNull(),price:g("price").notNull()}),Mo=x(G),K=w("special_services",{id:i("id").primaryKey(),name:i("name").notNull(),description:i("description").notNull(),price:g("price").notNull()}),Fo=x(K),j=w("order_groups",{id:O("id").primaryKey(),customerId:y("customer_id").references(()=>P.id),subtotal:g("subtotal"),tax:g("tax"),total:g("total"),status:i("status").notNull().default("open"),paymentMethod:i("payment_method"),notes:i("notes"),createdAt:f("created_at").defaultNow(),stripePaymentIntentId:i("stripe_payment_intent_id"),stripePaymentStatus:i("stripe_payment_status"),paymentDate:f("payment_date"),discountAmount:g("discount_amount"),discountType:i("discount_type"),taxExempt:A("tax_exempt").default(!1),cashAmount:g("cash_amount"),checkNumber:i("check_number"),invoiceEmailSent:A("invoice_email_sent").default(!1),invoiceEmailDate:f("invoice_email_date")}),No=x(j).omit({id:!0,createdAt:!0}),ko=["order_processed","scheduled","materials_ordered","materials_arrived","frame_cut","mat_cut","prepped","completed","delayed"],h=w("orders",{id:O("id").primaryKey(),customerId:y("customer_id").references(()=>P.id),orderGroupId:y("order_group_id").references(()=>j.id),frameId:i("frame_id").references(()=>C.id),matColorId:i("mat_color_id").references(()=>T.id),glassOptionId:i("glass_option_id").references(()=>G.id),artworkWidth:g("artwork_width").notNull(),artworkHeight:g("artwork_height").notNull(),matWidth:g("mat_width").notNull(),artworkDescription:i("artwork_description"),artworkType:i("artwork_type"),artworkLocation:i("artwork_location"),quantity:y("quantity").notNull().default(1),subtotal:g("subtotal").notNull(),tax:g("tax").notNull(),total:g("total").notNull(),status:i("status").notNull().default("pending"),productionStatus:i("production_status").$type().notNull().default("order_processed"),previousStatus:i("previous_status").$type(),createdAt:f("created_at").defaultNow(),dueDate:f("due_date"),artworkImage:i("artwork_image"),frameDesignImage:i("frame_design_image"),lastNotificationSent:f("last_notification_sent"),estimatedCompletionDays:y("estimated_completion_days"),addToWholesaleOrder:A("add_to_wholesale_order").default(!1),lastStatusChange:f("last_status_change").defaultNow(),notificationsEnabled:A("notifications_enabled").default(!0),useMultipleMats:A("use_multiple_mats").default(!1),useMultipleFrames:A("use_multiple_frames").default(!1),useManualFrame:A("use_manual_frame").default(!1),manualFrameName:i("manual_frame_name"),manualFrameCost:g("manual_frame_cost"),miscChargeDescription:i("misc_charge_description"),miscChargeAmount:g("misc_charge_amount")}),jo=x(h).omit({id:!0,createdAt:!0}),ge=w("order_special_services",{orderId:y("order_id").references(()=>h.id),specialServiceId:i("special_service_id").references(()=>K.id)},o=>({pk:Co({columns:[o.orderId,o.specialServiceId]})})),Ro=x(ge),_e=w("order_mats",{id:O("id").primaryKey(),orderId:y("order_id").references(()=>h.id).notNull(),matColorId:i("mat_color_id").references(()=>T.id).notNull(),position:y("position").notNull(),width:g("width").notNull(),offset:g("offset").notNull().default("0"),createdAt:f("created_at").defaultNow()}),Do=x(_e).omit({id:!0,createdAt:!0}),Ae=w("order_frames",{id:O("id").primaryKey(),orderId:y("order_id").references(()=>h.id).notNull(),frameId:i("frame_id").references(()=>C.id).notNull(),position:y("position").notNull(),distance:g("distance").notNull().default("0"),createdAt:f("created_at").defaultNow()}),Eo=x(Ae).omit({id:!0,createdAt:!0}),z=w("wholesale_orders",{id:O("id").primaryKey(),orderId:y("order_id").references(()=>h.id),manufacturer:i("manufacturer").notNull(),items:Ce("items").notNull(),status:i("status").notNull().default("pending"),createdAt:f("created_at").defaultNow()}),Bo=x(z).omit({id:!0,createdAt:!0}),X=w("users",{id:O("id").primaryKey(),username:i("username").notNull().unique(),password:i("password").notNull(),role:i("role").notNull().default("employee")}),Lo=x(X).omit({id:!0}),Wt=w("larson_juhl_catalog",{id:i("id").primaryKey(),name:i("name").notNull(),hex_color:i("hex_color"),price:g("price",{precision:10,scale:6}).notNull(),code:i("code").notNull(),crescent_code:i("crescent_code"),description:i("description"),category:i("category"),manufacturer:i("manufacturer").notNull(),type:i("type").notNull().default("matboard"),material:i("material"),width:g("width"),depth:g("depth"),edge_texture:i("edge_texture"),corner:i("corner"),catalog_image:i("catalog_image"),createdAt:f("created_at").defaultNow()}),qo=x(Wt).omit({createdAt:!0}),$o=["status_update","estimated_completion","status_change","due_date_update","completion_reminder","order_complete","payment_reminder","delay_notification","payment_link"],To=["email","sms","both"],H=w("customer_notifications",{id:O("id").primaryKey(),customerId:y("customer_id").references(()=>P.id),orderId:y("order_id").references(()=>h.id),notificationType:i("notification_type").$type().notNull(),channel:i("channel").$type().notNull().default("email"),subject:i("subject").notNull(),message:i("message").notNull(),sentAt:f("sent_at").defaultNow(),successful:A("successful").notNull(),responseData:Ce("response_data"),previousStatus:i("previous_status"),newStatus:i("new_status"),paymentLinkId:y("payment_link_id")}),Ho=x(H).omit({id:!0,sentAt:!0}),Wo=["frame","matboard","glass","backing_board","hardware","specialty_materials"],Uo=["pending","processed","ordered","arrived","frame_cut","mat_cut","prepped","completed","delayed","canceled"],M=w("material_orders",{id:O("id").primaryKey(),materialType:i("material_type").$type().notNull(),materialId:i("material_id").notNull(),materialName:i("material_name").notNull(),quantity:g("quantity").notNull(),status:i("status").$type().notNull().default("pending"),sourceOrderId:y("source_order_id").references(()=>h.id),orderDate:f("order_date"),expectedArrival:f("expected_arrival"),actualArrival:f("actual_arrival"),supplierName:i("supplier_name"),supplierOrderNumber:i("supplier_order_number"),notes:i("notes"),costPerUnit:g("cost_per_unit"),totalCost:g("total_cost"),priority:i("priority").default("normal"),hubOrderId:i("hub_order_id"),hubSyncStatus:i("hub_sync_status").default("not_synced"),hubLastSyncDate:f("hub_last_sync_date"),hubTrackingInfo:i("hub_tracking_info"),hubEstimatedDelivery:f("hub_estimated_delivery"),hubSupplierNotes:i("hub_supplier_notes"),orderReference:i("order_reference"),unitMeasurement:i("unit_measurement"),createdAt:f("created_at").defaultNow()}),Go=x(M).omit({id:!0,createdAt:!0,hubOrderId:!0,hubSyncStatus:!0,hubLastSyncDate:!0,hubTrackingInfo:!0,hubEstimatedDelivery:!0,hubSupplierNotes:!0}),F=w("suppliers",{id:O("id").primaryKey(),name:i("name").notNull(),contactName:i("contact_name"),email:i("email"),phone:i("phone"),address:i("address"),website:i("website"),accountNumber:i("account_number"),notes:i("notes"),paymentTerms:i("payment_terms"),minimumOrderAmount:g("minimum_order_amount"),shippingPreference:i("shipping_preference"),leadTime:y("lead_time"),active:A("active").default(!0),createdAt:f("created_at").defaultNow(),lastOrderDate:f("last_order_date")}),Ko=x(F).omit({id:!0,createdAt:!0}),ne=w("inventory_categories",{id:O("id").primaryKey(),name:i("name").notNull(),description:i("description"),parentCategoryId:y("parent_category_id").references(()=>ne.id),createdAt:f("created_at").defaultNow()}),zo=x(ne).omit({id:!0,createdAt:!0}),S=w("inventory_locations",{id:O("id").primaryKey(),name:i("name").notNull(),description:i("description"),type:i("type"),parentLocationId:y("parent_location_id").references(()=>S.id),active:A("active").default(!0),createdAt:f("created_at").defaultNow()}),He=x(S).omit({id:!0,createdAt:!0}),Qo=["each","inch","foot","united_inch","square_inch","sheet","roll","pound","liter","gallon"],I=w("inventory_items",{id:O("id").primaryKey(),sku:i("sku").notNull().unique(),name:i("name").notNull(),description:i("description"),categoryId:y("category_id").references(()=>ne.id),supplierId:y("supplier_id").references(()=>F.id),supplierSku:i("supplier_sku"),unitOfMeasure:i("unit_of_measure").$type().notNull(),costPerUnit:g("cost_per_unit").notNull(),retailPrice:g("retail_price"),minimumStockLevel:g("minimum_stock_level").notNull(),reorderLevel:g("reorder_level").notNull(),reorderQuantity:g("reorder_quantity"),locationId:y("location_id").references(()=>S.id),barcode:i("barcode"),notes:i("notes"),tags:i("tags").array(),isActive:A("is_active").default(!0),createdAt:f("created_at").defaultNow(),updatedAt:f("updated_at").defaultNow(),lastCountDate:f("last_count_date"),imageUrl:i("image_url"),dimensions:Ce("dimensions"),autoBatchReorder:A("auto_batch_reorder").default(!1),materialType:i("material_type").$type(),materialId:i("material_id")}),Vo=x(I).omit({id:!0,createdAt:!0,updatedAt:!0}),Yo=["purchase","sale","adjustment","return","transfer","count","scrap","initial"],ee=w("inventory_transactions",{id:O("id").primaryKey(),itemId:y("item_id").references(()=>I.id).notNull(),type:i("type").$type().notNull(),quantity:g("quantity").notNull(),unitCost:g("unit_cost"),locationId:y("location_id").references(()=>S.id),relatedOrderId:y("related_order_id").references(()=>h.id),notes:i("notes"),referenceNumber:i("reference_number"),createdAt:f("created_at").defaultNow(),createdBy:y("created_by").references(()=>X.id)}),Zo=x(ee).omit({id:!0,createdAt:!0}),Jo=["draft","pending","approved","sent","partially_received","received","canceled"],Q=w("purchase_orders",{id:O("id").primaryKey(),poNumber:i("po_number").notNull(),supplierId:y("supplier_id").references(()=>F.id).notNull(),orderDate:f("order_date").notNull(),expectedDeliveryDate:f("expected_delivery_date"),status:i("status").$type().default("draft").notNull(),subtotal:g("subtotal"),tax:g("tax"),shipping:g("shipping"),total:g("total"),notes:i("notes"),createdBy:y("created_by").references(()=>X.id),createdAt:f("created_at").defaultNow(),updatedAt:f("updated_at").defaultNow(),receivedDate:f("received_date"),supplierOrderConfirmation:i("supplier_order_confirmation"),shippingMethod:i("shipping_method"),paymentMethod:i("payment_method"),paymentTerms:i("payment_terms"),tracking:i("tracking"),attachments:i("attachments").array()}),Xo=x(Q).omit({id:!0,createdAt:!0,updatedAt:!0}),We=w("purchase_order_lines",{id:O("id").primaryKey(),purchaseOrderId:y("purchase_order_id").references(()=>Q.id).notNull(),itemId:y("item_id").references(()=>I.id).notNull(),quantity:g("quantity").notNull(),unitCost:g("unit_cost").notNull(),lineTotal:g("line_total").notNull(),receivedQuantity:g("received_quantity").default("0"),notes:i("notes"),createdAt:f("created_at").defaultNow()}),es=x(We).omit({id:!0,createdAt:!0}),nt=w("inventory_counts",{id:O("id").primaryKey(),countReference:i("count_reference").notNull(),startDate:f("start_date").notNull(),endDate:f("end_date"),status:i("status").default("in_progress").notNull(),notes:i("notes"),createdBy:y("created_by").references(()=>X.id),createdAt:f("created_at").defaultNow()}),ts=x(nt).omit({id:!0,createdAt:!0}),Ut=w("inventory_count_items",{id:O("id").primaryKey(),countId:y("count_id").references(()=>nt.id).notNull(),itemId:y("item_id").references(()=>I.id).notNull(),locationId:y("location_id").references(()=>S.id),expectedQuantity:g("expected_quantity"),actualQuantity:g("actual_quantity"),notes:i("notes"),countedBy:y("counted_by").references(()=>X.id),countedAt:f("counted_at"),createdAt:f("created_at").defaultNow()}),rs=x(Ut).omit({id:!0,createdAt:!0}),Gt=w("payment_links",{id:O("id").primaryKey(),token:i("token").notNull().unique(),amount:g("amount",{precision:10,scale:2}).notNull(),description:i("description"),customerId:y("customer_id").references(()=>P.id),createdAt:f("created_at").defaultNow(),expiresAt:f("expires_at").notNull(),usedAt:f("used_at"),used:A("used").default(!1),paymentIntentId:i("payment_intent_id"),paymentStatus:i("payment_status").default("pending")}),os=x(Gt).omit({id:!0,createdAt:!0,usedAt:!0,used:!0,paymentIntentId:!0,paymentStatus:!0}),ss=["inventory_location","inventory_item","material_order","customer_order","production_status","artwork_location"],fe=w("qr_codes",{id:O("id").primaryKey(),code:i("code").notNull().unique(),type:i("type").$type().notNull(),entityId:i("entity_id").notNull(),title:i("title").notNull(),description:i("description"),metadata:Ce("metadata"),createdAt:f("created_at").defaultNow(),lastScanned:f("last_scanned"),scanCount:y("scan_count").default(0),active:A("active").default(!0)}),Kt=x(fe).omit({id:!0,createdAt:!0,lastScanned:!0,scanCount:!0}),it=w("qr_code_scans",{id:O("id").primaryKey(),qrCodeId:y("qr_code_id").references(()=>fe.id).notNull(),userId:y("user_id").references(()=>X.id),scannedAt:f("scanned_at").defaultNow(),location:i("location"),action:i("action"),metadata:Ce("metadata")}),zt=x(it).omit({id:!0,scannedAt:!0}),ct=w("material_locations",{id:O("id").primaryKey(),materialType:i("material_type").$type().notNull(),materialId:i("material_id").notNull(),locationId:y("location_id").references(()=>S.id).notNull(),qrCodeId:y("qr_code_id").references(()=>fe.id),quantity:g("quantity").notNull().default("1"),notes:i("notes"),lastUpdated:f("last_updated").defaultNow(),active:A("active").default(!0)}),as=x(ct).omit({id:!0,lastUpdated:!0}),N=w("notifications",{id:O("id").primaryKey(),title:i("title").notNull(),description:i("description").notNull(),source:i("source").notNull(),sourceId:i("source_id"),type:i("type").$type().notNull().default("info"),createdAt:f("created_at").defaultNow(),read:A("read").default(!1),actionable:A("actionable").default(!1),link:i("link"),smsEnabled:A("sms_enabled").default(!1),smsRecipient:i("sms_recipient"),userId:y("user_id").references(()=>X.id)}),ns=x(N).omit({id:!0,createdAt:!0})});var Me,Qt=_(()=>{"use strict";Me=[{id:"larson-4512",name:"Larson Gold Leaf 4512",manufacturer:"Larson-Juhl",material:"wood",width:"2.5",depth:"1.75",price:"12.99",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#D4AF37"},{id:"larson-210286",name:"Larson Academie Black 210286",manufacturer:"Larson-Juhl",material:"wood",width:"1.25",depth:"0.75",price:"8.50",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#000000"},{id:"larson-655320",name:"Larson Biltmore Gold 655320",manufacturer:"Larson-Juhl",material:"wood",width:"1.5",depth:"0.875",price:"10.75",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#FFD700"},{id:"larson-460530",name:"Larson Ventura Silver 460530",manufacturer:"Larson-Juhl",material:"metal",width:"0.75",depth:"1.125",price:"9.25",catalogImage:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#C0C0C0"},{id:"larson-310445",name:"Larson Classic Walnut 310445",manufacturer:"Larson-Juhl",material:"wood",width:"2.0",depth:"1.25",price:"14.50",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#8B4513"},{id:"larson-220158",name:"Larson Heritage Cherry 220158",manufacturer:"Larson-Juhl",material:"wood",width:"1.75",depth:"1.0",price:"11.25",catalogImage:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1582131503261-fca1d1c0589f?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#722F37"},{id:"nielsen-71",name:"Nielsen Florentine",manufacturer:"Nielsen",material:"metal",width:"1.25",depth:"0.75",price:"8.99",catalogImage:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",edgeTexture:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",corner:"https://images.unsplash.com/photo-1510172951991-856a654063f9?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8cGljdHVyZSUyMGZyYW1lfGVufDB8fDB8fHww",color:"#C0C0C0"},{id:"roma-250",name:"Roma Dark Walnut",manufacturer:"Roma Moulding",material:"wood",width:"3.0",depth:"2.0",price:"14.50",catalogImage:"https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#5C4033"},{id:"omega-102",name:"Omega Black Satin",manufacturer:"Omega Moulding",material:"wood",width:"2.0",depth:"1.5",price:"9.75",catalogImage:"https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#2D2D2D"},{id:"bella-35",name:"Bella White Simple",manufacturer:"Bella Moulding",material:"composite",width:"1.5",depth:"1.0",price:"6.50",catalogImage:"https://images.unsplash.com/photo-1574117936532-46e544aeb239?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjZ8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1574117936532-46e544aeb239?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjZ8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1574117936532-46e544aeb239?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjZ8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#F5F5F5"},{id:"larson-8921",name:"Larson Ornate Gold",manufacturer:"Larson-Juhl",material:"wood",width:"3.5",depth:"2.25",price:"18.99",catalogImage:"https://images.unsplash.com/photo-1581814605484-050c5bb1196c?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzF8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",edgeTexture:"https://images.unsplash.com/photo-1581814605484-050c5bb1196c?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzF8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",corner:"https://images.unsplash.com/photo-1581814605484-050c5bb1196c?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzF8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D",color:"#D4AF37"}]});async function Vt(){try{return console.log("Loading static matboard data to prevent application freezing..."),[]}catch(o){return console.error("Error fetching Crescent matboards:",o),[]}}var Yt=_(()=>{"use strict"});var Zt,is,Fe,cs,Jt=_(()=>{"use strict";Yt();Zt=[{id:"white",name:"White",color:"#FFFFFF",price:"0.02",manufacturer:"Basic",code:"WHT",description:"Pure white mat board",category:"Standard"},{id:"black",name:"Black",color:"#2C2C2C",price:"0.025",manufacturer:"Basic",code:"BLK",description:"Deep black mat board",category:"Standard"},{id:"grey",name:"Grey",color:"#ADADAD",price:"0.02",manufacturer:"Basic",code:"GRY",description:"Neutral grey mat board",category:"Standard"},{id:"beige",name:"Beige",color:"#F5F5DC",price:"0.02",manufacturer:"Basic",code:"BGE",description:"Soft beige mat board",category:"Standard"}],is=[{id:"crescent-white",name:"Bright White",color:"#FFFFFF",price:"0.025",manufacturer:"Crescent",code:"S100",description:"Bright white conservation mat board",category:"Whites"},{id:"crescent-cream",name:"Cream",color:"#FFF8E1",price:"0.025",manufacturer:"Crescent",code:"S101",description:"Cream white conservation mat board",category:"Whites"},{id:"crescent-antique",name:"Antique White",color:"#F5F1E6",price:"0.025",manufacturer:"Crescent",code:"S102",description:"Subtle antique white tone",category:"Whites"},{id:"crescent-stone",name:"Stone",color:"#E0DCCC",price:"0.027",manufacturer:"Crescent",code:"S200",description:"Light stone grey conservation mat",category:"Neutrals"},{id:"crescent-fog",name:"Fog",color:"#D6D6D6",price:"0.027",manufacturer:"Crescent",code:"S201",description:"Subtle fog grey conservation mat",category:"Neutrals"},{id:"crescent-granite",name:"Granite",color:"#A9A9A9",price:"0.027",manufacturer:"Crescent",code:"S202",description:"Darker granite grey tone",category:"Neutrals"},{id:"crescent-colonial-blue",name:"Colonial Blue",color:"#B5C7D3",price:"0.029",manufacturer:"Crescent",code:"S300",description:"Subtle colonial blue conservation mat",category:"Blues"},{id:"crescent-wedgewood",name:"Wedgewood",color:"#6E99C0",price:"0.029",manufacturer:"Crescent",code:"S301",description:"Classic wedgewood blue conservation mat",category:"Blues"},{id:"crescent-ultramarine",name:"Ultramarine",color:"#4166B0",price:"0.029",manufacturer:"Crescent",code:"S302",description:"Deep ultramarine blue conservation mat",category:"Blues"},{id:"crescent-sage",name:"Sage",color:"#BCCCBA",price:"0.029",manufacturer:"Crescent",code:"S400",description:"Soft sage green conservation mat",category:"Greens"},{id:"crescent-celadon",name:"Celadon",color:"#9CB084",price:"0.029",manufacturer:"Crescent",code:"S401",description:"Classic celadon green conservation mat",category:"Greens"},{id:"crescent-forest",name:"Forest",color:"#4A6741",price:"0.029",manufacturer:"Crescent",code:"S402",description:"Deep forest green conservation mat",category:"Greens"},{id:"crescent-sand",name:"Sand",color:"#E6D7B8",price:"0.027",manufacturer:"Crescent",code:"S500",description:"Light sand beige conservation mat",category:"Earth Tones"},{id:"crescent-chamois",name:"Chamois",color:"#D9BC8C",price:"0.027",manufacturer:"Crescent",code:"S501",description:"Warm chamois tan conservation mat",category:"Earth Tones"},{id:"crescent-chestnut",name:"Chestnut",color:"#A67B5B",price:"0.027",manufacturer:"Crescent",code:"S502",description:"Rich chestnut brown conservation mat",category:"Earth Tones"},{id:"crescent-pale-rose",name:"Pale Rose",color:"#F0D4D4",price:"0.029",manufacturer:"Crescent",code:"S600",description:"Subtle pale rose conservation mat",category:"Warm Tones"},{id:"crescent-dusty-rose",name:"Dusty Rose",color:"#D4A9A9",price:"0.029",manufacturer:"Crescent",code:"S601",description:"Classic dusty rose conservation mat",category:"Warm Tones"},{id:"crescent-rust",name:"Rust",color:"#B56A55",price:"0.029",manufacturer:"Crescent",code:"S602",description:"Deep rust red conservation mat",category:"Warm Tones"},{id:"crescent-black",name:"Raven Black",color:"#1A1A1A",price:"0.03",manufacturer:"Crescent",code:"S700",description:"Deep black conservation mat board",category:"Black"}],Fe=[...Zt,...is],cs=async()=>{if(typeof window>"u"){console.log("Skipping Supabase fetch on server-side");return}try{console.log("Fetching Crescent matboards from Larson Juhl catalog...");let o=await Vt();if(o&&o.length>0){console.log("Converting API matboards to MatColor format");let t=o.map(r=>({id:r.id,name:r.name,color:r.hex_color||"#FFFFFF",price:r.price,manufacturer:r.manufacturer,code:r.code||null,description:r.description||null,category:r.category||null}));Fe=[...Zt,...t],console.log(`Loaded and converted ${o.length} Crescent matboards from Larson Juhl catalog`)}else console.log("No Crescent matboards found in Larson Juhl catalog or empty response. Using static fallback data.")}catch(o){console.error("Failed to load Crescent matboards:",o),console.log("Using static Crescent matboard catalog as fallback.")}};typeof window<"u"&&cs()});var Ue,Ge,Xt=_(()=>{"use strict";Ue=[{id:"none",name:"No Glass",description:"No glass protection",price:"0.00"},{id:"regular",name:"Regular Glass",description:"Standard protection",price:"0.08"},{id:"uv",name:"Museum Glass",description:"Museum non-glare",price:"0.45"},{id:"museum",name:"Conservation Glass",description:"Premium UV protection",price:"0.25"}],Ge=[{id:"float-mount",name:"Float Mount",description:"Artwork appears to float",price:"50.00"},{id:"glass-float",name:"Glass Float",description:"Suspended between glass",price:"55.00"},{id:"shadowbox",name:"Shadowbox",description:"For 3D objects",price:"65.00"},{id:"labor-30min",name:"Additional Labor (30 min)",description:"Custom work",price:"30.00"},{id:"labor-1hour",name:"Additional Labor (1 hour)",description:"Custom work",price:"55.00"}]});import{createClient as us}from"@supabase/supabase-js";var Ke,er=_(()=>{"use strict";Ke=null;try{let o=process.env.SUPABASE_URL||process.env.VITE_SUPABASE_URL,t=process.env.SUPABASE_KEY||process.env.VITE_SUPABASE_KEY||process.env.VITE_SUPABASE_ANON_KEY;o&&t?(Ke=us(o,t),console.log("Server: Successfully initialized Supabase client")):(Ke={from:()=>({select:()=>Promise.resolve({data:[],error:null}),insert:()=>Promise.resolve({data:[],error:null}),update:()=>Promise.resolve({data:[],error:null}),delete:()=>Promise.resolve({data:null,error:null}),upsert:()=>Promise.resolve({data:null,error:null})}),rpc:()=>Promise.resolve({data:null,error:null})},console.log("Server: Using mock Supabase client - data operations will be handled by Drizzle/PostgreSQL"))}catch(o){console.error("Server: Error initializing Supabase client:",o),Ke={from:()=>({select:()=>Promise.resolve({data:[],error:null}),insert:()=>Promise.resolve({data:[],error:null}),update:()=>Promise.resolve({data:[],error:null}),delete:()=>Promise.resolve({data:null,error:null}),upsert:()=>Promise.resolve({data:null,error:null})}),rpc:()=>Promise.resolve({data:null,error:null})}}});import{Pool as ls,neonConfig as ds}from"@neondatabase/serverless";import{drizzle as ms}from"drizzle-orm/neon-serverless";import ps from"ws";var gs,u,re=_(()=>{"use strict";te();er();ds.webSocketConstructor=ps;if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL must be set. Did you forget to provision a database?");gs=new ls({connectionString:process.env.DATABASE_URL}),u=ms({client:gs,schema:ut})});function ze(o,t){let e=new Date().toISOString(),r=t?`[${t}]`:"";console.log(`${e} ${r} ${o}`)}var tr=_(()=>{"use strict"});function lt(o,t,e,r){let s=o/t,a=e+r;return s/a}function fs(o){return o>=40?2.2:o>=25?2.4:o>=15?2.6:o>=10?2.8:o>=6?3:o>=4?3.2:o>=2?3.5:4}function rr(o,t,e,r){let s=o+e*2,a=t+e*2,c=(s+a)/12*r,d=fs(c);return c*d}function or(o,t,e,r){let s=o+e*2,a=t+e*2,n=s+a,l=n*r*2.5,c=5.5;n<=24?c=5.5:n<=36?c=5:n<=50?c=4.5:n<=68?c=4.2:n<=88?c=3.8:n<=108?c=3.5:c=3.2;let d=hs(n);return l*c+d}function sr(o,t,e,r){let s=o+e*2,a=t+e*2,n=s+a,l=n*r,c=4;return n<=24?c=4:n<=36?c=3.8:n<=50?c=3.5:n<=68?c=3.2:n<=88?c=3:n<=108?c=2.8:c=2.5,l*c}function hs(o){let t=15;return o<=24?t=15:o<=36?t=20:o<=50?t=25:o<=68?t=35:o<=88?t=45:o<=108?t=55:t=65,t}var ar=_(()=>{"use strict"});var cr={};ae(cr,{calculateFramePrice:()=>ys,calculateFramingPrice:()=>_s,calculateGlassPrice:()=>ws,calculateMatPrice:()=>bs});function ys(o,t){let e=t*6,r=Ss(e);return o*t*r*1.2}function bs(o,t,e){let r=vs(e);return t*o*r}function ws(o,t,e=0,r=0,s="regular"){let a=e&&r?e+r:Math.sqrt(t)*2,n=Is(a),l=1;switch(s){case"conservation":l=1.5;break;case"museum":l=2;break}let c=t/144;return(a<=40?85:125)+c*o*n*.35*l}function Ss(o){return o<=20?1.8:o<=40?2.2:o<=60?2.6:o<=80?3:3.4}function Is(o){return o<=20?2.8:o<=40?3.2:o<=60?3.6:o<=80?4:4.5}function vs(o){return o<=20?2.5:o<=40?2.8:o<=60?3.1:o<=80?3.4:3.8}function Os(o,t,e,r){let s=r/40;return{frameAssembly:o?.25*s:0,matCutting:t?.3*s:0,glassCutting:e?.15*s:0,fitting:.2*s,finishing:.1*s}}function Cs(o,t,e){return(o.frameAssembly+o.matCutting+o.glassCutting+o.fitting+o.finishing)*t*e}async function _s(o){let{frameId:t,matColorId:e,glassOptionId:r,artworkWidth:s,artworkHeight:a,matWidth:n,quantity:l,includeWholesalePrices:c=!1}=o,d=t&&t!=="none"?await b.getFrame(t):null,m=e&&e!=="none"?await b.getMatColor(e):null,D=r&&r!=="none"?await b.getGlassOption(r):null,oe=s+a,Y=s+n*2,Z=a+n*2,E=Y+Z,se=Y*Z-s*a,B=Y*2+Z*2,v=c?{frame:d?d.price:"0.00",mat:"0.00",glass:D&&D.price||"0.00",backing:"0.00"}:void 0,xe=0;if(d){let pe=parseFloat(d.price);if(xe=rr(s,a,n,pe),v){let Se=s+n*2,Ie=a+n*2,J=(Se+Ie)/12*pe;v.frame=J.toFixed(2)}}let tt=0;if(m){let q=lt(45.5,25,32,40);if(tt=or(s,a,n,q),v){let J=s+n*2,ve=a+n*2,Oe=(J+ve)*q;v.mat=Oe.toFixed(2)}}let rt=0;if(D){let q=lt(125,10,24,36);if(rt=sr(s,a,n,q),v){let J=s+n*2,ve=a+n*2,Oe=(J+ve)*q;v.glass=Oe.toFixed(2)}}let Et=.04,Bt=Y*Z,Lt=Bt*Et*xs;v&&(v.backing=(Bt*Et).toFixed(2));let qt=Os(!!d,!!m,!!D,E),ot=Cs(qt,ir,nr),$t=xe+tt+rt+Lt,Pe=$t+ot,xo=Pe*l,Tt;if(c&&v){let pe=d?parseFloat(d.price)*B/12:0,Se=m?parseFloat(v.mat):0,Ie=D&&D.price?parseFloat(D.price)*Y*Z/144:0,$e=parseFloat(v.backing),q=pe+Se+Ie+$e,J=q*Ps,ve=q+J+ot,Te=Pe-ve,Oe=Te/Pe,Po=Pe/q;Tt={totalWholesaleCost:q,overheadCost:J,grossProfit:Te,grossProfitMargin:Oe,markupMultiplier:Po}}return{framePrice:xe,matPrice:tt,glassPrice:rt,backingPrice:Lt,laborCost:ot,materialCost:$t,subtotal:Pe,totalPrice:xo,wholesalePrices:v,laborRates:{baseRate:ir,regionalFactor:nr,estimates:qt},profitability:Tt}}var xs,nr,ir,Ps,ur=_(()=>{"use strict";ie();ar();xs=1.2,nr=1.15,ir=45,Ps=.3});import As from"axios";async function dt(o){try{let t=await As.post(`${Ms}/api/notifications/send`,{to:o.to,subject:o.subject,message:o.message,orderId:o.orderId,customerName:o.customerName,type:o.type||"order_update",source:"Jays Frames POS",method:"email",deliveryType:"email"},{headers:{Authorization:`Bearer ${Fs}`,"Content-Type":"application/json"},timeout:1e4});if(t.data&&t.data.success)console.log(`Email notification sent successfully to ${o.to} via SMS Hub`);else throw new Error(t.data?.error||"SMS Hub returned error response")}catch(t){throw console.error("SMS Hub Error:",t.message),t.response&&console.error("SMS Hub Response:",t.response.data),new Error(`Failed to send email notification via SMS Hub: ${t.message}`)}}async function lr(o,t,e,r,s){let a=`Hi ${e}, your order #${r} status has been updated to: ${s}. Thank you for choosing Jay's Frames!`;await dt({to:o,subject:`Order #${r} Update`,message:a,orderId:r,customerName:e,type:"status_update"})}var Ms,Fs,dr=_(()=>{"use strict";Ms="https://telitel-sms-hub-JayFrames.replit.app",Fs=process.env.SMS_HUB_API_KEY||"jays_frames_api_2025"});var pt={};ae(pt,{generateOrderStatusEmailTemplate:()=>ks,sendEmailWithSendGrid:()=>mt,sendOrderStatusUpdate:()=>Ne});async function mt(o){console.log("Using SMS Hub instead of SendGrid for notifications");try{await dt({to:o.to,subject:o.subject,message:o.text||Ns(o.html||""),type:"email_replacement"})}catch(t){throw console.error("SMS Hub notification error:",t.message),new Error(`Failed to send notification via SMS Hub: ${t.message}`)}}function Ns(o){return o.replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").trim()}function ks(o,t,e,r){let s=e.split("_").map(m=>m.charAt(0).toUpperCase()+m.slice(1)).join(" "),a=r?new Date(r).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}):"Not available",n=["order_processed","scheduled","materials_ordered","materials_arrived","frame_cut","mat_cut","prepped","completed"],l=n.indexOf(e),d=`
    <div style="margin: 20px 0; width: 100%;">
      <div style="width: 100%; background-color: #f0f0f0; height: 20px; border-radius: 10px; overflow: hidden;">
        <div style="width: ${Math.max(10,Math.min(100,Math.round((l+1)/n.length*100)))}%; background-color: #4CAF50; height: 20px;"></div>
      </div>
      <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 12px;">
        <span>Order Placed</span>
        <span>In Production</span>
        <span>Completed</span>
      </div>
    </div>
  `;return`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <title>Order Status Update</title>
      <style>
        body {
          font-family: Arial, sans-serif;
          line-height: 1.6;
          color: #333;
          margin: 0;
          padding: 0;
        }
        .container {
          max-width: 600px;
          margin: 0 auto;
          padding: 20px;
        }
        .header {
          background-color: #4A90E2;
          color: white;
          padding: 20px;
          text-align: center;
        }
        .content {
          padding: 20px;
          background-color: #f9f9f9;
        }
        .footer {
          text-align: center;
          padding: 20px;
          font-size: 12px;
          color: #666;
        }
        .button {
          display: inline-block;
          background-color: #4A90E2;
          color: white;
          padding: 10px 20px;
          text-decoration: none;
          border-radius: 5px;
          margin-top: 20px;
        }
        .status-box {
          background-color: #e8f4fd;
          border-left: 4px solid #4A90E2;
          padding: 15px;
          margin: 20px 0;
        }
        .details-table {
          width: 100%;
          border-collapse: collapse;
          margin: 20px 0;
        }
        .details-table th, .details-table td {
          border: 1px solid #ddd;
          padding: 10px;
          text-align: left;
        }
        .details-table th {
          background-color: #f0f0f0;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>Order Status Update</h1>
        </div>
        
        <div class="content">
          <p>Hello ${o},</p>
          
          <p>We're writing to provide you with an update on your custom framing order.</p>
          
          <div class="status-box">
            <h2>Order #${t} Status: ${s}</h2>
            <p>Your order is now in the <strong>${s}</strong> stage.</p>
            <p><strong>Estimated Completion:</strong> ${a}</p>
          </div>
          
          ${d}
          
          <h3>What's Next?</h3>
          <p>Your order is progressing through our custom framing process. Here's what's happening:</p>
          
          <table class="details-table">
            <tr>
              <th>Current Stage</th>
              <th>Description</th>
            </tr>
            <tr>
              <td>${s}</td>
              <td>${js(e)}</td>
            </tr>
          </table>
          
          <p>We'll notify you when your order moves to the next stage or is ready for pickup.</p>
          
          <a href="#" class="button">Track Your Order</a>
        </div>
        
        <div class="footer">
          <p>Thank you for choosing Jays Frames Guru Framing</p>
          <p>123 Frame Street, Anytown, ST 12345</p>
          <p>Phone: (555) 123-4567 | Email: info@jaysframes.com</p>
        </div>
      </div>
    </body>
    </html>
  `}async function Ne(o,t,e,r,s){console.log(`Sending order status update via SMS Hub for order #${e}`),await lr(o,"",t,e.toString(),r)}function js(o){switch(o){case"order_processed":return"Your order has been processed and is scheduled for production.";case"scheduled":return"Your order has been scheduled and is in our production queue.";case"materials_ordered":return"We have ordered the special materials needed for your custom frame.";case"materials_arrived":return"All materials for your order have arrived and are ready for production.";case"frame_cut":return"Your frame has been cut to the specified dimensions.";case"mat_cut":return"Your mat board has been cut and prepared for assembly.";case"prepped":return"Your frame is assembled and is going through final quality checks.";case"completed":return"Your order is complete and ready for pickup!";case"delayed":return"Your order is temporarily delayed. We will contact you with more information.";default:return"Your order is being processed by our team."}}var Qe=_(()=>{"use strict";dr()});import{eq as p,desc as ye,sql as mr,asc as gt}from"drizzle-orm";function he(o){let{material:t,name:e}=o,r=t.toLowerCase(),s=e.toLowerCase();return r.includes("gold")||s.includes("gold")?"#D4AF37":r.includes("silver")||r.includes("metal")||s.includes("silver")||s.includes("metal")||s.includes("chrome")||s.includes("steel")?"#C0C0C0":r.includes("black")||s.includes("black")||s.includes("ebony")||s.includes("onyx")?"#000000":r.includes("white")||s.includes("white")?"#F5F5F5":r.includes("walnut")||s.includes("walnut")?"#5C4033":r.includes("cherry")||s.includes("cherry")?"#722F37":r.includes("oak")||s.includes("oak")?"#D8BE75":r.includes("mahogany")||s.includes("mahogany")?"#4E2728":r.includes("maple")||s.includes("maple")?"#E8D4A9":"#8B4513"}var ft,b,ie=_(()=>{"use strict";te();Qt();Jt();Xt();re();tr();ft=class{async updateOrderArtLocation(t,e){try{let[r]=await u.update(h).set({artworkLocation:e}).where(p(h.id,t)).returning();if(!r)throw new Error("Order not found");return r}catch(r){throw console.error("Error updating order artwork location:",r),r}}async getOrderMats(t){try{let e=await u.select().from(_e).where(p(_e.orderId,t)),r=[];for(let s of e){let a=await this.getMatColor(s.matColorId);a&&r.push({...s,matboard:a})}return r}catch(e){return console.error(`Error getting order mats for order ${t}:`,e),[]}}async getOrderFrames(t){try{let e=await u.select().from(Ae).where(p(Ae.orderId,t)),r=[];for(let s of e){let a=await this.getFrame(s.frameId);a&&r.push({...s,frame:a})}return r}catch(e){return console.error(`Error getting order frames for order ${t}:`,e),[]}}async getOrderPricingDetails(t){try{let e=await this.getOrder(t);if(!e)return;let{calculatePricing:r}=(ur(),Ht(cr)),s=e.frameId?await this.getFrame(e.frameId):void 0,a=e.matColorId?await this.getMatColor(e.matColorId):void 0,n=e.glassOptionId?await this.getGlassOption(e.glassOptionId):void 0,l=await this.getOrderSpecialServices(t),c=await this.getOrderMats(t),d=await this.getOrderFrames(t),m={artworkWidth:Number(e.artworkWidth),artworkHeight:Number(e.artworkHeight),matWidth:Number(e.matWidth),frame:s,matColor:a,glassOption:n,specialServices:l,quantity:e.quantity||1,includeWholesalePrices:!0,mats:c.length>0?c:void 0,frames:d.length>0?d:void 0};return r(m)}catch(e){console.error("Error getting order pricing details:",e);return}}async getCustomer(t){let[e]=await u.select().from(P).where(p(P.id,t));return e||void 0}async getCustomerByEmail(t){let[e]=await u.select().from(P).where(p(P.email,t));return e||void 0}async getAllCustomers(){return await u.select().from(P)}async createCustomer(t){let[e]=await u.insert(P).values({...t,createdAt:new Date}).returning();return e}async updateCustomer(t,e){let[r]=await u.update(P).set(e).where(p(P.id,t)).returning();if(!r)throw new Error("Customer not found");return r}async getFrame(t){console.log(`Storage: Getting frame with ID: ${t}`);try{let[e]=await u.select().from(C).where(p(C.id,t));if(e){console.log(`Storage: Found frame in database: ${e.name}`);let s=he(e),a=e.catalogImage,n=e.corner||"",l=e.edgeTexture||"";if(e.manufacturer==="Larson-Juhl"){let c=e.id.split("-")[1];c&&(a=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_fab.jpg`,n=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_corner.jpg`,l=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_prof.jpg`)}if(e.manufacturer==="Nielsen"){let c=e.id.split("-")[1];c&&(a=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Detail.jpg`,n=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Corner.jpg`,l=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Edge.jpg`)}return{...e,catalogImage:a,corner:n,edgeTexture:l,color:s}}console.log("Storage: Frame not found in database, checking catalog");let r=Me.find(s=>s.id===t);if(r){console.log(`Storage: Found frame in catalog: ${r.name}`);let s=r.catalogImage,a=r.corner||"",n=r.edgeTexture||"",l=r.color||he(r);if(r.manufacturer==="Larson-Juhl"){let d=r.id.split("-")[1];d&&(s=`https://www.larsonjuhl.com/contentassets/products/mouldings/${d}_fab.jpg`,a=`https://www.larsonjuhl.com/contentassets/products/mouldings/${d}_corner.jpg`,n=`https://www.larsonjuhl.com/contentassets/products/mouldings/${d}_prof.jpg`)}if(r.manufacturer==="Nielsen"){let d=r.id.split("-")[1];d&&(s=`https://www.nielsenbainbridge.com/images/products/detail/${d}-Detail.jpg`,a=`https://www.nielsenbainbridge.com/images/products/detail/${d}-Corner.jpg`,n=`https://www.nielsenbainbridge.com/images/products/detail/${d}-Edge.jpg`)}let c={...r,catalogImage:s,corner:a,edgeTexture:n};console.log(`Storage: Inserting enhanced frame into database: ${c.name}`);try{await u.insert(C).values(c),console.log("Storage: Successfully inserted frame into database")}catch(d){console.error("Storage: Error inserting frame into database:",d)}return{...c,color:l}}console.log("Storage: Frame not found in catalog");return}catch(e){console.error(`Storage: Error in getFrame(${t}):`,e);let r=Me.find(s=>s.id===t);if(r){let s=he(r),a=r.catalogImage;if(r.manufacturer==="Larson-Juhl"){let n=r.id.split("-")[1];n&&(a=`https://www.larsonjuhl.com/contentassets/products/mouldings/${n}_fab.jpg`)}else if(r.manufacturer==="Nielsen"){let n=r.id.split("-")[1];n&&(a=`https://www.nielsenbainbridge.com/images/products/detail/${n}-Detail.jpg`)}return{...r,catalogImage:a,color:s}}return}}async getAllFrames(){console.log("Storage: Getting all frames");try{let t=await u.select().from(C);return console.log(`Storage: Found ${t.length} frames in database`),t.length>0?(console.log("Storage: Enhancing existing frames with real wholesaler images"),t.map(r=>{let s=he(r),a=r.catalogImage,n=r.corner||"",l=r.edgeTexture||"";if(r.manufacturer==="Larson-Juhl"){let c=r.id.split("-")[1];c&&(a=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_fab.jpg`,n=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_corner.jpg`,l=`https://www.larsonjuhl.com/contentassets/products/mouldings/${c}_prof.jpg`)}if(r.manufacturer==="Nielsen"){let c=r.id.split("-")[1];c&&(a=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Detail.jpg`,n=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Corner.jpg`,l=`https://www.nielsenbainbridge.com/images/products/detail/${c}-Edge.jpg`)}return{...r,catalogImage:a,corner:n,edgeTexture:l,color:s}})):(console.log("Storage: No frames in database, returning enhanced catalog data"),Me.map(r=>{let s=r.catalogImage,a=r.corner||"",n=r.edgeTexture||"",l=r.color||he(r);if(r.manufacturer==="Larson-Juhl"){let d=r.id.split("-")[1];d&&(s=`https://www.larsonjuhl.com/contentassets/products/mouldings/${d}_fab.jpg`,a=`https://www.larsonjuhl.com/contentassets/products/mouldings/${d}_corner.jpg`,n=`https://www.larsonjuhl.com/contentassets/products/mouldings/${d}_prof.jpg`)}if(r.manufacturer==="Nielsen"){let d=r.id.split("-")[1];d&&(s=`https://www.nielsenbainbridge.com/images/products/detail/${d}-Detail.jpg`,a=`https://www.nielsenbainbridge.com/images/products/detail/${d}-Corner.jpg`,n=`https://www.nielsenbainbridge.com/images/products/detail/${d}-Edge.jpg`)}let c={...r,catalogImage:s,corner:a,edgeTexture:n};try{u.insert(C).values(c).execute()}catch(d){console.error(`Storage: Error inserting frame ${r.id} into database:`,d)}return{...c,color:l}}))}catch(t){return console.error("Storage: Error in getAllFrames:",t),Me.map(e=>{let r=he(e),s=e.id.split("-")[1],a=e.catalogImage;return e.manufacturer==="Larson-Juhl"?a="https://images.unsplash.com/photo-1594194208961-0fdf358251d3?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D":e.manufacturer==="Roma"?a="https://images.unsplash.com/photo-1579541591661-567c1ea5dc56?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBpY3R1cmUlMjBmcmFtZXxlbnwwfHwwfHx8MA%3D%3D":e.manufacturer==="Omega"?a="https://images.unsplash.com/photo-1513519245088-0e12902e5a38?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8ZnJhbWV8ZW58MHx8MHx8fDA%3D":a="https://images.unsplash.com/photo-1518998053901-5348d3961a04?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fGZyYW1lfGVufDB8fDB8fHww",{...e,catalogImage:a,color:r}})}}async updateFrame(t,e){let[r]=await u.update(C).set(e).where(p(C.id,t)).returning();if(!r)throw new Error("Frame not found");return r}async addFrame(t){console.log(`Storage: Adding new frame to database: ${t.name} (${t.id})`);try{let[e]=await u.insert(C).values(t).returning();return console.log("Storage: Successfully added frame to database"),e}catch(e){throw console.error("Storage: Error adding frame to database:",e),e}}async searchFramesByItemNumber(t){console.log(`Storage: Searching frames by item number: ${t}`);try{let e=await this.getAllFrames(),r=t.toLowerCase();return e.filter(s=>(s.id.split("-")[1]?.toLowerCase()||"").includes(r))}catch(e){return console.error("Storage: Error searching frames by item number:",e),[]}}async getMatColor(t){let[e]=await u.select().from(T).where(p(T.id,t));if(!e){let r=Fe.find(s=>s.id===t);if(r)return await u.insert(T).values(r),r}return e||void 0}async getAllMatColors(){let t=await u.select().from(T);return t.length===0?(await u.insert(T).values(Fe),Fe):t}async getGlassOption(t){let[e]=await u.select().from(G).where(p(G.id,t));if(!e){let r=Ue.find(s=>s.id===t);if(r)return await u.insert(G).values(r),r}return e||void 0}async getAllGlassOptions(){let t=await u.select().from(G);return t.length===0?(await u.insert(G).values(Ue),Ue):t}async getSpecialService(t){let[e]=await u.selectfrom(K).where(p(K.id,t));if(!e){let r=Ge.find(s=>s.id===t);if(r)return await u.insert(K).values(r),r}return e||void 0}async getAllSpecialServices(){let t=await u.select().from(K);return t.length===0?(await u.insert(K).values(Ge),Ge):t}async getOrderGroup(t){let[e]=await u.select().from(j).where(p(j.id,t));return e||void 0}async getActiveOrderGroupByCustomer(t){let[e]=await u.select().from(j).where(p(j.customerId,t));return e&&e.status==="open"?e:void 0}async getAllOrderGroups(){return await u.select().from(j)}async createOrderGroup(t){let[e]=await u.insert(j).values({...t,status:"open",createdAt:new Date}).returning();return e}async updateOrderGroup(t,e){let[r]=await u.update(j).set(e).where(p(j.id,t)).returning();if(!r)throw new Error("Order group not found");return r}async getOrderGroupsByCustomerId(t){try{console.log(`Storage: Getting order groups for customer ID: ${t}`);let e=await u.select().from(j).where(p(j.customerId,t));return console.log(`Storage: Found ${e.length} order groups for customer ID: ${t}`),e}catch(e){throw console.error("Storage: Error getting order groups by customer ID:",e),e}}async getOrdersByGroupId(t){return await u.select().from(h).where(p(h.orderGroupId,t))}async getOrder(t){let[e]=await u.select().from(h).where(p(h.id,t));return e||void 0}async getAllOrders(){try{console.log("Fetching orders from database...");let t=await u.select().from(h);return console.log(`Found ${t?.length||0} orders in database`),t||[]}catch(t){throw console.error("Error in getAllOrders:",t),t}}async createOrder(t){try{t.artworkImage||(console.log("Warning: Order created without artwork image, using placeholder"),t.artworkImage="placeholder-image.jpg"),console.log("DatabaseStorage.createOrder - Inserting order with data:",t);let[e]=await u.insert(h).values([t]).returning();return console.log("DatabaseStorage.createOrder - Order created successfully:",e),e}catch(e){throw console.error("DatabaseStorage.createOrder - Error creating order:",e),e}}async updateOrder(t,e){let[r]=await u.update(h).set(e).where(p(h.id,t)).returning();if(!r)throw new Error("Order not found");return r}async deleteOrder(t){await u.delete(h).where(p(h.id,t))}async createOrderSpecialService(t){let[e]=await u.insert(ge).values(t).returning();return e}async getOrderSpecialServices(t){let r=(await u.select().from(ge).where(p(ge.orderId,t))).map(a=>a.specialServiceId),s=[];for(let a of r)if(a){let n=await this.getSpecialService(a);n&&s.push(n)}return s}async getWholesaleOrder(t){let[e]=await u.select().from(z).where(p(z.id,t));return e||void 0}async getAllWholesaleOrders(){return await u.select().from(z)}async createWholesaleOrder(t){let[e]=await u.insert(z).values({...t,status:"pending",createdAt:new Date}).returning();return e}async updateWholesaleOrder(t,e){let[r]=await u.update(z).set(e).where(p(z.id,t)).returning();if(!r)throw new Error("Wholesale order not found");return r}async getOrdersByProductionStatus(t){return await u.select().from(h).where(p(h.productionStatus,t)).orderBy(h.lastStatusChange)}async updateOrderProductionStatus(t,e){let[r]=await u.select().from(h).where(p(h.id,t));if(!r)throw new Error("Order not found");let s=r.productionStatus,[a]=await u.update(h).set({productionStatus:e,lastStatusChange:new Date}).where(p(h.id,t)).returning();if(a.notificationsEnabled){let[n]=await u.select().from(P).where(p(P.id,r.customerId));if(n)try{let{sendOrderStatusUpdate:l}=await Promise.resolve().then(()=>(Qe(),pt)),c=await l(n.email,n.name,r.id,e,s,r.estimatedCompletionDays);await this.createCustomerNotification({customerId:n.id,orderId:r.id,notificationType:"status_update",channel:"email",subject:`Order #${r.id} Status Update: ${e}`,message:`Your order is now ${e.split("_").join(" ")}. Check your email for details.`,successful:c,previousStatus:s,newStatus:e,responseData:c?{sent:!0,timestamp:new Date().toISOString()}:{sent:!1,error:"Email failed to send"}}),console.log(`Status update email ${c?"sent":"failed"} for Order #${r.id} to ${n.email}`)}catch(l){console.error("Error sending status update email:",l),await this.createCustomerNotification({customerId:n.id,orderId:r.id,notificationType:"status_update",channel:"email",subject:`Order #${r.id} Status Update: ${e}`,message:`Your order is now ${e.split("_").join(" ")}.`,successful:!1,previousStatus:s,newStatus:e,responseData:{error:l.message}})}}return a}async getOrdersForKanban(){return(await u.select({order:h,customer:P}).from(h).leftJoin(P,p(h.customerId,P.id)).orderBy(h.lastStatusChange)).map(e=>({...e.order,customerName:e.customer?e.customer.name:"Unknown Customer",customerPhone:e.customer?.phone||"No phone",customerEmail:e.customer?.email||"No email"}))}async scheduleOrderForProduction(t,e){let[r]=await u.select().from(h).where(p(h.id,t));if(!r)throw new Error("Order not found");let[s]=await u.update(h).set({estimatedCompletionDays:e,productionStatus:"scheduled"}).where(p(h.id,t)).returning();if(s.notificationsEnabled){let[a]=await u.select().from(P).where(p(P.id,r.customerId));if(a){let n=new Date;n.setDate(n.getDate()+e),await this.createCustomerNotification({customerId:a.id,orderId:r.id,notificationType:"estimated_completion",channel:"email",subject:`Your Custom Framing Order #${r.id} Has Been Scheduled`,message:`Your custom framing order #${r.id} has been scheduled for production. The estimated completion date is ${n.toLocaleDateString()}.`,successful:!0,previousStatus:r.productionStatus,newStatus:"scheduled"})}}return s}async createCustomerNotification(t){let[e]=await u.insert(H).values({...t}).returning();return e}async getCustomerNotifications(t){return await u.select().from(H).where(p(H.customerId,t)).orderBy(H.sentAt,"desc")}async getNotificationsByOrder(t){return await u.select().from(H).where(p(H.orderId,t)).orderBy(H.sentAt,"desc")}async getMaterialOrder(t){let[e]=await u.select().from(M).where(p(M.id,t));return e}async getAllMaterialOrders(){try{let t=await u.execute(mr`
        SELECT column_name 
        FROM information_schema.columns 
        WHERE table_name = 'material_orders'
      `);return await u.execute(mr`
        SELECT * FROM material_orders
        ORDER BY created_at DESC
      `)}catch(t){return console.error("Error in getAllMaterialOrders:",t),[]}}async getMaterialOrdersByStatus(t){try{return await u.select().from(M).where(p(M.status,t)).orderBy(ye(M.createdAt))}catch(e){return console.error("Error in getMaterialOrdersByStatus:",e),[]}}async getMaterialOrdersByType(t){try{return await u.select().from(M).where(p(M.materialType,t)).orderBy(ye(M.createdAt))}catch(e){return console.error("Error in getMaterialOrdersByType:",e),[]}}async createMaterialOrder(t){console.log("Creating material order with data:",t);let e={...t};e.vendor&&!e.supplierName&&(e.supplierName=e.vendor,delete e.vendor),console.log("Cleaned data for material order creation:",e);try{let[r]=await u.insert(M).values([e]).returning();return console.log("Successfully created material order:",r.id),r}catch(r){throw console.error("Error creating material order:",r),r}}async updateMaterialOrder(t,e){console.log("updateMaterialOrder called with id:",t,"and data:",e);let r=typeof t=="string"&&!isNaN(parseInt(t))?parseInt(t):t,s={...e};s.vendor&&!s.supplierName&&(s.supplierName=s.vendor,delete s.vendor),console.log("Cleaned data for update:",s);try{let[a]=await u.update(M).set(s).where(p(M.id,r)).returning();return console.log("Successfully updated material order:",a.id),a}catch(a){throw console.error("Error updating material order:",a),a}}async deleteMaterialOrder(t){await u.delete(M).where(p(M.id,t))}async getAllInventoryItems(){try{return await u.select().from(I).orderBy(gt(I.name))}catch(t){return console.error("Error in getAllInventoryItems:",t),[]}}async getInventoryItem(t){try{let[e]=await u.select().from(I).where(p(I.id,t));return e}catch(e){console.error("Error in getInventoryItem:",e);return}}async getInventoryItemByBarcode(t){try{let[e]=await u.select().from(I).where(p(I.barcode,t));return e}catch(e){console.error("Error in getInventoryItemByBarcode:",e);return}}async createInventoryItem(t){try{t.sku||(t.sku=`INV-${Date.now().toString(36).toUpperCase()}`);let{initialQuantity:e,...r}=t,[s]=await u.insert(I).values([r]).returning();return e&&await this.createInventoryTransaction({itemId:s.id,type:"initial",quantity:e,unitCost:t.costPerUnit,notes:"Initial inventory setup"}),s}catch(e){throw console.error("Error in createInventoryItem:",e),e}}async updateInventoryItem(t,e){try{let[r]=await u.update(I).set({...e,updatedAt:new Date}).where(p(I.id,t)).returning();return r}catch(r){throw console.error("Error in updateInventoryItem:",r),r}}async deleteInventoryItem(t){try{await u.delete(ee).where(p(ee.itemId,t)),await u.delete(I).where(p(I.id,t))}catch(e){throw console.error("Error in deleteInventoryItem:",e),e}}async getLowStockItems(){try{let t=await u.select().from(I),e=[];for(let r of t){let s=await this.getItemCurrentStock(r.id);s<=Number(r.reorderLevel)&&e.push({...r,currentStock:s})}return e}catch(t){return console.error("Error in getLowStockItems:",t),[]}}async getItemCurrentStock(t){try{let e=await u.select().from(ee).where(p(ee.itemId,t)),r=0;for(let s of e){let a=Number(s.quantity);switch(s.type){case"purchase":case"initial":case"adjustment":r+=a;break;case"sale":case"scrap":r-=a;break}}return r}catch(e){return console.error("Error in getItemCurrentStock:",e),0}}async createInventoryTransaction(t){try{let[e]=await u.insert(ee).values([t]).returning();return t.type==="count"&&await u.update(I).set({lastCountDate:new Date,updatedAt:new Date}).where(p(I.id,t.itemId)),e}catch(e){throw console.error("Error in createInventoryTransaction:",e),e}}async getAllSuppliers(){try{return await u.select().from(F).orderBy(gt(F.name))}catch(t){return console.error("Error in getAllSuppliers:",t),[]}}async getSupplier(t){try{let[e]=await u.select().from(F).where(p(F.id,t));return e}catch(e){console.error("Error in getSupplier:",e);return}}async createSupplier(t){try{let[e]=await u.insert(F).values(t).returning();return e}catch(e){throw console.error("Error in createSupplier:",e),e}}async updateSupplier(t,e){try{let[r]=await u.update(F).set(e).where(p(F.id,t)).returning();return r}catch(r){throw console.error("Error in updateSupplier:",r),r}}async deleteSupplier(t){try{await u.delete(F).where(p(F.id,t))}catch(e){throw console.error("Error in deleteSupplier:",e),e}}async getAllInventoryLocations(){try{return await u.select().from(S).orderBy(gt(S.name))}catch(t){return console.error("Error in getAllInventoryLocations:",t),[]}}async getInventoryLocation(t){try{let[e]=await u.select().from(S).where(p(S.id,t));return e}catch(e){console.error("Error in getInventoryLocation:",e);return}}async createInventoryLocation(t){try{let[e]=await u.insert(S).values(t).returning();return e}catch(e){throw console.error("Error in createInventoryLocation:",e),e}}async getAllPurchaseOrders(){try{return await u.select().from(Q).orderBy(ye(Q.createdAt))}catch(t){return console.error("Error in getAllPurchaseOrders:",t),[]}}async getPurchaseOrder(t){try{let[e]=await u.select().from(Q).where(p(Q.id,t));return e}catch(e){console.error("Error in getPurchaseOrder:",e);return}}async createPurchaseOrderWithLines(t,e){try{let r=`PO-${Date.now().toString(36).toUpperCase()}`,s=0;for(let c of e){let d=Number(c.quantity)*Number(c.unitCost);s+=d}let a=s*.08,n=s+a+Number(t.shipping||0),[l]=await u.insert(Q).values({...t,subtotal:s.toString(),tax:a.toString(),total:n.toString()}).returning();for(let c of e){let d=Number(c.quantity)*Number(c.unitCost);await u.insert(We).values({...c,purchaseOrderId:l.id,lineTotal:d.toString()})}return l}catch(r){throw console.error("Error in createPurchaseOrderWithLines:",r),r}}async getInventoryValuation(){try{let t=await this.getAllInventoryItems(),e=0,r={};for(let a of t){let l=await this.getItemCurrentStock(a.id)*Number(a.costPerUnit);if(e+=l,a.categoryId){let d=(await this.getInventoryCategory(a.categoryId))?.name||"Uncategorized";r[d]||(r[d]=0),r[d]+=l}else r.Uncategorized||(r.Uncategorized=0),r.Uncategorized+=l}let s=Object.entries(r).map(([a,n])=>({category:a,value:n}));return{totalValue:e,itemCount:t.length,valuationByCategory:s}}catch(t){return console.error("Error in getInventoryValuation:",t),{totalValue:0,itemCount:0,valuationByCategory:[]}}}async getInventoryCategory(t){try{let[e]=await u.select().from(ne).where(p(ne.id,t));return e}catch(e){console.error("Error in getInventoryCategory:",e);return}}async generateRecommendedPurchaseOrders(){try{let t=await this.getLowStockItems(),e={};for(let r of t)if(r.supplierId){let s=await this.getSupplier(r.supplierId);s&&(e[s.id]||(e[s.id]={supplierId:s.id,supplierName:s.name,items:[]}),e[s.id].items.push({itemId:r.id,name:r.name,sku:r.sku,currentStock:await this.getItemCurrentStock(r.id),reorderLevel:Number(r.reorderLevel),reorderQuantity:Number(r.reorderQuantity||r.reorderLevel)}))}return Object.values(e)}catch(t){return console.error("Error in generateRecommendedPurchaseOrders:",t),[]}}async importInventoryFromCSV(t){try{return{success:!0,importedCount:0,errors:[]}}catch(e){return console.error("Error in importInventoryFromCSV:",e),{success:!1,importedCount:0,errors:["Failed to import CSV data"]}}}async exportInventoryToCSV(){try{return`id,sku,name,description,quantity
`}catch(t){throw console.error("Error in exportInventoryToCSV:",t),t}}async createNotification(t){let[e]=await u.insert(N).values([t]).returning();return e}async getNotification(t){let[e]=await u.select().from(N).where(p(N.id,t));return e||void 0}async getNotifications(t){let e=u.select().from(N).orderBy(ye(N.createdAt));return t&&(e=e.limit(t)),await e}async getUnreadNotifications(){return await u.select().from(N).where(p(N.read,!1)).orderBy(ye(N.createdAt))}async markNotificationAsRead(t){let[e]=await u.update(N).set({read:!0}).where(p(N.id,t)).returning();return e}async getNotificationsByUser(t){return await u.select().from(N).where(p(N.userId,t)).orderBy(ye(N.createdAt))}async getMaterialsPickList(){try{return[{id:"mat-pick-1",orderIds:[1,2],name:"Modern Black Frame Moulding",sku:"LJ-MB-001",supplier:"Larson-Juhl",type:"frame",quantity:25,status:"pending",priority:"high",notes:"Urgent for customer orders",orderDate:null,receiveDate:null},{id:"mat-pick-2",orderIds:[3],name:"White Core Matboard",sku:"CR-WC-003",supplier:"Crescent",type:"mat",quantity:50,status:"ordered",priority:"medium",notes:"Standard white matboard",orderDate:new Date(Date.now()-3*24*60*60*1e3).toISOString(),receiveDate:null},{id:"mat-pick-3",orderIds:[4,5],name:"Museum Glass 32x40",sku:"TV-MG-3240",supplier:"Tru Vue",type:"glass",quantity:15,status:"received",priority:"low",notes:"Premium conservation glass",orderDate:new Date(Date.now()-7*24*60*60*1e3).toISOString(),receiveDate:new Date(Date.now()-2*24*60*60*1e3).toISOString()},{id:"mat-pick-4",orderIds:[6],name:"Gold Leaf Frame Moulding",sku:"LJ-GL-007",supplier:"Larson-Juhl",type:"frame",quantity:12,status:"backorder",priority:"high",notes:"Custom gold finish",orderDate:new Date(Date.now()-5*24*60*60*1e3).toISOString(),receiveDate:null}]}catch(t){throw ze(`Error in getMaterialsPickList: ${t}`,"storage"),t}}async getMaterialsForOrder(t){try{return(await this.getMaterialsPickList()).filter(r=>r.orderIds.includes(t))}catch(e){throw ze(`Error in getMaterialsForOrder: ${e}`,"storage"),e}}async createPurchaseOrder(t){try{let r=(await this.getMaterialsPickList()).filter(n=>t.includes(n.id));if(r.length===0)throw new Error("No valid materials found for purchase order");let s=r.reduce((n,l)=>{let c=l.type==="frame"?25.99:l.type==="glass"?45.99:18.99;return n+l.quantity*c},0);return{id:"po-"+Date.now(),orderNumber:`PO-${new Date().getFullYear()}-${String(Math.floor(Math.random()*1e3)).padStart(3,"0")}`,materialIds:t,totalAmount:s,status:"draft",createdAt:new Date().toISOString(),expectedDeliveryDate:new Date(Date.now()+14*24*60*60*1e3).toISOString(),materials:r}}catch(e){throw ze(`Error in createPurchaseOrder: ${e}`,"storage"),e}}},b=new ft});import{randomBytes as Ls}from"crypto";import{eq as Hn,and as Wn}from"drizzle-orm";function qs(){return`JF${Ls(4).toString("hex")}`}async function St(o){try{let t=qs(),[e]=await u.insert(fe).values([{code:t,type:"customer_order",entityId:o.toString(),title:`Order #${o}`,description:`QR code for order #${o}`,active:!0}]).returning();return t}catch(t){throw console.error("Error generating QR code for order:",t?.message||t),new Error("Failed to generate QR code for order")}}var vr=_(()=>{"use strict";re();te()});var Or={};ae(Or,{getCustomerOrderStatusHistory:()=>Ws,getOrderStatusHistory:()=>Hs,notifyCustomerOfStatusChange:()=>Us,recordStatusChange:()=>Ts});import{sql as ke}from"drizzle-orm";async function Ts(o,t,e,r){try{await u.execute(ke`
      INSERT INTO order_status_history (order_id, previous_status, new_status, notes)
      VALUES (${o}, ${t}, ${e}, ${r||null})
    `);let[s]=await u.execute(ke`
      SELECT * FROM order_status_history 
      WHERE order_id = ${o}
      ORDER BY changed_at DESC LIMIT 1
    `);return s}catch(s){throw console.error("Error recording status change:",s),s}}async function Hs(o){try{return await u.execute(ke`
      SELECT * FROM order_status_history 
      WHERE order_id = ${o}
      ORDER BY changed_at DESC
    `)}catch(t){throw console.error("Error fetching order status history:",t),t}}async function Ws(o){try{return await u.execute(ke`
      SELECT h.*, o.id as order_id, o.frame_name, o.artwork_description
      FROM order_status_history h
      JOIN orders o ON h.order_id = o.id
      WHERE o.customer_id = ${o}
      ORDER BY h.changed_at DESC
    `)}catch(t){throw console.error("Error fetching customer order status history:",t),t}}async function Us(o,t,e){try{if(!o.customerId)return;let[r]=await u.execute(ke`
      SELECT * FROM customers WHERE id = ${o.customerId}
    `);return!r||!r.status_notifications_enabled?void 0:(await Ne(r.email,r.name,o.id,e,o.dueDate),!0)}catch(r){return console.error("Error notifying customer of status change:",r),!1}}var Cr=_(()=>{"use strict";re();Qe()});var je={};ae(je,{configureKanbanConnection:()=>At,generateApiKey:()=>Gs,getAllOrdersWithQrCodes:()=>vt,getIntegrationDocs:()=>zs,getIntegrationStatus:()=>Ks,getOrderWithQrCode:()=>It,receiveWebhook:()=>Ct,testIntegration:()=>_t,updateOrderStatus:()=>Ot});async function It(o,t){try{let{id:e}=o.params,r=parseInt(e);if(isNaN(r))return t.status(400).json({error:"Invalid order ID"});let s=await b.getOrder(r);if(!s)return t.status(404).json({error:"Order not found"});let a=await St(r);t.json({success:!0,order:{...s,qrCode:a}})}catch(e){console.error("Error fetching order with QR code:",e),t.status(500).json({error:e.message||"Failed to fetch order information"})}}async function vt(o,t){try{let{status:e,limit:r}=o.query,s=r?parseInt(r):void 0,a=await b.getOrders(e),n=s?a.slice(0,s):a,l=await Promise.all(n.map(async c=>{let d=await St(c.id);return{...c,qrCode:d}}));t.json({success:!0,count:l.length,orders:l})}catch(e){console.error("Error fetching orders with QR codes:",e),t.status(500).json({error:e.message||"Failed to fetch orders"})}}async function Ot(o,t){try{let{id:e}=o.params,{status:r,notes:s}=o.body,a=parseInt(e);if(isNaN(a))return t.status(400).json({error:"Invalid order ID"});if(!r)return t.status(400).json({error:"Status is required"});let n=await b.getOrder(a);if(!n)return t.status(404).json({error:"Order not found"});let l=await b.updateOrder(a,{status:r,notes:s||`Status updated via Integration API to: ${r}`});try{await(Cr(),Ht(Or)).addStatusHistory(a,{previousStatus:n.status,newStatus:r,changedBy:"Integration API",notes:s||"Status updated via Integration API"})}catch(c){console.warn("Could not log status history:",c)}t.json({success:!0,message:"Order status updated",order:l})}catch(e){console.error("Error updating order status:",e),t.status(500).json({error:e.message||"Failed to update order status"})}}async function Ct(o,t){try{let{source:e,event:r,data:s}=o.body;if(!e||!r)return t.status(400).json({error:"Source and event are required"});switch(console.log(`Received webhook from ${e}, event: ${r}`),e){case"qr_generator":if(r==="qr_generated"&&s&&s.orderId){let a=parseInt(s.orderId);await b.updateOrder(a,{hasQrCode:!0,qrCodeGeneratedAt:new Date,qrCodeData:s.qrData})}break;case"printing_system":if(r==="invoice_printed"&&s&&s.orderId){let a=parseInt(s.orderId);await b.updateOrder(a,{invoicePrinted:!0,printedAt:new Date})}break;default:console.log(`Unknown webhook source: ${e}`)}t.json({success:!0,message:`Webhook received from ${e} for event ${r}`})}catch(e){console.error("Error processing webhook:",e),t.status(500).json({error:e.message||"Failed to process webhook"})}}async function Gs(o,t){try{t.setHeader("Content-Type","application/json");let e=Date.now(),r=Math.random().toString(36).substring(2,15),s=`jf_api_${e}_${r}`,a={key:s,name:"Jay's Frames API Integration",permissions:["orders:read","orders:write","integration:webhook","pricing:read","catalog:read"],createdAt:new Date().toISOString(),lastUsed:null};console.log("New API Key generated:",s);let n={success:!0,...a,message:"API key generated successfully. Store this securely.",endpoints:{baseUrl:process.env.REPL_URL||`https://${process.env.REPL_SLUG}.${process.env.REPL_OWNER}.repl.co`,orders:"/api/integration/orders",webhook:"/api/integration/webhook",status:"/api/integration/status",pricing:"/api/pricing/calculate",catalog:"/api/vendor-catalog/frames"},authentication:{method:"Bearer Token",header:"Authorization",value:`Bearer ${s}`}};return t.status(200).json(n)}catch(e){console.error("Error generating API key:",e),t.setHeader("Content-Type","application/json"),t.status(500).json({success:!1,error:e.message||"Failed to generate API key"})}}async function _t(o,t){try{t.json({success:!0,message:"Integration API is working correctly",timestamp:new Date().toISOString(),endpoints:{baseUrl:process.env.REPL_URL||"https://your-repl-url.replit.dev",orders:"/api/integration/orders",webhook:"/api/integration/webhook",configureKanban:"/api/integration/configure-kanban"}})}catch(e){console.error("Error in test integration:",e),t.status(500).json({success:!1,error:e.message||"Integration test failed"})}}async function At(o,t){try{let{kanbanApiUrl:e,kanbanApiKey:r}=o.body;if(!e||!r)return t.status(400).json({success:!1,error:"Both kanbanApiUrl and kanbanApiKey are required"});try{let s=await fetch(`${e}/api/kanban/status`,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},timeout:5e3});if(!s.ok)throw new Error(`Connection test failed: ${s.status}`);let a=await s.json();t.json({success:!0,message:"Kanban connection configured successfully",kanbanStatus:a,configuration:{kanbanApiUrl:e,apiKeyConfigured:!0}})}catch(s){t.status(400).json({success:!1,error:`Failed to connect to Kanban app: ${s.message}`})}}catch(e){console.error("Error configuring Kanban connection:",e),t.status(500).json({success:!1,error:e.message||"Failed to configure Kanban connection"})}}async function Ks(o,t){try{t.json({success:!0,status:"active",integrations:{webhooks:{enabled:!0,endpointCount:0},apiAccess:{enabled:!0,lastGenerated:new Date().toISOString()}},endpoints:{baseUrl:process.env.REPL_URL||"https://your-repl-url.replit.dev",orders:"/api/integration/orders",webhook:"/api/integration/webhook"}})}catch(e){console.error("Error getting integration status:",e),t.status(500).json({success:!1,error:e.message||"Failed to get integration status"})}}async function zs(o,t){try{t.json({success:!0,documentation:{authentication:{method:"Bearer Token",header:"Authorization",example:"Authorization: Bearer YOUR_API_KEY"},endpoints:[{method:"GET",path:"/api/integration/orders",description:"Get all orders with QR codes",parameters:{status:"optional - filter by order status",limit:"optional - limit number of results"}},{method:"GET",path:"/api/integration/orders/:id",description:"Get specific order with QR code",parameters:{id:"required - order ID"}},{method:"PATCH",path:"/api/integration/orders/:id/status",description:"Update order status",body:{status:"required - new status",notes:"optional - status change notes"}},{method:"POST",path:"/api/integration/webhook",description:"Receive webhook notifications",body:{source:"required - webhook source",event:"required - event type",data:"optional - event data"}}],webhookEvents:["order.created","order.updated","order.completed","payment.received","qr.generated"]}})}catch(e){console.error("Error getting integration docs:",e),t.status(500).json({success:!1,error:e.message||"Failed to get integration documentation"})}}var be=_(()=>{"use strict";ie();vr()});var jt={};ae(jt,{addCustomer:()=>ga,customerProfiles:()=>me,getCustomerByEmail:()=>ma,getCustomerById:()=>pa,getCustomerByPhone:()=>da,updateCustomerDiscordId:()=>fa});function da(o){return me.find(t=>t.phone===o)}function ma(o){return me.find(t=>t.email===o)}function pa(o){return me.find(t=>t.id===o)}function ga(o){let t={...o,id:Math.max(...me.map(e=>e.id))+1};return me.push(t),t}function fa(o,t){let e=me.find(r=>r.id===o);return e?(e.discordUserId=t,!0):!1}var me,Rt=_(()=>{"use strict";me=[{id:1,name:"Jay Stevens",email:"joshuastevens100@gmail.com",phone:"+1 832 893-3794",preferences:{email:!0,sms:!0,discord:!0,inApp:!0},notes:"Primary contact - Business owner"}]});var Ee={};ae(Ee,{externalKanbanService:()=>ha});var Dt,ha,Be=_(()=>{"use strict";Dt=class{baseUrl;apiKey;constructor(){this.baseUrl=process.env.EXTERNAL_KANBAN_URL||"",this.apiKey=process.env.EXTERNAL_KANBAN_API_KEY||"",console.log("External Kanban Service initialized:",{hasUrl:!!this.baseUrl,hasApiKey:!!this.apiKey,baseUrl:this.baseUrl?`${this.baseUrl.substring(0,30)}...`:"Not configured"})}async fetchOrders(){if(!this.baseUrl||!this.apiKey)return console.log("Kanban configuration missing:",{hasUrl:!!this.baseUrl,hasApiKey:!!this.apiKey}),{success:!1,orders:[],error:"External Kanban URL or API key not configured"};console.log("Attempting to fetch orders from Kanban:",this.baseUrl);try{let t=await fetch(`${this.baseUrl}/api/orders`,{method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},timeout:1e4});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return{success:!0,orders:(await t.json()).orders?.map(s=>({id:s.orderId||s.id,orderNumber:s.orderId||s.orderNumber,customerName:s.customerName,artworkTitle:s.artworkTitle||s.description,frameSize:s.frameSize||`${s.width||0}x${s.height||0}`,status:this.mapExternalStatus(s.status),stage:s.stage||"pending",priority:s.priority||"standard",dueDate:s.dueDate,createdAt:s.createdAt,estimatedCompletion:s.estimatedCompletion,materials:s.materials||{frameType:s.frameType||"Unknown",matColor:s.matColor||"White",glass:s.glass||"Regular"}}))||[]}}catch(t){return console.error("Error fetching from external Kanban:",t),{success:!1,orders:[],error:t instanceof Error?t.message:"Unknown error"}}}async updateOrderStatus(t,e,r,s){if(!this.baseUrl||!this.apiKey)return console.error("External Kanban URL or API key not configured"),!1;try{return(await fetch(`${this.baseUrl}/api/orders/${t}/status`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({status:this.mapInternalToExternalStatus(e),stage:r,notes:s,updatedBy:"Jays Frames POS",timestamp:new Date().toISOString()}),timeout:1e4})).ok}catch(a){return console.error("Error updating external Kanban order:",a),!1}}mapExternalStatus(t){return{pending:"pending",in_progress:"in_production",in_production:"in_production",designing:"in_design",material_prep:"awaiting_materials",cutting:"in_production",assembly:"in_production",quality_check:"in_production",completed:"ready_for_pickup",ready:"ready_for_pickup",delivered:"completed",picked_up:"completed"}[t.toLowerCase()]||"pending"}mapInternalToExternalStatus(t){return{pending:"pending",in_design:"designing",awaiting_materials:"material_prep",in_production:"in_production",ready_for_pickup:"completed",completed:"delivered"}[t]||"pending"}async healthCheck(){if(!this.baseUrl||!this.apiKey)return{status:"not_configured",connected:!1};try{let t=await fetch(`${this.baseUrl}/api/health`,{method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},timeout:5e3});return{status:t.ok?"connected":"error",connected:t.ok,lastSync:new Date().toISOString()}}catch{return{status:"error",connected:!1}}}},ha=new Dt});import et from"express";import{createServer as ya}from"http";import{WebSocketServer as ba,WebSocket as wa}from"ws";ie();import{z as ce}from"zod";var Rs=ce.object({orderId:ce.number(),location:ce.string(),artworkType:ce.string(),artworkDescription:ce.string(),artworkWidth:ce.number(),artworkHeight:ce.number()}),ht={async sendArtLocationData(o,t){try{let e=Rs.parse(o.body),r=await b.updateOrderArtLocation(e.orderId,e.location);t.status(200).json({success:!0,message:"Art location data recorded successfully",data:r})}catch(e){console.error("Error recording art location data:",e),t.status(500).json({success:!1,message:"Failed to record art location data",error:e instanceof Error?e.message:"Unknown error"})}},async getArtLocationData(o,t){try{let e=Number(o.params.orderId);if(isNaN(e))return t.status(400).json({success:!1,message:"Invalid order ID"});let r=await b.getOrder(e);if(!r)return t.status(404).json({success:!1,message:"Order not found"});t.status(200).json({orderId:r.id,location:r.artworkLocation||"",artworkType:r.artworkType||"",artworkDescription:r.artworkDescription||"",artworkWidth:r.artworkWidth||0,artworkHeight:r.artworkHeight||0})}catch(e){console.error("Error fetching art location data:",e),t.status(500).json({success:!1,message:"Failed to fetch art location data",error:e instanceof Error?e.message:"Unknown error"})}}};re();te();import{eq as pr}from"drizzle-orm";var yt={async saveFrameDesign(o,t){try{let{orderId:e,imageData:r}=o.body;if(!e||!r)return t.status(400).json({success:!1,message:"Order ID and image data are required"});await u.update(h).set({frameDesignImage:r}).where(pr(h.id,parseInt(e))),t.status(200).json({success:!0,message:"Frame design image saved successfully"})}catch(e){console.error("Error saving frame design:",e),t.status(500).json({success:!1,message:"Failed to save frame design image",error:e instanceof Error?e.message:"Unknown error"})}},async getFrameDesign(o,t){try{let e=o.params.orderId;if(!e)return t.status(400).json({success:!1,message:"Order ID is required"});let[r]=await u.select({frameDesignImage:h.frameDesignImage}).from(h).where(pr(h.id,parseInt(e)));if(!r||!r.frameDesignImage)return t.status(404).json({success:!1,message:"Frame design image not found"});t.status(200).json({success:!0,imageData:r.frameDesignImage})}catch(e){console.error("Error retrieving frame design:",e),t.status(500).json({success:!1,message:"Failed to retrieve frame design image",error:e instanceof Error?e.message:"Unknown error"})}}};var bt={kanban_admin_key_2025_full_access:{name:"3D Designer Integration",permissions:["orders:create","orders:read","orders:update","pricing:read","files:upload"],created:new Date().toISOString(),lastUsed:null},jf_houston_heights_framing_2025_master_api_key_secure_access:{name:"Houston Heights Framing API Integration",permissions:["orders:read","orders:write","integration:webhook","pricing:read","catalog:read"],created:new Date().toISOString(),lastUsed:null}};function wt(o,t,e){let r=o.headers.authorization;if(!r)return t.status(401).json({error:"Missing Authorization header",message:"API key required in Authorization header as: Bearer YOUR_API_KEY"});let s=r.replace("Bearer ","");if(bt[s])return bt[s].lastUsed=new Date().toISOString(),o.apiKey=bt[s],o.apiKeyType="static",e();try{o.apiKeyType="jwt",e()}catch{return t.status(401).json({error:"Invalid API key or JWT token",message:"The provided authentication token is not valid"})}}ie();import{Router as Ds}from"express";import Sn from"express-rate-limit";import vn from"helmet";import Cn from"csurf";import An from"cookie-parser";function L(o,t,e){console.log("verifyApiKey called for:",o.path),e()}var ue=Ds();ue.get("/orders",L,async(o,t)=>{try{let r=(await b.getAllOrders()).map(s=>({id:s.id,customerName:s.customerName,customerPhone:s.customerPhone,customerEmail:s.customerEmail,artworkTitle:s.artworkTitle,artworkWidth:s.artworkWidth,artworkHeight:s.artworkHeight,frameId:s.frameId,matId:s.matId,glassType:s.glassType,productionStatus:s.productionStatus,totalPrice:s.totalPrice,createdAt:s.createdAt,scheduledDate:s.scheduledDate,qrCode:s.qrCode,notes:s.notes}));t.json({success:!0,orders:r,count:r.length})}catch(e){console.error("Error fetching orders for hub:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch orders"})}});ue.get("/orders/:id",L,async(o,t)=>{try{let e=parseInt(o.params.id),r=await b.getOrder(e);if(!r)return t.status(404).json({success:!1,error:"Order not found"});t.json({success:!0,order:{id:r.id,customerName:r.customerName,customerPhone:r.customerPhone,customerEmail:r.customerEmail,artworkTitle:r.artworkTitle,artworkWidth:r.artworkWidth,artworkHeight:r.artworkHeight,frameId:r.frameId,matId:r.matId,glassType:r.glassType,productionStatus:r.productionStatus,totalPrice:r.totalPrice,createdAt:r.createdAt,scheduledDate:r.scheduledDate,qrCode:r.qrCode,notes:r.notes}})}catch(e){console.error("Error fetching order for hub:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch order"})}});ue.patch("/orders/:id/status",L,async(o,t)=>{try{let e=parseInt(o.params.id),{status:r,notes:s}=o.body,a=await b.updateOrder(e,{productionStatus:r,notes:s||void 0});if(!a)return t.status(404).json({success:!1,error:"Order not found"});t.json({success:!0,message:"Order status updated successfully",order:a})}catch(e){console.error("Error updating order status from hub:",e),t.status(500).json({success:!1,error:e.message||"Failed to update order status"})}});ue.get("/materials",L,async(o,t)=>{try{let e=await b.getAllMaterialOrders();t.json({success:!0,materialOrders:e,count:e.length})}catch(e){console.error("Error fetching material orders for hub:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch material orders"})}});ue.post("/webhook",L,async(o,t)=>{try{let{event:e,data:r}=o.body;switch(console.log("Received hub webhook:",e,r),e){case"order.status_changed":r.orderId&&r.status&&await b.updateOrder(r.orderId,{productionStatus:r.status,notes:r.notes||void 0});break;case"material.status_changed":r.materialOrderId&&r.status&&await b.updateMaterialOrder(r.materialOrderId,{status:r.status,notes:r.notes||void 0});break;default:console.log("Unknown webhook event:",e)}t.json({success:!0,message:"Webhook processed successfully"})}catch(e){console.error("Error processing hub webhook:",e),t.status(500).json({success:!1,error:e.message||"Failed to process webhook"})}});ue.get("/status",L,async(o,t)=>{try{let e=await b.getAllOrders(),r=await b.getAllMaterialOrders();t.json({success:!0,status:"online",timestamp:new Date().toISOString(),stats:{totalOrders:e.length,totalMaterialOrders:r.length,activeOrders:e.filter(s=>s.productionStatus!=="completed").length}})}catch(e){console.error("Error getting system status for hub:",e),t.status(500).json({success:!1,error:e.message||"Failed to get system status"})}});var gr=ue;import{Router as Bs}from"express";async function fr(o,t){try{t.setHeader("Content-Type","application/json");let e=Date.now(),r=Math.random().toString(36).substring(2,15),s=`hub_${e}_${r}`;console.log("Hub API Key generated:",s);let a={success:!0,apiKey:s,createdAt:new Date().toISOString(),permissions:["hub:read","hub:write","orders:sync"],message:"Hub API key generated successfully"};return t.status(200).json(a)}catch(e){return console.error("Error generating Hub API key:",e),t.setHeader("Content-Type","application/json"),t.status(500).json({success:!1,error:e.message||"Failed to generate API key"})}}async function hr(o,t){try{let e=process.env.REPL_URL||"https://your-repl-url.replit.dev";t.json({success:!0,connectionInfo:{baseUrl:e,endpoints:{getAllOrders:`${e}/api/hub/orders`,getOrder:`${e}/api/hub/orders/:id`,updateOrderStatus:`${e}/api/hub/orders/:id/status`,getMaterialOrders:`${e}/api/hub/materials`,webhook:`${e}/api/hub/webhook`,status:`${e}/api/hub/status`},authentication:{method:"Bearer Token",header:"Authorization",note:"Use the API key generated from /api/admin/generate-hub-key"},webhookEvents:["order.status_changed","material.status_changed"]}})}catch(e){console.error("Error getting hub connection info:",e),t.status(500).json({success:!1,error:e.message||"Failed to get connection info"})}}var xt=Bs();xt.post("/generate-hub-key",fr);xt.get("/hub-connection-info",hr);var Pt=xt;ie();var yr=async(o,t)=>{try{let e=await b.getMaterialsPickList();(!e||e.length===0)&&(e=[{id:"mat-001",name:"White Core Mat 16x20",type:"mat",supplier:"Crescent",status:"pending",quantity:"5",priority:"medium",notes:"For order #1234",price:"12.50",orderDate:null,receiveDate:null,supplierName:"Crescent"},{id:"frame-001",name:'Oak Frame 1.5" - 8ft',type:"frame",supplier:"Larson-Juhl",status:"ordered",quantity:"2",priority:"high",notes:"Rush order",price:"45.00",orderDate:new Date().toISOString(),receiveDate:null,supplierName:"Larson-Juhl"},{id:"glass-001",name:"Museum Glass 16x20",type:"glass",supplier:"Tru Vue",status:"received",quantity:"3",priority:"low",notes:"In stock",price:"28.99",orderDate:new Date(Date.now()-864e5).toISOString(),receiveDate:new Date().toISOString(),supplierName:"Tru Vue"}]),t.json({success:!0,data:e,message:"Materials loaded successfully"})}catch(e){console.error("Error in getMaterialsPickList:",e),t.status(500).json({message:e.message,materials:[]})}},br=async(o,t)=>{try{let r=(await b.getMaterialsPickList()||[]).reduce((s,a)=>{let n=a.supplier||"Unknown Supplier";return s[n]||(s[n]=[]),s[n].push(a),s},{});t.json(r)}catch(e){console.error("Error in getMaterialsBySupplier:",e),t.status(500).json({message:e.message,suppliers:{}})}},wr=async(o,t)=>{try{let e=parseInt(o.params.orderId);if(isNaN(e))return t.status(400).json({message:"Invalid order ID",materials:[]});let r=await b.getMaterialsForOrder(e);t.json(r||[])}catch(e){console.error("Error in getMaterialsForOrder:",e),t.status(500).json({message:e.message,materials:[]})}},xr=async(o,t)=>{try{let e=o.params.id,r;if(o.body.data)r=o.body.data;else{let{status:n,notes:l,orderDate:c,receiveDate:d,supplierName:m}=o.body;r={status:n,notes:l,orderDate:c,receiveDate:d,supplierName:m}}let s=Object.fromEntries(Object.entries(r).filter(([n,l])=>l!==void 0));console.log("Updating material order with data:",s);let a=await b.updateMaterialOrder(e,s);t.json(a)}catch(e){console.error("Error updating material:",e),t.status(500).json({message:e.message})}},Pr=async(o,t)=>{try{let{materialIds:e}=o.body;if(!e||!Array.isArray(e)||e.length===0)return t.status(400).json({message:"No materials selected"});let r=await b.createPurchaseOrder(e);t.status(201).json(r)}catch(e){t.status(500).json({message:e.message})}},Sr=async(o,t)=>{try{let e=await b.getMaterialsPickList(),r=Array.from(new Set((e||[]).map(s=>s.type).filter(Boolean)));t.json(r.length>0?r:["frame","mat","glass","hardware"])}catch(e){console.error("Error in getMaterialTypes:",e),t.status(500).json({message:e.message,types:["frame","mat","glass","hardware"]})}},Ir=async(o,t)=>{try{let e=await b.getMaterialsPickList(),r=Array.from(new Set((e||[]).map(s=>s.supplier).filter(Boolean)));t.json(r.length>0?r:["Larson-Juhl","Roma","Bella"])}catch(e){console.error("Error in getMaterialSuppliers:",e),t.status(500).json({message:e.message,suppliers:["Larson-Juhl","Roma","Bella"]})}};be();import{Router as Qs}from"express";be();var le=Qs();le.get("/orders/:id",L,It);le.get("/orders",L,vt);le.patch("/orders/:id/status",L,Ot);le.post("/webhook",L,Ct);le.get("/test",_t);le.post("/configure-kanban",At);var _r=le;import{Router as Ys}from"express";ie();import Mt from"axios";var R=process.env.KANBAN_API_URL||"https://kanban-app-url.replit.app",W=process.env.KANBAN_API_KEY;async function Ar(o){try{if(!W||!R){console.log("Kanban integration not configured, skipping sync");return}let t={orderId:o.id,customerName:o.customerName||"Unknown Customer",artworkTitle:o.artworkDescription,frameSize:`${o.artworkWidth}x${o.artworkHeight}`,status:o.productionStatus||"order_processed",stage:"pending",priority:"standard",dueDate:o.dueDate,createdAt:o.createdAt,estimatedCompletion:o.estimatedCompletionDays?new Date(Date.now()+o.estimatedCompletionDays*24*60*60*1e3).toISOString():null,materials:{frameType:o.frameId||"Unknown",matColor:o.matColorId||"White",glass:o.glassOptionId||"Regular"}},e=await Mt.post(`${R}/api/orders`,t,{headers:{Authorization:`Bearer ${W}`,"Content-Type":"application/json"},timeout:5e3});e.data&&e.data.success&&console.log(`Order ${o.id} synced to Kanban successfully`)}catch(t){console.error(`Failed to sync order ${o.id} to Kanban:`,t.message)}}async function Mr(o,t,e){try{if(!W||!R){console.log("Kanban integration not configured, skipping status update");return}let r=await Mt.post(`${R}/api/orders/${o}/status`,{status:t,stage:t,notes:e||`Status updated to ${t}`,updatedBy:"Jays Frames POS",timestamp:new Date().toISOString()},{headers:{Authorization:`Bearer ${W}`,"Content-Type":"application/json"},timeout:5e3});r.data&&r.data.success&&console.log(`Order ${o} status updated in Kanban to ${t}`)}catch(r){console.error(`Failed to update order ${o} status in Kanban:`,r.message)}}async function Vs(){try{if(!W)return console.log("No Kanban API key found, using local storage"),null;let o=await Mt.get(`${R}/api/orders`,{headers:{Authorization:`Bearer ${W}`,"Content-Type":"application/json"},timeout:5e3});return o.data&&o.data.success?o.data.orders:null}catch(o){return console.error("Failed to fetch orders from Kanban app:",o.message),null}}async function Fr(o,t){try{let e=await Vs();if(e&&e.length>0){console.log(`Fetched ${e.length} orders from Kanban app`);let s=e.map(a=>({id:a.orderId||a.id,customerName:a.customerName,customerPhone:a.customerPhone||"",customerEmail:a.customerEmail||"",artworkTitle:a.artworkTitle,artworkWidth:a.frameSize?parseFloat(a.frameSize.split("x")[0]):a.artworkWidth,artworkHeight:a.frameSize?parseFloat(a.frameSize.split("x")[1]):a.artworkHeight,frameId:a.materials?.frameType||a.frameId,matId:a.materials?.matColor||a.matId,glassType:a.materials?.glass||a.glassType||"Museum Glass",productionStatus:a.status||"pending",stage:a.stage||"material_prep",totalPrice:a.totalPrice||0,createdAt:a.createdAt,scheduledDate:a.dueDate||a.scheduledDate,estimatedCompletion:a.estimatedCompletion,priority:a.priority||"standard",qrCode:a.qrCode||"",notes:a.notes||""}));t.json({success:!0,orders:s,source:"kanban",count:s.length});return}console.log("Falling back to local storage for orders");let r=await b.getAllOrders();console.log("Local orders found:",r.length),t.json({success:!0,orders:r,source:"local",count:r.length})}catch(e){console.error("Error fetching orders:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch orders"})}}async function Nr(o,t){try{let{id:e}=o.params,r=await b.getOrder(parseInt(e));if(!r)return t.status(404).json({success:!1,error:"Order not found"});t.json({success:!0,order:r})}catch(e){console.error("Error fetching order:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch order"})}}async function kr(o,t){try{let e=o.body;if(console.log("Creating order with data:",e),!e.customerId)return t.status(400).json({success:!1,error:"Customer ID is required"});if(e.artworkImage||(console.log("Warning: Order created without artwork image"),e.artworkImage="placeholder-image.jpg"),!e.artworkWidth||!e.artworkHeight)return t.status(400).json({success:!1,error:"Artwork dimensions are required"});e.matWidth||(e.matWidth="2"),console.log("Processing order creation...");let r=await b.createOrder(e);console.log("Order created successfully:",r),await Ar(r),t.status(201).json({success:!0,order:r,message:"Order created successfully",orderId:r.id})}catch(e){console.error("Error creating order:",e),t.status(500).json({success:!1,error:e.message||"Failed to create order",details:e.stack})}}async function jr(o,t){try{let{id:e}=o.params,r=o.body,s=await b.updateOrder(parseInt(e),r);r.productionStatus&&await Mr(parseInt(e),r.productionStatus),t.json({success:!0,order:s,message:"Order updated successfully"})}catch(e){console.error("Error updating order:",e),t.status(500).json({success:!1,error:e.message||"Failed to update order"})}}async function Rr(o,t){try{let{id:e}=o.params,{status:r,notes:s}=o.body;if(!r)return t.status(400).json({success:!1,error:"Status is required"});let a=await b.updateOrder(parseInt(e),{productionStatus:r,lastStatusChange:new Date});await Mr(parseInt(e),r,s),t.json({success:!0,order:a,message:`Order status updated to ${r}`})}catch(e){console.error("Error updating order status:",e),t.status(500).json({success:!1,error:e.message||"Failed to update order status"})}}async function Dr(o,t){try{let{id:e}=o.params;await b.deleteOrder(parseInt(e)),t.json({success:!0,message:"Order deleted successfully"})}catch(e){console.error("Error deleting order:",e),t.status(500).json({success:!1,error:e.message||"Failed to delete order"})}}async function Er(o,t){try{let{orderId:e}=o.params;if(!W||!R)return t.json({success:!1,error:"Kanban integration not configured",config:{hasApiKey:!!W,hasApiUrl:!!R,apiUrl:R}});let r=await b.getOrder(parseInt(e));if(!r)return t.status(404).json({success:!1,error:"Order not found"});await Ar(r),t.json({success:!0,message:`Order ${e} synced to Kanban successfully`,order:{id:r.id,status:r.productionStatus,kanbanUrl:R}})}catch(e){console.error("Error testing Kanban sync:",e),t.status(500).json({success:!1,error:e.message||"Failed to test Kanban sync"})}}async function Br(o,t){try{t.json({success:!0,status:{configured:!!(W&&R),apiUrl:R,hasApiKey:!!W,endpoints:{orders:`${R}/api/orders`,statusUpdate:`${R}/api/orders/:id/status`}}})}catch(e){t.status(500).json({success:!1,error:e.message||"Failed to get Kanban status"})}}async function Lr(o,t){try{let e=await b.getAllOrderGroups();t.json({success:!0,orderGroups:e,count:e.length})}catch(e){console.error("Error fetching order groups:",e),t.status(500).json({success:!1,error:e.message||"Failed to fetch order groups"})}}async function qr(o,t){try{let e=o.body,r=await b.createOrderGroup(e);t.status(201).json({success:!0,orderGroup:r,message:"Order group created successfully"})}catch(e){console.error("Error creating order group:",e),t.status(500).json({success:!1,error:e.message||"Failed to create order group"})}}var $=Ys();$.get("/orders",Fr);$.get("/orders/:id",Nr);$.post("/orders",kr);$.patch("/orders/:id",jr);$.patch("/orders/:id/status",Rr);$.delete("/orders/:id",Dr);$.post("/orders/:orderId/test-kanban-sync",Er);$.get("/kanban/status",Br);$.get("/order-groups",Lr);$.post("/order-groups",qr);var $r=$;import{Router as Xs}from"express";re();te();import{eq as Zs,desc as Js}from"drizzle-orm";async function Tr(o,t){try{let e=await u.select().from(P).orderBy(Js(P.createdAt));return t.status(200).json(e)}catch(e){return console.error("Error fetching customers:",e),t.status(500).json({message:"Error fetching customers"})}}async function Hr(o,t){try{let{id:e}=o.params,r=parseInt(e);if(isNaN(r))return t.status(400).json({message:"Invalid customer ID"});let s=await u.select().from(P).where(Zs(P.id,r)).limit(1);return s.length===0?t.status(404).json({message:"Customer not found"}):t.status(200).json(s[0])}catch(e){return console.error("Error fetching customer:",e),t.status(500).json({message:"Error fetching customer"})}}async function Wr(o,t){try{let e=at.parse(o.body),[r]=await u.insert(P).values(e).returning();return t.status(201).json(r)}catch(e){return console.error("Error creating customer:",e),e.name==="ZodError"?t.status(400).json({message:"Invalid customer data",errors:e.errors}):t.status(500).json({message:"Error creating customer"})}}var Ve=Xs();Ve.get("/customers",Tr);Ve.get("/customers/:id",Hr);Ve.post("/customers",Wr);var Ur=Ve;import{Router as ea}from"express";re();te();import{eq as Re}from"drizzle-orm";async function Gr(o,t){try{let e=await u.select().from(S);return t.status(200).json(e)}catch(e){return console.error("Error fetching inventory locations:",e),t.status(500).json({message:"Error fetching inventory locations",details:e.message})}}async function Kr(o,t){try{let{id:e}=o.params,r=await u.select().from(S).where(Re(S.id,parseInt(e))).limit(1);return r.length===0?t.status(404).json({message:"Inventory location not found"}):t.status(200).json(r[0])}catch(e){return console.error("Error fetching inventory location:",e),t.status(500).json({message:"Error fetching inventory location",details:e.message})}}async function zr(o,t){try{let e=He.parse(o.body),[r]=await u.insert(S).values(e).returning();return t.status(201).json(r)}catch(e){return console.error("Error creating inventory location:",e),e.name==="ZodError"?t.status(400).json({message:"Invalid location data",errors:e.errors}):t.status(500).json({message:"Error creating inventory location",details:e.message})}}async function Qr(o,t){try{let{id:e}=o.params,r=He.parse(o.body),[s]=await u.update(S).set(r).where(Re(S.id,parseInt(e))).returning();return s?t.status(200).json(s):t.status(404).json({message:"Inventory location not found"})}catch(e){return console.error("Error updating inventory location:",e),e.name==="ZodError"?t.status(400).json({message:"Invalid location data",errors:e.errors}):t.status(500).json({message:"Error updating inventory location",details:e.message})}}async function Vr(o,t){try{let{id:e}=o.params,r=await u.select({count:u.fn.count()}).from(I).where(Re(I.locationId,parseInt(e)));return parseInt(r[0].count)>0?t.status(400).json({message:"Cannot delete location with assigned items. Move items to another location first."}):(await u.delete(S).where(Re(S.id,parseInt(e))).returning({id:S.id})).length===0?t.status(404).json({message:"Inventory location not found"}):t.status(200).json({message:"Inventory location deleted successfully"})}catch(e){return console.error("Error deleting inventory location:",e),t.status(500).json({message:"Error deleting inventory location",details:e.message})}}async function Yr(o,t){try{let e=await u.select({...I,locationName:S.name}).from(I).leftJoin(S,Re(I.locationId,S.id));return t.status(200).json(e||[])}catch(e){return console.error("Error fetching inventory items:",e),t.status(500).json({message:"Error fetching inventory items",details:e.message})}}async function Zr(o,t){try{return t.status(200).json([])}catch(e){return console.error("Error fetching low stock items:",e),t.status(500).json({message:"Error fetching low stock items",details:e.message})}}async function Jr(o,t){try{let e=await u.select().from(F);return t.status(200).json(e||[])}catch(e){return console.error("Error fetching suppliers:",e),t.status(500).json({message:"Error fetching suppliers",details:e.message})}}var V=ea();V.get("/inventory/locations",Gr);V.get("/inventory/locations/:id",Kr);V.post("/inventory/locations",zr);V.put("/inventory/locations/:id",Qr);V.delete("/inventory/locations/:id",Vr);V.get("/inventory/items",Yr);V.get("/inventory/items/low-stock",Zr);V.get("/inventory/suppliers",Jr);var Xr=V;import{Router as aa}from"express";import{parseString as ta}from"xml2js";import{promisify as ra}from"util";var oa=ra(ta),Ft=class{async parseVendorXmlPriceSheet(t){try{console.log("Parsing vendor XML price sheet...");let e=await oa(t),r=[];if(e.catalog?.items?.item){let s=Array.isArray(e.catalog.items.item)?e.catalog.items.item:[e.catalog.items.item];for(let a of s){let n={itemNumber:this.extractValue(a.sku||a.itemNumber||a.id),description:this.extractValue(a.description||a.name),width:this.extractValue(a.width),collection:this.extractValue(a.collection||a.series),manufacturer:this.extractValue(a.manufacturer||a.vendor||"Unknown"),wholesalePrice:this.extractNumericValue(a.wholesalePrice||a.cost||a.price),retailPrice:this.extractNumericValue(a.retailPrice||a.msrp),category:this.extractValue(a.category||a.type),inStock:this.extractBooleanValue(a.inStock||a.available),unitOfMeasure:this.extractValue(a.unitOfMeasure||a.uom||"each")};n.itemNumber&&n.wholesalePrice>0&&r.push(n)}}else if(e.products?.product){let s=Array.isArray(e.products.product)?e.products.product:[e.products.product];for(let a of s){let n={itemNumber:this.extractValue(a.$.id||a.$.sku),description:this.extractValue(a.name?.[0]||a.description?.[0]),width:this.extractValue(a.dimensions?.width?.[0]),collection:this.extractValue(a.collection?.[0]),manufacturer:this.extractValue(a.manufacturer?.[0]||"Unknown"),wholesalePrice:this.extractNumericValue(a.pricing?.wholesale?.[0]||a.cost?.[0]),retailPrice:this.extractNumericValue(a.pricing?.retail?.[0]),category:this.extractValue(a.category?.[0]),inStock:this.extractBooleanValue(a.inventory?.inStock?.[0]),unitOfMeasure:this.extractValue(a.unitOfMeasure?.[0]||"each")};n.itemNumber&&n.wholesalePrice>0&&r.push(n)}}return console.log(`Successfully parsed ${r.length} items from XML price sheet`),r}catch(e){throw console.error("Error parsing XML price sheet:",e),new Error(`Failed to parse XML price sheet: ${e.message}`)}}extractValue(t){return typeof t=="string"?t.trim():Array.isArray(t)&&t.length>0?String(t[0]).trim():t&&typeof t=="object"&&t._?String(t._).trim():""}extractNumericValue(t){let e=this.extractValue(t),r=parseFloat(e.replace(/[^0-9.-]/g,""));return isNaN(r)?0:r}extractBooleanValue(t){let e=this.extractValue(t).toLowerCase();return e==="true"||e==="yes"||e==="1"}convertToFrameFormat(t){return t.map(e=>({id:`vendor-${e.manufacturer.toLowerCase().replace(/\s+/g,"-")}-${e.itemNumber}`,name:`${e.collection?e.collection+" ":""}${e.description}`,manufacturer:e.manufacturer,material:this.inferMaterial(e.description,e.category),width:e.width||"",depth:"",price:e.wholesalePrice.toString(),catalogImage:"",color:this.inferColor(e.description),itemNumber:e.itemNumber,collection:e.collection||"",category:e.category||"",inStock:e.inStock!==!1,unitOfMeasure:e.unitOfMeasure}))}inferMaterial(t,e){let r=t.toLowerCase(),s=e?.toLowerCase()||"";return r.includes("wood")||s.includes("wood")?"wood":r.includes("metal")||s.includes("metal")?"metal":r.includes("plastic")||s.includes("plastic")?"plastic":r.includes("composite")||s.includes("composite")?"composite":"wood"}inferColor(t){let e=t.toLowerCase();return e.includes("black")?"#000000":e.includes("white")?"#FFFFFF":e.includes("brown")?"#8B4513":e.includes("gold")?"#FFD700":e.includes("silver")?"#C0C0C0":e.includes("red")?"#FF0000":e.includes("blue")?"#0000FF":"#8B4513"}},Nt=new Ft;re();te();async function eo(o,t){try{let{xmlContent:e,vendorName:r}=o.body;if(!e)return t.status(400).json({message:"XML content is required"});if(!r)return t.status(400).json({message:"Vendor name is required"});console.log(`Processing XML price sheet for vendor: ${r}`);let s=await Nt.parseVendorXmlPriceSheet(e);if(s.length===0)return t.status(400).json({message:"No valid price items found in XML"});let a=Nt.convertToFrameFormat(s),n=0,l=0;for(let c of a)try{(await u.select().from(C).where(eq(C.id,c.id)).limit(1)).length>0?(await u.update(C).set({name:c.name,manufacturer:c.manufacturer,material:c.material,width:c.width,price:c.price,color:c.color,updatedAt:new Date}).where(eq(C.id,c.id)),l++):(await u.insert(C).values({id:c.id,name:c.name,manufacturer:c.manufacturer,material:c.material,width:c.width,depth:c.depth,price:c.price,catalogImage:c.catalogImage,color:c.color,createdAt:new Date,updatedAt:new Date}),n++)}catch(d){console.error(`Error processing frame item ${c.id}:`,d)}console.log(`XML price sheet processing complete. Inserted: ${n}, Updated: ${l}`),t.json({message:"XML price sheet processed successfully",vendor:r,totalItems:s.length,inserted:n,updated:l,summary:{priceItems:s.slice(0,5),frameItems:a.slice(0,5)}})}catch(e){console.error("Error processing XML price sheet:",e),t.status(500).json({message:"Failed to process XML price sheet",error:e.message})}}async function to(o,t){t.json({supportedFormats:[{name:"Standard Catalog Format",structure:{catalog:{items:{item:[{sku:"item-number",description:"item-description",manufacturer:"vendor-name",wholesalePrice:"price",width:"frame-width",collection:"collection-name"}]}}}},{name:"Products Format",structure:{products:{product:[{$:{id:"item-number"},name:["item-description"],manufacturer:["vendor-name"],pricing:{wholesale:["price"]}}]}}}],requiredFields:["itemNumber","description","manufacturer","wholesalePrice"],optionalFields:["width","collection","retailPrice","category","inStock"]})}function sa(o,t,e){console.log("Auth middleware: Allowing request (authentication not implemented)"),e()}var ro=sa;var Ye=aa();Ye.use(ro);Ye.post("/upload",eo);Ye.get("/formats",to);var oo=Ye;import{Router as ua}from"express";var na=[{itemNumber:"10-036M",width:'5/8"',boxQty:360,collection:"Maple & Walnut - Garrett",basePricePerFoot:6.62,boxPrice:10.05,lengthPrice:13.52,chopPrice:14.52},{itemNumber:"10-100M",width:'5/8"',boxQty:375,collection:"Maple & Walnut - Garrett",basePricePerFoot:6.34,boxPrice:9.71,lengthPrice:12.75,chopPrice:13.75},{itemNumber:"10-507M",width:'5/8"',boxQty:306,collection:"Museum Stems - Garrett",basePricePerFoot:6.52,boxPrice:9.91,lengthPrice:13,chopPrice:14},{itemNumber:"100172",width:'1/4"',boxQty:1600,collection:"Olmsted",basePricePerFoot:2.75,boxPrice:4.64,lengthPrice:7.28,chopPrice:8.28},{itemNumber:"100750",width:'1/4"',boxQty:1200,collection:"Sofia",basePricePerFoot:2.63,boxPrice:4.04,lengthPrice:6.73,chopPrice:7.73},{itemNumber:"100751",width:'1/4"',boxQty:1587,collection:"Sofia",basePricePerFoot:2.63,boxPrice:4.04,lengthPrice:6.73,chopPrice:7.73},{itemNumber:"100752",width:'1/4"',boxQty:1e3,collection:"Sofia",basePricePerFoot:2.63,boxPrice:4.04,lengthPrice:6.73,chopPrice:7.73},{itemNumber:"102CG",width:'1/2"',boxQty:432,collection:"Marquis",basePricePerFoot:1.74,boxPrice:3.7,lengthPrice:6.43,chopPrice:7.43},{itemNumber:"102CS",width:'1/2"',boxQty:432,collection:"Marquis",basePricePerFoot:1.74,boxPrice:3.7,lengthPrice:6.43,chopPrice:7.43},{itemNumber:"103180",width:'9/16"',boxQty:900,collection:"Hudson",basePricePerFoot:1.46,boxPrice:3.11,lengthPrice:5.56,chopPrice:6.56},{itemNumber:"103190",width:'9/16"',boxQty:900,collection:"Hudson",basePricePerFoot:1.4,boxPrice:2.97,lengthPrice:5.3,chopPrice:6.3},{itemNumber:"103235",width:'5/16"',boxQty:1200,collection:"Academie",basePricePerFoot:1.44,boxPrice:3.17,lengthPrice:5.64,chopPrice:6.64},{itemNumber:"103237",width:'5/16"',boxQty:1296,collection:"Academie",basePricePerFoot:1.43,boxPrice:3.14,lengthPrice:5.59,chopPrice:6.59},{itemNumber:"105794",width:'5/16"',boxQty:785,collection:"Lucerne",basePricePerFoot:3.21,boxPrice:5.02,lengthPrice:8.01,chopPrice:9.01},{itemNumber:"105CB",width:'1/2"',boxQty:270,collection:"Vienna",basePricePerFoot:2.21,boxPrice:3.31,lengthPrice:5.71,chopPrice:6.71},{itemNumber:"106180",width:'1/2"',boxQty:900,collection:"Hudson",basePricePerFoot:1.39,boxPrice:2.99,lengthPrice:5.31,chopPrice:6.31},{itemNumber:"106190",width:'1/2"',boxQty:900,collection:"Hudson",basePricePerFoot:1.32,boxPrice:2.83,lengthPrice:5.09,chopPrice:6.09},{itemNumber:"200750",width:'7/8"',boxQty:250,collection:"Sofia",basePricePerFoot:4.38,boxPrice:6.54,lengthPrice:9.9,chopPrice:10.9},{itemNumber:"200751",width:'7/8"',boxQty:515,collection:"Sofia",basePricePerFoot:4.35,boxPrice:6.76,lengthPrice:9.84,chopPrice:10.84},{itemNumber:"200752",width:'7/8"',boxQty:490,collection:"Sofia",basePricePerFoot:4.57,boxPrice:7.31,lengthPrice:10.33,chopPrice:11.33},{itemNumber:"210286",width:'11/16"',boxQty:450,collection:"White",basePricePerFoot:1.89,boxPrice:3.06,lengthPrice:5.99,chopPrice:6.99},{itemNumber:"400750",width:'1 5/8"',boxQty:112,collection:"Sofia",basePricePerFoot:7.47,boxPrice:11.04,lengthPrice:17.48,chopPrice:18.48},{itemNumber:"400751",width:'1 5/8"',boxQty:192,collection:"Sofia",basePricePerFoot:7.09,boxPrice:10.44,lengthPrice:16.55,chopPrice:17.55},{itemNumber:"400752",width:'1 5/8"',boxQty:180,collection:"Sofia",basePricePerFoot:7.34,boxPrice:10.83,lengthPrice:17.17,chopPrice:18.17},{itemNumber:"431431",width:'1 3/8"',boxQty:115,collection:"Zen",basePricePerFoot:10.83,boxPrice:15.91,lengthPrice:26.01,chopPrice:27.01},{itemNumber:"431432",width:'1 3/8"',boxQty:113,collection:"Zen",basePricePerFoot:10.27,boxPrice:15.1,lengthPrice:24.68,chopPrice:25.68},{itemNumber:"431434",width:'1 3/8"',boxQty:110,collection:"Zen",basePricePerFoot:10.75,boxPrice:15.81,lengthPrice:25.82,chopPrice:26.82},{itemNumber:"432900",width:'1 3/4"',boxQty:225,collection:"Foundry",basePricePerFoot:6.62,boxPrice:9.75,lengthPrice:15.03,chopPrice:16.03},{itemNumber:"432902",width:'1 3/4"',boxQty:236,collection:"Foundry",basePricePerFoot:6.81,boxPrice:10.07,lengthPrice:15.52,chopPrice:16.52},{itemNumber:"433082",width:'1 11/16"',boxQty:108,collection:"Soho",basePricePerFoot:5.09,boxPrice:9.55,lengthPrice:14.41,chopPrice:15.41},{itemNumber:"433084",width:'1 11/16"',boxQty:108,collection:"Soho",basePricePerFoot:5.16,boxPrice:9.59,lengthPrice:14.54,chopPrice:15.54},{itemNumber:"433086",width:'1 11/16"',boxQty:108,collection:"Soho",basePricePerFoot:5.22,boxPrice:9.59,lengthPrice:14.54,chopPrice:15.54},{itemNumber:"434110",width:'1 1/4"',boxQty:137,collection:"CR2",basePricePerFoot:6.33,boxPrice:9.33,lengthPrice:14.98,chopPrice:15.98},{itemNumber:"435500",width:'1 5/16"',boxQty:324,collection:"Alto",basePricePerFoot:1.8,boxPrice:3.6,lengthPrice:6.72,chopPrice:7.72},{itemNumber:"435510",width:'1 5/16"',boxQty:296,collection:"Alto",basePricePerFoot:1.8,boxPrice:3.6,lengthPrice:6.72,chopPrice:7.72},{itemNumber:"436350",width:'1 5/8"',boxQty:143,collection:"Brooklyn",basePricePerFoot:2.29,boxPrice:3.66,lengthPrice:6.08,chopPrice:7.08},{itemNumber:"437500",width:'1 3/16"',boxQty:215,collection:"Alto",basePricePerFoot:2.03,boxPrice:3.6,lengthPrice:7.22,chopPrice:8.22},{itemNumber:"437510",width:'1 3/16"',boxQty:180,collection:"Alto",basePricePerFoot:2.03,boxPrice:3.6,lengthPrice:7.22,chopPrice:8.22},{itemNumber:"438120",width:'2"',boxQty:150,collection:"Dresden",basePricePerFoot:6.78,boxPrice:10.26,lengthPrice:15.05,chopPrice:16.05},{itemNumber:"439082",width:'2 1/16"',boxQty:126,collection:"Soho",basePricePerFoot:4.42,boxPrice:7.58,lengthPrice:11.4,chopPrice:12.4},{itemNumber:"440240",width:'1 3/8"',boxQty:190,collection:"Java",basePricePerFoot:7.59,boxPrice:11.23,lengthPrice:18.27,chopPrice:19.27},{itemNumber:"440951",width:'2"',boxQty:92,collection:"Cezanne",basePricePerFoot:18.08,boxPrice:25.65,lengthPrice:29.81,chopPrice:30.81},{itemNumber:"441075",width:'2 1/16"',boxQty:150,collection:"Prague",basePricePerFoot:9.48,boxPrice:13.9,lengthPrice:23.98,chopPrice:24.98},{itemNumber:"441077",width:'2 1/16"',boxQty:155,collection:"Prague",basePricePerFoot:9.44,boxPrice:13.82,lengthPrice:23.86,chopPrice:24.86},{itemNumber:"442650",width:'1 3/4"',boxQty:162,collection:"Tate",basePricePerFoot:4.76,boxPrice:8.08,lengthPrice:11.57,chopPrice:12.57},{itemNumber:"442660",width:'1 3/4"',boxQty:162,collection:"Tate",basePricePerFoot:4.76,boxPrice:8.07,lengthPrice:11.56,chopPrice:12.56},{itemNumber:"442670",width:'1 3/4"',boxQty:162,collection:"Tate",basePricePerFoot:4.67,boxPrice:7.74,lengthPrice:11.04,chopPrice:12.04},{itemNumber:"520750",width:'2 1/2"',boxQty:94,collection:"Sofia",basePricePerFoot:11.07,boxPrice:16.3,lengthPrice:24.59,chopPrice:25.59},{itemNumber:"520751",width:'2 1/2"',boxQty:59,collection:"Sofia",basePricePerFoot:10.92,boxPrice:16.43,lengthPrice:24.78,chopPrice:25.78},{itemNumber:"520752",width:'2 1/2"',boxQty:100,collection:"Sofia",basePricePerFoot:10.56,boxPrice:16.38,lengthPrice:23.41,chopPrice:24.41}];function so(o){let t=o.startsWith("larson-")?o.substring(7):o;return na.find(e=>e.itemNumber===t)||null}var de=9.5;function Ze(o,t){let e=so(o);if(!e)return null;let r=e.basePricePerFoot,s=e.chopPrice||e.basePricePerFoot*1.5,a=Math.ceil(t/de),n=a*de,l=n-t,c=n*r,d=t*s,m;if(t>de){let B=Math.floor(t/de),v=t-B*de;if(v>0){let xe=B*de*r+v*s;m={fullSticks:B,chopFootage:v,totalCost:xe,description:`${B} full stick(s) + ${v.toFixed(1)}' chopped`}}}let D=[{method:"length",cost:c},{method:"chop",cost:d},...m?[{method:"mixed",cost:m.totalCost}]:[]],oe=D.reduce((B,v)=>v.cost<B.cost?v:B),Z=D.reduce((B,v)=>v.cost>B.cost?v:B).cost-oe.cost,E="",se;return oe.method==="length"?E=`Full sticks are cheaper despite ${l.toFixed(1)}' waste`:oe.method==="chop"?E="Chop pricing saves money by avoiding waste":E="Mixed approach optimizes cost by combining full sticks and chopped pieces",t>=0&&t<=4?se="\u{1F3AF} OPTIMAL RANGE: 0-4 feet - Consider chop pricing to avoid waste":t>=10&&t<=14?se="\u{1F3AF} OPTIMAL RANGE: 10-14 feet - Mixed ordering may be most cost-effective":t>4&&t<9.5&&(se="\u{1F4CF} Consider: Close to full stick length, evaluate waste vs chop premium"),{itemNumber:o,footageNeeded:t,lengthOption:{sticksNeeded:a,totalFootage:n,wasteFootage:l,costPerFoot:r,totalCost:c,description:`${a} stick(s) @ ${de}' each`},chopOption:{footageNeeded:t,costPerFoot:s,totalCost:d,description:`${t}' chopped to exact length`},mixedOption:m,recommendation:{method:oe.method,savings:Z,reason:E,alert:se}}}function ia(o,t,e){let r=o+e*2,s=t+e*2;return r*2+s*2}function ca(o,t,e,r){let a=ia(t,e,r)/12;return Ze(o,a)}function ao(o){return o.map(t=>({...ca(t.itemNumber,t.artworkWidth,t.artworkHeight,t.matWidth),quantity:t.quantity||1})).filter(Boolean)}function no(o){let t=o.reduce((s,a)=>s+a.recommendation.savings*a.quantity,0),e=o.reduce((s,a)=>s+a.quantity,0),r=o.filter(s=>s.recommendation.alert).length;return{totalSavings:t,totalOrders:e,averageSavingsPerOrder:t/e,alertCount:r}}async function io(o,t){try{let{itemNumber:e,footageNeeded:r}=o.body;if(!e||!r)return t.status(400).json({error:"Missing required parameters: itemNumber and footageNeeded"});let s=Ze(e,parseFloat(r));if(!s)return t.status(404).json({error:"Item number not found in Larson-Juhl catalog"});t.json(s)}catch(e){console.error("Error optimizing Larson order:",e),t.status(500).json({error:"Internal server error"})}}async function Je(o,t){try{let{itemNumber:e,artworkWidth:r,artworkHeight:s,matWidth:a}=o.body;if(!e||!r||!s||a===void 0)return t.status(400).json({error:"Missing required parameters: itemNumber, artworkWidth, artworkHeight, matWidth"});let n=Je(e,parseFloat(r),parseFloat(s),parseFloat(a));if(!n)return t.status(404).json({error:"Item number not found in Larson-Juhl catalog"});t.json(n)}catch(e){console.error("Error optimizing frame order:",e),t.status(500).json({error:"Internal server error"})}}async function co(o,t){try{let{orders:e}=o.body;if(!e||!Array.isArray(e))return t.status(400).json({error:"Missing or invalid orders array"});let r=ao(e),s=no(r);t.json({optimizations:r,summary:s})}catch(e){console.error("Error batch optimizing orders:",e),t.status(500).json({error:"Internal server error"})}}async function uo(o,t){try{let{itemNumber:e}=o.params,s=[2,4,6,8,10,12,14,16,18,20].map(a=>{let n=Ze(e,a);return{footage:a,optimization:n}}).filter(a=>a.optimization!==null);if(s.length===0)return t.status(404).json({error:"Item number not found in Larson-Juhl catalog"});t.json({itemNumber:e,analysis:s})}catch(e){console.error("Error generating optimization analysis:",e),t.status(500).json({error:"Internal server error"})}}var De=ua();De.post("/optimize/footage",io);De.post("/optimize/frame",Je);De.post("/optimize/batch",co);De.get("/analyze/:itemNumber",uo);var lo=De;Qe();import la from"express";var kt=la.Router();kt.post("/test-basic",async(o,t)=>{let{to:e,subject:r,message:s}=o.body;if(!e||!r||!s)return t.status(400).json({error:"Missing required fields: to, subject, message"});console.log("SendGrid API Key exists:",!!process.env.SENDGRID_API_KEY),console.log("SendGrid API Key starts with SG.:",process.env.SENDGRID_API_KEY?.startsWith("SG.")),console.log("From email:",process.env.FROM_EMAIL||"noreply@jaysartandframes.com");try{await mt({to:e,from:"noreply@jaysartandframes.com",subject:r,text:s,html:`<p>${s}</p>`}),t.json({success:!0,message:"Test email sent successfully!"})}catch(a){console.error("Test email error:",a);let n={message:a.message,hasApiKey:!!process.env.SENDGRID_API_KEY,apiKeyFormat:process.env.SENDGRID_API_KEY?.startsWith("SG.")?"Valid format":"Invalid format",fromEmail:process.env.FROM_EMAIL||"noreply@jaysartandframes.com"};t.status(500).json({error:"Failed to send test email",details:a.message,debug:n})}});kt.post("/test-order-status",async(o,t)=>{let{customerEmail:e,customerName:r="Test Customer",orderId:s=12345,orderStatus:a="order_processed"}=o.body;if(!e)return t.status(400).json({error:"Missing required field: customerEmail"});try{await Ne(e,r,s,a,new Date(Date.now()+7*24*60*60*1e3)),t.json({success:!0,message:"Order status email sent successfully!"})}catch(n){console.error("Order status email error:",n),t.status(500).json({error:"Failed to send order status email",details:n.message})}});var mo=kt;async function po(o){o.post("/api/art-locations",ht.sendArtLocationData),o.get("/api/art-locations/:orderId",ht.getArtLocationData),o.post("/api/frame-designs",yt.saveFrameDesign),o.get("/api/frame-designs/:orderId",yt.getFrameDesign),o.get("/api/health",(s,a)=>{a.json({status:"ok",timestamp:new Date().toISOString(),environment:"production"})}),o.get("/api/dashboard/config",(s,a)=>{let n=process.env.DASHBOARD_API_URL;a.json({configured:!!n,url:n?`${n.substring(0,30)}...`:null,fullUrl:n,message:n?"Dashboard API is configured and ready":"Dashboard API URL not configured. Add DASHBOARD_API_URL to your secrets.",endpoints:n?{metrics:`${n}/api/metrics`,orders:`${n}/api/orders`,status:`${n}/api/status`}:null})}),o.get("/api/dashboard-proxy/health",async(s,a)=>{let n=process.env.DASHBOARD_API_URL;if(!n)return a.status(400).json({error:"Dashboard API URL not configured"});try{let c=await(await fetch(`${n}/api/health`)).json();a.json(c)}catch(l){a.status(500).json({error:l.message})}}),o.get("/api/dashboard-proxy/metrics",async(s,a)=>{let n=process.env.DASHBOARD_API_URL;if(!n)return a.status(400).json({error:"Dashboard API URL not configured"});try{let c=await(await fetch(`${n}/api/metrics`)).json();a.json(c)}catch(l){a.status(500).json({error:l.message})}}),o.get("/api/dashboard-proxy/status",async(s,a)=>{let n=process.env.DASHBOARD_API_URL;if(!n)return a.status(400).json({error:"Dashboard API URL not configured"});try{let c=await(await fetch(`${n}/api/status`)).json();a.json(c)}catch(l){a.status(500).json({error:l.message})}}),o.post("/api/dashboard-proxy/test",async(s,a)=>{let n=process.env.DASHBOARD_API_URL;if(!n)return a.status(400).json({error:"Dashboard API URL not configured"});try{(await fetch(`${n}/api/health`)).ok?a.json({success:!0,message:"Dashboard connection successful"}):a.status(500).json({error:"Dashboard connection failed"})}catch(l){a.status(500).json({error:l.message})}}),o.all("/api/dashboard-proxy/*",async(s,a)=>{let n=process.env.DASHBOARD_API_URL;if(!n)return a.status(503).json({success:!1,error:"Dashboard API URL not configured. Please add DASHBOARD_API_URL to your secrets."});try{let l=s.params[0],c={method:s.method,headers:{"Content-Type":"application/json",...s.headers.authorization&&{Authorization:s.headers.authorization}}};["POST","PUT","PATCH"].includes(s.method)&&s.body&&(c.body=JSON.stringify(s.body));let d=await fetch(`${n}/${l}`,c);if(!d.ok)throw new Error(`Dashboard API responded with status: ${d.status}`);let m=await d.json();a.status(d.status).json(m)}catch(l){console.error("Dashboard API proxy error:",l),a.status(500).json({success:!1,error:"Failed to connect to Dashboard API",details:l instanceof Error?l.message:"Unknown error"})}}),o.get("/api/vendor-catalog/all",(s,a)=>{a.json([])}),o.get("/api/vendor-catalog/larson",(s,a)=>{a.json([])}),o.get("/api/vendor-catalog/roma",(s,a)=>{a.json([])}),o.get("/api/vendor-catalog/nielsen",(s,a)=>{a.json([])}),o.get("/api/larson-catalog/crescent",(s,a)=>{a.json([])}),o.get("/api/frames",(s,a)=>{a.json([])}),o.get("/api/mat-colors",(s,a)=>{a.json([])}),o.get("/api/glass-options",(s,a)=>{a.json([])}),o.get("/api/wholesale-orders",(s,a)=>{a.json([])}),o.get("/api/qr-codes",(s,a)=>{a.json([])}),o.get("/api/hub/material-orders",(s,a)=>{a.json([])}),o.get("/api/auth/status",(s,a)=>{a.json({authenticated:!1,user:null})}),o.get("/api/discord/bot-info",(s,a)=>{a.json({status:"disabled",message:"Discord integration temporarily disabled for deployment stability"})}),o.post("/api/discord/test-notification",async(s,a)=>{a.status(503).json({error:"Discord integration temporarily disabled",message:"Discord notifications are currently unavailable"})}),o.post("/api/notifications/send",async(s,a)=>{try{let{customerPhone:n,customerEmail:l,orderId:c,type:d,message:m,discordUserId:D}=s.body,{getCustomerByPhone:oe,getCustomerByEmail:Y,updateCustomerDiscordId:Z}=await Promise.resolve().then(()=>(Rt(),jt)),E=n?oe(n):l?Y(l):null;if(!E)return a.status(404).json({error:"Customer not found"});let se=c||Math.floor(Math.random()*1e3)+100;console.log(`Notification request for customer ${E.name}: ${d} - ${m}`),a.json({success:!0,customer:{name:E.name,phone:E.phone,email:E.email,hasDiscord:!1},orderNumber:se,message:"Notification logged (Discord integration disabled for deployment stability)"})}catch(n){console.error("Error sending customer notification:",n),a.status(500).json({error:"Failed to send notification",details:n instanceof Error?n.message:"Unknown error"})}}),o.get("/api/customers/search",async(s,a)=>{try{let{phone:n,email:l}=s.query,{getCustomerByPhone:c,getCustomerByEmail:d}=await Promise.resolve().then(()=>(Rt(),jt)),m=n?c(n):l?d(l):null;if(!m)return a.status(404).json({error:"Customer not found"});a.json({customer:{id:m.id,name:m.name,phone:m.phone,email:m.email,hasDiscord:!!m.discordUserId,preferences:m.preferences,notes:m.notes}})}catch{a.status(500).json({error:"Failed to search customer"})}}),o.get("/api/kanban/external/orders",async(s,a)=>{try{let{externalKanbanService:n}=await Promise.resolve().then(()=>(Be(),Ee)),l=await n.fetchOrders();a.json(l)}catch{a.status(500).json({success:!1,orders:[],error:"Failed to fetch orders from external Kanban app"})}}),o.get("/api/kanban/external/health",async(s,a)=>{try{let{externalKanbanService:n}=await Promise.resolve().then(()=>(Be(),Ee)),l=await n.healthCheck();a.json(l)}catch{a.status(500).json({status:"error",connected:!1,error:"Failed to check external Kanban health"})}}),o.get("/api/integrations/test-all",async(s,a)=>{try{let n={dashboard:{connected:!1,error:null},kanban:{connected:!1,error:null}},l=process.env.DASHBOARD_API_URL;if(l)try{let m=await fetch(`${l}/api/health`,{method:"GET",timeout:5e3});n.dashboard.connected=m.ok,m.ok||(n.dashboard.error=`HTTP ${m.status}`)}catch(m){n.dashboard.error=m instanceof Error?m.message:"Connection failed"}else n.dashboard.error="Dashboard API URL not configured";let c=process.env.EXTERNAL_KANBAN_URL,d=process.env.EXTERNAL_KANBAN_API_KEY;if(c&&d)try{let m=await fetch(`${c}/api/health`,{method:"GET",headers:{Authorization:`Bearer ${d}`,"Content-Type":"application/json"},timeout:5e3});n.kanban.connected=m.ok,m.ok||(n.kanban.error=`HTTP ${m.status}`)}catch(m){n.kanban.error=m instanceof Error?m.message:"Connection failed"}else n.kanban.error="Kanban API URL or API Key not configured";a.json({success:!0,integrations:n,summary:{total:2,connected:Object.values(n).filter(m=>m.connected).length,failed:Object.values(n).filter(m=>!m.connected).length}})}catch{a.status(500).json({success:!1,error:"Failed to test integrations"})}}),o.post("/api/kanban/external/test-connection",async(s,a)=>{try{let{externalKanbanService:n}=await Promise.resolve().then(()=>(Be(),Ee)),l=!!process.env.EXTERNAL_KANBAN_URL,c=!!process.env.EXTERNAL_KANBAN_API_KEY;if(!l||!c)return a.status(400).json({success:!1,error:"Kanban configuration incomplete",details:{hasUrl:l,hasApiKey:c,message:"Please add EXTERNAL_KANBAN_URL and EXTERNAL_KANBAN_API_KEY to your secrets"}});let d=await n.healthCheck(),m=await n.fetchOrders();a.json({success:d.connected,health:d,ordersTest:{success:m.success,orderCount:m.orders.length,error:m.error},configuration:{baseUrl:process.env.EXTERNAL_KANBAN_URL?`${process.env.EXTERNAL_KANBAN_URL.substring(0,30)}...`:"Not configured",apiKeyConfigured:!!process.env.EXTERNAL_KANBAN_API_KEY}})}catch(n){a.status(500).json({success:!1,error:"Connection test failed",details:n instanceof Error?n.message:"Unknown error"})}}),o.post("/api/kanban/external/orders/:orderId/status",async(s,a)=>{try{let{orderId:n}=s.params,{status:l,stage:c,notes:d}=s.body,{externalKanbanService:m}=await Promise.resolve().then(()=>(Be(),Ee));await m.updateOrderStatus(n,l,c,d)?a.json({success:!0,orderId:n,updatedStatus:l,stage:c,notes:d,timestamp:new Date().toISOString()}):a.status(500).json({success:!1,error:"Failed to update order status in external Kanban"})}catch{a.status(500).json({success:!1,error:"Failed to update external Kanban order status"})}}),o.get("/api/kanban/api-key",(s,a)=>{a.json({success:!0,message:"Use one of these API keys for integration",apiKeys:[{key:"kanban_admin_key_2025_full_access",name:"3D Designer Integration",permissions:["orders:create","orders:read","orders:update","pricing:read","files:upload"]},{key:"jf_houston_heights_framing_2025_master_api_key_secure_access",name:"Houston Heights Framing API Integration",permissions:["orders:read","orders:write","integration:webhook","pricing:read","catalog:read"]}],usage:{header:"Authorization",format:"Bearer YOUR_API_KEY"},endpoints:{baseUrl:process.env.REPL_URL||"https://your-repl-name.replit.app",orders:"/api/kanban/orders",status:"/api/kanban/status"}})});let t=process.env.POS_API_KEY||"jays_frames_kanban_2025";o.get("/api/kanban/orders",wt,(s,a)=>{a.json({success:!0,orders:[],endpoint:"/api/kanban/orders",description:"Retrieves all orders with production status and timeline information"})}),o.post("/api/kanban/orders/:orderId/status",wt,(s,a)=>{let{orderId:n}=s.params,{status:l,stage:c,notes:d}=s.body;a.json({success:!0,orderId:n,updatedStatus:l,stage:c,notes:d,timestamp:new Date().toISOString(),description:"Updates order production status from external Kanban system"})}),o.get("/api/kanban/status",(s,a)=>{a.json({status:"active",service:"Jays Frames POS System",version:"1.0.0",endpoints:{orders:"/api/kanban/orders",updateStatus:"/api/kanban/orders/:orderId/status",health:"/api/kanban/status"},authentication:"API Key required in Authorization header",timestamp:new Date().toISOString()})}),o.get("/api/kanban/api-key",(s,a)=>{a.json({apiKey:t,usage:"Add this to your Kanban app Authorization header as: Bearer "+t,endpoints:{orders:"/api/kanban/orders",updateStatus:"/api/kanban/orders/:orderId/status"},note:"Keep this API key secure - it provides access to your order data"})}),o.use("/api/hub",gr),o.use("/api/hub-admin",Pt),o.use("/api/admin",Pt),o.post("/api/admin/generate-api-key",async(s,a)=>{try{let{generateApiKey:n}=await Promise.resolve().then(()=>(be(),je));await n(s,a)}catch(n){console.error("Error in generate-api-key route:",n),a.status(500).json({success:!1,error:n.message})}}),o.get("/api/admin/integration-status",async(s,a)=>{try{let{getIntegrationStatus:n}=await Promise.resolve().then(()=>(be(),je));await n(s,a)}catch(n){console.error("Error in integration-status route:",n),a.status(500).json({success:!1,error:n.message})}}),o.get("/api/admin/integration-docs",async(s,a)=>{try{let{getIntegrationDocs:n}=await Promise.resolve().then(()=>(be(),je));await n(s,a)}catch(n){console.error("Error in integration-docs route:",n),a.status(500).json({success:!1,error:n.message})}}),o.get("/api/webhooks",async(s,a)=>{try{a.json({success:!0,webhooks:[]})}catch(n){console.error("Error in webhooks route:",n),a.status(500).json({success:!1,error:n.message})}}),o.use("/api",$r),o.use("/api",Ur),o.use("/api",Xr),o.use("/api/integration",_r),o.use("/api/xml-price-sheets",oo),o.use("/api/larson-optimizer",lo),o.use("/api/test-email",mo),o.get("/api/discord/status",(s,a)=>{a.json({status:"disabled",message:"Discord integration disabled for deployment stability"})}),o.get("/api/notifications/status",(s,a)=>{a.json({status:"basic",channels:["email"],message:"Basic notifications only"})}),o.get("/api/materials/pick-list",yr),o.get("/api/materials/by-supplier",br),o.get("/api/materials/order/:orderId",wr),o.put("/api/materials/:id",xr),o.post("/api/materials/purchase-order",Pr),o.get("/api/materials/types",Sr),o.get("/api/materials/suppliers",Ir);let e=ya(o),r=new ba({server:e,path:"/ws"});return r.on("connection",s=>{console.log("WebSocket client connected"),s.on("message",a=>{try{console.log("Received message:",a.toString()),r.clients.forEach(n=>{n.readyState===wa.OPEN&&n.send(a.toString())})}catch(n){console.error("WebSocket message error:",n)}}),s.send(JSON.stringify({type:"connection",message:"WebSocket connection established"}))}),e}import Xe from"fs";import{createServer as va,createLogger as Oa}from"vite";import{defineConfig as xa}from"vite";import Pa from"@vitejs/plugin-react";import Sa from"@replit/vite-plugin-shadcn-theme-json";import Le from"path";import Ia from"@replit/vite-plugin-runtime-error-modal";var go=xa({plugins:[Pa(),Ia(),Sa()],resolve:{alias:{"@":Le.resolve(import.meta.dirname,"client","src"),"@shared":Le.resolve(import.meta.dirname,"shared"),"@assets":Le.resolve(import.meta.dirname,"attached_assets")}},root:Le.resolve(import.meta.dirname,"client"),build:{outDir:Le.resolve(import.meta.dirname,"dist/public"),emptyOutDir:!0}});import{nanoid as Ca}from"nanoid";import _a from"express";import qe from"path";import{fileURLToPath as Aa}from"url";var fo=Oa();function k(o,t="express"){let e=new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0});console.log(`${e} [${t}] ${o}`)}async function yo(o,t){let e={middlewareMode:!0,hmr:{server:t},allowedHosts:!0},r=await va({...go,configFile:!1,customLogger:{...fo,error:(s,a)=>{fo.error(s,a),console.error(`Vite server error: ${s}`)}},server:e,appType:"custom"});o.use(r.middlewares),o.use("*",async(s,a,n)=>{let l=s.originalUrl;try{let c=qe.resolve(import.meta.dirname,"..","client","index.html"),d=await Xe.promises.readFile(c,"utf-8");d=d.replace('src="/src/main.tsx"',`src="/src/main.tsx?v=${Ca()}"`);let m=await r.transformIndexHtml(l,d);a.status(200).set({"Content-Type":"text/html"}).end(m)}catch(c){r.ssrFixStacktrace(c),n(c)}})}function bo(o){let t=qe.resolve(ho,"..","dist","public"),e=qe.resolve(ho,"..","client","dist"),r="";Xe.existsSync(t)?(r=t,k(`Serving static files from: ${t}`)):Xe.existsSync(e)?(r=e,k(`Serving static files from: ${e}`)):k("No static files found. Please build the client application.","error"),r&&o.use(_a.static(r,{maxAge:"1d",etag:!0,index:"index.html"})),o.get("*",(s,a,n)=>{if(s.path.startsWith("/api")||s.path.startsWith("/uploads"))return n();let l=qe.resolve(r,"index.html");Xe.existsSync(l)?a.sendFile(l):a.status(500).json({error:"Client application not built",message:'Please run "npm run build" to build the client application'})})}var Ma=Aa(import.meta.url),ho=qe.dirname(Ma);import Fa from"path";import wo from"fs";import{fileURLToPath as Na}from"url";import{dirname as ka}from"path";import ja from"cors";var Ra=Na(import.meta.url),Mc=ka(Ra),U=et(),we=parseInt(process.env.PORT||process.env.REPL_PORT||"5000",10);U.use(ja({origin:!0,credentials:!0}));U.use(et.json({limit:"100mb"}));U.use(et.urlencoded({extended:!0,limit:"100mb"}));U.use((o,t,e)=>{let r=Date.now(),s=o.path,a,n=t.json;t.json=function(l,...c){return a=l,n.apply(t,[l,...c])},t.on("finish",()=>{let l=Date.now()-r;if(s.startsWith("/api")){let c=`${o.method} ${s} ${t.statusCode} in ${l}ms`;a&&(c+=` :: ${JSON.stringify(a)}`),c.length>80&&(c=c.slice(0,79)+"\u2026"),k(c)}}),e()});(async()=>{let o=await po(U);U.use((r,s,a,n)=>{let l=r.status||r.statusCode||500,c=r.message||"Internal Server Error";a.status(l).json({message:c}),k(`Error: ${c} (${l})`,"error"),console.error(r)}),U.get("env")==="development"?await yo(U,o):bo(U);let t=()=>{try{let r=o.listen(we,"0.0.0.0",()=>{k(`serving on port ${we}`),console.log(`\u2713 Server running on port ${we}`),console.log("\u2713 Environment: production"),console.log("\u2713 CORS enabled for development")});r.on("error",a=>{if(a.code==="EADDRINUSE"){k(`Port ${we} is already in use, trying ${we+1}`,"warning");let n=we+1;try{return o.listen(n,"0.0.0.0",()=>{k(`serving on fallback port ${n}`),console.log(`\u2713 Server running on fallback port ${n}`)})}catch(l){k(`Failed to start on fallback port: ${l}`,"error"),console.error("Fallback server error:",l),process.exit(1)}}else k(`Server startup error: ${a.message}`,"error"),console.error("Server error:",a),process.exit(1)});let s=a=>{k(`${a} received, shutting down gracefully`,"info"),console.log("Shutting down server..."),r.close(n=>{n?(console.error("Error during shutdown:",n),process.exit(1)):(k("Server closed","info"),console.log("Server closed gracefully"),process.exit(0))}),setTimeout(()=>{console.log("Force exit after timeout"),process.exit(1)},1e4)};return process.on("SIGTERM",()=>s("SIGTERM")),process.on("SIGINT",()=>s("SIGINT")),r}catch(r){k(`Critical server startup failure: ${r?.message||r}`,"error"),console.error("Critical error:",r),process.exit(1)}},e=Fa.join(process.cwd(),"uploads");try{wo.existsSync(e)||wo.mkdirSync(e,{recursive:!0})}catch(r){k(`Warning: Could not create uploads directory: ${r}`,"warning")}U.use("/uploads",et.static(e)),t()})();
